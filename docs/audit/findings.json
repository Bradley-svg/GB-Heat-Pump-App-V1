[
  {
    "id": "P0-db-tls-disabled",
    "title": "CN gateway Postgres client disabled TLS verification",
    "severity": "P0",
    "category": "Security",
    "where": ["services/cn-gateway/src/db/pool.ts (pre-fix lines 10-18)"] ,
    "evidence": "git show HEAD^:services/cn-gateway/src/db/pool.ts set ssl: { rejectUnauthorized: false } whenever NODE_ENV was production.",
    "impact": "An in-path attacker could impersonate Postgres, steal mapping-table rows, or inject falsified pseudonym mappings without tripping TLS errors.",
    "fix": "Force rejectUnauthorized=true and optionally load PGSSLROOTCERT so production connections always validate the server certificate (see fixes.patch).",
    "tests": "npm test -- --run (services/cn-gateway)",
    "references": ["https://www.postgresql.org/docs/current/libpq-ssl.html"]
  },
  {
    "id": "P1-missing-device-signature",
    "title": "Unsigned ingest bodies were accepted",
    "severity": "P1",
    "category": "Security",
    "where": ["services/cn-gateway/src/ingest/routes.ts (pre-fix lines 70-85)"] ,
    "evidence": "verifyDeviceSignature() immediately returned when X-Device-Signature was absent, so spoofed telemetry sailed through sanitize->persist.",
    "impact": "Attackers could flood the exporter with bogus metrics or replay tampered payloads because authenticity was optional.",
    "fix": "Throw DeviceSignatureError when the header is blank, require the HMAC to match, and extend vitest integration/e2e suites to cover both valid and missing signatures.",
    "tests": "npm test -- --run (services/cn-gateway)",
    "references": ["https://owasp.org/www-community/controls/Message_Authentication_Codes"]
  },
  {
    "id": "P1-nginx-ip-logs",
    "title": "Ingress proxy logged raw client IPs",
    "severity": "P1",
    "category": "Privacy",
    "where": ["services/cn-gateway/docker/nginx.conf:7-14 (pre-fix)"] ,
    "evidence": "log_format main included $remote_addr and $http_x_forwarded_for and access_log used that format.",
    "impact": "CN gateway logs would contain real device/public IPs, violating the Mode A 'no raw IPs' mandate and widening breach scope.",
    "fix": "Emit a privacy-focused log format with constant placeholders so neither remote_addr nor X-Forwarded-For hit disk.",
    "tests": "Config validated via nginx -t inside docker build (implicit).",
    "references": ["https://datatracker.ietf.org/doc/html/rfc6973"]
  },
  {
    "id": "P0-export-auth-missing",
    "title": "Exporter never authenticates to overseas worker",
    "severity": "P0",
    "category": "Availability",
    "where": ["services/cn-gateway/src/ingest/exporter.ts:20-73", "services/overseas-api/src/index.ts:55-107"],
    "evidence": "BatchExporter fetch() only sets content-type/signature headers, yet the target worker calls requireAccessJwt() and expects a Cloudflare Access assertion plus Authorization token.",
    "impact": "Every batch post returns 401/403, so pseudonymized telemetry can never exit China even when EXPORT_ENABLED=true.",
    "fix": "Provision an Access service token (or mTLS) and inject the required headers before calling /api/ingest; add contract/integration tests that assert 202 responses under wrangler dev.",
    "tests": "Pending once auth plumbing exists (add exporter->worker integration suite).",
    "references": ["https://developers.cloudflare.com/access/service-auth/service-tokens/"]
  },
  {
    "id": "P0-overseas-drop",
    "title": "Overseas API drops every sanitized batch",
    "severity": "P0",
    "category": "Correctness",
    "where": ["services/overseas-api/src/index.ts:33-76"],
    "evidence": "After parsing records and verifying Ed25519, the handler simply returns {status:\"queued\"} and never writes to D1, R2, or another worker.",
    "impact": "Turning on the CN exporter would black-hole all telemetry/heartbeats, leaving dashboards/mobile permanently stale.",
    "fix": "Persist batches (e.g., enqueue to the main worker/D1) and add tests proving that a batch post results in stored rows/devices.",
    "tests": "Add new worker integration tests once persistence is implemented.",
    "references": ["docs/important-data-checklist.md"]
  },
  {
    "id": "P0-raw-deviceids-overseas",
    "title": "Dashboard worker still stores and logs raw device IDs",
    "severity": "P0",
    "category": "Privacy",
    "where": ["src/schemas/ingest.ts:17-48", "migrations/0001_init.sql:1-40", "src/routes/ingest.ts:246-563", "src/lib/ops-metrics.ts:20-36"],
    "evidence": "TelemetryPayloadSchema requires device_id, tables store device_id TEXT, and log.with({ device_id }) plus ops_metrics.device_id push raw IDs into Cloudflare logs and D1.",
    "impact": "Mode A's requirement that only pseudonymous IDs leave China is violated; any EU/US operator or log export can re-identify equipment directly.",
    "fix": "Delete/disable the raw /api/ingest path, migrate data stores to use did_pseudo, and mask/HMAC IDs before logging; confirm via integration tests that no raw IDs cross the border.",
    "tests": "Add regression tests once the pseudonymous pipeline replaces the legacy one.",
    "references": ["docs/mode-a-operational-guidance.md"]
  },
  {
    "id": "P1-safe-metrics-not-enforced",
    "title": "Legacy ingest schema accepts non-SAFE metrics",
    "severity": "P1",
    "category": "Compliance",
    "where": ["src/schemas/ingest.ts:17-37"],
    "evidence": "TelemetryMetricsSchema still exposes tankC/ambientC/compCurrentA/etc rather than the SAFE_METRICS contract used by sdk-core and cn-gateway.",
    "impact": "If ALLOW_RAW_INGEST is ever toggled (misconfig or emergency), regulated fields flow overseas without sanitization.",
    "fix": "Rip out the raw schema or wrap it with the same SAFE_METRICS filter used in cn-gateway; add CI to flag any metric not present in packages/sdk-core SAFE_METRICS.",
    "tests": "Add worker integration tests verifying that unknown metric keys are rejected or dropped.",
    "references": ["packages/sdk-core/src/constants.ts"]
  },
  {
    "id": "P1-observability-pii",
    "title": "Client error reports log arbitrary extras/tags",
    "severity": "P1",
    "category": "Privacy",
    "where": ["src/schemas/observability.ts:17-35,53", "src/routes/observability.ts:211-275"],
    "evidence": "ClientErrorReportSchema uses .passthrough() and sanitizeExtras() returns extras verbatim when under 4KB, so `email` or GPS can be logged.",
    "impact": "Any front-end bug or attacker can push PII into observability logs that replicate outside China.",
    "fix": "Switch to .strict(), reject forbidden keys, and only log vetted scalar fields (counts, booleans, enums).",
    "tests": "Add unit tests covering redaction of extras/tags before logging.",
    "references": [".modea.guard.json"]
  },
  {
    "id": "P1-export-queue-volatile",
    "title": "BatchExporter queue is in-memory only",
    "severity": "P1",
    "category": "Availability",
    "where": ["services/cn-gateway/src/ingest/exporter.ts:20-116"],
    "evidence": "queue/splice/backoff logic never persists pending records; a process restart loses every item not yet flushed upstream.",
    "impact": "On any crash/deploy the CN gateway silently drops telemetry, defeating Mode A's auditability and SLA promises.",
    "fix": "Back the queue with Postgres/Redis (or durable queue), replay on boot, and alert when backlog grows.",
    "tests": "Add persistence tests that simulate a restart and assert queued records are re-sent.",
    "references": ["https://queue.acm.org/detail.cfm?id=1394128"]
  },
  {
    "id": "P2-guard-ignores-docs",
    "title": "Forbidden-field guard skips docs and Markdown",
    "severity": "P2",
    "category": "Compliance",
    "where": ["SCRIPTS/forbidden-fields-lint.js:58-70"],
    "evidence": "ignorePatterns contain /^docs\//, README*, and *.md(x), so CI never scans the very runbooks/privacy notices that often contain sensitive phrases.",
    "impact": "PII or disallowed terms can slip into documentation unnoticed, undermining the documented 'no exceptions' control.",
    "fix": "Stop ignoring docs/markdown, rely on allowlists for legitimate cases, and fail CI when forbidden terms show up in docs PRs.",
    "tests": "Extend guard workflow to cover docs; manual spot-check once updated.",
    "references": [".modea.guard.json"]
  }
]
