# ADR-001 â€“ Adopt Mode A CN Gateway Architecture

**Date:** 2025-11-11  
**Status:** Accepted

## Context
- Mainland China deployments must ingest device telemetry while respecting Mode A DROP/SAFE policies and data-residency restrictions.
- Devices emit potentially sensitive identifiers (device IDs, network metadata). We must pseudonymize everything inside CN boundaries using a resident KMS/HSM.
- Overseas analytics only require SAFE operational metrics (temperatures, power, modes). Identifiers and PII are forbidden outside CN.
- Regulators expect auditable handling (logs, rotation, replay prevention) but also short time-to-market.

## Decision
Build a dedicated CN Gateway service (Fastify + TypeScript) that:
1. Terminates HTTPS+mTLS behind an nginx reverse proxy inside CN.
2. Validates + sanitizes payloads with Ajv (JSON Schema 2020-12, `additionalProperties:false`) and Mode A DROP/SAFE lists.
3. Pseudonymizes device IDs using CN-resident KMS adapters (Alibaba/Tencent/Huawei) and stores mappings in Postgres.
4. Enforces Mode A operational controls: sequence replay windows, timestamp skew checks, 24h idempotency, and per-device rate limits.
5. Queues only SAFE metrics for export, signs each batch with Ed25519, and forwards to overseas ingest via HTTPS.
6. Surfaces health + Prometheus metrics (no PII) and records audit/error logs for incident response.

## Consequences
### Positive
- Clear separation of CN-resident processing from overseas analytics; only SAFE metrics exit CN.
- Deterministic pseudonymization with collision handling means downstream SDKs can rely on stable `did_pseudo` values.
- KMS adapters abstract provider differences, enabling deployment on Alibaba/Tencent/Huawei regions without code changes.
- Replay limits, idempotency, and rate limiting reduce operational risk from buggy or malicious devices.
- Signed export batches (`X-Batch-Signature`) let overseas ingest verify integrity without trusting transport.

### Negative / Trade-offs
- Additional infrastructure (Postgres, Redis, nginx) must run inside CN, increasing operational burden.
- Strong schema enforcement means any new metric must land a schema + code change before devices can send it.
- Export batching introduces slight latency (flush interval/backoff) before SAFE metrics reach overseas analytics.
- Admin key rotation endpoint is simulated; real operations still need CSP-native rotations and secret distribution procedures.
