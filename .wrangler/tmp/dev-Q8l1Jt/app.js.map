{
  "version": 3,
  "sources": ["../../../node_modules/zod/v3/external.js", "../../../node_modules/zod/v3/helpers/util.js", "../../../node_modules/zod/v3/ZodError.js", "../../../node_modules/zod/v3/locales/en.js", "../../../node_modules/zod/v3/errors.js", "../../../node_modules/zod/v3/helpers/parseUtil.js", "../../../node_modules/zod/v3/helpers/errorUtil.js", "../../../node_modules/zod/v3/types.js", "../../../src/env.ts", "../../../src/assets-manifest.json", "../../../src/frontend/static-bundle.ts", "../../../src/utils/responses.ts", "../../../src/assets.ts", "../../../node_modules/jose/dist/browser/runtime/webcrypto.js", "../../../node_modules/jose/dist/browser/lib/buffer_utils.js", "../../../node_modules/jose/dist/browser/runtime/base64url.js", "../../../node_modules/jose/dist/browser/util/errors.js", "../../../node_modules/jose/dist/browser/lib/crypto_key.js", "../../../node_modules/jose/dist/browser/lib/invalid_key_input.js", "../../../node_modules/jose/dist/browser/runtime/is_key_like.js", "../../../node_modules/jose/dist/browser/lib/is_disjoint.js", "../../../node_modules/jose/dist/browser/lib/is_object.js", "../../../node_modules/jose/dist/browser/runtime/check_key_length.js", "../../../node_modules/jose/dist/browser/lib/is_jwk.js", "../../../node_modules/jose/dist/browser/runtime/jwk_to_key.js", "../../../node_modules/jose/dist/browser/runtime/normalize_key.js", "../../../node_modules/jose/dist/browser/key/import.js", "../../../node_modules/jose/dist/browser/lib/check_key_type.js", "../../../node_modules/jose/dist/browser/lib/validate_crit.js", "../../../node_modules/jose/dist/browser/lib/validate_algorithms.js", "../../../node_modules/jose/dist/browser/runtime/subtle_dsa.js", "../../../node_modules/jose/dist/browser/runtime/get_sign_verify_key.js", "../../../node_modules/jose/dist/browser/runtime/verify.js", "../../../node_modules/jose/dist/browser/jws/flattened/verify.js", "../../../node_modules/jose/dist/browser/jws/compact/verify.js", "../../../node_modules/jose/dist/browser/lib/epoch.js", "../../../node_modules/jose/dist/browser/lib/secs.js", "../../../node_modules/jose/dist/browser/lib/jwt_claims_set.js", "../../../node_modules/jose/dist/browser/jwt/verify.js", "../../../node_modules/jose/dist/browser/jwks/local.js", "../../../node_modules/jose/dist/browser/runtime/fetch_jwks.js", "../../../node_modules/jose/dist/browser/jwks/remote.js", "../../../node_modules/jose/dist/browser/util/base64url.js", "../../../node_modules/jose/dist/browser/util/decode_jwt.js", "../../../src/rbac.ts", "../../../src/utils/logging.ts", "../../../src/lib/access.ts", "../../../src/lib/cors.ts", "../../../node_modules/itty-router/index.mjs", "../../../src/utils/index.ts", "../../../src/lib/cursor.ts", "../../../src/lib/device.ts", "../../../src/schemas/params.ts", "../../../src/schemas/admin.ts", "../../../src/utils/validation.ts", "../../../src/lib/ops-metrics.ts", "../../../src/routes/admin.ts", "../../../src/schemas/audit.ts", "../../../src/lib/audit-store.ts", "../../../src/routes/audit.ts", "../../../src/telemetry/index.ts", "../../../src/schemas/ops.ts", "../../../src/routes/ops.ts", "../../../src/router/access.ts", "../../../src/router/admin.ts", "../../../src/schemas/devices.ts", "../../../src/routes/devices.ts", "../../../src/router/devices.ts", "../../../src/router/params.ts", "../../../src/schemas/metrics.ts", "../../../src/routes/metrics.ts", "../../../src/router/metrics.ts", "../../../src/schemas/telemetry.ts", "../../../src/lib/telemetry-access.ts", "../../../src/lib/telemetry-store.ts", "../../../src/routes/telemetry.legacy.ts", "../../../src/routes/telemetry.ts", "../../../src/router/telemetry.ts", "../../../src/schemas/alerts.ts", "../../../src/lib/db.ts", "../../../src/lib/alerts-store.ts", "../../../src/routes/alerts.ts", "../../../src/schemas/archive.ts", "../../../src/routes/archive.ts", "../../../src/schemas/client.ts", "../../../src/routes/client.ts", "../../../src/schemas/fleet.ts", "../../../src/routes/fleet.ts", "../../../src/lib/ip-rate-limit.ts", "../../../src/schemas/ingest.ts", "../../../src/utils/ingest-dedup.ts", "../../../src/lib/request-metrics.ts", "../../../src/routes/ingest.ts", "../../../src/routes/me.ts", "../../../src/routes/commissioning.ts", "../../../src/routes/health.ts", "../../../src/schemas/commissioning.ts", "../../../src/lib/commissioning-report.ts", "../../../src/lib/commissioning-store.ts", "../../../src/routes/commissioning-runs.ts", "../../../src/schemas/observability.ts", "../../../src/routes/observability.ts", "../../../src/router.ts", "../../../src/utils/asset-base.ts", "../../../src/app-config.ts", "../../../src/utils/security-options.ts", "../../../src/utils/return-url.ts", "../../../src/r2.ts", "../../../src/lib/cron-cursor.ts", "../../../src/jobs/retention.ts", "../../../src/app.ts", "file:///C:/Users/bradl.CRABNEBULA/AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-ensure-req-body-drained.ts", "file:///C:/Users/bradl.CRABNEBULA/AppData/Roaming/npm/node_modules/wrangler/templates/middleware/middleware-miniflare3-json-error.ts", "../bundle-Nsbk6Y/middleware-insertion-facade.js", "file:///C:/Users/bradl.CRABNEBULA/AppData/Roaming/npm/node_modules/wrangler/templates/middleware/common.ts", "../bundle-Nsbk6Y/middleware-loader.entry.ts"],
  "sourceRoot": "D:\\Work\\GREENBRO\\GB-Heat-Pump-App-V1\\.wrangler\\tmp\\dev-Q8l1Jt",
  "sourcesContent": ["export * from \"./errors.js\";\nexport * from \"./helpers/parseUtil.js\";\nexport * from \"./helpers/typeAliases.js\";\nexport * from \"./helpers/util.js\";\nexport * from \"./types.js\";\nexport * from \"./ZodError.js\";\n", "export var util;\n(function (util) {\n    util.assertEqual = (_) => { };\n    function assertIs(_arg) { }\n    util.assertIs = assertIs;\n    function assertNever(_x) {\n        throw new Error();\n    }\n    util.assertNever = assertNever;\n    util.arrayToEnum = (items) => {\n        const obj = {};\n        for (const item of items) {\n            obj[item] = item;\n        }\n        return obj;\n    };\n    util.getValidEnumValues = (obj) => {\n        const validKeys = util.objectKeys(obj).filter((k) => typeof obj[obj[k]] !== \"number\");\n        const filtered = {};\n        for (const k of validKeys) {\n            filtered[k] = obj[k];\n        }\n        return util.objectValues(filtered);\n    };\n    util.objectValues = (obj) => {\n        return util.objectKeys(obj).map(function (e) {\n            return obj[e];\n        });\n    };\n    util.objectKeys = typeof Object.keys === \"function\" // eslint-disable-line ban/ban\n        ? (obj) => Object.keys(obj) // eslint-disable-line ban/ban\n        : (object) => {\n            const keys = [];\n            for (const key in object) {\n                if (Object.prototype.hasOwnProperty.call(object, key)) {\n                    keys.push(key);\n                }\n            }\n            return keys;\n        };\n    util.find = (arr, checker) => {\n        for (const item of arr) {\n            if (checker(item))\n                return item;\n        }\n        return undefined;\n    };\n    util.isInteger = typeof Number.isInteger === \"function\"\n        ? (val) => Number.isInteger(val) // eslint-disable-line ban/ban\n        : (val) => typeof val === \"number\" && Number.isFinite(val) && Math.floor(val) === val;\n    function joinValues(array, separator = \" | \") {\n        return array.map((val) => (typeof val === \"string\" ? `'${val}'` : val)).join(separator);\n    }\n    util.joinValues = joinValues;\n    util.jsonStringifyReplacer = (_, value) => {\n        if (typeof value === \"bigint\") {\n            return value.toString();\n        }\n        return value;\n    };\n})(util || (util = {}));\nexport var objectUtil;\n(function (objectUtil) {\n    objectUtil.mergeShapes = (first, second) => {\n        return {\n            ...first,\n            ...second, // second overwrites first\n        };\n    };\n})(objectUtil || (objectUtil = {}));\nexport const ZodParsedType = util.arrayToEnum([\n    \"string\",\n    \"nan\",\n    \"number\",\n    \"integer\",\n    \"float\",\n    \"boolean\",\n    \"date\",\n    \"bigint\",\n    \"symbol\",\n    \"function\",\n    \"undefined\",\n    \"null\",\n    \"array\",\n    \"object\",\n    \"unknown\",\n    \"promise\",\n    \"void\",\n    \"never\",\n    \"map\",\n    \"set\",\n]);\nexport const getParsedType = (data) => {\n    const t = typeof data;\n    switch (t) {\n        case \"undefined\":\n            return ZodParsedType.undefined;\n        case \"string\":\n            return ZodParsedType.string;\n        case \"number\":\n            return Number.isNaN(data) ? ZodParsedType.nan : ZodParsedType.number;\n        case \"boolean\":\n            return ZodParsedType.boolean;\n        case \"function\":\n            return ZodParsedType.function;\n        case \"bigint\":\n            return ZodParsedType.bigint;\n        case \"symbol\":\n            return ZodParsedType.symbol;\n        case \"object\":\n            if (Array.isArray(data)) {\n                return ZodParsedType.array;\n            }\n            if (data === null) {\n                return ZodParsedType.null;\n            }\n            if (data.then && typeof data.then === \"function\" && data.catch && typeof data.catch === \"function\") {\n                return ZodParsedType.promise;\n            }\n            if (typeof Map !== \"undefined\" && data instanceof Map) {\n                return ZodParsedType.map;\n            }\n            if (typeof Set !== \"undefined\" && data instanceof Set) {\n                return ZodParsedType.set;\n            }\n            if (typeof Date !== \"undefined\" && data instanceof Date) {\n                return ZodParsedType.date;\n            }\n            return ZodParsedType.object;\n        default:\n            return ZodParsedType.unknown;\n    }\n};\n", "import { util } from \"./helpers/util.js\";\nexport const ZodIssueCode = util.arrayToEnum([\n    \"invalid_type\",\n    \"invalid_literal\",\n    \"custom\",\n    \"invalid_union\",\n    \"invalid_union_discriminator\",\n    \"invalid_enum_value\",\n    \"unrecognized_keys\",\n    \"invalid_arguments\",\n    \"invalid_return_type\",\n    \"invalid_date\",\n    \"invalid_string\",\n    \"too_small\",\n    \"too_big\",\n    \"invalid_intersection_types\",\n    \"not_multiple_of\",\n    \"not_finite\",\n]);\nexport const quotelessJson = (obj) => {\n    const json = JSON.stringify(obj, null, 2);\n    return json.replace(/\"([^\"]+)\":/g, \"$1:\");\n};\nexport class ZodError extends Error {\n    get errors() {\n        return this.issues;\n    }\n    constructor(issues) {\n        super();\n        this.issues = [];\n        this.addIssue = (sub) => {\n            this.issues = [...this.issues, sub];\n        };\n        this.addIssues = (subs = []) => {\n            this.issues = [...this.issues, ...subs];\n        };\n        const actualProto = new.target.prototype;\n        if (Object.setPrototypeOf) {\n            // eslint-disable-next-line ban/ban\n            Object.setPrototypeOf(this, actualProto);\n        }\n        else {\n            this.__proto__ = actualProto;\n        }\n        this.name = \"ZodError\";\n        this.issues = issues;\n    }\n    format(_mapper) {\n        const mapper = _mapper ||\n            function (issue) {\n                return issue.message;\n            };\n        const fieldErrors = { _errors: [] };\n        const processError = (error) => {\n            for (const issue of error.issues) {\n                if (issue.code === \"invalid_union\") {\n                    issue.unionErrors.map(processError);\n                }\n                else if (issue.code === \"invalid_return_type\") {\n                    processError(issue.returnTypeError);\n                }\n                else if (issue.code === \"invalid_arguments\") {\n                    processError(issue.argumentsError);\n                }\n                else if (issue.path.length === 0) {\n                    fieldErrors._errors.push(mapper(issue));\n                }\n                else {\n                    let curr = fieldErrors;\n                    let i = 0;\n                    while (i < issue.path.length) {\n                        const el = issue.path[i];\n                        const terminal = i === issue.path.length - 1;\n                        if (!terminal) {\n                            curr[el] = curr[el] || { _errors: [] };\n                            // if (typeof el === \"string\") {\n                            //   curr[el] = curr[el] || { _errors: [] };\n                            // } else if (typeof el === \"number\") {\n                            //   const errorArray: any = [];\n                            //   errorArray._errors = [];\n                            //   curr[el] = curr[el] || errorArray;\n                            // }\n                        }\n                        else {\n                            curr[el] = curr[el] || { _errors: [] };\n                            curr[el]._errors.push(mapper(issue));\n                        }\n                        curr = curr[el];\n                        i++;\n                    }\n                }\n            }\n        };\n        processError(this);\n        return fieldErrors;\n    }\n    static assert(value) {\n        if (!(value instanceof ZodError)) {\n            throw new Error(`Not a ZodError: ${value}`);\n        }\n    }\n    toString() {\n        return this.message;\n    }\n    get message() {\n        return JSON.stringify(this.issues, util.jsonStringifyReplacer, 2);\n    }\n    get isEmpty() {\n        return this.issues.length === 0;\n    }\n    flatten(mapper = (issue) => issue.message) {\n        const fieldErrors = {};\n        const formErrors = [];\n        for (const sub of this.issues) {\n            if (sub.path.length > 0) {\n                const firstEl = sub.path[0];\n                fieldErrors[firstEl] = fieldErrors[firstEl] || [];\n                fieldErrors[firstEl].push(mapper(sub));\n            }\n            else {\n                formErrors.push(mapper(sub));\n            }\n        }\n        return { formErrors, fieldErrors };\n    }\n    get formErrors() {\n        return this.flatten();\n    }\n}\nZodError.create = (issues) => {\n    const error = new ZodError(issues);\n    return error;\n};\n", "import { ZodIssueCode } from \"../ZodError.js\";\nimport { util, ZodParsedType } from \"../helpers/util.js\";\nconst errorMap = (issue, _ctx) => {\n    let message;\n    switch (issue.code) {\n        case ZodIssueCode.invalid_type:\n            if (issue.received === ZodParsedType.undefined) {\n                message = \"Required\";\n            }\n            else {\n                message = `Expected ${issue.expected}, received ${issue.received}`;\n            }\n            break;\n        case ZodIssueCode.invalid_literal:\n            message = `Invalid literal value, expected ${JSON.stringify(issue.expected, util.jsonStringifyReplacer)}`;\n            break;\n        case ZodIssueCode.unrecognized_keys:\n            message = `Unrecognized key(s) in object: ${util.joinValues(issue.keys, \", \")}`;\n            break;\n        case ZodIssueCode.invalid_union:\n            message = `Invalid input`;\n            break;\n        case ZodIssueCode.invalid_union_discriminator:\n            message = `Invalid discriminator value. Expected ${util.joinValues(issue.options)}`;\n            break;\n        case ZodIssueCode.invalid_enum_value:\n            message = `Invalid enum value. Expected ${util.joinValues(issue.options)}, received '${issue.received}'`;\n            break;\n        case ZodIssueCode.invalid_arguments:\n            message = `Invalid function arguments`;\n            break;\n        case ZodIssueCode.invalid_return_type:\n            message = `Invalid function return type`;\n            break;\n        case ZodIssueCode.invalid_date:\n            message = `Invalid date`;\n            break;\n        case ZodIssueCode.invalid_string:\n            if (typeof issue.validation === \"object\") {\n                if (\"includes\" in issue.validation) {\n                    message = `Invalid input: must include \"${issue.validation.includes}\"`;\n                    if (typeof issue.validation.position === \"number\") {\n                        message = `${message} at one or more positions greater than or equal to ${issue.validation.position}`;\n                    }\n                }\n                else if (\"startsWith\" in issue.validation) {\n                    message = `Invalid input: must start with \"${issue.validation.startsWith}\"`;\n                }\n                else if (\"endsWith\" in issue.validation) {\n                    message = `Invalid input: must end with \"${issue.validation.endsWith}\"`;\n                }\n                else {\n                    util.assertNever(issue.validation);\n                }\n            }\n            else if (issue.validation !== \"regex\") {\n                message = `Invalid ${issue.validation}`;\n            }\n            else {\n                message = \"Invalid\";\n            }\n            break;\n        case ZodIssueCode.too_small:\n            if (issue.type === \"array\")\n                message = `Array must contain ${issue.exact ? \"exactly\" : issue.inclusive ? `at least` : `more than`} ${issue.minimum} element(s)`;\n            else if (issue.type === \"string\")\n                message = `String must contain ${issue.exact ? \"exactly\" : issue.inclusive ? `at least` : `over`} ${issue.minimum} character(s)`;\n            else if (issue.type === \"number\")\n                message = `Number must be ${issue.exact ? `exactly equal to ` : issue.inclusive ? `greater than or equal to ` : `greater than `}${issue.minimum}`;\n            else if (issue.type === \"bigint\")\n                message = `Number must be ${issue.exact ? `exactly equal to ` : issue.inclusive ? `greater than or equal to ` : `greater than `}${issue.minimum}`;\n            else if (issue.type === \"date\")\n                message = `Date must be ${issue.exact ? `exactly equal to ` : issue.inclusive ? `greater than or equal to ` : `greater than `}${new Date(Number(issue.minimum))}`;\n            else\n                message = \"Invalid input\";\n            break;\n        case ZodIssueCode.too_big:\n            if (issue.type === \"array\")\n                message = `Array must contain ${issue.exact ? `exactly` : issue.inclusive ? `at most` : `less than`} ${issue.maximum} element(s)`;\n            else if (issue.type === \"string\")\n                message = `String must contain ${issue.exact ? `exactly` : issue.inclusive ? `at most` : `under`} ${issue.maximum} character(s)`;\n            else if (issue.type === \"number\")\n                message = `Number must be ${issue.exact ? `exactly` : issue.inclusive ? `less than or equal to` : `less than`} ${issue.maximum}`;\n            else if (issue.type === \"bigint\")\n                message = `BigInt must be ${issue.exact ? `exactly` : issue.inclusive ? `less than or equal to` : `less than`} ${issue.maximum}`;\n            else if (issue.type === \"date\")\n                message = `Date must be ${issue.exact ? `exactly` : issue.inclusive ? `smaller than or equal to` : `smaller than`} ${new Date(Number(issue.maximum))}`;\n            else\n                message = \"Invalid input\";\n            break;\n        case ZodIssueCode.custom:\n            message = `Invalid input`;\n            break;\n        case ZodIssueCode.invalid_intersection_types:\n            message = `Intersection results could not be merged`;\n            break;\n        case ZodIssueCode.not_multiple_of:\n            message = `Number must be a multiple of ${issue.multipleOf}`;\n            break;\n        case ZodIssueCode.not_finite:\n            message = \"Number must be finite\";\n            break;\n        default:\n            message = _ctx.defaultError;\n            util.assertNever(issue);\n    }\n    return { message };\n};\nexport default errorMap;\n", "import defaultErrorMap from \"./locales/en.js\";\nlet overrideErrorMap = defaultErrorMap;\nexport { defaultErrorMap };\nexport function setErrorMap(map) {\n    overrideErrorMap = map;\n}\nexport function getErrorMap() {\n    return overrideErrorMap;\n}\n", "import { getErrorMap } from \"../errors.js\";\nimport defaultErrorMap from \"../locales/en.js\";\nexport const makeIssue = (params) => {\n    const { data, path, errorMaps, issueData } = params;\n    const fullPath = [...path, ...(issueData.path || [])];\n    const fullIssue = {\n        ...issueData,\n        path: fullPath,\n    };\n    if (issueData.message !== undefined) {\n        return {\n            ...issueData,\n            path: fullPath,\n            message: issueData.message,\n        };\n    }\n    let errorMessage = \"\";\n    const maps = errorMaps\n        .filter((m) => !!m)\n        .slice()\n        .reverse();\n    for (const map of maps) {\n        errorMessage = map(fullIssue, { data, defaultError: errorMessage }).message;\n    }\n    return {\n        ...issueData,\n        path: fullPath,\n        message: errorMessage,\n    };\n};\nexport const EMPTY_PATH = [];\nexport function addIssueToContext(ctx, issueData) {\n    const overrideMap = getErrorMap();\n    const issue = makeIssue({\n        issueData: issueData,\n        data: ctx.data,\n        path: ctx.path,\n        errorMaps: [\n            ctx.common.contextualErrorMap, // contextual error map is first priority\n            ctx.schemaErrorMap, // then schema-bound map if available\n            overrideMap, // then global override map\n            overrideMap === defaultErrorMap ? undefined : defaultErrorMap, // then global default map\n        ].filter((x) => !!x),\n    });\n    ctx.common.issues.push(issue);\n}\nexport class ParseStatus {\n    constructor() {\n        this.value = \"valid\";\n    }\n    dirty() {\n        if (this.value === \"valid\")\n            this.value = \"dirty\";\n    }\n    abort() {\n        if (this.value !== \"aborted\")\n            this.value = \"aborted\";\n    }\n    static mergeArray(status, results) {\n        const arrayValue = [];\n        for (const s of results) {\n            if (s.status === \"aborted\")\n                return INVALID;\n            if (s.status === \"dirty\")\n                status.dirty();\n            arrayValue.push(s.value);\n        }\n        return { status: status.value, value: arrayValue };\n    }\n    static async mergeObjectAsync(status, pairs) {\n        const syncPairs = [];\n        for (const pair of pairs) {\n            const key = await pair.key;\n            const value = await pair.value;\n            syncPairs.push({\n                key,\n                value,\n            });\n        }\n        return ParseStatus.mergeObjectSync(status, syncPairs);\n    }\n    static mergeObjectSync(status, pairs) {\n        const finalObject = {};\n        for (const pair of pairs) {\n            const { key, value } = pair;\n            if (key.status === \"aborted\")\n                return INVALID;\n            if (value.status === \"aborted\")\n                return INVALID;\n            if (key.status === \"dirty\")\n                status.dirty();\n            if (value.status === \"dirty\")\n                status.dirty();\n            if (key.value !== \"__proto__\" && (typeof value.value !== \"undefined\" || pair.alwaysSet)) {\n                finalObject[key.value] = value.value;\n            }\n        }\n        return { status: status.value, value: finalObject };\n    }\n}\nexport const INVALID = Object.freeze({\n    status: \"aborted\",\n});\nexport const DIRTY = (value) => ({ status: \"dirty\", value });\nexport const OK = (value) => ({ status: \"valid\", value });\nexport const isAborted = (x) => x.status === \"aborted\";\nexport const isDirty = (x) => x.status === \"dirty\";\nexport const isValid = (x) => x.status === \"valid\";\nexport const isAsync = (x) => typeof Promise !== \"undefined\" && x instanceof Promise;\n", "export var errorUtil;\n(function (errorUtil) {\n    errorUtil.errToObj = (message) => typeof message === \"string\" ? { message } : message || {};\n    // biome-ignore lint:\n    errorUtil.toString = (message) => typeof message === \"string\" ? message : message?.message;\n})(errorUtil || (errorUtil = {}));\n", "import { ZodError, ZodIssueCode, } from \"./ZodError.js\";\nimport { defaultErrorMap, getErrorMap } from \"./errors.js\";\nimport { errorUtil } from \"./helpers/errorUtil.js\";\nimport { DIRTY, INVALID, OK, ParseStatus, addIssueToContext, isAborted, isAsync, isDirty, isValid, makeIssue, } from \"./helpers/parseUtil.js\";\nimport { util, ZodParsedType, getParsedType } from \"./helpers/util.js\";\nclass ParseInputLazyPath {\n    constructor(parent, value, path, key) {\n        this._cachedPath = [];\n        this.parent = parent;\n        this.data = value;\n        this._path = path;\n        this._key = key;\n    }\n    get path() {\n        if (!this._cachedPath.length) {\n            if (Array.isArray(this._key)) {\n                this._cachedPath.push(...this._path, ...this._key);\n            }\n            else {\n                this._cachedPath.push(...this._path, this._key);\n            }\n        }\n        return this._cachedPath;\n    }\n}\nconst handleResult = (ctx, result) => {\n    if (isValid(result)) {\n        return { success: true, data: result.value };\n    }\n    else {\n        if (!ctx.common.issues.length) {\n            throw new Error(\"Validation failed but no issues detected.\");\n        }\n        return {\n            success: false,\n            get error() {\n                if (this._error)\n                    return this._error;\n                const error = new ZodError(ctx.common.issues);\n                this._error = error;\n                return this._error;\n            },\n        };\n    }\n};\nfunction processCreateParams(params) {\n    if (!params)\n        return {};\n    const { errorMap, invalid_type_error, required_error, description } = params;\n    if (errorMap && (invalid_type_error || required_error)) {\n        throw new Error(`Can't use \"invalid_type_error\" or \"required_error\" in conjunction with custom error map.`);\n    }\n    if (errorMap)\n        return { errorMap: errorMap, description };\n    const customMap = (iss, ctx) => {\n        const { message } = params;\n        if (iss.code === \"invalid_enum_value\") {\n            return { message: message ?? ctx.defaultError };\n        }\n        if (typeof ctx.data === \"undefined\") {\n            return { message: message ?? required_error ?? ctx.defaultError };\n        }\n        if (iss.code !== \"invalid_type\")\n            return { message: ctx.defaultError };\n        return { message: message ?? invalid_type_error ?? ctx.defaultError };\n    };\n    return { errorMap: customMap, description };\n}\nexport class ZodType {\n    get description() {\n        return this._def.description;\n    }\n    _getType(input) {\n        return getParsedType(input.data);\n    }\n    _getOrReturnCtx(input, ctx) {\n        return (ctx || {\n            common: input.parent.common,\n            data: input.data,\n            parsedType: getParsedType(input.data),\n            schemaErrorMap: this._def.errorMap,\n            path: input.path,\n            parent: input.parent,\n        });\n    }\n    _processInputParams(input) {\n        return {\n            status: new ParseStatus(),\n            ctx: {\n                common: input.parent.common,\n                data: input.data,\n                parsedType: getParsedType(input.data),\n                schemaErrorMap: this._def.errorMap,\n                path: input.path,\n                parent: input.parent,\n            },\n        };\n    }\n    _parseSync(input) {\n        const result = this._parse(input);\n        if (isAsync(result)) {\n            throw new Error(\"Synchronous parse encountered promise.\");\n        }\n        return result;\n    }\n    _parseAsync(input) {\n        const result = this._parse(input);\n        return Promise.resolve(result);\n    }\n    parse(data, params) {\n        const result = this.safeParse(data, params);\n        if (result.success)\n            return result.data;\n        throw result.error;\n    }\n    safeParse(data, params) {\n        const ctx = {\n            common: {\n                issues: [],\n                async: params?.async ?? false,\n                contextualErrorMap: params?.errorMap,\n            },\n            path: params?.path || [],\n            schemaErrorMap: this._def.errorMap,\n            parent: null,\n            data,\n            parsedType: getParsedType(data),\n        };\n        const result = this._parseSync({ data, path: ctx.path, parent: ctx });\n        return handleResult(ctx, result);\n    }\n    \"~validate\"(data) {\n        const ctx = {\n            common: {\n                issues: [],\n                async: !!this[\"~standard\"].async,\n            },\n            path: [],\n            schemaErrorMap: this._def.errorMap,\n            parent: null,\n            data,\n            parsedType: getParsedType(data),\n        };\n        if (!this[\"~standard\"].async) {\n            try {\n                const result = this._parseSync({ data, path: [], parent: ctx });\n                return isValid(result)\n                    ? {\n                        value: result.value,\n                    }\n                    : {\n                        issues: ctx.common.issues,\n                    };\n            }\n            catch (err) {\n                if (err?.message?.toLowerCase()?.includes(\"encountered\")) {\n                    this[\"~standard\"].async = true;\n                }\n                ctx.common = {\n                    issues: [],\n                    async: true,\n                };\n            }\n        }\n        return this._parseAsync({ data, path: [], parent: ctx }).then((result) => isValid(result)\n            ? {\n                value: result.value,\n            }\n            : {\n                issues: ctx.common.issues,\n            });\n    }\n    async parseAsync(data, params) {\n        const result = await this.safeParseAsync(data, params);\n        if (result.success)\n            return result.data;\n        throw result.error;\n    }\n    async safeParseAsync(data, params) {\n        const ctx = {\n            common: {\n                issues: [],\n                contextualErrorMap: params?.errorMap,\n                async: true,\n            },\n            path: params?.path || [],\n            schemaErrorMap: this._def.errorMap,\n            parent: null,\n            data,\n            parsedType: getParsedType(data),\n        };\n        const maybeAsyncResult = this._parse({ data, path: ctx.path, parent: ctx });\n        const result = await (isAsync(maybeAsyncResult) ? maybeAsyncResult : Promise.resolve(maybeAsyncResult));\n        return handleResult(ctx, result);\n    }\n    refine(check, message) {\n        const getIssueProperties = (val) => {\n            if (typeof message === \"string\" || typeof message === \"undefined\") {\n                return { message };\n            }\n            else if (typeof message === \"function\") {\n                return message(val);\n            }\n            else {\n                return message;\n            }\n        };\n        return this._refinement((val, ctx) => {\n            const result = check(val);\n            const setError = () => ctx.addIssue({\n                code: ZodIssueCode.custom,\n                ...getIssueProperties(val),\n            });\n            if (typeof Promise !== \"undefined\" && result instanceof Promise) {\n                return result.then((data) => {\n                    if (!data) {\n                        setError();\n                        return false;\n                    }\n                    else {\n                        return true;\n                    }\n                });\n            }\n            if (!result) {\n                setError();\n                return false;\n            }\n            else {\n                return true;\n            }\n        });\n    }\n    refinement(check, refinementData) {\n        return this._refinement((val, ctx) => {\n            if (!check(val)) {\n                ctx.addIssue(typeof refinementData === \"function\" ? refinementData(val, ctx) : refinementData);\n                return false;\n            }\n            else {\n                return true;\n            }\n        });\n    }\n    _refinement(refinement) {\n        return new ZodEffects({\n            schema: this,\n            typeName: ZodFirstPartyTypeKind.ZodEffects,\n            effect: { type: \"refinement\", refinement },\n        });\n    }\n    superRefine(refinement) {\n        return this._refinement(refinement);\n    }\n    constructor(def) {\n        /** Alias of safeParseAsync */\n        this.spa = this.safeParseAsync;\n        this._def = def;\n        this.parse = this.parse.bind(this);\n        this.safeParse = this.safeParse.bind(this);\n        this.parseAsync = this.parseAsync.bind(this);\n        this.safeParseAsync = this.safeParseAsync.bind(this);\n        this.spa = this.spa.bind(this);\n        this.refine = this.refine.bind(this);\n        this.refinement = this.refinement.bind(this);\n        this.superRefine = this.superRefine.bind(this);\n        this.optional = this.optional.bind(this);\n        this.nullable = this.nullable.bind(this);\n        this.nullish = this.nullish.bind(this);\n        this.array = this.array.bind(this);\n        this.promise = this.promise.bind(this);\n        this.or = this.or.bind(this);\n        this.and = this.and.bind(this);\n        this.transform = this.transform.bind(this);\n        this.brand = this.brand.bind(this);\n        this.default = this.default.bind(this);\n        this.catch = this.catch.bind(this);\n        this.describe = this.describe.bind(this);\n        this.pipe = this.pipe.bind(this);\n        this.readonly = this.readonly.bind(this);\n        this.isNullable = this.isNullable.bind(this);\n        this.isOptional = this.isOptional.bind(this);\n        this[\"~standard\"] = {\n            version: 1,\n            vendor: \"zod\",\n            validate: (data) => this[\"~validate\"](data),\n        };\n    }\n    optional() {\n        return ZodOptional.create(this, this._def);\n    }\n    nullable() {\n        return ZodNullable.create(this, this._def);\n    }\n    nullish() {\n        return this.nullable().optional();\n    }\n    array() {\n        return ZodArray.create(this);\n    }\n    promise() {\n        return ZodPromise.create(this, this._def);\n    }\n    or(option) {\n        return ZodUnion.create([this, option], this._def);\n    }\n    and(incoming) {\n        return ZodIntersection.create(this, incoming, this._def);\n    }\n    transform(transform) {\n        return new ZodEffects({\n            ...processCreateParams(this._def),\n            schema: this,\n            typeName: ZodFirstPartyTypeKind.ZodEffects,\n            effect: { type: \"transform\", transform },\n        });\n    }\n    default(def) {\n        const defaultValueFunc = typeof def === \"function\" ? def : () => def;\n        return new ZodDefault({\n            ...processCreateParams(this._def),\n            innerType: this,\n            defaultValue: defaultValueFunc,\n            typeName: ZodFirstPartyTypeKind.ZodDefault,\n        });\n    }\n    brand() {\n        return new ZodBranded({\n            typeName: ZodFirstPartyTypeKind.ZodBranded,\n            type: this,\n            ...processCreateParams(this._def),\n        });\n    }\n    catch(def) {\n        const catchValueFunc = typeof def === \"function\" ? def : () => def;\n        return new ZodCatch({\n            ...processCreateParams(this._def),\n            innerType: this,\n            catchValue: catchValueFunc,\n            typeName: ZodFirstPartyTypeKind.ZodCatch,\n        });\n    }\n    describe(description) {\n        const This = this.constructor;\n        return new This({\n            ...this._def,\n            description,\n        });\n    }\n    pipe(target) {\n        return ZodPipeline.create(this, target);\n    }\n    readonly() {\n        return ZodReadonly.create(this);\n    }\n    isOptional() {\n        return this.safeParse(undefined).success;\n    }\n    isNullable() {\n        return this.safeParse(null).success;\n    }\n}\nconst cuidRegex = /^c[^\\s-]{8,}$/i;\nconst cuid2Regex = /^[0-9a-z]+$/;\nconst ulidRegex = /^[0-9A-HJKMNP-TV-Z]{26}$/i;\n// const uuidRegex =\n//   /^([a-f0-9]{8}-[a-f0-9]{4}-[1-5][a-f0-9]{3}-[a-f0-9]{4}-[a-f0-9]{12}|00000000-0000-0000-0000-000000000000)$/i;\nconst uuidRegex = /^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$/i;\nconst nanoidRegex = /^[a-z0-9_-]{21}$/i;\nconst jwtRegex = /^[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]*$/;\nconst durationRegex = /^[-+]?P(?!$)(?:(?:[-+]?\\d+Y)|(?:[-+]?\\d+[.,]\\d+Y$))?(?:(?:[-+]?\\d+M)|(?:[-+]?\\d+[.,]\\d+M$))?(?:(?:[-+]?\\d+W)|(?:[-+]?\\d+[.,]\\d+W$))?(?:(?:[-+]?\\d+D)|(?:[-+]?\\d+[.,]\\d+D$))?(?:T(?=[\\d+-])(?:(?:[-+]?\\d+H)|(?:[-+]?\\d+[.,]\\d+H$))?(?:(?:[-+]?\\d+M)|(?:[-+]?\\d+[.,]\\d+M$))?(?:[-+]?\\d+(?:[.,]\\d+)?S)?)??$/;\n// from https://stackoverflow.com/a/46181/1550155\n// old version: too slow, didn't support unicode\n// const emailRegex = /^((([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+(\\.([a-z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])+)*)|((\\x22)((((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(([\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(\\\\([\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF]))))*(((\\x20|\\x09)*(\\x0d\\x0a))?(\\x20|\\x09)+)?(\\x22)))@((([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|\\d|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))\\.)+(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])|(([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])([a-z]|\\d|-|\\.|_|~|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])*([a-z]|[\\u00A0-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFEF])))$/i;\n//old email regex\n// const emailRegex = /^(([^<>()[\\].,;:\\s@\"]+(\\.[^<>()[\\].,;:\\s@\"]+)*)|(\".+\"))@((?!-)([^<>()[\\].,;:\\s@\"]+\\.)+[^<>()[\\].,;:\\s@\"]{1,})[^-<>()[\\].,;:\\s@\"]$/i;\n// eslint-disable-next-line\n// const emailRegex =\n//   /^(([^<>()[\\]\\\\.,;:\\s@\\\"]+(\\.[^<>()[\\]\\\\.,;:\\s@\\\"]+)*)|(\\\".+\\\"))@((\\[(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\])|(\\[IPv6:(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))\\])|([A-Za-z0-9]([A-Za-z0-9-]*[A-Za-z0-9])*(\\.[A-Za-z]{2,})+))$/;\n// const emailRegex =\n//   /^[a-zA-Z0-9\\.\\!\\#\\$\\%\\&\\'\\*\\+\\/\\=\\?\\^\\_\\`\\{\\|\\}\\~\\-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n// const emailRegex =\n//   /^(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|\"(?:[\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x21\\x23-\\x5b\\x5d-\\x7f]|\\\\[\\x01-\\x09\\x0b\\x0c\\x0e-\\x7f])*\")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x21-\\x5a\\x53-\\x7f]|\\\\[\\x01-\\x09\\x0b\\x0c\\x0e-\\x7f])+)\\])$/i;\nconst emailRegex = /^(?!\\.)(?!.*\\.\\.)([A-Z0-9_'+\\-\\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\\-]*\\.)+[A-Z]{2,}$/i;\n// const emailRegex =\n//   /^[a-z0-9.!#$%&\u2019*+/=?^_`{|}~-]+@[a-z0-9-]+(?:\\.[a-z0-9\\-]+)*$/i;\n// from https://thekevinscott.com/emojis-in-javascript/#writing-a-regular-expression\nconst _emojiRegex = `^(\\\\p{Extended_Pictographic}|\\\\p{Emoji_Component})+$`;\nlet emojiRegex;\n// faster, simpler, safer\nconst ipv4Regex = /^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/;\nconst ipv4CidrRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\\/(3[0-2]|[12]?[0-9])$/;\n// const ipv6Regex =\n// /^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/;\nconst ipv6Regex = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;\nconst ipv6CidrRegex = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/;\n// https://stackoverflow.com/questions/7860392/determine-if-string-is-in-base64-using-javascript\nconst base64Regex = /^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/;\n// https://base64.guru/standards/base64url\nconst base64urlRegex = /^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/;\n// simple\n// const dateRegexSource = `\\\\d{4}-\\\\d{2}-\\\\d{2}`;\n// no leap year validation\n// const dateRegexSource = `\\\\d{4}-((0[13578]|10|12)-31|(0[13-9]|1[0-2])-30|(0[1-9]|1[0-2])-(0[1-9]|1\\\\d|2\\\\d))`;\n// with leap year validation\nconst dateRegexSource = `((\\\\d\\\\d[2468][048]|\\\\d\\\\d[13579][26]|\\\\d\\\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\\\d|30)|(02)-(0[1-9]|1\\\\d|2[0-8])))`;\nconst dateRegex = new RegExp(`^${dateRegexSource}$`);\nfunction timeRegexSource(args) {\n    let secondsRegexSource = `[0-5]\\\\d`;\n    if (args.precision) {\n        secondsRegexSource = `${secondsRegexSource}\\\\.\\\\d{${args.precision}}`;\n    }\n    else if (args.precision == null) {\n        secondsRegexSource = `${secondsRegexSource}(\\\\.\\\\d+)?`;\n    }\n    const secondsQuantifier = args.precision ? \"+\" : \"?\"; // require seconds if precision is nonzero\n    return `([01]\\\\d|2[0-3]):[0-5]\\\\d(:${secondsRegexSource})${secondsQuantifier}`;\n}\nfunction timeRegex(args) {\n    return new RegExp(`^${timeRegexSource(args)}$`);\n}\n// Adapted from https://stackoverflow.com/a/3143231\nexport function datetimeRegex(args) {\n    let regex = `${dateRegexSource}T${timeRegexSource(args)}`;\n    const opts = [];\n    opts.push(args.local ? `Z?` : `Z`);\n    if (args.offset)\n        opts.push(`([+-]\\\\d{2}:?\\\\d{2})`);\n    regex = `${regex}(${opts.join(\"|\")})`;\n    return new RegExp(`^${regex}$`);\n}\nfunction isValidIP(ip, version) {\n    if ((version === \"v4\" || !version) && ipv4Regex.test(ip)) {\n        return true;\n    }\n    if ((version === \"v6\" || !version) && ipv6Regex.test(ip)) {\n        return true;\n    }\n    return false;\n}\nfunction isValidJWT(jwt, alg) {\n    if (!jwtRegex.test(jwt))\n        return false;\n    try {\n        const [header] = jwt.split(\".\");\n        if (!header)\n            return false;\n        // Convert base64url to base64\n        const base64 = header\n            .replace(/-/g, \"+\")\n            .replace(/_/g, \"/\")\n            .padEnd(header.length + ((4 - (header.length % 4)) % 4), \"=\");\n        const decoded = JSON.parse(atob(base64));\n        if (typeof decoded !== \"object\" || decoded === null)\n            return false;\n        if (\"typ\" in decoded && decoded?.typ !== \"JWT\")\n            return false;\n        if (!decoded.alg)\n            return false;\n        if (alg && decoded.alg !== alg)\n            return false;\n        return true;\n    }\n    catch {\n        return false;\n    }\n}\nfunction isValidCidr(ip, version) {\n    if ((version === \"v4\" || !version) && ipv4CidrRegex.test(ip)) {\n        return true;\n    }\n    if ((version === \"v6\" || !version) && ipv6CidrRegex.test(ip)) {\n        return true;\n    }\n    return false;\n}\nexport class ZodString extends ZodType {\n    _parse(input) {\n        if (this._def.coerce) {\n            input.data = String(input.data);\n        }\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.string) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.string,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        const status = new ParseStatus();\n        let ctx = undefined;\n        for (const check of this._def.checks) {\n            if (check.kind === \"min\") {\n                if (input.data.length < check.value) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_small,\n                        minimum: check.value,\n                        type: \"string\",\n                        inclusive: true,\n                        exact: false,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"max\") {\n                if (input.data.length > check.value) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_big,\n                        maximum: check.value,\n                        type: \"string\",\n                        inclusive: true,\n                        exact: false,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"length\") {\n                const tooBig = input.data.length > check.value;\n                const tooSmall = input.data.length < check.value;\n                if (tooBig || tooSmall) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    if (tooBig) {\n                        addIssueToContext(ctx, {\n                            code: ZodIssueCode.too_big,\n                            maximum: check.value,\n                            type: \"string\",\n                            inclusive: true,\n                            exact: true,\n                            message: check.message,\n                        });\n                    }\n                    else if (tooSmall) {\n                        addIssueToContext(ctx, {\n                            code: ZodIssueCode.too_small,\n                            minimum: check.value,\n                            type: \"string\",\n                            inclusive: true,\n                            exact: true,\n                            message: check.message,\n                        });\n                    }\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"email\") {\n                if (!emailRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"email\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"emoji\") {\n                if (!emojiRegex) {\n                    emojiRegex = new RegExp(_emojiRegex, \"u\");\n                }\n                if (!emojiRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"emoji\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"uuid\") {\n                if (!uuidRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"uuid\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"nanoid\") {\n                if (!nanoidRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"nanoid\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"cuid\") {\n                if (!cuidRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"cuid\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"cuid2\") {\n                if (!cuid2Regex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"cuid2\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"ulid\") {\n                if (!ulidRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"ulid\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"url\") {\n                try {\n                    new URL(input.data);\n                }\n                catch {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"url\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"regex\") {\n                check.regex.lastIndex = 0;\n                const testResult = check.regex.test(input.data);\n                if (!testResult) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"regex\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"trim\") {\n                input.data = input.data.trim();\n            }\n            else if (check.kind === \"includes\") {\n                if (!input.data.includes(check.value, check.position)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.invalid_string,\n                        validation: { includes: check.value, position: check.position },\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"toLowerCase\") {\n                input.data = input.data.toLowerCase();\n            }\n            else if (check.kind === \"toUpperCase\") {\n                input.data = input.data.toUpperCase();\n            }\n            else if (check.kind === \"startsWith\") {\n                if (!input.data.startsWith(check.value)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.invalid_string,\n                        validation: { startsWith: check.value },\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"endsWith\") {\n                if (!input.data.endsWith(check.value)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.invalid_string,\n                        validation: { endsWith: check.value },\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"datetime\") {\n                const regex = datetimeRegex(check);\n                if (!regex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.invalid_string,\n                        validation: \"datetime\",\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"date\") {\n                const regex = dateRegex;\n                if (!regex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.invalid_string,\n                        validation: \"date\",\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"time\") {\n                const regex = timeRegex(check);\n                if (!regex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.invalid_string,\n                        validation: \"time\",\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"duration\") {\n                if (!durationRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"duration\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"ip\") {\n                if (!isValidIP(input.data, check.version)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"ip\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"jwt\") {\n                if (!isValidJWT(input.data, check.alg)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"jwt\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"cidr\") {\n                if (!isValidCidr(input.data, check.version)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"cidr\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"base64\") {\n                if (!base64Regex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"base64\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"base64url\") {\n                if (!base64urlRegex.test(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        validation: \"base64url\",\n                        code: ZodIssueCode.invalid_string,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else {\n                util.assertNever(check);\n            }\n        }\n        return { status: status.value, value: input.data };\n    }\n    _regex(regex, validation, message) {\n        return this.refinement((data) => regex.test(data), {\n            validation,\n            code: ZodIssueCode.invalid_string,\n            ...errorUtil.errToObj(message),\n        });\n    }\n    _addCheck(check) {\n        return new ZodString({\n            ...this._def,\n            checks: [...this._def.checks, check],\n        });\n    }\n    email(message) {\n        return this._addCheck({ kind: \"email\", ...errorUtil.errToObj(message) });\n    }\n    url(message) {\n        return this._addCheck({ kind: \"url\", ...errorUtil.errToObj(message) });\n    }\n    emoji(message) {\n        return this._addCheck({ kind: \"emoji\", ...errorUtil.errToObj(message) });\n    }\n    uuid(message) {\n        return this._addCheck({ kind: \"uuid\", ...errorUtil.errToObj(message) });\n    }\n    nanoid(message) {\n        return this._addCheck({ kind: \"nanoid\", ...errorUtil.errToObj(message) });\n    }\n    cuid(message) {\n        return this._addCheck({ kind: \"cuid\", ...errorUtil.errToObj(message) });\n    }\n    cuid2(message) {\n        return this._addCheck({ kind: \"cuid2\", ...errorUtil.errToObj(message) });\n    }\n    ulid(message) {\n        return this._addCheck({ kind: \"ulid\", ...errorUtil.errToObj(message) });\n    }\n    base64(message) {\n        return this._addCheck({ kind: \"base64\", ...errorUtil.errToObj(message) });\n    }\n    base64url(message) {\n        // base64url encoding is a modification of base64 that can safely be used in URLs and filenames\n        return this._addCheck({\n            kind: \"base64url\",\n            ...errorUtil.errToObj(message),\n        });\n    }\n    jwt(options) {\n        return this._addCheck({ kind: \"jwt\", ...errorUtil.errToObj(options) });\n    }\n    ip(options) {\n        return this._addCheck({ kind: \"ip\", ...errorUtil.errToObj(options) });\n    }\n    cidr(options) {\n        return this._addCheck({ kind: \"cidr\", ...errorUtil.errToObj(options) });\n    }\n    datetime(options) {\n        if (typeof options === \"string\") {\n            return this._addCheck({\n                kind: \"datetime\",\n                precision: null,\n                offset: false,\n                local: false,\n                message: options,\n            });\n        }\n        return this._addCheck({\n            kind: \"datetime\",\n            precision: typeof options?.precision === \"undefined\" ? null : options?.precision,\n            offset: options?.offset ?? false,\n            local: options?.local ?? false,\n            ...errorUtil.errToObj(options?.message),\n        });\n    }\n    date(message) {\n        return this._addCheck({ kind: \"date\", message });\n    }\n    time(options) {\n        if (typeof options === \"string\") {\n            return this._addCheck({\n                kind: \"time\",\n                precision: null,\n                message: options,\n            });\n        }\n        return this._addCheck({\n            kind: \"time\",\n            precision: typeof options?.precision === \"undefined\" ? null : options?.precision,\n            ...errorUtil.errToObj(options?.message),\n        });\n    }\n    duration(message) {\n        return this._addCheck({ kind: \"duration\", ...errorUtil.errToObj(message) });\n    }\n    regex(regex, message) {\n        return this._addCheck({\n            kind: \"regex\",\n            regex: regex,\n            ...errorUtil.errToObj(message),\n        });\n    }\n    includes(value, options) {\n        return this._addCheck({\n            kind: \"includes\",\n            value: value,\n            position: options?.position,\n            ...errorUtil.errToObj(options?.message),\n        });\n    }\n    startsWith(value, message) {\n        return this._addCheck({\n            kind: \"startsWith\",\n            value: value,\n            ...errorUtil.errToObj(message),\n        });\n    }\n    endsWith(value, message) {\n        return this._addCheck({\n            kind: \"endsWith\",\n            value: value,\n            ...errorUtil.errToObj(message),\n        });\n    }\n    min(minLength, message) {\n        return this._addCheck({\n            kind: \"min\",\n            value: minLength,\n            ...errorUtil.errToObj(message),\n        });\n    }\n    max(maxLength, message) {\n        return this._addCheck({\n            kind: \"max\",\n            value: maxLength,\n            ...errorUtil.errToObj(message),\n        });\n    }\n    length(len, message) {\n        return this._addCheck({\n            kind: \"length\",\n            value: len,\n            ...errorUtil.errToObj(message),\n        });\n    }\n    /**\n     * Equivalent to `.min(1)`\n     */\n    nonempty(message) {\n        return this.min(1, errorUtil.errToObj(message));\n    }\n    trim() {\n        return new ZodString({\n            ...this._def,\n            checks: [...this._def.checks, { kind: \"trim\" }],\n        });\n    }\n    toLowerCase() {\n        return new ZodString({\n            ...this._def,\n            checks: [...this._def.checks, { kind: \"toLowerCase\" }],\n        });\n    }\n    toUpperCase() {\n        return new ZodString({\n            ...this._def,\n            checks: [...this._def.checks, { kind: \"toUpperCase\" }],\n        });\n    }\n    get isDatetime() {\n        return !!this._def.checks.find((ch) => ch.kind === \"datetime\");\n    }\n    get isDate() {\n        return !!this._def.checks.find((ch) => ch.kind === \"date\");\n    }\n    get isTime() {\n        return !!this._def.checks.find((ch) => ch.kind === \"time\");\n    }\n    get isDuration() {\n        return !!this._def.checks.find((ch) => ch.kind === \"duration\");\n    }\n    get isEmail() {\n        return !!this._def.checks.find((ch) => ch.kind === \"email\");\n    }\n    get isURL() {\n        return !!this._def.checks.find((ch) => ch.kind === \"url\");\n    }\n    get isEmoji() {\n        return !!this._def.checks.find((ch) => ch.kind === \"emoji\");\n    }\n    get isUUID() {\n        return !!this._def.checks.find((ch) => ch.kind === \"uuid\");\n    }\n    get isNANOID() {\n        return !!this._def.checks.find((ch) => ch.kind === \"nanoid\");\n    }\n    get isCUID() {\n        return !!this._def.checks.find((ch) => ch.kind === \"cuid\");\n    }\n    get isCUID2() {\n        return !!this._def.checks.find((ch) => ch.kind === \"cuid2\");\n    }\n    get isULID() {\n        return !!this._def.checks.find((ch) => ch.kind === \"ulid\");\n    }\n    get isIP() {\n        return !!this._def.checks.find((ch) => ch.kind === \"ip\");\n    }\n    get isCIDR() {\n        return !!this._def.checks.find((ch) => ch.kind === \"cidr\");\n    }\n    get isBase64() {\n        return !!this._def.checks.find((ch) => ch.kind === \"base64\");\n    }\n    get isBase64url() {\n        // base64url encoding is a modification of base64 that can safely be used in URLs and filenames\n        return !!this._def.checks.find((ch) => ch.kind === \"base64url\");\n    }\n    get minLength() {\n        let min = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"min\") {\n                if (min === null || ch.value > min)\n                    min = ch.value;\n            }\n        }\n        return min;\n    }\n    get maxLength() {\n        let max = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"max\") {\n                if (max === null || ch.value < max)\n                    max = ch.value;\n            }\n        }\n        return max;\n    }\n}\nZodString.create = (params) => {\n    return new ZodString({\n        checks: [],\n        typeName: ZodFirstPartyTypeKind.ZodString,\n        coerce: params?.coerce ?? false,\n        ...processCreateParams(params),\n    });\n};\n// https://stackoverflow.com/questions/3966484/why-does-modulus-operator-return-fractional-number-in-javascript/31711034#31711034\nfunction floatSafeRemainder(val, step) {\n    const valDecCount = (val.toString().split(\".\")[1] || \"\").length;\n    const stepDecCount = (step.toString().split(\".\")[1] || \"\").length;\n    const decCount = valDecCount > stepDecCount ? valDecCount : stepDecCount;\n    const valInt = Number.parseInt(val.toFixed(decCount).replace(\".\", \"\"));\n    const stepInt = Number.parseInt(step.toFixed(decCount).replace(\".\", \"\"));\n    return (valInt % stepInt) / 10 ** decCount;\n}\nexport class ZodNumber extends ZodType {\n    constructor() {\n        super(...arguments);\n        this.min = this.gte;\n        this.max = this.lte;\n        this.step = this.multipleOf;\n    }\n    _parse(input) {\n        if (this._def.coerce) {\n            input.data = Number(input.data);\n        }\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.number) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.number,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        let ctx = undefined;\n        const status = new ParseStatus();\n        for (const check of this._def.checks) {\n            if (check.kind === \"int\") {\n                if (!util.isInteger(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.invalid_type,\n                        expected: \"integer\",\n                        received: \"float\",\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"min\") {\n                const tooSmall = check.inclusive ? input.data < check.value : input.data <= check.value;\n                if (tooSmall) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_small,\n                        minimum: check.value,\n                        type: \"number\",\n                        inclusive: check.inclusive,\n                        exact: false,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"max\") {\n                const tooBig = check.inclusive ? input.data > check.value : input.data >= check.value;\n                if (tooBig) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_big,\n                        maximum: check.value,\n                        type: \"number\",\n                        inclusive: check.inclusive,\n                        exact: false,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"multipleOf\") {\n                if (floatSafeRemainder(input.data, check.value) !== 0) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.not_multiple_of,\n                        multipleOf: check.value,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"finite\") {\n                if (!Number.isFinite(input.data)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.not_finite,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else {\n                util.assertNever(check);\n            }\n        }\n        return { status: status.value, value: input.data };\n    }\n    gte(value, message) {\n        return this.setLimit(\"min\", value, true, errorUtil.toString(message));\n    }\n    gt(value, message) {\n        return this.setLimit(\"min\", value, false, errorUtil.toString(message));\n    }\n    lte(value, message) {\n        return this.setLimit(\"max\", value, true, errorUtil.toString(message));\n    }\n    lt(value, message) {\n        return this.setLimit(\"max\", value, false, errorUtil.toString(message));\n    }\n    setLimit(kind, value, inclusive, message) {\n        return new ZodNumber({\n            ...this._def,\n            checks: [\n                ...this._def.checks,\n                {\n                    kind,\n                    value,\n                    inclusive,\n                    message: errorUtil.toString(message),\n                },\n            ],\n        });\n    }\n    _addCheck(check) {\n        return new ZodNumber({\n            ...this._def,\n            checks: [...this._def.checks, check],\n        });\n    }\n    int(message) {\n        return this._addCheck({\n            kind: \"int\",\n            message: errorUtil.toString(message),\n        });\n    }\n    positive(message) {\n        return this._addCheck({\n            kind: \"min\",\n            value: 0,\n            inclusive: false,\n            message: errorUtil.toString(message),\n        });\n    }\n    negative(message) {\n        return this._addCheck({\n            kind: \"max\",\n            value: 0,\n            inclusive: false,\n            message: errorUtil.toString(message),\n        });\n    }\n    nonpositive(message) {\n        return this._addCheck({\n            kind: \"max\",\n            value: 0,\n            inclusive: true,\n            message: errorUtil.toString(message),\n        });\n    }\n    nonnegative(message) {\n        return this._addCheck({\n            kind: \"min\",\n            value: 0,\n            inclusive: true,\n            message: errorUtil.toString(message),\n        });\n    }\n    multipleOf(value, message) {\n        return this._addCheck({\n            kind: \"multipleOf\",\n            value: value,\n            message: errorUtil.toString(message),\n        });\n    }\n    finite(message) {\n        return this._addCheck({\n            kind: \"finite\",\n            message: errorUtil.toString(message),\n        });\n    }\n    safe(message) {\n        return this._addCheck({\n            kind: \"min\",\n            inclusive: true,\n            value: Number.MIN_SAFE_INTEGER,\n            message: errorUtil.toString(message),\n        })._addCheck({\n            kind: \"max\",\n            inclusive: true,\n            value: Number.MAX_SAFE_INTEGER,\n            message: errorUtil.toString(message),\n        });\n    }\n    get minValue() {\n        let min = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"min\") {\n                if (min === null || ch.value > min)\n                    min = ch.value;\n            }\n        }\n        return min;\n    }\n    get maxValue() {\n        let max = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"max\") {\n                if (max === null || ch.value < max)\n                    max = ch.value;\n            }\n        }\n        return max;\n    }\n    get isInt() {\n        return !!this._def.checks.find((ch) => ch.kind === \"int\" || (ch.kind === \"multipleOf\" && util.isInteger(ch.value)));\n    }\n    get isFinite() {\n        let max = null;\n        let min = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"finite\" || ch.kind === \"int\" || ch.kind === \"multipleOf\") {\n                return true;\n            }\n            else if (ch.kind === \"min\") {\n                if (min === null || ch.value > min)\n                    min = ch.value;\n            }\n            else if (ch.kind === \"max\") {\n                if (max === null || ch.value < max)\n                    max = ch.value;\n            }\n        }\n        return Number.isFinite(min) && Number.isFinite(max);\n    }\n}\nZodNumber.create = (params) => {\n    return new ZodNumber({\n        checks: [],\n        typeName: ZodFirstPartyTypeKind.ZodNumber,\n        coerce: params?.coerce || false,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodBigInt extends ZodType {\n    constructor() {\n        super(...arguments);\n        this.min = this.gte;\n        this.max = this.lte;\n    }\n    _parse(input) {\n        if (this._def.coerce) {\n            try {\n                input.data = BigInt(input.data);\n            }\n            catch {\n                return this._getInvalidInput(input);\n            }\n        }\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.bigint) {\n            return this._getInvalidInput(input);\n        }\n        let ctx = undefined;\n        const status = new ParseStatus();\n        for (const check of this._def.checks) {\n            if (check.kind === \"min\") {\n                const tooSmall = check.inclusive ? input.data < check.value : input.data <= check.value;\n                if (tooSmall) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_small,\n                        type: \"bigint\",\n                        minimum: check.value,\n                        inclusive: check.inclusive,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"max\") {\n                const tooBig = check.inclusive ? input.data > check.value : input.data >= check.value;\n                if (tooBig) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_big,\n                        type: \"bigint\",\n                        maximum: check.value,\n                        inclusive: check.inclusive,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"multipleOf\") {\n                if (input.data % check.value !== BigInt(0)) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.not_multiple_of,\n                        multipleOf: check.value,\n                        message: check.message,\n                    });\n                    status.dirty();\n                }\n            }\n            else {\n                util.assertNever(check);\n            }\n        }\n        return { status: status.value, value: input.data };\n    }\n    _getInvalidInput(input) {\n        const ctx = this._getOrReturnCtx(input);\n        addIssueToContext(ctx, {\n            code: ZodIssueCode.invalid_type,\n            expected: ZodParsedType.bigint,\n            received: ctx.parsedType,\n        });\n        return INVALID;\n    }\n    gte(value, message) {\n        return this.setLimit(\"min\", value, true, errorUtil.toString(message));\n    }\n    gt(value, message) {\n        return this.setLimit(\"min\", value, false, errorUtil.toString(message));\n    }\n    lte(value, message) {\n        return this.setLimit(\"max\", value, true, errorUtil.toString(message));\n    }\n    lt(value, message) {\n        return this.setLimit(\"max\", value, false, errorUtil.toString(message));\n    }\n    setLimit(kind, value, inclusive, message) {\n        return new ZodBigInt({\n            ...this._def,\n            checks: [\n                ...this._def.checks,\n                {\n                    kind,\n                    value,\n                    inclusive,\n                    message: errorUtil.toString(message),\n                },\n            ],\n        });\n    }\n    _addCheck(check) {\n        return new ZodBigInt({\n            ...this._def,\n            checks: [...this._def.checks, check],\n        });\n    }\n    positive(message) {\n        return this._addCheck({\n            kind: \"min\",\n            value: BigInt(0),\n            inclusive: false,\n            message: errorUtil.toString(message),\n        });\n    }\n    negative(message) {\n        return this._addCheck({\n            kind: \"max\",\n            value: BigInt(0),\n            inclusive: false,\n            message: errorUtil.toString(message),\n        });\n    }\n    nonpositive(message) {\n        return this._addCheck({\n            kind: \"max\",\n            value: BigInt(0),\n            inclusive: true,\n            message: errorUtil.toString(message),\n        });\n    }\n    nonnegative(message) {\n        return this._addCheck({\n            kind: \"min\",\n            value: BigInt(0),\n            inclusive: true,\n            message: errorUtil.toString(message),\n        });\n    }\n    multipleOf(value, message) {\n        return this._addCheck({\n            kind: \"multipleOf\",\n            value,\n            message: errorUtil.toString(message),\n        });\n    }\n    get minValue() {\n        let min = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"min\") {\n                if (min === null || ch.value > min)\n                    min = ch.value;\n            }\n        }\n        return min;\n    }\n    get maxValue() {\n        let max = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"max\") {\n                if (max === null || ch.value < max)\n                    max = ch.value;\n            }\n        }\n        return max;\n    }\n}\nZodBigInt.create = (params) => {\n    return new ZodBigInt({\n        checks: [],\n        typeName: ZodFirstPartyTypeKind.ZodBigInt,\n        coerce: params?.coerce ?? false,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodBoolean extends ZodType {\n    _parse(input) {\n        if (this._def.coerce) {\n            input.data = Boolean(input.data);\n        }\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.boolean) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.boolean,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        return OK(input.data);\n    }\n}\nZodBoolean.create = (params) => {\n    return new ZodBoolean({\n        typeName: ZodFirstPartyTypeKind.ZodBoolean,\n        coerce: params?.coerce || false,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodDate extends ZodType {\n    _parse(input) {\n        if (this._def.coerce) {\n            input.data = new Date(input.data);\n        }\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.date) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.date,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        if (Number.isNaN(input.data.getTime())) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_date,\n            });\n            return INVALID;\n        }\n        const status = new ParseStatus();\n        let ctx = undefined;\n        for (const check of this._def.checks) {\n            if (check.kind === \"min\") {\n                if (input.data.getTime() < check.value) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_small,\n                        message: check.message,\n                        inclusive: true,\n                        exact: false,\n                        minimum: check.value,\n                        type: \"date\",\n                    });\n                    status.dirty();\n                }\n            }\n            else if (check.kind === \"max\") {\n                if (input.data.getTime() > check.value) {\n                    ctx = this._getOrReturnCtx(input, ctx);\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.too_big,\n                        message: check.message,\n                        inclusive: true,\n                        exact: false,\n                        maximum: check.value,\n                        type: \"date\",\n                    });\n                    status.dirty();\n                }\n            }\n            else {\n                util.assertNever(check);\n            }\n        }\n        return {\n            status: status.value,\n            value: new Date(input.data.getTime()),\n        };\n    }\n    _addCheck(check) {\n        return new ZodDate({\n            ...this._def,\n            checks: [...this._def.checks, check],\n        });\n    }\n    min(minDate, message) {\n        return this._addCheck({\n            kind: \"min\",\n            value: minDate.getTime(),\n            message: errorUtil.toString(message),\n        });\n    }\n    max(maxDate, message) {\n        return this._addCheck({\n            kind: \"max\",\n            value: maxDate.getTime(),\n            message: errorUtil.toString(message),\n        });\n    }\n    get minDate() {\n        let min = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"min\") {\n                if (min === null || ch.value > min)\n                    min = ch.value;\n            }\n        }\n        return min != null ? new Date(min) : null;\n    }\n    get maxDate() {\n        let max = null;\n        for (const ch of this._def.checks) {\n            if (ch.kind === \"max\") {\n                if (max === null || ch.value < max)\n                    max = ch.value;\n            }\n        }\n        return max != null ? new Date(max) : null;\n    }\n}\nZodDate.create = (params) => {\n    return new ZodDate({\n        checks: [],\n        coerce: params?.coerce || false,\n        typeName: ZodFirstPartyTypeKind.ZodDate,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodSymbol extends ZodType {\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.symbol) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.symbol,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        return OK(input.data);\n    }\n}\nZodSymbol.create = (params) => {\n    return new ZodSymbol({\n        typeName: ZodFirstPartyTypeKind.ZodSymbol,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodUndefined extends ZodType {\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.undefined) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.undefined,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        return OK(input.data);\n    }\n}\nZodUndefined.create = (params) => {\n    return new ZodUndefined({\n        typeName: ZodFirstPartyTypeKind.ZodUndefined,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodNull extends ZodType {\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.null) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.null,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        return OK(input.data);\n    }\n}\nZodNull.create = (params) => {\n    return new ZodNull({\n        typeName: ZodFirstPartyTypeKind.ZodNull,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodAny extends ZodType {\n    constructor() {\n        super(...arguments);\n        // to prevent instances of other classes from extending ZodAny. this causes issues with catchall in ZodObject.\n        this._any = true;\n    }\n    _parse(input) {\n        return OK(input.data);\n    }\n}\nZodAny.create = (params) => {\n    return new ZodAny({\n        typeName: ZodFirstPartyTypeKind.ZodAny,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodUnknown extends ZodType {\n    constructor() {\n        super(...arguments);\n        // required\n        this._unknown = true;\n    }\n    _parse(input) {\n        return OK(input.data);\n    }\n}\nZodUnknown.create = (params) => {\n    return new ZodUnknown({\n        typeName: ZodFirstPartyTypeKind.ZodUnknown,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodNever extends ZodType {\n    _parse(input) {\n        const ctx = this._getOrReturnCtx(input);\n        addIssueToContext(ctx, {\n            code: ZodIssueCode.invalid_type,\n            expected: ZodParsedType.never,\n            received: ctx.parsedType,\n        });\n        return INVALID;\n    }\n}\nZodNever.create = (params) => {\n    return new ZodNever({\n        typeName: ZodFirstPartyTypeKind.ZodNever,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodVoid extends ZodType {\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.undefined) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.void,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        return OK(input.data);\n    }\n}\nZodVoid.create = (params) => {\n    return new ZodVoid({\n        typeName: ZodFirstPartyTypeKind.ZodVoid,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodArray extends ZodType {\n    _parse(input) {\n        const { ctx, status } = this._processInputParams(input);\n        const def = this._def;\n        if (ctx.parsedType !== ZodParsedType.array) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.array,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        if (def.exactLength !== null) {\n            const tooBig = ctx.data.length > def.exactLength.value;\n            const tooSmall = ctx.data.length < def.exactLength.value;\n            if (tooBig || tooSmall) {\n                addIssueToContext(ctx, {\n                    code: tooBig ? ZodIssueCode.too_big : ZodIssueCode.too_small,\n                    minimum: (tooSmall ? def.exactLength.value : undefined),\n                    maximum: (tooBig ? def.exactLength.value : undefined),\n                    type: \"array\",\n                    inclusive: true,\n                    exact: true,\n                    message: def.exactLength.message,\n                });\n                status.dirty();\n            }\n        }\n        if (def.minLength !== null) {\n            if (ctx.data.length < def.minLength.value) {\n                addIssueToContext(ctx, {\n                    code: ZodIssueCode.too_small,\n                    minimum: def.minLength.value,\n                    type: \"array\",\n                    inclusive: true,\n                    exact: false,\n                    message: def.minLength.message,\n                });\n                status.dirty();\n            }\n        }\n        if (def.maxLength !== null) {\n            if (ctx.data.length > def.maxLength.value) {\n                addIssueToContext(ctx, {\n                    code: ZodIssueCode.too_big,\n                    maximum: def.maxLength.value,\n                    type: \"array\",\n                    inclusive: true,\n                    exact: false,\n                    message: def.maxLength.message,\n                });\n                status.dirty();\n            }\n        }\n        if (ctx.common.async) {\n            return Promise.all([...ctx.data].map((item, i) => {\n                return def.type._parseAsync(new ParseInputLazyPath(ctx, item, ctx.path, i));\n            })).then((result) => {\n                return ParseStatus.mergeArray(status, result);\n            });\n        }\n        const result = [...ctx.data].map((item, i) => {\n            return def.type._parseSync(new ParseInputLazyPath(ctx, item, ctx.path, i));\n        });\n        return ParseStatus.mergeArray(status, result);\n    }\n    get element() {\n        return this._def.type;\n    }\n    min(minLength, message) {\n        return new ZodArray({\n            ...this._def,\n            minLength: { value: minLength, message: errorUtil.toString(message) },\n        });\n    }\n    max(maxLength, message) {\n        return new ZodArray({\n            ...this._def,\n            maxLength: { value: maxLength, message: errorUtil.toString(message) },\n        });\n    }\n    length(len, message) {\n        return new ZodArray({\n            ...this._def,\n            exactLength: { value: len, message: errorUtil.toString(message) },\n        });\n    }\n    nonempty(message) {\n        return this.min(1, message);\n    }\n}\nZodArray.create = (schema, params) => {\n    return new ZodArray({\n        type: schema,\n        minLength: null,\n        maxLength: null,\n        exactLength: null,\n        typeName: ZodFirstPartyTypeKind.ZodArray,\n        ...processCreateParams(params),\n    });\n};\nfunction deepPartialify(schema) {\n    if (schema instanceof ZodObject) {\n        const newShape = {};\n        for (const key in schema.shape) {\n            const fieldSchema = schema.shape[key];\n            newShape[key] = ZodOptional.create(deepPartialify(fieldSchema));\n        }\n        return new ZodObject({\n            ...schema._def,\n            shape: () => newShape,\n        });\n    }\n    else if (schema instanceof ZodArray) {\n        return new ZodArray({\n            ...schema._def,\n            type: deepPartialify(schema.element),\n        });\n    }\n    else if (schema instanceof ZodOptional) {\n        return ZodOptional.create(deepPartialify(schema.unwrap()));\n    }\n    else if (schema instanceof ZodNullable) {\n        return ZodNullable.create(deepPartialify(schema.unwrap()));\n    }\n    else if (schema instanceof ZodTuple) {\n        return ZodTuple.create(schema.items.map((item) => deepPartialify(item)));\n    }\n    else {\n        return schema;\n    }\n}\nexport class ZodObject extends ZodType {\n    constructor() {\n        super(...arguments);\n        this._cached = null;\n        /**\n         * @deprecated In most cases, this is no longer needed - unknown properties are now silently stripped.\n         * If you want to pass through unknown properties, use `.passthrough()` instead.\n         */\n        this.nonstrict = this.passthrough;\n        // extend<\n        //   Augmentation extends ZodRawShape,\n        //   NewOutput extends util.flatten<{\n        //     [k in keyof Augmentation | keyof Output]: k extends keyof Augmentation\n        //       ? Augmentation[k][\"_output\"]\n        //       : k extends keyof Output\n        //       ? Output[k]\n        //       : never;\n        //   }>,\n        //   NewInput extends util.flatten<{\n        //     [k in keyof Augmentation | keyof Input]: k extends keyof Augmentation\n        //       ? Augmentation[k][\"_input\"]\n        //       : k extends keyof Input\n        //       ? Input[k]\n        //       : never;\n        //   }>\n        // >(\n        //   augmentation: Augmentation\n        // ): ZodObject<\n        //   extendShape<T, Augmentation>,\n        //   UnknownKeys,\n        //   Catchall,\n        //   NewOutput,\n        //   NewInput\n        // > {\n        //   return new ZodObject({\n        //     ...this._def,\n        //     shape: () => ({\n        //       ...this._def.shape(),\n        //       ...augmentation,\n        //     }),\n        //   }) as any;\n        // }\n        /**\n         * @deprecated Use `.extend` instead\n         *  */\n        this.augment = this.extend;\n    }\n    _getCached() {\n        if (this._cached !== null)\n            return this._cached;\n        const shape = this._def.shape();\n        const keys = util.objectKeys(shape);\n        this._cached = { shape, keys };\n        return this._cached;\n    }\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.object) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.object,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        const { status, ctx } = this._processInputParams(input);\n        const { shape, keys: shapeKeys } = this._getCached();\n        const extraKeys = [];\n        if (!(this._def.catchall instanceof ZodNever && this._def.unknownKeys === \"strip\")) {\n            for (const key in ctx.data) {\n                if (!shapeKeys.includes(key)) {\n                    extraKeys.push(key);\n                }\n            }\n        }\n        const pairs = [];\n        for (const key of shapeKeys) {\n            const keyValidator = shape[key];\n            const value = ctx.data[key];\n            pairs.push({\n                key: { status: \"valid\", value: key },\n                value: keyValidator._parse(new ParseInputLazyPath(ctx, value, ctx.path, key)),\n                alwaysSet: key in ctx.data,\n            });\n        }\n        if (this._def.catchall instanceof ZodNever) {\n            const unknownKeys = this._def.unknownKeys;\n            if (unknownKeys === \"passthrough\") {\n                for (const key of extraKeys) {\n                    pairs.push({\n                        key: { status: \"valid\", value: key },\n                        value: { status: \"valid\", value: ctx.data[key] },\n                    });\n                }\n            }\n            else if (unknownKeys === \"strict\") {\n                if (extraKeys.length > 0) {\n                    addIssueToContext(ctx, {\n                        code: ZodIssueCode.unrecognized_keys,\n                        keys: extraKeys,\n                    });\n                    status.dirty();\n                }\n            }\n            else if (unknownKeys === \"strip\") {\n            }\n            else {\n                throw new Error(`Internal ZodObject error: invalid unknownKeys value.`);\n            }\n        }\n        else {\n            // run catchall validation\n            const catchall = this._def.catchall;\n            for (const key of extraKeys) {\n                const value = ctx.data[key];\n                pairs.push({\n                    key: { status: \"valid\", value: key },\n                    value: catchall._parse(new ParseInputLazyPath(ctx, value, ctx.path, key) //, ctx.child(key), value, getParsedType(value)\n                    ),\n                    alwaysSet: key in ctx.data,\n                });\n            }\n        }\n        if (ctx.common.async) {\n            return Promise.resolve()\n                .then(async () => {\n                const syncPairs = [];\n                for (const pair of pairs) {\n                    const key = await pair.key;\n                    const value = await pair.value;\n                    syncPairs.push({\n                        key,\n                        value,\n                        alwaysSet: pair.alwaysSet,\n                    });\n                }\n                return syncPairs;\n            })\n                .then((syncPairs) => {\n                return ParseStatus.mergeObjectSync(status, syncPairs);\n            });\n        }\n        else {\n            return ParseStatus.mergeObjectSync(status, pairs);\n        }\n    }\n    get shape() {\n        return this._def.shape();\n    }\n    strict(message) {\n        errorUtil.errToObj;\n        return new ZodObject({\n            ...this._def,\n            unknownKeys: \"strict\",\n            ...(message !== undefined\n                ? {\n                    errorMap: (issue, ctx) => {\n                        const defaultError = this._def.errorMap?.(issue, ctx).message ?? ctx.defaultError;\n                        if (issue.code === \"unrecognized_keys\")\n                            return {\n                                message: errorUtil.errToObj(message).message ?? defaultError,\n                            };\n                        return {\n                            message: defaultError,\n                        };\n                    },\n                }\n                : {}),\n        });\n    }\n    strip() {\n        return new ZodObject({\n            ...this._def,\n            unknownKeys: \"strip\",\n        });\n    }\n    passthrough() {\n        return new ZodObject({\n            ...this._def,\n            unknownKeys: \"passthrough\",\n        });\n    }\n    // const AugmentFactory =\n    //   <Def extends ZodObjectDef>(def: Def) =>\n    //   <Augmentation extends ZodRawShape>(\n    //     augmentation: Augmentation\n    //   ): ZodObject<\n    //     extendShape<ReturnType<Def[\"shape\"]>, Augmentation>,\n    //     Def[\"unknownKeys\"],\n    //     Def[\"catchall\"]\n    //   > => {\n    //     return new ZodObject({\n    //       ...def,\n    //       shape: () => ({\n    //         ...def.shape(),\n    //         ...augmentation,\n    //       }),\n    //     }) as any;\n    //   };\n    extend(augmentation) {\n        return new ZodObject({\n            ...this._def,\n            shape: () => ({\n                ...this._def.shape(),\n                ...augmentation,\n            }),\n        });\n    }\n    /**\n     * Prior to zod@1.0.12 there was a bug in the\n     * inferred type of merged objects. Please\n     * upgrade if you are experiencing issues.\n     */\n    merge(merging) {\n        const merged = new ZodObject({\n            unknownKeys: merging._def.unknownKeys,\n            catchall: merging._def.catchall,\n            shape: () => ({\n                ...this._def.shape(),\n                ...merging._def.shape(),\n            }),\n            typeName: ZodFirstPartyTypeKind.ZodObject,\n        });\n        return merged;\n    }\n    // merge<\n    //   Incoming extends AnyZodObject,\n    //   Augmentation extends Incoming[\"shape\"],\n    //   NewOutput extends {\n    //     [k in keyof Augmentation | keyof Output]: k extends keyof Augmentation\n    //       ? Augmentation[k][\"_output\"]\n    //       : k extends keyof Output\n    //       ? Output[k]\n    //       : never;\n    //   },\n    //   NewInput extends {\n    //     [k in keyof Augmentation | keyof Input]: k extends keyof Augmentation\n    //       ? Augmentation[k][\"_input\"]\n    //       : k extends keyof Input\n    //       ? Input[k]\n    //       : never;\n    //   }\n    // >(\n    //   merging: Incoming\n    // ): ZodObject<\n    //   extendShape<T, ReturnType<Incoming[\"_def\"][\"shape\"]>>,\n    //   Incoming[\"_def\"][\"unknownKeys\"],\n    //   Incoming[\"_def\"][\"catchall\"],\n    //   NewOutput,\n    //   NewInput\n    // > {\n    //   const merged: any = new ZodObject({\n    //     unknownKeys: merging._def.unknownKeys,\n    //     catchall: merging._def.catchall,\n    //     shape: () =>\n    //       objectUtil.mergeShapes(this._def.shape(), merging._def.shape()),\n    //     typeName: ZodFirstPartyTypeKind.ZodObject,\n    //   }) as any;\n    //   return merged;\n    // }\n    setKey(key, schema) {\n        return this.augment({ [key]: schema });\n    }\n    // merge<Incoming extends AnyZodObject>(\n    //   merging: Incoming\n    // ): //ZodObject<T & Incoming[\"_shape\"], UnknownKeys, Catchall> = (merging) => {\n    // ZodObject<\n    //   extendShape<T, ReturnType<Incoming[\"_def\"][\"shape\"]>>,\n    //   Incoming[\"_def\"][\"unknownKeys\"],\n    //   Incoming[\"_def\"][\"catchall\"]\n    // > {\n    //   // const mergedShape = objectUtil.mergeShapes(\n    //   //   this._def.shape(),\n    //   //   merging._def.shape()\n    //   // );\n    //   const merged: any = new ZodObject({\n    //     unknownKeys: merging._def.unknownKeys,\n    //     catchall: merging._def.catchall,\n    //     shape: () =>\n    //       objectUtil.mergeShapes(this._def.shape(), merging._def.shape()),\n    //     typeName: ZodFirstPartyTypeKind.ZodObject,\n    //   }) as any;\n    //   return merged;\n    // }\n    catchall(index) {\n        return new ZodObject({\n            ...this._def,\n            catchall: index,\n        });\n    }\n    pick(mask) {\n        const shape = {};\n        for (const key of util.objectKeys(mask)) {\n            if (mask[key] && this.shape[key]) {\n                shape[key] = this.shape[key];\n            }\n        }\n        return new ZodObject({\n            ...this._def,\n            shape: () => shape,\n        });\n    }\n    omit(mask) {\n        const shape = {};\n        for (const key of util.objectKeys(this.shape)) {\n            if (!mask[key]) {\n                shape[key] = this.shape[key];\n            }\n        }\n        return new ZodObject({\n            ...this._def,\n            shape: () => shape,\n        });\n    }\n    /**\n     * @deprecated\n     */\n    deepPartial() {\n        return deepPartialify(this);\n    }\n    partial(mask) {\n        const newShape = {};\n        for (const key of util.objectKeys(this.shape)) {\n            const fieldSchema = this.shape[key];\n            if (mask && !mask[key]) {\n                newShape[key] = fieldSchema;\n            }\n            else {\n                newShape[key] = fieldSchema.optional();\n            }\n        }\n        return new ZodObject({\n            ...this._def,\n            shape: () => newShape,\n        });\n    }\n    required(mask) {\n        const newShape = {};\n        for (const key of util.objectKeys(this.shape)) {\n            if (mask && !mask[key]) {\n                newShape[key] = this.shape[key];\n            }\n            else {\n                const fieldSchema = this.shape[key];\n                let newField = fieldSchema;\n                while (newField instanceof ZodOptional) {\n                    newField = newField._def.innerType;\n                }\n                newShape[key] = newField;\n            }\n        }\n        return new ZodObject({\n            ...this._def,\n            shape: () => newShape,\n        });\n    }\n    keyof() {\n        return createZodEnum(util.objectKeys(this.shape));\n    }\n}\nZodObject.create = (shape, params) => {\n    return new ZodObject({\n        shape: () => shape,\n        unknownKeys: \"strip\",\n        catchall: ZodNever.create(),\n        typeName: ZodFirstPartyTypeKind.ZodObject,\n        ...processCreateParams(params),\n    });\n};\nZodObject.strictCreate = (shape, params) => {\n    return new ZodObject({\n        shape: () => shape,\n        unknownKeys: \"strict\",\n        catchall: ZodNever.create(),\n        typeName: ZodFirstPartyTypeKind.ZodObject,\n        ...processCreateParams(params),\n    });\n};\nZodObject.lazycreate = (shape, params) => {\n    return new ZodObject({\n        shape,\n        unknownKeys: \"strip\",\n        catchall: ZodNever.create(),\n        typeName: ZodFirstPartyTypeKind.ZodObject,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodUnion extends ZodType {\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        const options = this._def.options;\n        function handleResults(results) {\n            // return first issue-free validation if it exists\n            for (const result of results) {\n                if (result.result.status === \"valid\") {\n                    return result.result;\n                }\n            }\n            for (const result of results) {\n                if (result.result.status === \"dirty\") {\n                    // add issues from dirty option\n                    ctx.common.issues.push(...result.ctx.common.issues);\n                    return result.result;\n                }\n            }\n            // return invalid\n            const unionErrors = results.map((result) => new ZodError(result.ctx.common.issues));\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_union,\n                unionErrors,\n            });\n            return INVALID;\n        }\n        if (ctx.common.async) {\n            return Promise.all(options.map(async (option) => {\n                const childCtx = {\n                    ...ctx,\n                    common: {\n                        ...ctx.common,\n                        issues: [],\n                    },\n                    parent: null,\n                };\n                return {\n                    result: await option._parseAsync({\n                        data: ctx.data,\n                        path: ctx.path,\n                        parent: childCtx,\n                    }),\n                    ctx: childCtx,\n                };\n            })).then(handleResults);\n        }\n        else {\n            let dirty = undefined;\n            const issues = [];\n            for (const option of options) {\n                const childCtx = {\n                    ...ctx,\n                    common: {\n                        ...ctx.common,\n                        issues: [],\n                    },\n                    parent: null,\n                };\n                const result = option._parseSync({\n                    data: ctx.data,\n                    path: ctx.path,\n                    parent: childCtx,\n                });\n                if (result.status === \"valid\") {\n                    return result;\n                }\n                else if (result.status === \"dirty\" && !dirty) {\n                    dirty = { result, ctx: childCtx };\n                }\n                if (childCtx.common.issues.length) {\n                    issues.push(childCtx.common.issues);\n                }\n            }\n            if (dirty) {\n                ctx.common.issues.push(...dirty.ctx.common.issues);\n                return dirty.result;\n            }\n            const unionErrors = issues.map((issues) => new ZodError(issues));\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_union,\n                unionErrors,\n            });\n            return INVALID;\n        }\n    }\n    get options() {\n        return this._def.options;\n    }\n}\nZodUnion.create = (types, params) => {\n    return new ZodUnion({\n        options: types,\n        typeName: ZodFirstPartyTypeKind.ZodUnion,\n        ...processCreateParams(params),\n    });\n};\n/////////////////////////////////////////////////////\n/////////////////////////////////////////////////////\n//////////                                 //////////\n//////////      ZodDiscriminatedUnion      //////////\n//////////                                 //////////\n/////////////////////////////////////////////////////\n/////////////////////////////////////////////////////\nconst getDiscriminator = (type) => {\n    if (type instanceof ZodLazy) {\n        return getDiscriminator(type.schema);\n    }\n    else if (type instanceof ZodEffects) {\n        return getDiscriminator(type.innerType());\n    }\n    else if (type instanceof ZodLiteral) {\n        return [type.value];\n    }\n    else if (type instanceof ZodEnum) {\n        return type.options;\n    }\n    else if (type instanceof ZodNativeEnum) {\n        // eslint-disable-next-line ban/ban\n        return util.objectValues(type.enum);\n    }\n    else if (type instanceof ZodDefault) {\n        return getDiscriminator(type._def.innerType);\n    }\n    else if (type instanceof ZodUndefined) {\n        return [undefined];\n    }\n    else if (type instanceof ZodNull) {\n        return [null];\n    }\n    else if (type instanceof ZodOptional) {\n        return [undefined, ...getDiscriminator(type.unwrap())];\n    }\n    else if (type instanceof ZodNullable) {\n        return [null, ...getDiscriminator(type.unwrap())];\n    }\n    else if (type instanceof ZodBranded) {\n        return getDiscriminator(type.unwrap());\n    }\n    else if (type instanceof ZodReadonly) {\n        return getDiscriminator(type.unwrap());\n    }\n    else if (type instanceof ZodCatch) {\n        return getDiscriminator(type._def.innerType);\n    }\n    else {\n        return [];\n    }\n};\nexport class ZodDiscriminatedUnion extends ZodType {\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        if (ctx.parsedType !== ZodParsedType.object) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.object,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        const discriminator = this.discriminator;\n        const discriminatorValue = ctx.data[discriminator];\n        const option = this.optionsMap.get(discriminatorValue);\n        if (!option) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_union_discriminator,\n                options: Array.from(this.optionsMap.keys()),\n                path: [discriminator],\n            });\n            return INVALID;\n        }\n        if (ctx.common.async) {\n            return option._parseAsync({\n                data: ctx.data,\n                path: ctx.path,\n                parent: ctx,\n            });\n        }\n        else {\n            return option._parseSync({\n                data: ctx.data,\n                path: ctx.path,\n                parent: ctx,\n            });\n        }\n    }\n    get discriminator() {\n        return this._def.discriminator;\n    }\n    get options() {\n        return this._def.options;\n    }\n    get optionsMap() {\n        return this._def.optionsMap;\n    }\n    /**\n     * The constructor of the discriminated union schema. Its behaviour is very similar to that of the normal z.union() constructor.\n     * However, it only allows a union of objects, all of which need to share a discriminator property. This property must\n     * have a different value for each object in the union.\n     * @param discriminator the name of the discriminator property\n     * @param types an array of object schemas\n     * @param params\n     */\n    static create(discriminator, options, params) {\n        // Get all the valid discriminator values\n        const optionsMap = new Map();\n        // try {\n        for (const type of options) {\n            const discriminatorValues = getDiscriminator(type.shape[discriminator]);\n            if (!discriminatorValues.length) {\n                throw new Error(`A discriminator value for key \\`${discriminator}\\` could not be extracted from all schema options`);\n            }\n            for (const value of discriminatorValues) {\n                if (optionsMap.has(value)) {\n                    throw new Error(`Discriminator property ${String(discriminator)} has duplicate value ${String(value)}`);\n                }\n                optionsMap.set(value, type);\n            }\n        }\n        return new ZodDiscriminatedUnion({\n            typeName: ZodFirstPartyTypeKind.ZodDiscriminatedUnion,\n            discriminator,\n            options,\n            optionsMap,\n            ...processCreateParams(params),\n        });\n    }\n}\nfunction mergeValues(a, b) {\n    const aType = getParsedType(a);\n    const bType = getParsedType(b);\n    if (a === b) {\n        return { valid: true, data: a };\n    }\n    else if (aType === ZodParsedType.object && bType === ZodParsedType.object) {\n        const bKeys = util.objectKeys(b);\n        const sharedKeys = util.objectKeys(a).filter((key) => bKeys.indexOf(key) !== -1);\n        const newObj = { ...a, ...b };\n        for (const key of sharedKeys) {\n            const sharedValue = mergeValues(a[key], b[key]);\n            if (!sharedValue.valid) {\n                return { valid: false };\n            }\n            newObj[key] = sharedValue.data;\n        }\n        return { valid: true, data: newObj };\n    }\n    else if (aType === ZodParsedType.array && bType === ZodParsedType.array) {\n        if (a.length !== b.length) {\n            return { valid: false };\n        }\n        const newArray = [];\n        for (let index = 0; index < a.length; index++) {\n            const itemA = a[index];\n            const itemB = b[index];\n            const sharedValue = mergeValues(itemA, itemB);\n            if (!sharedValue.valid) {\n                return { valid: false };\n            }\n            newArray.push(sharedValue.data);\n        }\n        return { valid: true, data: newArray };\n    }\n    else if (aType === ZodParsedType.date && bType === ZodParsedType.date && +a === +b) {\n        return { valid: true, data: a };\n    }\n    else {\n        return { valid: false };\n    }\n}\nexport class ZodIntersection extends ZodType {\n    _parse(input) {\n        const { status, ctx } = this._processInputParams(input);\n        const handleParsed = (parsedLeft, parsedRight) => {\n            if (isAborted(parsedLeft) || isAborted(parsedRight)) {\n                return INVALID;\n            }\n            const merged = mergeValues(parsedLeft.value, parsedRight.value);\n            if (!merged.valid) {\n                addIssueToContext(ctx, {\n                    code: ZodIssueCode.invalid_intersection_types,\n                });\n                return INVALID;\n            }\n            if (isDirty(parsedLeft) || isDirty(parsedRight)) {\n                status.dirty();\n            }\n            return { status: status.value, value: merged.data };\n        };\n        if (ctx.common.async) {\n            return Promise.all([\n                this._def.left._parseAsync({\n                    data: ctx.data,\n                    path: ctx.path,\n                    parent: ctx,\n                }),\n                this._def.right._parseAsync({\n                    data: ctx.data,\n                    path: ctx.path,\n                    parent: ctx,\n                }),\n            ]).then(([left, right]) => handleParsed(left, right));\n        }\n        else {\n            return handleParsed(this._def.left._parseSync({\n                data: ctx.data,\n                path: ctx.path,\n                parent: ctx,\n            }), this._def.right._parseSync({\n                data: ctx.data,\n                path: ctx.path,\n                parent: ctx,\n            }));\n        }\n    }\n}\nZodIntersection.create = (left, right, params) => {\n    return new ZodIntersection({\n        left: left,\n        right: right,\n        typeName: ZodFirstPartyTypeKind.ZodIntersection,\n        ...processCreateParams(params),\n    });\n};\n// type ZodTupleItems = [ZodTypeAny, ...ZodTypeAny[]];\nexport class ZodTuple extends ZodType {\n    _parse(input) {\n        const { status, ctx } = this._processInputParams(input);\n        if (ctx.parsedType !== ZodParsedType.array) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.array,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        if (ctx.data.length < this._def.items.length) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.too_small,\n                minimum: this._def.items.length,\n                inclusive: true,\n                exact: false,\n                type: \"array\",\n            });\n            return INVALID;\n        }\n        const rest = this._def.rest;\n        if (!rest && ctx.data.length > this._def.items.length) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.too_big,\n                maximum: this._def.items.length,\n                inclusive: true,\n                exact: false,\n                type: \"array\",\n            });\n            status.dirty();\n        }\n        const items = [...ctx.data]\n            .map((item, itemIndex) => {\n            const schema = this._def.items[itemIndex] || this._def.rest;\n            if (!schema)\n                return null;\n            return schema._parse(new ParseInputLazyPath(ctx, item, ctx.path, itemIndex));\n        })\n            .filter((x) => !!x); // filter nulls\n        if (ctx.common.async) {\n            return Promise.all(items).then((results) => {\n                return ParseStatus.mergeArray(status, results);\n            });\n        }\n        else {\n            return ParseStatus.mergeArray(status, items);\n        }\n    }\n    get items() {\n        return this._def.items;\n    }\n    rest(rest) {\n        return new ZodTuple({\n            ...this._def,\n            rest,\n        });\n    }\n}\nZodTuple.create = (schemas, params) => {\n    if (!Array.isArray(schemas)) {\n        throw new Error(\"You must pass an array of schemas to z.tuple([ ... ])\");\n    }\n    return new ZodTuple({\n        items: schemas,\n        typeName: ZodFirstPartyTypeKind.ZodTuple,\n        rest: null,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodRecord extends ZodType {\n    get keySchema() {\n        return this._def.keyType;\n    }\n    get valueSchema() {\n        return this._def.valueType;\n    }\n    _parse(input) {\n        const { status, ctx } = this._processInputParams(input);\n        if (ctx.parsedType !== ZodParsedType.object) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.object,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        const pairs = [];\n        const keyType = this._def.keyType;\n        const valueType = this._def.valueType;\n        for (const key in ctx.data) {\n            pairs.push({\n                key: keyType._parse(new ParseInputLazyPath(ctx, key, ctx.path, key)),\n                value: valueType._parse(new ParseInputLazyPath(ctx, ctx.data[key], ctx.path, key)),\n                alwaysSet: key in ctx.data,\n            });\n        }\n        if (ctx.common.async) {\n            return ParseStatus.mergeObjectAsync(status, pairs);\n        }\n        else {\n            return ParseStatus.mergeObjectSync(status, pairs);\n        }\n    }\n    get element() {\n        return this._def.valueType;\n    }\n    static create(first, second, third) {\n        if (second instanceof ZodType) {\n            return new ZodRecord({\n                keyType: first,\n                valueType: second,\n                typeName: ZodFirstPartyTypeKind.ZodRecord,\n                ...processCreateParams(third),\n            });\n        }\n        return new ZodRecord({\n            keyType: ZodString.create(),\n            valueType: first,\n            typeName: ZodFirstPartyTypeKind.ZodRecord,\n            ...processCreateParams(second),\n        });\n    }\n}\nexport class ZodMap extends ZodType {\n    get keySchema() {\n        return this._def.keyType;\n    }\n    get valueSchema() {\n        return this._def.valueType;\n    }\n    _parse(input) {\n        const { status, ctx } = this._processInputParams(input);\n        if (ctx.parsedType !== ZodParsedType.map) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.map,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        const keyType = this._def.keyType;\n        const valueType = this._def.valueType;\n        const pairs = [...ctx.data.entries()].map(([key, value], index) => {\n            return {\n                key: keyType._parse(new ParseInputLazyPath(ctx, key, ctx.path, [index, \"key\"])),\n                value: valueType._parse(new ParseInputLazyPath(ctx, value, ctx.path, [index, \"value\"])),\n            };\n        });\n        if (ctx.common.async) {\n            const finalMap = new Map();\n            return Promise.resolve().then(async () => {\n                for (const pair of pairs) {\n                    const key = await pair.key;\n                    const value = await pair.value;\n                    if (key.status === \"aborted\" || value.status === \"aborted\") {\n                        return INVALID;\n                    }\n                    if (key.status === \"dirty\" || value.status === \"dirty\") {\n                        status.dirty();\n                    }\n                    finalMap.set(key.value, value.value);\n                }\n                return { status: status.value, value: finalMap };\n            });\n        }\n        else {\n            const finalMap = new Map();\n            for (const pair of pairs) {\n                const key = pair.key;\n                const value = pair.value;\n                if (key.status === \"aborted\" || value.status === \"aborted\") {\n                    return INVALID;\n                }\n                if (key.status === \"dirty\" || value.status === \"dirty\") {\n                    status.dirty();\n                }\n                finalMap.set(key.value, value.value);\n            }\n            return { status: status.value, value: finalMap };\n        }\n    }\n}\nZodMap.create = (keyType, valueType, params) => {\n    return new ZodMap({\n        valueType,\n        keyType,\n        typeName: ZodFirstPartyTypeKind.ZodMap,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodSet extends ZodType {\n    _parse(input) {\n        const { status, ctx } = this._processInputParams(input);\n        if (ctx.parsedType !== ZodParsedType.set) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.set,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        const def = this._def;\n        if (def.minSize !== null) {\n            if (ctx.data.size < def.minSize.value) {\n                addIssueToContext(ctx, {\n                    code: ZodIssueCode.too_small,\n                    minimum: def.minSize.value,\n                    type: \"set\",\n                    inclusive: true,\n                    exact: false,\n                    message: def.minSize.message,\n                });\n                status.dirty();\n            }\n        }\n        if (def.maxSize !== null) {\n            if (ctx.data.size > def.maxSize.value) {\n                addIssueToContext(ctx, {\n                    code: ZodIssueCode.too_big,\n                    maximum: def.maxSize.value,\n                    type: \"set\",\n                    inclusive: true,\n                    exact: false,\n                    message: def.maxSize.message,\n                });\n                status.dirty();\n            }\n        }\n        const valueType = this._def.valueType;\n        function finalizeSet(elements) {\n            const parsedSet = new Set();\n            for (const element of elements) {\n                if (element.status === \"aborted\")\n                    return INVALID;\n                if (element.status === \"dirty\")\n                    status.dirty();\n                parsedSet.add(element.value);\n            }\n            return { status: status.value, value: parsedSet };\n        }\n        const elements = [...ctx.data.values()].map((item, i) => valueType._parse(new ParseInputLazyPath(ctx, item, ctx.path, i)));\n        if (ctx.common.async) {\n            return Promise.all(elements).then((elements) => finalizeSet(elements));\n        }\n        else {\n            return finalizeSet(elements);\n        }\n    }\n    min(minSize, message) {\n        return new ZodSet({\n            ...this._def,\n            minSize: { value: minSize, message: errorUtil.toString(message) },\n        });\n    }\n    max(maxSize, message) {\n        return new ZodSet({\n            ...this._def,\n            maxSize: { value: maxSize, message: errorUtil.toString(message) },\n        });\n    }\n    size(size, message) {\n        return this.min(size, message).max(size, message);\n    }\n    nonempty(message) {\n        return this.min(1, message);\n    }\n}\nZodSet.create = (valueType, params) => {\n    return new ZodSet({\n        valueType,\n        minSize: null,\n        maxSize: null,\n        typeName: ZodFirstPartyTypeKind.ZodSet,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodFunction extends ZodType {\n    constructor() {\n        super(...arguments);\n        this.validate = this.implement;\n    }\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        if (ctx.parsedType !== ZodParsedType.function) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.function,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        function makeArgsIssue(args, error) {\n            return makeIssue({\n                data: args,\n                path: ctx.path,\n                errorMaps: [ctx.common.contextualErrorMap, ctx.schemaErrorMap, getErrorMap(), defaultErrorMap].filter((x) => !!x),\n                issueData: {\n                    code: ZodIssueCode.invalid_arguments,\n                    argumentsError: error,\n                },\n            });\n        }\n        function makeReturnsIssue(returns, error) {\n            return makeIssue({\n                data: returns,\n                path: ctx.path,\n                errorMaps: [ctx.common.contextualErrorMap, ctx.schemaErrorMap, getErrorMap(), defaultErrorMap].filter((x) => !!x),\n                issueData: {\n                    code: ZodIssueCode.invalid_return_type,\n                    returnTypeError: error,\n                },\n            });\n        }\n        const params = { errorMap: ctx.common.contextualErrorMap };\n        const fn = ctx.data;\n        if (this._def.returns instanceof ZodPromise) {\n            // Would love a way to avoid disabling this rule, but we need\n            // an alias (using an arrow function was what caused 2651).\n            // eslint-disable-next-line @typescript-eslint/no-this-alias\n            const me = this;\n            return OK(async function (...args) {\n                const error = new ZodError([]);\n                const parsedArgs = await me._def.args.parseAsync(args, params).catch((e) => {\n                    error.addIssue(makeArgsIssue(args, e));\n                    throw error;\n                });\n                const result = await Reflect.apply(fn, this, parsedArgs);\n                const parsedReturns = await me._def.returns._def.type\n                    .parseAsync(result, params)\n                    .catch((e) => {\n                    error.addIssue(makeReturnsIssue(result, e));\n                    throw error;\n                });\n                return parsedReturns;\n            });\n        }\n        else {\n            // Would love a way to avoid disabling this rule, but we need\n            // an alias (using an arrow function was what caused 2651).\n            // eslint-disable-next-line @typescript-eslint/no-this-alias\n            const me = this;\n            return OK(function (...args) {\n                const parsedArgs = me._def.args.safeParse(args, params);\n                if (!parsedArgs.success) {\n                    throw new ZodError([makeArgsIssue(args, parsedArgs.error)]);\n                }\n                const result = Reflect.apply(fn, this, parsedArgs.data);\n                const parsedReturns = me._def.returns.safeParse(result, params);\n                if (!parsedReturns.success) {\n                    throw new ZodError([makeReturnsIssue(result, parsedReturns.error)]);\n                }\n                return parsedReturns.data;\n            });\n        }\n    }\n    parameters() {\n        return this._def.args;\n    }\n    returnType() {\n        return this._def.returns;\n    }\n    args(...items) {\n        return new ZodFunction({\n            ...this._def,\n            args: ZodTuple.create(items).rest(ZodUnknown.create()),\n        });\n    }\n    returns(returnType) {\n        return new ZodFunction({\n            ...this._def,\n            returns: returnType,\n        });\n    }\n    implement(func) {\n        const validatedFunc = this.parse(func);\n        return validatedFunc;\n    }\n    strictImplement(func) {\n        const validatedFunc = this.parse(func);\n        return validatedFunc;\n    }\n    static create(args, returns, params) {\n        return new ZodFunction({\n            args: (args ? args : ZodTuple.create([]).rest(ZodUnknown.create())),\n            returns: returns || ZodUnknown.create(),\n            typeName: ZodFirstPartyTypeKind.ZodFunction,\n            ...processCreateParams(params),\n        });\n    }\n}\nexport class ZodLazy extends ZodType {\n    get schema() {\n        return this._def.getter();\n    }\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        const lazySchema = this._def.getter();\n        return lazySchema._parse({ data: ctx.data, path: ctx.path, parent: ctx });\n    }\n}\nZodLazy.create = (getter, params) => {\n    return new ZodLazy({\n        getter: getter,\n        typeName: ZodFirstPartyTypeKind.ZodLazy,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodLiteral extends ZodType {\n    _parse(input) {\n        if (input.data !== this._def.value) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                received: ctx.data,\n                code: ZodIssueCode.invalid_literal,\n                expected: this._def.value,\n            });\n            return INVALID;\n        }\n        return { status: \"valid\", value: input.data };\n    }\n    get value() {\n        return this._def.value;\n    }\n}\nZodLiteral.create = (value, params) => {\n    return new ZodLiteral({\n        value: value,\n        typeName: ZodFirstPartyTypeKind.ZodLiteral,\n        ...processCreateParams(params),\n    });\n};\nfunction createZodEnum(values, params) {\n    return new ZodEnum({\n        values,\n        typeName: ZodFirstPartyTypeKind.ZodEnum,\n        ...processCreateParams(params),\n    });\n}\nexport class ZodEnum extends ZodType {\n    _parse(input) {\n        if (typeof input.data !== \"string\") {\n            const ctx = this._getOrReturnCtx(input);\n            const expectedValues = this._def.values;\n            addIssueToContext(ctx, {\n                expected: util.joinValues(expectedValues),\n                received: ctx.parsedType,\n                code: ZodIssueCode.invalid_type,\n            });\n            return INVALID;\n        }\n        if (!this._cache) {\n            this._cache = new Set(this._def.values);\n        }\n        if (!this._cache.has(input.data)) {\n            const ctx = this._getOrReturnCtx(input);\n            const expectedValues = this._def.values;\n            addIssueToContext(ctx, {\n                received: ctx.data,\n                code: ZodIssueCode.invalid_enum_value,\n                options: expectedValues,\n            });\n            return INVALID;\n        }\n        return OK(input.data);\n    }\n    get options() {\n        return this._def.values;\n    }\n    get enum() {\n        const enumValues = {};\n        for (const val of this._def.values) {\n            enumValues[val] = val;\n        }\n        return enumValues;\n    }\n    get Values() {\n        const enumValues = {};\n        for (const val of this._def.values) {\n            enumValues[val] = val;\n        }\n        return enumValues;\n    }\n    get Enum() {\n        const enumValues = {};\n        for (const val of this._def.values) {\n            enumValues[val] = val;\n        }\n        return enumValues;\n    }\n    extract(values, newDef = this._def) {\n        return ZodEnum.create(values, {\n            ...this._def,\n            ...newDef,\n        });\n    }\n    exclude(values, newDef = this._def) {\n        return ZodEnum.create(this.options.filter((opt) => !values.includes(opt)), {\n            ...this._def,\n            ...newDef,\n        });\n    }\n}\nZodEnum.create = createZodEnum;\nexport class ZodNativeEnum extends ZodType {\n    _parse(input) {\n        const nativeEnumValues = util.getValidEnumValues(this._def.values);\n        const ctx = this._getOrReturnCtx(input);\n        if (ctx.parsedType !== ZodParsedType.string && ctx.parsedType !== ZodParsedType.number) {\n            const expectedValues = util.objectValues(nativeEnumValues);\n            addIssueToContext(ctx, {\n                expected: util.joinValues(expectedValues),\n                received: ctx.parsedType,\n                code: ZodIssueCode.invalid_type,\n            });\n            return INVALID;\n        }\n        if (!this._cache) {\n            this._cache = new Set(util.getValidEnumValues(this._def.values));\n        }\n        if (!this._cache.has(input.data)) {\n            const expectedValues = util.objectValues(nativeEnumValues);\n            addIssueToContext(ctx, {\n                received: ctx.data,\n                code: ZodIssueCode.invalid_enum_value,\n                options: expectedValues,\n            });\n            return INVALID;\n        }\n        return OK(input.data);\n    }\n    get enum() {\n        return this._def.values;\n    }\n}\nZodNativeEnum.create = (values, params) => {\n    return new ZodNativeEnum({\n        values: values,\n        typeName: ZodFirstPartyTypeKind.ZodNativeEnum,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodPromise extends ZodType {\n    unwrap() {\n        return this._def.type;\n    }\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        if (ctx.parsedType !== ZodParsedType.promise && ctx.common.async === false) {\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.promise,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        const promisified = ctx.parsedType === ZodParsedType.promise ? ctx.data : Promise.resolve(ctx.data);\n        return OK(promisified.then((data) => {\n            return this._def.type.parseAsync(data, {\n                path: ctx.path,\n                errorMap: ctx.common.contextualErrorMap,\n            });\n        }));\n    }\n}\nZodPromise.create = (schema, params) => {\n    return new ZodPromise({\n        type: schema,\n        typeName: ZodFirstPartyTypeKind.ZodPromise,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodEffects extends ZodType {\n    innerType() {\n        return this._def.schema;\n    }\n    sourceType() {\n        return this._def.schema._def.typeName === ZodFirstPartyTypeKind.ZodEffects\n            ? this._def.schema.sourceType()\n            : this._def.schema;\n    }\n    _parse(input) {\n        const { status, ctx } = this._processInputParams(input);\n        const effect = this._def.effect || null;\n        const checkCtx = {\n            addIssue: (arg) => {\n                addIssueToContext(ctx, arg);\n                if (arg.fatal) {\n                    status.abort();\n                }\n                else {\n                    status.dirty();\n                }\n            },\n            get path() {\n                return ctx.path;\n            },\n        };\n        checkCtx.addIssue = checkCtx.addIssue.bind(checkCtx);\n        if (effect.type === \"preprocess\") {\n            const processed = effect.transform(ctx.data, checkCtx);\n            if (ctx.common.async) {\n                return Promise.resolve(processed).then(async (processed) => {\n                    if (status.value === \"aborted\")\n                        return INVALID;\n                    const result = await this._def.schema._parseAsync({\n                        data: processed,\n                        path: ctx.path,\n                        parent: ctx,\n                    });\n                    if (result.status === \"aborted\")\n                        return INVALID;\n                    if (result.status === \"dirty\")\n                        return DIRTY(result.value);\n                    if (status.value === \"dirty\")\n                        return DIRTY(result.value);\n                    return result;\n                });\n            }\n            else {\n                if (status.value === \"aborted\")\n                    return INVALID;\n                const result = this._def.schema._parseSync({\n                    data: processed,\n                    path: ctx.path,\n                    parent: ctx,\n                });\n                if (result.status === \"aborted\")\n                    return INVALID;\n                if (result.status === \"dirty\")\n                    return DIRTY(result.value);\n                if (status.value === \"dirty\")\n                    return DIRTY(result.value);\n                return result;\n            }\n        }\n        if (effect.type === \"refinement\") {\n            const executeRefinement = (acc) => {\n                const result = effect.refinement(acc, checkCtx);\n                if (ctx.common.async) {\n                    return Promise.resolve(result);\n                }\n                if (result instanceof Promise) {\n                    throw new Error(\"Async refinement encountered during synchronous parse operation. Use .parseAsync instead.\");\n                }\n                return acc;\n            };\n            if (ctx.common.async === false) {\n                const inner = this._def.schema._parseSync({\n                    data: ctx.data,\n                    path: ctx.path,\n                    parent: ctx,\n                });\n                if (inner.status === \"aborted\")\n                    return INVALID;\n                if (inner.status === \"dirty\")\n                    status.dirty();\n                // return value is ignored\n                executeRefinement(inner.value);\n                return { status: status.value, value: inner.value };\n            }\n            else {\n                return this._def.schema._parseAsync({ data: ctx.data, path: ctx.path, parent: ctx }).then((inner) => {\n                    if (inner.status === \"aborted\")\n                        return INVALID;\n                    if (inner.status === \"dirty\")\n                        status.dirty();\n                    return executeRefinement(inner.value).then(() => {\n                        return { status: status.value, value: inner.value };\n                    });\n                });\n            }\n        }\n        if (effect.type === \"transform\") {\n            if (ctx.common.async === false) {\n                const base = this._def.schema._parseSync({\n                    data: ctx.data,\n                    path: ctx.path,\n                    parent: ctx,\n                });\n                if (!isValid(base))\n                    return INVALID;\n                const result = effect.transform(base.value, checkCtx);\n                if (result instanceof Promise) {\n                    throw new Error(`Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.`);\n                }\n                return { status: status.value, value: result };\n            }\n            else {\n                return this._def.schema._parseAsync({ data: ctx.data, path: ctx.path, parent: ctx }).then((base) => {\n                    if (!isValid(base))\n                        return INVALID;\n                    return Promise.resolve(effect.transform(base.value, checkCtx)).then((result) => ({\n                        status: status.value,\n                        value: result,\n                    }));\n                });\n            }\n        }\n        util.assertNever(effect);\n    }\n}\nZodEffects.create = (schema, effect, params) => {\n    return new ZodEffects({\n        schema,\n        typeName: ZodFirstPartyTypeKind.ZodEffects,\n        effect,\n        ...processCreateParams(params),\n    });\n};\nZodEffects.createWithPreprocess = (preprocess, schema, params) => {\n    return new ZodEffects({\n        schema,\n        effect: { type: \"preprocess\", transform: preprocess },\n        typeName: ZodFirstPartyTypeKind.ZodEffects,\n        ...processCreateParams(params),\n    });\n};\nexport { ZodEffects as ZodTransformer };\nexport class ZodOptional extends ZodType {\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType === ZodParsedType.undefined) {\n            return OK(undefined);\n        }\n        return this._def.innerType._parse(input);\n    }\n    unwrap() {\n        return this._def.innerType;\n    }\n}\nZodOptional.create = (type, params) => {\n    return new ZodOptional({\n        innerType: type,\n        typeName: ZodFirstPartyTypeKind.ZodOptional,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodNullable extends ZodType {\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType === ZodParsedType.null) {\n            return OK(null);\n        }\n        return this._def.innerType._parse(input);\n    }\n    unwrap() {\n        return this._def.innerType;\n    }\n}\nZodNullable.create = (type, params) => {\n    return new ZodNullable({\n        innerType: type,\n        typeName: ZodFirstPartyTypeKind.ZodNullable,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodDefault extends ZodType {\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        let data = ctx.data;\n        if (ctx.parsedType === ZodParsedType.undefined) {\n            data = this._def.defaultValue();\n        }\n        return this._def.innerType._parse({\n            data,\n            path: ctx.path,\n            parent: ctx,\n        });\n    }\n    removeDefault() {\n        return this._def.innerType;\n    }\n}\nZodDefault.create = (type, params) => {\n    return new ZodDefault({\n        innerType: type,\n        typeName: ZodFirstPartyTypeKind.ZodDefault,\n        defaultValue: typeof params.default === \"function\" ? params.default : () => params.default,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodCatch extends ZodType {\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        // newCtx is used to not collect issues from inner types in ctx\n        const newCtx = {\n            ...ctx,\n            common: {\n                ...ctx.common,\n                issues: [],\n            },\n        };\n        const result = this._def.innerType._parse({\n            data: newCtx.data,\n            path: newCtx.path,\n            parent: {\n                ...newCtx,\n            },\n        });\n        if (isAsync(result)) {\n            return result.then((result) => {\n                return {\n                    status: \"valid\",\n                    value: result.status === \"valid\"\n                        ? result.value\n                        : this._def.catchValue({\n                            get error() {\n                                return new ZodError(newCtx.common.issues);\n                            },\n                            input: newCtx.data,\n                        }),\n                };\n            });\n        }\n        else {\n            return {\n                status: \"valid\",\n                value: result.status === \"valid\"\n                    ? result.value\n                    : this._def.catchValue({\n                        get error() {\n                            return new ZodError(newCtx.common.issues);\n                        },\n                        input: newCtx.data,\n                    }),\n            };\n        }\n    }\n    removeCatch() {\n        return this._def.innerType;\n    }\n}\nZodCatch.create = (type, params) => {\n    return new ZodCatch({\n        innerType: type,\n        typeName: ZodFirstPartyTypeKind.ZodCatch,\n        catchValue: typeof params.catch === \"function\" ? params.catch : () => params.catch,\n        ...processCreateParams(params),\n    });\n};\nexport class ZodNaN extends ZodType {\n    _parse(input) {\n        const parsedType = this._getType(input);\n        if (parsedType !== ZodParsedType.nan) {\n            const ctx = this._getOrReturnCtx(input);\n            addIssueToContext(ctx, {\n                code: ZodIssueCode.invalid_type,\n                expected: ZodParsedType.nan,\n                received: ctx.parsedType,\n            });\n            return INVALID;\n        }\n        return { status: \"valid\", value: input.data };\n    }\n}\nZodNaN.create = (params) => {\n    return new ZodNaN({\n        typeName: ZodFirstPartyTypeKind.ZodNaN,\n        ...processCreateParams(params),\n    });\n};\nexport const BRAND = Symbol(\"zod_brand\");\nexport class ZodBranded extends ZodType {\n    _parse(input) {\n        const { ctx } = this._processInputParams(input);\n        const data = ctx.data;\n        return this._def.type._parse({\n            data,\n            path: ctx.path,\n            parent: ctx,\n        });\n    }\n    unwrap() {\n        return this._def.type;\n    }\n}\nexport class ZodPipeline extends ZodType {\n    _parse(input) {\n        const { status, ctx } = this._processInputParams(input);\n        if (ctx.common.async) {\n            const handleAsync = async () => {\n                const inResult = await this._def.in._parseAsync({\n                    data: ctx.data,\n                    path: ctx.path,\n                    parent: ctx,\n                });\n                if (inResult.status === \"aborted\")\n                    return INVALID;\n                if (inResult.status === \"dirty\") {\n                    status.dirty();\n                    return DIRTY(inResult.value);\n                }\n                else {\n                    return this._def.out._parseAsync({\n                        data: inResult.value,\n                        path: ctx.path,\n                        parent: ctx,\n                    });\n                }\n            };\n            return handleAsync();\n        }\n        else {\n            const inResult = this._def.in._parseSync({\n                data: ctx.data,\n                path: ctx.path,\n                parent: ctx,\n            });\n            if (inResult.status === \"aborted\")\n                return INVALID;\n            if (inResult.status === \"dirty\") {\n                status.dirty();\n                return {\n                    status: \"dirty\",\n                    value: inResult.value,\n                };\n            }\n            else {\n                return this._def.out._parseSync({\n                    data: inResult.value,\n                    path: ctx.path,\n                    parent: ctx,\n                });\n            }\n        }\n    }\n    static create(a, b) {\n        return new ZodPipeline({\n            in: a,\n            out: b,\n            typeName: ZodFirstPartyTypeKind.ZodPipeline,\n        });\n    }\n}\nexport class ZodReadonly extends ZodType {\n    _parse(input) {\n        const result = this._def.innerType._parse(input);\n        const freeze = (data) => {\n            if (isValid(data)) {\n                data.value = Object.freeze(data.value);\n            }\n            return data;\n        };\n        return isAsync(result) ? result.then((data) => freeze(data)) : freeze(result);\n    }\n    unwrap() {\n        return this._def.innerType;\n    }\n}\nZodReadonly.create = (type, params) => {\n    return new ZodReadonly({\n        innerType: type,\n        typeName: ZodFirstPartyTypeKind.ZodReadonly,\n        ...processCreateParams(params),\n    });\n};\n////////////////////////////////////////\n////////////////////////////////////////\n//////////                    //////////\n//////////      z.custom      //////////\n//////////                    //////////\n////////////////////////////////////////\n////////////////////////////////////////\nfunction cleanParams(params, data) {\n    const p = typeof params === \"function\" ? params(data) : typeof params === \"string\" ? { message: params } : params;\n    const p2 = typeof p === \"string\" ? { message: p } : p;\n    return p2;\n}\nexport function custom(check, _params = {}, \n/**\n * @deprecated\n *\n * Pass `fatal` into the params object instead:\n *\n * ```ts\n * z.string().custom((val) => val.length > 5, { fatal: false })\n * ```\n *\n */\nfatal) {\n    if (check)\n        return ZodAny.create().superRefine((data, ctx) => {\n            const r = check(data);\n            if (r instanceof Promise) {\n                return r.then((r) => {\n                    if (!r) {\n                        const params = cleanParams(_params, data);\n                        const _fatal = params.fatal ?? fatal ?? true;\n                        ctx.addIssue({ code: \"custom\", ...params, fatal: _fatal });\n                    }\n                });\n            }\n            if (!r) {\n                const params = cleanParams(_params, data);\n                const _fatal = params.fatal ?? fatal ?? true;\n                ctx.addIssue({ code: \"custom\", ...params, fatal: _fatal });\n            }\n            return;\n        });\n    return ZodAny.create();\n}\nexport { ZodType as Schema, ZodType as ZodSchema };\nexport const late = {\n    object: ZodObject.lazycreate,\n};\nexport var ZodFirstPartyTypeKind;\n(function (ZodFirstPartyTypeKind) {\n    ZodFirstPartyTypeKind[\"ZodString\"] = \"ZodString\";\n    ZodFirstPartyTypeKind[\"ZodNumber\"] = \"ZodNumber\";\n    ZodFirstPartyTypeKind[\"ZodNaN\"] = \"ZodNaN\";\n    ZodFirstPartyTypeKind[\"ZodBigInt\"] = \"ZodBigInt\";\n    ZodFirstPartyTypeKind[\"ZodBoolean\"] = \"ZodBoolean\";\n    ZodFirstPartyTypeKind[\"ZodDate\"] = \"ZodDate\";\n    ZodFirstPartyTypeKind[\"ZodSymbol\"] = \"ZodSymbol\";\n    ZodFirstPartyTypeKind[\"ZodUndefined\"] = \"ZodUndefined\";\n    ZodFirstPartyTypeKind[\"ZodNull\"] = \"ZodNull\";\n    ZodFirstPartyTypeKind[\"ZodAny\"] = \"ZodAny\";\n    ZodFirstPartyTypeKind[\"ZodUnknown\"] = \"ZodUnknown\";\n    ZodFirstPartyTypeKind[\"ZodNever\"] = \"ZodNever\";\n    ZodFirstPartyTypeKind[\"ZodVoid\"] = \"ZodVoid\";\n    ZodFirstPartyTypeKind[\"ZodArray\"] = \"ZodArray\";\n    ZodFirstPartyTypeKind[\"ZodObject\"] = \"ZodObject\";\n    ZodFirstPartyTypeKind[\"ZodUnion\"] = \"ZodUnion\";\n    ZodFirstPartyTypeKind[\"ZodDiscriminatedUnion\"] = \"ZodDiscriminatedUnion\";\n    ZodFirstPartyTypeKind[\"ZodIntersection\"] = \"ZodIntersection\";\n    ZodFirstPartyTypeKind[\"ZodTuple\"] = \"ZodTuple\";\n    ZodFirstPartyTypeKind[\"ZodRecord\"] = \"ZodRecord\";\n    ZodFirstPartyTypeKind[\"ZodMap\"] = \"ZodMap\";\n    ZodFirstPartyTypeKind[\"ZodSet\"] = \"ZodSet\";\n    ZodFirstPartyTypeKind[\"ZodFunction\"] = \"ZodFunction\";\n    ZodFirstPartyTypeKind[\"ZodLazy\"] = \"ZodLazy\";\n    ZodFirstPartyTypeKind[\"ZodLiteral\"] = \"ZodLiteral\";\n    ZodFirstPartyTypeKind[\"ZodEnum\"] = \"ZodEnum\";\n    ZodFirstPartyTypeKind[\"ZodEffects\"] = \"ZodEffects\";\n    ZodFirstPartyTypeKind[\"ZodNativeEnum\"] = \"ZodNativeEnum\";\n    ZodFirstPartyTypeKind[\"ZodOptional\"] = \"ZodOptional\";\n    ZodFirstPartyTypeKind[\"ZodNullable\"] = \"ZodNullable\";\n    ZodFirstPartyTypeKind[\"ZodDefault\"] = \"ZodDefault\";\n    ZodFirstPartyTypeKind[\"ZodCatch\"] = \"ZodCatch\";\n    ZodFirstPartyTypeKind[\"ZodPromise\"] = \"ZodPromise\";\n    ZodFirstPartyTypeKind[\"ZodBranded\"] = \"ZodBranded\";\n    ZodFirstPartyTypeKind[\"ZodPipeline\"] = \"ZodPipeline\";\n    ZodFirstPartyTypeKind[\"ZodReadonly\"] = \"ZodReadonly\";\n})(ZodFirstPartyTypeKind || (ZodFirstPartyTypeKind = {}));\n// requires TS 4.4+\nclass Class {\n    constructor(..._) { }\n}\nconst instanceOfType = (\n// const instanceOfType = <T extends new (...args: any[]) => any>(\ncls, params = {\n    message: `Input not instance of ${cls.name}`,\n}) => custom((data) => data instanceof cls, params);\nconst stringType = ZodString.create;\nconst numberType = ZodNumber.create;\nconst nanType = ZodNaN.create;\nconst bigIntType = ZodBigInt.create;\nconst booleanType = ZodBoolean.create;\nconst dateType = ZodDate.create;\nconst symbolType = ZodSymbol.create;\nconst undefinedType = ZodUndefined.create;\nconst nullType = ZodNull.create;\nconst anyType = ZodAny.create;\nconst unknownType = ZodUnknown.create;\nconst neverType = ZodNever.create;\nconst voidType = ZodVoid.create;\nconst arrayType = ZodArray.create;\nconst objectType = ZodObject.create;\nconst strictObjectType = ZodObject.strictCreate;\nconst unionType = ZodUnion.create;\nconst discriminatedUnionType = ZodDiscriminatedUnion.create;\nconst intersectionType = ZodIntersection.create;\nconst tupleType = ZodTuple.create;\nconst recordType = ZodRecord.create;\nconst mapType = ZodMap.create;\nconst setType = ZodSet.create;\nconst functionType = ZodFunction.create;\nconst lazyType = ZodLazy.create;\nconst literalType = ZodLiteral.create;\nconst enumType = ZodEnum.create;\nconst nativeEnumType = ZodNativeEnum.create;\nconst promiseType = ZodPromise.create;\nconst effectsType = ZodEffects.create;\nconst optionalType = ZodOptional.create;\nconst nullableType = ZodNullable.create;\nconst preprocessType = ZodEffects.createWithPreprocess;\nconst pipelineType = ZodPipeline.create;\nconst ostring = () => stringType().optional();\nconst onumber = () => numberType().optional();\nconst oboolean = () => booleanType().optional();\nexport const coerce = {\n    string: ((arg) => ZodString.create({ ...arg, coerce: true })),\n    number: ((arg) => ZodNumber.create({ ...arg, coerce: true })),\n    boolean: ((arg) => ZodBoolean.create({\n        ...arg,\n        coerce: true,\n    })),\n    bigint: ((arg) => ZodBigInt.create({ ...arg, coerce: true })),\n    date: ((arg) => ZodDate.create({ ...arg, coerce: true })),\n};\nexport { anyType as any, arrayType as array, bigIntType as bigint, booleanType as boolean, dateType as date, discriminatedUnionType as discriminatedUnion, effectsType as effect, enumType as enum, functionType as function, instanceOfType as instanceof, intersectionType as intersection, lazyType as lazy, literalType as literal, mapType as map, nanType as nan, nativeEnumType as nativeEnum, neverType as never, nullType as null, nullableType as nullable, numberType as number, objectType as object, oboolean, onumber, optionalType as optional, ostring, pipelineType as pipeline, preprocessType as preprocess, promiseType as promise, recordType as record, setType as set, strictObjectType as strictObject, stringType as string, symbolType as symbol, effectsType as transformer, tupleType as tuple, undefinedType as undefined, unionType as union, unknownType as unknown, voidType as void, };\nexport const NEVER = INVALID;\n", "import { z } from \"zod\";\n\ninterface KvNamespace {\n  get(key: string, options?: { type: \"text\" | \"json\" | \"arrayBuffer\" }): Promise<any>;\n  put(\n    key: string,\n    value: string,\n    options?: { expiration?: number; expirationTtl?: number; metadata?: unknown },\n  ): Promise<void>;\n  delete(key: string): Promise<void>;\n}\n\nexport interface Env {\n  DB: D1Database;\n  ACCESS_JWKS_URL: string;\n  ACCESS_AUD: string;\n  APP_BASE_URL: string;\n  RETURN_DEFAULT: string;\n  ENVIRONMENT?: string;\n  DEV_ALLOW_USER?: string;\n  ALLOW_DEV_ACCESS_SHIM?: string;\n  APP_API_BASE?: string;\n  APP_ASSET_BASE?: string;\n  HEARTBEAT_INTERVAL_SECS?: string;\n  OFFLINE_MULTIPLIER?: string;\r\n  CURSOR_SECRET: string;\r\n  APP_STATIC?: R2Bucket;\r\n  GB_BUCKET?: R2Bucket;\r\n  RETENTION_ARCHIVE?: R2Bucket;\r\n  ASSET_SIGNING_SECRET?: string;\r\n  ALLOWED_PREFIXES?: string;\n  INGEST_ALLOWED_ORIGINS: string;\n  INGEST_RATE_LIMIT_PER_MIN: string;\n  INGEST_DEDUP_WINDOW_MINUTES?: string;\n  INGEST_SIGNATURE_TOLERANCE_SECS: string;\n  INGEST_FAILURE_LIMIT_PER_MIN?: string;\n  INGEST_IP_LIMIT_PER_MIN?: string;\n  INGEST_IP_BLOCK_SECONDS?: string;\n  INGEST_IP_BUCKETS?: KvNamespace;\n  TELEMETRY_RETENTION_DAYS?: string;\n  TELEMETRY_REFACTOR_MODE?: string;\n  RETENTION_BACKUP_PREFIX?: string;\n  RETENTION_BACKUP_BEFORE_DELETE?: string;\n  LOG_LEVEL?: string;\n  LOG_DEBUG_SAMPLE_RATE?: string;\n  LOG_REDACT_CLIENT_IP?: string;\n  LOG_REDACT_USER_AGENT?: string;\n  LOG_REDACT_CF_RAY?: string;\n  OBSERVABILITY_MAX_BYTES?: string;\n  TELEMETRY_CARRY_MAX_MINUTES?: string;\n}\n\r\nexport type User = {\r\n  email: string;\r\n  roles: Array<\"admin\" | \"client\" | \"contractor\">;\r\n  clientIds: string[];\r\n};\r\n\r\nexport class EnvValidationError extends Error {\r\n  readonly issues: string[];\r\n\r\n  constructor(issues: string[]) {\r\n    super(`Invalid environment configuration: ${issues.join(\"; \")}`);\r\n    this.name = \"EnvValidationError\";\r\n    this.issues = issues;\r\n  }\r\n}\r\n\r\nconst HTTP_SCHEMES = new Set([\"http:\", \"https:\"]);\nconst ABSOLUTE_SCHEME_PATTERN = /^[a-zA-Z][a-zA-Z\\d+\\-.]*:/;\nconst LOCAL_FLAG_VALUES = new Set([\"1\", \"true\", \"yes\", \"on\"]);\nconst DEV_SHIM_ENVIRONMENTS = new Set([\"development\", \"dev\", \"local\"]);\n\nfunction isHttpUrl(candidate: string): boolean {\n  try {\n    const parsed = new URL(candidate);\n    return HTTP_SCHEMES.has(parsed.protocol);\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction isSafeRelativePath(candidate: string): boolean {\r\n  return candidate.startsWith(\"/\") && !candidate.startsWith(\"//\");\r\n}\r\n\r\nconst EnvSchema = z\r\n  .object({\r\n    ACCESS_JWKS_URL: z\r\n      .string()\r\n      .min(1, \"ACCESS_JWKS_URL must be set\")\r\n      .refine((value: string) => isHttpUrl(value.trim()), {\r\n        message: \"ACCESS_JWKS_URL must be an http(s) URL\",\r\n      }),\r\n    ACCESS_AUD: z\r\n      .string()\r\n      .trim()\r\n      .min(1, \"ACCESS_AUD must be set\"),\r\n    APP_BASE_URL: z\r\n      .string()\r\n      .min(1, \"APP_BASE_URL must be set\")\r\n      .refine((value: string) => isHttpUrl(value.trim()), {\r\n        message: \"APP_BASE_URL must be an absolute http(s) URL\",\r\n      }),\r\n    RETURN_DEFAULT: z.string().min(1, \"RETURN_DEFAULT must be set\"),\r\n    CURSOR_SECRET: z\r\n      .string()\r\n      .trim()\r\n      .min(16, \"CURSOR_SECRET must be at least 16 characters long\"),\r\n  })\r\n  .passthrough()\r\n  .superRefine((value: Record<string, unknown>, ctx: z.RefinementCtx) => {\r\n    const binding = value.DB as unknown;\r\n    if (\r\n      !binding ||\r\n      typeof binding !== \"object\" ||\r\n      typeof (binding as { prepare?: unknown }).prepare !== \"function\"\r\n    ) {\r\n      ctx.addIssue({\r\n        path: [\"DB\"],\r\n        code: z.ZodIssueCode.custom,\r\n        message: \"DB binding must be configured with a D1 database\",\r\n      });\r\n    }\r\n\r\n    const appBase = typeof value.APP_BASE_URL === \"string\" ? value.APP_BASE_URL.trim() : \"\";\r\n    if (!appBase || !isHttpUrl(appBase)) {\r\n      ctx.addIssue({\r\n        path: [\"APP_BASE_URL\"],\r\n        code: z.ZodIssueCode.custom,\r\n        message: \"APP_BASE_URL must be an absolute http(s) URL\",\r\n      });\r\n    }\r\n\r\n    const returnDefault = typeof value.RETURN_DEFAULT === \"string\" ? value.RETURN_DEFAULT.trim() : \"\";\r\n    if (!returnDefault) {\r\n      ctx.addIssue({\r\n        path: [\"RETURN_DEFAULT\"],\r\n        code: z.ZodIssueCode.custom,\r\n        message: \"RETURN_DEFAULT must be set\",\r\n      });\r\n    } else if (!isSafeRelativePath(returnDefault) && !isHttpUrl(returnDefault)) {\r\n      ctx.addIssue({\r\n        path: [\"RETURN_DEFAULT\"],\r\n        code: z.ZodIssueCode.custom,\r\n        message: \"RETURN_DEFAULT must be a safe relative path or an absolute http(s) URL\",\r\n      });\r\n    }\r\n\r\n    const appApiBase = typeof value.APP_API_BASE === \"string\" ? value.APP_API_BASE.trim() : \"\";\r\n    if (appApiBase && ABSOLUTE_SCHEME_PATTERN.test(appApiBase) && !isHttpUrl(appApiBase)) {\r\n      ctx.addIssue({\r\n        path: [\"APP_API_BASE\"],\r\n        code: z.ZodIssueCode.custom,\r\n        message: \"APP_API_BASE must use http(s) scheme when absolute\",\r\n      });\r\n    }\r\n\r\n    const appAssetBase = typeof value.APP_ASSET_BASE === \"string\" ? value.APP_ASSET_BASE.trim() : \"\";\r\n    if (appAssetBase) {\r\n      if (appAssetBase.startsWith(\"//\")) {\r\n        // protocol-relative URLs are acceptable\r\n        // ensure host portion exists by attempting to parse with https:// prefix\r\n        try {\r\n          const parsed = new URL(`https:${appAssetBase}`);\r\n          if (!parsed.host) {\r\n            throw new Error(\"missing host\");\r\n          }\r\n        } catch {\r\n          ctx.addIssue({\r\n            path: [\"APP_ASSET_BASE\"],\r\n            code: z.ZodIssueCode.custom,\r\n            message: \"APP_ASSET_BASE protocol-relative URLs must include a host\",\r\n          });\r\n        }\r\n      } else if (ABSOLUTE_SCHEME_PATTERN.test(appAssetBase) && !isHttpUrl(appAssetBase)) {\r\n        ctx.addIssue({\r\n          path: [\"APP_ASSET_BASE\"],\r\n          code: z.ZodIssueCode.custom,\r\n          message: \"APP_ASSET_BASE must use http(s) scheme when absolute\",\r\n        });\r\n      }\r\n    }\r\n\r\n    const ingestOriginsRaw =\r\n      typeof value.INGEST_ALLOWED_ORIGINS === \"string\" ? value.INGEST_ALLOWED_ORIGINS.trim() : \"\";\r\n    const ingestRateLimitRaw =\n      typeof value.INGEST_RATE_LIMIT_PER_MIN === \"string\"\n        ? value.INGEST_RATE_LIMIT_PER_MIN.trim()\n        : \"\";\n    const ingestFailureLimitRaw =\n      typeof value.INGEST_FAILURE_LIMIT_PER_MIN === \"string\"\n        ? value.INGEST_FAILURE_LIMIT_PER_MIN.trim()\n        : \"\";\n    const ingestToleranceRaw =\n      typeof value.INGEST_SIGNATURE_TOLERANCE_SECS === \"string\"\n        ? value.INGEST_SIGNATURE_TOLERANCE_SECS.trim()\n        : \"\";\n    const ingestIpLimitRaw =\n      typeof value.INGEST_IP_LIMIT_PER_MIN === \"string\"\n        ? value.INGEST_IP_LIMIT_PER_MIN.trim()\n        : \"\";\n    const ingestIpBlockRaw =\n      typeof value.INGEST_IP_BLOCK_SECONDS === \"string\"\n        ? value.INGEST_IP_BLOCK_SECONDS.trim()\n        : \"\";\n    const normalizedAllowShim =\n      typeof value.ALLOW_DEV_ACCESS_SHIM === \"string\"\n        ? value.ALLOW_DEV_ACCESS_SHIM.trim().toLowerCase()\n        : \"\";\n    const allowShimFlag =\n      normalizedAllowShim.length > 0 && LOCAL_FLAG_VALUES.has(normalizedAllowShim);\n    const hasDevUser =\n      typeof value.DEV_ALLOW_USER === \"string\" && value.DEV_ALLOW_USER.trim().length > 0;\n    const rawEnvironment =\n      typeof value.ENVIRONMENT === \"string\" ? value.ENVIRONMENT.trim().toLowerCase() : \"\";\n    const environmentAllowsShim =\n      rawEnvironment.length > 0 && DEV_SHIM_ENVIRONMENTS.has(rawEnvironment);\n    const appBaseLower = appBase.toLowerCase();\n    const appBaseIsLocal =\n      appBaseLower.startsWith(\"http://localhost\") ||\n      appBaseLower.startsWith(\"http://127.0.0.1\") ||\n      appBaseLower.startsWith(\"http://0.0.0.0\") ||\n      appBaseLower.startsWith(\"http://[::1]\");\n\n    if (allowShimFlag && !environmentAllowsShim) {\n      ctx.addIssue({\n        path: [\"ALLOW_DEV_ACCESS_SHIM\"],\n        code: z.ZodIssueCode.custom,\n        message: \"ALLOW_DEV_ACCESS_SHIM requires ENVIRONMENT to be one of development, dev, local, test\",\n      });\n    }\n\n    if (allowShimFlag && !appBaseIsLocal) {\n      ctx.addIssue({\n        path: [\"ALLOW_DEV_ACCESS_SHIM\"],\n        code: z.ZodIssueCode.custom,\n        message:\n          \"ALLOW_DEV_ACCESS_SHIM may only be enabled when APP_BASE_URL points to a localhost origin\",\n      });\n    }\n\n    const isLocalEnv = hasDevUser || appBaseIsLocal || environmentAllowsShim;\n\n    if (!ingestOriginsRaw) {\n      if (isLocalEnv) {\n        console.warn(\"INGEST_ALLOWED_ORIGINS is not set; ingest endpoints will deny browser origins.\");\n      } else {\r\n        ctx.addIssue({\r\n          path: [\"INGEST_ALLOWED_ORIGINS\"],\r\n          code: z.ZodIssueCode.custom,\r\n          message: \"INGEST_ALLOWED_ORIGINS must be configured for non-local environments\",\r\n        });\n      }\n    }\n\n    if (ingestIpLimitRaw) {\n      const parsed = Number.parseInt(ingestIpLimitRaw, 10);\n      if (!Number.isFinite(parsed) || parsed < 0) {\n        ctx.addIssue({\n          path: [\"INGEST_IP_LIMIT_PER_MIN\"],\n          code: z.ZodIssueCode.custom,\n          message: \"INGEST_IP_LIMIT_PER_MIN must be zero or a positive integer when set\",\n        });\n      }\n      if (parsed > 0 && ingestIpBlockRaw) {\n        const block = Number.parseInt(ingestIpBlockRaw, 10);\n        if (!Number.isFinite(block) || block <= 0) {\n          ctx.addIssue({\n            path: [\"INGEST_IP_BLOCK_SECONDS\"],\n            code: z.ZodIssueCode.custom,\n            message: \"INGEST_IP_BLOCK_SECONDS must be a positive integer when set\",\n          });\n        }\n      }\n      if (parsed > 0 && !value.INGEST_IP_BUCKETS && !isLocalEnv) {\n        console.warn(\n          \"INGEST_IP_LIMIT_PER_MIN is enabled without an INGEST_IP_BUCKETS binding; falling back to in-memory token buckets per isolate.\",\n        );\n      }\n    } else if (ingestIpBlockRaw) {\n      const block = Number.parseInt(ingestIpBlockRaw, 10);\n      if (!Number.isFinite(block) || block <= 0) {\n        ctx.addIssue({\n          path: [\"INGEST_IP_BLOCK_SECONDS\"],\n          code: z.ZodIssueCode.custom,\n          message: \"INGEST_IP_BLOCK_SECONDS must be a positive integer when set\",\n        });\n      }\n    }\n\n    if (!ingestRateLimitRaw) {\n      ctx.addIssue({\n        path: [\"INGEST_RATE_LIMIT_PER_MIN\"],\n        code: z.ZodIssueCode.custom,\n        message: \"INGEST_RATE_LIMIT_PER_MIN must be configured\",\n      });\r\n    } else {\r\n      const parsed = Number.parseInt(ingestRateLimitRaw, 10);\r\n      if (Number.isNaN(parsed) || parsed <= 0) {\r\n        ctx.addIssue({\r\n          path: [\"INGEST_RATE_LIMIT_PER_MIN\"],\r\n          code: z.ZodIssueCode.custom,\r\n          message: \"INGEST_RATE_LIMIT_PER_MIN must be a positive integer\",\r\n        });\n      }\n    }\n\n    if (ingestFailureLimitRaw) {\n      const parsed = Number.parseInt(ingestFailureLimitRaw, 10);\n      if (Number.isNaN(parsed) || parsed < 0) {\n        ctx.addIssue({\n          path: [\"INGEST_FAILURE_LIMIT_PER_MIN\"],\n          code: z.ZodIssueCode.custom,\n          message: \"INGEST_FAILURE_LIMIT_PER_MIN must be a non-negative integer\",\n        });\n      }\n    }\n\n    if (!ingestToleranceRaw) {\n      ctx.addIssue({\n        path: [\"INGEST_SIGNATURE_TOLERANCE_SECS\"],\n        code: z.ZodIssueCode.custom,\n        message: \"INGEST_SIGNATURE_TOLERANCE_SECS must be configured\",\n      });\r\n    } else {\n      const parsed = Number.parseInt(ingestToleranceRaw, 10);\n      if (Number.isNaN(parsed) || parsed < 0) {\n        ctx.addIssue({\n          path: [\"INGEST_SIGNATURE_TOLERANCE_SECS\"],\n          code: z.ZodIssueCode.custom,\n          message: \"INGEST_SIGNATURE_TOLERANCE_SECS must be zero or a positive integer\",\n        });\n      }\n    }\n\n    const logLevelRaw = typeof value.LOG_LEVEL === \"string\" ? value.LOG_LEVEL.trim().toLowerCase() : \"\";\n    if (logLevelRaw && ![\"debug\", \"info\", \"warn\", \"error\"].includes(logLevelRaw)) {\n      ctx.addIssue({\n        path: [\"LOG_LEVEL\"],\n        code: z.ZodIssueCode.custom,\n        message: \"LOG_LEVEL must be one of debug, info, warn, error\",\n      });\n    }\n\n    const logSampleRaw =\n      typeof value.LOG_DEBUG_SAMPLE_RATE === \"string\" ? value.LOG_DEBUG_SAMPLE_RATE.trim() : \"\";\n    if (logSampleRaw) {\n      const parsed = Number(logSampleRaw);\n      if (!Number.isFinite(parsed) || parsed <= 0) {\n        ctx.addIssue({\n          path: [\"LOG_DEBUG_SAMPLE_RATE\"],\n          code: z.ZodIssueCode.custom,\n          message: \"LOG_DEBUG_SAMPLE_RATE must be a positive number\",\n        });\n      }\n    }\n\n    const observabilityMaxRaw =\n      typeof value.OBSERVABILITY_MAX_BYTES === \"string\" ? value.OBSERVABILITY_MAX_BYTES.trim() : \"\";\n    if (observabilityMaxRaw) {\n      const parsed = Number(observabilityMaxRaw);\n      if (!Number.isFinite(parsed) || parsed <= 0) {\n        ctx.addIssue({\n          path: [\"OBSERVABILITY_MAX_BYTES\"],\n          code: z.ZodIssueCode.custom,\n          message: \"OBSERVABILITY_MAX_BYTES must be a positive integer\",\n        });\n      }\n    }\n\n    const carryForwardRaw =\n      typeof value.TELEMETRY_CARRY_MAX_MINUTES === \"string\"\n        ? value.TELEMETRY_CARRY_MAX_MINUTES.trim()\n        : \"\";\n    if (carryForwardRaw) {\n      const parsed = Number.parseInt(carryForwardRaw, 10);\n      if (!Number.isFinite(parsed) || parsed <= 0) {\n        ctx.addIssue({\n          path: [\"TELEMETRY_CARRY_MAX_MINUTES\"],\n          code: z.ZodIssueCode.custom,\n          message: \"TELEMETRY_CARRY_MAX_MINUTES must be a positive integer\",\n        });\n      }\n    }\n  });\n\r\nconst validatedEnvs = new WeakSet<object>();\r\n\r\nexport function validateEnv(env: Env): Env {\r\n  if (validatedEnvs.has(env as unknown as object)) {\r\n    return env;\r\n  }\r\n\r\n  const result = EnvSchema.safeParse(env);\r\n  if (!result.success) {\r\n    const issues = result.error.issues.map((issue: z.ZodIssue) => {\r\n      const path = issue.path.length ? issue.path.join(\".\") : \"env\";\r\n      return `${path}: ${issue.message}`;\r\n    });\r\n    throw new EnvValidationError(issues);\r\n  }\r\n\r\n  validatedEnvs.add(env as unknown as object);\r\n  return env;\r\n}\r\n", "{\r\n    \"Gear_Icon_01.svg\":  \"\\u003csvg viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"\\u003e\\u003ccircle cx=\\\"12\\\" cy=\\\"12\\\" r=\\\"3\\\" fill=\\\"#52ff99\\\"/\\u003e\\u003cpath d=\\\"M3 12h3m12 0h3M12 3v3m0 12v3M5 5l2.1 2.1M16.9 16.9L19 19M19 5l-2.1 2.1M7.1 16.9 5 19\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/\\u003e\\u003c/svg\\u003e\",\r\n    \"GREENBRO LOGO APP.svg\":  \"\\u003csvg viewBox=\\\"0 0 320 64\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" role=\\\"img\\\" aria-label=\\\"GreenBro\\\"\\u003e\\u003crect width=\\\"320\\\" height=\\\"64\\\" rx=\\\"12\\\" fill=\\\"#0b1e14\\\"/\\u003e\\u003ctext x=\\\"32\\\" y=\\\"40\\\" font-size=\\\"28\\\" font-family=\\\"Arial, Helvetica, sans-serif\\\" fill=\\\"#52ff99\\\"\\u003eGreenBro\\u003c/text\\u003e\\u003c/svg\\u003e\",\r\n    \"Gear_Icon_02.svg\":  \"\\u003csvg viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"\\u003e\\u003crect x=\\\"6\\\" y=\\\"6\\\" width=\\\"12\\\" height=\\\"12\\\" rx=\\\"2\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/\\u003e\\u003ccircle cx=\\\"12\\\" cy=\\\"12\\\" r=\\\"2\\\" fill=\\\"#52ff99\\\"/\\u003e\\u003c/svg\\u003e\",\r\n    \"Gear_Icon_03.svg\":  \"\\u003csvg viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\"\\u003e\\u003cpath d=\\\"M4 12a8 8 0 1 0 16 0\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/\\u003e\\u003cpath d=\\\"M12 4a8 8 0 0 0 0 16\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/\\u003e\\u003c/svg\\u003e\"\r\n}", "\uFEFF// Auto-generated by frontend/scripts/export-static-bundle.mjs.\r\nexport const STATIC_BUNDLE = {\r\n  \"index.html\": \"<!doctype html>\\n<html lang=\\\"en-ZA\\\">\\n  <head>\\n    <meta charset=\\\"UTF-8\\\" />\\n    <meta name=\\\"viewport\\\" content=\\\"width=device-width, initial-scale=1.0\\\" />\\n    <title>GreenBro - Heat Pump Dashboard</title>\\n    <link rel=\\\"icon\\\" type=\\\"image/svg+xml\\\" href=\\\"/app/assets/GREENBRO LOGO APP.svg\\\" />\\n    <script type=\\\"module\\\" crossorigin src=\\\"/app/assets/index-CAv5rt5M.js\\\"></script>\\n    <link rel=\\\"stylesheet\\\" crossorigin href=\\\"/app/assets/index-y6znqhWW.css\\\">\\n  </head>\\n  <body>\\n    <div id=\\\"root\\\"></div>\\n  </body>\\n</html>\\n\",\r\n  \"assets/AdminArchivePage-eBZK27bO.js\": \"import{u as o,r as t,j as e,L as m}from\\\"./index-CAv5rt5M.js\\\";import{P as r,b as h,a as v}from\\\"./format-BvCvFL95.js\\\";function f(){const c=o(),[d,l]=t.useState(\\\"loading\\\"),[a,n]=t.useState(null);return t.useEffect(()=>{const s=new AbortController;return l(\\\"loading\\\"),c.get(\\\"/api/archive/offline\\\",{signal:s.signal}).then(i=>{n(i),l(\\\"ready\\\")}).catch(i=>{i instanceof DOMException&&i.name===\\\"AbortError\\\"||l(\\\"error\\\")}),()=>s.abort()},[c]),d===\\\"loading\\\"?e.jsx(r,{title:\\\"Archive\\\",children:e.jsx(\\\"div\\\",{className:\\\"card\\\",children:\\\"Loading...\\\"})}):d===\\\"error\\\"||!a?e.jsx(r,{title:\\\"Archive\\\",children:e.jsx(\\\"div\\\",{className:\\\"card callout error\\\",children:\\\"Unable to load archive data\\\"})}):e.jsxs(r,{title:\\\"Archive\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Offline devices\\\"}),e.jsxs(\\\"span\\\",{className:\\\"pill\\\",children:[a.offline?.length??0,\\\" entries\\\"]})]}),a.offline?.length?e.jsx(\\\"div\\\",{className:\\\"stack\\\",children:a.offline.map(s=>e.jsxs(\\\"div\\\",{className:\\\"list-item\\\",children:[e.jsxs(\\\"div\\\",{children:[e.jsx(\\\"div\\\",{className:\\\"font-semibold\\\",children:s.device_id}),s.site?e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:s.site}):null,e.jsxs(\\\"div\\\",{className:\\\"meta\\\",children:[\\\"Last heartbeat \\\",h(s.last_seen_at)]})]}),e.jsxs(\\\"div\\\",{className:\\\"text-right\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"meta\\\",children:[\\\"Alerts \\\",s.alerts]}),e.jsx(m,{to:`/app/device?device=${encodeURIComponent(s.lookup)}`,className:\\\"link\\\",children:\\\"Open\\\"})]})]},s.lookup))}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No offline devices found\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card mt-1\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-header\\\",children:e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Telemetry archive volume\\\"})}),a.history?.length?e.jsx(\\\"div\\\",{className:\\\"history-grid\\\",children:a.history.map((s,i)=>e.jsxs(\\\"div\\\",{className:\\\"history-card\\\",children:[e.jsx(\\\"strong\\\",{children:s.day}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[v(s.samples??0,0),\\\" samples\\\"]})]},`${s.day}-${i}`))}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No recent telemetry samples\\\"})]})]})}export{f as default};\\n\",\r\n  \"assets/AdminPage-Bf9ziHWx.js\": \"import{u as m,r,j as e,L as u}from\\\"./index-CAv5rt5M.js\\\";import{P as c,a as l,c as h}from\\\"./format-BvCvFL95.js\\\";function f(){const n=m(),[a,d]=r.useState(\\\"loading\\\"),[t,x]=r.useState(null);if(r.useEffect(()=>{const s=new AbortController;return d(\\\"loading\\\"),n.get(\\\"/api/fleet/admin-overview\\\",{signal:s.signal}).then(i=>{x(i),d(\\\"ready\\\")}).catch(i=>{i instanceof DOMException&&i.name===\\\"AbortError\\\"||d(\\\"error\\\")}),()=>s.abort()},[n]),a===\\\"loading\\\")return e.jsx(c,{title:\\\"Admin\\\",children:e.jsx(\\\"div\\\",{className:\\\"card\\\",children:\\\"Loading...\\\"})});if(a===\\\"error\\\"||!t)return e.jsx(c,{title:\\\"Admin\\\",children:e.jsx(\\\"div\\\",{className:\\\"card callout error\\\",children:\\\"Unable to load admin overview\\\"})});const j=p(t.ops_summary),o=t.ops_window?`Window: last ${l(t.ops_window.days,0)} days (since ${h(t.ops_window.start)})`:null;return e.jsxs(c,{title:\\\"Admin\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Tenants\\\"}),e.jsxs(\\\"span\\\",{className:\\\"pill\\\",children:[t.tenants?.length??0,\\\" profiles\\\"]})]}),t.tenants?.length?e.jsx(\\\"div\\\",{className:\\\"min-table\\\",children:e.jsxs(\\\"table\\\",{className:\\\"table\\\",children:[e.jsx(\\\"thead\\\",{children:e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"th\\\",{children:\\\"Profile\\\"}),e.jsx(\\\"th\\\",{children:\\\"Devices\\\"}),e.jsx(\\\"th\\\",{children:\\\"Online\\\"})]})}),e.jsx(\\\"tbody\\\",{children:t.tenants.map(s=>e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"td\\\",{children:s.profile_id}),e.jsx(\\\"td\\\",{children:l(s.device_count??0,0)}),e.jsx(\\\"td\\\",{children:l(s.online_count??0,0)})]},s.profile_id))})]})}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No tenant data\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card mt-1\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Recent operations\\\"}),e.jsxs(\\\"span\\\",{className:\\\"pill\\\",children:[t.ops?.length??0,\\\" events\\\"]})]}),t.ops?.length?e.jsx(\\\"div\\\",{className:\\\"min-table\\\",children:e.jsxs(\\\"table\\\",{className:\\\"table\\\",children:[e.jsx(\\\"thead\\\",{children:e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"th\\\",{children:\\\"Timestamp\\\"}),e.jsx(\\\"th\\\",{children:\\\"Route\\\"}),e.jsx(\\\"th\\\",{children:\\\"Status\\\"}),e.jsx(\\\"th\\\",{children:\\\"Duration ms\\\"}),e.jsx(\\\"th\\\",{children:\\\"Device\\\"})]})}),e.jsx(\\\"tbody\\\",{children:t.ops.map((s,i)=>e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"td\\\",{children:h(s.ts)}),e.jsx(\\\"td\\\",{children:s.route}),e.jsx(\\\"td\\\",{children:s.status_code}),e.jsx(\\\"td\\\",{children:s.duration_ms}),e.jsx(\\\"td\\\",{children:s.device_id?e.jsx(u,{className:\\\"link\\\",to:`/app/device?device=${encodeURIComponent(s.lookup??\\\"\\\")}`,children:s.device_id}):\\\"-\\\"})]},`${s.ts}-${i}`))})]})}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No recent operations in scope\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued mt-06\\\",children:[\\\"Status mix: \\\",j]}),o?e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:o}):null]})]})}function p(n){if(!n)return\\\"n/a\\\";const a=Object.entries(n);return a.length?a.map(([d,t])=>`${d}: ${l(t,0)}`).join(\\\" | \\\"):\\\"n/a\\\"}export{f as default};\\n\",\r\n  \"assets/AlertsPage-CiG2Kh3G.js\": \"import{u as p,b as g,r as c,j as s}from\\\"./index-CAv5rt5M.js\\\";import{P as d,a as h,b as u}from\\\"./format-BvCvFL95.js\\\";function w(){const e=p(),[x]=g(),[i,v]=c.useState(null),[n,l]=c.useState(\\\"loading\\\"),a=x.get(\\\"hours\\\")??void 0;c.useEffect(()=>{const t=new AbortController;l(\\\"loading\\\");const o=new URLSearchParams;a&&o.set(\\\"hours\\\",a);const m=o.toString(),N=m?\\\"/api/alerts/recent?\\\"+m:\\\"/api/alerts/recent\\\";return e.get(N,{signal:t.signal}).then(r=>{v(r),l(\\\"ready\\\")}).catch(r=>{r instanceof DOMException&&r.name===\\\"AbortError\\\"||l(\\\"error\\\")}),()=>t.abort()},[e,a]);const j=c.useMemo(()=>a?`${a}h`:\\\"72h\\\",[a]);return n===\\\"loading\\\"?s.jsx(d,{title:\\\"Alerts\\\",children:s.jsx(\\\"div\\\",{className:\\\"card\\\",children:\\\"Loading...\\\"})}):n===\\\"error\\\"||!i?s.jsx(d,{title:\\\"Alerts\\\",children:s.jsx(\\\"div\\\",{className:\\\"card callout error\\\",children:\\\"Unable to load alerts\\\"})}):s.jsxs(d,{title:\\\"Alerts\\\",children:[s.jsxs(\\\"div\\\",{className:\\\"grid kpis\\\",children:[s.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[s.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Total alerts\\\"}),s.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:h(i.stats?.total??0,0)})]}),s.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[s.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Active now\\\"}),s.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:h(i.stats?.active??0,0)})]}),s.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[s.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Window\\\"}),s.jsxs(\\\"div\\\",{className:\\\"large-number\\\",children:[\\\"Last \\\",j]})]})]}),s.jsx(\\\"div\\\",{className:\\\"stack\\\",children:i.items?.length?i.items.map(t=>s.jsx(f,{alert:t},t.lookup)):s.jsx(\\\"div\\\",{className:\\\"card\\\",children:s.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No alerts during this window\\\"})})})]})}function f({alert:e}){return s.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[s.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[s.jsxs(\\\"div\\\",{children:[s.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:e.device_id}),e.site?s.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:e.site}):null]}),s.jsx(\\\"span\\\",{className:`pill${e.active?\\\" warn\\\":\\\"\\\"}`,children:e.active?\\\"Active\\\":\\\"Cleared\\\"})]}),s.jsx(\\\"div\\\",{className:\\\"list\\\",children:s.jsxs(\\\"div\\\",{className:\\\"list-item\\\",children:[s.jsxs(\\\"div\\\",{children:[s.jsx(\\\"div\\\",{children:e.faults?.join(\\\", \\\")||\\\"Fault reported\\\"}),s.jsxs(\\\"div\\\",{className:\\\"meta\\\",children:[\\\"Triggered \\\",u(e.ts)]})]}),s.jsxs(\\\"div\\\",{className:\\\"text-right\\\",children:[s.jsx(\\\"div\\\",{className:\\\"meta\\\",children:e.last_update?`Last update ${u(e.last_update)}`:\\\"No recent update\\\"}),s.jsx(\\\"a\\\",{href:`/app/device?device=${encodeURIComponent(e.lookup)}`,className:\\\"link inline-link\\\",children:\\\"Inspect device\\\"})]})]})})]})}export{w as default};\\n\",\r\n  \"assets/CommissioningPage-CNVLMK2O.js\": \"import{u as x,r as d,j as s}from\\\"./index-CAv5rt5M.js\\\";import{P as m,a as i,b as f}from\\\"./format-BvCvFL95.js\\\";function k(){const e=x(),[a,n]=d.useState(\\\"loading\\\"),[o,c]=d.useState(null);if(d.useEffect(()=>{const l=new AbortController;return n(\\\"loading\\\"),e.get(\\\"/api/commissioning/checklist\\\",{signal:l.signal}).then(t=>{const u=(t.devices??[]).map(g);c({summary:t.summary,devices:u}),n(\\\"ready\\\")}).catch(t=>{t instanceof DOMException&&t.name===\\\"AbortError\\\"||n(\\\"error\\\")}),()=>l.abort()},[e]),a===\\\"loading\\\")return s.jsx(m,{title:\\\"Commissioning & QA\\\",children:s.jsx(\\\"div\\\",{className:\\\"card\\\",children:\\\"Loading...\\\"})});if(a===\\\"error\\\"||!o)return s.jsx(m,{title:\\\"Commissioning & QA\\\",children:s.jsx(\\\"div\\\",{className:\\\"card callout error\\\",children:\\\"Unable to load commissioning status\\\"})});const{summary:r,devices:p}=o,h=r.total?Math.round((r.ready??0)/r.total*100):0;return s.jsxs(m,{title:\\\"Commissioning & QA\\\",children:[s.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[s.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[s.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Readiness overview\\\"}),s.jsxs(\\\"span\\\",{className:\\\"pill\\\",children:[r.ready,\\\" ready of \\\",r.total]})]}),s.jsx(\\\"div\\\",{className:\\\"callout mt-06\\\",children:r.total?`${h}% checklist complete across fleet`:\\\"No devices in scope\\\"})]}),s.jsx(\\\"div\\\",{className:\\\"stack mt-1\\\",children:p.map(l=>s.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[s.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[s.jsxs(\\\"div\\\",{children:[s.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:l.device_id}),l.site?s.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:l.site}):null]}),s.jsxs(\\\"span\\\",{className:`pill${l.progress>=.86?\\\"\\\":\\\" warn\\\"}`,children:[i(l.progress*100,0),\\\"%\\\"]})]}),s.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Last heartbeat \\\",f(l.last_seen_at??l.updated_at)]}),s.jsx(\\\"progress\\\",{className:\\\"progress-bar\\\",max:100,value:Math.round(l.progress*100)}),s.jsx(\\\"div\\\",{className:\\\"checklist\\\",children:l.checklist.map(t=>s.jsxs(\\\"div\\\",{className:`check-item${t.pass?\\\"\\\":\\\" fail\\\"}`,children:[s.jsx(\\\"span\\\",{children:t.label}),s.jsx(\\\"span\\\",{className:\\\"subdued\\\",children:t.detail})]},t.key))}),s.jsx(\\\"div\\\",{className:\\\"mt-06\\\",children:s.jsx(\\\"a\\\",{href:`/app/device?device=${encodeURIComponent(l.lookup)}`,className:\\\"link\\\",children:\\\"Open device\\\"})})]},l.lookup))})]})}function g(e){const a=j(e),n=a.filter(c=>c.pass).length,o=a.length?n/a.length:0;return{...e,checklist:a,progress:o}}function j(e){const a=[];return a.push({key:\\\"online\\\",label:\\\"Device online\\\",detail:e.online?\\\"Heartbeat received\\\":\\\"Waiting for heartbeat\\\",pass:e.online}),a.push({key:\\\"flow\\\",label:\\\"Flow sensor reporting\\\",detail:e.flowLps!==null?`${i(e.flowLps,2)} L/s`:\\\"No flow telemetry yet\\\",pass:typeof e.flowLps==\\\"number\\\"}),a.push({key:\\\"delta\\\",label:\\\"\u00CE\u201DT above 3\u00C2\u00B0C\\\",detail:e.deltaT!==null?`${i(e.deltaT,1)} \u00C2\u00B0C`:\\\"\u00CE\u201DT unavailable\\\",pass:typeof e.deltaT==\\\"number\\\"&&e.deltaT>=3}),a.push({key:\\\"thermal\\\",label:\\\"Thermal output reported\\\",detail:e.thermalKW!==null?`${i(e.thermalKW,2)} kW`:\\\"No thermal telemetry\\\",pass:typeof e.thermalKW==\\\"number\\\"}),a.push({key:\\\"mode\\\",label:\\\"Operating mode detected\\\",detail:e.mode??\\\"Mode unknown\\\",pass:!!e.mode}),a}export{k as default};\\n\",\r\n  \"assets/CompactDashboardPage-azXId9pO.js\": \"import{u as y,r as c,j as e}from\\\"./index-CAv5rt5M.js\\\";import{P as m,f as _,a as n,b as u}from\\\"./format-BvCvFL95.js\\\";import{S as k}from\\\"./Sparkline-D2W6pTJo.js\\\";function O(){const o=y(),[a,v]=c.useState(null),[r,p]=c.useState([]),[x,j]=c.useState(\\\"loading\\\"),[t,h]=c.useState(\\\"cop\\\");c.useEffect(()=>{const s=new AbortController;let i=!1;async function b(){try{const d=await o.get(\\\"/api/client/compact\\\",{signal:s.signal});i||(v(d),j(\\\"ready\\\"))}catch(d){!i&&!(d instanceof DOMException&&d.name===\\\"AbortError\\\")&&j(\\\"error\\\")}}async function g(){try{const d=await o.get(\\\"/api/devices?mine=1&limit=12\\\",{signal:s.signal});i||p(d.items??[])}catch{}}return b(),g(),()=>{i=!0,s.abort()}},[o]);const N=c.useMemo(()=>a?(a.trend??[]).map(s=>{const i=s[t];return typeof i==\\\"number\\\"?i:null}):[],[a,t]),f=c.useMemo(()=>{switch(t){case\\\"cop\\\":return\\\"Fleet average COP\\\";case\\\"thermalKW\\\":return\\\"Thermal output (kW)\\\";case\\\"deltaT\\\":return\\\"?T average (\u00C2\u00B0C)\\\";default:return\\\"\\\"}},[t]);if(x===\\\"loading\\\")return e.jsx(m,{title:\\\"My Sites - Compact\\\",children:e.jsx(\\\"div\\\",{className:\\\"card\\\",children:\\\"Loading...\\\"})});if(x===\\\"error\\\"||!a)return e.jsx(m,{title:\\\"My Sites - Compact\\\",children:e.jsx(\\\"div\\\",{className:\\\"card callout error\\\",children:\\\"Unable to load dashboard data\\\"})});const l=a.kpis;return e.jsxs(m,{title:\\\"My Sites - Compact\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"grid kpis\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Online rate\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:_(l.online_pct)}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[l.devices_online,\\\"/\\\",l.devices_total,\\\" devices online\\\"]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Open alerts\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:n(l.open_alerts??0,0)}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:a.alerts?.length?`${a.alerts.length} devices affected`:\\\"Monitoring\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Avg COP\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:n(l.avg_cop,2)}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Window start \\\",u(a.window_start_ms)]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Low ?T (24h)\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:n(l.low_deltaT_count??0,0)}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:l.max_heartbeat_age_sec?`Oldest heartbeat ${n((l.max_heartbeat_age_sec??0)/60,1)}m`:\\\"All fresh\\\"})]})]}),e.jsxs(\\\"div\\\",{className:\\\"card chart-card\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsxs(\\\"div\\\",{children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Performance trend\\\"}),e.jsx(\\\"div\\\",{className:\\\"trend-subtitle\\\",children:f})]}),e.jsxs(\\\"div\\\",{className:\\\"tabs\\\",children:[e.jsx(\\\"button\\\",{type:\\\"button\\\",className:`btn ghost${t===\\\"cop\\\"?\\\" active\\\":\\\"\\\"}`,onClick:()=>h(\\\"cop\\\"),children:\\\"COP\\\"}),e.jsx(\\\"button\\\",{type:\\\"button\\\",className:`btn ghost${t===\\\"thermalKW\\\"?\\\" active\\\":\\\"\\\"}`,onClick:()=>h(\\\"thermalKW\\\"),children:\\\"Thermal kW\\\"}),e.jsx(\\\"button\\\",{type:\\\"button\\\",className:`btn ghost${t===\\\"deltaT\\\"?\\\" active\\\":\\\"\\\"}`,onClick:()=>h(\\\"deltaT\\\"),children:\\\"?T\\\"})]})]}),e.jsx(\\\"div\\\",{className:\\\"card-section\\\",children:e.jsx(k,{values:N,color:t===\\\"cop\\\"?\\\"#52ff99\\\":t===\\\"thermalKW\\\"?\\\"#7d96ff\\\":\\\"#ffcc66\\\"})})]}),e.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Recent alerts\\\"}),a.alerts?.length?e.jsxs(\\\"span\\\",{className:\\\"pill warn\\\",children:[a.alerts.length,\\\" active\\\"]}):e.jsx(\\\"span\\\",{className:\\\"pill\\\",children:\\\"Stable\\\"})]}),a.alerts?.length?e.jsx(\\\"div\\\",{className:\\\"list\\\",children:a.alerts.map(s=>e.jsxs(\\\"div\\\",{className:\\\"list-item\\\",children:[e.jsxs(\\\"div\\\",{children:[e.jsx(\\\"div\\\",{className:\\\"font-semibold\\\",children:s.device_id}),s.site?e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:s.site}):null,e.jsxs(\\\"div\\\",{className:\\\"meta\\\",children:[\\\"Updated \\\",u(s.updated_at)]})]}),e.jsxs(\\\"div\\\",{className:\\\"text-right\\\",children:[e.jsx(\\\"div\\\",{children:s.faults?.slice(0,3).join(\\\", \\\")||\\\"Fault reported\\\"}),e.jsx(\\\"div\\\",{className:\\\"meta\\\",children:s.faults&&s.faults.length>3?`+${s.faults.length-3} more`:\\\"\\\"}),e.jsx(\\\"a\\\",{href:`/app/device?device=${encodeURIComponent(s.lookup)}`,className:\\\"link inline-link\\\",children:\\\"Open\\\"})]})]},s.lookup))}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No alerts in the selected window\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Device roster\\\"}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:r.length?`${r.length} listed`:\\\"No devices yet\\\"})]}),r.length?e.jsx(\\\"div\\\",{className:\\\"min-table\\\",children:e.jsxs(\\\"table\\\",{className:\\\"table\\\",children:[e.jsx(\\\"thead\\\",{children:e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"th\\\",{children:\\\"Device\\\"}),e.jsx(\\\"th\\\",{children:\\\"Site\\\"}),e.jsx(\\\"th\\\",{children:\\\"Online\\\"}),e.jsx(\\\"th\\\",{children:\\\"Last heartbeat\\\"}),e.jsx(\\\"th\\\",{children:\\\"Firmware\\\"})]})}),e.jsx(\\\"tbody\\\",{children:r.map(s=>e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"td\\\",{children:e.jsx(\\\"a\\\",{href:`/app/device?device=${encodeURIComponent(s.lookup)}`,className:\\\"link\\\",children:s.device_id||\\\"(device)\\\"})}),e.jsx(\\\"td\\\",{children:s.site??\\\"-\\\"}),e.jsx(\\\"td\\\",{children:e.jsx(\\\"span\\\",{className:`status-dot${s.online?\\\" ok\\\":\\\"\\\"}`,title:s.online?\\\"Online\\\":\\\"Offline\\\"})}),e.jsx(\\\"td\\\",{children:u(s.last_seen_at)}),e.jsx(\\\"td\\\",{children:s.firmware??\\\"-\\\"})]},s.lookup))})]})}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No devices in scope\\\"})]})]})}export{O as default};\\n\",\r\n  \"assets/DeviceDetailPage-B9wux4UQ.js\": \"import{u as z,a as G,r as a,b as J,j as e}from\\\"./index-CAv5rt5M.js\\\";import{b as P,a as n,P as Q,c as X}from\\\"./format-BvCvFL95.js\\\";import{S as b}from\\\"./Sparkline-D2W6pTJo.js\\\";function te(){const l=z(),o=G().user,m=a.useMemo(()=>(o?.roles??[]).some(s=>s.toLowerCase()===\\\"admin\\\"),[o?.roles]),[$,R]=a.useState(()=>!m),[w,M]=J(),A=w.get(\\\"device\\\")??\\\"\\\",[y,_]=a.useState([]),[r,S]=a.useState(A),[j,E]=a.useState(null),[N,K]=a.useState(null),[O,F]=a.useState(\\\"\\\"),[U,C]=a.useState(!1),[I,W]=a.useState(!1),x=m?$:!0;a.useEffect(()=>{let s=!1;async function t(){try{const f=new URLSearchParams({limit:\\\"50\\\",mine:x?\\\"1\\\":\\\"0\\\"}),c=await l.get(`/api/devices?${f.toString()}`);if(s)return;const p=c.items??[];_(p),S(D=>D&&p.some(V=>V.lookup===D)?D:p[0]?.lookup??\\\"\\\")}catch{s||(_([]),S(\\\"\\\"))}}return t(),()=>{s=!0}},[l,x]);const k=a.useCallback(async s=>{if(s){C(!0),W(!1);try{const t=new URLSearchParams({scope:\\\"device\\\",device:s,interval:\\\"5m\\\",limit:\\\"120\\\",fill:\\\"carry\\\"}),[f,c]=await Promise.all([l.post(\\\"/api/telemetry/latest-batch\\\",{devices:[s]}),l.get(`/api/telemetry/series?${t.toString()}`)]),p=f.items?.[0]??null;E(p),K(c),F(p?.device_id??\\\"\\\"),C(!1)}catch{W(!0),C(!1)}}},[l]);a.useEffect(()=>{r&&(k(r),M(s=>{const t=new URLSearchParams(s);return t.set(\\\"device\\\",r),t}))},[k,r,M]);const i=a.useMemo(()=>j?.latest??{},[j]),T=a.useMemo(()=>y.find(s=>s.lookup===r)??null,[y,r]),d=a.useMemo(()=>{const s=N?.series??[];return{supply:s.map(t=>u(t,\\\"supplyC\\\")),return:s.map(t=>u(t,\\\"returnC\\\")),thermal:s.map(t=>u(t,\\\"thermalKW\\\")),cop:s.map(t=>u(t,\\\"cop\\\"))}},[N]),L=a.useMemo(()=>(N?.series??[]).slice(-10).reverse(),[N]),B=a.useMemo(()=>{const s=O.trim();return s.length>0?s:j?.device_id??\\\"-\\\"},[O,j]),q=i.updated_at!=null?`Updated ${P(i.updated_at)}`:i.ts!=null?`Sample ${P(i.ts)}`:\\\"\\\",H=m?e.jsxs(\\\"div\\\",{className:\\\"tabs\\\",role:\\\"group\\\",\\\"aria-label\\\":\\\"Device scope filter\\\",children:[e.jsx(\\\"button\\\",{type:\\\"button\\\",className:`btn ghost${x?\\\" active\\\":\\\"\\\"}`,\\\"aria-pressed\\\":x,onClick:()=>R(!0),children:\\\"Assigned\\\"}),e.jsx(\\\"button\\\",{type:\\\"button\\\",className:`btn ghost${x?\\\"\\\":\\\" active\\\"}`,\\\"aria-pressed\\\":!x,onClick:()=>R(!1),children:\\\"All devices\\\"})]}):null,h=a.useCallback((s,t,f=1)=>{const c=i[s];return c==null?e.jsxs(\\\"div\\\",{className:\\\"metric-tile\\\",children:[e.jsx(\\\"div\\\",{className:\\\"metric-label\\\",children:t}),e.jsx(\\\"div\\\",{className:\\\"metric-value\\\",children:\\\"-\\\"})]},String(s)):typeof c==\\\"number\\\"?e.jsxs(\\\"div\\\",{className:\\\"metric-tile\\\",children:[e.jsx(\\\"div\\\",{className:\\\"metric-label\\\",children:t}),e.jsx(\\\"div\\\",{className:\\\"metric-value\\\",children:n(c,f)})]},String(s)):e.jsxs(\\\"div\\\",{className:\\\"metric-tile\\\",children:[e.jsx(\\\"div\\\",{className:\\\"metric-label\\\",children:t}),e.jsx(\\\"div\\\",{className:\\\"metric-value\\\",children:Y(c)})]},String(s))},[i]);return e.jsx(Q,{title:\\\"Device detail\\\",actions:H,children:e.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"flex\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"flex-basis-220\\\",children:[e.jsx(\\\"label\\\",{className:\\\"muted\\\",htmlFor:\\\"device-select\\\",children:\\\"Device\\\"}),e.jsxs(\\\"select\\\",{id:\\\"device-select\\\",value:r,onChange:s=>S(s.target.value),children:[e.jsx(\\\"option\\\",{value:\\\"\\\",children:\\\"Select a device\\\"}),y.map(s=>e.jsx(\\\"option\\\",{value:s.lookup,children:s.device_id},s.lookup))]})]}),e.jsx(\\\"button\\\",{type:\\\"button\\\",className:\\\"btn align-self-end\\\",onClick:()=>{r&&k(r)},disabled:!r||U,children:U?\\\"Loading...\\\":\\\"Refresh\\\"})]}),I?e.jsx(\\\"div\\\",{className:\\\"callout error mt-1\\\",children:\\\"Unable to load device data\\\"}):null,j?e.jsxs(\\\"div\\\",{className:\\\"stack mt-1\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"grid-3\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Device ID\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:B}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:q})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Status\\\"}),e.jsxs(\\\"div\\\",{className:\\\"status-row\\\",children:[e.jsx(\\\"span\\\",{className:`status-dot${i.online?\\\" ok\\\":\\\"\\\"}`,title:i.online?\\\"Online\\\":\\\"Offline\\\"}),e.jsx(\\\"span\\\",{children:i.online?\\\"Online\\\":\\\"Offline\\\"})]}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:i.mode??\\\"Mode unknown\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Site\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:T?.site??\\\"-\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Last heartbeat \\\",P(T?.last_seen_at??null)]})]})]}),e.jsxs(\\\"div\\\",{className:\\\"metric-grid\\\",children:[h(\\\"supplyC\\\",\\\"Supply \u00C2\u00B0C\\\",1),h(\\\"returnC\\\",\\\"Return \u00C2\u00B0C\\\",1),h(\\\"deltaT\\\",\\\"\u00CE\u201DT \u00C2\u00B0C\\\",1),h(\\\"thermalKW\\\",\\\"Thermal kW\\\",2),h(\\\"cop\\\",\\\"COP\\\",2),h(\\\"flowLps\\\",\\\"Flow L/s\\\",2),h(\\\"powerKW\\\",\\\"Power kW\\\",2)]}),e.jsxs(\\\"div\\\",{className:\\\"grid auto mt-1\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Supply trend\\\"}),e.jsx(b,{values:d.supply,color:\\\"#52ff99\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Latest \\\",n(g(d.supply),1),\\\" \\\\\\\\u00B0C\\\"]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Return trend\\\"}),e.jsx(b,{values:d.return,color:\\\"#86a5ff\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Latest \\\",n(g(d.return),1),\\\" \\\\\\\\u00B0C\\\"]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Thermal output\\\"}),e.jsx(b,{values:d.thermal,color:\\\"#ffcc66\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Latest \\\",n(g(d.thermal),2),\\\" kW\\\"]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"COP trend\\\"}),e.jsx(b,{values:d.cop,color:\\\"#52ff99\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Latest \\\",n(g(d.cop),2)]})]})]}),L.length?e.jsxs(\\\"div\\\",{className:\\\"card mt-1\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Recent telemetry\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[L.length,\\\" buckets\\\"]})]}),e.jsx(\\\"div\\\",{className:\\\"min-table\\\",children:e.jsxs(\\\"table\\\",{className:\\\"table\\\",children:[e.jsx(\\\"thead\\\",{children:e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"th\\\",{children:\\\"Timestamp\\\"}),e.jsx(\\\"th\\\",{children:\\\"Samples\\\"}),e.jsx(\\\"th\\\",{children:\\\"Supply\\\"}),e.jsx(\\\"th\\\",{children:\\\"Return\\\"}),e.jsx(\\\"th\\\",{children:\\\"Thermal kW\\\"}),e.jsx(\\\"th\\\",{children:\\\"COP\\\"})]})}),e.jsx(\\\"tbody\\\",{children:L.map(s=>e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"td\\\",{children:X(s.bucket_start)}),e.jsx(\\\"td\\\",{children:s.sample_count}),e.jsx(\\\"td\\\",{children:n(u(s,\\\"supplyC\\\"),1)}),e.jsx(\\\"td\\\",{children:n(u(s,\\\"returnC\\\"),1)}),e.jsx(\\\"td\\\",{children:n(u(s,\\\"thermalKW\\\"),2)}),e.jsx(\\\"td\\\",{children:n(u(s,\\\"cop\\\"),2)})]},s.bucket_start))})]})})]}):null]}):e.jsx(\\\"div\\\",{className:\\\"empty mt-1\\\",children:r?\\\"Select refresh to load details\\\":\\\"Choose a device to load telemetry\\\"})]})})}function Y(l){return l==null?\\\"-\\\":typeof l==\\\"string\\\"||typeof l==\\\"number\\\"||typeof l==\\\"boolean\\\"?String(l):\\\"-\\\"}function u(l,v){const m=l.values?.[v]?.avg;return typeof m==\\\"number\\\"&&Number.isFinite(m)?m:null}function g(l){for(let v=l.length-1;v>=0;v-=1){const o=l[v];if(typeof o==\\\"number\\\"&&!Number.isNaN(o))return o}return null}export{te as default};\\n\",\r\n  \"assets/DevicesPage-D9uGgfnL.js\": \"import{u as y,a as k,r as l,j as e,L}from\\\"./index-CAv5rt5M.js\\\";import{P as S,b as A}from\\\"./format-BvCvFL95.js\\\";const C={items:[],cursor:null,loading:!1,error:!1};function U(){const u=y(),m=k().user,i=l.useMemo(()=>(m?.roles??[]).some(s=>s.toLowerCase()===\\\"admin\\\"),[m?.roles]),[f,h]=l.useState(()=>!i),[b,n]=l.useState(C),a=i?f:!0,r=l.useCallback(async(s,d=!1)=>{n(t=>({items:d?[]:t.items,cursor:d?null:t.cursor,loading:!0,error:!1}));try{const t=new URLSearchParams({limit:\\\"25\\\",mine:a?\\\"1\\\":\\\"0\\\"});s&&t.set(\\\"cursor\\\",s);const j=await u.get(`/api/devices?${t.toString()}`),p=j.items??[];n(N=>({items:s&&!d?N.items.concat(p):p,cursor:j.next??null,loading:!1,error:!1}))}catch{n(t=>({...t,loading:!1,error:!0}))}},[u,a]);l.useEffect(()=>{r(null,!0)},[r]);const{items:x,cursor:c,loading:o,error:v}=b,g=i?e.jsxs(\\\"div\\\",{className:\\\"tabs\\\",role:\\\"group\\\",\\\"aria-label\\\":\\\"Device scope filter\\\",children:[e.jsx(\\\"button\\\",{type:\\\"button\\\",className:`btn ghost${a?\\\" active\\\":\\\"\\\"}`,\\\"aria-pressed\\\":a,onClick:()=>h(!0),children:\\\"Assigned\\\"}),e.jsx(\\\"button\\\",{type:\\\"button\\\",className:`btn ghost${a?\\\"\\\":\\\" active\\\"}`,\\\"aria-pressed\\\":!a,onClick:()=>h(!1),children:\\\"All devices\\\"})]}):null;return e.jsx(S,{title:\\\"Devices\\\",actions:g,children:e.jsxs(\\\"div\\\",{className:\\\"card\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Devices in scope\\\"}),v?e.jsx(\\\"span\\\",{className:\\\"pill error\\\",children:\\\"Error fetching list\\\"}):null]}),x.length?e.jsx(\\\"div\\\",{className:\\\"min-table\\\",children:e.jsxs(\\\"table\\\",{className:\\\"table\\\",children:[e.jsx(\\\"thead\\\",{children:e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"th\\\",{children:\\\"Device\\\"}),e.jsx(\\\"th\\\",{children:\\\"Site\\\"}),e.jsx(\\\"th\\\",{children:\\\"Status\\\"}),e.jsx(\\\"th\\\",{children:\\\"Last seen\\\"}),e.jsx(\\\"th\\\",{children:\\\"Profile\\\"})]})}),e.jsx(\\\"tbody\\\",{children:x.map(s=>e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"td\\\",{children:e.jsx(L,{className:\\\"link\\\",to:`/app/device?device=${encodeURIComponent(s.lookup)}`,children:s.device_id})}),e.jsx(\\\"td\\\",{children:s.site??\\\"-\\\"}),e.jsx(\\\"td\\\",{children:e.jsx(\\\"span\\\",{className:`status-dot${s.online?\\\" ok\\\":\\\"\\\"}`,title:s.online?\\\"Online\\\":\\\"Offline\\\"})}),e.jsx(\\\"td\\\",{children:A(s.last_seen_at)}),e.jsx(\\\"td\\\",{children:s.profile_id??\\\"-\\\"})]},s.lookup))})]})}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:o?\\\"Loading...\\\":\\\"No devices\\\"}),e.jsxs(\\\"div\\\",{className:\\\"flex-between mt-1\\\",children:[e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:c?\\\"More devices available\\\":\\\"End of list\\\"}),c?e.jsx(\\\"button\\\",{type:\\\"button\\\",className:\\\"btn\\\",disabled:o,onClick:()=>{r(c)},children:o?\\\"Loading...\\\":\\\"Load more\\\"}):null]})]})})}export{U as default};\\n\",\r\n  \"assets/GREENBRO LOGO APP.svg\": \"\u00EF\u00BB\u00BF<svg viewBox=\\\"0 0 320 64\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" role=\\\"img\\\" aria-label=\\\"GreenBro\\\">\\n  <rect width=\\\"320\\\" height=\\\"64\\\" rx=\\\"12\\\" fill=\\\"#0b1e14\\\"/>\\n  <text x=\\\"32\\\" y=\\\"40\\\" font-size=\\\"28\\\" font-family=\\\"Arial, Helvetica, sans-serif\\\" fill=\\\"#52ff99\\\">GreenBro</text>\\n</svg>\\r\\n\",\r\n  \"assets/Gear_Icon_01.svg\": \"\u00EF\u00BB\u00BF<svg viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n  <circle cx=\\\"12\\\" cy=\\\"12\\\" r=\\\"3\\\" fill=\\\"#52ff99\\\"/>\\n  <path d=\\\"M3 12h3m12 0h3M12 3v3m0 12v3M5 5l2.1 2.1M16.9 16.9L19 19M19 5l-2.1 2.1M7.1 16.9 5 19\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/>\\n</svg>\\r\\n\",\r\n  \"assets/Gear_Icon_02.svg\": \"\u00EF\u00BB\u00BF<svg viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n  <rect x=\\\"6\\\" y=\\\"6\\\" width=\\\"12\\\" height=\\\"12\\\" rx=\\\"2\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/>\\n  <circle cx=\\\"12\\\" cy=\\\"12\\\" r=\\\"2\\\" fill=\\\"#52ff99\\\"/>\\n</svg>\\r\\n\",\r\n  \"assets/Gear_Icon_03.svg\": \"\u00EF\u00BB\u00BF<svg viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n  <path d=\\\"M4 12a8 8 0 1 0 16 0\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/>\\n  <path d=\\\"M12 4a8 8 0 0 0 0 16\\\" stroke=\\\"#52ff99\\\" stroke-width=\\\"2\\\" fill=\\\"none\\\"/>\\n</svg>\\r\\n\",\r\n  \"assets/OpsPage-CXH1Qzc6.js\": \"import{u as T,r as W,j as e}from\\\"./index-CAv5rt5M.js\\\";import{u as q,R as w}from\\\"./RequestErrorCallout-BT33_181.js\\\";import{P as m,a as r,c as u,f as a}from\\\"./format-BvCvFL95.js\\\";function P(){const x=T(),g=W.useCallback(({signal:s})=>x.get(\\\"/api/ops/overview\\\",{signal:s}),[x]),{phase:b,data:t,error:j,retry:f,isRetryScheduled:y,nextRetryInMs:$,attempts:R,isFetching:S}=q(g,{autoRefreshMs:6e4}),k=t?\\\"Issues loading latest operations data\\\":\\\"Unable to load operations metrics\\\",d=j?e.jsx(w,{title:k,error:j,onRetry:f,retryScheduled:y,nextRetryInMs:$,attempts:R,busy:S}):null;if(!t&&b===\\\"loading\\\")return e.jsx(m,{title:\\\"Operations\\\",children:e.jsx(\\\"div\\\",{className:\\\"card\\\",children:\\\"Loading...\\\"})});if(!t)return e.jsx(m,{title:\\\"Operations\\\",children:d??e.jsx(\\\"div\\\",{className:\\\"card callout error\\\",children:\\\"Unable to load operations metrics\\\"})});const{ops_summary:l,devices:i,thresholds:n,ops:c,recent:h,ops_window:o}=t,v=n?.error_rate?.warn??null,N=n?.client_error_rate?.warn??null,p=n?.avg_duration_ms?.warn??null,_=o?`Window: last ${r(o.days,0)} days (since ${u(o.start)})`:null;return e.jsxs(m,{title:\\\"Operations\\\",children:[d?e.jsx(\\\"div\\\",{style:{marginBottom:\\\"1rem\\\"},children:d}):null,e.jsxs(\\\"div\\\",{className:\\\"grid kpis\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Requests observed\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:r(l.total_requests,0)}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Generated \\\",u(t.generated_at),_?` \u00E2\u20AC\u00A2 ${_}`:null]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Server error rate\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:a(l.server_error_rate*100,2)}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:v!==null?`Warns at ${a(v*100,2)}`:\\\"No threshold\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Client error rate\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:a(l.client_error_rate*100,2)}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:N!==null?`Warns at ${a(N*100,2)}`:\\\"No threshold\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Slow requests\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:a(l.slow_rate*100,2)}),e.jsx(\\\"div\\\",{className:\\\"subdued\\\",children:p!==null?`Warns at ${r(p,0)} ms`:\\\"No threshold\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Devices online\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:r(i.online,0)}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[r(i.offline,0),\\\" offline (\\\",a(i.offline_ratio*100,2),\\\")\\\"]})]})]}),l.slow_routes.length||l.top_server_error_routes.length?e.jsxs(\\\"div\\\",{className:\\\"card mt-1\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-header\\\",children:e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Hotspots\\\"})}),e.jsxs(\\\"div\\\",{className:\\\"stack\\\",children:[l.slow_routes.length?e.jsxs(\\\"div\\\",{children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Slow routes\\\"}),e.jsx(\\\"ul\\\",{style:{listStyle:\\\"none\\\",padding:0,margin:\\\"0.25rem 0 0\\\"},children:l.slow_routes.map(s=>e.jsxs(\\\"li\\\",{children:[s.route,\\\" (\\\",s.status_code,\\\") \u00C2\u00B7 \\\",r(s.avg_duration_ms,1),\\\" ms avg \u00C2\u00B7\\\",\\\" \\\",r(s.count,0),\\\" calls\\\"]},`${s.route}-${s.status_code}`))})]}):null,l.top_server_error_routes.length?e.jsxs(\\\"div\\\",{children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Server errors\\\"}),e.jsx(\\\"ul\\\",{style:{listStyle:\\\"none\\\",padding:0,margin:\\\"0.25rem 0 0\\\"},children:l.top_server_error_routes.map(s=>e.jsxs(\\\"li\\\",{children:[s.route,\\\" (\\\",s.status_code,\\\") \u00C2\u00B7 \\\",r(s.count,0),\\\" errors\\\"]},`${s.route}-${s.status_code}`))})]}):null]})]}):null,e.jsxs(\\\"div\\\",{className:\\\"card mt-1\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Route breakdown\\\"}),e.jsxs(\\\"span\\\",{className:\\\"pill\\\",children:[c.length,\\\" groups\\\"]})]}),c.length?e.jsx(\\\"div\\\",{className:\\\"min-table\\\",children:e.jsxs(\\\"table\\\",{className:\\\"table\\\",children:[e.jsx(\\\"thead\\\",{children:e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"th\\\",{children:\\\"Route\\\"}),e.jsx(\\\"th\\\",{children:\\\"Status\\\"}),e.jsx(\\\"th\\\",{children:\\\"Count\\\"}),e.jsx(\\\"th\\\",{children:\\\"Avg ms\\\"}),e.jsx(\\\"th\\\",{children:\\\"Max ms\\\"}),e.jsx(\\\"th\\\",{children:\\\"Total ms\\\"})]})}),e.jsx(\\\"tbody\\\",{children:c.map(s=>e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"td\\\",{children:s.route}),e.jsx(\\\"td\\\",{children:s.status_code}),e.jsx(\\\"td\\\",{children:r(s.count,0)}),e.jsx(\\\"td\\\",{children:r(s.avg_duration_ms,1)}),e.jsx(\\\"td\\\",{children:r(s.max_duration_ms,1)}),e.jsx(\\\"td\\\",{children:r(s.total_duration_ms,1)})]},`${s.route}-${s.status_code}`))})]})}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No aggregated metrics\\\"})]}),e.jsxs(\\\"div\\\",{className:\\\"card mt-1\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card-header\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Recent events\\\"}),e.jsxs(\\\"span\\\",{className:\\\"pill\\\",children:[h.length,\\\" events\\\"]})]}),h.length?e.jsx(\\\"div\\\",{className:\\\"min-table\\\",children:e.jsxs(\\\"table\\\",{className:\\\"table\\\",children:[e.jsx(\\\"thead\\\",{children:e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"th\\\",{children:\\\"Timestamp\\\"}),e.jsx(\\\"th\\\",{children:\\\"Route\\\"}),e.jsx(\\\"th\\\",{children:\\\"Status\\\"}),e.jsx(\\\"th\\\",{children:\\\"Duration ms\\\"}),e.jsx(\\\"th\\\",{children:\\\"Device\\\"})]})}),e.jsx(\\\"tbody\\\",{children:h.map((s,C)=>e.jsxs(\\\"tr\\\",{children:[e.jsx(\\\"td\\\",{children:u(s.ts)}),e.jsx(\\\"td\\\",{children:s.route}),e.jsx(\\\"td\\\",{children:s.status_code}),e.jsx(\\\"td\\\",{children:r(s.duration_ms,1)}),e.jsx(\\\"td\\\",{children:s.device_id?s.lookup?e.jsx(\\\"a\\\",{className:\\\"link\\\",href:`/app/device?device=${encodeURIComponent(s.lookup)}`,children:s.device_id}):s.device_id:\\\"-\\\"})]},`${s.ts}-${C}`))})]})}):e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:\\\"No recent events\\\"})]})]})}export{P as default};\\n\",\r\n  \"assets/OverviewPage-CmJl3bQb.js\": \"import{u as j,r as N,j as e}from\\\"./index-CAv5rt5M.js\\\";import{u as g,R as f}from\\\"./RequestErrorCallout-BT33_181.js\\\";import{P as t,f as p,a as r,b as _}from\\\"./format-BvCvFL95.js\\\";function R(){const i=j(),d=N.useCallback(({signal:x})=>i.get(\\\"/api/fleet/summary\\\",{signal:x}),[i]),{phase:c,data:s,error:l,retry:n,isRetryScheduled:m,nextRetryInMs:o,attempts:u,isFetching:v}=g(d),h=s?\\\"Issues loading latest fleet metrics\\\":\\\"Failed to load fleet metrics\\\",a=l?e.jsx(f,{title:h,error:l,onRetry:n,retryScheduled:m,nextRetryInMs:o,attempts:u,busy:v}):null;return!s&&c===\\\"loading\\\"?e.jsx(t,{title:\\\"Overview (Fleet)\\\",children:e.jsx(\\\"div\\\",{className:\\\"card\\\",children:\\\"Loading...\\\"})}):s?e.jsxs(t,{title:\\\"Overview (Fleet)\\\",children:[a?e.jsx(\\\"div\\\",{style:{marginBottom:\\\"1rem\\\"},children:a}):null,e.jsxs(\\\"div\\\",{className:\\\"grid kpis\\\",children:[e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Online %\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:p(s.online_pct)}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[s.devices_online,\\\"/\\\",s.devices_total,\\\" online\\\"]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Avg COP (24h)\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:r(s.avg_cop_24h,2)}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Window start \\\",_(s.window_start_ms)]})]}),e.jsxs(\\\"div\\\",{className:\\\"card tight\\\",children:[e.jsx(\\\"div\\\",{className:\\\"muted\\\",children:\\\"Low ?T events\\\"}),e.jsx(\\\"div\\\",{className:\\\"large-number\\\",children:r(s.low_deltaT_count_24h??0,0)}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[\\\"Oldest heartbeat \\\",r((s.max_heartbeat_age_sec??0)/60,1),\\\"m\\\"]})]})]}),e.jsxs(\\\"div\\\",{className:\\\"card mt-1\\\",children:[e.jsx(\\\"div\\\",{className:\\\"card-title\\\",children:\\\"Devices\\\"}),e.jsxs(\\\"div\\\",{className:\\\"subdued\\\",children:[s.devices_online,\\\"/\\\",s.devices_total,\\\" online\\\"]})]})]}):e.jsx(t,{title:\\\"Overview (Fleet)\\\",children:a??e.jsx(\\\"div\\\",{className:\\\"card callout error\\\",children:\\\"Failed to load fleet metrics\\\"})})}export{R as default};\\n\",\r\n  \"assets/RequestErrorCallout-BT33_181.js\": \"import{r as e,A as K,j as o}from\\\"./index-CAv5rt5M.js\\\";const j={initialDelayMs:2e3,multiplier:2,maxDelayMs:3e4};function L(t){return t?{initialDelayMs:t.initialDelayMs??j.initialDelayMs,multiplier:t.multiplier??j.multiplier,maxDelayMs:t.maxDelayMs??j.maxDelayMs}:j}function W(t,r){const i=Math.max(0,t-1),f=r.initialDelayMs*r.multiplier**i;return Math.min(r.maxDelayMs,f)}function _(t){if(t){if(typeof t==\\\"string\\\")return t;if(typeof t==\\\"number\\\"||typeof t==\\\"boolean\\\")return String(t);if(typeof t==\\\"object\\\"){const r=t.message??t.error??t.detail??t.title;return typeof r==\\\"string\\\"?r:void 0}}}function G(t){if(t instanceof K){const r=_(t.body),i=t.status>=500||t.status===429||t.status===408;return{message:`API request failed (${t.status})`,description:r,status:t.status,cause:t,retryable:i}}return t instanceof DOMException&&t.name===\\\"AbortError\\\"?{message:\\\"Request cancelled\\\",cause:t,retryable:!1}:t instanceof Error?{message:t.message||\\\"Request failed\\\",description:typeof t.cause==\\\"string\\\"?t.cause:void 0,cause:t,retryable:!0}:{message:\\\"Request failed\\\",cause:t,retryable:!0}}function X(t,r={}){const{initialData:i=null,autoRefreshMs:f,enableAutoRetry:A=!0,backoff:g,onSuccess:b,onError:S}=r,m=e.useMemo(()=>L(g),[g]),[s,I]=e.useState(()=>({phase:i?\\\"ready\\\":\\\"loading\\\",data:i,error:null,isFetching:!1,attempts:0,isRetryScheduled:!1,nextRetryInMs:null,lastUpdatedAt:i?Date.now():null,lastErrorAt:null})),h=e.useRef(s),M=e.useRef(!0),w=e.useRef(null),D=e.useRef(null),k=e.useRef(null),a=e.useRef(null),E=e.useRef(null);e.useEffect(()=>{h.current=s},[s]);const N=e.useCallback(n=>{I(p=>{const u=typeof n==\\\"function\\\"?n(p):n;return h.current=u,u})},[]),d=e.useCallback(n=>{M.current&&N(n)},[N]),C=e.useCallback(()=>{a.current&&(clearInterval(a.current),a.current=null)},[]),y=e.useCallback(()=>{k.current&&(clearTimeout(k.current),k.current=null)},[]),R=e.useCallback(()=>{D.current&&(clearTimeout(D.current),D.current=null),E.current=null,C(),d(n=>!n.isRetryScheduled&&n.nextRetryInMs===null?n:{...n,isRetryScheduled:!1,nextRetryInMs:null})},[C,d]),q=e.useCallback(()=>{E.current&&(C(),a.current=setInterval(()=>{if(!M.current){a.current&&(clearInterval(a.current),a.current=null);return}const n=E.current;if(!n){a.current&&(clearInterval(a.current),a.current=null);return}const p=Math.max(0,n-Date.now());d(u=>!u.isRetryScheduled||u.nextRetryInMs===p?u:{...u,nextRetryInMs:p}),p<=0&&a.current&&(clearInterval(a.current),a.current=null)},250))},[C,d]),x=e.useCallback(n=>{const p=!!n?.manual,u=!!n?.silent,B=n?.resetAttempts??p;R(),y();const v=new AbortController;w.current?.abort(),w.current=v;const U=h.current.data!==null;d(l=>{const c={...l,isFetching:!0,isRetryScheduled:!1,nextRetryInMs:null};return B&&(c.attempts=0),u||(c.phase=U?l.phase:\\\"loading\\\",U||(c.error=null)),c}),t({signal:v.signal}).then(l=>{M.current&&(R(),y(),d(c=>({phase:\\\"ready\\\",data:l,error:null,isFetching:!1,attempts:0,isRetryScheduled:!1,nextRetryInMs:null,lastUpdatedAt:Date.now(),lastErrorAt:c.lastErrorAt})),b?.(l),f&&f>0&&(k.current=setTimeout(()=>{x({silent:!0,resetAttempts:!0})},f)))}).catch(l=>{if(!M.current||v.signal.aborted||l instanceof DOMException&&l.name===\\\"AbortError\\\"||l instanceof Error&&l.name===\\\"AbortError\\\")return;y();const c=G(l),$=(B?0:h.current.attempts)+1,O=h.current.data!==null?\\\"ready\\\":\\\"error\\\",T=W($,m),F=A&&c.retryable;d(H=>({...H,phase:O,error:c,isFetching:!1,attempts:$,isRetryScheduled:F,nextRetryInMs:F?T:null,lastErrorAt:Date.now()})),S?.(l,c),F&&(E.current=Date.now()+T,D.current=setTimeout(()=>{D.current=null,E.current=null,x({silent:h.current.data!==null})},T),q())})},[f,m,y,A,S,b,t,d,q,R]),P=e.useCallback(()=>{const n=h.current.data!==null;x({manual:!0,silent:n,resetAttempts:!0})},[x]),z=e.useCallback(()=>{R()},[R]);return e.useEffect(()=>(x(),()=>{M.current=!1,w.current?.abort(),R(),y()}),[y,x,R]),{phase:s.phase,data:s.data,error:s.error,isFetching:s.isFetching,attempts:s.attempts,isRetryScheduled:s.isRetryScheduled,nextRetryInMs:s.nextRetryInMs,lastUpdatedAt:s.lastUpdatedAt,lastErrorAt:s.lastErrorAt,retry:P,cancelRetry:z}}function Y({title:t,error:r,onRetry:i,retryScheduled:f,nextRetryInMs:A,attempts:g,busy:b=!1}){const S=r.description??r.message,m=f&&typeof A==\\\"number\\\"?Math.max(0,Math.ceil(A/1e3)):null,s=[];g>0&&s.push(`Attempt ${g}`),m!==null?s.push(`Retrying in ${m}s`):r.retryable||s.push(\\\"Auto retry disabled\\\");const I=s.length?s.join(\\\" \u00E2\u20AC\u00A2 \\\"):null;return o.jsxs(\\\"div\\\",{className:\\\"card callout error\\\",children:[o.jsx(\\\"div\\\",{children:o.jsx(\\\"strong\\\",{children:t})}),o.jsx(\\\"div\\\",{children:S}),r.status?o.jsx(\\\"div\\\",{className:\\\"muted\\\",children:`HTTP status ${r.status}`}):null,I?o.jsx(\\\"div\\\",{className:\\\"muted\\\",children:I}):null,o.jsxs(\\\"div\\\",{className:\\\"mt-1\\\",style:{display:\\\"flex\\\",gap:\\\"0.5rem\\\",flexWrap:\\\"wrap\\\",alignItems:\\\"center\\\"},children:[o.jsx(\\\"button\\\",{type:\\\"button\\\",className:\\\"btn\\\",onClick:i,disabled:b,children:b?\\\"Retrying...\\\":\\\"Retry now\\\"}),m!==null?o.jsx(\\\"span\\\",{className:\\\"subdued\\\",children:`Next attempt in ${m}s`}):null]})]})}export{Y as R,X as u};\\n\",\r\n  \"assets/Sparkline-D2W6pTJo.js\": \"import{j as e}from\\\"./index-CAv5rt5M.js\\\";function h({values:a=[],color:i=\\\"#52ff99\\\",emptyLabel:l=\\\"No data\\\"}){const n=a.filter(t=>typeof t==\\\"number\\\"&&!Number.isNaN(t));if(n.length===0)return e.jsx(\\\"div\\\",{className:\\\"empty\\\",children:l});const o=Math.min(...n),r=Math.max(...n),s=n.map((t,m)=>{const c=n.length===1?100:m/(n.length-1)*100,p=100-(r===o?.5:(t-o)/(r-o))*100;return`${c.toFixed(2)},${p.toFixed(2)}`}).join(\\\" \\\");return e.jsxs(\\\"svg\\\",{className:\\\"sparkline\\\",viewBox:\\\"0 0 100 100\\\",role:\\\"img\\\",\\\"aria-label\\\":\\\"sparkline chart\\\",children:[e.jsx(\\\"polyline\\\",{points:s,fill:\\\"none\\\",stroke:i,strokeWidth:6,opacity:.08,strokeLinecap:\\\"round\\\"}),e.jsx(\\\"polyline\\\",{points:s,fill:\\\"none\\\",stroke:i,strokeWidth:2,strokeLinecap:\\\"round\\\",strokeLinejoin:\\\"round\\\"})]})}export{h as S};\\n\",\r\n  \"assets/format-BvCvFL95.js\": \"import{j as o}from\\\"./index-CAv5rt5M.js\\\";function c({title:t,actions:r=null,children:e}){return o.jsxs(\\\"div\\\",{className:\\\"wrap\\\",children:[o.jsxs(\\\"div\\\",{className:\\\"page-header\\\",children:[o.jsx(\\\"h2\\\",{className:\\\"page-title\\\",children:t}),r]}),e]})}function f(t,r=1){if(t==null||Number.isNaN(t))return\\\"\u00EF\u00BF\u00BD\\\";const e=Math.pow(10,r);return String(Math.round(t*e)/e)}function d(t,r=0){return t==null||Number.isNaN(t)?\\\"\u00EF\u00BF\u00BD\\\":`${f(t,r)}%`}function N(t){if(!t)return\\\"\u00EF\u00BF\u00BD\\\";const r=typeof t==\\\"number\\\"?new Date(t):new Date(String(t));if(Number.isNaN(r.getTime()))return String(t);const e=Date.now()-r.getTime(),n=e>=0?\\\"ago\\\":\\\"from now\\\",i=Math.abs(e);if(i<6e4)return\\\"just now\\\";const a=Math.round(i/6e4);if(a<60)return`${a}m ${n}`;const s=Math.round(a/60);return s<48?`${s}h ${n}`:`${Math.round(s/24)}d ${n}`}function g(t){if(!t)return\\\"\u00EF\u00BF\u00BD\\\";const r=typeof t==\\\"number\\\"?new Date(t):new Date(String(t));return Number.isNaN(r.getTime())?String(t):r.toLocaleString()}export{c as P,f as a,N as b,g as c,d as f};\\n\",\r\n  \"assets/index-y6znqhWW.css\": \":root{color-scheme:dark;--bg:#0b0f10;--card:#11181a;--muted:#6b7f7a;--fg:#e9ffef;--brand:#52ff99;--warn:#ffcc66;--err:#ff7a7a;--ok:#7dffa1}*{box-sizing:border-box}html,body,#root{height:100%}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}a{color:var(--brand);text-decoration:none}.nav{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;border-bottom:1px solid #17322a;background:#0d1415;position:sticky;top:0;z-index:10}.nav .brand{display:flex;align-items:center;gap:.5rem;font-weight:600;font-size:15px}.tag{padding:.1rem .5rem;border-radius:.5rem;background:#143c2c;color:#72ffb6;font-size:12px;text-transform:uppercase;letter-spacing:.08em}.sp{flex:1}.btn{background:#123026;border:1px solid #1d4a39;color:var(--fg);padding:.5rem .85rem;border-radius:.6rem;cursor:pointer;font-weight:500}.btn:hover{background:#173a2e}.btn.ghost{background:transparent;color:var(--muted);border-color:#1d4032}.btn.ghost.active{color:var(--fg);background:#123026}.wrap{max-width:1180px;margin:0 auto;padding:1.2rem}.page-header{display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}.page-title{margin:0}.flex-between{display:flex;justify-content:space-between;align-items:center}.flex-basis-220{flex:1 1 220px}.align-self-end{align-self:flex-end}.status-row{display:flex;align-items:center;gap:.5rem;margin-top:.4rem}.font-semibold{font-weight:600}.text-right{text-align:right}.trend-subtitle{font-size:16px;font-weight:600;margin-top:.2rem}.card-section{padding:0 1rem 1rem}.inline-link{display:inline-block;margin-top:.4rem}.mt-1{margin-top:1rem}.mt-06{margin-top:.6rem}.mt-04{margin-top:.4rem}.mt-02{margin-top:.2rem}.mb-1{margin-bottom:1rem}.grid{display:grid;gap:1rem}.grid.kpis{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}.grid.auto{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}.grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.75rem}.card{background:var(--card);border:1px solid #15352a;border-radius:1rem;padding:1rem;box-shadow:0 10px 25px #0000002e}.card.tight{padding:.75rem}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}.card-title{font-size:16px;font-weight:600}.muted{color:var(--muted)}.hero,.large-number{font-size:32px;font-weight:600}.subdued{color:#889a94;font-size:12px}.pill{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .55rem;border-radius:999px;background:#133126;color:#7dffa1;font-size:12px;text-transform:uppercase;letter-spacing:.08em}.pill.warn{background:#3a2e1a;color:var(--warn)}.pill.error{background:#3a1f1f;color:var(--err)}.chip{background:#102119;border:1px solid #1f4532;border-radius:.6rem;padding:.2rem .55rem;font-size:12px;display:inline-flex;align-items:center;gap:.3rem;color:#7dffa1}.chip.warn{border-color:#4d3c20;color:var(--warn);background:#2a2113}.chip.error{border-color:#4a2020;color:var(--err);background:#2a1414}table{width:100%;border-collapse:collapse}.table th,.table td{padding:.55rem .65rem;border-bottom:1px solid #163226;text-align:left;font-size:13px}.table tr:hover{background:#52ff990d}.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#ff7a7a}.status-dot.ok{background:#7dffa1}.sparkline{width:100%;height:60px}.list{display:flex;flex-direction:column;gap:.8rem}.list-item{display:flex;justify-content:space-between;align-items:flex-start;border:1px solid #163226;border-radius:.85rem;padding:.85rem;background:#0f1716;gap:.75rem}.list-item .meta{font-size:12px;color:var(--muted)}.metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem}.metric-tile{background:#101918;border:1px solid #1b382f;border-radius:.85rem;padding:.75rem}.metric-label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}.metric-value{margin-top:.35rem;font-size:20px;font-weight:600}.metric-sub{color:#86a59c;font-size:12px;margin-top:.2rem}.checklist{display:flex;flex-direction:column;gap:.45rem;margin-top:.6rem}.check-item{display:flex;justify-content:space-between;align-items:center;background:#101b19;border:1px solid #1b382f;border-radius:.7rem;padding:.45rem .6rem}.check-item.fail{background:#1a1111;border-color:#3e1c1c}.check-item span{font-size:13px}.progress-bar{appearance:none;-webkit-appearance:none;width:100%;height:8px;border-radius:999px;background:#132320;margin-top:.4rem;overflow:hidden;border:none}.progress-bar::-webkit-progress-bar{background:#132320;border-radius:999px}.progress-bar::-webkit-progress-value{background:linear-gradient(90deg,#1fcc78,#52ff99);border-radius:999px}.progress-bar::-moz-progress-bar{background:linear-gradient(90deg,#1fcc78,#52ff99);border-radius:999px}input,select{background:#0e1516;border:1px solid #193a30;color:var(--fg);border-radius:.6rem;padding:.5rem .6rem;font-size:14px}.flex{display:flex;gap:1rem;flex-wrap:wrap}.two-column{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}.empty{color:var(--muted);font-style:italic}.tabs{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}.stack{display:flex;flex-direction:column;gap:.75rem}.callout{background:#11231d;border:1px solid #1d4032;border-radius:.8rem;padding:.75rem;font-size:13px;color:#7dffa1}.callout.warn{background:#2a2113;border-color:#4a3a1a;color:var(--warn)}.callout.error{background:#2a1414;border-color:#4a2020;color:var(--err)}.min-table{max-height:320px;overflow:auto}.chart-card{padding:0}.chart-card svg{display:block;width:100%;height:160px}.section-title{font-size:18px;margin:0 0 .5rem;font-weight:600}.link{color:var(--brand);text-decoration:none}.link:hover{text-decoration:underline}.mono{font-family:JetBrains Mono,monospace}.badge{border:1px solid #2b5a49;border-radius:.4rem;padding:.2rem .45rem;font-size:12px}.pill+.pill{margin-left:.4rem}.card-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}.history-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.75rem}.history-card{background:#101918;border:1px solid #1b382f;border-radius:.75rem;padding:.6rem .75rem}.history-card strong{font-size:16px}@media(max-width:720px){.nav{flex-wrap:wrap;gap:.5rem}.nav .brand{margin-bottom:.25rem}.nav-links{flex-wrap:wrap;width:100%;margin-left:0}.nav-link{padding:.3rem .5rem}.nav .sp{display:none}.grid.kpis{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}}\\n\"\r\n} as const;\r\nexport type StaticBundleKey = keyof typeof STATIC_BUNDLE;\r\n", "export const JSON_CT = \"application/json;charset=utf-8\";\nexport const HTML_CT = \"text/html;charset=utf-8\";\nexport const SVG_CT = \"image/svg+xml;charset=utf-8\";\n\nexport interface SecurityHeaderOptions {\n  scriptSrc?: string[];\n  scriptHashes?: string[];\n  scriptNonces?: string[];\n  styleHashes?: string[];\n  styleNonces?: string[];\n  styleSrc?: string[];\n  connectSrc?: string[];\n  imgSrc?: string[];\n  fontSrc?: string[];\n}\n\nfunction appendUnique(target: string[], values?: string[]) {\n  if (!values) return;\n  for (const value of values) {\n    if (!target.includes(value)) {\n      target.push(value);\n    }\n  }\n}\n\nexport function withSecurityHeaders(res: Response, options: SecurityHeaderOptions = {}) {\n  const scriptSrc = [\"'self'\"];\n  appendUnique(scriptSrc, options.scriptSrc);\n  appendUnique(scriptSrc, options.scriptHashes);\n  appendUnique(scriptSrc, options.scriptNonces);\n\n  const styleSrc = [\"'self'\"];\n  appendUnique(styleSrc, options.styleHashes);\n  appendUnique(styleSrc, options.styleNonces);\n  appendUnique(styleSrc, options.styleSrc);\n\n  const connectSrc = [\"'self'\"];\n  appendUnique(connectSrc, options.connectSrc);\n\n  const imgSrc = [\"'self'\", \"data:\"];\n  appendUnique(imgSrc, options.imgSrc);\n\n  const fontSrc = [\"'self'\", \"data:\"];\n  appendUnique(fontSrc, options.fontSrc);\n\n  const csp = [\n    \"default-src 'self'\",\n    `script-src ${scriptSrc.join(\" \")}`,\n    `style-src ${styleSrc.join(\" \")}`,\n    `img-src ${imgSrc.join(\" \")}`,\n    `connect-src ${connectSrc.join(\" \")}`,\n    `font-src ${fontSrc.join(\" \")}`,\n    \"object-src 'none'\",\n    \"base-uri 'self'\",\n    \"frame-ancestors 'none'\",\n  ].join(\"; \");\n\n  const h = new Headers(res.headers);\n  h.set(\"Content-Security-Policy\", csp);\n  h.set(\"X-Content-Type-Options\", \"nosniff\");\n  h.set(\"Referrer-Policy\", \"no-referrer\");\n  h.set(\"Cross-Origin-Opener-Policy\", \"same-origin\");\n  h.set(\"Strict-Transport-Security\", \"max-age=31536000; includeSubDomains\");\n\n  return new Response(res.body, {\n    headers: h,\n    status: res.status,\n    statusText: res.statusText,\n  });\n}\n\nexport function json(data: unknown, init: ResponseInit = {}) {\n  const headers = new Headers({ \"content-type\": JSON_CT });\n  if (init.headers) {\n    const initHeaders = new Headers(init.headers);\n    initHeaders.forEach((value, key) => {\n      headers.set(key, value);\n    });\n  }\n  const responseInit: ResponseInit = { ...init, headers };\n  return withSecurityHeaders(new Response(JSON.stringify(data), responseInit));\n}\n\nexport function text(body: string, init: ResponseInit = {}) {\n  return withSecurityHeaders(new Response(body, init));\n}\n", "import manifest from \"./assets-manifest.json\" assert { type: \"json\" };\nimport { STATIC_BUNDLE } from \"./frontend/static-bundle\";\nimport { SVG_CT } from \"./utils/responses\";\n\ntype AssetManifest = Record<string, string>;\n\nconst MANIFEST = manifest as AssetManifest;\n\nfunction bundledAssetBody(name: string): string | null {\n  const key = `assets/${name}`;\n  const bundled = (STATIC_BUNDLE as Record<string, string | undefined>)[key];\n  return typeof bundled === \"string\" ? bundled : null;\n}\n\nexport const ASSETS: Record<string, { ct: string; body: string }> = Object.fromEntries(\n  Object.entries(MANIFEST).map(([name, fallback]) => {\n    const body = bundledAssetBody(name) ?? fallback;\n    return [name, { ct: SVG_CT, body }];\n  }),\n);\n", "export default crypto;\nexport const isCryptoKey = (key) => key instanceof CryptoKey;\n", "import digest from '../runtime/digest.js';\nexport const encoder = new TextEncoder();\nexport const decoder = new TextDecoder();\nconst MAX_INT32 = 2 ** 32;\nexport function concat(...buffers) {\n    const size = buffers.reduce((acc, { length }) => acc + length, 0);\n    const buf = new Uint8Array(size);\n    let i = 0;\n    for (const buffer of buffers) {\n        buf.set(buffer, i);\n        i += buffer.length;\n    }\n    return buf;\n}\nexport function p2s(alg, p2sInput) {\n    return concat(encoder.encode(alg), new Uint8Array([0]), p2sInput);\n}\nfunction writeUInt32BE(buf, value, offset) {\n    if (value < 0 || value >= MAX_INT32) {\n        throw new RangeError(`value must be >= 0 and <= ${MAX_INT32 - 1}. Received ${value}`);\n    }\n    buf.set([value >>> 24, value >>> 16, value >>> 8, value & 0xff], offset);\n}\nexport function uint64be(value) {\n    const high = Math.floor(value / MAX_INT32);\n    const low = value % MAX_INT32;\n    const buf = new Uint8Array(8);\n    writeUInt32BE(buf, high, 0);\n    writeUInt32BE(buf, low, 4);\n    return buf;\n}\nexport function uint32be(value) {\n    const buf = new Uint8Array(4);\n    writeUInt32BE(buf, value);\n    return buf;\n}\nexport function lengthAndInput(input) {\n    return concat(uint32be(input.length), input);\n}\nexport async function concatKdf(secret, bits, value) {\n    const iterations = Math.ceil((bits >> 3) / 32);\n    const res = new Uint8Array(iterations * 32);\n    for (let iter = 0; iter < iterations; iter++) {\n        const buf = new Uint8Array(4 + secret.length + value.length);\n        buf.set(uint32be(iter + 1));\n        buf.set(secret, 4);\n        buf.set(value, 4 + secret.length);\n        res.set(await digest('sha256', buf), iter * 32);\n    }\n    return res.slice(0, bits >> 3);\n}\n", "import { encoder, decoder } from '../lib/buffer_utils.js';\nexport const encodeBase64 = (input) => {\n    let unencoded = input;\n    if (typeof unencoded === 'string') {\n        unencoded = encoder.encode(unencoded);\n    }\n    const CHUNK_SIZE = 0x8000;\n    const arr = [];\n    for (let i = 0; i < unencoded.length; i += CHUNK_SIZE) {\n        arr.push(String.fromCharCode.apply(null, unencoded.subarray(i, i + CHUNK_SIZE)));\n    }\n    return btoa(arr.join(''));\n};\nexport const encode = (input) => {\n    return encodeBase64(input).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n};\nexport const decodeBase64 = (encoded) => {\n    const binary = atob(encoded);\n    const bytes = new Uint8Array(binary.length);\n    for (let i = 0; i < binary.length; i++) {\n        bytes[i] = binary.charCodeAt(i);\n    }\n    return bytes;\n};\nexport const decode = (input) => {\n    let encoded = input;\n    if (encoded instanceof Uint8Array) {\n        encoded = decoder.decode(encoded);\n    }\n    encoded = encoded.replace(/-/g, '+').replace(/_/g, '/').replace(/\\s/g, '');\n    try {\n        return decodeBase64(encoded);\n    }\n    catch {\n        throw new TypeError('The input to be decoded is not correctly encoded.');\n    }\n};\n", "export class JOSEError extends Error {\n    static get code() {\n        return 'ERR_JOSE_GENERIC';\n    }\n    constructor(message) {\n        super(message);\n        this.code = 'ERR_JOSE_GENERIC';\n        this.name = this.constructor.name;\n        Error.captureStackTrace?.(this, this.constructor);\n    }\n}\nexport class JWTClaimValidationFailed extends JOSEError {\n    static get code() {\n        return 'ERR_JWT_CLAIM_VALIDATION_FAILED';\n    }\n    constructor(message, payload, claim = 'unspecified', reason = 'unspecified') {\n        super(message);\n        this.code = 'ERR_JWT_CLAIM_VALIDATION_FAILED';\n        this.claim = claim;\n        this.reason = reason;\n        this.payload = payload;\n    }\n}\nexport class JWTExpired extends JOSEError {\n    static get code() {\n        return 'ERR_JWT_EXPIRED';\n    }\n    constructor(message, payload, claim = 'unspecified', reason = 'unspecified') {\n        super(message);\n        this.code = 'ERR_JWT_EXPIRED';\n        this.claim = claim;\n        this.reason = reason;\n        this.payload = payload;\n    }\n}\nexport class JOSEAlgNotAllowed extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JOSE_ALG_NOT_ALLOWED';\n    }\n    static get code() {\n        return 'ERR_JOSE_ALG_NOT_ALLOWED';\n    }\n}\nexport class JOSENotSupported extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JOSE_NOT_SUPPORTED';\n    }\n    static get code() {\n        return 'ERR_JOSE_NOT_SUPPORTED';\n    }\n}\nexport class JWEDecryptionFailed extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWE_DECRYPTION_FAILED';\n        this.message = 'decryption operation failed';\n    }\n    static get code() {\n        return 'ERR_JWE_DECRYPTION_FAILED';\n    }\n}\nexport class JWEInvalid extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWE_INVALID';\n    }\n    static get code() {\n        return 'ERR_JWE_INVALID';\n    }\n}\nexport class JWSInvalid extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWS_INVALID';\n    }\n    static get code() {\n        return 'ERR_JWS_INVALID';\n    }\n}\nexport class JWTInvalid extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWT_INVALID';\n    }\n    static get code() {\n        return 'ERR_JWT_INVALID';\n    }\n}\nexport class JWKInvalid extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWK_INVALID';\n    }\n    static get code() {\n        return 'ERR_JWK_INVALID';\n    }\n}\nexport class JWKSInvalid extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWKS_INVALID';\n    }\n    static get code() {\n        return 'ERR_JWKS_INVALID';\n    }\n}\nexport class JWKSNoMatchingKey extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWKS_NO_MATCHING_KEY';\n        this.message = 'no applicable key found in the JSON Web Key Set';\n    }\n    static get code() {\n        return 'ERR_JWKS_NO_MATCHING_KEY';\n    }\n}\nexport class JWKSMultipleMatchingKeys extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWKS_MULTIPLE_MATCHING_KEYS';\n        this.message = 'multiple matching keys found in the JSON Web Key Set';\n    }\n    static get code() {\n        return 'ERR_JWKS_MULTIPLE_MATCHING_KEYS';\n    }\n}\nSymbol.asyncIterator;\nexport class JWKSTimeout extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWKS_TIMEOUT';\n        this.message = 'request timed out';\n    }\n    static get code() {\n        return 'ERR_JWKS_TIMEOUT';\n    }\n}\nexport class JWSSignatureVerificationFailed extends JOSEError {\n    constructor() {\n        super(...arguments);\n        this.code = 'ERR_JWS_SIGNATURE_VERIFICATION_FAILED';\n        this.message = 'signature verification failed';\n    }\n    static get code() {\n        return 'ERR_JWS_SIGNATURE_VERIFICATION_FAILED';\n    }\n}\n", "function unusable(name, prop = 'algorithm.name') {\n    return new TypeError(`CryptoKey does not support this operation, its ${prop} must be ${name}`);\n}\nfunction isAlgorithm(algorithm, name) {\n    return algorithm.name === name;\n}\nfunction getHashLength(hash) {\n    return parseInt(hash.name.slice(4), 10);\n}\nfunction getNamedCurve(alg) {\n    switch (alg) {\n        case 'ES256':\n            return 'P-256';\n        case 'ES384':\n            return 'P-384';\n        case 'ES512':\n            return 'P-521';\n        default:\n            throw new Error('unreachable');\n    }\n}\nfunction checkUsage(key, usages) {\n    if (usages.length && !usages.some((expected) => key.usages.includes(expected))) {\n        let msg = 'CryptoKey does not support this operation, its usages must include ';\n        if (usages.length > 2) {\n            const last = usages.pop();\n            msg += `one of ${usages.join(', ')}, or ${last}.`;\n        }\n        else if (usages.length === 2) {\n            msg += `one of ${usages[0]} or ${usages[1]}.`;\n        }\n        else {\n            msg += `${usages[0]}.`;\n        }\n        throw new TypeError(msg);\n    }\n}\nexport function checkSigCryptoKey(key, alg, ...usages) {\n    switch (alg) {\n        case 'HS256':\n        case 'HS384':\n        case 'HS512': {\n            if (!isAlgorithm(key.algorithm, 'HMAC'))\n                throw unusable('HMAC');\n            const expected = parseInt(alg.slice(2), 10);\n            const actual = getHashLength(key.algorithm.hash);\n            if (actual !== expected)\n                throw unusable(`SHA-${expected}`, 'algorithm.hash');\n            break;\n        }\n        case 'RS256':\n        case 'RS384':\n        case 'RS512': {\n            if (!isAlgorithm(key.algorithm, 'RSASSA-PKCS1-v1_5'))\n                throw unusable('RSASSA-PKCS1-v1_5');\n            const expected = parseInt(alg.slice(2), 10);\n            const actual = getHashLength(key.algorithm.hash);\n            if (actual !== expected)\n                throw unusable(`SHA-${expected}`, 'algorithm.hash');\n            break;\n        }\n        case 'PS256':\n        case 'PS384':\n        case 'PS512': {\n            if (!isAlgorithm(key.algorithm, 'RSA-PSS'))\n                throw unusable('RSA-PSS');\n            const expected = parseInt(alg.slice(2), 10);\n            const actual = getHashLength(key.algorithm.hash);\n            if (actual !== expected)\n                throw unusable(`SHA-${expected}`, 'algorithm.hash');\n            break;\n        }\n        case 'EdDSA': {\n            if (key.algorithm.name !== 'Ed25519' && key.algorithm.name !== 'Ed448') {\n                throw unusable('Ed25519 or Ed448');\n            }\n            break;\n        }\n        case 'ES256':\n        case 'ES384':\n        case 'ES512': {\n            if (!isAlgorithm(key.algorithm, 'ECDSA'))\n                throw unusable('ECDSA');\n            const expected = getNamedCurve(alg);\n            const actual = key.algorithm.namedCurve;\n            if (actual !== expected)\n                throw unusable(expected, 'algorithm.namedCurve');\n            break;\n        }\n        default:\n            throw new TypeError('CryptoKey does not support this operation');\n    }\n    checkUsage(key, usages);\n}\nexport function checkEncCryptoKey(key, alg, ...usages) {\n    switch (alg) {\n        case 'A128GCM':\n        case 'A192GCM':\n        case 'A256GCM': {\n            if (!isAlgorithm(key.algorithm, 'AES-GCM'))\n                throw unusable('AES-GCM');\n            const expected = parseInt(alg.slice(1, 4), 10);\n            const actual = key.algorithm.length;\n            if (actual !== expected)\n                throw unusable(expected, 'algorithm.length');\n            break;\n        }\n        case 'A128KW':\n        case 'A192KW':\n        case 'A256KW': {\n            if (!isAlgorithm(key.algorithm, 'AES-KW'))\n                throw unusable('AES-KW');\n            const expected = parseInt(alg.slice(1, 4), 10);\n            const actual = key.algorithm.length;\n            if (actual !== expected)\n                throw unusable(expected, 'algorithm.length');\n            break;\n        }\n        case 'ECDH': {\n            switch (key.algorithm.name) {\n                case 'ECDH':\n                case 'X25519':\n                case 'X448':\n                    break;\n                default:\n                    throw unusable('ECDH, X25519, or X448');\n            }\n            break;\n        }\n        case 'PBES2-HS256+A128KW':\n        case 'PBES2-HS384+A192KW':\n        case 'PBES2-HS512+A256KW':\n            if (!isAlgorithm(key.algorithm, 'PBKDF2'))\n                throw unusable('PBKDF2');\n            break;\n        case 'RSA-OAEP':\n        case 'RSA-OAEP-256':\n        case 'RSA-OAEP-384':\n        case 'RSA-OAEP-512': {\n            if (!isAlgorithm(key.algorithm, 'RSA-OAEP'))\n                throw unusable('RSA-OAEP');\n            const expected = parseInt(alg.slice(9), 10) || 1;\n            const actual = getHashLength(key.algorithm.hash);\n            if (actual !== expected)\n                throw unusable(`SHA-${expected}`, 'algorithm.hash');\n            break;\n        }\n        default:\n            throw new TypeError('CryptoKey does not support this operation');\n    }\n    checkUsage(key, usages);\n}\n", "function message(msg, actual, ...types) {\n    types = types.filter(Boolean);\n    if (types.length > 2) {\n        const last = types.pop();\n        msg += `one of type ${types.join(', ')}, or ${last}.`;\n    }\n    else if (types.length === 2) {\n        msg += `one of type ${types[0]} or ${types[1]}.`;\n    }\n    else {\n        msg += `of type ${types[0]}.`;\n    }\n    if (actual == null) {\n        msg += ` Received ${actual}`;\n    }\n    else if (typeof actual === 'function' && actual.name) {\n        msg += ` Received function ${actual.name}`;\n    }\n    else if (typeof actual === 'object' && actual != null) {\n        if (actual.constructor?.name) {\n            msg += ` Received an instance of ${actual.constructor.name}`;\n        }\n    }\n    return msg;\n}\nexport default (actual, ...types) => {\n    return message('Key must be ', actual, ...types);\n};\nexport function withAlg(alg, actual, ...types) {\n    return message(`Key for the ${alg} algorithm must be `, actual, ...types);\n}\n", "import { isCryptoKey } from './webcrypto.js';\nexport default (key) => {\n    if (isCryptoKey(key)) {\n        return true;\n    }\n    return key?.[Symbol.toStringTag] === 'KeyObject';\n};\nexport const types = ['CryptoKey'];\n", "const isDisjoint = (...headers) => {\n    const sources = headers.filter(Boolean);\n    if (sources.length === 0 || sources.length === 1) {\n        return true;\n    }\n    let acc;\n    for (const header of sources) {\n        const parameters = Object.keys(header);\n        if (!acc || acc.size === 0) {\n            acc = new Set(parameters);\n            continue;\n        }\n        for (const parameter of parameters) {\n            if (acc.has(parameter)) {\n                return false;\n            }\n            acc.add(parameter);\n        }\n    }\n    return true;\n};\nexport default isDisjoint;\n", "function isObjectLike(value) {\n    return typeof value === 'object' && value !== null;\n}\nexport default function isObject(input) {\n    if (!isObjectLike(input) || Object.prototype.toString.call(input) !== '[object Object]') {\n        return false;\n    }\n    if (Object.getPrototypeOf(input) === null) {\n        return true;\n    }\n    let proto = input;\n    while (Object.getPrototypeOf(proto) !== null) {\n        proto = Object.getPrototypeOf(proto);\n    }\n    return Object.getPrototypeOf(input) === proto;\n}\n", "export default (alg, key) => {\n    if (alg.startsWith('RS') || alg.startsWith('PS')) {\n        const { modulusLength } = key.algorithm;\n        if (typeof modulusLength !== 'number' || modulusLength < 2048) {\n            throw new TypeError(`${alg} requires key modulusLength to be 2048 bits or larger`);\n        }\n    }\n};\n", "import isObject from './is_object.js';\nexport function isJWK(key) {\n    return isObject(key) && typeof key.kty === 'string';\n}\nexport function isPrivateJWK(key) {\n    return key.kty !== 'oct' && typeof key.d === 'string';\n}\nexport function isPublicJWK(key) {\n    return key.kty !== 'oct' && typeof key.d === 'undefined';\n}\nexport function isSecretJWK(key) {\n    return isJWK(key) && key.kty === 'oct' && typeof key.k === 'string';\n}\n", "import crypto from './webcrypto.js';\nimport { JOSENotSupported } from '../util/errors.js';\nfunction subtleMapping(jwk) {\n    let algorithm;\n    let keyUsages;\n    switch (jwk.kty) {\n        case 'RSA': {\n            switch (jwk.alg) {\n                case 'PS256':\n                case 'PS384':\n                case 'PS512':\n                    algorithm = { name: 'RSA-PSS', hash: `SHA-${jwk.alg.slice(-3)}` };\n                    keyUsages = jwk.d ? ['sign'] : ['verify'];\n                    break;\n                case 'RS256':\n                case 'RS384':\n                case 'RS512':\n                    algorithm = { name: 'RSASSA-PKCS1-v1_5', hash: `SHA-${jwk.alg.slice(-3)}` };\n                    keyUsages = jwk.d ? ['sign'] : ['verify'];\n                    break;\n                case 'RSA-OAEP':\n                case 'RSA-OAEP-256':\n                case 'RSA-OAEP-384':\n                case 'RSA-OAEP-512':\n                    algorithm = {\n                        name: 'RSA-OAEP',\n                        hash: `SHA-${parseInt(jwk.alg.slice(-3), 10) || 1}`,\n                    };\n                    keyUsages = jwk.d ? ['decrypt', 'unwrapKey'] : ['encrypt', 'wrapKey'];\n                    break;\n                default:\n                    throw new JOSENotSupported('Invalid or unsupported JWK \"alg\" (Algorithm) Parameter value');\n            }\n            break;\n        }\n        case 'EC': {\n            switch (jwk.alg) {\n                case 'ES256':\n                    algorithm = { name: 'ECDSA', namedCurve: 'P-256' };\n                    keyUsages = jwk.d ? ['sign'] : ['verify'];\n                    break;\n                case 'ES384':\n                    algorithm = { name: 'ECDSA', namedCurve: 'P-384' };\n                    keyUsages = jwk.d ? ['sign'] : ['verify'];\n                    break;\n                case 'ES512':\n                    algorithm = { name: 'ECDSA', namedCurve: 'P-521' };\n                    keyUsages = jwk.d ? ['sign'] : ['verify'];\n                    break;\n                case 'ECDH-ES':\n                case 'ECDH-ES+A128KW':\n                case 'ECDH-ES+A192KW':\n                case 'ECDH-ES+A256KW':\n                    algorithm = { name: 'ECDH', namedCurve: jwk.crv };\n                    keyUsages = jwk.d ? ['deriveBits'] : [];\n                    break;\n                default:\n                    throw new JOSENotSupported('Invalid or unsupported JWK \"alg\" (Algorithm) Parameter value');\n            }\n            break;\n        }\n        case 'OKP': {\n            switch (jwk.alg) {\n                case 'EdDSA':\n                    algorithm = { name: jwk.crv };\n                    keyUsages = jwk.d ? ['sign'] : ['verify'];\n                    break;\n                case 'ECDH-ES':\n                case 'ECDH-ES+A128KW':\n                case 'ECDH-ES+A192KW':\n                case 'ECDH-ES+A256KW':\n                    algorithm = { name: jwk.crv };\n                    keyUsages = jwk.d ? ['deriveBits'] : [];\n                    break;\n                default:\n                    throw new JOSENotSupported('Invalid or unsupported JWK \"alg\" (Algorithm) Parameter value');\n            }\n            break;\n        }\n        default:\n            throw new JOSENotSupported('Invalid or unsupported JWK \"kty\" (Key Type) Parameter value');\n    }\n    return { algorithm, keyUsages };\n}\nconst parse = async (jwk) => {\n    if (!jwk.alg) {\n        throw new TypeError('\"alg\" argument is required when \"jwk.alg\" is not present');\n    }\n    const { algorithm, keyUsages } = subtleMapping(jwk);\n    const rest = [\n        algorithm,\n        jwk.ext ?? false,\n        jwk.key_ops ?? keyUsages,\n    ];\n    const keyData = { ...jwk };\n    delete keyData.alg;\n    delete keyData.use;\n    return crypto.subtle.importKey('jwk', keyData, ...rest);\n};\nexport default parse;\n", "import { isJWK } from '../lib/is_jwk.js';\nimport { decode } from './base64url.js';\nimport importJWK from './jwk_to_key.js';\nconst exportKeyValue = (k) => decode(k);\nlet privCache;\nlet pubCache;\nconst isKeyObject = (key) => {\n    return key?.[Symbol.toStringTag] === 'KeyObject';\n};\nconst importAndCache = async (cache, key, jwk, alg, freeze = false) => {\n    let cached = cache.get(key);\n    if (cached?.[alg]) {\n        return cached[alg];\n    }\n    const cryptoKey = await importJWK({ ...jwk, alg });\n    if (freeze)\n        Object.freeze(key);\n    if (!cached) {\n        cache.set(key, { [alg]: cryptoKey });\n    }\n    else {\n        cached[alg] = cryptoKey;\n    }\n    return cryptoKey;\n};\nconst normalizePublicKey = (key, alg) => {\n    if (isKeyObject(key)) {\n        let jwk = key.export({ format: 'jwk' });\n        delete jwk.d;\n        delete jwk.dp;\n        delete jwk.dq;\n        delete jwk.p;\n        delete jwk.q;\n        delete jwk.qi;\n        if (jwk.k) {\n            return exportKeyValue(jwk.k);\n        }\n        pubCache || (pubCache = new WeakMap());\n        return importAndCache(pubCache, key, jwk, alg);\n    }\n    if (isJWK(key)) {\n        if (key.k)\n            return decode(key.k);\n        pubCache || (pubCache = new WeakMap());\n        const cryptoKey = importAndCache(pubCache, key, key, alg, true);\n        return cryptoKey;\n    }\n    return key;\n};\nconst normalizePrivateKey = (key, alg) => {\n    if (isKeyObject(key)) {\n        let jwk = key.export({ format: 'jwk' });\n        if (jwk.k) {\n            return exportKeyValue(jwk.k);\n        }\n        privCache || (privCache = new WeakMap());\n        return importAndCache(privCache, key, jwk, alg);\n    }\n    if (isJWK(key)) {\n        if (key.k)\n            return decode(key.k);\n        privCache || (privCache = new WeakMap());\n        const cryptoKey = importAndCache(privCache, key, key, alg, true);\n        return cryptoKey;\n    }\n    return key;\n};\nexport default { normalizePublicKey, normalizePrivateKey };\n", "import { decode as decodeBase64URL } from '../runtime/base64url.js';\nimport { fromSPKI, fromPKCS8, fromX509 } from '../runtime/asn1.js';\nimport asKeyObject from '../runtime/jwk_to_key.js';\nimport { JOSENotSupported } from '../util/errors.js';\nimport isObject from '../lib/is_object.js';\nexport async function importSPKI(spki, alg, options) {\n    if (typeof spki !== 'string' || spki.indexOf('-----BEGIN PUBLIC KEY-----') !== 0) {\n        throw new TypeError('\"spki\" must be SPKI formatted string');\n    }\n    return fromSPKI(spki, alg, options);\n}\nexport async function importX509(x509, alg, options) {\n    if (typeof x509 !== 'string' || x509.indexOf('-----BEGIN CERTIFICATE-----') !== 0) {\n        throw new TypeError('\"x509\" must be X.509 formatted string');\n    }\n    return fromX509(x509, alg, options);\n}\nexport async function importPKCS8(pkcs8, alg, options) {\n    if (typeof pkcs8 !== 'string' || pkcs8.indexOf('-----BEGIN PRIVATE KEY-----') !== 0) {\n        throw new TypeError('\"pkcs8\" must be PKCS#8 formatted string');\n    }\n    return fromPKCS8(pkcs8, alg, options);\n}\nexport async function importJWK(jwk, alg) {\n    if (!isObject(jwk)) {\n        throw new TypeError('JWK must be an object');\n    }\n    alg || (alg = jwk.alg);\n    switch (jwk.kty) {\n        case 'oct':\n            if (typeof jwk.k !== 'string' || !jwk.k) {\n                throw new TypeError('missing \"k\" (Key Value) Parameter value');\n            }\n            return decodeBase64URL(jwk.k);\n        case 'RSA':\n            if (jwk.oth !== undefined) {\n                throw new JOSENotSupported('RSA JWK \"oth\" (Other Primes Info) Parameter value is not supported');\n            }\n        case 'EC':\n        case 'OKP':\n            return asKeyObject({ ...jwk, alg });\n        default:\n            throw new JOSENotSupported('Unsupported \"kty\" (Key Type) Parameter value');\n    }\n}\n", "import { withAlg as invalidKeyInput } from './invalid_key_input.js';\nimport isKeyLike, { types } from '../runtime/is_key_like.js';\nimport * as jwk from './is_jwk.js';\nconst tag = (key) => key?.[Symbol.toStringTag];\nconst jwkMatchesOp = (alg, key, usage) => {\n    if (key.use !== undefined && key.use !== 'sig') {\n        throw new TypeError('Invalid key for this operation, when present its use must be sig');\n    }\n    if (key.key_ops !== undefined && key.key_ops.includes?.(usage) !== true) {\n        throw new TypeError(`Invalid key for this operation, when present its key_ops must include ${usage}`);\n    }\n    if (key.alg !== undefined && key.alg !== alg) {\n        throw new TypeError(`Invalid key for this operation, when present its alg must be ${alg}`);\n    }\n    return true;\n};\nconst symmetricTypeCheck = (alg, key, usage, allowJwk) => {\n    if (key instanceof Uint8Array)\n        return;\n    if (allowJwk && jwk.isJWK(key)) {\n        if (jwk.isSecretJWK(key) && jwkMatchesOp(alg, key, usage))\n            return;\n        throw new TypeError(`JSON Web Key for symmetric algorithms must have JWK \"kty\" (Key Type) equal to \"oct\" and the JWK \"k\" (Key Value) present`);\n    }\n    if (!isKeyLike(key)) {\n        throw new TypeError(invalidKeyInput(alg, key, ...types, 'Uint8Array', allowJwk ? 'JSON Web Key' : null));\n    }\n    if (key.type !== 'secret') {\n        throw new TypeError(`${tag(key)} instances for symmetric algorithms must be of type \"secret\"`);\n    }\n};\nconst asymmetricTypeCheck = (alg, key, usage, allowJwk) => {\n    if (allowJwk && jwk.isJWK(key)) {\n        switch (usage) {\n            case 'sign':\n                if (jwk.isPrivateJWK(key) && jwkMatchesOp(alg, key, usage))\n                    return;\n                throw new TypeError(`JSON Web Key for this operation be a private JWK`);\n            case 'verify':\n                if (jwk.isPublicJWK(key) && jwkMatchesOp(alg, key, usage))\n                    return;\n                throw new TypeError(`JSON Web Key for this operation be a public JWK`);\n        }\n    }\n    if (!isKeyLike(key)) {\n        throw new TypeError(invalidKeyInput(alg, key, ...types, allowJwk ? 'JSON Web Key' : null));\n    }\n    if (key.type === 'secret') {\n        throw new TypeError(`${tag(key)} instances for asymmetric algorithms must not be of type \"secret\"`);\n    }\n    if (usage === 'sign' && key.type === 'public') {\n        throw new TypeError(`${tag(key)} instances for asymmetric algorithm signing must be of type \"private\"`);\n    }\n    if (usage === 'decrypt' && key.type === 'public') {\n        throw new TypeError(`${tag(key)} instances for asymmetric algorithm decryption must be of type \"private\"`);\n    }\n    if (key.algorithm && usage === 'verify' && key.type === 'private') {\n        throw new TypeError(`${tag(key)} instances for asymmetric algorithm verifying must be of type \"public\"`);\n    }\n    if (key.algorithm && usage === 'encrypt' && key.type === 'private') {\n        throw new TypeError(`${tag(key)} instances for asymmetric algorithm encryption must be of type \"public\"`);\n    }\n};\nfunction checkKeyType(allowJwk, alg, key, usage) {\n    const symmetric = alg.startsWith('HS') ||\n        alg === 'dir' ||\n        alg.startsWith('PBES2') ||\n        /^A\\d{3}(?:GCM)?KW$/.test(alg);\n    if (symmetric) {\n        symmetricTypeCheck(alg, key, usage, allowJwk);\n    }\n    else {\n        asymmetricTypeCheck(alg, key, usage, allowJwk);\n    }\n}\nexport default checkKeyType.bind(undefined, false);\nexport const checkKeyTypeWithJwk = checkKeyType.bind(undefined, true);\n", "import { JOSENotSupported } from '../util/errors.js';\nfunction validateCrit(Err, recognizedDefault, recognizedOption, protectedHeader, joseHeader) {\n    if (joseHeader.crit !== undefined && protectedHeader?.crit === undefined) {\n        throw new Err('\"crit\" (Critical) Header Parameter MUST be integrity protected');\n    }\n    if (!protectedHeader || protectedHeader.crit === undefined) {\n        return new Set();\n    }\n    if (!Array.isArray(protectedHeader.crit) ||\n        protectedHeader.crit.length === 0 ||\n        protectedHeader.crit.some((input) => typeof input !== 'string' || input.length === 0)) {\n        throw new Err('\"crit\" (Critical) Header Parameter MUST be an array of non-empty strings when present');\n    }\n    let recognized;\n    if (recognizedOption !== undefined) {\n        recognized = new Map([...Object.entries(recognizedOption), ...recognizedDefault.entries()]);\n    }\n    else {\n        recognized = recognizedDefault;\n    }\n    for (const parameter of protectedHeader.crit) {\n        if (!recognized.has(parameter)) {\n            throw new JOSENotSupported(`Extension Header Parameter \"${parameter}\" is not recognized`);\n        }\n        if (joseHeader[parameter] === undefined) {\n            throw new Err(`Extension Header Parameter \"${parameter}\" is missing`);\n        }\n        if (recognized.get(parameter) && protectedHeader[parameter] === undefined) {\n            throw new Err(`Extension Header Parameter \"${parameter}\" MUST be integrity protected`);\n        }\n    }\n    return new Set(protectedHeader.crit);\n}\nexport default validateCrit;\n", "const validateAlgorithms = (option, algorithms) => {\n    if (algorithms !== undefined &&\n        (!Array.isArray(algorithms) || algorithms.some((s) => typeof s !== 'string'))) {\n        throw new TypeError(`\"${option}\" option must be an array of strings`);\n    }\n    if (!algorithms) {\n        return undefined;\n    }\n    return new Set(algorithms);\n};\nexport default validateAlgorithms;\n", "import { JOSENotSupported } from '../util/errors.js';\nexport default function subtleDsa(alg, algorithm) {\n    const hash = `SHA-${alg.slice(-3)}`;\n    switch (alg) {\n        case 'HS256':\n        case 'HS384':\n        case 'HS512':\n            return { hash, name: 'HMAC' };\n        case 'PS256':\n        case 'PS384':\n        case 'PS512':\n            return { hash, name: 'RSA-PSS', saltLength: alg.slice(-3) >> 3 };\n        case 'RS256':\n        case 'RS384':\n        case 'RS512':\n            return { hash, name: 'RSASSA-PKCS1-v1_5' };\n        case 'ES256':\n        case 'ES384':\n        case 'ES512':\n            return { hash, name: 'ECDSA', namedCurve: algorithm.namedCurve };\n        case 'EdDSA':\n            return { name: algorithm.name };\n        default:\n            throw new JOSENotSupported(`alg ${alg} is not supported either by JOSE or your javascript runtime`);\n    }\n}\n", "import crypto, { isCryptoKey } from './webcrypto.js';\nimport { checkSigCryptoKey } from '../lib/crypto_key.js';\nimport invalidKeyInput from '../lib/invalid_key_input.js';\nimport { types } from './is_key_like.js';\nimport normalize from './normalize_key.js';\nexport default async function getCryptoKey(alg, key, usage) {\n    if (usage === 'sign') {\n        key = await normalize.normalizePrivateKey(key, alg);\n    }\n    if (usage === 'verify') {\n        key = await normalize.normalizePublicKey(key, alg);\n    }\n    if (isCryptoKey(key)) {\n        checkSigCryptoKey(key, alg, usage);\n        return key;\n    }\n    if (key instanceof Uint8Array) {\n        if (!alg.startsWith('HS')) {\n            throw new TypeError(invalidKeyInput(key, ...types));\n        }\n        return crypto.subtle.importKey('raw', key, { hash: `SHA-${alg.slice(-3)}`, name: 'HMAC' }, false, [usage]);\n    }\n    throw new TypeError(invalidKeyInput(key, ...types, 'Uint8Array', 'JSON Web Key'));\n}\n", "import subtleAlgorithm from './subtle_dsa.js';\nimport crypto from './webcrypto.js';\nimport checkKeyLength from './check_key_length.js';\nimport getVerifyKey from './get_sign_verify_key.js';\nconst verify = async (alg, key, signature, data) => {\n    const cryptoKey = await getVerifyKey(alg, key, 'verify');\n    checkKeyLength(alg, cryptoKey);\n    const algorithm = subtleAlgorithm(alg, cryptoKey.algorithm);\n    try {\n        return await crypto.subtle.verify(algorithm, cryptoKey, signature, data);\n    }\n    catch {\n        return false;\n    }\n};\nexport default verify;\n", "import { decode as base64url } from '../../runtime/base64url.js';\nimport verify from '../../runtime/verify.js';\nimport { JOSEAlgNotAllowed, JWSInvalid, JWSSignatureVerificationFailed } from '../../util/errors.js';\nimport { concat, encoder, decoder } from '../../lib/buffer_utils.js';\nimport isDisjoint from '../../lib/is_disjoint.js';\nimport isObject from '../../lib/is_object.js';\nimport { checkKeyTypeWithJwk } from '../../lib/check_key_type.js';\nimport validateCrit from '../../lib/validate_crit.js';\nimport validateAlgorithms from '../../lib/validate_algorithms.js';\nimport { isJWK } from '../../lib/is_jwk.js';\nimport { importJWK } from '../../key/import.js';\nexport async function flattenedVerify(jws, key, options) {\n    if (!isObject(jws)) {\n        throw new JWSInvalid('Flattened JWS must be an object');\n    }\n    if (jws.protected === undefined && jws.header === undefined) {\n        throw new JWSInvalid('Flattened JWS must have either of the \"protected\" or \"header\" members');\n    }\n    if (jws.protected !== undefined && typeof jws.protected !== 'string') {\n        throw new JWSInvalid('JWS Protected Header incorrect type');\n    }\n    if (jws.payload === undefined) {\n        throw new JWSInvalid('JWS Payload missing');\n    }\n    if (typeof jws.signature !== 'string') {\n        throw new JWSInvalid('JWS Signature missing or incorrect type');\n    }\n    if (jws.header !== undefined && !isObject(jws.header)) {\n        throw new JWSInvalid('JWS Unprotected Header incorrect type');\n    }\n    let parsedProt = {};\n    if (jws.protected) {\n        try {\n            const protectedHeader = base64url(jws.protected);\n            parsedProt = JSON.parse(decoder.decode(protectedHeader));\n        }\n        catch {\n            throw new JWSInvalid('JWS Protected Header is invalid');\n        }\n    }\n    if (!isDisjoint(parsedProt, jws.header)) {\n        throw new JWSInvalid('JWS Protected and JWS Unprotected Header Parameter names must be disjoint');\n    }\n    const joseHeader = {\n        ...parsedProt,\n        ...jws.header,\n    };\n    const extensions = validateCrit(JWSInvalid, new Map([['b64', true]]), options?.crit, parsedProt, joseHeader);\n    let b64 = true;\n    if (extensions.has('b64')) {\n        b64 = parsedProt.b64;\n        if (typeof b64 !== 'boolean') {\n            throw new JWSInvalid('The \"b64\" (base64url-encode payload) Header Parameter must be a boolean');\n        }\n    }\n    const { alg } = joseHeader;\n    if (typeof alg !== 'string' || !alg) {\n        throw new JWSInvalid('JWS \"alg\" (Algorithm) Header Parameter missing or invalid');\n    }\n    const algorithms = options && validateAlgorithms('algorithms', options.algorithms);\n    if (algorithms && !algorithms.has(alg)) {\n        throw new JOSEAlgNotAllowed('\"alg\" (Algorithm) Header Parameter value not allowed');\n    }\n    if (b64) {\n        if (typeof jws.payload !== 'string') {\n            throw new JWSInvalid('JWS Payload must be a string');\n        }\n    }\n    else if (typeof jws.payload !== 'string' && !(jws.payload instanceof Uint8Array)) {\n        throw new JWSInvalid('JWS Payload must be a string or an Uint8Array instance');\n    }\n    let resolvedKey = false;\n    if (typeof key === 'function') {\n        key = await key(parsedProt, jws);\n        resolvedKey = true;\n        checkKeyTypeWithJwk(alg, key, 'verify');\n        if (isJWK(key)) {\n            key = await importJWK(key, alg);\n        }\n    }\n    else {\n        checkKeyTypeWithJwk(alg, key, 'verify');\n    }\n    const data = concat(encoder.encode(jws.protected ?? ''), encoder.encode('.'), typeof jws.payload === 'string' ? encoder.encode(jws.payload) : jws.payload);\n    let signature;\n    try {\n        signature = base64url(jws.signature);\n    }\n    catch {\n        throw new JWSInvalid('Failed to base64url decode the signature');\n    }\n    const verified = await verify(alg, key, signature, data);\n    if (!verified) {\n        throw new JWSSignatureVerificationFailed();\n    }\n    let payload;\n    if (b64) {\n        try {\n            payload = base64url(jws.payload);\n        }\n        catch {\n            throw new JWSInvalid('Failed to base64url decode the payload');\n        }\n    }\n    else if (typeof jws.payload === 'string') {\n        payload = encoder.encode(jws.payload);\n    }\n    else {\n        payload = jws.payload;\n    }\n    const result = { payload };\n    if (jws.protected !== undefined) {\n        result.protectedHeader = parsedProt;\n    }\n    if (jws.header !== undefined) {\n        result.unprotectedHeader = jws.header;\n    }\n    if (resolvedKey) {\n        return { ...result, key };\n    }\n    return result;\n}\n", "import { flattenedVerify } from '../flattened/verify.js';\nimport { JWSInvalid } from '../../util/errors.js';\nimport { decoder } from '../../lib/buffer_utils.js';\nexport async function compactVerify(jws, key, options) {\n    if (jws instanceof Uint8Array) {\n        jws = decoder.decode(jws);\n    }\n    if (typeof jws !== 'string') {\n        throw new JWSInvalid('Compact JWS must be a string or Uint8Array');\n    }\n    const { 0: protectedHeader, 1: payload, 2: signature, length } = jws.split('.');\n    if (length !== 3) {\n        throw new JWSInvalid('Invalid Compact JWS');\n    }\n    const verified = await flattenedVerify({ payload, protected: protectedHeader, signature }, key, options);\n    const result = { payload: verified.payload, protectedHeader: verified.protectedHeader };\n    if (typeof key === 'function') {\n        return { ...result, key: verified.key };\n    }\n    return result;\n}\n", "export default (date) => Math.floor(date.getTime() / 1000);\n", "const minute = 60;\nconst hour = minute * 60;\nconst day = hour * 24;\nconst week = day * 7;\nconst year = day * 365.25;\nconst REGEX = /^(\\+|\\-)? ?(\\d+|\\d+\\.\\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i;\nexport default (str) => {\n    const matched = REGEX.exec(str);\n    if (!matched || (matched[4] && matched[1])) {\n        throw new TypeError('Invalid time period format');\n    }\n    const value = parseFloat(matched[2]);\n    const unit = matched[3].toLowerCase();\n    let numericDate;\n    switch (unit) {\n        case 'sec':\n        case 'secs':\n        case 'second':\n        case 'seconds':\n        case 's':\n            numericDate = Math.round(value);\n            break;\n        case 'minute':\n        case 'minutes':\n        case 'min':\n        case 'mins':\n        case 'm':\n            numericDate = Math.round(value * minute);\n            break;\n        case 'hour':\n        case 'hours':\n        case 'hr':\n        case 'hrs':\n        case 'h':\n            numericDate = Math.round(value * hour);\n            break;\n        case 'day':\n        case 'days':\n        case 'd':\n            numericDate = Math.round(value * day);\n            break;\n        case 'week':\n        case 'weeks':\n        case 'w':\n            numericDate = Math.round(value * week);\n            break;\n        default:\n            numericDate = Math.round(value * year);\n            break;\n    }\n    if (matched[1] === '-' || matched[4] === 'ago') {\n        return -numericDate;\n    }\n    return numericDate;\n};\n", "import { JWTClaimValidationFailed, JWTExpired, JWTInvalid } from '../util/errors.js';\nimport { decoder } from './buffer_utils.js';\nimport epoch from './epoch.js';\nimport secs from './secs.js';\nimport isObject from './is_object.js';\nconst normalizeTyp = (value) => value.toLowerCase().replace(/^application\\//, '');\nconst checkAudiencePresence = (audPayload, audOption) => {\n    if (typeof audPayload === 'string') {\n        return audOption.includes(audPayload);\n    }\n    if (Array.isArray(audPayload)) {\n        return audOption.some(Set.prototype.has.bind(new Set(audPayload)));\n    }\n    return false;\n};\nexport default (protectedHeader, encodedPayload, options = {}) => {\n    let payload;\n    try {\n        payload = JSON.parse(decoder.decode(encodedPayload));\n    }\n    catch {\n    }\n    if (!isObject(payload)) {\n        throw new JWTInvalid('JWT Claims Set must be a top-level JSON object');\n    }\n    const { typ } = options;\n    if (typ &&\n        (typeof protectedHeader.typ !== 'string' ||\n            normalizeTyp(protectedHeader.typ) !== normalizeTyp(typ))) {\n        throw new JWTClaimValidationFailed('unexpected \"typ\" JWT header value', payload, 'typ', 'check_failed');\n    }\n    const { requiredClaims = [], issuer, subject, audience, maxTokenAge } = options;\n    const presenceCheck = [...requiredClaims];\n    if (maxTokenAge !== undefined)\n        presenceCheck.push('iat');\n    if (audience !== undefined)\n        presenceCheck.push('aud');\n    if (subject !== undefined)\n        presenceCheck.push('sub');\n    if (issuer !== undefined)\n        presenceCheck.push('iss');\n    for (const claim of new Set(presenceCheck.reverse())) {\n        if (!(claim in payload)) {\n            throw new JWTClaimValidationFailed(`missing required \"${claim}\" claim`, payload, claim, 'missing');\n        }\n    }\n    if (issuer &&\n        !(Array.isArray(issuer) ? issuer : [issuer]).includes(payload.iss)) {\n        throw new JWTClaimValidationFailed('unexpected \"iss\" claim value', payload, 'iss', 'check_failed');\n    }\n    if (subject && payload.sub !== subject) {\n        throw new JWTClaimValidationFailed('unexpected \"sub\" claim value', payload, 'sub', 'check_failed');\n    }\n    if (audience &&\n        !checkAudiencePresence(payload.aud, typeof audience === 'string' ? [audience] : audience)) {\n        throw new JWTClaimValidationFailed('unexpected \"aud\" claim value', payload, 'aud', 'check_failed');\n    }\n    let tolerance;\n    switch (typeof options.clockTolerance) {\n        case 'string':\n            tolerance = secs(options.clockTolerance);\n            break;\n        case 'number':\n            tolerance = options.clockTolerance;\n            break;\n        case 'undefined':\n            tolerance = 0;\n            break;\n        default:\n            throw new TypeError('Invalid clockTolerance option type');\n    }\n    const { currentDate } = options;\n    const now = epoch(currentDate || new Date());\n    if ((payload.iat !== undefined || maxTokenAge) && typeof payload.iat !== 'number') {\n        throw new JWTClaimValidationFailed('\"iat\" claim must be a number', payload, 'iat', 'invalid');\n    }\n    if (payload.nbf !== undefined) {\n        if (typeof payload.nbf !== 'number') {\n            throw new JWTClaimValidationFailed('\"nbf\" claim must be a number', payload, 'nbf', 'invalid');\n        }\n        if (payload.nbf > now + tolerance) {\n            throw new JWTClaimValidationFailed('\"nbf\" claim timestamp check failed', payload, 'nbf', 'check_failed');\n        }\n    }\n    if (payload.exp !== undefined) {\n        if (typeof payload.exp !== 'number') {\n            throw new JWTClaimValidationFailed('\"exp\" claim must be a number', payload, 'exp', 'invalid');\n        }\n        if (payload.exp <= now - tolerance) {\n            throw new JWTExpired('\"exp\" claim timestamp check failed', payload, 'exp', 'check_failed');\n        }\n    }\n    if (maxTokenAge) {\n        const age = now - payload.iat;\n        const max = typeof maxTokenAge === 'number' ? maxTokenAge : secs(maxTokenAge);\n        if (age - tolerance > max) {\n            throw new JWTExpired('\"iat\" claim timestamp check failed (too far in the past)', payload, 'iat', 'check_failed');\n        }\n        if (age < 0 - tolerance) {\n            throw new JWTClaimValidationFailed('\"iat\" claim timestamp check failed (it should be in the past)', payload, 'iat', 'check_failed');\n        }\n    }\n    return payload;\n};\n", "import { compactVerify } from '../jws/compact/verify.js';\nimport jwtPayload from '../lib/jwt_claims_set.js';\nimport { JWTInvalid } from '../util/errors.js';\nexport async function jwtVerify(jwt, key, options) {\n    const verified = await compactVerify(jwt, key, options);\n    if (verified.protectedHeader.crit?.includes('b64') && verified.protectedHeader.b64 === false) {\n        throw new JWTInvalid('JWTs MUST NOT use unencoded payload');\n    }\n    const payload = jwtPayload(verified.protectedHeader, verified.payload, options);\n    const result = { payload, protectedHeader: verified.protectedHeader };\n    if (typeof key === 'function') {\n        return { ...result, key: verified.key };\n    }\n    return result;\n}\n", "import { importJWK } from '../key/import.js';\nimport { JWKSInvalid, JOSENotSupported, JWKSNoMatchingKey, JWKSMultipleMatchingKeys, } from '../util/errors.js';\nimport isObject from '../lib/is_object.js';\nfunction getKtyFromAlg(alg) {\n    switch (typeof alg === 'string' && alg.slice(0, 2)) {\n        case 'RS':\n        case 'PS':\n            return 'RSA';\n        case 'ES':\n            return 'EC';\n        case 'Ed':\n            return 'OKP';\n        default:\n            throw new JOSENotSupported('Unsupported \"alg\" value for a JSON Web Key Set');\n    }\n}\nfunction isJWKSLike(jwks) {\n    return (jwks &&\n        typeof jwks === 'object' &&\n        Array.isArray(jwks.keys) &&\n        jwks.keys.every(isJWKLike));\n}\nfunction isJWKLike(key) {\n    return isObject(key);\n}\nfunction clone(obj) {\n    if (typeof structuredClone === 'function') {\n        return structuredClone(obj);\n    }\n    return JSON.parse(JSON.stringify(obj));\n}\nclass LocalJWKSet {\n    constructor(jwks) {\n        this._cached = new WeakMap();\n        if (!isJWKSLike(jwks)) {\n            throw new JWKSInvalid('JSON Web Key Set malformed');\n        }\n        this._jwks = clone(jwks);\n    }\n    async getKey(protectedHeader, token) {\n        const { alg, kid } = { ...protectedHeader, ...token?.header };\n        const kty = getKtyFromAlg(alg);\n        const candidates = this._jwks.keys.filter((jwk) => {\n            let candidate = kty === jwk.kty;\n            if (candidate && typeof kid === 'string') {\n                candidate = kid === jwk.kid;\n            }\n            if (candidate && typeof jwk.alg === 'string') {\n                candidate = alg === jwk.alg;\n            }\n            if (candidate && typeof jwk.use === 'string') {\n                candidate = jwk.use === 'sig';\n            }\n            if (candidate && Array.isArray(jwk.key_ops)) {\n                candidate = jwk.key_ops.includes('verify');\n            }\n            if (candidate && alg === 'EdDSA') {\n                candidate = jwk.crv === 'Ed25519' || jwk.crv === 'Ed448';\n            }\n            if (candidate) {\n                switch (alg) {\n                    case 'ES256':\n                        candidate = jwk.crv === 'P-256';\n                        break;\n                    case 'ES256K':\n                        candidate = jwk.crv === 'secp256k1';\n                        break;\n                    case 'ES384':\n                        candidate = jwk.crv === 'P-384';\n                        break;\n                    case 'ES512':\n                        candidate = jwk.crv === 'P-521';\n                        break;\n                }\n            }\n            return candidate;\n        });\n        const { 0: jwk, length } = candidates;\n        if (length === 0) {\n            throw new JWKSNoMatchingKey();\n        }\n        if (length !== 1) {\n            const error = new JWKSMultipleMatchingKeys();\n            const { _cached } = this;\n            error[Symbol.asyncIterator] = async function* () {\n                for (const jwk of candidates) {\n                    try {\n                        yield await importWithAlgCache(_cached, jwk, alg);\n                    }\n                    catch { }\n                }\n            };\n            throw error;\n        }\n        return importWithAlgCache(this._cached, jwk, alg);\n    }\n}\nasync function importWithAlgCache(cache, jwk, alg) {\n    const cached = cache.get(jwk) || cache.set(jwk, {}).get(jwk);\n    if (cached[alg] === undefined) {\n        const key = await importJWK({ ...jwk, ext: true }, alg);\n        if (key instanceof Uint8Array || key.type !== 'public') {\n            throw new JWKSInvalid('JSON Web Key Set members must be public keys');\n        }\n        cached[alg] = key;\n    }\n    return cached[alg];\n}\nexport function createLocalJWKSet(jwks) {\n    const set = new LocalJWKSet(jwks);\n    const localJWKSet = async (protectedHeader, token) => set.getKey(protectedHeader, token);\n    Object.defineProperties(localJWKSet, {\n        jwks: {\n            value: () => clone(set._jwks),\n            enumerable: true,\n            configurable: false,\n            writable: false,\n        },\n    });\n    return localJWKSet;\n}\n", "import { JOSEError, JWKSTimeout } from '../util/errors.js';\nconst fetchJwks = async (url, timeout, options) => {\n    let controller;\n    let id;\n    let timedOut = false;\n    if (typeof AbortController === 'function') {\n        controller = new AbortController();\n        id = setTimeout(() => {\n            timedOut = true;\n            controller.abort();\n        }, timeout);\n    }\n    const response = await fetch(url.href, {\n        signal: controller ? controller.signal : undefined,\n        redirect: 'manual',\n        headers: options.headers,\n    }).catch((err) => {\n        if (timedOut)\n            throw new JWKSTimeout();\n        throw err;\n    });\n    if (id !== undefined)\n        clearTimeout(id);\n    if (response.status !== 200) {\n        throw new JOSEError('Expected 200 OK from the JSON Web Key Set HTTP response');\n    }\n    try {\n        return await response.json();\n    }\n    catch {\n        throw new JOSEError('Failed to parse the JSON Web Key Set HTTP response as JSON');\n    }\n};\nexport default fetchJwks;\n", "import fetchJwks from '../runtime/fetch_jwks.js';\nimport { JWKSNoMatchingKey } from '../util/errors.js';\nimport { createLocalJWKSet } from './local.js';\nimport isObject from '../lib/is_object.js';\nfunction isCloudflareWorkers() {\n    return (typeof WebSocketPair !== 'undefined' ||\n        (typeof navigator !== 'undefined' && navigator.userAgent === 'Cloudflare-Workers') ||\n        (typeof EdgeRuntime !== 'undefined' && EdgeRuntime === 'vercel'));\n}\nlet USER_AGENT;\nif (typeof navigator === 'undefined' || !navigator.userAgent?.startsWith?.('Mozilla/5.0 ')) {\n    const NAME = 'jose';\n    const VERSION = 'v5.9.3';\n    USER_AGENT = `${NAME}/${VERSION}`;\n}\nexport const jwksCache = Symbol();\nfunction isFreshJwksCache(input, cacheMaxAge) {\n    if (typeof input !== 'object' || input === null) {\n        return false;\n    }\n    if (!('uat' in input) || typeof input.uat !== 'number' || Date.now() - input.uat >= cacheMaxAge) {\n        return false;\n    }\n    if (!('jwks' in input) ||\n        !isObject(input.jwks) ||\n        !Array.isArray(input.jwks.keys) ||\n        !Array.prototype.every.call(input.jwks.keys, isObject)) {\n        return false;\n    }\n    return true;\n}\nclass RemoteJWKSet {\n    constructor(url, options) {\n        if (!(url instanceof URL)) {\n            throw new TypeError('url must be an instance of URL');\n        }\n        this._url = new URL(url.href);\n        this._options = { agent: options?.agent, headers: options?.headers };\n        this._timeoutDuration =\n            typeof options?.timeoutDuration === 'number' ? options?.timeoutDuration : 5000;\n        this._cooldownDuration =\n            typeof options?.cooldownDuration === 'number' ? options?.cooldownDuration : 30000;\n        this._cacheMaxAge = typeof options?.cacheMaxAge === 'number' ? options?.cacheMaxAge : 600000;\n        if (options?.[jwksCache] !== undefined) {\n            this._cache = options?.[jwksCache];\n            if (isFreshJwksCache(options?.[jwksCache], this._cacheMaxAge)) {\n                this._jwksTimestamp = this._cache.uat;\n                this._local = createLocalJWKSet(this._cache.jwks);\n            }\n        }\n    }\n    coolingDown() {\n        return typeof this._jwksTimestamp === 'number'\n            ? Date.now() < this._jwksTimestamp + this._cooldownDuration\n            : false;\n    }\n    fresh() {\n        return typeof this._jwksTimestamp === 'number'\n            ? Date.now() < this._jwksTimestamp + this._cacheMaxAge\n            : false;\n    }\n    async getKey(protectedHeader, token) {\n        if (!this._local || !this.fresh()) {\n            await this.reload();\n        }\n        try {\n            return await this._local(protectedHeader, token);\n        }\n        catch (err) {\n            if (err instanceof JWKSNoMatchingKey) {\n                if (this.coolingDown() === false) {\n                    await this.reload();\n                    return this._local(protectedHeader, token);\n                }\n            }\n            throw err;\n        }\n    }\n    async reload() {\n        if (this._pendingFetch && isCloudflareWorkers()) {\n            this._pendingFetch = undefined;\n        }\n        const headers = new Headers(this._options.headers);\n        if (USER_AGENT && !headers.has('User-Agent')) {\n            headers.set('User-Agent', USER_AGENT);\n            this._options.headers = Object.fromEntries(headers.entries());\n        }\n        this._pendingFetch || (this._pendingFetch = fetchJwks(this._url, this._timeoutDuration, this._options)\n            .then((json) => {\n            this._local = createLocalJWKSet(json);\n            if (this._cache) {\n                this._cache.uat = Date.now();\n                this._cache.jwks = json;\n            }\n            this._jwksTimestamp = Date.now();\n            this._pendingFetch = undefined;\n        })\n            .catch((err) => {\n            this._pendingFetch = undefined;\n            throw err;\n        }));\n        await this._pendingFetch;\n    }\n}\nexport function createRemoteJWKSet(url, options) {\n    const set = new RemoteJWKSet(url, options);\n    const remoteJWKSet = async (protectedHeader, token) => set.getKey(protectedHeader, token);\n    Object.defineProperties(remoteJWKSet, {\n        coolingDown: {\n            get: () => set.coolingDown(),\n            enumerable: true,\n            configurable: false,\n        },\n        fresh: {\n            get: () => set.fresh(),\n            enumerable: true,\n            configurable: false,\n        },\n        reload: {\n            value: () => set.reload(),\n            enumerable: true,\n            configurable: false,\n            writable: false,\n        },\n        reloading: {\n            get: () => !!set._pendingFetch,\n            enumerable: true,\n            configurable: false,\n        },\n        jwks: {\n            value: () => set._local?.jwks(),\n            enumerable: true,\n            configurable: false,\n            writable: false,\n        },\n    });\n    return remoteJWKSet;\n}\nexport const experimental_jwksCache = jwksCache;\n", "import * as base64url from '../runtime/base64url.js';\nexport const encode = base64url.encode;\nexport const decode = base64url.decode;\n", "import { decode as base64url } from './base64url.js';\nimport { decoder } from '../lib/buffer_utils.js';\nimport isObject from '../lib/is_object.js';\nimport { JWTInvalid } from './errors.js';\nexport function decodeJwt(jwt) {\n    if (typeof jwt !== 'string')\n        throw new JWTInvalid('JWTs must use Compact JWS serialization, JWT must be a string');\n    const { 1: payload, length } = jwt.split('.');\n    if (length === 5)\n        throw new JWTInvalid('Only JWTs using Compact JWS serialization can be decoded');\n    if (length !== 3)\n        throw new JWTInvalid('Invalid JWT');\n    if (!payload)\n        throw new JWTInvalid('JWTs must contain a payload');\n    let decoded;\n    try {\n        decoded = base64url(payload);\n    }\n    catch {\n        throw new JWTInvalid('Failed to base64url decode the payload');\n    }\n    let result;\n    try {\n        result = JSON.parse(decoder.decode(decoded));\n    }\n    catch {\n        throw new JWTInvalid('Failed to parse the decoded payload as JSON');\n    }\n    if (!isObject(result))\n        throw new JWTInvalid('Invalid JWT Claims Set');\n    return result;\n}\n", "// src/rbac.ts\nimport type { JWTPayload } from \"jose\";\nimport type { User } from \"./env\";\n\nconst ROLE_MAP: Record<string, User[\"roles\"][number]> = {\n  admin: \"admin\",\n  contractor: \"contractor\",\n  client: \"client\",\n};\n\nexport function canonicalRole(candidate: string): User[\"roles\"][number] | null {\n  const normalized = candidate.trim().toLowerCase();\n  if (!normalized) return null;\n  return ROLE_MAP[normalized] ?? null;\n}\n\n/**\n * Canonical RBAC helpers.\n * - roles from roles[] or groups[]\n * - clientIds from explicit clientIds[] OR groups like \"client:<id>\"\n * SECURITY: Fail-closed. If no supported role is present, user gets no roles.\n */\nexport function deriveUserFromClaims(claims: JWTPayload): User {\n  const email = (claims as any).email || claims.sub || \"unknown@unknown\";\n\n  // Normalize potential role/group arrays to string[]\n  const rawRolesArr: unknown[] = Array.isArray((claims as any).roles)\n    ? (claims as any).roles\n    : Array.isArray((claims as any).groups)\n    ? (claims as any).groups\n    : [];\n  const rawRoles: string[] = rawRolesArr.map((r) => String(r));\n\n  const roles = new Set<User[\"roles\"][number]>();\n  for (const r of rawRoles) {\n    const canonical = canonicalRole(r);\n    if (canonical) {\n      roles.add(canonical);\n    }\n  }\n  // No default grant - unknown users have zero roles\n\n  // ---- clientIds\n  const groupsUnknown: unknown[] = Array.isArray((claims as any).groups)\n    ? (claims as any).groups\n    : [];\n  const groups: string[] = groupsUnknown.map((g) => String(g));\n\n  const fromGroups: string[] = groups\n    .filter((g: string) => g.startsWith(\"client:\"))\n    .map((g: string) => g.slice(\"client:\".length));\n\n  const claimIdsUnknown: unknown[] = Array.isArray((claims as any).clientIds)\n    ? (claims as any).clientIds\n    : [];\n  const fromClaim: string[] = claimIdsUnknown.map((id) => String(id));\n\n  const clientIds = Array.from(new Set<string>([...fromGroups, ...fromClaim]));\n\n  return { email, roles: Array.from(roles), clientIds };\n}\n\nexport function landingFor(user: User): string {\n  if (user.roles.includes(\"admin\")) return \"/app/overview\";\n  if (user.roles.includes(\"client\")) return \"/app/compact\";\n  if (user.roles.includes(\"contractor\")) return \"/app/devices\";\n  // no roles => explicit unauthorized landing\n  return \"/app/unauthorized\";\n}\n", "import type { Env } from \"../env\";\n\ntype LogLevel = \"debug\" | \"info\" | \"warn\" | \"error\";\n\ntype RedactionOptions = {\n  clientIp: boolean;\n  userAgent: boolean;\n  cfRay: boolean;\n};\n\ntype LoggingConfig = {\n  level: LogLevel;\n  debugSampleRate: number;\n  redaction: RedactionOptions;\n};\n\nconst LEVEL_PRIORITY: Record<LogLevel, number> = {\n  debug: 10,\n  info: 20,\n  warn: 30,\n  error: 40,\n};\n\nconst DEFAULT_REDACTION: RedactionOptions = {\n  clientIp: false,\n  userAgent: false,\n  cfRay: false,\n};\n\nlet loggingConfig: LoggingConfig = {\n  level: \"debug\",\n  debugSampleRate: 1,\n  redaction: DEFAULT_REDACTION,\n};\n\nlet configuredFromEnv = false;\n\nexport type LogFields = Record<string, unknown>;\n\nexport interface Logger {\n  debug(message: string, fields?: LogFields): void;\n  info(message: string, fields?: LogFields): void;\n  warn(message: string, fields?: LogFields): void;\n  error(message: string, fields?: LogFields): void;\n  with(extra: LogFields): Logger;\n}\n\ninterface LogEntry extends LogFields {\n  ts: string;\n  level: LogLevel;\n  msg: string;\n}\n\nclass JsonLogger implements Logger {\n  private readonly base: LogFields;\n\n  constructor(base: LogFields = {}) {\n    this.base = pruneUndefined(base);\n  }\n\n  debug(message: string, fields?: LogFields) {\n    if (!shouldLog(\"debug\")) return;\n    this.emit(\"debug\", message, fields);\n  }\n\n  info(message: string, fields?: LogFields) {\n    if (!shouldLog(\"info\")) return;\n    this.emit(\"info\", message, fields);\n  }\n\n  warn(message: string, fields?: LogFields) {\n    if (!shouldLog(\"warn\")) return;\n    this.emit(\"warn\", message, fields);\n  }\n\n  error(message: string, fields?: LogFields) {\n    if (!shouldLog(\"error\")) return;\n    this.emit(\"error\", message, fields);\n  }\n\n  with(extra: LogFields): Logger {\n    const merged: LogFields = { ...this.base, ...pruneUndefined(extra) };\n    return new JsonLogger(merged);\n  }\n\n  private emit(level: LogLevel, message: string, fields?: LogFields) {\n    const entry: LogEntry = {\n      ts: new Date().toISOString(),\n      level,\n      msg: message,\n      ...this.base,\n      ...pruneUndefined((fields ?? {}) as LogFields),\n    };\n\n    if (entry.error instanceof Error) {\n      entry.error = serializeError(entry.error);\n    } else if (entry.error && typeof entry.error === \"object\") {\n      entry.error = normalizeErrorLike(entry.error as Record<string, unknown>);\n    }\n\n    writeLog(applyRedaction(entry));\n  }\n}\n\nconst requestLoggers = new WeakMap<Request, Logger>();\n\nexport function bindRequestLogger(req: Request, env: Env, extra?: LogFields): Logger {\n  configureLoggingFromEnv(env);\n  const base: LogFields = {\n    request_id: deriveRequestId(req),\n    method: req.method,\n    path: safePath(req.url),\n    host: safeHost(req.url),\n    user_agent: headerOrNull(req, \"user-agent\"),\n    client_ip: headerOrNull(req, \"cf-connecting-ip\"),\n    cf_ray: headerOrNull(req, \"cf-ray\"),\n    ...pruneUndefined((extra ?? {}) as LogFields),\n  };\n\n  const logger = new JsonLogger(base);\n  requestLoggers.set(req, logger);\n  return logger;\n}\n\nexport function loggerForRequest(req: Request, extra?: LogFields): Logger {\n  const existing = requestLoggers.get(req);\n  if (existing) {\n    return extra && Object.keys(extra).length ? existing.with(extra) : existing;\n  }\n\n  const logger = new JsonLogger(pruneUndefined((extra ?? {}) as LogFields));\n  requestLoggers.set(req, logger);\n  return logger;\n}\n\nexport function releaseRequestLogger(req: Request) {\n  requestLoggers.delete(req);\n}\n\nexport function systemLogger(extra?: LogFields): Logger {\n  return new JsonLogger({ scope: \"system\", ...pruneUndefined((extra ?? {}) as LogFields) });\n}\n\nexport function serializeError(err: unknown) {\n  if (err instanceof Error) {\n    return {\n      name: err.name,\n      message: err.message,\n      stack: err.stack,\n    };\n  }\n  if (typeof err === \"string\") {\n    return { message: err };\n  }\n  if (typeof err === \"object\" && err !== null) {\n    const obj = err as Record<string, unknown>;\n    return {\n      name: typeof obj.name === \"string\" ? obj.name : undefined,\n      message: typeof obj.message === \"string\" ? obj.message : JSON.stringify(obj),\n    };\n  }\n  return { message: String(err) };\n}\n\nfunction normalizeErrorLike(errorLike: Record<string, unknown>) {\n  const normalized: Record<string, unknown> = {};\n  for (const [key, value] of Object.entries(errorLike)) {\n    if (value instanceof Error) {\n      normalized[key] = serializeError(value);\n    } else if (typeof value === \"bigint\") {\n      normalized[key] = value.toString();\n    } else {\n      normalized[key] = value;\n    }\n  }\n  return normalized;\n}\n\nfunction pruneUndefined(fields: LogFields): LogFields {\n  const pruned: LogFields = {};\n  for (const [key, value] of Object.entries(fields)) {\n    if (value === undefined) continue;\n    if (typeof value === \"bigint\") {\n      pruned[key] = value.toString();\n    } else if (value instanceof Error) {\n      pruned[key] = serializeError(value);\n    } else {\n      pruned[key] = value;\n    }\n  }\n  return pruned;\n}\n\nfunction safePath(url: string) {\n  try {\n    return new URL(url).pathname;\n  } catch {\n    return url;\n  }\n}\n\nfunction safeHost(url: string) {\n  try {\n    return new URL(url).host;\n  } catch {\n    return undefined;\n  }\n}\n\nfunction headerOrNull(req: Request, key: string) {\n  const value = req.headers.get(key);\n  return value ?? undefined;\n}\n\nfunction deriveRequestId(req: Request) {\n  const explicit = req.headers.get(\"x-request-id\") ?? req.headers.get(\"cf-ray\");\n  if (explicit) return explicit;\n  if (typeof crypto?.randomUUID === \"function\") {\n    return crypto.randomUUID();\n  }\n  return `req-${Date.now()}-${Math.random().toString(16).slice(2)}`;\n}\n\nfunction writeLog(entry: LogEntry) {\n  try {\n    console.log(JSON.stringify(entry, replacer));\n  } catch (err) {\n    console.log(\n      JSON.stringify({\n        ts: new Date().toISOString(),\n        level: \"error\",\n        msg: \"log_serialization_failed\",\n        original_message: entry.msg,\n        error: serializeError(err),\n      }),\n    );\n  }\n}\n\nfunction replacer(_key: string, value: unknown) {\n  if (value instanceof Error) return serializeError(value);\n  if (typeof value === \"bigint\") return value.toString();\n  if (typeof value === \"function\") return undefined;\n  if (value instanceof Request) {\n    return { method: value.method, url: value.url };\n  }\n  if (value instanceof Response) {\n    return { status: value.status };\n  }\n  return value;\n}\n\nfunction shouldLog(level: LogLevel): boolean {\n  if (LEVEL_PRIORITY[level] < LEVEL_PRIORITY[loggingConfig.level]) {\n    return false;\n  }\n  if (level === \"debug\" && loggingConfig.debugSampleRate < 1) {\n    return Math.random() < loggingConfig.debugSampleRate;\n  }\n  return true;\n}\n\nfunction applyRedaction(entry: LogEntry): LogEntry {\n  const { redaction } = loggingConfig;\n  if (!redaction.clientIp && !redaction.userAgent && !redaction.cfRay) {\n    return entry;\n  }\n  const clone: LogEntry = { ...entry };\n  if (redaction.clientIp && \"client_ip\" in clone) {\n    clone.client_ip = \"[redacted]\";\n  }\n  if (redaction.userAgent && \"user_agent\" in clone) {\n    clone.user_agent = \"[redacted]\";\n  }\n  if (redaction.cfRay && \"cf_ray\" in clone) {\n    clone.cf_ray = \"[redacted]\";\n  }\n  return clone;\n}\n\nexport function configureLogging(options: Partial<LoggingConfig>) {\n  if (options.level) loggingConfig.level = options.level;\n  if (typeof options.debugSampleRate === \"number\" && options.debugSampleRate > 0) {\n    loggingConfig.debugSampleRate = Math.min(options.debugSampleRate, 1);\n  }\n  if (options.redaction) {\n    loggingConfig.redaction = {\n      ...loggingConfig.redaction,\n      ...options.redaction,\n    };\n  }\n}\n\nfunction parseLogLevel(candidate: string | undefined): LogLevel | null {\n  if (!candidate) return null;\n  const normalized = candidate.trim().toLowerCase();\n  if (normalized === \"debug\" || normalized === \"info\" || normalized === \"warn\" || normalized === \"error\") {\n    return normalized;\n  }\n  return null;\n}\n\nfunction parseSampleRate(raw: string | undefined): number | null {\n  if (!raw) return null;\n  const parsed = Number(raw);\n  if (!Number.isFinite(parsed)) return null;\n  if (parsed <= 0) return null;\n  return parsed > 1 ? 1 : parsed;\n}\n\nexport function configureLoggingFromEnv(env: Env) {\n  if (configuredFromEnv) return;\n  configuredFromEnv = true;\n  const level = parseLogLevel(env.LOG_LEVEL);\n  const sampleRate = parseSampleRate(env.LOG_DEBUG_SAMPLE_RATE);\n  configureLogging({\n    level: level ?? loggingConfig.level,\n    debugSampleRate: sampleRate ?? loggingConfig.debugSampleRate,\n    redaction: {\n      clientIp: flagEnabled(env.LOG_REDACT_CLIENT_IP),\n      userAgent: flagEnabled(env.LOG_REDACT_USER_AGENT),\n      cfRay: flagEnabled(env.LOG_REDACT_CF_RAY),\n    },\n  });\n}\n\n/** @internal Use only in tests to reset logging configuration */\nexport function __resetLoggingConfigForTests() {\n  loggingConfig = {\n    level: \"debug\",\n    debugSampleRate: 1,\n    redaction: DEFAULT_REDACTION,\n  };\n  configuredFromEnv = false;\n}\n\nfunction flagEnabled(value: unknown): boolean {\n  if (typeof value !== \"string\") return false;\n  const normalized = value.trim().toLowerCase();\n  if (!normalized) return false;\n  return normalized === \"true\" || normalized === \"1\" || normalized === \"yes\" || normalized === \"on\";\n}\n", "import { createRemoteJWKSet, decodeJwt, jwtVerify, JWTPayload } from \"jose\";\nimport { deriveUserFromClaims, landingFor } from \"../rbac\";\nimport type { Env, User } from \"../env\";\nimport { loggerForRequest } from \"../utils/logging\";\n\r\nconst jwksCache = new Map<string, ReturnType<typeof createRemoteJWKSet>>();\nconst devUserCache = new WeakMap<\n  Env,\n  { rawUser: string | null; rawFlag: string | null; user: User | null }\n>();\nconst requestUserCache = new WeakMap<Request, User | null>();\nconst DISABLED_TOKENS = new Set([\"0\", \"false\", \"off\", \"no\"]);\nconst ENABLED_TOKENS = new Set([\"1\", \"true\", \"on\", \"yes\"]);\nconst ALLOWED_ROLES: ReadonlyArray<User[\"roles\"][number]> = [\"admin\", \"client\", \"contractor\"];\nconst DEV_SHIM_ENVIRONMENTS = new Set([\"development\", \"dev\", \"local\"]);\n\nfunction cacheRequestUser(req: Request, user: User | null) {\n  requestUserCache.set(req, user);\n}\n\nfunction getCachedRequestUser(req: Request): User | null | undefined {\n  return requestUserCache.get(req);\n}\n\r\nexport function getJwks(env: Env) {\r\n  const url = env.ACCESS_JWKS_URL;\r\n  if (!jwksCache.has(url)) {\r\n    jwksCache.set(url, createRemoteJWKSet(new URL(url)));\r\n  }\r\n  return jwksCache.get(url)!;\r\n}\r\n\r\nfunction resolveDevUser(env: Env): User | null {\r\n  const rawValue = typeof env.DEV_ALLOW_USER === \"string\" ? env.DEV_ALLOW_USER : null;\r\n  const rawFlag = typeof env.ALLOW_DEV_ACCESS_SHIM === \"string\" ? env.ALLOW_DEV_ACCESS_SHIM : null;\r\n  const cached = devUserCache.get(env);\r\n  if (cached && cached.rawUser === rawValue && cached.rawFlag === rawFlag) {\r\n    return cached.user;\r\n  }\r\n\r\n  const normalizedFlag = rawFlag?.trim().toLowerCase() ?? \"\";\r\n  if (!normalizedFlag || DISABLED_TOKENS.has(normalizedFlag) || !ENABLED_TOKENS.has(normalizedFlag)) {\r\n    devUserCache.set(env, { rawUser: rawValue, rawFlag, user: null });\r\n    return null;\r\n  }\r\n\r\n  if (!rawValue) {\r\n    devUserCache.set(env, { rawUser: null, rawFlag, user: null });\r\n    return null;\r\n  }\r\n\r\n  const trimmed = rawValue.trim();\r\n  if (!trimmed || DISABLED_TOKENS.has(trimmed.toLowerCase())) {\r\n    devUserCache.set(env, { rawUser: rawValue, rawFlag, user: null });\r\n    return null;\r\n  }\r\n\r\n  let parsed: unknown = trimmed;\r\n  try {\r\n    parsed = JSON.parse(trimmed);\r\n  } catch {\r\n    // treat the raw string as an email below\r\n  }\r\n\r\n  let email = \"dev@example.com\";\r\n  let roles: User[\"roles\"] = [\"admin\"];\r\n  let clientIds: string[] = [];\r\n\r\n  if (typeof parsed === \"string\") {\r\n    const candidate = parsed.trim();\r\n    if (candidate) {\r\n      email = candidate;\r\n    }\r\n  } else if (parsed && typeof parsed === \"object\") {\r\n    const candidateEmail = (parsed as { email?: unknown }).email;\r\n    if (typeof candidateEmail === \"string\" && candidateEmail.trim()) {\r\n      email = candidateEmail.trim();\r\n    }\r\n\r\n    const candidateRoles = (parsed as { roles?: unknown }).roles;\r\n    if (Array.isArray(candidateRoles)) {\r\n      const normalized = candidateRoles\r\n        .map((role) => (typeof role === \"string\" ? role.trim().toLowerCase() : \"\"))\r\n        .filter((role) => role.length > 0);\r\n      const filtered = normalized\r\n        .map((role) => ALLOWED_ROLES.find((allowed) => allowed === role))\r\n        .filter((role): role is User[\"roles\"][number] => Boolean(role));\r\n      if (filtered.length > 0) {\r\n        roles = Array.from(new Set(filtered));\r\n      }\r\n    }\r\n\r\n    const candidateClientIds = (parsed as { clientIds?: unknown }).clientIds;\r\n    if (Array.isArray(candidateClientIds)) {\r\n      const normalized = candidateClientIds\r\n        .map((id) => (typeof id === \"string\" ? id.trim() : \"\"))\r\n        .filter((id) => id.length > 0);\r\n      if (normalized.length > 0) {\r\n        clientIds = Array.from(new Set(normalized));\r\n      }\r\n    }\r\n  } else {\r\n    const candidate = String(parsed).trim();\r\n    if (candidate) {\r\n      email = candidate;\r\n    }\r\n  }\r\n\r\n  const user: User = { email, roles, clientIds };\r\n  devUserCache.set(env, { rawUser: rawValue, rawFlag, user });\r\n  return user;\r\n}\r\n\r\nexport async function requireAccessUser(req: Request, env: Env): Promise<User | null> {\n  const cached = getCachedRequestUser(req);\n  if (cached !== undefined) {\n    return cached;\n  }\n\n  const jwt = req.headers.get(\"Cf-Access-Jwt-Assertion\");\n  if (jwt) {\n    try {\n      const { payload } = await jwtVerify(jwt, getJwks(env), { audience: env.ACCESS_AUD });\n      const user = deriveUserFromClaims(payload as JWTPayload);\n      cacheRequestUser(req, user);\n      return user;\n    } catch (error) {\n      const log = loggerForRequest(req, { scope: \"access\" });\n      const decoded = safeDecodeJwt(jwt);\n      const reason = error instanceof Error ? error.message : String(error);\n      const headerEmail = req.headers.get(\"Cf-Access-Authenticated-User-Email\");\n      const payloadEmail =\n        typeof decoded?.email === \"string\" ? decoded.email :\n        typeof decoded?.sub === \"string\" ? decoded.sub :\n        undefined;\n      const sanitizedEmail = sanitizeEmailForLog(headerEmail ?? payloadEmail);\n      const cfRay = req.headers.get(\"cf-ray\");\n      const logFields: Record<string, unknown> = {\n        reason,\n        audience: env.ACCESS_AUD,\n        cf_ray: cfRay ?? undefined,\n        metric: \"greenbro.security.jwt_verify_failed\",\n        metric_key: \"security.jwt_verify_failed\",\n        count: 1,\n      };\n      const tokenAudience = normalizeAudience(decoded?.aud);\n      if (tokenAudience) {\n        logFields.token_audience = tokenAudience;\n      }\n      if (sanitizedEmail) {\n        logFields.sanitized_email = sanitizedEmail;\n      }\n      log.warn(\"access.jwt_verify_failed\", logFields);\n    }\n  }\n\n  const environment =\n    typeof env.ENVIRONMENT === \"string\" ? env.ENVIRONMENT.trim().toLowerCase() : \"\";\n  const environmentAllowsShim = environment.length > 0 && DEV_SHIM_ENVIRONMENTS.has(environment);\n  const hasShimFlag =\n    typeof env.ALLOW_DEV_ACCESS_SHIM === \"string\" &&\n    env.ALLOW_DEV_ACCESS_SHIM.trim().length > 0 &&\n    ENABLED_TOKENS.has(env.ALLOW_DEV_ACCESS_SHIM.trim().toLowerCase());\n\n  if (hasShimFlag && !environmentAllowsShim) {\n    loggerForRequest(req, { scope: \"access\" }).warn(\"access.dev_shim_blocked\", {\n      environment: environment || null,\n    });\n    cacheRequestUser(req, null);\n    return null;\n  }\n\n  if (!environmentAllowsShim) {\n    cacheRequestUser(req, null);\n    return null;\n  }\n\n  const devUser = resolveDevUser(env);\n  if (devUser) {\n    loggerForRequest(req, { scope: \"access\" }).info(\"access.dev_shim_used\", {\n      email: devUser.email,\n      environment,\n    });\n    cacheRequestUser(req, devUser);\n    return devUser;\n  }\n\n  cacheRequestUser(req, null);\n  return null;\n}\n\r\nexport function userIsAdmin(user: User) {\n  return user.roles?.includes(\"admin\") ?? false;\n}\n\nexport { landingFor };\n\nfunction safeDecodeJwt(token: string): JWTPayload | null {\n  try {\n    return decodeJwt(token);\n  } catch {\n    return null;\n  }\n}\n\nfunction normalizeAudience(aud: JWTPayload[\"aud\"]): string | undefined {\n  if (!aud) return undefined;\n  if (typeof aud === \"string\") return aud;\n  if (Array.isArray(aud)) return aud.join(\",\");\n  return undefined;\n}\n\nfunction sanitizeEmailForLog(candidate: unknown): string | undefined {\n  if (typeof candidate !== \"string\") return undefined;\n  const trimmed = candidate.trim().toLowerCase();\n  if (!trimmed) return undefined;\n  const parts = trimmed.split(\"@\");\n  if (parts.length !== 2) return undefined;\n  const [localPartRaw, domainRaw] = parts;\n  const domain = domainRaw.trim();\n  if (!domain) return undefined;\n  const localPart = localPartRaw.trim();\n  if (!localPart) return `*@${domain}`;\n  if (localPart.length === 1) return `*@${domain}`;\n  if (localPart.length === 2) return `${localPart[0]}*@${domain}`;\n  return `${localPart[0]}***${localPart.slice(-1)}@${domain}`;\n}\n", "import type { Env } from \"../env\";\nimport { json, withSecurityHeaders } from \"../utils/responses\";\n\nconst ALLOW_METHODS = \"GET,POST,OPTIONS\";\nconst ALLOW_HEADERS =\n  \"content-type,cf-access-jwt-assertion,x-greenbro-device-key,x-greenbro-signature,x-greenbro-timestamp\";\n\nexport const CORS_BASE: Record<string, string> = {\n  \"access-control-allow-origin\": \"*\",\n  \"access-control-allow-methods\": ALLOW_METHODS,\n  \"access-control-allow-headers\": ALLOW_HEADERS,\n};\n\nexport interface CorsEvaluation {\n  allowed: boolean;\n  origin: string | null;\n  allowOrigin: string | null;\n}\n\nfunction appendVary(headers: Headers, value: string) {\n  const existing = headers.get(\"vary\");\n  if (!existing) {\n    headers.set(\"vary\", value);\n    return;\n  }\n  const parts = existing\n    .split(\",\")\n    .map((token) => token.trim())\n    .filter(Boolean);\n  if (!parts.some((token) => token.toLowerCase() === value.toLowerCase())) {\n    parts.push(value);\n    headers.set(\"vary\", parts.join(\", \"));\n  }\n}\n\nfunction parseAllowedOrigins(env: Env): { origins: string[]; configured: boolean } {\n  const raw = env.INGEST_ALLOWED_ORIGINS;\n  if (typeof raw !== \"string\") {\n    return { origins: [], configured: false };\n  }\n  const origins = raw\n    .split(/[, \\n\\r]+/)\n    .map((entry) => entry.trim())\n    .filter(Boolean);\n  return { origins, configured: origins.length > 0 };\n}\n\nfunction matchesOrigin(origin: string, rule: string) {\n  if (rule === \"*\") return true;\n  const normOrigin = origin.toLowerCase();\n  const normRule = rule.toLowerCase();\n  if (normRule.startsWith(\"*.\")) {\n    const suffix = normRule.slice(1);\n    return normOrigin.endsWith(suffix);\n  }\n  return normOrigin === normRule;\n}\n\nexport function evaluateCors(req: Request, env: Env): CorsEvaluation {\n  const origin = req.headers.get(\"Origin\");\n  const { origins: allowedOrigins, configured } = parseAllowedOrigins(env);\n  if (!configured) {\n    return { allowed: false, origin: origin ?? null, allowOrigin: null };\n  }\n  if (!origin) {\n    const allowAny = allowedOrigins.includes(\"*\");\n    return {\n      allowed: true,\n      origin: null,\n      allowOrigin: allowAny ? \"*\" : null,\n    };\n  }\n\n  for (const candidate of allowedOrigins) {\n    if (matchesOrigin(origin, candidate)) {\n      const allowOrigin = candidate === \"*\" ? \"*\" : origin;\n      return { allowed: true, origin, allowOrigin };\n    }\n  }\n\n  return { allowed: false, origin, allowOrigin: null };\n}\n\nexport function withCors(\n  req: Request,\n  env: Env,\n  res: Response,\n  evaluation?: CorsEvaluation,\n) {\n  const result = evaluation ?? evaluateCors(req, env);\n  const headers = new Headers(res.headers);\n  if (result.allowOrigin) {\n    headers.set(\"access-control-allow-origin\", result.allowOrigin);\n  } else {\n    headers.delete(\"access-control-allow-origin\");\n  }\n  headers.set(\"access-control-allow-methods\", ALLOW_METHODS);\n  headers.set(\"access-control-allow-headers\", ALLOW_HEADERS);\n  appendVary(headers, \"Origin\");\n  return new Response(res.body, {\n    headers,\n    status: res.status,\n    statusText: res.statusText,\n  });\n}\n\nexport function maybeHandlePreflight(req: Request, pathname: string, env: Env) {\n  if (req.method !== \"OPTIONS\") return null;\n\n  if (\n    pathname.startsWith(\"/api/ingest/\") ||\n    pathname.startsWith(\"/api/heartbeat/\") ||\n    /^\\/api\\/devices\\/[^/]+\\/latest$/.test(pathname)\n  ) {\n    const evaluation = evaluateCors(req, env);\n    if (!evaluation.allowed) {\n      return withCors(\n        req,\n        env,\n        json({ error: \"Origin not allowed\" }, { status: 403 }),\n        evaluation,\n      );\n    }\n    const headers = new Headers({\n      \"access-control-allow-methods\": ALLOW_METHODS,\n      \"access-control-allow-headers\": ALLOW_HEADERS,\n      \"access-control-max-age\": \"600\",\n    });\n    appendVary(headers, \"Origin\");\n    if (evaluation.allowOrigin) {\n      headers.set(\"access-control-allow-origin\", evaluation.allowOrigin);\n    }\n    return withSecurityHeaders(new Response(\"\", { status: 204, headers }));\n  }\n  return null;\n}\n", "const e=({base:e=\"\",routes:t=[],...r}={})=>({__proto__:new Proxy({},{get:(r,o,a,s)=>(r,...c)=>t.push([o.toUpperCase(),RegExp(`^${(s=(e+r).replace(/\\/+(\\/|$)/g,\"$1\")).replace(/(\\/?\\.?):(\\w+)\\+/g,\"($1(?<$2>*))\").replace(/(\\/?\\.?):(\\w+)/g,\"($1(?<$2>[^$1/]+?))\").replace(/\\./g,\"\\\\.\").replace(/(\\/?)\\*/g,\"($1.*)?\")}/*$`),c,s])&&a}),routes:t,...r,async fetch(e,...r){let o,a,s=new URL(e.url),c=e.query={__proto__:null};for(let[e,t]of s.searchParams)c[e]=c[e]?[].concat(c[e],t):t;for(let[c,n,l,i]of t)if((c==e.method||\"ALL\"==c)&&(a=s.pathname.match(n))){e.params=a.groups||{},e.route=i;for(let t of l)if(null!=(o=await t(e.proxy??e,...r)))return o}}}),t=({base:e=\"\",routes:t=[],...r}={})=>({__proto__:new Proxy({},{get:(r,o,a,s)=>(r,...c)=>t.push([o.toUpperCase?.(),RegExp(`^${(s=(e+r).replace(/\\/+(\\/|$)/g,\"$1\")).replace(/(\\/?\\.?):(\\w+)\\+/g,\"($1(?<$2>*))\").replace(/(\\/?\\.?):(\\w+)/g,\"($1(?<$2>[^$1/]+?))\").replace(/\\./g,\"\\\\.\").replace(/(\\/?)\\*/g,\"($1.*)?\")}/*$`),c,s])&&a}),routes:t,...r,async fetch(e,...o){let a,s,c=new URL(e.url),n=e.query={__proto__:null};for(let[e,t]of c.searchParams)n[e]=n[e]?[].concat(n[e],t):t;e:try{for(let t of r.before||[])if(null!=(a=await t(e.proxy??e,...o)))break e;t:for(let[r,n,l,i]of t)if((r==e.method||\"ALL\"==r)&&(s=c.pathname.match(n))){e.params=s.groups||{},e.route=i;for(let t of l)if(null!=(a=await t(e.proxy??e,...o)))break t}}catch(t){if(!r.catch)throw t;a=await r.catch(t,e.proxy??e,...o)}try{for(let t of r.finally||[])a=await t(a,e.proxy??e,...o)??a}catch(t){if(!r.catch)throw t;a=await r.catch(t,e.proxy??e,...o)}return a}}),r=(e=\"text/plain; charset=utf-8\",t)=>(r,o={})=>{if(void 0===r||r instanceof Response)return r;const a=new Response(t?.(r)??r,o.url?void 0:o);return a.headers.set(\"content-type\",e),a},o=r(\"application/json; charset=utf-8\",JSON.stringify),a=e=>({400:\"Bad Request\",401:\"Unauthorized\",403:\"Forbidden\",404:\"Not Found\",500:\"Internal Server Error\"}[e]||\"Unknown Error\"),s=(e=500,t)=>{if(e instanceof Error){const{message:r,...o}=e;e=e.status||500,t={error:r||a(e),...o}}return t={status:e,...\"object\"==typeof t?t:{error:t||a(e)}},o(t,{status:e})},c=e=>{e.proxy=new Proxy(e.proxy??e,{get:(t,r)=>t[r]?.bind?.(e)??t[r]??t?.params?.[r]})},n=({format:e=o,missing:r=(()=>s(404)),finally:a=[],before:n=[],...l}={})=>t({before:[c,...n],catch:s,finally:[(e,...t)=>e??r(...t),e,...a],...l});class l extends Error{status;constructor(e=500,t){super(\"object\"==typeof t?t.error:t),\"object\"==typeof t&&Object.assign(this,t),this.status=e}}const i=(e,t)=>new Response(null,{...t,status:e}),p=r(\"text/plain; charset=utf-8\",String),f=r(\"text/html\"),u=r(\"image/jpeg\"),h=r(\"image/png\"),g=r(\"image/webp\"),d=async e=>{e.content=e.body?await e.clone().json().catch((()=>e.clone().formData())).catch((()=>e.text())):void 0},w=e=>{e.cookies=(e.headers.get(\"Cookie\")||\"\").split(/;\\s*/).map((e=>e.split(/=(.+)/))).reduce(((e,[t,r])=>r?(e[t]=r,e):e),{})},y=(e={})=>{const{origin:t=\"*\",credentials:r=!1,allowMethods:o=\"*\",allowHeaders:a,exposeHeaders:s,maxAge:c}=e,n=e=>{const o=e?.headers.get(\"origin\");return!0===t?o:t instanceof RegExp?t.test(o)?o:void 0:Array.isArray(t)?t.includes(o)?o:void 0:t instanceof Function?t(o):\"*\"==t&&r?o:t},l=(e,t)=>{for(const[r,o]of Object.entries(t))o&&e.headers.append(r,o);return e};return{corsify:(e,t)=>e?.headers?.get(\"access-control-allow-origin\")||101==e.status?e:l(e.clone(),{\"access-control-allow-origin\":n(t),\"access-control-allow-credentials\":r}),preflight:e=>{if(\"OPTIONS\"==e.method){const t=new Response(null,{status:204});return l(t,{\"access-control-allow-origin\":n(e),\"access-control-allow-methods\":o?.join?.(\",\")??o,\"access-control-expose-headers\":s?.join?.(\",\")??s,\"access-control-allow-headers\":a?.join?.(\",\")??a??e.headers.get(\"access-control-request-headers\"),\"access-control-max-age\":c,\"access-control-allow-credentials\":r})}}}};export{n as AutoRouter,e as IttyRouter,t as Router,l as StatusError,y as cors,r as createResponse,s as error,f as html,u as jpeg,o as json,h as png,i as status,p as text,g as webp,d as withContent,w as withCookies,c as withParams};\n", "\uFEFFexport async function sha256Hex(input: string) {\n  const data = new TextEncoder().encode(input);\n  const digest = await crypto.subtle.digest(\"SHA-256\", data);\n  return [...new Uint8Array(digest)].map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n}\n\nexport function hexToBytes(hex: string) {\n  const normalized = hex.replace(/\\s+/g, \"\").toLowerCase();\n  if (normalized.length % 2 !== 0) {\n    throw new Error(\"Hex string must have an even length\");\n  }\n  const bytes = new Uint8Array(normalized.length / 2);\n  for (let i = 0; i < normalized.length; i += 2) {\n    const byte = Number.parseInt(normalized.slice(i, i + 2), 16);\n    if (Number.isNaN(byte)) {\n      throw new Error(\"Invalid hex string\");\n    }\n    bytes[i / 2] = byte;\n  }\n  return bytes;\n}\n\nexport function bytesToHex(bytes: Uint8Array) {\n  return [...bytes].map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\n}\n\nexport async function hmacSha256Hex(keyHex: string, payload: string) {\n  const keyBytes = hexToBytes(keyHex);\n  const cryptoKey = await crypto.subtle.importKey(\n    \"raw\",\n    keyBytes,\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\"],\n  );\n  const data = new TextEncoder().encode(payload);\n  const signature = await crypto.subtle.sign(\"HMAC\", cryptoKey, data);\n  return bytesToHex(new Uint8Array(signature));\n}\n\nexport function timingSafeEqual(a: string, b: string) {\n  const len = Math.max(a.length, b.length);\n  let mismatch = a.length === b.length ? 0 : 1;\n  for (let i = 0; i < len; i++) {\n    const ca = i < a.length ? a.charCodeAt(i) : 0;\n    const cb = i < b.length ? b.charCodeAt(i) : 0;\n    mismatch |= ca ^ cb;\n  }\n  return mismatch === 0;\n}\n\nexport function round(n: unknown, dp: number) {\n  if (typeof n !== \"number\" || Number.isNaN(n)) return null;\n  const f = Math.pow(10, dp);\n  return Math.round(n * f) / f;\n}\n\nexport function nowISO() {\n  return new Date().toISOString();\n}\n\nexport function maskId(id: string | null | undefined) {\n  if (!id) return \"\";\n  if (id.length <= 4) return \"***\";\n  return id.slice(0, 3) + \"***\" + id.slice(-2);\n}\n\nexport function parseAndCheckTs(ts: string) {\n  const ms = Date.parse(ts);\n  if (Number.isNaN(ms)) return { ok: false as const, reason: \"Invalid timestamp\" };\n  const now = Date.now();\n  const ahead = 5 * 60 * 1000; // +5 min\n  const behind = 365 * 24 * 60 * 60 * 1000; // ~1 year\n  if (ms > now + ahead) return { ok: false as const, reason: \"Timestamp too far in future\" };\n  if (ms < now - behind) return { ok: false as const, reason: \"Timestamp too old\" };\n  return { ok: true as const, ms };\n}\n\nexport function chunk<T>(arr: T[], size: number): T[][] {\n  const out: T[][] = [];\n  for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));\n  return out;\n}\n\nexport function safeDecode(part: string | null): string | null {\n  if (!part) return null;\n  try {\n    return decodeURIComponent(part);\n  } catch {\n    return null;\n  }\n}\n\nexport function base64UrlEncode(data: Uint8Array) {\n  let binary = \"\";\n  for (const byte of data) binary += String.fromCharCode(byte);\n  return btoa(binary).replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=+$/g, \"\");\n}\n\nexport function base64UrlDecode(input: string): Uint8Array | null {\n  try {\n    let normalized = input.replace(/-/g, \"+\").replace(/_/g, \"/\");\n    while (normalized.length % 4) normalized += \"=\";\n    const binary = atob(normalized);\n    const out = new Uint8Array(binary.length);\n    for (let i = 0; i < binary.length; i++) out[i] = binary.charCodeAt(i);\n    return out;\n  } catch {\n    return null;\n  }\n}\n\nexport function andWhere(where: string, clause: string) {\n  return where ? `${where} AND ${clause}` : `WHERE ${clause}`;\n}\n\nexport function parseFaultsJson(jsonStr: string | null | undefined): string[] {\n  if (!jsonStr) return [];\n  try {\n    const parsed = JSON.parse(jsonStr);\n    return Array.isArray(parsed) ? parsed.filter((f) => typeof f === \"string\") : [];\n  } catch {\n    return [];\n  }\n}\n\nexport function parseMetricsJson(jsonStr: string | null | undefined): Record<string, any> {\n  if (!jsonStr) return {};\n  try {\n    const parsed = JSON.parse(jsonStr);\n    return typeof parsed === \"object\" && parsed !== null ? (parsed as Record<string, any>) : {};\n  } catch {\n    return {};\n  }\n}\n\r\n", "import type { Env } from \"../env\";\r\nimport { base64UrlDecode, base64UrlEncode } from \"../utils\";\n\r\nconst cursorKeyCache = new Map<string, Promise<CryptoKey>>();\r\n\r\nfunction ensureCursorSecret(env: Env) {\r\n  const secret = env.CURSOR_SECRET;\r\n  if (!secret || secret.length < 16) {\r\n    throw new Error(\"CURSOR_SECRET must be configured (>= 16 characters)\");\r\n  }\r\n  return secret;\r\n}\r\n\r\nasync function importCursorKey(secret: string) {\r\n  if (!cursorKeyCache.has(secret)) {\r\n    const encoder = new TextEncoder();\r\n    const secretHash = await crypto.subtle.digest(\"SHA-256\", encoder.encode(secret));\r\n    const keyPromise = crypto.subtle.importKey(\r\n      \"raw\",\r\n      secretHash,\r\n      \"AES-GCM\",\r\n      false,\r\n      [\"encrypt\", \"decrypt\"],\r\n    );\r\n    cursorKeyCache.set(secret, keyPromise);\r\n  }\r\n  return cursorKeyCache.get(secret)!;\r\n}\r\n\r\nexport async function sealCursorId(env: Env, deviceId: string) {\r\n  const secret = ensureCursorSecret(env);\r\n  const key = await importCursorKey(secret);\r\n  const iv = crypto.getRandomValues(new Uint8Array(12));\r\n  const encoder = new TextEncoder();\r\n  const ciphertext = await crypto.subtle.encrypt(\r\n    { name: \"AES-GCM\", iv },\r\n    key,\r\n    encoder.encode(deviceId),\r\n  );\r\n  return `enc.${base64UrlEncode(iv)}.${base64UrlEncode(new Uint8Array(ciphertext))}`;\r\n}\r\n\r\nexport async function unsealCursorId(env: Env, token: string) {\r\n  const secret = ensureCursorSecret(env);\r\n  const key = await importCursorKey(secret);\r\n  const [, ivPart, dataPart] = token.split(\".\", 3);\r\n  if (!ivPart || !dataPart) return null;\r\n  const ivArray = base64UrlDecode(ivPart);\r\n  const payloadArray = base64UrlDecode(dataPart);\r\n  if (!ivArray || !payloadArray) return null;\r\n  const ivBuffer = new ArrayBuffer(ivArray.length);\r\n  new Uint8Array(ivBuffer).set(ivArray);\r\n  const payloadBuffer = new ArrayBuffer(payloadArray.length);\r\n  new Uint8Array(payloadBuffer).set(payloadArray);\r\n  try {\r\n    const plain = await crypto.subtle.decrypt({ name: \"AES-GCM\", iv: ivBuffer }, key, payloadBuffer);\r\n    return new TextDecoder().decode(plain);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function parseCursorId(\r\n  encoded: string | null,\r\n  env: Env,\r\n  isAdmin: boolean,\r\n): Promise<{ ok: true; id: string | null } | { ok: false }> {\r\n  if (!encoded) return { ok: true, id: null };\r\n  if (!encoded.startsWith(\"enc.\")) {\r\n    return isAdmin ? { ok: true, id: encoded } : { ok: false };\r\n  }\r\n  try {\r\n    const unsealed = await unsealCursorId(env, encoded);\r\n    if (!unsealed) return { ok: false };\r\n    return { ok: true, id: unsealed };\r\n  } catch {\r\n    return { ok: false };\r\n  }\r\n}\r\n", "import type { Env, User } from \"../env\";\r\nimport { parseCursorId, sealCursorId } from \"./cursor\";\nimport { maskId, parseFaultsJson, parseMetricsJson, sha256Hex } from \"../utils\";\nimport { userIsAdmin } from \"./access\";\r\n\r\nexport function buildDeviceScope(user: User, alias = \"d\") {\r\n  const isAdmin = userIsAdmin(user);\r\n  if (isAdmin) {\r\n    return { isAdmin: true, empty: false, clause: \"\", bind: [] as any[] };\r\n  }\r\n  const ids = user.clientIds || [];\r\n  if (!ids.length) {\r\n    return { isAdmin: false, empty: true, clause: \"\", bind: [] as any[] };\r\n  }\r\n  const placeholders = ids.map(() => \"?\").join(\",\");\r\n  return {\r\n    isAdmin: false,\r\n    empty: false,\r\n    clause: `${alias}.profile_id IN (${placeholders})`,\r\n    bind: [...ids],\r\n  };\r\n}\r\n\r\nexport function presentDeviceId(id: string, isAdmin: boolean) {\r\n  return isAdmin ? id : maskId(id);\r\n}\r\n\r\nexport async function resolveDeviceId(raw: string, env: Env, isAdmin: boolean): Promise<string | null> {\r\n  if (isAdmin) return raw;\r\n  if (!raw) return null;\r\n  const parsed = await parseCursorId(raw, env, isAdmin);\r\n  if (!parsed.ok || !parsed.id) return null;\r\n  return parsed.id;\r\n}\r\n\r\nexport async function buildDeviceLookup(id: string, env: Env, isAdmin: boolean) {\r\n  return isAdmin ? id : sealCursorId(env, id);\r\n}\r\n\r\nexport async function claimDeviceIfUnowned(env: Env, deviceId: string, profileId: string) {\r\n  await env.DB.prepare(\r\n    `UPDATE devices SET profile_id = ?2 WHERE device_id = ?1 AND profile_id IS NULL`\r\n  ).bind(deviceId, profileId).run();\r\n\r\n  const row = await env.DB\r\n    .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1`)\r\n    .bind(deviceId)\r\n    .first<{ profile_id?: string | null }>();\r\n\r\n  if (!row) return { ok: false as const, reason: \"unknown_device\" };\r\n  if (row.profile_id && row.profile_id !== profileId) {\r\n    return { ok: false as const, reason: \"claimed_by_other\", owner: row.profile_id };\r\n  }\r\n  return { ok: true as const };\r\n}\r\n\r\nexport interface DeviceKeyVerification {\n  ok: boolean;\n  deviceKeyHash?: string;\n  reason?:\n    | \"missing_key\"\n    | \"unknown_device\"\n    | \"missing_device_key\"\n    | \"mismatch\";\n}\n\nexport async function verifyDeviceKey(\n  env: Env,\n  deviceId: string,\n  keyHeader: string | null,\n): Promise<DeviceKeyVerification> {\n  if (!keyHeader) return { ok: false, reason: \"missing_key\" };\n  const row = await env.DB\n    .prepare(`SELECT device_key_hash FROM devices WHERE device_id = ?1`)\n    .bind(deviceId)\n    .first<{ device_key_hash?: string }>();\n  if (!row) return { ok: false, reason: \"unknown_device\" };\n  if (!row.device_key_hash) return { ok: false, reason: \"missing_device_key\" };\n  const hash = await sha256Hex(keyHeader);\n  if (hash.toLowerCase() !== String(row.device_key_hash).toLowerCase()) {\n    return { ok: false, reason: \"mismatch\" };\n  }\n  return { ok: true, deviceKeyHash: hash };\n}\n\nexport { parseFaultsJson, parseMetricsJson, userIsAdmin };\n\nexport interface DeviceMeta {\n  device_id: string;\n  profile_id: string | null;\n  site: string | null;\n}\n\nexport async function fetchDeviceMeta(env: Env, deviceIds: string[]): Promise<Map<string, DeviceMeta>> {\n  if (!deviceIds.length) return new Map();\n  const unique = [...new Set(deviceIds)];\n  const placeholders = unique.map((_, idx) => `?${idx + 1}`).join(\",\");\n  const rows = await env.DB\n    .prepare(\n      `SELECT device_id, profile_id, site\n         FROM devices\n        WHERE device_id IN (${placeholders})`,\n    )\n    .bind(...unique)\n    .all<DeviceMeta>();\n\n  const map = new Map<string, DeviceMeta>();\n  for (const row of rows.results ?? []) {\n    map.set(row.device_id, row);\n  }\n  return map;\n}\n", "import { z } from \"zod\";\n\nfunction coerceNumber(input: unknown) {\n  if (input === undefined || input === null) return undefined;\n  if (typeof input === \"number\") return input;\n  if (typeof input === \"string\") {\n    const trimmed = input.trim();\n    if (trimmed === \"\") return undefined;\n    const parsed = Number(trimmed);\n    return Number.isFinite(parsed) ? parsed : Number.NaN;\n  }\n  return Number.NaN;\n}\n\nexport function numericParam(options: {\n  min?: number;\n  max?: number;\n  integer?: boolean;\n  defaultValue?: number;\n}) {\n  let schema = z.number();\n  if (options.integer) schema = schema.int();\n  if (options.min !== undefined) schema = schema.min(options.min);\n  if (options.max !== undefined) schema = schema.max(options.max);\n\n  const withPreprocess = z.preprocess(coerceNumber, schema);\n  return options.defaultValue !== undefined\n    ? withPreprocess.default(options.defaultValue)\n    : withPreprocess.optional();\n}\n\nexport function optionalNumericParam(options: {\n  min?: number;\n  max?: number;\n  integer?: boolean;\n}) {\n  let schema = z.number();\n  if (options.integer) schema = schema.int();\n  if (options.min !== undefined) schema = schema.min(options.min);\n  if (options.max !== undefined) schema = schema.max(options.max);\n  return z.preprocess(coerceNumber, schema).optional();\n}\n\nexport function booleanFlagParam(defaultValue: boolean) {\n  return z\n    .preprocess((input: unknown) => {\n      if (input === undefined || input === null) return undefined;\n      if (typeof input === \"boolean\") return input;\n      if (typeof input === \"number\") return input !== 0;\n      if (typeof input === \"string\") {\n        const trimmed = input.trim().toLowerCase();\n        if (trimmed === \"\") return undefined;\n        if (trimmed === \"1\" || trimmed === \"true\" || trimmed === \"yes\") return true;\n        if (trimmed === \"0\" || trimmed === \"false\" || trimmed === \"no\") return false;\n      }\n      return input;\n    }, z.boolean())\n    .default(defaultValue);\n}\n\nexport const optionalBooleanFlag = z\n  .preprocess((input: unknown) => {\n    if (input === undefined || input === null) return undefined;\n    if (typeof input === \"boolean\") return input;\n    if (typeof input === \"number\") return input !== 0;\n    if (typeof input === \"string\") {\n      const trimmed = input.trim().toLowerCase();\n      if (trimmed === \"\") return undefined;\n      if (trimmed === \"1\" || trimmed === \"true\" || trimmed === \"yes\") return true;\n      if (trimmed === \"0\" || trimmed === \"false\" || trimmed === \"no\") return false;\n    }\n    return input;\n  }, z.boolean())\n  .optional();\n\nexport const optionalTrimmedString = z\n  .preprocess((input: unknown) => {\n    if (input === undefined || input === null) return undefined;\n    if (typeof input !== \"string\") return input;\n    const trimmed = input.trim();\n    return trimmed === \"\" ? undefined : trimmed;\n  }, z.string().min(1, \"Must not be empty\"))\n  .optional();\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const AdminOverviewQuerySchema = z\n  .object({\n    limit: numericParam({ integer: true, min: 1, max: 100, defaultValue: 40 }),\n  })\n  .strict();\n\nexport type AdminOverviewQuery = z.infer<typeof AdminOverviewQuerySchema>;\n", "import { z } from \"zod\";\r\nimport { json } from \"./responses\";\r\n\r\nexport type ValidationIssue = {\r\n  path: string;\r\n  message: string;\r\n};\r\n\r\nexport type SchemaParseResult<T> =\r\n  | { success: true; data: T }\r\n  | { success: false; issues: ValidationIssue[] };\r\n\r\nexport function fromZodError(error: z.ZodError): ValidationIssue[] {\r\n  return error.issues.map((issue: z.ZodIssue) => ({\r\n    path: issue.path.length ? issue.path.join(\".\") : \"root\",\r\n    message: issue.message,\r\n  }));\r\n}\r\n\r\nexport function validateWithSchema<T>(\r\n  schema: z.ZodType<T, z.ZodTypeDef, unknown> | undefined,\r\n  payload: unknown,\r\n): SchemaParseResult<T> {\r\n  if (!schema) {\r\n    return {\r\n      success: false,\r\n      issues: [{ path: \"root\", message: \"Validation unavailable\" }],\r\n    };\r\n  }\r\n\r\n  const parsed = schema.safeParse(payload);\r\n  if (parsed.success) {\r\n    return { success: true, data: parsed.data };\r\n  }\r\n  return { success: false, issues: fromZodError(parsed.error) };\r\n}\r\n\r\nexport function validationErrorResponse(\r\n  issues: ValidationIssue[] | z.ZodError,\r\n  init?: ResponseInit,\r\n): Response {\r\n  const details = issues instanceof z.ZodError ? fromZodError(issues) : issues;\r\n  return json(\r\n    {\r\n      error: \"Validation failed\",\r\n      details,\r\n    },\r\n    {\r\n      status: 400,\r\n      ...init,\r\n    },\r\n  );\r\n}\r\n", "import type { Env } from \"../env\";\nimport { nowISO } from \"../utils\";\nimport type { Logger } from \"../utils/logging\";\nimport { systemLogger } from \"../utils/logging\";\n\nconst DAY_MS = 86_400_000;\nexport const OPS_METRICS_WINDOW_DAYS = 30;\nexport const OPS_METRICS_WINDOW_MS = OPS_METRICS_WINDOW_DAYS * DAY_MS;\nconst OPS_METRICS_PRUNE_INTERVAL_MS = 15 * 60 * 1000;\n\nlet lastPruneAttemptMs = 0;\n\nexport function opsMetricsWindowStart(now = Date.now()): string {\n  const startMs = now - OPS_METRICS_WINDOW_MS;\n  return new Date(startMs).toISOString();\n}\n\nexport async function pruneOpsMetrics(env: Env, now = Date.now()): Promise<void> {\n  if (now - lastPruneAttemptMs < OPS_METRICS_PRUNE_INTERVAL_MS) {\n    return;\n  }\n  lastPruneAttemptMs = now;\n  const cutoff = opsMetricsWindowStart(now);\n  try {\n    await env.DB.prepare(\"DELETE FROM ops_metrics WHERE ts < ?1\").bind(cutoff).run();\n  } catch (error) {\n    systemLogger({ scope: \"ops_metrics\" }).warn(\"ops_metrics.prune_failed\", { cutoff, error });\n  }\n}\n\nexport async function recordOpsMetric(\n  env: Env,\n  route: string,\n  statusCode: number,\n  durationMs: number,\n  deviceId: string | null,\n  logger?: Logger,\n): Promise<void> {\n  try {\n    await env.DB.prepare(\n      `INSERT INTO ops_metrics (ts, route, status_code, duration_ms, device_id) VALUES (?1, ?2, ?3, ?4, ?5)`,\n    )\n      .bind(nowISO(), route, statusCode, durationMs, deviceId)\n      .run();\n  } catch (error) {\n    const bucketMs = Math.floor(Date.now() / 60_000) * 60_000;\n    const scopedLogger = logger ?? systemLogger({ route });\n    scopedLogger.error(\"ops_metrics.insert_failed\", {\n      route,\n      status_code: statusCode,\n      device_id: deviceId ?? undefined,\n      duration_ms: durationMs,\n      metric: \"greenbro.ops_metrics.insert_failed\",\n      metric_key: \"ops_metrics.insert_failed\",\n      count: 1,\n      bucket_minute: new Date(bucketMs).toISOString(),\n      error,\n    });\n  }\n}\n", "import type { Env, User } from \"../env\";\nimport { requireAccessUser, userIsAdmin } from \"../lib/access\";\nimport { buildDeviceLookup, buildDeviceScope, presentDeviceId } from \"../lib/device\";\nimport { json } from \"../utils/responses\";\nimport { andWhere, nowISO } from \"../utils\";\nimport { AdminOverviewQuerySchema } from \"../schemas/admin\";\nimport { validationErrorResponse } from \"../utils/validation\";\nimport { loggerForRequest } from \"../utils/logging\";\nimport {\n  OPS_METRICS_WINDOW_DAYS,\n  opsMetricsWindowStart,\n  pruneOpsMetrics,\n} from \"../lib/ops-metrics\";\n\nasync function buildOverviewResponse(\n  req: Request,\n  env: Env,\n  user: User,\n  routeTag: string,\n) {\n  const log = loggerForRequest(req, { route: routeTag });\n  const scope = buildDeviceScope(user);\n  const url = new URL(req.url);\n  const paramsResult = AdminOverviewQuerySchema.safeParse({\n    limit: url.searchParams.get(\"limit\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { limit } = paramsResult.data;\n\n  const now = Date.now();\n  const windowStart = opsMetricsWindowStart(now);\n  await pruneOpsMetrics(env, now);\n\n  let tenants;\n  if (scope.isAdmin) {\n    tenants = await env.DB\n      .prepare(\n        `SELECT COALESCE(d.profile_id, 'unassigned') AS profile_id,\n                COUNT(*) AS device_count,\r\n                SUM(d.online) AS online_count\r\n           FROM devices d\r\n          GROUP BY COALESCE(d.profile_id, 'unassigned')\r\n          ORDER BY device_count DESC`,\r\n      )\r\n      .all<{\r\n        profile_id: string;\r\n        device_count: number;\r\n        online_count: number | null;\r\n      }>();\r\n  } else if (scope.empty) {\r\n    tenants = { results: [] as any[] };\r\n  } else {\r\n    const where = andWhere(\"\", scope.clause);\r\n    tenants = await env.DB\r\n      .prepare(\r\n        `SELECT d.profile_id AS profile_id,\r\n                COUNT(*) AS device_count,\r\n                SUM(d.online) AS online_count\r\n           FROM devices d\r\n           ${where}\r\n          GROUP BY d.profile_id`,\r\n      )\r\n      .bind(...scope.bind)\r\n      .all<{\r\n        profile_id: string | null;\r\n        device_count: number;\r\n        online_count: number | null;\r\n      }>();\r\n  }\n\n  let opsRows;\n  if (scope.isAdmin) {\n    opsRows = await env.DB\n      .prepare(\n        `SELECT ts, route, status_code, duration_ms, device_id\n           FROM ops_metrics\n          WHERE ts >= ?\n          ORDER BY ts DESC\n          LIMIT ?`,\n      )\n      .bind(windowStart, limit)\n      .all<{\n        ts: string;\n        route: string;\n        status_code: number;\n        duration_ms: number;\n        device_id: string | null;\n      }>();\r\n  } else if (scope.empty) {\n    opsRows = { results: [] as any[] };\n  } else {\n    const tenantClause = scope.clause.replace(/\\bd\\./g, \"devices.\");\n    const where = andWhere(\"WHERE o.ts >= ?\", tenantClause);\n    opsRows = await env.DB\n      .prepare(\n        `SELECT o.ts, o.route, o.status_code, o.duration_ms, o.device_id\n           FROM ops_metrics o\n           JOIN devices ON devices.device_id = o.device_id\n           ${where}\n          ORDER BY o.ts DESC\n          LIMIT ?`,\n      )\n      .bind(windowStart, ...scope.bind, limit)\n      .all<{\n        ts: string;\n        route: string;\n        status_code: number;\n        duration_ms: number;\n        device_id: string | null;\r\n      }>();\r\n  }\r\n\r\n  const ops = [] as any[];\n  for (const row of opsRows.results ?? []) {\n    const deviceId = row.device_id;\n    let lookupToken: string | null = null;\n    let outwardId: string | null = null;\n    if (deviceId) {\n      outwardId = presentDeviceId(deviceId, scope.isAdmin);\n      try {\n        lookupToken = await buildDeviceLookup(deviceId, env, scope.isAdmin);\n      } catch (err) {\n        log.error(\"admin.lookup_failed\", { device_id: deviceId, error: err });\n        continue;\n      }\n    }\n\n    ops.push({\n      ts: row.ts,\n      route: row.route,\r\n      status_code: row.status_code,\r\n      duration_ms: row.duration_ms,\r\n      device_id: outwardId,\r\n      lookup: lookupToken,\n    });\n  }\n\n  const statusCounts = ops.reduce<Record<string, number>>((acc, item) => {\n    const bucket = item.status_code >= 500 ? \"5xx\" : item.status_code >= 400 ? \"4xx\" : \"ok\";\r\n    acc[bucket] = (acc[bucket] || 0) + 1;\r\n    return acc;\r\n  }, {});\r\n\n  return json({\n    generated_at: nowISO(),\n    scope: scope.isAdmin ? \"admin\" : scope.empty ? \"empty\" : \"tenant\",\n    tenants:\n      tenants.results?.map((row) => ({\n        profile_id: row.profile_id ?? \"unassigned\",\n        device_count: row.device_count ?? 0,\n        online_count: row.online_count ?? 0,\n      })) ?? [],\n    ops,\n    ops_summary: statusCounts,\n    ops_window: {\n      start: windowStart,\n      days: OPS_METRICS_WINDOW_DAYS,\n    },\n  });\n}\n\nexport async function handleAdminOverview(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n  if (!userIsAdmin(user)) return json({ error: \"Forbidden\" }, { status: 403 });\n  return buildOverviewResponse(req, env, user, \"/api/admin/overview\");\n}\n\nexport async function handleFleetAdminOverview(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n  return buildOverviewResponse(req, env, user, \"/api/fleet/admin-overview\");\n}\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const AuditTrailQuerySchema = z\n  .object({\n    entity_type: z.string().trim().min(1).optional(),\n    entity_id: z.string().trim().min(1).optional(),\n    actor_id: z.string().trim().min(1).optional(),\n    action: z.string().trim().min(1).optional(),\n    limit: numericParam({ integer: true, min: 1, max: 200, defaultValue: 100 }),\n    since: z.string().datetime({ offset: true }).optional(),\n    until: z.string().datetime({ offset: true }).optional(),\n  })\n  .strict();\n\nexport const CreateAuditEntrySchema = z\n  .object({\n    audit_id: z.string().trim().min(1).optional(),\n    actor_id: z.string().trim().min(1).optional(),\n    actor_email: z.string().trim().email().optional(),\n    actor_name: z.string().trim().min(1).optional(),\n    action: z.string().trim().min(1),\n    entity_type: z.string().trim().min(1).optional(),\n    entity_id: z.string().trim().min(1).optional(),\n    metadata: z.record(z.any()).optional(),\n    ip_address: z.string().trim().min(1).optional(),\n    created_at: z.string().datetime({ offset: true }).optional(),\n  })\n  .strict();\n\nexport type AuditTrailQuery = z.infer<typeof AuditTrailQuerySchema>;\nexport type CreateAuditEntryInput = z.infer<typeof CreateAuditEntrySchema>;\n", "import type { Env } from \"../env\";\nimport { andWhere, nowISO } from \"../utils\";\n\nexport interface AuditRecord {\n  audit_id: string;\n  actor_id: string;\n  actor_email: string | null;\n  actor_name: string | null;\n  action: string;\n  entity_type: string | null;\n  entity_id: string | null;\n  metadata: Record<string, unknown> | null;\n  ip_address: string | null;\n  created_at: string;\n}\n\nexport interface CreateAuditParams {\n  audit_id?: string;\n  actor_id: string;\n  actor_email?: string | null;\n  actor_name?: string | null;\n  action: string;\n  entity_type?: string | null;\n  entity_id?: string | null;\n  metadata?: Record<string, unknown> | null;\n  ip_address?: string | null;\n  created_at?: string;\n}\n\nexport type CreateAuditResult =\n  | { ok: true; audit: AuditRecord }\n  | { ok: false; reason: \"conflict\" };\n\nexport interface AuditListFilters {\n  entity_type?: string;\n  entity_id?: string;\n  actor_id?: string;\n  action?: string;\n  since?: string;\n  until?: string;\n  limit: number;\n}\n\ninterface AuditRow {\n  audit_id: string;\n  actor_id: string;\n  actor_email: string | null;\n  actor_name: string | null;\n  action: string;\n  entity_type: string | null;\n  entity_id: string | null;\n  metadata_json: string | null;\n  ip_address: string | null;\n  created_at: string;\n}\n\nfunction mapAuditRow(row: AuditRow): AuditRecord {\n  let metadata: Record<string, unknown> | null = null;\n  if (row.metadata_json) {\n    try {\n      const parsed = JSON.parse(row.metadata_json);\n      if (parsed && typeof parsed === \"object\") {\n        metadata = parsed as Record<string, unknown>;\n      }\n    } catch {\n      metadata = null;\n    }\n  }\n\n  return {\n    audit_id: row.audit_id,\n    actor_id: row.actor_id,\n    actor_email: row.actor_email,\n    actor_name: row.actor_name,\n    action: row.action,\n    entity_type: row.entity_type,\n    entity_id: row.entity_id,\n    metadata,\n    ip_address: row.ip_address,\n    created_at: row.created_at,\n  };\n}\n\nexport async function createAuditEntry(\n  env: Env,\n  params: CreateAuditParams,\n): Promise<CreateAuditResult> {\n  const id = params.audit_id ?? crypto.randomUUID();\n  const createdAt = params.created_at ?? nowISO();\n  const metadataJson = params.metadata ? JSON.stringify(params.metadata) : null;\n  const actorEmail = params.actor_email ?? null;\n  const actorName = params.actor_name ?? null;\n  const entityType = params.entity_type ?? null;\n  const entityId = params.entity_id ?? null;\n  const ipAddress = params.ip_address ?? null;\n\n  try {\n    await env.DB\n      .prepare(\n        `INSERT INTO audit_trail (\n            audit_id, actor_id, actor_email, actor_name, action,\n            entity_type, entity_id, metadata_json, ip_address, created_at\n          ) VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, ?10)`,\n      )\n      .bind(\n        id,\n        params.actor_id,\n        actorEmail,\n        actorName,\n        params.action,\n        entityType,\n        entityId,\n        metadataJson,\n        ipAddress,\n        createdAt,\n      )\n      .run();\n  } catch (err: any) {\n    const message = typeof err?.message === \"string\" ? err.message : String(err);\n    if (message.includes(\"UNIQUE constraint failed\")) {\n      return { ok: false, reason: \"conflict\" };\n    }\n    throw err;\n  }\n\n  const row = await env.DB\n    .prepare(`SELECT * FROM audit_trail WHERE audit_id = ?1 LIMIT 1`)\n    .bind(id)\n    .first<AuditRow>();\n\n  if (!row) {\n    return { ok: false, reason: \"conflict\" };\n  }\n\n  return { ok: true, audit: mapAuditRow(row) };\n}\n\nexport async function listAuditTrail(\n  env: Env,\n  filters: AuditListFilters,\n): Promise<AuditRecord[]> {\n  let where = \"\";\n  const bind: any[] = [];\n\n  if (filters.entity_type) {\n    where = andWhere(where, \"entity_type = ?\");\n    bind.push(filters.entity_type);\n  }\n\n  if (filters.entity_id) {\n    where = andWhere(where, \"entity_id = ?\");\n    bind.push(filters.entity_id);\n  }\n\n  if (filters.actor_id) {\n    where = andWhere(where, \"actor_id = ?\");\n    bind.push(filters.actor_id);\n  }\n\n  if (filters.action) {\n    where = andWhere(where, \"action = ?\");\n    bind.push(filters.action);\n  }\n\n  if (filters.since) {\n    where = andWhere(where, \"created_at >= ?\");\n    bind.push(filters.since);\n  }\n\n  if (filters.until) {\n    where = andWhere(where, \"created_at <= ?\");\n    bind.push(filters.until);\n  }\n\n  const sql = `SELECT * FROM audit_trail ${where} ORDER BY created_at DESC LIMIT ?`;\n  bind.push(filters.limit);\n\n  const rows = await env.DB.prepare(sql).bind(...bind).all<AuditRow>();\n  return (rows.results ?? []).map(mapAuditRow);\n}\n", "import type { Env } from \"../env\";\nimport { requireAccessUser, userIsAdmin } from \"../lib/access\";\nimport { json } from \"../utils/responses\";\nimport { nowISO } from \"../utils\";\nimport {\n  AuditTrailQuerySchema,\n  CreateAuditEntrySchema,\n  type AuditTrailQuery,\n  type CreateAuditEntryInput,\n} from \"../schemas/audit\";\nimport { validationErrorResponse, validateWithSchema } from \"../utils/validation\";\nimport { createAuditEntry, listAuditTrail } from \"../lib/audit-store\";\n\nexport async function handleListAuditTrail(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user || !userIsAdmin(user)) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  const url = new URL(req.url);\n  const paramsResult = validateWithSchema<AuditTrailQuery>(AuditTrailQuerySchema, {\n    entity_type: url.searchParams.get(\"entity_type\") ?? undefined,\n    entity_id: url.searchParams.get(\"entity_id\") ?? undefined,\n    actor_id: url.searchParams.get(\"actor_id\") ?? undefined,\n    action: url.searchParams.get(\"action\") ?? undefined,\n    limit: url.searchParams.get(\"limit\") ?? undefined,\n    since: url.searchParams.get(\"since\") ?? undefined,\n    until: url.searchParams.get(\"until\") ?? undefined,\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.issues);\n  }\n  const params = paramsResult.data;\n\n  if (params.since && params.until) {\n    const sinceMs = Date.parse(params.since);\n    const untilMs = Date.parse(params.until);\n    if (!Number.isNaN(sinceMs) && !Number.isNaN(untilMs) && untilMs < sinceMs) {\n      return json({ error: \"Invalid range\" }, { status: 400 });\n    }\n  }\n\n  const limit = params.limit ?? 100;\n\n  const entries = await listAuditTrail(env, {\n    entity_type: params.entity_type ?? undefined,\n    entity_id: params.entity_id ?? undefined,\n    actor_id: params.actor_id ?? undefined,\n    action: params.action ?? undefined,\n    since: params.since ?? undefined,\n    until: params.until ?? undefined,\n    limit,\n  });\n\n  return json({\n    generated_at: nowISO(),\n    entries,\n  });\n}\n\nexport async function handleCreateAuditEntry(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n  if (!userIsAdmin(user)) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  let payload: unknown;\n  try {\n    payload = await req.json();\n  } catch {\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\n  }\n\n  const parseResult = validateWithSchema<CreateAuditEntryInput>(CreateAuditEntrySchema, payload);\n  if (!parseResult.success) {\n    return validationErrorResponse(parseResult.issues);\n  }\n  const body = parseResult.data;\n\n  const expectedActorId = user.email;\n  const expectedActorEmail = user.email;\n\n  if (body.actor_id && body.actor_id !== expectedActorId) {\n    return json({ error: \"Actor identity mismatch\" }, { status: 400 });\n  }\n  if (body.actor_email && body.actor_email !== expectedActorEmail) {\n    return json({ error: \"Actor identity mismatch\" }, { status: 400 });\n  }\n\n  const ip =\n    body.ip_address ??\n    req.headers.get(\"cf-connecting-ip\") ??\n    req.headers.get(\"x-forwarded-for\") ??\n    null;\n\n  const result = await createAuditEntry(env, {\n    audit_id: body.audit_id,\n    actor_id: expectedActorId,\n    actor_email: expectedActorEmail,\n    actor_name: body.actor_name ?? null,\n    action: body.action,\n    entity_type: body.entity_type ?? null,\n    entity_id: body.entity_id ?? null,\n    metadata: body.metadata ?? null,\n    ip_address: ip,\n    created_at: body.created_at,\n  });\n\n  if (!result.ok) {\n    if (result.reason === \"conflict\") {\n      return json({ error: \"Audit entry already exists\" }, { status: 409 });\n    }\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\n  return json({ ok: true, audit: result.audit }, { status: 201 });\n}\n", "import { nowISO, round } from \"../utils\";\n\nexport type MetricsFormat = \"prom\" | \"json\";\n\nexport interface DerivationInput {\n  supplyC?: number | null;\n  returnC?: number | null;\n  flowLps?: number | null;\n  powerKW?: number | null;\n}\n\nexport interface DerivedMetrics {\n  deltaT: number | null;\n  thermalKW: number | null;\n  cop: number | null;\n  cop_quality: \"measured\" | null;\n}\n\nexport interface DeviceSummaryInput {\n  total: number | null | undefined;\n  online: number | null | undefined;\n}\n\nexport interface OpsMetricInput {\n  route: string | null;\n  status_code: number | null;\n  count: number | null;\n  total_duration_ms?: number | string | null;\n  avg_duration_ms?: number | string | null;\n  max_duration_ms?: number | string | null;\n}\n\nexport interface OpsMetricNormalized {\n  route: string;\n  status_code: number;\n  count: number;\n  total_duration_ms: number;\n  avg_duration_ms: number;\n  max_duration_ms: number;\n}\n\nconst WATER_DENSITY_KG_PER_L = 0.997;\nconst WATER_SPECIFIC_HEAT_KJ_PER_KG_C = 4.186;\nconst MIN_COP_POWER_KW = 0.05;\n\nexport const ALERT_THRESHOLDS = {\n  devices: {\n    offline_ratio: { warn: 0.2, critical: 0.35 },\n    heartbeat_gap_minutes: { warn: 5, critical: 10 },\n  },\n  ops: {\n    error_rate: { warn: 0.02, critical: 0.05 },\n    client_error_rate: { warn: 0.08, critical: 0.15 },\n    avg_duration_ms: { warn: 1500, critical: 3000 },\n  },\n  ingest: {\n    consecutive_failures: { warn: 3, critical: 5 },\n    rate_limit_per_device: { warn: 90, critical: 120 },\n  },\n} as const;\n\nfunction coerceNumber(value: unknown, fallback = 0): number {\n  if (typeof value === \"number\") return Number.isFinite(value) ? value : fallback;\n  if (typeof value === \"string\") {\n    const parsed = Number(value);\n    return Number.isFinite(parsed) ? parsed : fallback;\n  }\n  return fallback;\n}\n\nexport function pickMetricsFormat(explicit: string | null | undefined, acceptHeader: string | null | undefined): MetricsFormat {\n  if (explicit === \"json\" || explicit === \"prom\") return explicit;\n  if (typeof acceptHeader === \"string\" && acceptHeader.toLowerCase().includes(\"application/json\")) {\n    return \"json\";\n  }\n  return \"prom\";\n}\n\nexport function deriveDeltaT(supplyC: unknown, returnC: unknown): number | null {\n  if (typeof supplyC !== \"number\" || typeof returnC !== \"number\") return null;\n  return round(supplyC - returnC, 1);\n}\n\nexport function deriveThermalKW(deltaT: number | null, flowLps: unknown): number | null {\n  if (deltaT === null || typeof flowLps !== \"number\") return null;\n  return round(WATER_DENSITY_KG_PER_L * WATER_SPECIFIC_HEAT_KJ_PER_KG_C * flowLps * deltaT, 2);\n}\n\nexport function deriveCop(thermalKW: number | null, powerKW: unknown): { cop: number | null; quality: \"measured\" | null } {\n  if (thermalKW === null || typeof powerKW !== \"number\" || powerKW <= MIN_COP_POWER_KW) {\n    return { cop: null, quality: null };\n  }\n  return {\n    cop: round(thermalKW / powerKW, 2),\n    quality: \"measured\",\n  };\n}\n\nexport function deriveTelemetryMetrics(input: DerivationInput): DerivedMetrics {\n  const deltaT = deriveDeltaT(input.supplyC ?? null, input.returnC ?? null);\n  const thermalKW = deriveThermalKW(deltaT, input.flowLps ?? null);\n  const copInfo = deriveCop(thermalKW, input.powerKW ?? null);\n  return {\n    deltaT,\n    thermalKW,\n    cop: copInfo.cop,\n    cop_quality: copInfo.quality,\n  };\n}\n\nexport function maskTelemetryNumber(\n  value: unknown,\n  isAdmin: boolean,\n  tenantPrecision = 1,\n  adminPrecision?: number,\n): number | null {\n  if (typeof value !== \"number\" || Number.isNaN(value)) return null;\n  if (isAdmin) {\n    return typeof adminPrecision === \"number\" ? Number(value.toFixed(adminPrecision)) : value;\n  }\n  return Number(value.toFixed(tenantPrecision));\n}\n\nexport function normalizeDeviceSummary(stats: DeviceSummaryInput) {\n  const total = Number.isFinite(stats.total as number) ? (stats.total as number) : 0;\n  const online = Number.isFinite(stats.online as number) ? (stats.online as number) : 0;\n  const offline = Math.max(0, total - online);\n  return { total, online, offline };\n}\n\nexport function normalizeOpsMetrics(rows: OpsMetricInput[]): OpsMetricNormalized[] {\n  return rows.map((row) => {\n    const route = row.route ?? \"unknown\";\n    const statusCodeRaw =\n      typeof row.status_code === \"number\" ? row.status_code : coerceNumber(row.status_code);\n    const statusCode = Number.isFinite(statusCodeRaw) ? Math.trunc(statusCodeRaw) : 0;\n    const count = coerceNumber(row.count);\n    const totalDuration = coerceNumber(row.total_duration_ms);\n    const avgDuration =\n      count > 0 ? totalDuration / count : coerceNumber(row.avg_duration_ms);\n    const maxDuration = coerceNumber(row.max_duration_ms);\n\n    return {\n      route,\n      status_code: statusCode,\n      count,\n      total_duration_ms: totalDuration,\n      avg_duration_ms: avgDuration,\n      max_duration_ms: maxDuration,\n    };\n  });\n}\n\nexport function summarizeOpsMetrics(rows: OpsMetricNormalized[]) {\n  let total = 0;\n  let serverErrors = 0;\n  let clientErrors = 0;\n  let slow = 0;\n\n  const slowRoutes: Array<{\n    route: string;\n    status_code: number;\n    avg_duration_ms: number;\n    count: number;\n  }> = [];\n  const serverErrorRoutes: Array<{ route: string; status_code: number; count: number }> = [];\n\n  for (const row of rows) {\n    total += row.count;\n    if (row.status_code >= 500) {\n      serverErrors += row.count;\n      serverErrorRoutes.push({\n        route: row.route,\n        status_code: row.status_code,\n        count: row.count,\n      });\n    } else if (row.status_code >= 400) {\n      clientErrors += row.count;\n    }\n    if (row.avg_duration_ms >= ALERT_THRESHOLDS.ops.avg_duration_ms.warn) {\n      slow += row.count;\n      slowRoutes.push({\n        route: row.route,\n        status_code: row.status_code,\n        avg_duration_ms: Number(row.avg_duration_ms.toFixed(2)),\n        count: row.count,\n      });\n    }\n  }\n\n  slowRoutes.sort((a, b) => b.avg_duration_ms - a.avg_duration_ms);\n  serverErrorRoutes.sort((a, b) => b.count - a.count);\n\n  const totalRequests = total;\n  const denominator = totalRequests > 0 ? totalRequests : 1;\n\n  return {\n    total_requests: totalRequests,\n    server_error_rate: totalRequests > 0 ? Number((serverErrors / denominator).toFixed(4)) : 0,\n    client_error_rate: totalRequests > 0 ? Number((clientErrors / denominator).toFixed(4)) : 0,\n    slow_rate: totalRequests > 0 ? Number((slow / denominator).toFixed(4)) : 0,\n    slow_routes: slowRoutes.slice(0, 5),\n    top_server_error_routes: serverErrorRoutes.slice(0, 5),\n  };\n}\n\nexport function formatMetricsJson(\n  devices: DeviceSummaryInput,\n  opsRows: OpsMetricInput[],\n  generatedAt: string = nowISO(),\n) {\n  const summary = normalizeDeviceSummary(devices);\n  const ops = normalizeOpsMetrics(opsRows);\n  const opsSummary = summarizeOpsMetrics(ops);\n  const offlineRatio = summary.total > 0 ? summary.offline / summary.total : 0;\n\n  return {\n    devices: {\n      ...summary,\n      offline_ratio: Number(offlineRatio.toFixed(4)),\n    },\n    ops,\n    ops_summary: opsSummary,\n    thresholds: ALERT_THRESHOLDS,\n    generated_at: generatedAt,\n  };\n}\n\nexport function formatPromMetrics(\n  devices: DeviceSummaryInput,\n  opsRows: OpsMetricInput[],\n  timestampMs: number = Date.now(),\n) {\n  const summary = normalizeDeviceSummary(devices);\n  const ops = normalizeOpsMetrics(opsRows);\n  const opsSummary = summarizeOpsMetrics(ops);\n  const offlineRatio = summary.total > 0 ? summary.offline / summary.total : 0;\n  const lines: string[] = [\n    \"# HELP greenbro_devices_total Total registered devices\",\n    \"# TYPE greenbro_devices_total gauge\",\n    `greenbro_devices_total ${summary.total}`,\n    \"# HELP greenbro_devices_online_total Devices currently marked online\",\n    \"# TYPE greenbro_devices_online_total gauge\",\n    `greenbro_devices_online_total ${summary.online}`,\n    \"# HELP greenbro_devices_offline_total Devices currently marked offline\",\n    \"# TYPE greenbro_devices_offline_total gauge\",\n    `greenbro_devices_offline_total ${summary.offline}`,\n    \"# HELP greenbro_devices_offline_ratio Fraction of devices currently offline\",\n    \"# TYPE greenbro_devices_offline_ratio gauge\",\n    `greenbro_devices_offline_ratio ${offlineRatio}`,\n    \"# HELP greenbro_ops_requests_total Recorded API requests by route and status\",\n    \"# TYPE greenbro_ops_requests_total counter\",\n  ];\n\n  for (const row of ops) {\n    const routeLabel = row.route.replace(/\"/g, '\\\\\"');\n    lines.push(\n      `greenbro_ops_requests_total{route=\"${routeLabel}\",status=\"${row.status_code}\"} ${row.count}`,\n    );\n  }\n\n  lines.push(\n    \"# HELP greenbro_metrics_generated_at Timestamp metrics payload produced\",\n    \"# TYPE greenbro_metrics_generated_at gauge\",\n  );\n  lines.push(`greenbro_metrics_generated_at ${Math.floor(timestampMs / 1000)}`);\n  lines.push(\"# HELP greenbro_ops_requests_overall_total Total recorded API requests (all routes)\");\n  lines.push(\"# TYPE greenbro_ops_requests_overall_total counter\");\n  lines.push(`greenbro_ops_requests_overall_total ${opsSummary.total_requests}`);\n  lines.push(\"# HELP greenbro_ops_server_error_rate Share of requests returning 5xx\");\n  lines.push(\"# TYPE greenbro_ops_server_error_rate gauge\");\n  lines.push(`greenbro_ops_server_error_rate ${opsSummary.server_error_rate}`);\n  lines.push(\"# HELP greenbro_ops_client_error_rate Share of requests returning 4xx\");\n  lines.push(\"# TYPE greenbro_ops_client_error_rate gauge\");\n  lines.push(`greenbro_ops_client_error_rate ${opsSummary.client_error_rate}`);\n  lines.push(\"# HELP greenbro_ops_slow_rate Share of requests above avg latency threshold\");\n  lines.push(\"# TYPE greenbro_ops_slow_rate gauge\");\n  lines.push(`greenbro_ops_slow_rate ${opsSummary.slow_rate}`);\n\n  return lines.join(\"\\n\") + \"\\n\";\n}\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const OpsOverviewQuerySchema = z\n  .object({\n    limit: numericParam({ integer: true, min: 1, max: 200, defaultValue: 50 }),\n  })\n  .strict();\n\nexport type OpsOverviewQuery = z.infer<typeof OpsOverviewQuerySchema>;\n", "import type { Env } from \"../env\";\nimport { requireAccessUser } from \"../lib/access\";\nimport { buildDeviceLookup, presentDeviceId, userIsAdmin } from \"../lib/device\";\nimport { json } from \"../utils/responses\";\nimport { loggerForRequest } from \"../utils/logging\";\nimport { formatMetricsJson } from \"../telemetry\";\nimport { OpsOverviewQuerySchema } from \"../schemas/ops\";\nimport { validationErrorResponse } from \"../utils/validation\";\nimport {\n  OPS_METRICS_WINDOW_DAYS,\n  opsMetricsWindowStart,\n  pruneOpsMetrics,\n} from \"../lib/ops-metrics\";\n\nexport async function handleOpsOverview(req: Request, env: Env) {\n  const log = loggerForRequest(req, { route: \"/api/ops/overview\" });\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n  if (!userIsAdmin(user)) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  const url = new URL(req.url);\n  const paramsResult = OpsOverviewQuerySchema.safeParse({\n    limit: url.searchParams.get(\"limit\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { limit } = paramsResult.data;\n\n  const now = Date.now();\n  const windowStart = opsMetricsWindowStart(now);\n  await pruneOpsMetrics(env, now);\n\n  const deviceStats =\n    (await env.DB.prepare(\"SELECT COUNT(*) AS total, SUM(online) AS online FROM devices\").first<{\n      total: number | null;\n      online: number | null;\n    }>()) ?? null;\n\n  const opsRows =\n    (\n      await env.DB.prepare(\n        `SELECT route,\n                status_code,\n                COUNT(*) AS count,\n                SUM(duration_ms) AS total_duration_ms,\n                AVG(duration_ms) AS avg_duration_ms,\n                MAX(duration_ms) AS max_duration_ms\n           FROM ops_metrics\n          WHERE ts >= ?1\n          GROUP BY route, status_code\n          ORDER BY route ASC, status_code ASC`,\n      )\n        .bind(windowStart)\n        .all<{\n          route: string | null;\n          status_code: number | null;\n          count: number | null;\n          total_duration_ms: number | string | null;\n          avg_duration_ms: number | string | null;\n          max_duration_ms: number | string | null;\n        }>()\n    ).results ?? [];\n\n  const metrics = formatMetricsJson(deviceStats ?? { total: 0, online: 0 }, opsRows);\n\n  const recentRows =\n    (\n      await env.DB.prepare(\n        `SELECT ts, route, status_code, duration_ms, device_id\n           FROM ops_metrics\n          WHERE ts >= ?1\n          ORDER BY ts DESC\n          LIMIT ?2`,\n      )\n        .bind(windowStart, limit)\n        .all<{\n          ts: string;\n          route: string;\n          status_code: number;\n          duration_ms: number;\n          device_id: string | null;\n        }>()\n    ).results ?? [];\n\n  const recent = [] as Array<{\n    ts: string;\n    route: string;\n    status_code: number;\n    duration_ms: number;\n    device_id: string | null;\n    lookup: string | null;\n  }>;\n\n  for (const row of recentRows) {\n    let lookup: string | null = null;\n    let outwardId: string | null = null;\n    if (row.device_id) {\n      outwardId = presentDeviceId(row.device_id, true);\n      try {\n        lookup = await buildDeviceLookup(row.device_id, env, true);\n      } catch (error) {\n        log.error(\"ops.recent_lookup_failed\", { device_id: row.device_id, error });\n        lookup = null;\n      }\n    }\n    recent.push({\n      ts: row.ts,\n      route: row.route,\n      status_code: row.status_code,\n      duration_ms: row.duration_ms,\n      device_id: outwardId,\n      lookup,\n    });\n  }\n\n  return json({\n    generated_at: metrics.generated_at,\n    scope: \"admin\" as const,\n    devices: metrics.devices,\n   ops: metrics.ops,\n   ops_summary: metrics.ops_summary,\n   thresholds: metrics.thresholds?.ops ?? null,\n    ops_window: {\n      start: windowStart,\n      days: OPS_METRICS_WINDOW_DAYS,\n    },\n    recent,\n  });\n}\n", "import type { RouteHandler } from \"./params\";\nimport { requireAccessUser } from \"../lib/access\";\nimport { json } from \"../utils/responses\";\n\n/**\n * Ensures Cloudflare Access authentication has succeeded before invoking the route handler.\n * The authenticated user is cached on the request, so downstream calls to `requireAccessUser`\n * return instantly without re-validating the JWT.\n */\nexport function withAccess(handler: RouteHandler): RouteHandler {\n  return async (req, env, ctx) => {\n    const user = await requireAccessUser(req, env);\n    if (!user) {\n      return json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n    return handler(req, env, ctx);\n  };\n}\n\n", "import { handleAdminOverview } from \"../routes/admin\";\nimport { handleCreateAuditEntry, handleListAuditTrail } from \"../routes/audit\";\nimport { handleOpsOverview } from \"../routes/ops\";\nimport { withAccess } from \"./access\";\n\nimport type { AppRouter } from \"./params\";\n\nexport function registerAdminRoutes(router: AppRouter) {\n  router\n    .get(\"/api/admin/overview\", withAccess((req, env) => handleAdminOverview(req, env)))\n    .get(\"/api/ops/overview\", withAccess((req, env) => handleOpsOverview(req, env)))\n    .get(\"/api/audit/logs\", withAccess((req, env) => handleListAuditTrail(req, env)))\n    .post(\"/api/audit/logs\", withAccess((req, env) => handleCreateAuditEntry(req, env)));\n}\n", "import { z } from \"zod\";\nimport { numericParam, optionalBooleanFlag, optionalTrimmedString } from \"./params\";\n\nexport const ListDevicesQuerySchema = z\n  .object({\n    mine: optionalBooleanFlag,\n    limit: numericParam({ integer: true, min: 1, max: 100, defaultValue: 50 }),\n    cursor: optionalTrimmedString,\n  })\n  .strict();\n\nexport type ListDevicesQuery = z.infer<typeof ListDevicesQuerySchema>;\n\nexport const DeviceHistoryQuerySchema = z\n  .object({\n    limit: numericParam({ integer: true, min: 1, max: 500, defaultValue: 72 }),\n  })\n  .strict();\n\nexport type DeviceHistoryQuery = z.infer<typeof DeviceHistoryQuerySchema>;\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser } from \"../lib/access\";\r\nimport { parseCursorId, sealCursorId } from \"../lib/cursor\";\r\nimport {\r\n  buildDeviceLookup,\r\n  buildDeviceScope,\r\n  presentDeviceId,\r\n  resolveDeviceId,\r\n  userIsAdmin,\r\n} from \"../lib/device\";\r\nimport { json } from \"../utils/responses\";\nimport { parseMetricsJson, safeDecode } from \"../utils\";\nimport { DeviceHistoryQuerySchema, ListDevicesQuerySchema } from \"../schemas/devices\";\nimport { validationErrorResponse } from \"../utils/validation\";\nimport { loggerForRequest } from \"../utils/logging\";\n\r\nexport async function handleLatest(req: Request, env: Env, deviceId: string) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const isAdmin = userIsAdmin(user);\r\n  const resolvedId = await resolveDeviceId(deviceId, env, isAdmin);\r\n  if (!resolvedId) return json({ error: \"Not found\" }, { status: 404 });\r\n  let row: any | null;\r\n\r\n  if (isAdmin) {\r\n    row = await env.DB.prepare(`SELECT * FROM latest_state WHERE device_id = ?1 LIMIT 1`)\r\n      .bind(resolvedId)\r\n      .first();\r\n  } else {\r\n    if (!user.clientIds || user.clientIds.length === 0) {\r\n      return json({ error: \"Not found\" }, { status: 404 });\r\n    }\r\n    const placeholders = user.clientIds.map((_, i) => `?${i + 2}`).join(\",\");\r\n    row = await env.DB.prepare(\r\n      `SELECT ls.*\r\n         FROM latest_state ls\r\n         JOIN devices d ON d.device_id = ls.device_id\r\n        WHERE ls.device_id = ?1\r\n          AND d.profile_id IN (${placeholders})\r\n        LIMIT 1`,\r\n    )\r\n      .bind(resolvedId, ...user.clientIds)\r\n      .first();\r\n  }\r\n\r\n  if (!row) return json({ error: \"Not found\" }, { status: 404 });\r\n\r\n  let outwardDeviceId = presentDeviceId(resolvedId, isAdmin);\r\n  let latest = row;\r\n  if (!isAdmin) {\r\n    const { device_id: _drop, ...rest } = row;\r\n    latest = rest;\r\n  }\r\n\r\n  return json({ device_id: outwardDeviceId, latest });\r\n}\r\n\r\nexport async function handleListDevices(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const isAdmin = userIsAdmin(user);\n  const url = new URL(req.url);\n  const paramsResult = ListDevicesQuerySchema.safeParse({\n    mine: url.searchParams.get(\"mine\") ?? undefined,\n    limit: url.searchParams.get(\"limit\") ?? undefined,\n    cursor: url.searchParams.get(\"cursor\") ?? undefined,\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { mine: mineParam, limit = 50, cursor } = paramsResult.data;\n  const mine = isAdmin ? mineParam ?? false : true;\n  const rawCursor = cursor ?? null;\n  let cursorPhase: \"ts\" | \"null\" | null = null;\r\n  let cursorTs: string | null = null;\r\n  let cursorId: string | null = null;\r\n  if (rawCursor) {\n    const parts = rawCursor.split(\"|\", 3);\n    const phase = parts[0];\r\n    if (phase === \"ts\") {\r\n      cursorPhase = \"ts\";\r\n      const tsPart = parts[1] ?? null;\r\n      cursorTs = safeDecode(tsPart);\r\n      if (tsPart && cursorTs === null) return json({ error: \"Invalid cursor\" }, { status: 400 });\r\n      const idPartRaw = parts.length >= 3 ? parts[2] ?? null : null;\r\n      const idPart = safeDecode(idPartRaw);\r\n      if (idPartRaw && idPart === null) return json({ error: \"Invalid cursor\" }, { status: 400 });\r\n      if (idPart) {\r\n        const parsed = await parseCursorId(idPart, env, isAdmin);\r\n        if (!parsed.ok) return json({ error: \"Invalid cursor\" }, { status: 400 });\r\n        cursorId = parsed.id;\r\n      }\r\n    } else if (phase === \"null\") {\r\n      cursorPhase = \"null\";\r\n      const idPartRaw = parts[1] ?? null;\r\n      const idPart = safeDecode(idPartRaw);\r\n      if (!idPart) return json({ error: \"Invalid cursor\" }, { status: 400 });\r\n      const parsed = await parseCursorId(idPart, env, isAdmin);\r\n      if (!parsed.ok || !parsed.id) return json({ error: \"Invalid cursor\" }, { status: 400 });\r\n      cursorId = parsed.id;\r\n    }\r\n  }\r\n\r\n  let where = \"\";\r\n  const bind: any[] = [];\r\n\r\n  if (mine) {\r\n    if (!user.clientIds?.length) return json({ items: [], next: null });\r\n    const ph = user.clientIds.map((_, i) => `?${i + 1}`).join(\",\");\r\n    where = `WHERE d.profile_id IN (${ph})`;\r\n    bind.push(...user.clientIds);\r\n  }\r\n\r\n  if (cursorPhase === \"ts\" && cursorTs) {\r\n    where += where ? \" AND\" : \"WHERE\";\r\n    if (cursorId) {\r\n      where +=\r\n        \" ((d.last_seen_at IS NOT NULL AND (d.last_seen_at < ? OR (d.last_seen_at = ? AND d.device_id > ?))) OR d.last_seen_at IS NULL)\";\r\n      bind.push(cursorTs, cursorTs, cursorId);\r\n    } else {\r\n      where += \" ((d.last_seen_at IS NOT NULL AND d.last_seen_at < ?) OR d.last_seen_at IS NULL)\";\r\n      bind.push(cursorTs);\r\n    }\r\n  } else if (cursorPhase === \"null\" && cursorId) {\r\n    where += where ? \" AND\" : \"WHERE\";\r\n    where += \" (d.last_seen_at IS NULL AND d.device_id > ?)\";\r\n    bind.push(cursorId);\r\n  }\r\n\r\n  const sql = `\r\n    SELECT d.device_id, d.profile_id, d.site, d.firmware, d.map_version,\r\n           d.online, d.last_seen_at\r\n      FROM devices d\r\n      ${where}\r\n     ORDER BY (d.last_seen_at IS NOT NULL) DESC, d.last_seen_at DESC, d.device_id ASC\r\n     LIMIT ${limit + 1}\r\n  `;\r\n\r\n  const rows = (\r\n    await env.DB.prepare(sql).bind(...bind).all<{\r\n      device_id: string;\r\n      profile_id: string;\r\n      online: number;\r\n      last_seen_at: string | null;\r\n    }>()\r\n  ).results ?? [];\r\n\r\n  const hasMore = rows.length > limit;\r\n  const slice = hasMore ? rows.slice(0, limit) : rows;\r\n\r\n  let items;\r\n  try {\r\n    items = await Promise.all(\r\n      slice.map(async (r) => ({\r\n        device_id: presentDeviceId(r.device_id, isAdmin),\r\n        lookup: await buildDeviceLookup(r.device_id, env, isAdmin),\r\n        profile_id: r.profile_id,\r\n        online: !!r.online,\r\n        last_seen_at: r.last_seen_at,\r\n        site: (r as any).site ?? null,\r\n        firmware: (r as any).firmware ?? null,\r\n        map_version: (r as any).map_version ?? null,\r\n      })),\r\n    );\r\n  } catch (err) {\n    loggerForRequest(req, { route: \"/api/devices\" }).error(\"devices.list_failed\", {\n      error: err,\n    });\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\r\n  let next: string | null = null;\r\n  if (hasMore) {\r\n    const last = slice[slice.length - 1];\r\n    let cursorDeviceId = last.device_id;\r\n    if (!isAdmin) {\r\n      try {\r\n        cursorDeviceId = await sealCursorId(env, last.device_id);\r\n      } catch (err) {\r\n        loggerForRequest(req, { route: \"/api/devices\" }).error(\"devices.cursor_seal_failed\", {\n          error: err,\n        });\n        return json({ error: \"Server error\" }, { status: 500 });\n      }\n    }\r\n    next = last.last_seen_at\r\n      ? `ts|${encodeURIComponent(last.last_seen_at)}|${encodeURIComponent(cursorDeviceId)}`\r\n      : `null|${encodeURIComponent(cursorDeviceId)}`;\r\n  }\r\n\r\n  return json({ items, next });\r\n}\r\n\r\nexport async function handleDeviceHistory(req: Request, env: Env, rawDeviceId: string) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const scope = buildDeviceScope(user);\r\n  const resolvedId = await resolveDeviceId(rawDeviceId, env, scope.isAdmin);\r\n  if (!resolvedId) return json({ error: \"Not found\" }, { status: 404 });\r\n\r\n  if (!scope.isAdmin) {\r\n    if (scope.empty) return json({ error: \"Not found\" }, { status: 404 });\r\n    const owned = await env.DB.prepare(\r\n      `SELECT 1 FROM devices d WHERE d.device_id = ?1 AND ${scope.clause} LIMIT 1`,\r\n    )\r\n      .bind(resolvedId, ...scope.bind)\r\n      .first();\r\n    if (!owned) return json({ error: \"Not found\" }, { status: 404 });\r\n  }\r\n\r\n  const url = new URL(req.url);\n  const paramsResult = DeviceHistoryQuerySchema.safeParse({\n    limit: url.searchParams.get(\"limit\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { limit = 72 } = paramsResult.data;\n\r\n  const rows = await env.DB\r\n    .prepare(\r\n      `SELECT ts, metrics_json, deltaT, thermalKW, cop\r\n         FROM telemetry\r\n        WHERE device_id = ?1\r\n        ORDER BY ts DESC\r\n        LIMIT ${limit}`,\r\n    )\r\n    .bind(resolvedId)\r\n    .all<{\r\n      ts: number;\r\n      metrics_json: string | null;\r\n      deltaT: number | null;\r\n      thermalKW: number | null;\r\n      cop: number | null;\r\n    }>();\r\n\r\n  const items = (rows.results ?? []).map((row) => {\r\n    const metrics = parseMetricsJson(row.metrics_json);\r\n    return {\r\n      ts: new Date(row.ts).toISOString(),\r\n      deltaT: row.deltaT ?? null,\r\n      thermalKW: row.thermalKW ?? null,\r\n      cop: row.cop ?? null,\r\n      supplyC: metrics.supplyC ?? null,\r\n      returnC: metrics.returnC ?? null,\r\n      tankC: metrics.tankC ?? null,\r\n      ambientC: metrics.ambientC ?? null,\r\n      flowLps: metrics.flowLps ?? null,\r\n      powerKW: metrics.powerKW ?? null,\r\n      mode: metrics.mode ?? null,\r\n      defrost: metrics.defrost ?? null,\r\n    };\r\n  }).reverse();\r\n\r\n  let lookupToken: string;\r\n  try {\r\n    lookupToken = await buildDeviceLookup(resolvedId, env, scope.isAdmin);\r\n  } catch (err) {\n    loggerForRequest(req, {\n      route: \"/api/devices/:id/history\",\n      device_id: resolvedId,\n      request_device_id: rawDeviceId,\n    }).error(\"devices.history_lookup_failed\", { error: err });\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\r\n  return json({\r\n    device_id: presentDeviceId(resolvedId, scope.isAdmin),\r\n    lookup: lookupToken,\r\n    items,\r\n  });\r\n}\r\n", "import { handleDeviceHistory, handleLatest, handleListDevices } from \"../routes/devices\";\nimport { withAccess } from \"./access\";\n\nimport type { AppRouter, WithParam } from \"./params\";\n\nexport function registerDeviceRoutes(router: AppRouter, withParam: WithParam) {\n  router\n    .get(\"/api/devices\", withAccess((req, env) => handleListDevices(req, env)))\n    .get(\n      \"/api/devices/:id/latest\",\n      withAccess(\n        withParam(\"id\", (req, env, deviceId) => handleLatest(req, env, deviceId)),\n      ),\n    )\n    .get(\n      \"/api/devices/:id/history\",\n      withAccess(\n        withParam(\"id\", (req, env, deviceId) => handleDeviceHistory(req, env, deviceId)),\n      ),\n    );\n}\n", "import type { RouterType } from \"itty-router\";\n\nimport type { Env } from \"../env\";\nimport { safeDecode } from \"../utils\";\nimport { json } from \"../utils/responses\";\n\nexport type AppRouter = RouterType<Request, [Env, ExecutionContext], Response>;\nexport type RouteHandler = (\n  req: Request,\n  env: Env,\n  ctx?: ExecutionContext,\n) => Promise<Response> | Response;\nexport type ParamHandler = (\n  req: Request,\n  env: Env,\n  value: string,\n  ctx?: ExecutionContext,\n) => Promise<Response> | Response;\nexport type WithParam = (param: string, handler: ParamHandler) => RouteHandler;\n\ntype RoutedRequest = Request & { params?: Record<string, string> };\n\nfunction decodeParam(req: RoutedRequest, key: string): string | null {\n  const raw = req.params?.[key] ?? null;\n  const decoded = safeDecode(raw);\n  if (decoded === null || decoded === \"\") return null;\n  return decoded;\n}\n\nexport const withParam: WithParam = (param, handler) => {\n  return (req, env, ctx) => {\n    const value = decodeParam(req as RoutedRequest, param);\n    if (!value) {\n      return json({ error: `Invalid ${param}` }, { status: 400 });\n    }\n    return handler(req, env, value, ctx);\n  };\n};\n", "import { z } from \"zod\";\n\nexport const MetricsQuerySchema = z\n  .object({\n    format: z.preprocess(\n      (input: unknown) => {\n        if (input === undefined || input === null) return undefined;\n        if (typeof input !== \"string\") return input;\n        const trimmed = input.trim().toLowerCase();\n        return trimmed === \"\" ? undefined : trimmed;\n      },\n      z.enum([\"json\", \"prom\", \"dashboard\"]).optional(),\n    ),\n  })\n  .strict();\n\nexport type MetricsQuery = z.infer<typeof MetricsQuerySchema>;\n", "import type { Env } from \"../env\";\nimport { requireAccessUser, userIsAdmin } from \"../lib/access\";\nimport { json, text } from \"../utils/responses\";\nimport { validationErrorResponse } from \"../utils/validation\";\nimport { MetricsQuerySchema } from \"../schemas/metrics\";\nimport { formatMetricsJson, formatPromMetrics, pickMetricsFormat } from \"../telemetry\";\nimport {\n  OPS_METRICS_WINDOW_DAYS,\n  opsMetricsWindowStart,\n  pruneOpsMetrics,\n} from \"../lib/ops-metrics\";\n\nexport async function handleMetrics(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n  if (!userIsAdmin(user)) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  const url = new URL(req.url);\n  const paramsResult = MetricsQuerySchema.safeParse({\n    format: url.searchParams.get(\"format\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const formatParam = paramsResult.data.format;\n  const isDashboardFormat = (formatParam as string | undefined) === \"dashboard\";\n\n  const now = Date.now();\n  const windowStart = opsMetricsWindowStart(now);\n  await pruneOpsMetrics(env, now);\n\n  const deviceStats =\n    (await env.DB.prepare(\"SELECT COUNT(*) AS total, SUM(online) AS online FROM devices\").first<{\n      total: number | null;\n      online: number | null;\n    }>()) ?? null;\n\n  const opsRows =\n    (\n      await env.DB.prepare(\n        `SELECT route,\n                status_code,\n                COUNT(*) AS count,\n                SUM(duration_ms) AS total_duration_ms,\n                AVG(duration_ms) AS avg_duration_ms,\n                MAX(duration_ms) AS max_duration_ms\n           FROM ops_metrics\n          WHERE ts >= ?1\n          GROUP BY route, status_code\n          ORDER BY route ASC, status_code ASC`,\n      )\n        .bind(windowStart)\n        .all<{\n          route: string | null;\n          status_code: number | null;\n          count: number | null;\n          total_duration_ms: number | string | null;\n          avg_duration_ms: number | string | null;\n          max_duration_ms: number | string | null;\n        }>()\n    ).results ?? [];\n\n  const deviceSummary = {\n    total: deviceStats?.total ?? null,\n    online: deviceStats?.online ?? null,\n  };\n\n  const metricsPayload = formatMetricsJson(deviceSummary, opsRows);\n\n  if (isDashboardFormat) {\n    const dashboard = buildDashboardPayload(metricsPayload);\n    return json({\n      ...dashboard,\n      ops_window: {\n        start: windowStart,\n        days: OPS_METRICS_WINDOW_DAYS,\n      },\n    });\n  }\n\n  const format = pickMetricsFormat(formatParam, req.headers.get(\"accept\") ?? \"\");\n\n  if (format === \"json\") {\n    return json({\n      ...metricsPayload,\n      ops_window: {\n        start: windowStart,\n        days: OPS_METRICS_WINDOW_DAYS,\n      },\n    });\n  }\n\n  const promPayload = formatPromMetrics(deviceSummary, opsRows);\n  return text(promPayload, {\n    headers: {\n      \"content-type\": \"text/plain; charset=utf-8\",\n    },\n  });\n}\n\ntype MetricsJsonPayload = ReturnType<typeof formatMetricsJson>;\ntype SeverityLevel = \"ok\" | \"warn\" | \"critical\";\n\nfunction buildDashboardPayload(payload: MetricsJsonPayload) {\n  const offlineStatus = deriveSeverity(\n    payload.devices.offline_ratio,\n    payload.thresholds.devices.offline_ratio,\n  );\n\n  const serverSeverity = deriveSeverity(\n    payload.ops_summary.server_error_rate,\n    payload.thresholds.ops.error_rate,\n  );\n  const clientSeverity = deriveSeverity(\n    payload.ops_summary.client_error_rate,\n    payload.thresholds.ops.client_error_rate,\n  );\n  const maxAvgDuration = payload.ops_summary.slow_routes[0]?.avg_duration_ms ?? 0;\n  const latencySeverity = deriveSeverity(\n    maxAvgDuration,\n    payload.thresholds.ops.avg_duration_ms,\n  );\n\n  const overallOpsSeverity = [serverSeverity, clientSeverity, latencySeverity].reduce(\n    (acc, current) => (severityWeight(current) > severityWeight(acc) ? current : acc),\n    \"ok\" as SeverityLevel,\n  );\n\n  return {\n    generated_at: payload.generated_at,\n    devices: {\n      ...payload.devices,\n      status: offlineStatus,\n      thresholds: payload.thresholds.devices,\n    },\n    ops: {\n      summary: payload.ops_summary,\n      status: overallOpsSeverity,\n      metrics: {\n        server_error_rate: {\n          value: payload.ops_summary.server_error_rate,\n          status: serverSeverity,\n          thresholds: payload.thresholds.ops.error_rate,\n        },\n        client_error_rate: {\n          value: payload.ops_summary.client_error_rate,\n          status: clientSeverity,\n          thresholds: payload.thresholds.ops.client_error_rate,\n        },\n        max_avg_duration_ms: {\n          value: maxAvgDuration,\n          status: latencySeverity,\n          thresholds: payload.thresholds.ops.avg_duration_ms,\n        },\n      },\n      slow_routes: payload.ops_summary.slow_routes,\n      top_server_error_routes: payload.ops_summary.top_server_error_routes,\n    },\n    thresholds: payload.thresholds,\n  };\n}\n\nfunction deriveSeverity(\n  value: number,\n  thresholds: { warn: number; critical: number },\n): SeverityLevel {\n  if (value >= thresholds.critical) return \"critical\";\n  if (value >= thresholds.warn) return \"warn\";\n  return \"ok\";\n}\n\nfunction severityWeight(level: SeverityLevel): number {\n  switch (level) {\n    case \"critical\":\n      return 3;\n    case \"warn\":\n      return 2;\n    default:\n      return 1;\n  }\n}\n", "import { handleMetrics } from \"../routes/metrics\";\n\nimport type { AppRouter } from \"./params\";\n\nexport function registerMetricsRoutes(router: AppRouter) {\n  router.get(\"/metrics\", (req, env) => handleMetrics(req, env));\n}\n", "import { z } from \"zod\";\r\n\r\nimport {\r\n  numericParam,\r\n  optionalBooleanFlag,\r\n  optionalTrimmedString,\r\n} from \"./params\";\r\n\r\nconst DEVICE_ID_LIMIT = 200;\r\n\r\nexport const TelemetryLatestBatchSchema = z\r\n  .object({\r\n    devices: z\r\n      .array(\r\n        z\r\n          .string({\r\n            required_error: \"Device identifiers are required\",\r\n            invalid_type_error: \"Device identifiers must be strings\",\r\n          })\r\n          .trim()\r\n          .min(1, \"Device identifier must not be empty\"),\r\n      )\r\n      .max(DEVICE_ID_LIMIT, `Cannot request more than ${DEVICE_ID_LIMIT} devices`)\r\n      .default([]),\r\n    include: z\r\n      .object({\r\n        faults: optionalBooleanFlag.default(true),\r\n        metrics: optionalBooleanFlag.default(true),\r\n      })\r\n      .default({\r\n        faults: true,\r\n        metrics: true,\r\n      }),\r\n  })\r\n  .strict();\r\n\r\nexport type TelemetryLatestBatchInput = z.infer<typeof TelemetryLatestBatchSchema>;\r\n\r\nexport const TelemetrySeriesQuerySchema = z\r\n  .object({\r\n    scope: optionalTrimmedString\r\n      .transform((value: string | undefined) =>\r\n        value ? value.toLowerCase() : undefined,\r\n      )\r\n      .refine(\r\n        (value: string | undefined) =>\r\n          !value || [\"device\", \"profile\", \"fleet\"].includes(value),\r\n        \"Invalid scope\",\r\n      )\r\n      .default(\"device\"),\r\n    device: optionalTrimmedString,\r\n    profile: optionalTrimmedString,\r\n    metric: optionalTrimmedString,\r\n    start: optionalTrimmedString,\r\n    end: optionalTrimmedString,\r\n    interval: optionalTrimmedString,\r\n    fill: optionalTrimmedString,\r\n    limit: numericParam({ integer: true, min: 1, max: 2000, defaultValue: 288 }),\r\n  })\r\n  .strict();\r\n\r\nexport type TelemetrySeriesQuery = z.infer<typeof TelemetrySeriesQuerySchema>;\r\n\r\nexport const TELEMETRY_ALLOWED_METRICS = [\r\n  \"thermalKW\",\r\n  \"cop\",\r\n  \"deltaT\",\r\n  \"supplyC\",\r\n  \"returnC\",\r\n  \"flowLps\",\r\n  \"powerKW\",\r\n] as const;\r\n\r\nexport const TELEMETRY_INTERVALS_MS: Record<string, number> = {\r\n  \"1m\": 60_000,\r\n  \"5m\": 300_000,\r\n  \"15m\": 900_000,\r\n  \"1h\": 3_600_000,\r\n  \"1d\": 86_400_000,\r\n};\r\n", "import type { Env, User } from \"../env\";\nimport { maskTelemetryNumber } from \"../telemetry\";\nimport {\n  TELEMETRY_ALLOWED_METRICS,\n  TELEMETRY_INTERVALS_MS,\n  type TelemetryLatestBatchInput,\n  type TelemetrySeriesQuery,\n} from \"../schemas/telemetry\";\nimport { parseFaultsJson } from \"../utils\";\nimport {\n  buildDeviceLookup,\n  buildDeviceScope,\n  presentDeviceId,\n  resolveDeviceId,\n} from \"./device\";\nimport { userIsAdmin } from \"./access\";\nimport type { TelemetryLatestRow } from \"./telemetry-store\";\n\ntype TelemetryIncludeFlags = TelemetryLatestBatchInput[\"include\"];\nconst SENSITIVE_PAYLOAD_KEYS = [\"secret\", \"token\", \"password\", \"key\", \"signature\", \"auth\"];\n\nexport interface LatestBatchRequestedDevice {\n  token: string;\n  index: number;\n  resolved: string | null;\n}\n\nexport interface LatestBatchResolution {\n  scope: ReturnType<typeof buildDeviceScope>;\n  requested: LatestBatchRequestedDevice[];\n  resolvedIds: string[];\n  missingTokens: string[];\n}\n\nexport interface TelemetrySeriesConfig {\n  bucketMs: number;\n  startMs: number;\n  endMs: number;\n  metrics: (typeof TELEMETRY_ALLOWED_METRICS)[number][];\n  whereClause: string;\n  bindings: any[];\n  scopeDescriptor: TelemetryScopeDescriptor;\n  fillMode: \"carry\" | \"none\";\n  tenantPrecision: number;\n}\n\nexport type TelemetrySeriesConfigResult =\n  | { ok: true; config: TelemetrySeriesConfig }\n  | { ok: false; status: 400 | 403 | 404 | 500; error: string };\n\nexport interface DeviceScopeDescriptor {\n  type: \"device\";\n  device_id: string;\n  lookup: string;\n}\n\nexport interface ProfileScopeDescriptor {\n  type: \"profile\";\n  profile_ids: string[];\n}\n\nexport interface FleetScopeDescriptor {\n  type: \"fleet\";\n  profile_ids: string[] | null;\n}\n\nexport type TelemetryScopeDescriptor =\n  | DeviceScopeDescriptor\n  | ProfileScopeDescriptor\n  | FleetScopeDescriptor;\n\nexport async function resolveLatestBatchDevices(\n  env: Env,\n  user: User,\n  deviceTokens: string[],\n): Promise<LatestBatchResolution> {\n  const scope = buildDeviceScope(user);\n  const requested: LatestBatchRequestedDevice[] = deviceTokens.map((token, index) => ({\n    token,\n    index,\n    resolved: null,\n  }));\n\n  const missingTokens: string[] = [];\n  if (!deviceTokens.length) {\n    return { scope, requested, resolvedIds: [], missingTokens };\n  }\n\n  const resolutions = await Promise.all(\n    requested.map((entry) => resolveDeviceId(entry.token, env, scope.isAdmin)),\n  );\n  resolutions.forEach((resolved, index) => {\n    if (!resolved) {\n      missingTokens.push(requested[index]!.token);\n      return;\n    }\n    requested[index]!.resolved = resolved;\n  });\n\n  const resolvedIds = Array.from(\n    new Set(requested.filter((candidate) => candidate.resolved).map((candidate) => candidate.resolved!)),\n  );\n\n  return { scope, requested, resolvedIds, missingTokens };\n}\n\nexport async function presentLatestBatchRow(\n  row: TelemetryLatestRow,\n  env: Env,\n  include: TelemetryIncludeFlags | undefined,\n  user: User,\n) {\n  const isAdmin = userIsAdmin(user);\n  const lookup = await buildDeviceLookup(row.device_id, env, isAdmin);\n  const outwardId = presentDeviceId(row.device_id, isAdmin);\n  const flags: TelemetryIncludeFlags = include ?? { faults: true, metrics: true };\n  const includeMetrics = flags.metrics !== false;\n  const includeFaults = flags.faults !== false;\n\n  const latest: Record<string, unknown> = {\n    ts: row.ts ?? null,\n    updated_at: row.updated_at ?? null,\n    online: row.latest_online === 1,\n    mode: row.mode ?? null,\n    defrost: row.defrost ?? null,\n    cop_quality: row.cop_quality ?? null,\n  };\n\n  if (includeMetrics) {\n    if (isAdmin) {\n      const parsedPayload = safeParseJson(row.payload_json);\n      const sanitized = parsedPayload === null ? null : sanitizeTelemetryPayload(parsedPayload);\n      latest.payload = sanitized ?? null;\n    }\n    latest.supplyC = maskTelemetryNumber(row.supplyC, isAdmin);\n    latest.returnC = maskTelemetryNumber(row.returnC, isAdmin);\n    latest.tankC = maskTelemetryNumber(row.tankC, isAdmin);\n    latest.ambientC = maskTelemetryNumber(row.ambientC, isAdmin);\n    latest.flowLps = maskTelemetryNumber(row.flowLps, isAdmin, 3);\n    latest.compCurrentA = maskTelemetryNumber(row.compCurrentA, isAdmin, 2);\n    latest.eevSteps = maskTelemetryNumber(row.eevSteps, isAdmin, 0);\n    latest.powerKW = maskTelemetryNumber(row.powerKW, isAdmin, 3);\n    latest.deltaT = maskTelemetryNumber(row.deltaT, isAdmin, 2);\n    latest.thermalKW = maskTelemetryNumber(row.thermalKW, isAdmin, 3);\n    latest.cop = maskTelemetryNumber(row.cop, isAdmin, 2);\n  } else if (isAdmin) {\n    const parsedPayload = safeParseJson(row.payload_json);\n    if (parsedPayload !== null) {\n      const sanitized = sanitizeTelemetryPayload(parsedPayload);\n      if (sanitized !== undefined) {\n        latest.payload = sanitized;\n      }\n    }\n  }\n\n  if (includeFaults) {\n    latest.faults = parseFaultsJson(row.faults_json);\n  }\n\n  return {\n    lookup,\n    device_id: outwardId,\n    profile_id: row.profile_id ?? null,\n    site: row.site ?? null,\n    online: row.device_online === 1,\n    last_seen_at: row.last_seen_at ?? null,\n    latest,\n  };\n}\n\nexport async function resolveTelemetrySeriesConfig(\n  params: TelemetrySeriesQuery,\n  env: Env,\n  user: User,\n): Promise<TelemetrySeriesConfigResult> {\n  const metrics = resolveMetrics(params.metric);\n  if (!metrics.length) {\n    return { ok: false, status: 400, error: \"Invalid metrics\" };\n  }\n\n  const bucketMs = resolveInterval(params.interval ?? \"5m\");\n  if (!bucketMs) {\n    return { ok: false, status: 400, error: \"Invalid interval\" };\n  }\n\n  const now = Date.now();\n  const endMs = clampTimestamp(params.end, now);\n  if (endMs === null) {\n    return { ok: false, status: 400, error: \"Invalid end timestamp\" };\n  }\n\n  const defaultStart = endMs - 24 * 60 * 60 * 1000;\n  let startMs = clampTimestamp(params.start, defaultStart);\n  if (startMs === null) {\n    return { ok: false, status: 400, error: \"Invalid start timestamp\" };\n  }\n\n  if (startMs >= endMs) {\n    return { ok: false, status: 400, error: \"Start must be before end\" };\n  }\n\n  const limit = params.limit ?? 288;\n  const maxWindow = limit * bucketMs;\n  if (endMs - startMs > maxWindow) {\n    startMs = endMs - maxWindow;\n  }\n\n  const scope = buildDeviceScope(user, \"d\");\n  const isAdmin = scope.isAdmin;\n  const fillMode = params.fill === \"carry\" ? \"carry\" : \"none\";\n  const tenantPrecision = isAdmin ? 4 : 2;\n\n  const conditions: string[] = [\"t.ts BETWEEN params.start_ms AND params.end_ms\"];\n  const bindings: any[] = [];\n  let scopeDescriptor: TelemetryScopeDescriptor;\n\n  if (params.scope === \"device\") {\n    if (!params.device) {\n      return { ok: false, status: 400, error: \"Device parameter is required for device scope\" };\n    }\n    const resolvedId = await resolveDeviceId(params.device, env, isAdmin);\n    if (!resolvedId) {\n      return { ok: false, status: 404, error: \"Device not found\" };\n    }\n\n    const row = await env.DB\n      .prepare(`SELECT device_id, profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n      .bind(resolvedId)\n      .first<{ device_id: string; profile_id: string | null }>();\n    if (!row) {\n      return { ok: false, status: 404, error: \"Device not found\" };\n    }\n\n    if (!isAdmin) {\n      const allowed = (scope.bind as string[]) ?? [];\n      if (!allowed.includes(row.profile_id ?? \"\")) {\n        return { ok: false, status: 403, error: \"Forbidden\" };\n      }\n    }\n\n    conditions.push(\"t.device_id = ?\");\n    bindings.push(row.device_id);\n\n    const outwardId = presentDeviceId(row.device_id, isAdmin);\n    const lookup = await buildDeviceLookup(row.device_id, env, isAdmin);\n    scopeDescriptor = { type: \"device\", device_id: outwardId, lookup };\n  } else if (params.scope === \"profile\") {\n    if (isAdmin) {\n      if (!params.profile) {\n        return { ok: false, status: 400, error: \"Profile parameter is required for profile scope\" };\n      }\n      conditions.push(buildInClause(\"d.profile_id\", [params.profile]));\n      bindings.push(params.profile);\n      scopeDescriptor = { type: \"profile\", profile_ids: [params.profile] };\n    } else {\n      const allowed = (scope.bind as string[]) ?? [];\n      if (!allowed.length) {\n        conditions.push(\"1=0\");\n        scopeDescriptor = { type: \"profile\", profile_ids: [] };\n      } else {\n        let selected: string[];\n        if (params.profile) {\n          if (!allowed.includes(params.profile)) {\n            return { ok: false, status: 403, error: \"Forbidden\" };\n          }\n          selected = [params.profile];\n        } else if (allowed.length === 1) {\n          selected = [...allowed];\n        } else {\n          return {\n            ok: false,\n            status: 400,\n            error: \"Profile parameter required for scoped users\",\n          };\n        }\n        conditions.push(buildInClause(\"d.profile_id\", selected));\n        bindings.push(...selected);\n        scopeDescriptor = { type: \"profile\", profile_ids: selected };\n      }\n    }\n  } else {\n    if (isAdmin) {\n      if (params.profile) {\n        conditions.push(buildInClause(\"d.profile_id\", [params.profile]));\n        bindings.push(params.profile);\n        scopeDescriptor = { type: \"fleet\", profile_ids: [params.profile] };\n      } else {\n        scopeDescriptor = { type: \"fleet\", profile_ids: null };\n      }\n    } else {\n      const allowed = (scope.bind as string[]) ?? [];\n      if (!allowed.length) {\n        conditions.push(\"1=0\");\n        scopeDescriptor = { type: \"fleet\", profile_ids: [] };\n      } else {\n        let selected = [...allowed];\n        if (params.profile) {\n          if (!allowed.includes(params.profile)) {\n            return { ok: false, status: 403, error: \"Forbidden\" };\n          }\n          selected = [params.profile];\n        }\n        conditions.push(buildInClause(\"d.profile_id\", selected));\n        bindings.push(...selected);\n        scopeDescriptor = { type: \"fleet\", profile_ids: selected };\n      }\n    }\n  }\n\n  if (!isAdmin && scope.clause) {\n    conditions.push(scope.clause);\n    bindings.push(...scope.bind);\n  }\n\n  const whereClause = conditions.join(\" AND \");\n\n  return {\n    ok: true,\n    config: {\n      bucketMs,\n      startMs,\n      endMs,\n      metrics,\n      whereClause,\n      bindings,\n      scopeDescriptor,\n      fillMode,\n      tenantPrecision,\n    },\n  };\n}\n\nfunction resolveMetrics(csv: string | undefined | null) {\n  if (!csv) return [...TELEMETRY_ALLOWED_METRICS];\n  const parts = csv\n    .split(\",\")\n    .map((part) => part.trim())\n    .filter(Boolean) as (typeof TELEMETRY_ALLOWED_METRICS)[number][];\n  const allowed = new Set(TELEMETRY_ALLOWED_METRICS);\n  return parts.filter((part) => allowed.has(part));\n}\n\nfunction resolveInterval(interval: string | undefined) {\n  if (!interval) return TELEMETRY_INTERVALS_MS[\"5m\"];\n  return TELEMETRY_INTERVALS_MS[interval] ?? null;\n}\n\nfunction clampTimestamp(value: string | number | null | undefined, fallback: number): number | null {\n  if (value == null) return fallback;\n  if (typeof value === \"number\") return Number.isFinite(value) ? value : null;\n  const trimmed = String(value).trim();\n  if (!trimmed) return fallback;\n  if (/^\\d+$/.test(trimmed)) {\n    const parsed = Number.parseInt(trimmed, 10);\n    return Number.isNaN(parsed) ? null : parsed;\n  }\n  const parsed = Date.parse(trimmed);\n  return Number.isNaN(parsed) ? null : parsed;\n}\n\nfunction buildInClause(column: string, values: string[]) {\n  if (!values.length) return \"1=0\";\n  const placeholders = values.map(() => \"?\").join(\",\");\n  return `${column} IN (${placeholders})`;\n}\n\nfunction sanitizeTelemetryPayload(payload: unknown, depth = 0): unknown {\n  if (payload === null) return null;\n  if (depth >= 6) return null;\n\n  if (Array.isArray(payload)) {\n    const items = payload\n      .slice(0, 50)\n      .map((item) => sanitizeTelemetryPayload(item, depth + 1))\n      .filter((item) => item !== undefined);\n    return items;\n  }\n\n  if (typeof payload === \"object\") {\n    const entries = Object.entries(payload as Record<string, unknown>);\n    const result: Record<string, unknown> = {};\n    for (const [key, value] of entries) {\n      if (!key) continue;\n      const normalized = key.toLowerCase();\n      if (SENSITIVE_PAYLOAD_KEYS.some((fragment) => normalized.includes(fragment))) {\n        result[key] = \"[redacted]\";\n        continue;\n      }\n      const sanitized = sanitizeTelemetryPayload(value, depth + 1);\n      if (sanitized !== undefined) {\n        result[key] = sanitized;\n      }\n    }\n    return result;\n  }\n\n  if (typeof payload === \"string\") {\n    if (!payload.trim()) return \"\";\n    return payload.length > 512 ? `${payload.slice(0, 509)}...` : payload;\n  }\n\n  if (typeof payload === \"number\" || typeof payload === \"boolean\") {\n    return payload;\n  }\n\n  return undefined;\n}\n\nfunction safeParseJson(payload: string | null | undefined) {\n  if (!payload) return null;\n  try {\n    return JSON.parse(payload);\n  } catch {\n    return null;\n  }\n}\n", "import type { Env } from \"../env\";\nimport type { buildDeviceScope } from \"./device\";\nimport { andWhere } from \"../utils\";\n\nexport const TELEMETRY_LATEST_BATCH_CHUNK = 100;\n\nexport type DeviceScope = ReturnType<typeof buildDeviceScope>;\n\nexport interface TelemetryLatestRow {\n  device_id: string;\n  ts: number | null;\n  updated_at: string | null;\n  supplyC: number | null;\n  returnC: number | null;\n  tankC: number | null;\n  ambientC: number | null;\n  flowLps: number | null;\n  compCurrentA: number | null;\n  eevSteps: number | null;\n  powerKW: number | null;\n  deltaT: number | null;\n  thermalKW: number | null;\n  cop: number | null;\n  cop_quality: string | null;\n  mode: string | null;\n  defrost: number | null;\n  latest_online: number | null;\n  faults_json: string | null;\n  payload_json: string | null;\n  profile_id: string | null;\n  site: string | null;\n  device_online: number | null;\n  last_seen_at: string | null;\n}\n\nexport interface TelemetrySeriesRow {\n  bucket_start_ms: number;\n  sample_count: number;\n  avg_deltaT: number | null;\n  min_deltaT: number | null;\n  max_deltaT: number | null;\n  avg_thermalKW: number | null;\n  min_thermalKW: number | null;\n  max_thermalKW: number | null;\n  avg_cop: number | null;\n  min_cop: number | null;\n  max_cop: number | null;\n  avg_supplyC: number | null;\n  avg_returnC: number | null;\n  avg_flowLps: number | null;\n  avg_powerKW: number | null;\n}\n\nexport interface TelemetrySeriesQueryConfig {\n  bucketMs: number;\n  startMs: number;\n  endMs: number;\n  whereClause: string;\n  bindings: readonly unknown[];\n}\n\nexport async function fetchLatestTelemetryBatch(\n  env: Env,\n  deviceIds: string[],\n  scope: DeviceScope,\n): Promise<TelemetryLatestRow[]> {\n  if (!deviceIds.length) {\n    return [];\n  }\n\n  const rows: TelemetryLatestRow[] = [];\n  for (let i = 0; i < deviceIds.length; i += TELEMETRY_LATEST_BATCH_CHUNK) {\n    const chunk = deviceIds.slice(i, i + TELEMETRY_LATEST_BATCH_CHUNK);\n    const placeholders = chunk.map(() => \"?\").join(\",\");\n    let where = `ls.device_id IN (${placeholders})`;\n    const bind: unknown[] = [...chunk];\n\n    if (!scope.isAdmin && scope.clause) {\n      where = andWhere(where, scope.clause.replace(/^WHERE\\s+/i, \"\"));\n      bind.push(...scope.bind);\n    }\n\n    const query = `\n      SELECT\n        ls.device_id,\n        ls.ts,\n        ls.updated_at,\n        ls.supplyC,\n        ls.returnC,\n        ls.tankC,\n        ls.ambientC,\n        ls.flowLps,\n        ls.compCurrentA,\n        ls.eevSteps,\n        ls.powerKW,\n        ls.deltaT,\n        ls.thermalKW,\n        ls.cop,\n        ls.cop_quality,\n        ls.mode,\n        ls.defrost,\n        ls.online AS latest_online,\n        ls.faults_json,\n        ls.payload_json,\n        d.profile_id,\n        d.site,\n        d.online AS device_online,\n        d.last_seen_at\n      FROM latest_state ls\n      JOIN devices d ON d.device_id = ls.device_id\n      WHERE ${where}\n    `;\n\n    const result = await env.DB.prepare(query)\n      .bind(...bind)\n      .all<TelemetryLatestRow>();\n    rows.push(...(result.results ?? []));\n  }\n\n  return rows;\n}\n\nexport async function fetchTelemetrySeries(\n  env: Env,\n  config: TelemetrySeriesQueryConfig,\n): Promise<TelemetrySeriesRow[]> {\n  const query = buildSeriesSql(config.whereClause);\n  const bindings = [\n    config.bucketMs,\n    config.startMs,\n    config.endMs,\n    ...config.bindings,\n  ];\n  const rows = await env.DB.prepare(query)\n    .bind(...bindings)\n    .all<TelemetrySeriesRow>();\n  return rows.results ?? [];\n}\n\nfunction buildSeriesSql(whereClause: string): string {\n  return `\n    WITH params AS (\n      SELECT ? AS bucket_ms, ? AS start_ms, ? AS end_ms\n    ),\n    scoped AS (\n      SELECT\n        (CAST(t.ts / params.bucket_ms AS INTEGER) * params.bucket_ms) AS bucket_start_ms,\n        t.device_id,\n        t.deltaT,\n        t.thermalKW,\n        t.cop,\n        json_extract(t.metrics_json, '$.supplyC') AS supplyC,\n        json_extract(t.metrics_json, '$.returnC') AS returnC,\n        json_extract(t.metrics_json, '$.flowLps') AS flowLps,\n        json_extract(t.metrics_json, '$.powerKW') AS powerKW\n      FROM telemetry t\n      JOIN devices d ON d.device_id = t.device_id\n      JOIN params\n      WHERE ${whereClause}\n    ),\n    per_device AS (\n      SELECT\n        bucket_start_ms,\n        device_id,\n        COUNT(*) AS sample_count,\n        AVG(deltaT) AS avg_deltaT,\n        MIN(deltaT) AS min_deltaT,\n        MAX(deltaT) AS max_deltaT,\n        SUM(CASE WHEN deltaT IS NOT NULL THEN 1 ELSE 0 END) AS deltaT_count,\n        AVG(thermalKW) AS avg_thermalKW,\n        MIN(thermalKW) AS min_thermalKW,\n        MAX(thermalKW) AS max_thermalKW,\n        SUM(CASE WHEN thermalKW IS NOT NULL THEN 1 ELSE 0 END) AS thermalKW_count,\n        AVG(cop) AS avg_cop,\n        MIN(cop) AS min_cop,\n        MAX(cop) AS max_cop,\n        SUM(CASE WHEN cop IS NOT NULL THEN 1 ELSE 0 END) AS cop_count,\n        AVG(supplyC) AS avg_supplyC,\n        AVG(returnC) AS avg_returnC,\n        AVG(flowLps) AS avg_flowLps,\n        AVG(powerKW) AS avg_powerKW,\n        SUM(CASE WHEN supplyC IS NOT NULL THEN 1 ELSE 0 END) AS supplyC_count,\n        SUM(CASE WHEN returnC IS NOT NULL THEN 1 ELSE 0 END) AS returnC_count,\n        SUM(CASE WHEN flowLps IS NOT NULL THEN 1 ELSE 0 END) AS flowLps_count,\n        SUM(CASE WHEN powerKW IS NOT NULL THEN 1 ELSE 0 END) AS powerKW_count\n      FROM scoped\n      GROUP BY bucket_start_ms, device_id\n    ),\n    aggregated AS (\n      SELECT\n        bucket_start_ms,\n        SUM(sample_count) AS sample_count,\n        SUM(avg_deltaT * deltaT_count) / NULLIF(SUM(deltaT_count), 0) AS avg_deltaT,\n        MIN(min_deltaT) AS min_deltaT,\n        MAX(max_deltaT) AS max_deltaT,\n        SUM(avg_thermalKW * thermalKW_count) / NULLIF(SUM(thermalKW_count), 0) AS avg_thermalKW,\n        MIN(min_thermalKW) AS min_thermalKW,\n        MAX(max_thermalKW) AS max_thermalKW,\n        SUM(avg_cop * cop_count) / NULLIF(SUM(cop_count), 0) AS avg_cop,\n        MIN(min_cop) AS min_cop,\n        MAX(max_cop) AS max_cop,\n        SUM(avg_supplyC * supplyC_count) / NULLIF(SUM(supplyC_count), 0) AS avg_supplyC,\n        SUM(avg_returnC * returnC_count) / NULLIF(SUM(returnC_count), 0) AS avg_returnC,\n        SUM(avg_flowLps * flowLps_count) / NULLIF(SUM(flowLps_count), 0) AS avg_flowLps,\n        SUM(avg_powerKW * powerKW_count) / NULLIF(SUM(powerKW_count), 0) AS avg_powerKW\n      FROM per_device\n      GROUP BY bucket_start_ms\n    )\n    SELECT *\n    FROM aggregated\n    ORDER BY bucket_start_ms ASC\n  `;\n}\n", "import type { Env, User } from \"../env\";\r\nimport { requireAccessUser, userIsAdmin } from \"../lib/access\";\r\nimport {\r\n  buildDeviceLookup,\r\n  buildDeviceScope,\r\n  presentDeviceId,\r\n  resolveDeviceId,\r\n} from \"../lib/device\";\r\nimport { maskTelemetryNumber } from \"../telemetry\";\r\nimport {\r\n  TelemetryLatestBatchSchema,\r\n  TelemetrySeriesQuerySchema,\r\n  TELEMETRY_ALLOWED_METRICS,\r\n  TELEMETRY_INTERVALS_MS,\r\n  type TelemetryLatestBatchInput,\r\n  type TelemetrySeriesQuery,\r\n} from \"../schemas/telemetry\";\r\nimport { andWhere, nowISO, parseFaultsJson } from \"../utils\";\r\nimport { json } from \"../utils/responses\";\r\nimport { loggerForRequest } from \"../utils/logging\";\r\nimport { validationErrorResponse, validateWithSchema } from \"../utils/validation\";\r\n\r\ntype TelemetryIncludeFlags = TelemetryLatestBatchInput[\"include\"];\r\n\r\nconst LATEST_BATCH_CHUNK = 100;\r\nconst METRICS_WITH_EXTENTS = new Set<Readonly<typeof TELEMETRY_ALLOWED_METRICS>[number]>([\r\n  \"deltaT\",\r\n  \"thermalKW\",\r\n  \"cop\",\r\n]);\r\n\r\ninterface LatestStateRow {\r\n  device_id: string;\r\n  ts: number | null;\r\n  updated_at: string | null;\r\n  supplyC: number | null;\r\n  returnC: number | null;\r\n  tankC: number | null;\r\n  ambientC: number | null;\r\n  flowLps: number | null;\r\n  compCurrentA: number | null;\r\n  eevSteps: number | null;\r\n  powerKW: number | null;\r\n  deltaT: number | null;\r\n  thermalKW: number | null;\r\n  cop: number | null;\r\n  cop_quality: string | null;\r\n  mode: string | null;\r\n  defrost: number | null;\r\n  latest_online: number | null;\r\n  faults_json: string | null;\r\n  payload_json: string | null;\r\n  profile_id: string | null;\r\n  site: string | null;\r\n  device_online: number | null;\r\n  last_seen_at: string | null;\r\n}\r\n\r\ninterface SeriesRow {\r\n  bucket_start_ms: number;\r\n  sample_count: number;\r\n  avg_deltaT: number | null;\r\n  min_deltaT: number | null;\r\n  max_deltaT: number | null;\r\n  avg_thermalKW: number | null;\r\n  min_thermalKW: number | null;\r\n  max_thermalKW: number | null;\r\n  avg_cop: number | null;\r\n  min_cop: number | null;\r\n  max_cop: number | null;\r\n  avg_supplyC: number | null;\r\n  avg_returnC: number | null;\r\n  avg_flowLps: number | null;\r\n  avg_powerKW: number | null;\r\n}\r\n\r\nexport async function legacyHandleTelemetryLatestBatch(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  let payload: unknown;\r\n  try {\r\n    payload = await req.json();\r\n  } catch {\r\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\r\n  }\r\n\r\n  const parsed = validateWithSchema<TelemetryLatestBatchInput>(TelemetryLatestBatchSchema, payload);\r\n  if (!parsed.success) {\r\n    return validationErrorResponse(parsed.issues);\r\n  }\r\n\r\n  const body = parsed.data;\r\n  const scope = buildDeviceScope(user);\r\n\r\n  if (body.devices.length === 0) {\r\n    return json({ generated_at: nowISO(), items: [], missing: [] });\r\n  }\r\n\r\n  if (scope.empty && !scope.isAdmin) {\r\n    return json({\r\n      generated_at: nowISO(),\r\n      items: [],\r\n      missing: [...new Set(body.devices)],\r\n    });\r\n  }\r\n\r\n  type RequestedDevice = {\r\n    token: string;\r\n    index: number;\r\n    resolved: string | null;\r\n  };\r\n\r\n  const requested: RequestedDevice[] = body.devices.map(\r\n    (token: string, index: number): RequestedDevice => ({\r\n      token,\r\n      index,\r\n      resolved: null,\r\n    }),\r\n  );\r\n\r\n  const isResolved = (\r\n    entry: RequestedDevice,\r\n  ): entry is RequestedDevice & { resolved: string } => entry.resolved !== null;\r\n\r\n  const missing: string[] = [];\r\n  for (const entry of requested) {\r\n    const resolved = await resolveDeviceId(entry.token, env, scope.isAdmin);\r\n    if (!resolved) {\r\n      missing.push(entry.token);\r\n      continue;\r\n    }\r\n    entry.resolved = resolved;\r\n  }\r\n\r\n  const resolvedIds = Array.from(new Set(requested.filter(isResolved).map((r) => r.resolved)));\r\n\r\n  if (!resolvedIds.length) {\r\n    return json({\r\n      generated_at: nowISO(),\r\n      items: [],\r\n      missing: dedupePreserveOrder(body.devices, missing),\r\n    });\r\n  }\r\n\r\n  const rows = await fetchLatestRows(env, resolvedIds, scope);\r\n  const rowMap = new Map<string, LatestStateRow>();\r\n  for (const row of rows) {\r\n    rowMap.set(row.device_id, row);\r\n  }\r\n\r\n  const items = [];\r\n  const seen = new Set<string>();\r\n  const missingTokens = new Set<string>(missing);\r\n\r\n  for (const entry of requested) {\r\n    if (!entry.resolved) {\r\n      continue;\r\n    }\r\n    if (seen.has(entry.resolved)) {\r\n      continue;\r\n    }\r\n    const row = rowMap.get(entry.resolved);\r\n    if (!row) {\r\n      missingTokens.add(entry.token);\r\n      continue;\r\n    }\r\n    seen.add(entry.resolved);\r\n    try {\r\n      const formatted = await presentLatestRow(\r\n        row,\r\n        env,\r\n        userIsAdmin(user),\r\n        body.include ?? { faults: true, metrics: true },\r\n      );\r\n      items.push(formatted);\r\n    } catch (error) {\r\n      loggerForRequest(req, { route: \"/api/telemetry/latest-batch\" }).error(\r\n        \"telemetry.latest_batch.present_failed\",\r\n        { error, device_id: entry.resolved },\r\n      );\r\n    }\r\n  }\r\n\r\n  return json({\r\n    generated_at: nowISO(),\r\n    items,\r\n    missing: dedupePreserveOrder(body.devices, Array.from(missingTokens)),\r\n  });\r\n}\r\n\r\nexport async function legacyHandleTelemetrySeries(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const url = new URL(req.url);\r\n  const rawQuery: Record<string, string | null> = {};\r\n  const searchEntries = url.searchParams as any;\r\n  for (const [key, value] of searchEntries) {\r\n    rawQuery[key] = value;\r\n  }\r\n  const parsed = TelemetrySeriesQuerySchema.safeParse(rawQuery);\r\n  if (!parsed.success) {\r\n    return validationErrorResponse(parsed.error);\r\n  }\r\n\r\n  const result = await resolveSeriesConfig(parsed.data, env, user);\r\n  if (!result.ok) {\r\n    if (result.status === 400) {\r\n      return json({ error: result.error }, { status: 400 });\r\n    }\r\n    if (result.status === 403) {\r\n      return json({ error: \"Forbidden\" }, { status: 403 });\r\n    }\r\n    if (result.status === 404) {\r\n      return json({ error: \"Not found\" }, { status: 404 });\r\n    }\r\n    return json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n\r\n  const { config } = result;\r\n  const query = buildSeriesSql(config.whereClause);\r\n  const bindings = [config.bucketMs, config.startMs, config.endMs, ...config.bindings];\r\n\r\n  const rows = await env.DB.prepare(query).bind(...bindings).all<SeriesRow>();\r\n  const bucketRows = rows.results ?? [];\r\n\r\n  const series = buildSeriesResponse(bucketRows, {\r\n    startMs: config.startMs,\r\n    endMs: config.endMs,\r\n    bucketMs: config.bucketMs,\r\n    metrics: config.metrics,\r\n    fillMode: config.fillMode,\r\n    isAdmin: userIsAdmin(user),\r\n    tenantPrecision: config.tenantPrecision,\r\n  });\r\n\r\n  return json({\r\n    generated_at: nowISO(),\r\n    scope: config.scopeDescriptor,\r\n    interval_ms: config.bucketMs,\r\n    window: {\r\n      start: new Date(config.startMs).toISOString(),\r\n      end: new Date(config.endMs).toISOString(),\r\n    },\r\n    metrics: config.metrics,\r\n    series,\r\n  });\r\n}\r\n\r\ninterface SeriesConfig {\r\n  bucketMs: number;\r\n  startMs: number;\r\n  endMs: number;\r\n  metrics: (typeof TELEMETRY_ALLOWED_METRICS)[number][];\r\n  whereClause: string;\r\n  bindings: any[];\r\n  scopeDescriptor: UnifiedScopeDescriptor;\r\n  fillMode: \"carry\" | \"none\";\r\n  tenantPrecision: number;\r\n}\r\n\r\ntype SeriesConfigResult =\r\n  | { ok: true; config: SeriesConfig }\r\n  | { ok: false; status: 400 | 403 | 404 | 500; error: string };\r\n\r\ninterface DeviceScopeDescriptor {\r\n  type: \"device\";\r\n  device_id: string;\r\n  lookup: string;\r\n}\r\n\r\ninterface ProfileScopeDescriptor {\r\n  type: \"profile\";\r\n  profile_ids: string[];\r\n}\r\n\r\ninterface FleetScopeDescriptor {\r\n  type: \"fleet\";\r\n  profile_ids: string[] | null;\r\n}\r\n\r\ntype UnifiedScopeDescriptor = DeviceScopeDescriptor | ProfileScopeDescriptor | FleetScopeDescriptor;\r\n\r\nasync function resolveSeriesConfig(\r\n  params: TelemetrySeriesQuery,\r\n  env: Env,\r\n  user: User,\r\n): Promise<SeriesConfigResult> {\r\n  const metrics = resolveMetrics(params.metric);\r\n  if (!metrics.length) {\r\n    return { ok: false, status: 400, error: \"Invalid metrics\" };\r\n  }\r\n\r\n  const bucketMs = resolveInterval(params.interval ?? \"5m\");\r\n  if (!bucketMs) {\r\n    return { ok: false, status: 400, error: \"Invalid interval\" };\r\n  }\r\n\r\n  const now = Date.now();\r\n  const endMs = clampTimestamp(params.end, now);\r\n  if (endMs === null) {\r\n    return { ok: false, status: 400, error: \"Invalid end timestamp\" };\r\n  }\r\n\r\n  const defaultStart = endMs - 24 * 60 * 60 * 1000;\r\n  let startMs = clampTimestamp(params.start, defaultStart);\r\n  if (startMs === null) {\r\n    return { ok: false, status: 400, error: \"Invalid start timestamp\" };\r\n  }\r\n\r\n  if (startMs >= endMs) {\r\n    return { ok: false, status: 400, error: \"Start must be before end\" };\r\n  }\r\n\r\n  const limit = params.limit ?? 288;\r\n  const maxWindow = limit * bucketMs;\r\n  if (endMs - startMs > maxWindow) {\r\n    startMs = endMs - maxWindow;\r\n  }\r\n\r\n  const scope = buildDeviceScope(user, \"d\");\r\n  const isAdmin = scope.isAdmin;\r\n  const fillMode = params.fill === \"carry\" ? \"carry\" : \"none\";\r\n  const tenantPrecision = isAdmin ? 4 : 2;\r\n\r\n  const conditions: string[] = [\"t.ts BETWEEN params.start_ms AND params.end_ms\"];\r\n  const bindings: any[] = [];\r\n  let scopeDescriptor: UnifiedScopeDescriptor;\r\n\r\n  if (params.scope === \"device\") {\r\n    if (!params.device) {\r\n      return { ok: false, status: 400, error: \"Device parameter is required for device scope\" };\r\n    }\r\n    const resolvedId = await resolveDeviceId(params.device, env, isAdmin);\r\n    if (!resolvedId) {\r\n      return { ok: false, status: 404, error: \"Device not found\" };\r\n    }\r\n\r\n    const row = await env.DB\r\n      .prepare(`SELECT device_id, profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\r\n      .bind(resolvedId)\r\n      .first<{ device_id: string; profile_id: string | null }>();\r\n    if (!row) {\r\n      return { ok: false, status: 404, error: \"Device not found\" };\r\n    }\r\n\r\n    if (!isAdmin) {\r\n      const allowed = (scope.bind as string[]) ?? [];\r\n      if (!allowed.includes(row.profile_id ?? \"\")) {\r\n        return { ok: false, status: 403, error: \"Forbidden\" };\r\n      }\r\n    }\r\n\r\n    conditions.push(\"t.device_id = ?\");\r\n    bindings.push(row.device_id);\r\n\r\n    const outwardId = presentDeviceId(row.device_id, isAdmin);\r\n    const lookup = await buildDeviceLookup(row.device_id, env, isAdmin);\r\n    scopeDescriptor = { type: \"device\", device_id: outwardId, lookup };\r\n  } else if (params.scope === \"profile\") {\r\n    if (isAdmin) {\r\n      if (!params.profile) {\r\n        return { ok: false, status: 400, error: \"Profile parameter is required for profile scope\" };\r\n      }\r\n      const clause = buildInClause(\"d.profile_id\", [params.profile]);\r\n      conditions.push(clause);\r\n      bindings.push(params.profile);\r\n      scopeDescriptor = { type: \"profile\", profile_ids: [params.profile] };\r\n    } else {\r\n      const allowed = (scope.bind as string[]) ?? [];\r\n      if (!allowed.length) {\r\n        conditions.push(\"1=0\");\r\n        scopeDescriptor = { type: \"profile\", profile_ids: [] };\r\n      } else {\r\n        let selected: string[];\r\n        if (params.profile) {\r\n          if (!allowed.includes(params.profile)) {\r\n            return { ok: false, status: 403, error: \"Forbidden\" };\r\n          }\r\n          selected = [params.profile];\r\n        } else if (allowed.length === 1) {\r\n          selected = [...allowed];\r\n        } else {\r\n          return { ok: false, status: 400, error: \"Profile parameter required for scoped users\" };\r\n        }\r\n        const clause = buildInClause(\"d.profile_id\", selected);\r\n        conditions.push(clause);\r\n        bindings.push(...selected);\r\n        scopeDescriptor = { type: \"profile\", profile_ids: selected };\r\n      }\r\n    }\r\n  } else {\r\n    // fleet scope\r\n    if (isAdmin) {\r\n      if (params.profile) {\r\n        const clause = buildInClause(\"d.profile_id\", [params.profile]);\r\n        conditions.push(clause);\r\n        bindings.push(params.profile);\r\n        scopeDescriptor = { type: \"fleet\", profile_ids: [params.profile] };\r\n      } else {\r\n        scopeDescriptor = { type: \"fleet\", profile_ids: null };\r\n      }\r\n    } else {\r\n      const allowed = (scope.bind as string[]) ?? [];\r\n      if (!allowed.length) {\r\n        conditions.push(\"1=0\");\r\n        scopeDescriptor = { type: \"fleet\", profile_ids: [] };\r\n      } else {\r\n        let selected = [...allowed];\r\n        if (params.profile) {\r\n          if (!allowed.includes(params.profile)) {\r\n            return { ok: false, status: 403, error: \"Forbidden\" };\r\n          }\r\n          selected = [params.profile];\r\n        }\r\n        const clause = buildInClause(\"d.profile_id\", selected);\r\n        conditions.push(clause);\r\n        bindings.push(...selected);\r\n        scopeDescriptor = { type: \"fleet\", profile_ids: selected };\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!isAdmin && scope.clause) {\r\n    conditions.push(scope.clause);\r\n    bindings.push(...scope.bind);\r\n  }\r\n\r\n  const whereClause = conditions.join(\" AND \");\r\n\r\n  return {\r\n    ok: true,\r\n    config: {\r\n      bucketMs,\r\n      startMs,\r\n      endMs,\r\n      metrics,\r\n      whereClause,\r\n      bindings,\r\n      scopeDescriptor,\r\n      fillMode,\r\n      tenantPrecision,\r\n    },\r\n  };\r\n}\r\n\r\nfunction resolveMetrics(csv: string | undefined | null) {\r\n  if (!csv) return [...TELEMETRY_ALLOWED_METRICS];\r\n  const parts = csv\r\n    .split(\",\")\r\n    .map((part) => part.trim())\r\n    .filter(Boolean) as (typeof TELEMETRY_ALLOWED_METRICS)[number][];\r\n  const allowed = new Set(TELEMETRY_ALLOWED_METRICS);\r\n  return parts.filter((part) => allowed.has(part));\r\n}\r\n\r\nfunction resolveInterval(interval: string | undefined) {\r\n  if (!interval) return TELEMETRY_INTERVALS_MS[\"5m\"];\r\n  return TELEMETRY_INTERVALS_MS[interval] ?? null;\r\n}\r\n\r\nfunction clampTimestamp(value: string | number | null | undefined, fallback: number): number | null {\r\n  if (value == null) return fallback;\r\n  if (typeof value === \"number\") return Number.isFinite(value) ? value : null;\r\n  const trimmed = String(value).trim();\r\n  if (!trimmed) return fallback;\r\n  if (/^\\d+$/.test(trimmed)) {\r\n    const parsed = Number.parseInt(trimmed, 10);\r\n    return Number.isNaN(parsed) ? null : parsed;\r\n  }\r\n  const parsed = Date.parse(trimmed);\r\n  return Number.isNaN(parsed) ? null : parsed;\r\n}\r\n\r\nfunction buildInClause(column: string, values: string[]) {\r\n  if (!values.length) return \"1=0\";\r\n  const placeholders = values.map(() => \"?\").join(\",\");\r\n  return `${column} IN (${placeholders})`;\r\n}\r\n\r\nfunction buildSeriesSql(whereClause: string) {\r\n  return `\r\n    WITH params AS (\r\n      SELECT ? AS bucket_ms, ? AS start_ms, ? AS end_ms\r\n    ),\r\n    scoped AS (\r\n      SELECT\r\n        (CAST(t.ts / params.bucket_ms AS INTEGER) * params.bucket_ms) AS bucket_start_ms,\r\n        t.device_id,\r\n        t.deltaT,\r\n        t.thermalKW,\r\n        t.cop,\r\n        json_extract(t.metrics_json, '$.supplyC') AS supplyC,\r\n        json_extract(t.metrics_json, '$.returnC') AS returnC,\r\n        json_extract(t.metrics_json, '$.flowLps') AS flowLps,\r\n        json_extract(t.metrics_json, '$.powerKW') AS powerKW\r\n      FROM telemetry t\r\n      JOIN devices d ON d.device_id = t.device_id\r\n      JOIN params\r\n      WHERE ${whereClause}\r\n    ),\r\n    per_device AS (\r\n      SELECT\r\n        bucket_start_ms,\r\n        device_id,\r\n        COUNT(*) AS sample_count,\r\n        AVG(deltaT) AS avg_deltaT,\r\n        MIN(deltaT) AS min_deltaT,\r\n        MAX(deltaT) AS max_deltaT,\r\n        AVG(thermalKW) AS avg_thermalKW,\r\n        MIN(thermalKW) AS min_thermalKW,\r\n        MAX(thermalKW) AS max_thermalKW,\r\n        AVG(cop) AS avg_cop,\r\n        MIN(cop) AS min_cop,\r\n        MAX(cop) AS max_cop,\r\n        AVG(supplyC) AS avg_supplyC,\r\n        AVG(returnC) AS avg_returnC,\r\n        AVG(flowLps) AS avg_flowLps,\r\n        AVG(powerKW) AS avg_powerKW\r\n      FROM scoped\r\n      GROUP BY bucket_start_ms, device_id\r\n    ),\r\n    aggregated AS (\r\n      SELECT\r\n        bucket_start_ms,\r\n        SUM(sample_count) AS sample_count,\r\n        AVG(avg_deltaT) AS avg_deltaT,\r\n        MIN(min_deltaT) AS min_deltaT,\r\n        MAX(max_deltaT) AS max_deltaT,\r\n        AVG(avg_thermalKW) AS avg_thermalKW,\r\n        MIN(min_thermalKW) AS min_thermalKW,\r\n        MAX(max_thermalKW) AS max_thermalKW,\r\n        AVG(avg_cop) AS avg_cop,\r\n        MIN(min_cop) AS min_cop,\r\n        MAX(max_cop) AS max_cop,\r\n        AVG(avg_supplyC) AS avg_supplyC,\r\n        AVG(avg_returnC) AS avg_returnC,\r\n        AVG(avg_flowLps) AS avg_flowLps,\r\n        AVG(avg_powerKW) AS avg_powerKW\r\n      FROM per_device\r\n      GROUP BY bucket_start_ms\r\n    )\r\n    SELECT *\r\n    FROM aggregated\r\n    ORDER BY bucket_start_ms ASC\r\n  `;\r\n}\r\n\r\nasync function fetchLatestRows(\r\n  env: Env,\r\n  deviceIds: string[],\r\n  scope: ReturnType<typeof buildDeviceScope>,\r\n) {\r\n  const rows: LatestStateRow[] = [];\r\n  for (let i = 0; i < deviceIds.length; i += LATEST_BATCH_CHUNK) {\r\n    const chunk = deviceIds.slice(i, i + LATEST_BATCH_CHUNK);\r\n    const placeholders = chunk.map(() => \"?\").join(\",\");\r\n    let where = `ls.device_id IN (${placeholders})`;\r\n    const bind: any[] = [...chunk];\r\n\r\n    if (!scope.isAdmin && scope.clause) {\r\n      where = andWhere(where, scope.clause.replace(/^WHERE\\s+/i, \"\"));\r\n      bind.push(...scope.bind);\r\n    }\r\n\r\n    const query = `\r\n      SELECT\r\n        ls.device_id,\r\n        ls.ts,\r\n        ls.updated_at,\r\n        ls.supplyC,\r\n        ls.returnC,\r\n        ls.tankC,\r\n        ls.ambientC,\r\n        ls.flowLps,\r\n        ls.compCurrentA,\r\n        ls.eevSteps,\r\n        ls.powerKW,\r\n        ls.deltaT,\r\n        ls.thermalKW,\r\n        ls.cop,\r\n        ls.cop_quality,\r\n        ls.mode,\r\n        ls.defrost,\r\n        ls.online AS latest_online,\r\n        ls.faults_json,\r\n        ls.payload_json,\r\n        d.profile_id,\r\n        d.site,\r\n        d.online AS device_online,\r\n        d.last_seen_at\r\n      FROM latest_state ls\r\n      JOIN devices d ON d.device_id = ls.device_id\r\n      WHERE ${where}\r\n    `;\r\n\r\n    const result = await env.DB.prepare(query).bind(...bind).all<LatestStateRow>();\r\n    rows.push(...(result.results ?? []));\r\n  }\r\n  return rows;\r\n}\r\n\r\nasync function presentLatestRow(\r\n  row: LatestStateRow,\r\n  env: Env,\r\n  isAdmin: boolean,\r\n  include: TelemetryIncludeFlags,\r\n) {\r\n  const lookup = await buildDeviceLookup(row.device_id, env, isAdmin);\r\n  const outwardId = presentDeviceId(row.device_id, isAdmin);\r\n  const payload = safeParseJson(row.payload_json);\r\n  const latest: Record<string, unknown> = {\r\n    ts: row.ts ?? null,\r\n    updated_at: row.updated_at ?? null,\r\n    online: row.latest_online === 1,\r\n    mode: row.mode ?? null,\r\n    defrost: row.defrost ?? null,\r\n    cop_quality: row.cop_quality ?? null,\r\n    payload,\r\n  };\r\n\r\n  if (include.metrics !== false) {\r\n    latest.supplyC = maskTelemetryNumber(row.supplyC, isAdmin);\r\n    latest.returnC = maskTelemetryNumber(row.returnC, isAdmin);\r\n    latest.tankC = maskTelemetryNumber(row.tankC, isAdmin);\r\n    latest.ambientC = maskTelemetryNumber(row.ambientC, isAdmin);\r\n    latest.flowLps = maskTelemetryNumber(row.flowLps, isAdmin, 3);\r\n    latest.compCurrentA = maskTelemetryNumber(row.compCurrentA, isAdmin, 2);\r\n    latest.eevSteps = maskTelemetryNumber(row.eevSteps, isAdmin, 0);\r\n    latest.powerKW = maskTelemetryNumber(row.powerKW, isAdmin, 3);\r\n    latest.deltaT = maskTelemetryNumber(row.deltaT, isAdmin, 2);\r\n    latest.thermalKW = maskTelemetryNumber(row.thermalKW, isAdmin, 3);\r\n    latest.cop = maskTelemetryNumber(row.cop, isAdmin, 2);\r\n  }\r\n\r\n  if (include.faults !== false) {\r\n    latest.faults = parseFaultsJson(row.faults_json);\r\n  }\r\n\r\n  return {\r\n    lookup,\r\n    device_id: outwardId,\r\n    profile_id: row.profile_id ?? null,\r\n    site: row.site ?? null,\r\n    online: row.device_online === 1,\r\n    last_seen_at: row.last_seen_at ?? null,\r\n    latest,\r\n  };\r\n}\r\ninterface BuildSeriesOptions {\r\n  startMs: number;\r\n  endMs: number;\r\n  bucketMs: number;\r\n  metrics: readonly (typeof TELEMETRY_ALLOWED_METRICS)[number][];\r\n  fillMode: \"carry\" | \"none\";\r\n  isAdmin: boolean;\r\n  tenantPrecision: number;\r\n}\r\n\r\nfunction buildSeriesResponse(rows: SeriesRow[], options: BuildSeriesOptions) {\r\n  const { startMs, endMs, bucketMs, metrics, fillMode, isAdmin, tenantPrecision } = options;\r\n\r\n  const map = new Map<number, SeriesRow>();\r\n  for (const row of rows) {\r\n    map.set(row.bucket_start_ms, row);\r\n  }\r\n\r\n  const startBucket = Math.floor(startMs / bucketMs) * bucketMs;\r\n  const endBucket = Math.floor(endMs / bucketMs) * bucketMs;\r\n\r\n  const buckets: SeriesRow[] = [];\r\n\r\n  if (fillMode === \"carry\") {\r\n    let current = startBucket;\r\n    let lastValues: Record<string, number | null> | null = null;\r\n\r\n    while (current <= endBucket) {\r\n      const row = map.get(current);\r\n      if (row) {\r\n        buckets.push(row);\r\n        lastValues = captureLastValues(row);\r\n      } else if (lastValues) {\r\n        buckets.push({\r\n          bucket_start_ms: current,\r\n          sample_count: 0,\r\n          avg_deltaT: lastValues.deltaT,\r\n          min_deltaT: lastValues.deltaT,\r\n          max_deltaT: lastValues.deltaT,\r\n          avg_thermalKW: lastValues.thermalKW,\r\n          min_thermalKW: lastValues.thermalKW,\r\n          max_thermalKW: lastValues.thermalKW,\r\n          avg_cop: lastValues.cop,\r\n          min_cop: lastValues.cop,\r\n          max_cop: lastValues.cop,\r\n          avg_supplyC: lastValues.supplyC,\r\n          avg_returnC: lastValues.returnC,\r\n          avg_flowLps: lastValues.flowLps,\r\n          avg_powerKW: lastValues.powerKW,\r\n        });\r\n      }\r\n      current += bucketMs;\r\n    }\r\n  } else {\r\n    buckets.push(...rows);\r\n  }\r\n\r\n  return buckets.map((row) => ({\r\n    bucket_start: new Date(row.bucket_start_ms).toISOString(),\r\n    sample_count: row.sample_count,\r\n    values: buildMetricValues(row, metrics, isAdmin, tenantPrecision),\r\n  }));\r\n}\r\n\r\nfunction captureLastValues(row: SeriesRow) {\r\n  return {\r\n    deltaT: row.avg_deltaT,\r\n    thermalKW: row.avg_thermalKW,\r\n    cop: row.avg_cop,\r\n    supplyC: row.avg_supplyC,\r\n    returnC: row.avg_returnC,\r\n    flowLps: row.avg_flowLps,\r\n    powerKW: row.avg_powerKW,\r\n  };\r\n}\r\n\r\nfunction buildMetricValues(\r\n  row: SeriesRow,\r\n  metrics: readonly (typeof TELEMETRY_ALLOWED_METRICS)[number][],\r\n  isAdmin: boolean,\r\n  tenantPrecision: number,\r\n) {\r\n  const values: Record<string, Record<string, number | null>> = {};\r\n  for (const metric of metrics) {\r\n    const entry: Record<string, number | null> = {};\r\n    const avg = averageForMetric(row, metric);\r\n    entry.avg = maskTelemetryNumber(avg, isAdmin, tenantPrecision, 4);\r\n\r\n    if (METRICS_WITH_EXTENTS.has(metric)) {\r\n      const minVal = minForMetric(row, metric);\r\n      const maxVal = maxForMetric(row, metric);\r\n      entry.min = maskTelemetryNumber(minVal, isAdmin, tenantPrecision, 4);\r\n      entry.max = maskTelemetryNumber(maxVal, isAdmin, tenantPrecision, 4);\r\n    }\r\n\r\n    values[metric] = entry;\r\n  }\r\n  return values;\r\n}\r\n\r\nfunction averageForMetric(row: SeriesRow, metric: typeof TELEMETRY_ALLOWED_METRICS[number]) {\r\n  switch (metric) {\r\n    case \"deltaT\":\r\n      return row.avg_deltaT;\r\n    case \"thermalKW\":\r\n      return row.avg_thermalKW;\r\n    case \"cop\":\r\n      return row.avg_cop;\r\n    case \"supplyC\":\r\n      return row.avg_supplyC;\r\n    case \"returnC\":\r\n      return row.avg_returnC;\r\n    case \"flowLps\":\r\n      return row.avg_flowLps;\r\n    case \"powerKW\":\r\n      return row.avg_powerKW;\r\n    default:\r\n      return null;\r\n  }\r\n}\r\n\r\nfunction minForMetric(row: SeriesRow, metric: typeof TELEMETRY_ALLOWED_METRICS[number]) {\r\n  switch (metric) {\r\n    case \"deltaT\":\r\n      return row.min_deltaT;\r\n    case \"thermalKW\":\r\n      return row.min_thermalKW;\r\n    case \"cop\":\r\n      return row.min_cop;\r\n    default:\r\n      return null;\r\n  }\r\n}\r\n\r\nfunction maxForMetric(row: SeriesRow, metric: typeof TELEMETRY_ALLOWED_METRICS[number]) {\r\n  switch (metric) {\r\n    case \"deltaT\":\r\n      return row.max_deltaT;\r\n    case \"thermalKW\":\r\n      return row.max_thermalKW;\r\n    case \"cop\":\r\n      return row.max_cop;\r\n    default:\r\n      return null;\r\n  }\r\n}\r\n\r\nfunction safeParseJson(payload: string | null | undefined) {\r\n  if (!payload) return null;\r\n  try {\r\n    return JSON.parse(payload);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction dedupePreserveOrder(requested: string[], extra: string[]) {\r\n  const seen = new Set<string>();\r\n  const output: string[] = [];\r\n  const extraSet = new Set(extra);\r\n  for (const token of requested) {\r\n    if (extraSet.has(token) && !seen.has(token)) {\r\n      seen.add(token);\r\n      output.push(token);\r\n    }\r\n  }\r\n  for (const token of extra) {\r\n    if (!seen.has(token)) {\r\n      seen.add(token);\r\n      output.push(token);\r\n    }\r\n  }\r\n  return output;\r\n}\r\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser, userIsAdmin } from \"../lib/access\";\r\nimport {\r\n  TelemetryLatestBatchSchema,\r\n  TelemetrySeriesQuerySchema,\r\n  TELEMETRY_ALLOWED_METRICS,\r\n  type TelemetryLatestBatchInput,\r\n} from \"../schemas/telemetry\";\r\nimport { nowISO } from \"../utils\";\r\nimport { json } from \"../utils/responses\";\r\nimport { loggerForRequest } from \"../utils/logging\";\r\nimport { validationErrorResponse, validateWithSchema } from \"../utils/validation\";\r\nimport {\r\n  resolveLatestBatchDevices,\r\n  presentLatestBatchRow,\r\n  resolveTelemetrySeriesConfig,\r\n} from \"../lib/telemetry-access\";\r\nimport {\r\n  fetchLatestTelemetryBatch,\r\n  fetchTelemetrySeries,\r\n  type TelemetrySeriesRow,\r\n} from \"../lib/telemetry-store\";\r\nimport { maskTelemetryNumber } from \"../telemetry\";\r\nimport {\r\n  legacyHandleTelemetryLatestBatch,\r\n  legacyHandleTelemetrySeries,\r\n} from \"./telemetry.legacy\";\r\n\r\ntype TelemetryIncludeFlags = TelemetryLatestBatchInput[\"include\"];\r\ntype TelemetryFeatureMode = \"refactor\" | \"legacy\" | \"compare\";\r\n\r\nconst METRICS_WITH_EXTENTS = new Set<Readonly<typeof TELEMETRY_ALLOWED_METRICS>[number]>([\n  \"deltaT\",\n  \"thermalKW\",\n  \"cop\",\n]);\nexport const DEFAULT_CARRY_FORWARD_MINUTES = 30;\n\nexport function resolveCarryForwardLimitMs(env: Env): number {\n  const raw =\n    typeof env.TELEMETRY_CARRY_MAX_MINUTES === \"string\"\n      ? env.TELEMETRY_CARRY_MAX_MINUTES.trim()\n      : \"\";\n  if (raw) {\n    const parsed = Number.parseInt(raw, 10);\n    if (Number.isFinite(parsed) && parsed > 0) {\n      return parsed * 60 * 1000;\n    }\n  }\n  return DEFAULT_CARRY_FORWARD_MINUTES * 60 * 1000;\n}\n\r\nexport async function handleTelemetryLatestBatch(req: Request, env: Env, ctx?: ExecutionContext) {\r\n  const mode = getTelemetryFeatureMode(env);\r\n  if (mode === \"legacy\") {\r\n    return legacyHandleTelemetryLatestBatch(req, env);\r\n  }\r\n\r\n  const shadowReq = mode === \"compare\" ? req.clone() : null;\r\n\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  let payload: unknown;\r\n  try {\r\n    payload = await req.json();\r\n  } catch {\r\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\r\n  }\r\n\r\n  const parsed = validateWithSchema<TelemetryLatestBatchInput>(TelemetryLatestBatchSchema, payload);\r\n  if (!parsed.success) {\r\n    return validationErrorResponse(parsed.issues);\r\n  }\r\n\r\n  const body = parsed.data;\r\n  const resolution = await resolveLatestBatchDevices(env, user, body.devices);\r\n  const { scope, requested, resolvedIds, missingTokens } = resolution;\r\n\r\n  if (body.devices.length === 0) {\r\n    const response = json({ generated_at: nowISO(), items: [], missing: [] });\r\n    if (shadowReq) {\r\n      scheduleShadowComparison(\r\n        ctx,\r\n        runLegacyShadowComparison(\r\n          req as Request,\r\n          shadowReq as Request,\r\n          env,\r\n          legacyHandleTelemetryLatestBatch,\r\n          response.clone(),\r\n          \"/api/telemetry/latest-batch\",\r\n        ),\r\n      );\r\n    }\r\n    return response;\r\n  }\r\n\r\n  if (scope.empty && !scope.isAdmin) {\r\n    const response = json({\r\n      generated_at: nowISO(),\r\n      items: [],\r\n      missing: [...new Set(body.devices)],\r\n    });\r\n    if (shadowReq) {\r\n      scheduleShadowComparison(\r\n        ctx,\r\n        runLegacyShadowComparison(\r\n          req as Request,\r\n          shadowReq as Request,\r\n          env,\r\n          legacyHandleTelemetryLatestBatch,\r\n          response.clone(),\r\n          \"/api/telemetry/latest-batch\",\r\n        ),\r\n      );\r\n    }\r\n    return response;\r\n  }\r\n\r\n  if (!resolvedIds.length) {\r\n    const response = json({\r\n      generated_at: nowISO(),\r\n      items: [],\r\n      missing: dedupePreserveOrder(body.devices, missingTokens),\r\n    });\r\n    if (shadowReq) {\r\n      scheduleShadowComparison(\r\n        ctx,\r\n        runLegacyShadowComparison(\r\n          req as Request,\r\n          shadowReq as Request,\r\n          env,\r\n          legacyHandleTelemetryLatestBatch,\r\n          response.clone(),\r\n          \"/api/telemetry/latest-batch\",\r\n        ),\r\n      );\r\n    }\r\n    return response;\r\n  }\r\n\r\n  const rows = await fetchLatestTelemetryBatch(env, resolvedIds, scope);\r\n  const rowMap = new Map(rows.map((row) => [row.device_id, row]));\r\n  const include: TelemetryIncludeFlags = body.include ?? { faults: true, metrics: true };\r\n  const items: unknown[] = [];\r\n  const seen = new Set<string>();\r\n  const missingSet = new Set<string>(missingTokens);\r\n\r\n  for (const entry of requested) {\r\n    if (!entry.resolved) continue;\r\n    if (seen.has(entry.resolved)) continue;\r\n    const row = rowMap.get(entry.resolved);\r\n    if (!row) {\r\n      missingSet.add(entry.token);\r\n      continue;\r\n    }\r\n    seen.add(entry.resolved);\r\n    try {\r\n      const formatted = await presentLatestBatchRow(row, env, include, user);\r\n      items.push(formatted);\r\n    } catch (error) {\r\n      loggerForRequest(req, { route: \"/api/telemetry/latest-batch\" }).error(\r\n        \"telemetry.latest_batch.present_failed\",\r\n        { error, device_id: entry.resolved, mode },\r\n      );\r\n    }\r\n  }\r\n\r\n  const response = json({\r\n    generated_at: nowISO(),\r\n    items,\r\n    missing: dedupePreserveOrder(body.devices, Array.from(missingSet)),\r\n  });\r\n\r\n  if (shadowReq) {\r\n    scheduleShadowComparison(\r\n      ctx,\r\n      runLegacyShadowComparison(\r\n        req as Request,\r\n        shadowReq as Request,\r\n        env,\r\n        legacyHandleTelemetryLatestBatch,\r\n        response.clone(),\r\n        \"/api/telemetry/latest-batch\",\r\n      ),\r\n    );\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\nexport async function handleTelemetrySeries(req: Request, env: Env, ctx?: ExecutionContext) {\r\n  const mode = getTelemetryFeatureMode(env);\r\n  if (mode === \"legacy\") {\r\n    return legacyHandleTelemetrySeries(req, env);\r\n  }\r\n\r\n  const shadowReq = mode === \"compare\" ? req.clone() : null;\r\n\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const url = new URL(req.url);\r\n  const rawQuery: Record<string, string | null> = {};\r\n  const searchEntries = url.searchParams as any;\r\n  for (const [key, value] of searchEntries) {\r\n    rawQuery[key] = value;\r\n  }\r\n  const parsed = TelemetrySeriesQuerySchema.safeParse(rawQuery);\r\n  if (!parsed.success) {\r\n    return validationErrorResponse(parsed.error);\r\n  }\r\n\r\n  const result = await resolveTelemetrySeriesConfig(parsed.data, env, user);\r\n  if (!result.ok) {\r\n    if (result.status === 400) {\r\n      return json({ error: result.error }, { status: 400 });\r\n    }\r\n    if (result.status === 403) {\r\n      return json({ error: \"Forbidden\" }, { status: 403 });\r\n    }\r\n    if (result.status === 404) {\r\n      return json({ error: \"Not found\" }, { status: 404 });\r\n    }\r\n    return json({ error: \"Server error\" }, { status: 500 });\r\n  }\r\n\r\n  const { config } = result;\r\n  const rows = await fetchTelemetrySeries(env, config);\n\n  const carryForwardLimitMs = resolveCarryForwardLimitMs(env);\n  const series = buildSeriesResponse(rows, {\n    startMs: config.startMs,\n    endMs: config.endMs,\n    bucketMs: config.bucketMs,\n    metrics: config.metrics,\n    fillMode: config.fillMode,\n    isAdmin: userIsAdmin(user),\n    tenantPrecision: config.tenantPrecision,\n    carryForwardLimitMs,\n  });\n\r\n  const response = json({\r\n    generated_at: nowISO(),\r\n    scope: config.scopeDescriptor,\r\n    interval_ms: config.bucketMs,\r\n    window: {\r\n      start: new Date(config.startMs).toISOString(),\r\n      end: new Date(config.endMs).toISOString(),\r\n    },\r\n    metrics: config.metrics,\r\n    series,\r\n  });\r\n\r\n  if (shadowReq) {\r\n    scheduleShadowComparison(\r\n      ctx,\r\n      runLegacyShadowComparison(\r\n        req as Request,\r\n        shadowReq as Request,\r\n        env,\r\n        legacyHandleTelemetrySeries,\r\n        response.clone(),\r\n        \"/api/telemetry/series\",\r\n      ),\r\n    );\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\ninterface BuildSeriesOptions {\n  startMs: number;\n  endMs: number;\n  bucketMs: number;\n  metrics: readonly (typeof TELEMETRY_ALLOWED_METRICS)[number][];\n  fillMode: \"carry\" | \"none\";\n  isAdmin: boolean;\n  tenantPrecision: number;\n  carryForwardLimitMs: number;\n}\n\r\nfunction buildSeriesResponse(rows: TelemetrySeriesRow[], options: BuildSeriesOptions) {\n  const {\n    startMs,\n    endMs,\n    bucketMs,\n    metrics,\n    fillMode,\n    isAdmin,\n    tenantPrecision,\n    carryForwardLimitMs,\n  } = options;\n\r\n  const map = new Map<number, TelemetrySeriesRow>();\r\n  for (const row of rows) {\r\n    map.set(row.bucket_start_ms, row);\r\n  }\r\n\r\n  const startBucket = Math.floor(startMs / bucketMs) * bucketMs;\r\n  const endBucket = Math.floor(endMs / bucketMs) * bucketMs;\r\n\r\n  const buckets: Array<{ row: TelemetrySeriesRow; stale: boolean }> = [];\n\n  if (fillMode === \"carry\") {\n    let current = startBucket;\n    let lastValues: Record<string, number | null> | null = null;\n    let lastRealBucketMs: number | null = null;\n\n    while (current <= endBucket) {\n      const row = map.get(current);\n      if (row) {\n        buckets.push({ row, stale: false });\n        lastRealBucketMs = current;\n        lastValues = captureLastValues(row);\n      } else if (lastValues) {\n        if (lastRealBucketMs === null || current - lastRealBucketMs > carryForwardLimitMs) {\n          lastValues = null;\n          lastRealBucketMs = null;\n        } else {\n          const syntheticRow: TelemetrySeriesRow = {\n            bucket_start_ms: current,\n            sample_count: 0,\n            avg_deltaT: lastValues.deltaT,\n            min_deltaT: lastValues.deltaT,\n            max_deltaT: lastValues.deltaT,\n            avg_thermalKW: lastValues.thermalKW,\n            min_thermalKW: lastValues.thermalKW,\n            max_thermalKW: lastValues.thermalKW,\n            avg_cop: lastValues.cop,\n            min_cop: lastValues.cop,\n            max_cop: lastValues.cop,\n            avg_supplyC: lastValues.supplyC,\n            avg_returnC: lastValues.returnC,\n            avg_flowLps: lastValues.flowLps,\n            avg_powerKW: lastValues.powerKW,\n          };\n          buckets.push({ row: syntheticRow, stale: true });\n        }\n      }\n      current += bucketMs;\n    }\n  } else {\n    for (const row of rows) {\n      buckets.push({ row, stale: false });\n    }\n  }\n\n  return buckets.map(({ row, stale }) => ({\n    bucket_start: new Date(row.bucket_start_ms).toISOString(),\n    sample_count: row.sample_count,\n    stale,\n    values: buildMetricValues(row, metrics, isAdmin, tenantPrecision),\n  }));\n}\n\r\nfunction captureLastValues(row: TelemetrySeriesRow) {\r\n  return {\r\n    deltaT: row.avg_deltaT,\r\n    thermalKW: row.avg_thermalKW,\r\n    cop: row.avg_cop,\r\n    supplyC: row.avg_supplyC,\r\n    returnC: row.avg_returnC,\r\n    flowLps: row.avg_flowLps,\r\n    powerKW: row.avg_powerKW,\r\n  };\r\n}\r\n\r\nfunction buildMetricValues(\r\n  row: TelemetrySeriesRow,\r\n  metrics: readonly (typeof TELEMETRY_ALLOWED_METRICS)[number][],\r\n  isAdmin: boolean,\r\n  tenantPrecision: number,\r\n) {\r\n  const values: Record<string, Record<string, number | null>> = {};\r\n  for (const metric of metrics) {\r\n    const entry: Record<string, number | null> = {};\r\n    const avg = averageForMetric(row, metric);\r\n    entry.avg = maskTelemetryNumber(avg, isAdmin, tenantPrecision, 4);\r\n\r\n    if (METRICS_WITH_EXTENTS.has(metric)) {\r\n      const minVal = minForMetric(row, metric);\r\n      const maxVal = maxForMetric(row, metric);\r\n      entry.min = maskTelemetryNumber(minVal, isAdmin, tenantPrecision, 4);\r\n      entry.max = maskTelemetryNumber(maxVal, isAdmin, tenantPrecision, 4);\r\n    }\r\n\r\n    values[metric] = entry;\r\n  }\r\n  return values;\r\n}\r\n\r\nfunction averageForMetric(row: TelemetrySeriesRow, metric: typeof TELEMETRY_ALLOWED_METRICS[number]) {\r\n  switch (metric) {\r\n    case \"deltaT\":\r\n      return row.avg_deltaT;\r\n    case \"thermalKW\":\r\n      return row.avg_thermalKW;\r\n    case \"cop\":\r\n      return row.avg_cop;\r\n    case \"supplyC\":\r\n      return row.avg_supplyC;\r\n    case \"returnC\":\r\n      return row.avg_returnC;\r\n    case \"flowLps\":\r\n      return row.avg_flowLps;\r\n    case \"powerKW\":\r\n      return row.avg_powerKW;\r\n    default:\r\n      return null;\r\n  }\r\n}\r\n\r\nfunction minForMetric(row: TelemetrySeriesRow, metric: typeof TELEMETRY_ALLOWED_METRICS[number]) {\r\n  switch (metric) {\r\n    case \"deltaT\":\r\n      return row.min_deltaT;\r\n    case \"thermalKW\":\r\n      return row.min_thermalKW;\r\n    case \"cop\":\r\n      return row.min_cop;\r\n    default:\r\n      return null;\r\n  }\r\n}\r\n\r\nfunction maxForMetric(row: TelemetrySeriesRow, metric: typeof TELEMETRY_ALLOWED_METRICS[number]) {\r\n  switch (metric) {\r\n    case \"deltaT\":\r\n      return row.max_deltaT;\r\n    case \"thermalKW\":\r\n      return row.max_thermalKW;\r\n    case \"cop\":\r\n      return row.max_cop;\r\n    default:\r\n      return null;\r\n  }\r\n}\r\n\r\nfunction dedupePreserveOrder(requested: string[], extra: string[]) {\r\n  const seen = new Set<string>();\r\n  const output: string[] = [];\r\n  const extraSet = new Set(extra);\r\n  for (const token of requested) {\r\n    if (extraSet.has(token) && !seen.has(token)) {\r\n      seen.add(token);\r\n      output.push(token);\r\n    }\r\n  }\r\n  for (const token of extra) {\r\n    if (!seen.has(token)) {\r\n      seen.add(token);\r\n      output.push(token);\r\n    }\r\n  }\r\n  return output;\r\n}\r\n\r\nfunction getTelemetryFeatureMode(env: Env): TelemetryFeatureMode {\r\n  const raw = String(env.TELEMETRY_REFACTOR_MODE ?? \"\").trim().toLowerCase();\r\n  if (raw === \"legacy\" || raw === \"off\") {\r\n    return \"legacy\";\r\n  }\r\n  if (raw === \"compare\" || raw === \"shadow\" || raw === \"dark\") {\r\n    return \"compare\";\r\n  }\r\n  return \"refactor\";\r\n}\r\n\r\nfunction scheduleShadowComparison(ctx: ExecutionContext | undefined, work: Promise<void>) {\r\n  if (ctx) {\r\n    ctx.waitUntil(work);\r\n  } else {\r\n    void work;\r\n  }\r\n}\r\n\r\nasync function runLegacyShadowComparison(\r\n  req: Request,\r\n  legacyReq: Request,\r\n  env: Env,\r\n  handler: (request: Request, env: Env) => Promise<Response>,\r\n  refactorResponse: Response,\r\n  route: string,\r\n) {\r\n  try {\r\n    const legacyResponse = await handler(legacyReq, env);\r\n    await compareResponses(req, refactorResponse, legacyResponse, route);\r\n  } catch (error) {\r\n    loggerForRequest(req, { route }).warn(\"telemetry.refactor.shadow_failed\", { error });\r\n  }\r\n}\r\n\r\nasync function compareResponses(\r\n  req: Request,\r\n  refactorResponse: Response,\r\n  legacyResponse: Response,\r\n  route: string,\r\n) {\r\n  try {\r\n    const refactorBody = await extractBody(refactorResponse);\r\n    const legacyBody = await extractBody(legacyResponse);\r\n    const statusMismatch = refactorResponse.status !== legacyResponse.status;\r\n    const bodyMismatch = !deepEqual(refactorBody, legacyBody);\r\n    if (statusMismatch || bodyMismatch) {\r\n      loggerForRequest(req, { route }).warn(\"telemetry.refactor.shadow_mismatch\", {\r\n        refactor_status: refactorResponse.status,\r\n        legacy_status: legacyResponse.status,\r\n        refactor_body: refactorBody,\r\n        legacy_body: legacyBody,\r\n      });\r\n    }\r\n  } catch (error) {\r\n    loggerForRequest(req, { route }).warn(\"telemetry.refactor.shadow_compare_failed\", { error });\r\n  }\r\n}\r\n\r\nasync function extractBody(response: Response) {\r\n  const text = await response.text();\r\n  if (!text) return null;\r\n  try {\r\n    return JSON.parse(text);\r\n  } catch {\r\n    return text;\r\n  }\r\n}\r\n\r\nfunction deepEqual(lhs: unknown, rhs: unknown) {\r\n  return JSON.stringify(lhs) === JSON.stringify(rhs);\r\n}\r\n", "import { handleTelemetryLatestBatch, handleTelemetrySeries } from \"../routes/telemetry\";\nimport { withAccess } from \"./access\";\n\nimport type { AppRouter } from \"./params\";\n\nexport function registerTelemetryRoutes(router: AppRouter) {\n  router\n    .post(\n      \"/api/telemetry/latest-batch\",\n      withAccess((req, env, ctx) => handleTelemetryLatestBatch(req, env, ctx)),\n    )\n    .get(\n      \"/api/telemetry/series\",\n      withAccess((req, env, ctx) => handleTelemetrySeries(req, env, ctx)),\n    );\n}\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const ALERT_SEVERITIES = [\"info\", \"warning\", \"critical\"] as const;\nexport const ALERT_STATUSES = [\"open\", \"acknowledged\", \"resolved\"] as const;\nexport const ALERT_ACTIONS = [\"acknowledge\", \"assign\", \"resolve\"] as const;\n\nexport const AlertSeveritySchema = z.enum(ALERT_SEVERITIES);\nexport const AlertStatusSchema = z.enum(ALERT_STATUSES);\nexport const AlertActionSchema = z.enum(ALERT_ACTIONS);\n\nexport const AlertsQuerySchema = z\n  .object({\n    limit: numericParam({ integer: true, min: 1, max: 100, defaultValue: 40 }),\n    hours: numericParam({ integer: true, min: 1, max: 168, defaultValue: 72 }),\n  })\n  .strict();\n\nexport const AlertListQuerySchema = z\n  .object({\n    status: AlertStatusSchema.optional(),\n    severity: AlertSeveritySchema.optional(),\n    device: z.string().trim().min(1).optional(),\n    profile: z.string().trim().min(1).optional(),\n    limit: numericParam({ integer: true, min: 1, max: 200, defaultValue: 50 }),\n    since: z.string().datetime({ offset: true }).optional(),\n    until: z.string().datetime({ offset: true }).optional(),\n  })\n  .strict();\n\nexport const CreateAlertSchema = z\n  .object({\n    alert_id: z.string().trim().min(1).optional(),\n    device_id: z.string().trim().min(1),\n    profile_id: z.string().trim().min(1).optional(),\n    alert_type: z.string().trim().min(1),\n    severity: AlertSeveritySchema.default(\"info\"),\n    status: AlertStatusSchema.default(\"open\"),\n    summary: z.string().trim().min(1).max(240).optional(),\n    description: z.string().trim().min(1).max(4000).optional(),\n    metadata: z.record(z.any()).optional(),\n    acknowledged_at: z.string().datetime({ offset: true }).optional(),\n    resolved_at: z.string().datetime({ offset: true }).nullable().optional(),\n    resolved_by: z.string().trim().min(1).optional(),\n    assigned_to: z.string().trim().min(1).optional(),\n  })\n  .strict();\n\nconst CommentSchema = z\n  .string()\n  .trim()\n  .min(1, \"Comment must not be empty\")\n  .max(2000, \"Comment must be 2000 characters or fewer\");\n\nconst AssigneeSchema = z.string().trim().min(1).max(200);\n\nexport const AlertLifecycleActionSchema = z.discriminatedUnion(\"action\", [\n  z\n    .object({\n      action: z.literal(\"acknowledge\"),\n      comment: CommentSchema.optional(),\n      assignee: AssigneeSchema.optional(),\n    })\n    .strict(),\n  z\n    .object({\n      action: z.literal(\"assign\"),\n      assignee: AssigneeSchema,\n      comment: CommentSchema.optional(),\n    })\n    .strict(),\n  z\n    .object({\n      action: z.literal(\"resolve\"),\n      comment: CommentSchema.optional(),\n    })\n    .strict(),\n]);\n\nexport const AlertCommentCreateSchema = z\n  .object({\n    comment: CommentSchema,\n  })\n  .strict();\n\nexport type AlertsQuery = z.infer<typeof AlertsQuerySchema>;\nexport type AlertListQuery = z.infer<typeof AlertListQuerySchema>;\nexport type CreateAlertInput = z.infer<typeof CreateAlertSchema>;\nexport type AlertLifecycleActionInput = z.infer<typeof AlertLifecycleActionSchema>;\nexport type AlertCommentCreateInput = z.infer<typeof AlertCommentCreateSchema>;\n", "import type { Env } from \"../env\";\nimport { systemLogger } from \"../utils/logging\";\n\nlet foreignKeysEnabled = false;\n\nasync function enableForeignKeys(db: Env[\"DB\"]) {\n  if (foreignKeysEnabled) return;\n  try {\n    await db.prepare(\"PRAGMA foreign_keys = ON\").run();\n    foreignKeysEnabled = true;\n  } catch (error) {\n    systemLogger({ scope: \"db\" }).warn(\"db.enable_foreign_keys_failed\", { error });\n  }\n}\n\nexport async function withTransaction<T>(\n  db: Env[\"DB\"],\n  work: () => Promise<T>,\n): Promise<T> {\n  await enableForeignKeys(db);\n  await db.prepare(\"BEGIN IMMEDIATE\").run();\n  try {\n    const result = await work();\n    await db.prepare(\"COMMIT\").run();\n    return result;\n  } catch (error) {\n    try {\n      await db.prepare(\"ROLLBACK\").run();\n    } catch (rollbackError) {\n      systemLogger({ scope: \"db\" }).error(\"db.transaction_rollback_failed\", {\n        error: rollbackError,\n        original_error: error,\n      });\n    }\n    throw error;\n  }\n}\n", "import type { Env } from \"../env\";\nimport { andWhere, nowISO } from \"../utils\";\nimport { withTransaction } from \"./db\";\n\nexport interface AlertRecord {\n  alert_id: string;\n  device_id: string;\n  profile_id: string | null;\n  alert_type: string;\n  severity: string;\n  status: string;\n  summary: string | null;\n  description: string | null;\n  metadata: Record<string, unknown> | null;\n  acknowledged_at: string | null;\n  resolved_at: string | null;\n  resolved_by: string | null;\n  assigned_to: string | null;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface CreateAlertParams {\n  alert_id?: string;\n  device_id: string;\n  profile_id?: string | null;\n  alert_type: string;\n  severity: string;\n  status: string;\n  summary?: string | null;\n  description?: string | null;\n  metadata?: Record<string, unknown> | null;\n  acknowledged_at?: string | null;\n  resolved_at?: string | null;\n  resolved_by?: string | null;\n  assigned_to?: string | null;\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport type CreateAlertResult =\n  | { ok: true; alert: AlertRecord }\n  | { ok: false; reason: \"device_not_found\" | \"conflict\" };\n\nexport interface AlertListFilters {\n  status?: string;\n  severity?: string;\n  device_id?: string;\n  profile_id?: string;\n  profile_ids?: string[];\n  since?: string;\n  until?: string;\n  limit: number;\n}\n\ninterface AlertRow {\n  alert_id: string;\n  device_id: string;\n  profile_id: string | null;\n  alert_type: string;\n  severity: string;\n  status: string;\n  summary: string | null;\n  description: string | null;\n  metadata_json: string | null;\n  acknowledged_at: string | null;\n  resolved_at: string | null;\n  resolved_by: string | null;\n  assigned_to: string | null;\n  created_at: string;\n  updated_at: string;\n}\n\nfunction mapAlertRow(row: AlertRow): AlertRecord {\n  let metadata: Record<string, unknown> | null = null;\n  if (row.metadata_json) {\n    try {\n      const parsed = JSON.parse(row.metadata_json);\n      if (parsed && typeof parsed === \"object\") metadata = parsed as Record<string, unknown>;\n    } catch {\n      metadata = null;\n    }\n  }\n  return {\n    alert_id: row.alert_id,\n    device_id: row.device_id,\n    profile_id: row.profile_id,\n    alert_type: row.alert_type,\n    severity: row.severity,\n    status: row.status,\n    summary: row.summary,\n    description: row.description,\n    metadata,\n    acknowledged_at: row.acknowledged_at,\n    resolved_at: row.resolved_at,\n    resolved_by: row.resolved_by,\n    assigned_to: row.assigned_to,\n    created_at: row.created_at,\n    updated_at: row.updated_at,\n  };\n}\n\nexport async function createAlert(env: Env, params: CreateAlertParams): Promise<CreateAlertResult> {\n  const deviceId = params.device_id;\n  const id = params.alert_id ?? crypto.randomUUID();\n  const createdAt = params.created_at ?? nowISO();\n  const updatedAt = params.updated_at ?? createdAt;\n  const acknowledgedAt = params.acknowledged_at ?? null;\n  const resolvedAt = params.resolved_at ?? null;\n  const resolvedBy = params.resolved_by ?? null;\n  const assignedTo = params.assigned_to ?? null;\n  const summary = params.summary ?? null;\n  const description = params.description ?? null;\n  const metadataJson = params.metadata ? JSON.stringify(params.metadata) : null;\n\n  let profileId: string | null | undefined = params.profile_id ?? null;\n\n  if (!profileId) {\n    const deviceRow = await env.DB\n      .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n      .bind(deviceId)\n      .first<{ profile_id: string | null }>();\n    if (!deviceRow) {\n      return { ok: false, reason: \"device_not_found\" };\n    }\n    profileId = deviceRow.profile_id ?? null;\n  } else {\n    const exists = await env.DB\n      .prepare(`SELECT 1 FROM devices WHERE device_id = ?1 LIMIT 1`)\n      .bind(deviceId)\n      .first();\n    if (!exists) {\n      return { ok: false, reason: \"device_not_found\" };\n    }\n  }\n\n  try {\n    await env.DB\n      .prepare(\n        `INSERT INTO alerts (\n            alert_id, device_id, profile_id, alert_type, severity, status,\n            summary, description, metadata_json, acknowledged_at, resolved_at,\n            resolved_by, assigned_to, created_at, updated_at\n          ) VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, ?10, ?11, ?12, ?13, ?14, ?15)`,\n      )\n      .bind(\n        id,\n        deviceId,\n        profileId,\n        params.alert_type,\n        params.severity,\n        params.status,\n        summary,\n        description,\n        metadataJson,\n        acknowledgedAt,\n        resolvedAt,\n        resolvedBy,\n        assignedTo,\n        createdAt,\n        updatedAt,\n      )\n      .run();\n  } catch (err: any) {\n    const message = typeof err?.message === \"string\" ? err.message : String(err);\n    if (message.includes(\"UNIQUE constraint failed\")) {\n      return { ok: false, reason: \"conflict\" };\n    }\n    throw err;\n  }\n\n  const row = await env.DB\n    .prepare(`SELECT * FROM alerts WHERE alert_id = ?1 LIMIT 1`)\n    .bind(id)\n    .first<AlertRow>();\n\n  if (!row) {\n    return { ok: false, reason: \"device_not_found\" };\n  }\n\n  return { ok: true, alert: mapAlertRow(row) };\n}\n\nexport async function listAlerts(env: Env, filters: AlertListFilters): Promise<AlertRecord[]> {\n  let where = \"\";\n  const bind: any[] = [];\n\n  if (filters.status) {\n    where = andWhere(where, \"status = ?\");\n    bind.push(filters.status);\n  }\n\n  if (filters.severity) {\n    where = andWhere(where, \"severity = ?\");\n    bind.push(filters.severity);\n  }\n\n  if (filters.device_id) {\n    where = andWhere(where, \"device_id = ?\");\n    bind.push(filters.device_id);\n  }\n\n  if (filters.profile_ids && filters.profile_ids.length) {\n    const placeholders = filters.profile_ids.map(() => \"?\").join(\",\");\n    where = andWhere(where, `profile_id IN (${placeholders})`);\n    bind.push(...filters.profile_ids);\n  } else if (filters.profile_id) {\n    where = andWhere(where, \"profile_id = ?\");\n    bind.push(filters.profile_id);\n  }\n\n  if (filters.since) {\n    where = andWhere(where, \"created_at >= ?\");\n    bind.push(filters.since);\n  }\n\n  if (filters.until) {\n    where = andWhere(where, \"created_at <= ?\");\n    bind.push(filters.until);\n  }\n\n  const sql = `SELECT * FROM alerts ${where} ORDER BY created_at DESC LIMIT ?`;\n  bind.push(filters.limit);\n\n  const rows = await env.DB.prepare(sql).bind(...bind).all<AlertRow>();\n  return (rows.results ?? []).map(mapAlertRow);\n}\n\ninterface AlertCommentRow {\n  comment_id: string;\n  alert_id: string;\n  action: string;\n  author_id: string | null;\n  author_email: string | null;\n  body: string | null;\n  metadata_json: string | null;\n  created_at: string;\n}\n\nexport interface AlertCommentRecord {\n  comment_id: string;\n  alert_id: string;\n  action: string;\n  author_id: string | null;\n  author_email: string | null;\n  body: string | null;\n  metadata: Record<string, unknown> | null;\n  created_at: string;\n}\n\nfunction mapAlertCommentRow(row: AlertCommentRow): AlertCommentRecord {\n  let metadata: Record<string, unknown> | null = null;\n  if (row.metadata_json) {\n    try {\n      const parsed = JSON.parse(row.metadata_json);\n      if (parsed && typeof parsed === \"object\") metadata = parsed as Record<string, unknown>;\n    } catch {\n      metadata = null;\n    }\n  }\n\n  return {\n    comment_id: row.comment_id,\n    alert_id: row.alert_id,\n    action: row.action,\n    author_id: row.author_id,\n    author_email: row.author_email,\n    body: row.body,\n    metadata,\n    created_at: row.created_at,\n  };\n}\n\nexport async function getAlert(env: Env, alertId: string): Promise<AlertRecord | null> {\n  const row = await env.DB\n    .prepare(`SELECT * FROM alerts WHERE alert_id = ?1 LIMIT 1`)\n    .bind(alertId)\n    .first<AlertRow>();\n  if (!row) return null;\n  return mapAlertRow(row);\n}\n\nexport interface AlertLifecycleUpdateBase {\n  alert_id: string;\n  actor_id: string;\n  actor_email?: string | null;\n  comment?: string | null;\n  acknowledged_at?: string | null;\n  resolved_at?: string | null;\n}\n\nexport type AlertLifecycleUpdateParams =\n  | (AlertLifecycleUpdateBase & {\n      action: \"acknowledge\";\n      assignee?: string | null;\n    })\n  | (AlertLifecycleUpdateBase & {\n      action: \"assign\";\n      assignee: string;\n    })\n  | (AlertLifecycleUpdateBase & {\n      action: \"resolve\";\n    });\n\nexport type AlertLifecycleUpdateResult =\n  | { ok: true; alert: AlertRecord; comment: AlertCommentRecord | null }\n  | { ok: false; reason: \"not_found\" };\n\nexport async function updateAlertLifecycle(\n  env: Env,\n  params: AlertLifecycleUpdateParams,\n): Promise<AlertLifecycleUpdateResult> {\n  const current = await env.DB\n    .prepare(`SELECT * FROM alerts WHERE alert_id = ?1 LIMIT 1`)\n    .bind(params.alert_id)\n    .first<AlertRow>();\n  if (!current) {\n    return { ok: false, reason: \"not_found\" };\n  }\n\n  const now = nowISO();\n  const actorEmail = params.actor_email ?? null;\n  let commentMetadata: Record<string, unknown> | null = null;\n  let commentAction = params.action;\n  let commentBody: string | null = params.comment ?? null;\n  let shouldInsertComment = Boolean(params.comment);\n  let assignedTo = current.assigned_to;\n  let acknowledgedAt = current.acknowledged_at;\n  let status = current.status;\n  let resolvedAt = current.resolved_at;\n  let resolvedBy = current.resolved_by;\n\n  if (params.action === \"acknowledge\") {\n    acknowledgedAt = params.acknowledged_at ?? now;\n    if (current.status !== \"resolved\") {\n      status = \"acknowledged\";\n    }\n    if (params.assignee !== undefined) {\n      assignedTo = params.assignee;\n      if (!params.comment) {\n        commentBody = null;\n      }\n      if (params.assignee !== null) {\n        commentMetadata = { assignee: params.assignee };\n      }\n      shouldInsertComment = shouldInsertComment || params.assignee !== undefined;\n    }\n  } else if (params.action === \"assign\") {\n    assignedTo = params.assignee;\n    commentMetadata = { assignee: params.assignee };\n    shouldInsertComment = true;\n    commentAction = \"assign\";\n  } else if (params.action === \"resolve\") {\n    status = \"resolved\";\n    resolvedAt = params.resolved_at ?? now;\n    resolvedBy = params.actor_id;\n    if (!acknowledgedAt) {\n      acknowledgedAt = resolvedAt;\n    }\n  }\n\n  const updateStmt = env.DB\n    .prepare(\n      `UPDATE alerts\n          SET status = ?2,\n              acknowledged_at = ?3,\n              resolved_at = ?4,\n              resolved_by = ?5,\n              assigned_to = ?6,\n              updated_at = ?7\n        WHERE alert_id = ?1`,\n    )\n    .bind(\n      params.alert_id,\n      status,\n      acknowledgedAt,\n      resolvedAt,\n      resolvedBy,\n      assignedTo,\n      now,\n    );\n\n  const statements = [updateStmt];\n  let commentRecord: AlertCommentRecord | null = null;\n\n  if (shouldInsertComment) {\n    const commentId = crypto.randomUUID();\n    const metadataJson = commentMetadata ? JSON.stringify(commentMetadata) : null;\n    const insertStmt = env.DB\n      .prepare(\n        `INSERT INTO alert_comments (\n            comment_id, alert_id, action, author_id, author_email, body, metadata_json, created_at\n          ) VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8)`,\n      )\n      .bind(\n        commentId,\n        params.alert_id,\n        commentAction,\n        params.actor_id,\n        actorEmail,\n        commentBody,\n        metadataJson,\n        now,\n      );\n    statements.push(insertStmt);\n\n    commentRecord = {\n      comment_id: commentId,\n      alert_id: params.alert_id,\n      action: commentAction,\n      author_id: params.actor_id,\n      author_email: actorEmail,\n      body: commentBody,\n      metadata: commentMetadata,\n      created_at: now,\n    };\n  }\n\n  await withTransaction(env.DB, async () => {\n    for (const statement of statements) {\n      await statement.run();\n    }\n  });\n\n  const refreshed = await getAlert(env, params.alert_id);\n  if (!refreshed) {\n    return { ok: false, reason: \"not_found\" };\n  }\n\n  return { ok: true, alert: refreshed, comment: commentRecord };\n}\n\nexport async function listAlertComments(env: Env, alertId: string): Promise<AlertCommentRecord[]> {\n  const rows = await env.DB\n    .prepare(\n      `SELECT * FROM alert_comments WHERE alert_id = ?1 ORDER BY created_at ASC, comment_id ASC`,\n    )\n    .bind(alertId)\n    .all<AlertCommentRow>();\n  return (rows.results ?? []).map(mapAlertCommentRow);\n}\n\nexport async function listAlertCommentsForAlerts(\n  env: Env,\n  alertIds: string[],\n): Promise<Map<string, AlertCommentRecord[]>> {\n  const map = new Map<string, AlertCommentRecord[]>();\n  if (!alertIds.length) {\n    return map;\n  }\n  const unique = [...new Set(alertIds)];\n  const placeholders = unique.map((_, idx) => `?${idx + 1}`).join(\",\");\n  const rows = await env.DB\n    .prepare(\n      `SELECT * FROM alert_comments\n         WHERE alert_id IN (${placeholders})\n         ORDER BY alert_id ASC, created_at ASC, comment_id ASC`,\n    )\n    .bind(...unique)\n    .all<AlertCommentRow>();\n\n  for (const row of rows.results ?? []) {\n    const record = mapAlertCommentRow(row);\n    const bucket = map.get(record.alert_id);\n    if (bucket) {\n      bucket.push(record);\n    } else {\n      map.set(record.alert_id, [record]);\n    }\n  }\n\n  for (const id of unique) {\n    if (!map.has(id)) {\n      map.set(id, []);\n    }\n  }\n\n  return map;\n}\n\nexport async function addAlertComment(\n  env: Env,\n  params: {\n    alert_id: string;\n    action: string;\n    body: string | null;\n    actor_id: string;\n    actor_email?: string | null;\n    metadata?: Record<string, unknown> | null;\n  },\n): Promise<AlertCommentRecord> {\n  const now = nowISO();\n  const metadataJson = params.metadata ? JSON.stringify(params.metadata) : null;\n  const commentId = crypto.randomUUID();\n  const insertStmt = env.DB\n    .prepare(\n      `INSERT INTO alert_comments (\n          comment_id, alert_id, action, author_id, author_email, body, metadata_json, created_at\n        ) VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8)`,\n    )\n    .bind(\n      commentId,\n      params.alert_id,\n      params.action,\n      params.actor_id,\n      params.actor_email ?? null,\n      params.body ?? null,\n      metadataJson,\n      now,\n    );\n\n  const updateAlertStmt = env.DB\n    .prepare(`UPDATE alerts SET updated_at = ?2 WHERE alert_id = ?1`)\n    .bind(params.alert_id, now);\n\n  await withTransaction(env.DB, async () => {\n    await insertStmt.run();\n    await updateAlertStmt.run();\n  });\n\n  return {\n    comment_id: commentId,\n    alert_id: params.alert_id,\n    action: params.action,\n    author_id: params.actor_id,\n    author_email: params.actor_email ?? null,\n    body: params.body ?? null,\n    metadata: params.metadata ?? null,\n    created_at: now,\n  };\n}\n", "import type { Env } from \"../env\";\nimport { requireAccessUser } from \"../lib/access\";\nimport {\n  buildDeviceLookup,\n  buildDeviceScope,\n  fetchDeviceMeta,\n  presentDeviceId,\n  resolveDeviceId,\n  type DeviceMeta,\n} from \"../lib/device\";\nimport { json } from \"../utils/responses\";\nimport { andWhere, nowISO, parseFaultsJson } from \"../utils\";\nimport {\n  AlertsQuerySchema,\n  AlertListQuerySchema,\n  CreateAlertSchema,\n  AlertLifecycleActionSchema,\n  AlertCommentCreateSchema,\n  type AlertListQuery,\n  type CreateAlertInput,\n  type AlertLifecycleActionInput,\n  type AlertCommentCreateInput,\n} from \"../schemas/alerts\";\nimport { validationErrorResponse, validateWithSchema } from \"../utils/validation\";\nimport {\n  createAlert,\n  listAlerts,\n  getAlert,\n  updateAlertLifecycle,\n  listAlertComments,\n  listAlertCommentsForAlerts,\n  addAlertComment,\n  type AlertRecord,\n  type AlertCommentRecord,\n} from \"../lib/alerts-store\";\nimport { createAuditEntry } from \"../lib/audit-store\";\nimport { loggerForRequest } from \"../utils/logging\";\n\r\nexport async function handleAlertsFeed(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const scope = buildDeviceScope(user);\r\n  const url = new URL(req.url);\n  const paramsResult = AlertsQuerySchema.safeParse({\n    limit: url.searchParams.get(\"limit\"),\n    hours: url.searchParams.get(\"hours\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { limit = 40, hours = 72 } = paramsResult.data;\n  const sinceMs = Date.now() - hours * 60 * 60 * 1000;\r\n\r\n  if (scope.empty) {\r\n    return json({ generated_at: nowISO(), items: [], stats: { total: 0, active: 0 } });\r\n  }\r\n\r\n  let where = \"\";\r\n  const bind: any[] = [];\r\n  if (scope.clause) {\r\n    where = andWhere(where, scope.clause);\r\n    bind.push(...scope.bind);\r\n  }\r\n\r\n  const faultsWhere = andWhere(\r\n    andWhere(where, \"t.ts >= ?\"),\r\n    \"t.faults_json IS NOT NULL AND t.faults_json != '[]' AND t.faults_json != ''\",\r\n  );\r\n  const faultRows = await env.DB\r\n    .prepare(\r\n      `SELECT t.device_id, t.ts, t.faults_json, d.site, ls.updated_at AS last_update, ls.faults_json AS latest_faults\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         LEFT JOIN latest_state ls ON ls.device_id = t.device_id\r\n         ${faultsWhere}\r\n        ORDER BY t.ts DESC\r\n        LIMIT ${limit}`,\r\n    )\r\n    .bind(...bind, sinceMs)\r\n    .all<{\r\n      device_id: string;\r\n      ts: number;\r\n      faults_json: string | null;\r\n      site: string | null;\r\n      last_update: string | null;\r\n      latest_faults: string | null;\r\n    }>();\r\n\r\n  let items;\r\n  try {\r\n    items = await Promise.all(\r\n      (faultRows.results ?? []).map(async (row) => {\r\n        const faults = parseFaultsJson(row.faults_json);\r\n        const activeFaults = parseFaultsJson(row.latest_faults);\r\n        return {\r\n          device_id: presentDeviceId(row.device_id, scope.isAdmin),\r\n          lookup: await buildDeviceLookup(row.device_id, env, scope.isAdmin),\r\n          site: row.site ?? null,\r\n          ts: new Date(row.ts).toISOString(),\r\n          fault_count: faults.length,\r\n          faults,\r\n          active: activeFaults.length > 0,\r\n          active_faults: activeFaults,\r\n          last_update: row.last_update ?? null,\r\n        };\r\n      }),\r\n    );\r\n  } catch (err) {\n    loggerForRequest(req, { route: \"/api/alerts/recent\" }).error(\"alerts.feed_failed\", {\n      error: err,\n    });\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\r\n  const active = items.filter((i: any) => i.active).length;\r\n\r\n  return json({\n    generated_at: nowISO(),\n    items,\n    stats: {\n      total: items.length,\n      active,\n    },\n  });\n}\n\nfunction requestIp(req: Request): string | null {\n  return (\n    req.headers.get(\"cf-connecting-ip\") ??\n    req.headers.get(\"x-forwarded-for\") ??\n    req.headers.get(\"x-real-ip\") ??\n    null\n  );\n}\n\nfunction presentAlertComment(comment: AlertCommentRecord) {\n  return {\n    comment_id: comment.comment_id,\n    alert_id: comment.alert_id,\n    action: comment.action,\n    author_id: comment.author_id,\n    author_email: comment.author_email,\n    body: comment.body,\n    metadata: comment.metadata,\n    created_at: comment.created_at,\n  };\n}\n\nasync function ensureAlertAccess(\n  env: Env,\n  scope: ReturnType<typeof buildDeviceScope>,\n  alert: AlertRecord,\n) {\n  if (scope.isAdmin) return true;\n  if (scope.empty) return false;\n  const allowedProfiles = (scope.bind as string[]) ?? [];\n  if (!allowedProfiles.length) return false;\n  if (alert.profile_id && allowedProfiles.includes(alert.profile_id)) return true;\n\n  const row = await env.DB\n    .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n    .bind(alert.device_id)\n    .first<{ profile_id: string | null }>();\n  const profileId = row?.profile_id ?? null;\n  if (!profileId) return false;\n  return allowedProfiles.includes(profileId);\n}\n\nasync function recordAlertAudit(\n  env: Env,\n  req: Request,\n  userEmail: string,\n  action: string,\n  alert: AlertRecord,\n  extras?: Record<string, unknown>,\n) {\n  const result = await createAuditEntry(env, {\n    actor_id: userEmail,\n    actor_email: userEmail,\n    actor_name: null,\n    action,\n    entity_type: \"alert\",\n    entity_id: alert.alert_id,\n    metadata: {\n      alert_id: alert.alert_id,\n      device_id: alert.device_id,\n      profile_id: alert.profile_id,\n      status: alert.status,\n      severity: alert.severity,\n      acknowledged_at: alert.acknowledged_at,\n      resolved_at: alert.resolved_at,\n      assigned_to: alert.assigned_to,\n      ...extras,\n    },\n    ip_address: requestIp(req),\n  });\n\n  if (!result.ok) {\n    throw new Error(\"Failed to create audit entry for alert lifecycle action\");\n  }\n}\n\nasync function presentAlertRecord(\n  record: AlertRecord,\n  env: Env,\n  scope: ReturnType<typeof buildDeviceScope>,\n  meta: Map<string, DeviceMeta>,\n  comments?: AlertCommentRecord[] | null,\n) {\n  const info = meta.get(record.device_id);\n  const outwardId = presentDeviceId(record.device_id, scope.isAdmin);\n  const lookup = await buildDeviceLookup(record.device_id, env, scope.isAdmin);\n  return {\n    alert_id: record.alert_id,\n    device_id: outwardId,\n    lookup,\n    profile_id: record.profile_id ?? info?.profile_id ?? null,\n    site: info?.site ?? null,\n    alert_type: record.alert_type,\n    severity: record.severity,\n    status: record.status,\n    summary: record.summary,\n    description: record.description,\n    metadata: record.metadata,\n    acknowledged_at: record.acknowledged_at,\n    resolved_at: record.resolved_at,\n    resolved_by: record.resolved_by,\n    assigned_to: record.assigned_to,\n    created_at: record.created_at,\n    updated_at: record.updated_at,\n    comments: (comments ?? []).map(presentAlertComment),\n  };\n}\n\nexport async function handleListAlertRecords(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n\n  const scope = buildDeviceScope(user, \"a\");\n  if (scope.empty && !scope.isAdmin) {\n    return json({ generated_at: nowISO(), items: [] });\n  }\n\n  const url = new URL(req.url);\n  const paramsResult = validateWithSchema<AlertListQuery>(AlertListQuerySchema, {\n    status: url.searchParams.get(\"status\") ?? undefined,\n    severity: url.searchParams.get(\"severity\") ?? undefined,\n    device: url.searchParams.get(\"device\") ?? undefined,\n    profile: url.searchParams.get(\"profile\") ?? undefined,\n    limit: url.searchParams.get(\"limit\") ?? undefined,\n    since: url.searchParams.get(\"since\") ?? undefined,\n    until: url.searchParams.get(\"until\") ?? undefined,\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.issues);\n  }\n  const params = paramsResult.data;\n\n  if (params.since && params.until) {\n    const sinceMs = Date.parse(params.since);\n    const untilMs = Date.parse(params.until);\n    if (!Number.isNaN(sinceMs) && !Number.isNaN(untilMs) && untilMs < sinceMs) {\n      return json({ error: \"Invalid range\" }, { status: 400 });\n    }\n  }\n\n  let deviceId: string | undefined;\n  if (params.device) {\n    const resolved = await resolveDeviceId(params.device, env, scope.isAdmin);\n    if (!resolved) {\n      return json({ error: \"Unknown device\" }, { status: 404 });\n    }\n    deviceId = resolved;\n  }\n\n  let profileIds: string[] | undefined;\n  let singleProfile: string | undefined = undefined;\n  if (scope.isAdmin) {\n    if (params.profile) singleProfile = params.profile;\n  } else {\n    const allowedProfiles = scope.bind as string[];\n    if (!allowedProfiles.length) {\n      return json({ generated_at: nowISO(), items: [] });\n    }\n    if (params.profile) {\n      if (!allowedProfiles.includes(params.profile)) {\n        return json({ error: \"Forbidden\" }, { status: 403 });\n      }\n      profileIds = [params.profile];\n    } else {\n      profileIds = allowedProfiles;\n    }\n\n    if (deviceId) {\n      const deviceRow = await env.DB\n        .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n        .bind(deviceId)\n        .first<{ profile_id: string | null }>();\n      const deviceProfile = deviceRow?.profile_id ?? null;\n      if (!deviceProfile || !allowedProfiles.includes(deviceProfile)) {\n        return json({ error: \"Forbidden\" }, { status: 403 });\n      }\n    }\n  }\n\n  const limit = params.limit ?? 50;\n\n  const alerts = await listAlerts(env, {\n    status: params.status ?? undefined,\n    severity: params.severity ?? undefined,\n    device_id: deviceId,\n    profile_id: singleProfile,\n    profile_ids: profileIds,\n    since: params.since ?? undefined,\n    until: params.until ?? undefined,\n    limit,\n  });\n\n  const meta = await fetchDeviceMeta(env, alerts.map((a) => a.device_id));\n  const commentMap = await listAlertCommentsForAlerts(\n    env,\n    alerts.map((a) => a.alert_id),\n  );\n  const items = await Promise.all(\n    alerts.map((record) =>\n      presentAlertRecord(record, env, scope, meta, commentMap.get(record.alert_id) ?? []),\n    ),\n  );\n\n  return json({\n    generated_at: nowISO(),\n    items,\n  });\n}\n\nexport async function handleCreateAlertRecord(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n\n  const scope = buildDeviceScope(user, \"a\");\n  if (scope.empty && !scope.isAdmin) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  let payload: unknown;\n  try {\n    payload = await req.json();\n  } catch {\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\n  }\n\n  const parseResult = validateWithSchema<CreateAlertInput>(CreateAlertSchema, payload);\n  if (!parseResult.success) {\n    return validationErrorResponse(parseResult.issues);\n  }\n  const body = parseResult.data;\n\n  const deviceId = await resolveDeviceId(body.device_id, env, scope.isAdmin);\n  if (!deviceId) {\n    return json({ error: \"Unknown device\" }, { status: 404 });\n  }\n\n  let resolvedProfile = body.profile_id ?? null;\n\n  if (!scope.isAdmin) {\n    const allowedProfiles = scope.bind as string[];\n    const deviceRow = await env.DB\n      .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n      .bind(deviceId)\n      .first<{ profile_id: string | null }>();\n\n    if (!deviceRow?.profile_id || !allowedProfiles.includes(deviceRow.profile_id)) {\n      return json({ error: \"Forbidden\" }, { status: 403 });\n    }\n\n    if (resolvedProfile && resolvedProfile !== deviceRow.profile_id) {\n      return json({ error: \"Profile mismatch\" }, { status: 400 });\n    }\n\n    resolvedProfile = deviceRow.profile_id;\n  }\n\n  const result = await createAlert(env, {\n    alert_id: body.alert_id,\n    device_id: deviceId,\n    profile_id: resolvedProfile,\n    alert_type: body.alert_type,\n    severity: body.severity,\n    status: body.status,\n    summary: body.summary ?? null,\n    description: body.description ?? null,\n    metadata: body.metadata ?? null,\n    acknowledged_at: body.acknowledged_at ?? null,\n    resolved_at: body.resolved_at ?? null,\n    resolved_by: body.resolved_by ?? null,\n    assigned_to: body.assigned_to ?? null,\n  });\n\n  if (!result.ok) {\n    if (result.reason === \"device_not_found\") {\n      return json({ error: \"Unknown device\" }, { status: 404 });\n    }\n    if (result.reason === \"conflict\") {\n      return json({ error: \"Alert already exists\" }, { status: 409 });\n    }\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\n  const meta = await fetchDeviceMeta(env, [result.alert.device_id]);\n  const [alert] = await Promise.all([\n    presentAlertRecord(result.alert, env, scope, meta, []),\n  ]);\n\n  return json({ ok: true, alert }, { status: 201 });\n}\n\nexport async function handleUpdateAlertRecord(req: Request, env: Env, alertId: string) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n\n  const scope = buildDeviceScope(user, \"a\");\n  if (scope.empty && !scope.isAdmin) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  const existing = await getAlert(env, alertId);\n  if (!existing) {\n    return json({ error: \"Alert not found\" }, { status: 404 });\n  }\n\n  if (!(await ensureAlertAccess(env, scope, existing))) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  let payload: unknown;\n  try {\n    payload = await req.json();\n  } catch {\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\n  }\n\n  const parseResult = validateWithSchema<AlertLifecycleActionInput>(AlertLifecycleActionSchema, payload);\n  if (!parseResult.success) {\n    return validationErrorResponse(parseResult.issues);\n  }\n  const body = parseResult.data;\n\n  const updateResult = await updateAlertLifecycle(env, {\n    ...body,\n    alert_id: alertId,\n    actor_id: user.email,\n    actor_email: user.email,\n    comment: body.comment ?? null,\n  });\n\n  if (!updateResult.ok) {\n    return json({ error: \"Alert not found\" }, { status: 404 });\n  }\n\n  const updatedAlert = updateResult.alert;\n  const meta = await fetchDeviceMeta(env, [updatedAlert.device_id]);\n  const comments = await listAlertComments(env, alertId);\n  const presented = await presentAlertRecord(updatedAlert, env, scope, meta, comments);\n\n  const auditExtras: Record<string, unknown> = {};\n  if (body.comment) auditExtras.comment = body.comment;\n  if (\"assignee\" in body) {\n    auditExtras.assignee = (body as { assignee?: string }).assignee ?? null;\n  }\n  if (updateResult.comment) {\n    auditExtras.comment_id = updateResult.comment.comment_id;\n  }\n\n  await recordAlertAudit(env, req, user.email, `alert.${body.action}`, updatedAlert, auditExtras);\n\n  return json({\n    ok: true,\n    alert: presented,\n    comment: updateResult.comment ? presentAlertComment(updateResult.comment) : null,\n  });\n}\n\nexport async function handleCreateAlertComment(req: Request, env: Env, alertId: string) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n\n  const scope = buildDeviceScope(user, \"a\");\n  if (scope.empty && !scope.isAdmin) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  const existing = await getAlert(env, alertId);\n  if (!existing) {\n    return json({ error: \"Alert not found\" }, { status: 404 });\n  }\n\n  if (!(await ensureAlertAccess(env, scope, existing))) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  let payload: unknown;\n  try {\n    payload = await req.json();\n  } catch {\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\n  }\n\n  const parseResult = validateWithSchema<AlertCommentCreateInput>(AlertCommentCreateSchema, payload);\n  if (!parseResult.success) {\n    return validationErrorResponse(parseResult.issues);\n  }\n  const body = parseResult.data;\n\n  const commentRecord = await addAlertComment(env, {\n    alert_id: alertId,\n    action: \"comment\",\n    body: body.comment,\n    actor_id: user.email,\n    actor_email: user.email,\n    metadata: null,\n  });\n\n  const refreshed = await getAlert(env, alertId);\n  if (!refreshed) {\n    return json({ error: \"Alert not found\" }, { status: 404 });\n  }\n\n  const meta = await fetchDeviceMeta(env, [refreshed.device_id]);\n  const comments = await listAlertComments(env, alertId);\n  const presented = await presentAlertRecord(refreshed, env, scope, meta, comments);\n\n  await recordAlertAudit(env, req, user.email, \"alert.commented\", refreshed, {\n    comment_id: commentRecord.comment_id,\n  });\n\n  return json({\n    ok: true,\n    alert: presented,\n    comment: presentAlertComment(commentRecord),\n  });\n}\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const ArchiveQuerySchema = z\n  .object({\n    offlineHours: numericParam({ integer: true, min: 1, max: 720, defaultValue: 72 }),\n    days: numericParam({ integer: true, min: 1, max: 30, defaultValue: 14 }),\n  })\n  .strict();\n\nexport type ArchiveQuery = z.infer<typeof ArchiveQuerySchema>;\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser } from \"../lib/access\";\r\nimport { buildDeviceLookup, buildDeviceScope, presentDeviceId } from \"../lib/device\";\r\nimport { json } from \"../utils/responses\";\nimport { andWhere, nowISO, parseFaultsJson } from \"../utils\";\nimport { ArchiveQuerySchema } from \"../schemas/archive\";\nimport { validationErrorResponse } from \"../utils/validation\";\nimport { maskTelemetryNumber } from \"../telemetry\";\nimport { loggerForRequest } from \"../utils/logging\";\n\r\nexport async function handleArchive(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const scope = buildDeviceScope(user);\r\n  const url = new URL(req.url);\n  const paramsResult = ArchiveQuerySchema.safeParse({\n    offlineHours: url.searchParams.get(\"offlineHours\"),\n    days: url.searchParams.get(\"days\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { offlineHours = 72, days = 14 } = paramsResult.data;\n  const offlineThreshold = new Date(Date.now() - offlineHours * 60 * 60 * 1000).toISOString();\r\n\r\n  const historySinceMs = Date.now() - days * 24 * 60 * 60 * 1000;\n\r\n  if (scope.empty) {\r\n    return json({ generated_at: nowISO(), offline: [], history: [] });\r\n  }\r\n\r\n  let where = \"\";\r\n  const bind: any[] = [];\r\n  if (scope.clause) {\r\n    where = andWhere(where, scope.clause);\r\n    bind.push(...scope.bind);\r\n  }\r\n\r\n  const offlineWhere = andWhere(where, \"(d.last_seen_at IS NULL OR d.last_seen_at < ?)\");\r\n  const offlineRows = await env.DB\r\n    .prepare(\r\n      `SELECT d.device_id, d.site, d.last_seen_at, d.online, ls.cop, ls.deltaT, ls.faults_json, ls.updated_at\r\n         FROM devices d\r\n         LEFT JOIN latest_state ls ON ls.device_id = d.device_id\r\n         ${offlineWhere}\r\n        ORDER BY d.last_seen_at IS NOT NULL, d.last_seen_at ASC\r\n        LIMIT 25`,\r\n    )\r\n    .bind(...bind, offlineThreshold)\r\n    .all<{\r\n      device_id: string;\r\n      site: string | null;\r\n      last_seen_at: string | null;\r\n      online: number;\r\n      cop: number | null;\r\n      deltaT: number | null;\r\n      faults_json: string | null;\r\n      updated_at: string | null;\r\n    }>();\r\n\r\n  let offline;\r\n  try {\r\n    offline = await Promise.all(\r\n      (offlineRows.results ?? []).map(async (row) => ({\r\n        device_id: presentDeviceId(row.device_id, scope.isAdmin),\r\n        lookup: await buildDeviceLookup(row.device_id, env, scope.isAdmin),\r\n        site: row.site ?? null,\n        last_seen_at: row.last_seen_at ?? null,\n        online: !!row.online,\n        cop: maskTelemetryNumber(row.cop, scope.isAdmin, 1, 2),\n        deltaT: maskTelemetryNumber(row.deltaT, scope.isAdmin, 1, 2),\n        alerts: parseFaultsJson(row.faults_json).length,\n        updated_at: row.updated_at ?? null,\n      })),\n    );\r\n  } catch (err) {\n    loggerForRequest(req, { route: \"/api/archive/offline\" }).error(\"archive.offline_payload_failed\", {\n      error: err,\n    });\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\r\n  const historyWhere = andWhere(andWhere(where, \"t.ts >= ?\"), \"t.ts IS NOT NULL\");\r\n  const historyRows = await env.DB\r\n    .prepare(\r\n      `SELECT DATE(t.ts / 1000, 'unixepoch') AS day, COUNT(*) AS samples\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         ${historyWhere}\r\n        GROUP BY DATE(t.ts / 1000, 'unixepoch')\r\n        ORDER BY day DESC\r\n        LIMIT ${days}`,\r\n    )\r\n    .bind(...bind, historySinceMs)\r\n    .all<{ day: string; samples: number }>();\r\n\r\n  const history = (historyRows.results ?? []).map((row) => ({\r\n    day: row.day,\r\n    samples: row.samples,\r\n  }));\r\n\r\n  return json({\r\n    generated_at: nowISO(),\r\n    offline,\r\n    history,\r\n  });\r\n}\r\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const ClientCompactQuerySchema = z\n  .object({\n    hours: numericParam({ integer: true, min: 1, max: 72, defaultValue: 24 }),\n    lowDeltaT: numericParam({ min: 0, defaultValue: 2 }),\n  })\n  .strict();\n\nexport type ClientCompactQuery = z.infer<typeof ClientCompactQuerySchema>;\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser } from \"../lib/access\";\r\nimport { buildDeviceLookup, buildDeviceScope, presentDeviceId } from \"../lib/device\";\nimport { json } from \"../utils/responses\";\nimport { andWhere, nowISO, parseFaultsJson } from \"../utils\";\nimport { ClientCompactQuerySchema } from \"../schemas/client\";\nimport { validationErrorResponse } from \"../utils/validation\";\nimport { maskTelemetryNumber } from \"../telemetry\";\nimport { loggerForRequest } from \"../utils/logging\";\n\r\nexport async function handleClientCompact(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const scope = buildDeviceScope(user);\r\n  const url = new URL(req.url);\n  const paramsResult = ClientCompactQuerySchema.safeParse({\n    hours: url.searchParams.get(\"hours\"),\n    lowDeltaT: url.searchParams.get(\"lowDeltaT\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { hours = 24, lowDeltaT = 2 } = paramsResult.data;\n  const sinceMs = Date.now() - hours * 60 * 60 * 1000;\n\r\n  if (scope.empty) {\r\n    return json({\r\n      generated_at: nowISO(),\r\n      scope: \"empty\",\r\n      window_start_ms: sinceMs,\r\n      kpis: {\r\n        devices_total: 0,\r\n        devices_online: 0,\r\n        offline_count: 0,\r\n        online_pct: 0,\r\n        avg_cop: null,\r\n        low_deltaT_count: 0,\r\n        open_alerts: 0,\r\n        max_heartbeat_age_sec: null,\r\n      },\r\n      alerts: [],\r\n      top_devices: [],\r\n      trend: [],\r\n    });\r\n  }\r\n\r\n  let where = \"\";\r\n  const bind: any[] = [];\r\n  if (scope.clause) {\r\n    where = andWhere(where, scope.clause);\r\n    bind.push(...scope.bind);\r\n  }\r\n\r\n  const totalRow = await env.DB\r\n    .prepare(`SELECT COUNT(*) AS c FROM devices d ${where}`)\r\n    .bind(...bind)\r\n    .first<{ c: number }>();\r\n  const onlineRow = await env.DB\r\n    .prepare(`SELECT COUNT(*) AS c FROM devices d ${andWhere(where, \"d.online = 1\")}`)\r\n    .bind(...bind)\r\n    .first<{ c: number }>();\r\n\r\n  const devices_total = totalRow?.c ?? 0;\r\n  const devices_online = onlineRow?.c ?? 0;\r\n  const offline_count = Math.max(0, devices_total - devices_online);\r\n  const online_pct = devices_total ? Math.round((devices_online / devices_total) * 100) : 0;\r\n\r\n  const telemWhere = andWhere(where, \"t.ts >= ?\");\r\n  const telemBind = [...bind, sinceMs];\r\n\r\n  const avgRow = await env.DB\r\n    .prepare(\r\n      `SELECT AVG(t.cop) AS v\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         ${telemWhere}`,\r\n    )\r\n    .bind(...telemBind)\r\n    .first<{ v: number | null }>();\r\n\r\n  const lowWhere = andWhere(telemWhere, \"t.deltaT IS NOT NULL AND t.deltaT < ?\");\r\n  const lowBind = [...telemBind, lowDeltaT];\r\n  const lowRow = await env.DB\r\n    .prepare(\r\n      `SELECT COUNT(*) AS c\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         ${lowWhere}`,\r\n    )\r\n    .bind(...lowBind)\r\n    .first<{ c: number }>();\r\n\r\n  const hbRow = await env.DB\r\n    .prepare(\r\n      `SELECT MAX(\r\n          CASE WHEN d.last_seen_at IS NULL THEN NULL\r\n               ELSE (strftime('%s','now') - strftime('%s', d.last_seen_at))\r\n          END\r\n        ) AS s\r\n       FROM devices d\r\n       ${where}`,\r\n    )\r\n    .bind(...bind)\r\n    .first<{ s: number | null }>();\r\n\r\n  const alertsRows = await env.DB\r\n    .prepare(\r\n      `SELECT t.device_id, t.ts, t.faults_json, d.site, ls.updated_at\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         LEFT JOIN latest_state ls ON ls.device_id = t.device_id\r\n         ${andWhere(telemWhere, \"t.faults_json IS NOT NULL AND t.faults_json != '[]' AND t.faults_json != ''\")}\r\n        ORDER BY t.ts DESC\r\n        LIMIT 12`,\r\n    )\r\n    .bind(...telemBind)\r\n    .all<{\r\n      device_id: string;\r\n      ts: number;\r\n      faults_json: string | null;\r\n      site: string | null;\r\n      updated_at: string | null;\r\n    }>();\r\n\r\n  let alerts;\r\n  try {\r\n    alerts = await Promise.all(\r\n      (alertsRows.results ?? []).map(async (row) => {\r\n        const faults = parseFaultsJson(row.faults_json);\r\n        return {\r\n          device_id: presentDeviceId(row.device_id, scope.isAdmin),\r\n          lookup: await buildDeviceLookup(row.device_id, env, scope.isAdmin),\r\n          site: row.site ?? null,\r\n          ts: new Date(row.ts).toISOString(),\r\n          updated_at: row.updated_at ?? null,\r\n          faults,\r\n          fault_count: faults.length,\r\n        };\r\n      }),\r\n    );\r\n  } catch (err) {\n    loggerForRequest(req, { route: \"/api/client/compact\" }).error(\"client.alerts_payload_failed\", {\n      error: err,\n    });\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\r\n  const openAlertsTotal = alerts.filter((a: any) => a.fault_count > 0).length;\r\n\r\n  const topRows = await env.DB\r\n    .prepare(\r\n      `SELECT d.device_id, d.site, d.online, d.last_seen_at, ls.cop, ls.deltaT, ls.thermalKW, ls.faults_json, ls.updated_at\r\n         FROM devices d\r\n         LEFT JOIN latest_state ls ON ls.device_id = d.device_id\r\n         ${where}\r\n        ORDER BY d.online DESC, (d.last_seen_at IS NULL), d.last_seen_at DESC, d.device_id ASC\r\n        LIMIT 8`,\r\n    )\r\n    .bind(...bind)\r\n    .all<{\r\n      device_id: string;\r\n      site: string | null;\r\n      online: number;\r\n      last_seen_at: string | null;\r\n      cop: number | null;\r\n      deltaT: number | null;\r\n      thermalKW: number | null;\r\n      faults_json: string | null;\r\n      updated_at: string | null;\r\n    }>();\r\n\r\n  let topDevices;\r\n  try {\r\n    topDevices = await Promise.all(\r\n      (topRows.results ?? []).map(async (row) => {\r\n        const faults = parseFaultsJson(row.faults_json);\r\n        return {\n          device_id: presentDeviceId(row.device_id, scope.isAdmin),\n          lookup: await buildDeviceLookup(row.device_id, env, scope.isAdmin),\n          site: row.site ?? null,\n          online: !!row.online,\n          last_seen_at: row.last_seen_at ?? null,\n          updated_at: row.updated_at ?? null,\n          cop: maskTelemetryNumber(row.cop, scope.isAdmin, 1, 2),\n          deltaT: maskTelemetryNumber(row.deltaT, scope.isAdmin, 1, 2),\n          thermalKW: maskTelemetryNumber(row.thermalKW, scope.isAdmin, 1, 2),\n          alert_count: faults.length,\n        };\n      }),\n    );\n  } catch (err) {\n    loggerForRequest(req, { route: \"/api/client/compact\" }).error(\"client.top_devices_payload_failed\", {\n      error: err,\n    });\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\r\n  const telemetryRows = await env.DB\r\n    .prepare(\r\n      `SELECT t.ts, t.cop, t.thermalKW, t.deltaT\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         ${telemWhere}\r\n        ORDER BY t.ts DESC\r\n        LIMIT 160`,\r\n    )\r\n    .bind(...telemBind)\r\n    .all<{\r\n      ts: number;\r\n      cop: number | null;\r\n      thermalKW: number | null;\r\n      deltaT: number | null;\r\n    }>();\r\n\r\n  const bucketCount = 8;\r\n  const nowMs = Date.now();\r\n  const spanMs = Math.max(1, nowMs - sinceMs);\r\n  const bucketMs = spanMs / bucketCount;\r\n  const buckets = Array.from({ length: bucketCount }, (_, i) => ({\r\n    start: sinceMs + i * bucketMs,\r\n    end: sinceMs + (i + 1) * bucketMs,\r\n    count: 0,\r\n    cop: 0,\r\n    thermal: 0,\r\n    delta: 0,\r\n  }));\r\n\r\n  for (const row of telemetryRows.results ?? []) {\r\n    const idx = Math.min(bucketCount - 1, Math.max(0, Math.floor((row.ts - sinceMs) / bucketMs)));\r\n    const bucket = buckets[idx];\r\n    bucket.count += 1;\r\n    if (typeof row.cop === \"number\") bucket.cop += row.cop;\r\n    if (typeof row.thermalKW === \"number\") bucket.thermal += row.thermalKW;\r\n    if (typeof row.deltaT === \"number\") bucket.delta += row.deltaT;\r\n  }\r\n\r\n  const trend = buckets.map((bucket) => {\n    const avgCop = bucket.count ? bucket.cop / bucket.count : null;\n    const avgThermal = bucket.count ? bucket.thermal / bucket.count : null;\n    const avgDelta = bucket.count ? bucket.delta / bucket.count : null;\n    return {\n      label: new Date(Math.min(nowMs, bucket.end)).toISOString(),\n      cop: maskTelemetryNumber(avgCop, scope.isAdmin, 1, 2),\n      thermalKW: maskTelemetryNumber(avgThermal, scope.isAdmin, 1, 2),\n      deltaT: maskTelemetryNumber(avgDelta, scope.isAdmin, 1, 2),\n    };\n  });\n\r\n  return json({\r\n    generated_at: nowISO(),\r\n    scope: scope.isAdmin ? \"fleet\" : \"tenant\",\r\n    window_start_ms: sinceMs,\r\n    kpis: {\r\n      devices_total,\r\n      devices_online,\r\n      offline_count,\r\n      online_pct,\n      avg_cop: maskTelemetryNumber(avgRow?.v ?? null, scope.isAdmin, 1, 2),\n      low_deltaT_count: lowRow?.c ?? 0,\n      open_alerts: openAlertsTotal,\n      max_heartbeat_age_sec: hbRow?.s ?? null,\n    },\r\n    alerts,\r\n    top_devices: topDevices,\r\n    trend,\r\n  });\r\n}\r\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const FleetSummaryQuerySchema = z\n  .object({\n    hours: numericParam({ integer: true, min: 1, max: 168, defaultValue: 24 }),\n    lowDeltaT: numericParam({ min: 0, defaultValue: 2 }),\n  })\n  .strict();\n\nexport type FleetSummaryQuery = z.infer<typeof FleetSummaryQuerySchema>;\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser } from \"../lib/access\";\nimport { buildDeviceScope } from \"../lib/device\";\nimport { json } from \"../utils/responses\";\nimport { andWhere, nowISO } from \"../utils\";\nimport { FleetSummaryQuerySchema } from \"../schemas/fleet\";\nimport { validationErrorResponse } from \"../utils/validation\";\nimport { maskTelemetryNumber } from \"../telemetry\";\n\r\nexport async function handleFleetSummary(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const scope = buildDeviceScope(user);\r\n  const url = new URL(req.url);\n  const paramsResult = FleetSummaryQuerySchema.safeParse({\n    hours: url.searchParams.get(\"hours\"),\n    lowDeltaT: url.searchParams.get(\"lowDeltaT\"),\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.error);\n  }\n  const { hours = 24, lowDeltaT = 2 } = paramsResult.data;\n  const sinceMs = Date.now() - hours * 60 * 60 * 1000;\r\n\r\n  let where = \"\";\n  const bind: any[] = [];\r\n\r\n  if (scope.empty) {\r\n    return json({\r\n      devices_total: 0,\r\n      devices_online: 0,\r\n      online_pct: 0,\r\n      avg_cop_24h: null,\r\n      low_deltaT_count_24h: 0,\r\n      max_heartbeat_age_sec: null,\r\n      window_start_ms: sinceMs,\r\n      generated_at: nowISO(),\r\n    });\r\n  }\r\n\r\n  if (scope.clause) {\r\n    where = andWhere(where, scope.clause);\r\n    bind.push(...scope.bind);\r\n  }\r\n\r\n  const totalRow = await env.DB\r\n    .prepare(`SELECT COUNT(*) AS c FROM devices d ${where}`)\r\n    .bind(...bind)\r\n    .first<{ c: number }>();\r\n\r\n  const onlineRow = await env.DB\r\n    .prepare(`SELECT COUNT(*) AS c FROM devices d ${andWhere(where, \"d.online = 1\")}`)\r\n    .bind(...bind)\r\n    .first<{ c: number }>();\r\n\r\n  const devices_total = totalRow?.c ?? 0;\r\n  const devices_online = onlineRow?.c ?? 0;\r\n  const online_pct = devices_total ? Math.round((devices_online / devices_total) * 100) : 0;\r\n\r\n  const telemWhere = andWhere(where, \"t.ts >= ?\");\r\n  const telemBind = [...bind, sinceMs];\r\n\r\n  const avgRow = await env.DB\r\n    .prepare(\r\n      `SELECT AVG(t.cop) AS v\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         ${telemWhere}`,\r\n    )\r\n    .bind(...telemBind)\r\n    .first<{ v: number | null }>();\r\n\r\n  const lowWhere = andWhere(telemWhere, \"t.deltaT IS NOT NULL AND t.deltaT < ?\");\r\n  const lowBind = [...telemBind, lowDeltaT];\r\n  const lowRow = await env.DB\r\n    .prepare(\r\n      `SELECT COUNT(*) AS c\r\n         FROM telemetry t\r\n         JOIN devices d ON d.device_id = t.device_id\r\n         ${lowWhere}`,\r\n    )\r\n    .bind(...lowBind)\r\n    .first<{ c: number }>();\r\n\r\n  const hbRow = await env.DB\r\n    .prepare(\r\n      `SELECT MAX(\r\n          CASE WHEN d.last_seen_at IS NULL THEN NULL\r\n               ELSE (strftime('%s','now') - strftime('%s', d.last_seen_at))\r\n          END\r\n        ) AS s\r\n       FROM devices d\r\n       ${where}`,\r\n    )\r\n    .bind(...bind)\r\n    .first<{ s: number | null }>();\r\n\r\n  return json({\n    devices_total,\n    devices_online,\n    online_pct,\n    avg_cop_24h: maskTelemetryNumber(avgRow?.v ?? null, scope.isAdmin, 1, 2),\n    low_deltaT_count_24h: lowRow?.c ?? 0,\n    max_heartbeat_age_sec: hbRow?.s ?? null,\n    window_start_ms: sinceMs,\n    generated_at: nowISO(),\n  });\n}\r\n", "import type { Env } from \"../env\";\nimport { systemLogger } from \"../utils/logging\";\n\nconst MEMORY_BUCKETS = new Map<string, MemoryBucket>();\nconst CLEANUP_INTERVAL_MS = 5 * 60 * 1000;\n\ninterface MemoryBucket {\n  capacity: number;\n  tokens: number;\n  lastRefill: number;\n  blockedUntil: number;\n}\n\ninterface StoredBucket {\n  tokens: number;\n  lastRefill: number;\n  blockedUntil: number;\n}\n\nexport interface IpRateLimitConfig {\n  capacity: number;\n  refillIntervalMs: number;\n  blockDurationMs: number;\n}\n\nexport interface IpRateLimitResult {\n  limited: boolean;\n  retryAfterSeconds?: number;\n  remaining?: number;\n  limit?: number;\n  ip?: string;\n}\n\nlet lastCleanup = Date.now();\n\nexport async function checkIpRateLimit(\n  req: Request,\n  env: Env,\n  route: string,\n): Promise<IpRateLimitResult | null> {\n  const config = resolveConfig(env);\n  if (!config) return null;\n  const ip = extractClientIp(req);\n  if (!ip) return null;\n\n  const key = `${route}:${ip}`;\n  const now = Date.now();\n\n  if (env.INGEST_IP_BUCKETS) {\n    try {\n      const kvResult = await checkKvRateLimit(env.INGEST_IP_BUCKETS, key, ip, config, now);\n      if (kvResult) {\n        return kvResult;\n      }\n    } catch (error) {\n      systemLogger({ scope: \"ingest_ip_rate_limit\" }).warn(\"ingest.ip_kv_bucket_failed\", {\n        error,\n      });\n    }\n  }\n\n  cleanupBuckets(now);\n  return checkMemoryRateLimit(key, ip, config, now);\n}\n\nfunction resolveConfig(env: Env): IpRateLimitConfig | null {\n  const rawLimit =\n    typeof env.INGEST_IP_LIMIT_PER_MIN === \"string\"\n      ? env.INGEST_IP_LIMIT_PER_MIN.trim()\n      : \"\";\n  if (!rawLimit) return null;\n  const capacity = Number.parseInt(rawLimit, 10);\n  if (!Number.isFinite(capacity) || capacity <= 0) return null;\n\n  const rawBlockSeconds =\n    typeof env.INGEST_IP_BLOCK_SECONDS === \"string\"\n      ? env.INGEST_IP_BLOCK_SECONDS.trim()\n      : \"\";\n  const blockSeconds = Number.parseInt(rawBlockSeconds || \"60\", 10);\n  const blockDurationMs =\n    Number.isFinite(blockSeconds) && blockSeconds > 0 ? blockSeconds * 1000 : 60_000;\n\n  return {\n    capacity,\n    refillIntervalMs: 60_000,\n    blockDurationMs,\n  };\n}\n\nfunction extractClientIp(req: Request): string | null {\n  const direct = req.headers.get(\"cf-connecting-ip\");\n  if (direct?.trim()) {\n    return direct.trim();\n  }\n  const forwarded = req.headers.get(\"x-forwarded-for\");\n  if (forwarded?.trim()) {\n    const first = forwarded.split(\",\")[0]?.trim();\n    return first || null;\n  }\n  return null;\n}\n\nfunction refill(bucket: MemoryBucket | StoredBucket, config: IpRateLimitConfig, now: number) {\n  if (bucket.tokens >= config.capacity) {\n    bucket.tokens = config.capacity;\n    bucket.lastRefill = now;\n    return;\n  }\n\n  const elapsed = now - bucket.lastRefill;\n  if (elapsed <= 0) return;\n\n  const tokensToAdd = (elapsed / config.refillIntervalMs) * config.capacity;\n  bucket.tokens = Math.min(config.capacity, bucket.tokens + tokensToAdd);\n  bucket.lastRefill = now;\n}\n\nexport function __resetIpRateLimiterForTests() {\n  MEMORY_BUCKETS.clear();\n  lastCleanup = Date.now();\n}\n\nasync function checkKvRateLimit(\n  kv: Env[\"INGEST_IP_BUCKETS\"],\n  key: string,\n  ip: string,\n  config: IpRateLimitConfig,\n  now: number,\n): Promise<IpRateLimitResult | null> {\n  if (!kv) return null;\n  const ttlSeconds = computeTtlSeconds(config);\n  const stored = (await kv.get(key, { type: \"json\" })) as StoredBucket | null;\n  const bucket: StoredBucket =\n    stored ?? {\n      tokens: config.capacity,\n      lastRefill: now,\n      blockedUntil: 0,\n    };\n\n  if (bucket.blockedUntil > now) {\n    await kv.put(\n      key,\n      JSON.stringify(bucket),\n      { expirationTtl: ttlSeconds },\n    );\n    return {\n      limited: true,\n      retryAfterSeconds: Math.ceil((bucket.blockedUntil - now) / 1000),\n      remaining: 0,\n      limit: config.capacity,\n      ip,\n    };\n  }\n\n  refill(bucket, config, now);\n\n  if (bucket.tokens >= 1) {\n    bucket.tokens -= 1;\n    await kv.put(\n      key,\n      JSON.stringify(bucket),\n      { expirationTtl: ttlSeconds },\n    );\n    return {\n      limited: false,\n      remaining: Math.floor(bucket.tokens),\n      limit: config.capacity,\n      ip,\n    };\n  }\n\n  bucket.tokens = 0;\n  bucket.blockedUntil = now + config.blockDurationMs;\n  await kv.put(\n    key,\n    JSON.stringify(bucket),\n    { expirationTtl: ttlSeconds },\n  );\n\n  return {\n    limited: true,\n    retryAfterSeconds: Math.ceil(config.blockDurationMs / 1000),\n    remaining: 0,\n    limit: config.capacity,\n    ip,\n  };\n}\n\nfunction checkMemoryRateLimit(\n  key: string,\n  ip: string,\n  config: IpRateLimitConfig,\n  now: number,\n): IpRateLimitResult {\n  let bucket = MEMORY_BUCKETS.get(key);\n  if (!bucket) {\n    bucket = {\n      capacity: config.capacity,\n      tokens: config.capacity,\n      lastRefill: now,\n      blockedUntil: 0,\n    };\n    MEMORY_BUCKETS.set(key, bucket);\n  }\n\n  if (bucket.blockedUntil > now) {\n    return {\n      limited: true,\n      retryAfterSeconds: Math.ceil((bucket.blockedUntil - now) / 1000),\n      remaining: 0,\n      limit: config.capacity,\n      ip,\n    };\n  }\n\n  refill(bucket, config, now);\n\n  if (bucket.tokens >= 1) {\n    bucket.tokens -= 1;\n\n    return {\n      limited: false,\n      remaining: Math.floor(bucket.tokens),\n      limit: config.capacity,\n      ip,\n    };\n  }\n\n  bucket.blockedUntil = now + config.blockDurationMs;\n  bucket.tokens = 0;\n\n  return {\n    limited: true,\n    retryAfterSeconds: Math.ceil(config.blockDurationMs / 1000),\n    remaining: 0,\n    limit: config.capacity,\n    ip,\n  };\n}\n\nfunction computeTtlSeconds(config: IpRateLimitConfig): number {\n  const totalMs = config.blockDurationMs + config.refillIntervalMs * 2;\n  return Math.max(60, Math.ceil(totalMs / 1000));\n}\n\nfunction cleanupBuckets(now: number) {\n  if (now - lastCleanup < CLEANUP_INTERVAL_MS) return;\n  lastCleanup = now;\n  for (const [key, bucket] of MEMORY_BUCKETS) {\n    if (bucket.tokens >= bucket.capacity && bucket.blockedUntil <= now) {\n      MEMORY_BUCKETS.delete(key);\n    }\n  }\n}\n", "import { z } from \"zod\";\r\n\r\nconst nullableNumber = z\r\n  .union([z.number(), z.null()])\r\n  .optional()\r\n  .transform((value: number | null | undefined) =>\r\n    value === undefined ? null : value,\r\n  );\r\n\r\nconst nullableString = z\r\n  .union([z.string().min(1), z.null()])\r\n  .optional()\r\n  .transform((value: string | null | undefined) =>\r\n    value === undefined ? null : value,\r\n  );\r\n\r\nexport const TelemetryMetricsSchema = z\n  .object({\n    supplyC: nullableNumber,\n    returnC: nullableNumber,\n    tankC: nullableNumber,\n    ambientC: nullableNumber,\n    flowLps: nullableNumber,\n    compCurrentA: nullableNumber,\n    eevSteps: nullableNumber,\n    powerKW: nullableNumber,\n    mode: nullableString,\n    defrost: nullableNumber,\n  })\n  .strip();\n\r\nexport const TelemetryPayloadSchema = z\r\n  .object({\r\n    device_id: z.string().min(1, \"device_id must not be empty\"),\r\n    ts: z.string().min(1, \"ts must not be empty\"),\r\n    metrics: TelemetryMetricsSchema,\r\n    faults: z.array(z.string()).default([]),\r\n    rssi: nullableNumber,\r\n  })\r\n  .strict();\r\n\r\nexport type TelemetryPayload = z.infer<typeof TelemetryPayloadSchema>;\r\n\r\nexport const HeartbeatPayloadSchema = z\r\n  .object({\r\n    device_id: z.string().min(1, \"device_id must not be empty\"),\r\n    ts: z.string().min(1).optional(),\r\n    rssi: nullableNumber,\r\n  })\r\n  .strict();\r\n\r\nexport type HeartbeatPayload = z.infer<typeof HeartbeatPayloadSchema>;\r\n", "import type { Env } from \"../env\";\n\nexport const DEFAULT_INGEST_DEDUP_WINDOW_MINUTES = 5;\n\nexport function ingestDedupWindowMs(env: Pick<Env, \"INGEST_DEDUP_WINDOW_MINUTES\">): number {\n  const raw = env.INGEST_DEDUP_WINDOW_MINUTES;\n  const parsed = raw ? Number(raw) : NaN;\n  const minutes =\n    Number.isFinite(parsed) && parsed > 0 ? parsed : DEFAULT_INGEST_DEDUP_WINDOW_MINUTES;\n  const windowMs = Math.floor(minutes * 60_000);\n  return Math.max(windowMs, 1_000);\n}\n", "const recordedMetrics = new WeakMap<Request, boolean>();\n\nexport function initializeRequestMetrics(req: Request): void {\n  recordedMetrics.set(req, false);\n}\n\nexport function markRequestMetricsRecorded(req: Request): void {\n  recordedMetrics.set(req, true);\n}\n\nexport function requestMetricsRecorded(req: Request): boolean {\n  return recordedMetrics.get(req) === true;\n}\n", "import type { Env } from \"../env\";\r\nimport { claimDeviceIfUnowned, verifyDeviceKey } from \"../lib/device\";\r\nimport { json } from \"../utils/responses\";\r\nimport { evaluateCors, withCors } from \"../lib/cors\";\nimport { checkIpRateLimit } from \"../lib/ip-rate-limit\";\nimport {\r\n  parseAndCheckTs,\r\n  nowISO,\r\n  hmacSha256Hex,\r\n  timingSafeEqual,\r\n} from \"../utils\";\r\nimport { validationErrorResponse } from \"../utils/validation\";\r\nimport { HeartbeatPayloadSchema, TelemetryPayloadSchema } from \"../schemas/ingest\";\r\nimport type { HeartbeatPayload, TelemetryPayload } from \"../schemas/ingest\";\r\nimport { deriveTelemetryMetrics } from \"../telemetry\";\r\nimport { ingestDedupWindowMs } from \"../utils/ingest-dedup\";\r\nimport { loggerForRequest, type Logger } from \"../utils/logging\";\r\nimport { recordOpsMetric } from \"../lib/ops-metrics\";\r\nimport { markRequestMetricsRecorded } from \"../lib/request-metrics\";\r\nimport { withTransaction } from \"../lib/db\";\r\n\r\nconst DEVICE_KEY_HEADER = \"X-GREENBRO-DEVICE-KEY\";\r\nconst SIGNATURE_HEADER = \"X-GREENBRO-SIGNATURE\";\r\nconst TIMESTAMP_HEADER = \"X-GREENBRO-TIMESTAMP\";\r\nconst INGEST_ROUTE = \"/api/ingest\";\r\nconst HEARTBEAT_ROUTE = \"/api/heartbeat\";\r\n\r\nconst textEncoder = new TextEncoder();\r\n\r\ntype SignatureValidation =\r\n  | { ok: true }\r\n  | { ok: false; status: number; error: string };\r\n\r\nfunction signatureToleranceMs(env: Env) {\r\n  const raw = env.INGEST_SIGNATURE_TOLERANCE_SECS;\r\n  const parsed = raw ? Number(raw) : NaN;\r\n  const seconds = Number.isFinite(parsed) && parsed > 0 ? parsed : 300;\r\n  return seconds * 1000;\r\n}\r\n\r\nfunction parseSignatureTimestamp(raw: string): number | null {\r\n  const value = raw.trim();\r\n  if (!value) return null;\r\n  if (/^\\d{10,}$/.test(value)) {\r\n    const numeric = Number(value);\r\n    if (!Number.isFinite(numeric)) return null;\r\n    if (value.length <= 10) {\r\n      return numeric * 1000;\r\n    }\r\n    return numeric;\r\n  }\r\n  const parsed = Date.parse(value);\r\n  return Number.isNaN(parsed) ? null : parsed;\r\n}\r\n\r\nfunction parsePositiveInt(raw: string | undefined, fallback: number): number {\r\n  if (!raw) return fallback;\r\n  const parsed = Number.parseInt(raw, 10);\r\n  if (!Number.isFinite(parsed) || parsed <= 0) return fallback;\r\n  return parsed;\r\n}\r\n\r\nfunction parseNonNegativeInt(raw: string | undefined, fallback: number): number {\r\n  if (!raw) return fallback;\r\n  const parsed = Number.parseInt(raw, 10);\r\n  if (!Number.isFinite(parsed) || parsed < 0) return fallback;\r\n  return parsed;\r\n}\r\n\r\nfunction parsedRateLimit(env: Env): number {\r\n  return parsePositiveInt(env.INGEST_RATE_LIMIT_PER_MIN, 120);\r\n}\r\n\r\nfunction parsedFailureLimit(env: Env, overallLimit: number): number {\r\n  const explicit = parseNonNegativeInt(env.INGEST_FAILURE_LIMIT_PER_MIN, -1);\r\n  if (explicit >= 0) {\r\n    return explicit;\r\n  }\r\n  if (overallLimit > 0) {\r\n    return Math.max(10, Math.floor(overallLimit / 2));\r\n  }\r\n  return 0;\r\n}\r\n\r\nasync function isRateLimited(\r\n  env: Env,\r\n  route: string,\r\n  deviceId: string,\r\n  limitPerMinute: number,\r\n) {\r\n  if (limitPerMinute <= 0) return false;\r\n  const sinceIso = new Date(Date.now() - 60_000).toISOString();\r\n  const row = await env.DB\r\n    .prepare(\r\n      `SELECT COUNT(*) AS cnt\r\n         FROM ops_metrics\r\n        WHERE device_id = ?1\r\n          AND route = ?2\r\n          AND ts >= ?3`,\r\n    )\r\n    .bind(deviceId, route, sinceIso)\r\n    .first<{ cnt: number | string | null }>();\r\n  const rawCount = row?.cnt ?? 0;\r\n  const count = typeof rawCount === \"number\" ? rawCount : Number(rawCount);\r\n  return Number.isFinite(count) && count >= limitPerMinute;\r\n}\r\n\r\nasync function isFailureRateLimited(\r\n  env: Env,\r\n  route: string,\r\n  deviceId: string,\r\n  failureLimitPerMinute: number,\r\n) {\r\n  if (failureLimitPerMinute <= 0) return false;\r\n  const sinceIso = new Date(Date.now() - 60_000).toISOString();\r\n  const row = await env.DB\r\n    .prepare(\r\n      `SELECT COUNT(*) AS cnt\r\n         FROM ops_metrics\r\n        WHERE device_id = ?1\r\n          AND route = ?2\r\n          AND ts >= ?3\r\n          AND status_code >= 400`,\r\n    )\r\n    .bind(deviceId, route, sinceIso)\r\n    .first<{ cnt: number | string | null }>();\r\n  const rawCount = row?.cnt ?? 0;\r\n  const count = typeof rawCount === \"number\" ? rawCount : Number(rawCount);\r\n  return Number.isFinite(count) && count >= failureLimitPerMinute;\r\n}\r\n\r\nfunction isNonceConflict(error: unknown): boolean {\r\n  if (!error) return false;\r\n  const message =\r\n    error instanceof Error ? error.message :\r\n    typeof error === \"string\" ? error :\r\n    \"\";\r\n  if (!message) return false;\r\n  return (\r\n    message.includes(\"ingest_nonces\") &&\r\n    message.toLowerCase().includes(\"unique constraint failed\")\r\n  );\r\n}\r\n\r\nasync function ensureSignature(\r\n  req: Request,\r\n  env: Env,\r\n  payload: string,\r\n  deviceKeyHash: string,\r\n): Promise<SignatureValidation> {\r\n  const signatureHeader = req.headers.get(SIGNATURE_HEADER);\r\n  const timestampHeader = req.headers.get(TIMESTAMP_HEADER);\r\n  if (!signatureHeader || !timestampHeader) {\r\n    return { ok: false, status: 401, error: \"Missing signature headers\" };\r\n  }\r\n\r\n  const trimmedTimestamp = timestampHeader.trim();\r\n  const normalizedSignature = signatureHeader.trim().toLowerCase();\r\n  if (!trimmedTimestamp) {\r\n    return { ok: false, status: 400, error: \"Invalid signature timestamp\" };\r\n  }\r\n  if (!normalizedSignature) {\r\n    return { ok: false, status: 401, error: \"Invalid signature\" };\r\n  }\r\n\r\n  const tsMs = parseSignatureTimestamp(trimmedTimestamp);\r\n  if (tsMs === null) {\r\n    return { ok: false, status: 400, error: \"Invalid signature timestamp\" };\r\n  }\r\n\r\n  const toleranceMs = signatureToleranceMs(env);\r\n  if (Math.abs(Date.now() - tsMs) > toleranceMs) {\r\n    return {\r\n      ok: false,\r\n      status: 401,\r\n      error: \"Signature timestamp outside tolerance\",\r\n    };\r\n  }\r\n\r\n  const expected = await hmacSha256Hex(deviceKeyHash, `${trimmedTimestamp}.${payload}`);\r\n  if (!timingSafeEqual(expected, normalizedSignature)) {\r\n    return { ok: false, status: 401, error: \"Invalid signature\" };\r\n  }\r\n\r\n  return { ok: true };\r\n}\r\n\r\nfunction readRawBody(raw: string): unknown {\r\n  if (!raw) return null;\r\n  return JSON.parse(raw);\r\n}\r\n\r\nfunction payloadSizeOk(raw: string) {\r\n  return textEncoder.encode(raw).length <= 256_000;\r\n}\r\n\r\ntype EarlyExitLevel = \"info\" | \"warn\" | \"error\";\r\n\r\nasync function logAndRecordEarlyExit(\r\n  req: Request,\r\n  env: Env,\r\n  route: string,\r\n  statusCode: number,\r\n  t0: number,\r\n  log: Logger,\r\n  event: string,\r\n  options: {\r\n    deviceId?: string | null;\r\n    level?: EarlyExitLevel;\r\n    fields?: Record<string, unknown>;\r\n  } = {},\r\n) {\r\n  const { deviceId = null, level, fields } = options;\r\n  const scopedLog = deviceId ? log.with({ device_id: deviceId }) : log;\r\n  await recordOpsMetric(env, route, statusCode, Date.now() - t0, deviceId, scopedLog);\r\n  markRequestMetricsRecorded(req);\r\n  const severity: EarlyExitLevel =\r\n    level ?? (statusCode >= 500 ? \"error\" : statusCode >= 400 ? \"warn\" : \"info\");\r\n  const payload = { status_code: statusCode, ...(fields ?? {}) };\r\n  if (severity === \"error\") {\r\n    scopedLog.error(event, payload);\r\n  } else if (severity === \"info\") {\r\n    scopedLog.info(event, payload);\r\n  } else {\r\n    scopedLog.warn(event, payload);\r\n  }\r\n}\r\n\r\nexport async function handleIngest(req: Request, env: Env, profileId: string) {\r\n  const t0 = Date.now();\r\n  const log = loggerForRequest(req, { route: `${INGEST_ROUTE}/:profile`, profile_id: profileId });\n  const cors = evaluateCors(req, env);\n  if (!cors.allowed) {\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 403, t0, log, \"ingest.cors_blocked\", {\n      fields: { reason: \"origin_not_allowed\", origin: cors.origin },\n      level: \"warn\",\n    });\n    return json({ error: \"Origin not allowed\" }, { status: 403 });\n  }\n\n  const ipDecision = await checkIpRateLimit(req, env, INGEST_ROUTE);\n  if (ipDecision?.limited) {\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 429, t0, log, \"ingest.ip_rate_limited\", {\n      fields: {\n        reason: \"ip_rate_limited\",\n        client_ip: ipDecision.ip,\n        limit_per_minute: ipDecision.limit,\n        retry_after_seconds: ipDecision.retryAfterSeconds,\n      },\n      level: \"warn\",\n    });\n    const rateResponse = json({ error: \"Rate limit exceeded\" }, { status: 429 });\n    if (ipDecision.retryAfterSeconds != null) {\n      rateResponse.headers.set(\"Retry-After\", String(ipDecision.retryAfterSeconds));\n    }\n    return withCors(req, env, rateResponse, cors);\n  }\n\r\n  let rawBodyText: string;\r\n  try {\r\n    rawBodyText = await req.text();\r\n  } catch (error) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 400, t0, log, \"ingest.body_read_failed\", {\r\n      fields: { reason: \"invalid_json\", error },\r\n      level: \"warn\",\r\n    });\r\n    return withCors(req, env, json({ error: \"Invalid JSON\" }, { status: 400 }), cors);\r\n  }\r\n\r\n  if (!payloadSizeOk(rawBodyText)) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 413, t0, log, \"ingest.payload_too_large\", {\r\n      fields: { reason: \"payload_too_large\" },\r\n    });\r\n    return withCors(req, env, json({ error: \"Payload too large\" }, { status: 413 }), cors);\r\n  }\r\n\r\n  let rawBody: unknown;\r\n  try {\r\n    rawBody = readRawBody(rawBodyText);\r\n  } catch (error) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 400, t0, log, \"ingest.invalid_json\", {\r\n      fields: { reason: \"invalid_json\", error },\r\n      level: \"warn\",\r\n    });\r\n    return withCors(req, env, json({ error: \"Invalid JSON\" }, { status: 400 }), cors);\r\n  }\r\n\r\n  const parsedBody = TelemetryPayloadSchema.safeParse(rawBody);\r\n  if (!parsedBody.success) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 400, t0, log, \"ingest.validation_failed\", {\r\n      fields: {\r\n        reason: \"validation_failed\",\r\n        issue_count: parsedBody.error.issues.length,\r\n      },\r\n    });\r\n    return withCors(req, env, validationErrorResponse(parsedBody.error), cors);\r\n  }\r\n  const body: TelemetryPayload = parsedBody.data;\r\n\r\n  const tsCheck = parseAndCheckTs(body.ts);\r\n  if (!tsCheck.ok) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 400, t0, log, \"ingest.invalid_timestamp\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: tsCheck.reason },\r\n    });\r\n    return withCors(req, env, json({ error: tsCheck.reason }, { status: 400 }), cors);\r\n  }\r\n  const tsMs = tsCheck.ms!;\r\n\r\n  const limitPerMinute = parsedRateLimit(env);\r\n  const failureLimitPerMinute = parsedFailureLimit(env, limitPerMinute);\r\n\r\n  if (\r\n    await isFailureRateLimited(env, INGEST_ROUTE, body.device_id, failureLimitPerMinute)\r\n  ) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 429, t0, log, \"ingest.failure_rate_limited\", {\r\n      deviceId: body.device_id,\r\n      fields: {\r\n        reason: \"failure_rate_limited\",\r\n        failure_limit_per_minute: failureLimitPerMinute,\r\n      },\r\n    });\r\n    return withCors(req, env, json({ error: \"Rate limit exceeded\" }, { status: 429 }), cors);\r\n  }\r\n\r\n  if (await isRateLimited(env, INGEST_ROUTE, body.device_id, limitPerMinute)) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 429, t0, log, \"ingest.rate_limited\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: \"rate_limited\", limit_per_minute: limitPerMinute },\r\n    });\r\n    return withCors(req, env, json({ error: \"Rate limit exceeded\" }, { status: 429 }), cors);\r\n  }\r\n\r\n  const keyHeader = req.headers.get(DEVICE_KEY_HEADER);\r\n  const keyVerification = await verifyDeviceKey(env, body.device_id, keyHeader);\r\n  if (!keyVerification.ok || !keyVerification.deviceKeyHash) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 401, t0, log, \"ingest.unauthorized_device_key\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: \"invalid_device_key\" },\r\n    });\r\n    return withCors(req, env, json({ error: \"Unauthorized\" }, { status: 401 }), cors);\r\n  }\r\n\r\n  const signatureCheck = await ensureSignature(req, env, rawBodyText, keyVerification.deviceKeyHash);\r\n  if (!signatureCheck.ok) {\r\n    await logAndRecordEarlyExit(\r\n      req,\r\n      env,\r\n      INGEST_ROUTE,\r\n      signatureCheck.status,\r\n      t0,\r\n      log,\r\n      \"ingest.signature_failure\",\r\n      {\r\n        deviceId: body.device_id,\r\n        fields: { reason: signatureCheck.error },\r\n      },\r\n    );\r\n    return withCors(\r\n      req,\r\n      env,\r\n      json({ error: signatureCheck.error }, { status: signatureCheck.status }),\r\n      cors,\r\n    );\r\n  }\r\n\r\n  const devRow = await env.DB\r\n    .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1`)\r\n    .bind(body.device_id)\r\n    .first<{ profile_id?: string | null }>();\r\n\r\n  if (!devRow) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 401, t0, log, \"ingest.unknown_device\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: \"unknown_device\" },\r\n    });\r\n    return withCors(\r\n      req,\r\n      env,\r\n      json({ error: \"Unauthorized (unknown device)\" }, { status: 401 }),\r\n      cors,\r\n    );\r\n  }\r\n\r\n  if (devRow.profile_id && devRow.profile_id !== profileId) {\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 409, t0, log, \"ingest.profile_mismatch\", {\r\n      deviceId: body.device_id,\r\n      fields: {\r\n        reason: \"profile_mismatch\",\r\n        db_profile_id: devRow.profile_id,\r\n        requested_profile_id: profileId,\r\n      },\r\n    });\r\n    return withCors(\r\n      req,\r\n      env,\r\n      json({ error: \"Profile mismatch for device\" }, { status: 409 }),\r\n      cors,\r\n    );\r\n  }\r\n\r\n  if (!devRow.profile_id) {\r\n    const claim = await claimDeviceIfUnowned(env, body.device_id, profileId);\r\n    if (!claim.ok && claim.reason === \"claimed_by_other\") {\r\n      await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 409, t0, log, \"ingest.claim_conflict\", {\r\n        deviceId: body.device_id,\r\n        fields: { reason: \"claim_conflict\" },\r\n      });\r\n      return withCors(\r\n        req,\r\n        env,\r\n        json({ error: \"Profile mismatch for device\" }, { status: 409 }),\r\n        cors,\r\n      );\r\n    }\r\n  }\r\n\r\n  const supply = typeof body.metrics.supplyC === \"number\" ? body.metrics.supplyC : null;\r\n  const ret = typeof body.metrics.returnC === \"number\" ? body.metrics.returnC : null;\r\n  const flow = typeof body.metrics.flowLps === \"number\" ? body.metrics.flowLps : null;\r\n  const powerKW = typeof body.metrics.powerKW === \"number\" ? body.metrics.powerKW : null;\r\n\r\n  const { deltaT, thermalKW, cop, cop_quality } = deriveTelemetryMetrics({\r\n    supplyC: supply,\r\n    returnC: ret,\r\n    flowLps: flow,\r\n    powerKW,\r\n  });\r\n\r\n  const sanitizedMetricsJson = JSON.stringify(body.metrics);\r\n  const faults_json = JSON.stringify(body.faults || []);\r\n  const status_json = JSON.stringify({\r\n    mode: body.metrics.mode ?? null,\r\n    defrost: body.metrics.defrost ?? 0,\r\n    rssi: body.rssi ?? null,\r\n  });\r\n\r\n  const dedupWindowMs = ingestDedupWindowMs(env);\r\n  const dedupExpiresAt = tsMs + dedupWindowMs;\r\n  const dedupCleanupCutoff = Date.now();\r\n\r\n  try {\r\n    const updatedAtIso = nowISO();\r\n    const lastSeenIso = new Date(tsMs).toISOString();\r\n\r\n    await withTransaction(env.DB, async () => {\r\n      await env.DB\r\n        .prepare(\r\n          `DELETE FROM ingest_nonces WHERE device_id = ?1 AND ts_ms = ?2 AND expires_at < ?3`,\r\n        )\r\n        .bind(body.device_id, tsMs, dedupCleanupCutoff)\r\n        .run();\r\n\r\n      await env.DB\r\n        .prepare(\r\n          `INSERT INTO telemetry (device_id, ts, metrics_json, deltaT, thermalKW, cop, cop_quality, status_json, faults_json)\r\n           VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9)\r\n           ON CONFLICT (device_id, ts) DO NOTHING`,\r\n        )\r\n        .bind(\r\n          body.device_id,\r\n          tsMs,\r\n          sanitizedMetricsJson,\r\n          deltaT,\r\n          thermalKW,\r\n          cop,\r\n          cop_quality,\r\n          status_json,\r\n          faults_json,\r\n        )\r\n        .run();\r\n\r\n      await env.DB\r\n        .prepare(\r\n          `INSERT INTO latest_state\r\n             (device_id, ts, supplyC, returnC, tankC, ambientC, flowLps, compCurrentA, eevSteps, powerKW,\r\n              deltaT, thermalKW, cop, cop_quality, mode, defrost, online, payload_json, faults_json, updated_at)\r\n           VALUES (?1,?2,?3,?4,?5,?6,?7,?8,?9,?10,?11,?12,?13,?14,?15,?16,1,?17,?18,?19)\r\n           ON CONFLICT(device_id) DO UPDATE SET\r\n              ts=excluded.ts, supplyC=excluded.supplyC, returnC=excluded.returnC, tankC=excluded.tankC,\r\n              ambientC=excluded.ambientC, flowLps=excluded.flowLps, compCurrentA=excluded.compCurrentA,\r\n              eevSteps=excluded.eevSteps, powerKW=excluded.powerKW, deltaT=excluded.deltaT,\r\n              thermalKW=excluded.thermalKW, cop=excluded.cop, cop_quality=excluded.cop_quality,\r\n              mode=excluded.mode, defrost=excluded.defrost, online=1, payload_json=excluded.payload_json,\r\n              faults_json=excluded.faults_json, updated_at=excluded.updated_at`,\r\n        )\r\n        .bind(\r\n          body.device_id,\r\n          tsMs,\r\n          supply,\r\n          ret,\r\n          body.metrics.tankC ?? null,\r\n          body.metrics.ambientC ?? null,\r\n          flow,\r\n          body.metrics.compCurrentA ?? null,\r\n          body.metrics.eevSteps ?? null,\r\n          body.metrics.powerKW ?? null,\r\n          deltaT,\r\n          thermalKW,\r\n          cop,\r\n          cop_quality,\r\n          body.metrics.mode ?? null,\r\n          body.metrics.defrost ?? 0,\r\n          sanitizedMetricsJson,\r\n          faults_json,\r\n          updatedAtIso,\r\n        )\r\n        .run();\r\n\r\n      await env.DB\r\n        .prepare(`UPDATE devices SET online=1, last_seen_at=?2 WHERE device_id=?1`)\r\n        .bind(body.device_id, lastSeenIso)\r\n        .run();\r\n\r\n      await env.DB\r\n        .prepare(`INSERT INTO ingest_nonces (device_id, ts_ms, expires_at) VALUES (?1, ?2, ?3)`)\r\n        .bind(body.device_id, tsMs, dedupExpiresAt)\r\n        .run();\r\n    });\r\n\r\n    const deviceLog = log.with({ device_id: body.device_id });\r\n    await recordOpsMetric(env, INGEST_ROUTE, 200, Date.now() - t0, body.device_id, deviceLog);\r\n    markRequestMetricsRecorded(req);\r\n    deviceLog.info(\"ingest.telemetry_stored\", {\r\n      payload_ts: new Date(tsMs).toISOString(),\r\n      faults_count: body.faults?.length ?? 0,\r\n      delta_t: deltaT,\r\n      thermal_kw: thermalKW,\r\n      cop,\r\n    });\r\n    return withCors(req, env, json({ ok: true }), cors);\r\n  } catch (e: any) {\r\n    if (isNonceConflict(e)) {\r\n      await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 409, t0, log, \"ingest.duplicate_payload\", {\r\n        deviceId: body.device_id,\r\n        fields: {\r\n          reason: \"duplicate_payload\",\r\n          payload_ts: new Date(tsMs).toISOString(),\r\n          dedup_window_ms: dedupWindowMs,\r\n        },\r\n      });\r\n      return withCors(\r\n        req,\r\n        env,\r\n        json({ error: \"Duplicate payload\" }, { status: 409 }),\r\n        cors,\r\n      );\r\n    }\r\n\r\n    await logAndRecordEarlyExit(req, env, INGEST_ROUTE, 500, t0, log, \"ingest.db_error\", {\r\n      deviceId: body.device_id,\r\n      level: \"error\",\r\n      fields: { reason: \"db_error\", error: e },\r\n    });\r\n    return withCors(\r\n      req,\r\n      env,\r\n      json({ error: \"DB error\" }, { status: 500 }),\r\n      cors,\r\n    );\r\n  }\r\n}\r\n\r\nexport async function handleHeartbeat(req: Request, env: Env, profileId: string) {\n  const t0 = Date.now();\n  const log = loggerForRequest(req, { route: `${HEARTBEAT_ROUTE}/:profile`, profile_id: profileId });\n  const cors = evaluateCors(req, env);\n  if (!cors.allowed) {\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 403, t0, log, \"heartbeat.cors_blocked\", {\r\n      fields: { reason: \"origin_not_allowed\", origin: cors.origin },\r\n      level: \"warn\",\r\n    });\n    return json({ error: \"Origin not allowed\" }, { status: 403 });\n  }\n\n  const ipDecision = await checkIpRateLimit(req, env, HEARTBEAT_ROUTE);\n  if (ipDecision?.limited) {\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 429, t0, log, \"heartbeat.ip_rate_limited\", {\n      fields: {\n        reason: \"ip_rate_limited\",\n        client_ip: ipDecision.ip,\n        limit_per_minute: ipDecision.limit,\n        retry_after_seconds: ipDecision.retryAfterSeconds,\n      },\n      level: \"warn\",\n    });\n    const rateResponse = json({ error: \"Rate limit exceeded\" }, { status: 429 });\n    if (ipDecision.retryAfterSeconds != null) {\n      rateResponse.headers.set(\"Retry-After\", String(ipDecision.retryAfterSeconds));\n    }\n    return withCors(req, env, rateResponse, cors);\n  }\n\n  let rawBodyText: string;\r\n  try {\r\n    rawBodyText = await req.text();\r\n  } catch (error) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 400, t0, log, \"heartbeat.body_read_failed\", {\r\n      fields: { reason: \"invalid_json\", error },\r\n      level: \"warn\",\r\n    });\r\n    return withCors(req, env, json({ error: \"Invalid JSON\" }, { status: 400 }), cors);\r\n  }\r\n\r\n  if (!payloadSizeOk(rawBodyText)) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 413, t0, log, \"heartbeat.payload_too_large\", {\r\n      fields: { reason: \"payload_too_large\" },\r\n    });\r\n    return withCors(req, env, json({ error: \"Payload too large\" }, { status: 413 }), cors);\r\n  }\r\n\r\n  let rawBody: unknown;\r\n  try {\r\n    rawBody = readRawBody(rawBodyText);\r\n  } catch (error) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 400, t0, log, \"heartbeat.invalid_json\", {\r\n      fields: { reason: \"invalid_json\", error },\r\n      level: \"warn\",\r\n    });\r\n    return withCors(req, env, json({ error: \"Invalid JSON\" }, { status: 400 }), cors);\r\n  }\r\n\r\n  const parsedBody = HeartbeatPayloadSchema.safeParse(rawBody);\r\n  if (!parsedBody.success) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 400, t0, log, \"heartbeat.validation_failed\", {\r\n      fields: {\r\n        reason: \"validation_failed\",\r\n        issue_count: parsedBody.error.issues.length,\r\n      },\r\n    });\r\n    return withCors(req, env, validationErrorResponse(parsedBody.error), cors);\r\n  }\r\n  const body: HeartbeatPayload = parsedBody.data;\r\n\r\n  const tsStr = body.ts ?? new Date().toISOString();\r\n  const tsCheck = parseAndCheckTs(tsStr);\r\n  if (!tsCheck.ok) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 400, t0, log, \"heartbeat.invalid_timestamp\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: tsCheck.reason },\r\n    });\r\n    return withCors(req, env, json({ error: tsCheck.reason }, { status: 400 }), cors);\r\n  }\r\n\r\n  const heartRateLimit = parsedRateLimit(env);\r\n  const heartFailureLimit = parsedFailureLimit(env, heartRateLimit);\r\n\r\n  if (\r\n    await isFailureRateLimited(env, HEARTBEAT_ROUTE, body.device_id, heartFailureLimit)\r\n  ) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 429, t0, log, \"heartbeat.failure_rate_limited\", {\r\n      deviceId: body.device_id,\r\n      fields: {\r\n        reason: \"failure_rate_limited\",\r\n        failure_limit_per_minute: heartFailureLimit,\r\n      },\r\n    });\r\n    return withCors(req, env, json({ error: \"Rate limit exceeded\" }, { status: 429 }), cors);\r\n  }\r\n\r\n  if (await isRateLimited(env, HEARTBEAT_ROUTE, body.device_id, heartRateLimit)) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 429, t0, log, \"heartbeat.rate_limited\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: \"rate_limited\", limit_per_minute: heartRateLimit },\r\n    });\r\n    return withCors(req, env, json({ error: \"Rate limit exceeded\" }, { status: 429 }), cors);\r\n  }\r\n\r\n  const keyHeader = req.headers.get(DEVICE_KEY_HEADER);\r\n  const keyVerification = await verifyDeviceKey(env, body.device_id, keyHeader);\r\n  if (!keyVerification.ok || !keyVerification.deviceKeyHash) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 401, t0, log, \"heartbeat.unauthorized_device_key\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: \"invalid_device_key\" },\r\n    });\r\n    return withCors(req, env, json({ error: \"Unauthorized\" }, { status: 401 }), cors);\r\n  }\r\n\r\n  const signatureCheck = await ensureSignature(req, env, rawBodyText, keyVerification.deviceKeyHash);\r\n  if (!signatureCheck.ok) {\r\n    await logAndRecordEarlyExit(\r\n      req,\r\n      env,\r\n      HEARTBEAT_ROUTE,\r\n      signatureCheck.status,\r\n      t0,\r\n      log,\r\n      \"heartbeat.signature_failure\",\r\n      {\r\n        deviceId: body.device_id,\r\n        fields: { reason: signatureCheck.error },\r\n      },\r\n    );\r\n    return withCors(\r\n      req,\r\n      env,\r\n      json({ error: signatureCheck.error }, { status: signatureCheck.status }),\r\n      cors,\r\n    );\r\n  }\r\n\r\n  const devRow = await env.DB\r\n    .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1`)\r\n    .bind(body.device_id)\r\n    .first<{ profile_id?: string | null }>();\r\n\r\n  if (!devRow) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 401, t0, log, \"heartbeat.unknown_device\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: \"unknown_device\" },\r\n    });\r\n    return withCors(\r\n      req,\r\n      env,\r\n      json({ error: \"Unauthorized (unknown device)\" }, { status: 401 }),\r\n      cors,\r\n    );\r\n  }\r\n\r\n  if (devRow.profile_id && devRow.profile_id !== profileId) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 409, t0, log, \"heartbeat.profile_mismatch\", {\r\n      deviceId: body.device_id,\r\n      fields: {\r\n        reason: \"profile_mismatch\",\r\n        db_profile_id: devRow.profile_id,\r\n        requested_profile_id: profileId,\r\n      },\r\n    });\r\n    return withCors(\r\n      req,\r\n      env,\r\n      json({ error: \"Profile mismatch for device\" }, { status: 409 }),\r\n      cors,\r\n    );\r\n  }\r\n\r\n  if (!devRow.profile_id) {\r\n    const claim = await claimDeviceIfUnowned(env, body.device_id, profileId);\r\n    if (!claim.ok && claim.reason === \"claimed_by_other\") {\r\n      await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 409, t0, log, \"heartbeat.claim_conflict\", {\r\n        deviceId: body.device_id,\r\n        fields: { reason: \"claim_conflict\" },\r\n      });\r\n      return withCors(\r\n        req,\r\n        env,\r\n        json({ error: \"Profile mismatch for device\" }, { status: 409 }),\r\n        cors,\r\n      );\r\n    }\r\n  }\r\n\r\n  const limitPerMinute = parsedRateLimit(env);\r\n  if (await isRateLimited(env, HEARTBEAT_ROUTE, body.device_id, limitPerMinute)) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 429, t0, log, \"heartbeat.rate_limited\", {\r\n      deviceId: body.device_id,\r\n      fields: { reason: \"rate_limited\", limit_per_minute: limitPerMinute },\r\n    });\r\n    return withCors(req, env, json({ error: \"Rate limit exceeded\" }, { status: 429 }), cors);\r\n  }\r\n\r\n  const tsMs = tsCheck.ms ?? Date.now();\r\n\r\n  try {\r\n    const updatedIso = new Date(tsMs).toISOString();\r\n    await withTransaction(env.DB, async () => {\r\n      await env.DB\r\n        .prepare(\r\n          `UPDATE latest_state\r\n              SET online=1, updated_at=?2, faults_json='[]'\r\n            WHERE device_id=?1`,\r\n        )\r\n        .bind(body.device_id, updatedIso)\r\n        .run();\r\n\r\n      await env.DB\r\n        .prepare(`UPDATE devices SET online=1, last_seen_at=?2 WHERE device_id=?1`)\r\n        .bind(body.device_id, updatedIso)\r\n        .run();\r\n    });\r\n\r\n    const deviceLog = log.with({ device_id: body.device_id });\r\n    await recordOpsMetric(env, HEARTBEAT_ROUTE, 200, Date.now() - t0, body.device_id, deviceLog);\n    markRequestMetricsRecorded(req);\r\n    deviceLog.info(\"heartbeat.accepted\", { payload_ts: new Date(tsMs).toISOString() });\r\n    return withCors(req, env, json({ ok: true, server_time: new Date().toISOString() }), cors);\r\n  } catch (e) {\r\n    await logAndRecordEarlyExit(req, env, HEARTBEAT_ROUTE, 500, t0, log, \"heartbeat.db_error\", {\r\n      deviceId: body.device_id,\r\n      level: \"error\",\r\n      fields: { reason: \"db_error\", error: e },\r\n    });\r\n    return withCors(req, env, json({ error: \"DB error\" }, { status: 500 }), cors);\r\n  }\r\n}\r\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser } from \"../lib/access\";\r\nimport { json } from \"../utils/responses\";\n\r\nexport async function handleMe(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n  return json(user);\r\n}\r\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser } from \"../lib/access\";\r\nimport { buildDeviceLookup, buildDeviceScope, presentDeviceId } from \"../lib/device\";\r\nimport { json } from \"../utils/responses\";\nimport { andWhere, nowISO } from \"../utils\";\nimport { loggerForRequest } from \"../utils/logging\";\n\r\nexport async function handleCommissioning(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n  const scope = buildDeviceScope(user);\r\n  if (scope.empty && !scope.isAdmin) {\r\n    return json({ generated_at: nowISO(), devices: [], summary: { total: 0, ready: 0 } });\r\n  }\r\n\r\n  let where = \"\";\r\n  const bind: any[] = [];\r\n  if (!scope.isAdmin) {\r\n    where = andWhere(where, scope.clause);\r\n    bind.push(...scope.bind);\r\n  }\r\n\r\n  const rows = await env.DB\r\n    .prepare(\r\n      `SELECT d.device_id, d.site, d.online, d.last_seen_at,\r\n              ls.supplyC, ls.returnC, ls.deltaT, ls.flowLps, ls.cop, ls.thermalKW,\r\n              ls.mode, ls.defrost, ls.powerKW, ls.updated_at\r\n         FROM devices d\r\n         LEFT JOIN latest_state ls ON ls.device_id = d.device_id\r\n         ${where}\r\n        ORDER BY d.device_id ASC`,\r\n    )\r\n    .bind(...bind)\r\n    .all<{\r\n      device_id: string;\r\n      site: string | null;\r\n      online: number;\r\n      last_seen_at: string | null;\r\n      supplyC: number | null;\r\n      returnC: number | null;\r\n      deltaT: number | null;\r\n      flowLps: number | null;\r\n      cop: number | null;\r\n      thermalKW: number | null;\r\n      mode: string | null;\r\n      defrost: number | null;\r\n      powerKW: number | null;\r\n      updated_at: string | null;\r\n    }>();\r\n\r\n  let devices;\r\n  try {\r\n    devices = await Promise.all(\r\n      (rows.results ?? []).map(async (row) => ({\r\n        device_id: presentDeviceId(row.device_id, scope.isAdmin),\r\n        lookup: await buildDeviceLookup(row.device_id, env, scope.isAdmin),\r\n        site: row.site ?? null,\r\n        online: !!row.online,\r\n        last_seen_at: row.last_seen_at ?? null,\r\n        supplyC: row.supplyC ?? null,\r\n        returnC: row.returnC ?? null,\r\n        deltaT: row.deltaT ?? null,\r\n        flowLps: row.flowLps ?? null,\r\n        cop: row.cop ?? null,\r\n        thermalKW: row.thermalKW ?? null,\r\n        mode: row.mode ?? null,\r\n        defrost: row.defrost ?? null,\r\n        powerKW: row.powerKW ?? null,\r\n        updated_at: row.updated_at ?? null,\r\n      })),\r\n    );\r\n  } catch (err) {\n    loggerForRequest(req, { route: \"/api/commissioning/checklist\" }).error(\n      \"commissioning.payload_failed\",\n      { error: err },\n    );\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\r\n  const ready = devices.filter((d: any) => d.online && d.deltaT !== null && d.flowLps !== null).length;\r\n\r\n  return json({\r\n    generated_at: nowISO(),\r\n    devices,\r\n    summary: {\r\n      total: devices.length,\r\n      ready,\r\n    },\r\n  });\r\n}\r\n", "import { json } from \"../utils/responses\";\nimport { nowISO } from \"../utils\";\n\r\nexport async function handleHealth() {\r\n  return json({ ok: true, ts: nowISO() });\r\n}\r\n", "import { z } from \"zod\";\nimport { numericParam } from \"./params\";\n\nexport const COMMISSIONING_STATUSES = [\"draft\", \"in_progress\", \"blocked\", \"completed\", \"failed\"] as const;\n\nexport const CommissioningStatusSchema = z.enum(COMMISSIONING_STATUSES);\n\nexport const CommissioningRunsQuerySchema = z\n  .object({\n    status: CommissioningStatusSchema.optional(),\n    device: z.string().trim().min(1).optional(),\n    profile: z.string().trim().min(1).optional(),\n    limit: numericParam({ integer: true, min: 1, max: 200, defaultValue: 50 }),\n    since: z.string().datetime({ offset: true }).optional(),\n    until: z.string().datetime({ offset: true }).optional(),\n  })\n  .strict();\n\nexport const CreateCommissioningRunSchema = z\n  .object({\n    run_id: z.string().trim().min(1).optional(),\n    device_id: z.string().trim().min(1),\n    profile_id: z.string().trim().min(1).optional(),\n    status: CommissioningStatusSchema.default(\"draft\"),\n    started_at: z.string().datetime({ offset: true }).optional(),\n    completed_at: z.string().datetime({ offset: true }).nullable().optional(),\n    checklist: z.array(z.string().trim().min(1)).optional(),\n    notes: z.string().trim().min(1).max(4000).optional(),\n    performed_by: z.string().trim().min(1).optional(),\n  })\n  .strict();\n\nexport type CommissioningRunsQuery = z.infer<typeof CommissioningRunsQuerySchema>;\nexport type CreateCommissioningRunInput = z.infer<typeof CreateCommissioningRunSchema>;\n", "import type { Env } from \"../env\";\r\nimport { nowISO } from \"../utils\";\r\nimport type { CommissioningRunRecord } from \"./commissioning-store\";\r\n\r\nconst encoder = new TextEncoder();\r\n\r\nconst REPORT_KEY_PREFIX = \"reports/commissioning/\";\r\nconst DEFAULT_TTL_SECONDS = 7 * 24 * 60 * 60; // 7 days\r\nconst PDF_LINE_HEIGHT = 18;\r\n\r\nconst PDF_ASCII_FALLBACKS: Record<string, string> = {\r\n  \"\\u00a0\": \" \",\r\n  \"\\u2013\": \"-\",\r\n  \"\\u2014\": \"-\",\r\n  \"\\u2018\": \"'\",\r\n  \"\\u2019\": \"'\",\r\n  \"\\u201c\": \"\\\"\",\r\n  \"\\u201d\": \"\\\"\",\r\n  \"\\u2022\": \"*\",\r\n};\r\n\r\nfunction sanitizePdfText(input: string): string {\r\n  return input\r\n    .normalize(\"NFKD\")\r\n    .replace(/[\\u0300-\\u036f]/g, \"\")\r\n    .split(\"\")\r\n    .map((char) => {\r\n      if (char === \"\\n\" || char === \"\\r\") return \"\\n\";\r\n      if (char === \"\\t\") return \" \";\r\n      if (char >= \" \" && char <= \"~\") return char;\r\n      return PDF_ASCII_FALLBACKS[char] ?? \"?\";\r\n    })\r\n    .join(\"\");\r\n}\r\n\r\ninterface PdfLayoutContext {\r\n  cursorX: number;\r\n  cursorY: number;\r\n  commands: string[];\r\n  lineHeight: number;\r\n}\r\n\r\nfunction escapePdfText(input: string): string {\r\n  const sanitized = sanitizePdfText(input);\r\n  return sanitized.replace(/\\\\/g, \"\\\\\\\\\").replace(/\\(/g, \"\\\\(\").replace(/\\)/g, \"\\\\)\").replace(/\\r?\\n/g, \" \");\r\n}\r\n\r\nfunction wrapText(text: string, maxWidth = 88): string[] {\r\n  const words = text.split(/\\s+/).filter(Boolean);\r\n  if (!words.length) return [\"\"];\r\n  const lines: string[] = [];\r\n  let current = \"\";\r\n  for (const word of words) {\r\n    const candidate = current ? `${current} ${word}` : word;\r\n    if (candidate.length <= maxWidth) {\r\n      current = candidate;\r\n    } else {\r\n      if (current) lines.push(current);\r\n      current = word;\r\n    }\r\n  }\r\n  if (current) lines.push(current);\r\n  return lines.length ? lines : [text.slice(0, maxWidth)];\r\n}\r\n\r\nfunction appendLine(layout: PdfLayoutContext, text: string) {\r\n  layout.commands.push(`(${escapePdfText(text)}) Tj`);\r\n  layout.cursorY -= layout.lineHeight;\r\n  layout.commands.push(`0 -${layout.lineHeight} Td`);\r\n}\r\n\r\nfunction buildContent(run: CommissioningRunRecord, generatedAt: string): string {\r\n  const lines: string[] = [];\r\n  lines.push(\"Commissioning Run Report\");\r\n  lines.push(`Run ID: ${run.run_id}`);\r\n  lines.push(`Device: ${run.device_id}`);\r\n  lines.push(`Profile: ${run.profile_id ?? \"n/a\"}`);\r\n  lines.push(`Status: ${run.status}`);\r\n  lines.push(`Started: ${run.started_at}`);\r\n  lines.push(`Completed: ${run.completed_at ?? \"n/a\"}`);\r\n  lines.push(`Performed By: ${run.performed_by ?? \"n/a\"}`);\r\n  lines.push(`Generated: ${generatedAt}`);\r\n\r\n  if (run.notes) {\r\n    lines.push(\"\");\r\n    lines.push(\"Notes:\");\r\n    const noteLines = wrapText(run.notes);\r\n    for (const line of noteLines) {\r\n      lines.push(`* ${line}`);\r\n    }\r\n  }\r\n\r\n  if (Array.isArray(run.checklist) && run.checklist.length) {\r\n    lines.push(\"\");\r\n    lines.push(\"Checklist:\");\r\n    for (const item of run.checklist) {\r\n      lines.push(`- ${item}`);\r\n    }\r\n  }\r\n\r\n  const layout: PdfLayoutContext = {\r\n    cursorX: 72,\r\n    cursorY: 720,\r\n    commands: [\"BT\", \"/F1 12 Tf\", \"72 720 Td\"],\r\n    lineHeight: PDF_LINE_HEIGHT,\r\n  };\r\n\r\n  for (const line of lines) {\r\n    appendLine(layout, line || \" \");\r\n  }\r\n\r\n  layout.commands.push(\"ET\");\r\n  return layout.commands.join(\"\\n\");\r\n}\r\n\r\nfunction assemblePdf(streamContent: string): Uint8Array {\r\n  const streamBytes = encodeLatin1(streamContent);\r\n  const objects: string[] = [];\r\n\r\n  objects[1] = `1 0 obj\r\n<< /Type /Catalog /Pages 2 0 R >>\r\nendobj\r\n`;\r\n\r\n  objects[2] = `2 0 obj\r\n<< /Type /Pages /Kids [3 0 R] /Count 1 >>\r\nendobj\r\n`;\r\n\r\n  objects[3] = `3 0 obj\r\n<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R /Resources << /Font << /F1 5 0 R >> >> >>\r\nendobj\r\n`;\r\n\r\n  objects[4] = `4 0 obj\r\n<< /Length ${streamBytes.length} >>\r\nstream\r\n${streamContent}\r\nendstream\r\nendobj\r\n`;\r\n\r\n  objects[5] = `5 0 obj\r\n<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>\r\nendobj\r\n`;\r\n\r\n  const header = `%PDF-1.4\r\n${String.fromCharCode(0xe2, 0xe3, 0xcf, 0xd3)}\r\n`;\r\n  let position = header.length;\r\n  const offsets: number[] = [0];\r\n  let body = header;\r\n\r\n  for (let i = 1; i <= 5; i++) {\r\n    const obj = objects[i];\r\n    offsets[i] = position;\r\n    body += obj;\r\n    position += obj.length;\r\n  }\r\n\r\n  const xrefStart = position;\r\n  let xref = `xref\r\n0 6\r\n0000000000 65535 f \r\n`;\r\n  for (let i = 1; i <= 5; i++) {\r\n    xref += `${offsets[i].toString().padStart(10, \"0\")} 00000 n \\n`;\r\n  }\r\n\r\n  const trailer = `trailer\r\n<< /Size 6 /Root 1 0 R >>\r\nstartxref\r\n${xrefStart}\r\n%%EOF\r\n`;\r\n\r\n  const pdfString = body + xref + trailer;\r\n  return encodeLatin1(pdfString);\r\n}\r\n\r\nfunction encodeLatin1(input: string): Uint8Array {\r\n  const bytes = new Uint8Array(input.length);\r\n  for (let i = 0; i < input.length; i += 1) {\r\n    bytes[i] = input.charCodeAt(i) & 0xff;\r\n  }\r\n  return bytes;\r\n}\r\nasync function signReportUrl(env: Env, key: string, method: string, ttlSeconds: number): Promise<string | null> {\r\n  if (!env.APP_BASE_URL || !env.ASSET_SIGNING_SECRET) {\r\n    return null;\r\n  }\r\n\r\n  const expires = Math.floor(Date.now() / 1000) + ttlSeconds;\r\n  const canonicalMethod = method.toUpperCase();\r\n  const payload = `${canonicalMethod}\\n${key}\\n${expires}`;\r\n  const cryptoKey = await crypto.subtle.importKey(\r\n    \"raw\",\r\n    encoder.encode(env.ASSET_SIGNING_SECRET),\r\n    { name: \"HMAC\", hash: \"SHA-256\" },\r\n    false,\r\n    [\"sign\"],\r\n  );\r\n  const mac = await crypto.subtle.sign(\"HMAC\", cryptoKey, encoder.encode(payload));\r\n  const signature = [...new Uint8Array(mac)].map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\r\n  const url = new URL(`/r2/${key}`, env.APP_BASE_URL);\r\n  url.searchParams.set(\"exp\", String(expires));\r\n  url.searchParams.set(\"sig\", signature);\r\n  return url.toString();\r\n}\r\n\r\nexport interface ReportGenerationResult {\r\n  key: string;\r\n  url: string | null;\r\n  generated_at: string;\r\n}\r\n\r\nexport async function generateCommissioningReport(\r\n  env: Env,\r\n  run: CommissioningRunRecord,\r\n  options: { keyPrefix?: string; expiresInSeconds?: number } = {},\r\n): Promise<ReportGenerationResult | null> {\r\n  const bucket = env.GB_BUCKET ?? env.APP_STATIC;\r\n  if (!bucket) {\r\n    return null;\r\n  }\r\n\r\n  const generatedAt = nowISO();\r\n  const streamContent = buildContent(run, generatedAt);\r\n  const pdfBytes = assemblePdf(streamContent);\r\n  const key = `${options.keyPrefix ?? REPORT_KEY_PREFIX}${run.run_id}.pdf`;\r\n\r\n  await bucket.put(key, pdfBytes, {\r\n    httpMetadata: { contentType: \"application/pdf\" },\r\n  });\r\n\r\n  let url = await signReportUrl(env, key, \"GET\", options.expiresInSeconds ?? DEFAULT_TTL_SECONDS);\r\n  if (!url && env.APP_BASE_URL) {\r\n    url = new URL(`/r2/${key}`, env.APP_BASE_URL).toString();\r\n  }\r\n  return { key, url, generated_at: generatedAt };\r\n}\r\n\r\n\r\n\r\n", "import type { Env } from \"../env\";\nimport { andWhere, nowISO } from \"../utils\";\nimport { generateCommissioningReport } from \"./commissioning-report\";\n\nexport interface CommissioningRunRecord {\n  run_id: string;\n  device_id: string;\n  profile_id: string | null;\n  status: string;\n  started_at: string;\n  completed_at: string | null;\n  checklist: string[] | null;\n  notes: string | null;\n  performed_by: string | null;\n  report_url: string | null;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface CreateCommissioningRunParams {\n  run_id?: string;\n  device_id: string;\n  profile_id?: string | null;\n  status: string;\n  started_at?: string;\n  completed_at?: string | null;\n  checklist?: string[] | null;\n  notes?: string | null;\n  performed_by?: string | null;\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport type CreateCommissioningRunResult =\n  | { ok: true; run: CommissioningRunRecord }\n  | { ok: false; reason: \"device_not_found\" | \"conflict\" };\n\nexport interface CommissioningRunFilters {\n  status?: string;\n  device_id?: string;\n  profile_id?: string;\n  profile_ids?: string[];\n  since?: string;\n  until?: string;\n  limit: number;\n}\n\ninterface CommissioningRow {\n  run_id: string;\n  device_id: string;\n  profile_id: string | null;\n  status: string;\n  started_at: string;\n  completed_at: string | null;\n  checklist_json: string | null;\n  notes: string | null;\n  performed_by: string | null;\n  report_url: string | null;\n  created_at: string;\n  updated_at: string;\n}\n\nfunction mapRunRow(row: CommissioningRow): CommissioningRunRecord {\n  let checklist: string[] | null = null;\n  if (row.checklist_json) {\n    try {\n      const parsed = JSON.parse(row.checklist_json);\n      if (Array.isArray(parsed)) checklist = parsed.filter((item) => typeof item === \"string\");\n    } catch {\n      checklist = null;\n    }\n  }\n  return {\n    run_id: row.run_id,\n    device_id: row.device_id,\n    profile_id: row.profile_id,\n    status: row.status,\n    started_at: row.started_at,\n    completed_at: row.completed_at,\n    checklist,\n    notes: row.notes,\n    performed_by: row.performed_by,\n    report_url: row.report_url,\n    created_at: row.created_at,\n    updated_at: row.updated_at,\n  };\n}\n\nexport async function createCommissioningRun(\n  env: Env,\n  params: CreateCommissioningRunParams,\n): Promise<CreateCommissioningRunResult> {\n  const deviceId = params.device_id;\n  const id = params.run_id ?? crypto.randomUUID();\n  const createdAt = params.created_at ?? nowISO();\n  const updatedAt = params.updated_at ?? createdAt;\n  const startedAt = params.started_at ?? createdAt;\n  const completedAt = params.completed_at ?? null;\n  const checklistJson = params.checklist ? JSON.stringify(params.checklist) : null;\n  const notes = params.notes ?? null;\n  const performedBy = params.performed_by ?? null;\n  const reportUrl = null;\n\n  let profileId: string | null | undefined = params.profile_id ?? null;\n\n  if (!profileId) {\n    const deviceRow = await env.DB\n      .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n      .bind(deviceId)\n      .first<{ profile_id: string | null }>();\n    if (!deviceRow) {\n      return { ok: false, reason: \"device_not_found\" };\n    }\n    profileId = deviceRow.profile_id ?? null;\n  } else {\n    const exists = await env.DB\n      .prepare(`SELECT 1 FROM devices WHERE device_id = ?1 LIMIT 1`)\n      .bind(deviceId)\n      .first();\n    if (!exists) {\n      return { ok: false, reason: \"device_not_found\" };\n    }\n  }\n\n  try {\n    await env.DB\n      .prepare(\n        `INSERT INTO commissioning_runs (\n            run_id, device_id, profile_id, status, started_at,\n            completed_at, checklist_json, notes, performed_by,\n            report_url, created_at, updated_at\n          ) VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, ?10, ?11, ?12)`,\n      )\n      .bind(\n        id,\n        deviceId,\n        profileId,\n        params.status,\n        startedAt,\n        completedAt,\n        checklistJson,\n        notes,\n        performedBy,\n        reportUrl,\n        createdAt,\n        updatedAt,\n      )\n      .run();\n  } catch (err: any) {\n    const message = typeof err?.message === \"string\" ? err.message : String(err);\n    if (message.includes(\"UNIQUE constraint failed\")) {\n      return { ok: false, reason: \"conflict\" };\n    }\n    throw err;\n  }\n\n  const row = await env.DB\n    .prepare(`SELECT * FROM commissioning_runs WHERE run_id = ?1 LIMIT 1`)\n    .bind(id)\n    .first<CommissioningRow>();\n\n  if (!row) {\n    return { ok: false, reason: \"device_not_found\" };\n  }\n\n  let runRecord = mapRunRow(row);\n\n  if (runRecord.status === \"completed\" && !runRecord.report_url) {\n    try {\n      const report = await generateCommissioningReport(env, runRecord);\n      if (report?.url) {\n        const updatedAtNow = nowISO();\n        await env.DB\n          .prepare(`UPDATE commissioning_runs SET report_url = ?1, updated_at = ?2 WHERE run_id = ?3`)\n          .bind(report.url, updatedAtNow, runRecord.run_id)\n          .run();\n        runRecord = { ...runRecord, report_url: report.url, updated_at: updatedAtNow };\n      }\n    } catch (error) {\n      console.warn(\"commissioning.report_failed\", {\n        run_id: runRecord.run_id,\n        error,\n      });\n    }\n  }\n\n  return { ok: true, run: runRecord };\n}\n\nexport async function listCommissioningRuns(\n  env: Env,\n  filters: CommissioningRunFilters,\n): Promise<CommissioningRunRecord[]> {\n  let where = \"\";\n  const bind: any[] = [];\n\n  if (filters.status) {\n    where = andWhere(where, \"status = ?\");\n    bind.push(filters.status);\n  }\n\n  if (filters.device_id) {\n    where = andWhere(where, \"device_id = ?\");\n    bind.push(filters.device_id);\n  }\n\n  if (filters.profile_ids && filters.profile_ids.length) {\n    const placeholders = filters.profile_ids.map(() => \"?\").join(\",\");\n    where = andWhere(where, `profile_id IN (${placeholders})`);\n    bind.push(...filters.profile_ids);\n  } else if (filters.profile_id) {\n    where = andWhere(where, \"profile_id = ?\");\n    bind.push(filters.profile_id);\n  }\n\n  if (filters.since) {\n    where = andWhere(where, \"created_at >= ?\");\n    bind.push(filters.since);\n  }\n\n  if (filters.until) {\n    where = andWhere(where, \"created_at <= ?\");\n    bind.push(filters.until);\n  }\n\n  const sql = `SELECT * FROM commissioning_runs ${where} ORDER BY created_at DESC LIMIT ?`;\n  bind.push(filters.limit);\n\n  const rows = await env.DB.prepare(sql).bind(...bind).all<CommissioningRow>();\n  return (rows.results ?? []).map(mapRunRow);\n}\n", "import type { Env } from \"../env\";\nimport { requireAccessUser } from \"../lib/access\";\nimport {\n  buildDeviceLookup,\n  buildDeviceScope,\n  fetchDeviceMeta,\n  presentDeviceId,\n  resolveDeviceId,\n  type DeviceMeta,\n} from \"../lib/device\";\nimport { json } from \"../utils/responses\";\nimport { nowISO } from \"../utils\";\nimport {\n  CommissioningRunsQuerySchema,\n  CreateCommissioningRunSchema,\n  type CommissioningRunsQuery,\n  type CreateCommissioningRunInput,\n} from \"../schemas/commissioning\";\nimport { validationErrorResponse, validateWithSchema } from \"../utils/validation\";\nimport {\n  createCommissioningRun,\n  listCommissioningRuns,\n  type CommissioningRunRecord,\n} from \"../lib/commissioning-store\";\n\nasync function presentRun(\n  record: CommissioningRunRecord,\n  env: Env,\n  scope: ReturnType<typeof buildDeviceScope>,\n  meta: Map<string, DeviceMeta>,\n) {\n  const info = meta.get(record.device_id);\n  const outwardId = presentDeviceId(record.device_id, scope.isAdmin);\n  const lookup = await buildDeviceLookup(record.device_id, env, scope.isAdmin);\n  return {\n    run_id: record.run_id,\n    device_id: outwardId,\n    lookup,\n    profile_id: record.profile_id ?? info?.profile_id ?? null,\n    site: info?.site ?? null,\n    status: record.status,\n    started_at: record.started_at,\n    completed_at: record.completed_at,\n    checklist: record.checklist,\n    notes: record.notes,\n    performed_by: record.performed_by,\n    report_url: record.report_url,\n    created_at: record.created_at,\n    updated_at: record.updated_at,\n  };\n}\n\nexport async function handleListCommissioningRuns(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n\n  const scope = buildDeviceScope(user, \"cr\");\n  if (scope.empty && !scope.isAdmin) {\n    return json({ generated_at: nowISO(), runs: [] });\n  }\n\n  const url = new URL(req.url);\n  const paramsResult = validateWithSchema<CommissioningRunsQuery>(CommissioningRunsQuerySchema, {\n    status: url.searchParams.get(\"status\") ?? undefined,\n    device: url.searchParams.get(\"device\") ?? undefined,\n    profile: url.searchParams.get(\"profile\") ?? undefined,\n    limit: url.searchParams.get(\"limit\") ?? undefined,\n    since: url.searchParams.get(\"since\") ?? undefined,\n    until: url.searchParams.get(\"until\") ?? undefined,\n  });\n  if (!paramsResult.success) {\n    return validationErrorResponse(paramsResult.issues);\n  }\n  const params = paramsResult.data;\n\n  if (params.since && params.until) {\n    const sinceMs = Date.parse(params.since);\n    const untilMs = Date.parse(params.until);\n    if (!Number.isNaN(sinceMs) && !Number.isNaN(untilMs) && untilMs < sinceMs) {\n      return json({ error: \"Invalid range\" }, { status: 400 });\n    }\n  }\n\n  let deviceId: string | undefined;\n  if (params.device) {\n    const resolved = await resolveDeviceId(params.device, env, scope.isAdmin);\n    if (!resolved) {\n      return json({ error: \"Unknown device\" }, { status: 404 });\n    }\n    deviceId = resolved;\n  }\n\n  let profileIds: string[] | undefined;\n  let profileId: string | undefined;\n\n  if (scope.isAdmin) {\n    if (params.profile) profileId = params.profile;\n  } else {\n    const allowedProfiles = scope.bind as string[];\n    if (!allowedProfiles.length) {\n      return json({ generated_at: nowISO(), runs: [] });\n    }\n    if (params.profile) {\n      if (!allowedProfiles.includes(params.profile)) {\n        return json({ error: \"Forbidden\" }, { status: 403 });\n      }\n      profileIds = [params.profile];\n    } else {\n      profileIds = allowedProfiles;\n    }\n\n    if (deviceId) {\n      const deviceRow = await env.DB\n        .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n        .bind(deviceId)\n        .first<{ profile_id: string | null }>();\n      const deviceProfile = deviceRow?.profile_id ?? null;\n      if (!deviceProfile || !allowedProfiles.includes(deviceProfile)) {\n        return json({ error: \"Forbidden\" }, { status: 403 });\n      }\n    }\n  }\n\n  const limit = params.limit ?? 50;\n\n  const runs = await listCommissioningRuns(env, {\n    status: params.status ?? undefined,\n    device_id: deviceId,\n    profile_id: profileId,\n    profile_ids: profileIds,\n    since: params.since ?? undefined,\n    until: params.until ?? undefined,\n    limit,\n  });\n\n  const meta = await fetchDeviceMeta(env, runs.map((run) => run.device_id));\n  const items = await Promise.all(runs.map((run) => presentRun(run, env, scope, meta)));\n\n  return json({\n    generated_at: nowISO(),\n    runs: items,\n  });\n}\n\nexport async function handleCreateCommissioningRun(req: Request, env: Env) {\n  const user = await requireAccessUser(req, env);\n  if (!user) return json({ error: \"Unauthorized\" }, { status: 401 });\n\n  const scope = buildDeviceScope(user, \"cr\");\n  if (scope.empty && !scope.isAdmin) {\n    return json({ error: \"Forbidden\" }, { status: 403 });\n  }\n\n  let payload: unknown;\n  try {\n    payload = await req.json();\n  } catch {\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\n  }\n\n  const parseResult = validateWithSchema<CreateCommissioningRunInput>(CreateCommissioningRunSchema, payload);\n  if (!parseResult.success) {\n    return validationErrorResponse(parseResult.issues);\n  }\n  const body = parseResult.data;\n\n  const deviceId = await resolveDeviceId(body.device_id, env, scope.isAdmin);\n  if (!deviceId) {\n    return json({ error: \"Unknown device\" }, { status: 404 });\n  }\n\n  if (body.completed_at && body.started_at) {\n    const startedMs = Date.parse(body.started_at);\n    const completedMs = Date.parse(body.completed_at);\n    if (!Number.isNaN(startedMs) && !Number.isNaN(completedMs) && completedMs < startedMs) {\n      return json({ error: \"Invalid lifecycle timestamps\" }, { status: 400 });\n    }\n  }\n\n  let resolvedProfile = body.profile_id ?? null;\n  if (!scope.isAdmin) {\n    const allowedProfiles = scope.bind as string[];\n    const deviceRow = await env.DB\n      .prepare(`SELECT profile_id FROM devices WHERE device_id = ?1 LIMIT 1`)\n      .bind(deviceId)\n      .first<{ profile_id: string | null }>();\n    if (!deviceRow?.profile_id || !allowedProfiles.includes(deviceRow.profile_id)) {\n      return json({ error: \"Forbidden\" }, { status: 403 });\n    }\n    if (resolvedProfile && resolvedProfile !== deviceRow.profile_id) {\n      return json({ error: \"Profile mismatch\" }, { status: 400 });\n    }\n    resolvedProfile = deviceRow.profile_id;\n  }\n\n  const result = await createCommissioningRun(env, {\n    run_id: body.run_id,\n    device_id: deviceId,\n    profile_id: resolvedProfile,\n    status: body.status,\n    started_at: body.started_at,\n    completed_at: body.completed_at ?? null,\n    checklist: body.checklist ?? null,\n    notes: body.notes ?? null,\n    performed_by: body.performed_by ?? null,\n  });\n\n  if (!result.ok) {\n    if (result.reason === \"device_not_found\") {\n      return json({ error: \"Unknown device\" }, { status: 404 });\n    }\n    if (result.reason === \"conflict\") {\n      return json({ error: \"Run already exists\" }, { status: 409 });\n    }\n    return json({ error: \"Server error\" }, { status: 500 });\n  }\n\n  const meta = await fetchDeviceMeta(env, [result.run.device_id]);\n  const [run] = await Promise.all([presentRun(result.run, env, scope, meta)]);\n\n  return json({ ok: true, run }, { status: 201 });\n}\n", "import { z } from \"zod\";\n\nconst optionalLimitedString = (max: number) =>\n  z\n    .string()\n    .max(max)\n    .optional();\n\nconst optionalTrimmedString = (max: number) =>\n  z\n    .string()\n    .trim()\n    .max(max)\n    .optional();\n\nconst optionalStringRecord = z.record(z.union([z.string(), z.number(), z.boolean(), z.null()])).optional();\n\nexport const ClientErrorReportSchema = z\n  .object({\n    name: optionalTrimmedString(256),\n    message: optionalLimitedString(2048),\n    stack: optionalLimitedString(8192),\n    componentStack: optionalLimitedString(8192),\n    userAgent: optionalLimitedString(1024),\n    url: optionalLimitedString(2048),\n    timestamp: optionalTrimmedString(64),\n    release: optionalTrimmedString(128),\n    tags: optionalStringRecord,\n    extras: z.unknown().optional(),\n  })\n  .extend({\n    user: z\n      .object({\n        email: optionalTrimmedString(320),\n        roles: z.array(optionalTrimmedString(128)).optional(),\n        clientIds: z.array(optionalTrimmedString(128)).optional(),\n      })\n      .optional(),\n  })\n  .passthrough();\n\nexport type ClientErrorReport = z.infer<typeof ClientErrorReportSchema>;\n", "import type { Env } from \"../env\";\r\nimport { requireAccessUser } from \"../lib/access\";\r\nimport { ClientErrorReportSchema } from \"../schemas/observability\";\r\nimport type { ClientErrorReport } from \"../schemas/observability\";\r\nimport { loggerForRequest } from \"../utils/logging\";\r\nimport { json } from \"../utils/responses\";\r\nimport { validationErrorResponse, validateWithSchema } from \"../utils/validation\";\r\n\r\nconst ROUTE_PATH = \"/api/observability/client-errors\";\r\nconst DEFAULT_MAX_PAYLOAD_BYTES = 16_384;\r\nconst STACK_MAX_CHARS = 4_096;\r\nconst COMPONENT_STACK_MAX_CHARS = 4_096;\r\nconst MESSAGE_MAX_CHARS = 2_048;\r\nconst EXTRAS_MAX_BYTES = 4_096;\r\nconst encoder = new TextEncoder();\r\n\r\nexport async function handleClientErrorReport(req: Request, env: Env) {\r\n  const user = await requireAccessUser(req, env);\r\n  if (!user) {\r\n    return json({ error: \"Unauthorized\" }, { status: 401 });\r\n  }\r\n\r\n  let rawBody = \"\";\r\n  try {\r\n    rawBody = await req.text();\r\n  } catch {\r\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\r\n  }\r\n\r\n  const maxBytes = resolveMaxPayloadBytes(env);\r\n  if (encoder.encode(rawBody).length > maxBytes) {\r\n    return json({ error: \"Payload too large\" }, { status: 413 });\r\n  }\r\n\r\n  let payload: unknown;\r\n  try {\r\n    payload = rawBody ? JSON.parse(rawBody) : {};\r\n  } catch {\r\n    return json({ error: \"Invalid JSON\" }, { status: 400 });\r\n  }\r\n\r\n  const parsed = validateWithSchema<ClientErrorReport>(ClientErrorReportSchema, payload);\r\n  if (!parsed.success) {\r\n    return validationErrorResponse(parsed.issues);\r\n  }\r\n\r\n  const body = parsed.data;\r\n  const log = loggerForRequest(req, { route: ROUTE_PATH });\r\n\r\n  const sanitized = sanitizeClientErrorReport(body);\r\n\r\n  const userContext = {\r\n    email: user.email,\r\n    roles: user.roles,\r\n    client_ids: user.clientIds,\r\n  };\r\n\r\n  const logPayload: Record<string, unknown> = {\r\n    source: \"frontend\",\r\n    report: sanitized.report,\r\n    user: userContext,\r\n  };\r\n\r\n  if (sanitized.truncatedFields.length) {\r\n    logPayload.truncated_fields = sanitized.truncatedFields;\r\n  }\r\n\r\n  log.error(\"ui.error_boundary\", logPayload);\r\n\r\n  return json({ ok: true }, { status: 202 });\r\n}\r\n\r\nfunction resolveMaxPayloadBytes(env: Env): number {\r\n  const raw = env.OBSERVABILITY_MAX_BYTES?.trim();\r\n  if (!raw) return DEFAULT_MAX_PAYLOAD_BYTES;\r\n  const parsed = Number(raw);\r\n  return Number.isFinite(parsed) && parsed > 0 ? Math.floor(parsed) : DEFAULT_MAX_PAYLOAD_BYTES;\r\n}\r\n\r\nfunction sanitizeClientErrorReport(body: ClientErrorReport) {\r\n  const truncatedFields: string[] = [];\r\n\r\n  const report = {\r\n    name: body.name ?? null,\r\n    message: truncateString(body.message, MESSAGE_MAX_CHARS, truncatedFields, \"message\"),\r\n    stack: truncateString(body.stack, STACK_MAX_CHARS, truncatedFields, \"stack\"),\r\n    component_stack: truncateString(\r\n      body.componentStack,\r\n      COMPONENT_STACK_MAX_CHARS,\r\n      truncatedFields,\r\n      \"component_stack\",\r\n    ),\r\n    user_agent: body.userAgent ?? null,\r\n    url: body.url ?? null,\r\n    timestamp: body.timestamp ?? new Date().toISOString(),\r\n    release: body.release ?? null,\r\n    tags: body.tags ?? null,\r\n    extras: sanitizeExtras(body.extras, truncatedFields),\r\n    reporter_user: body.user ?? null,\r\n  };\r\n\r\n  return { report, truncatedFields };\r\n}\r\n\r\nfunction truncateString(\r\n  value: string | null | undefined,\r\n  maxLength: number,\r\n  truncatedFields: string[],\r\n  fieldName: string,\r\n): string | null {\r\n  if (typeof value !== \"string\") return value ?? null;\r\n  if (value.length <= maxLength) return value;\r\n  truncatedFields.push(fieldName);\n  return `${value.slice(0, maxLength)}...`;\n}\r\n\r\nfunction sanitizeExtras(extras: unknown, truncatedFields: string[]) {\r\n  if (extras === undefined) return undefined;\r\n  if (extras === null) return null;\r\n  try {\r\n    const serialized = JSON.stringify(extras);\r\n    if (encoder.encode(serialized).length <= EXTRAS_MAX_BYTES) {\r\n      return extras;\r\n    }\r\n    truncatedFields.push(\"extras\");\r\n    return {\r\n      truncated: true,\r\n      bytes: encoder.encode(serialized).length,\r\n      note: `extras truncated above ${EXTRAS_MAX_BYTES} bytes`,\r\n    };\r\n  } catch {\r\n    truncatedFields.push(\"extras\");\r\n    return {\r\n      truncated: true,\r\n      note: \"extras could not be serialized\",\r\n    };\r\n  }\r\n}\r\n", "import { Router } from \"itty-router\";\n\nimport { registerAdminRoutes } from \"./router/admin\";\nimport { registerDeviceRoutes } from \"./router/devices\";\nimport { withAccess } from \"./router/access\";\nimport type { AppRouter } from \"./router/params\";\nimport { withParam } from \"./router/params\";\nimport { registerMetricsRoutes } from \"./router/metrics\";\nimport { registerTelemetryRoutes } from \"./router/telemetry\";\nimport type { Env } from \"./env\";\nimport { json } from \"./utils/responses\";\nimport {\n  handleAlertsFeed,\n  handleCreateAlertRecord,\n  handleListAlertRecords,\n  handleUpdateAlertRecord,\n  handleCreateAlertComment,\n} from \"./routes/alerts\";\nimport { handleArchive } from \"./routes/archive\";\nimport { handleClientCompact } from \"./routes/client\";\nimport { handleFleetAdminOverview } from \"./routes/admin\";\nimport { handleFleetSummary } from \"./routes/fleet\";\nimport { handleHeartbeat, handleIngest } from \"./routes/ingest\";\nimport { handleMe } from \"./routes/me\";\nimport { handleCommissioning } from \"./routes/commissioning\";\nimport { handleHealth } from \"./routes/health\";\nimport {\n  handleCreateCommissioningRun,\n  handleListCommissioningRuns,\n} from \"./routes/commissioning-runs\";\nimport { handleClientErrorReport } from \"./routes/observability\";\nimport { bindRequestLogger, loggerForRequest, releaseRequestLogger } from \"./utils/logging\";\nimport { recordOpsMetric } from \"./lib/ops-metrics\";\nimport {\n  initializeRequestMetrics,\n  requestMetricsRecorded,\n} from \"./lib/request-metrics\";\n\nconst router: AppRouter = Router();\n\nrouter.get(\"/health\", () => handleHealth());\n\nregisterMetricsRoutes(router);\nregisterDeviceRoutes(router, withParam);\nregisterTelemetryRoutes(router);\nregisterAdminRoutes(router);\n\nrouter\n  .get(\"/api/me\", withAccess((req, env) => handleMe(req, env)))\n  .get(\"/api/fleet/summary\", withAccess((req, env) => handleFleetSummary(req, env)))\n  .get(\n    \"/api/fleet/admin-overview\",\n    withAccess((req, env) => handleFleetAdminOverview(req, env)),\n  )\n  .get(\"/api/client/compact\", withAccess((req, env) => handleClientCompact(req, env)))\n  .get(\"/api/alerts\", withAccess((req, env) => handleListAlertRecords(req, env)))\n  .post(\"/api/alerts\", withAccess((req, env) => handleCreateAlertRecord(req, env)))\n  .patch(\n    \"/api/alerts/:id\",\n    withAccess(\n      withParam(\"id\", (req, env, alertId) => handleUpdateAlertRecord(req, env, alertId)),\n    ),\n  )\n  .post(\n    \"/api/alerts/:id/comments\",\n    withAccess(\n      withParam(\"id\", (req, env, alertId) => handleCreateAlertComment(req, env, alertId)),\n    ),\n  )\n  .get(\"/api/alerts/recent\", withAccess((req, env) => handleAlertsFeed(req, env)))\n  .get(\"/api/commissioning/checklist\", withAccess((req, env) => handleCommissioning(req, env)))\n  .get(\"/api/commissioning/runs\", withAccess((req, env) => handleListCommissioningRuns(req, env)))\n  .post(\"/api/commissioning/runs\", withAccess((req, env) => handleCreateCommissioningRun(req, env)))\n  .get(\"/api/archive/offline\", withAccess((req, env) => handleArchive(req, env)))\n  .post(\n    \"/api/observability/client-errors\",\n    withAccess((req, env) => handleClientErrorReport(req, env)),\n  )\n  .post(\n    \"/api/ingest/:profile\",\n    withParam(\"profile\", (req, env, profile) => handleIngest(req, env, profile)),\n  )\n  .post(\n    \"/api/heartbeat/:profile\",\n    withParam(\"profile\", (req, env, profile) => handleHeartbeat(req, env, profile)),\n  );\n\nrouter.all(\"*\", () => json({ error: \"Not found\" }, { status: 404 }));\n\nexport function handleRequest(req: Request, env: Env, ctx?: ExecutionContext) {\n  const start = Date.now();\n  initializeRequestMetrics(req);\n  const logger = bindRequestLogger(req, env);\n  logger.debug(\"request.received\");\n  const pathname = safePath(req.url);\n  let statusCode: number | null = null;\n  return Promise.resolve(router.fetch(req, env, ctx))\n    .then((res) => {\n      statusCode = res?.status ?? 0;\n      logger.info(\"request.completed\", {\n        status: statusCode,\n        duration_ms: Date.now() - start,\n      });\n      return res;\n    })\n    .catch((err) => {\n      statusCode = 500;\n      loggerForRequest(req).error(\"request.failed\", {\n        duration_ms: Date.now() - start,\n        error: err,\n      });\n      throw err;\n    })\n    .finally(async () => {\n      try {\n        if (!requestMetricsRecorded(req)) {\n          const route = normalizeRoute(pathname);\n          await recordOpsMetric(env, route, statusCode ?? 0, Date.now() - start, null, logger);\n        }\n      } catch (error) {\n        logger.warn(\"request.metrics_failed\", { error });\n      } finally {\n        releaseRequestLogger(req);\n      }\n    });\n}\n\nfunction safePath(url: string): string {\n  try {\n    return new URL(url).pathname;\n  } catch {\n    return url;\n  }\n}\n\nfunction normalizeRoute(pathname: string): string {\n  if (pathname.startsWith(\"/api/ingest/\")) return \"/api/ingest\";\n  if (pathname.startsWith(\"/api/heartbeat/\")) return \"/api/heartbeat\";\n  if (pathname.startsWith(\"/api/alerts/\") && pathname.split(\"/\").length === 4) {\n    return \"/api/alerts/:id\";\n  }\n  if (pathname.startsWith(\"/api/commissioning/runs\")) {\n    return \"/api/commissioning/runs\";\n  }\n  return pathname;\n}\n", "import { systemLogger } from \"./logging\";\n\nconst PLACEHOLDER_ORIGIN = \"https://asset-base.invalid\";\nconst ABSOLUTE_SCHEME = /^[a-zA-Z][a-zA-Z\\d+\\-.]*:/;\nconst ALLOWED_ABSOLUTE_SCHEMES = new Set([\"http:\", \"https:\"]);\n\nclass UnsupportedAssetSchemeError extends Error {\n  readonly scheme: string;\n\n  constructor(scheme: string) {\n    super(`Unsupported asset base scheme: ${scheme}`);\n    this.name = \"UnsupportedAssetSchemeError\";\n    this.scheme = scheme.toLowerCase();\n  }\n}\n\ntype AssetBaseKind = \"absolute\" | \"protocol-relative\" | \"root-relative\" | \"relative\";\n\ninterface ParsedAssetBase {\n  url: URL;\n  kind: AssetBaseKind;\n  original: string;\n}\n\nfunction parseAssetBase(raw: string): ParsedAssetBase {\n  const trimmed = raw.trim();\n  if (!trimmed) {\n    const url = new URL(\"/\", PLACEHOLDER_ORIGIN);\n    return { url, kind: \"root-relative\", original: trimmed };\n  }\n  if (trimmed.startsWith(\"//\")) {\n    const url = new URL(`https:${trimmed}`);\n    return { url, kind: \"protocol-relative\", original: trimmed };\n  }\n  if (ABSOLUTE_SCHEME.test(trimmed)) {\n    const scheme = trimmed.slice(0, trimmed.indexOf(\":\") + 1).toLowerCase();\n    if (!ALLOWED_ABSOLUTE_SCHEMES.has(scheme)) {\n      throw new UnsupportedAssetSchemeError(scheme);\n    }\n    const url = new URL(trimmed);\n    return { url, kind: \"absolute\", original: trimmed };\n  }\n  const url = new URL(trimmed, PLACEHOLDER_ORIGIN);\n  const kind: AssetBaseKind = trimmed.startsWith(\"/\") ? \"root-relative\" : \"relative\";\n  return { url, kind, original: trimmed };\n}\n\nfunction ensureTrailingSlash(url: URL): void {\n  if (!url.pathname.endsWith(\"/\")) {\n    url.pathname = `${url.pathname}/`;\n  }\n}\n\nfunction serializeAssetUrl(parsed: ParsedAssetBase): string {\n  const { url, kind } = parsed;\n  const suffix = `${url.pathname}${url.search}${url.hash}`;\n  switch (kind) {\n    case \"absolute\":\n      return url.toString();\n    case \"protocol-relative\":\n      return `//${url.host}${suffix}`;\n    case \"root-relative\":\n      return suffix;\n    case \"relative\": {\n      return suffix.startsWith(\"/\") ? suffix.slice(1) : suffix;\n    }\n    default:\n      return suffix;\n  }\n}\n\nfunction splitSuffix(input: string): { path: string; search: string; hash: string } {\n  const match = input.match(/^([^?#]*)(\\?[^#]*)?(#.*)?$/);\n  return {\n    path: match?.[1] ?? \"\",\n    search: match?.[2] ?? \"\",\n    hash: match?.[3] ?? \"\",\n  };\n}\n\nfunction combineQueryStrings(baseSearch: string, suffixSearch: string): string {\n  const params = new URLSearchParams();\n  if (suffixSearch) {\n    const suffixParams = new URLSearchParams(suffixSearch.slice(1));\n    suffixParams.forEach((value, key) => {\n      params.append(key, value);\n    });\n  }\n  if (baseSearch) {\n    const baseParams = new URLSearchParams(baseSearch.slice(1));\n    baseParams.forEach((value, key) => {\n      params.append(key, value);\n    });\n  }\n  const combined = params.toString();\n  return combined ? `?${combined}` : \"\";\n}\n\nfunction manualEnsureTrailingSlash(input: string): string {\n  const trimmed = input.trim();\n  if (!trimmed) return \"/\";\n  const match = trimmed.match(/^([^?#]*)([?#].*)?$/);\n  if (!match) return trimmed.endsWith(\"/\") ? trimmed : `${trimmed}/`;\n  let path = match[1] ?? \"\";\n  const suffix = match[2] ?? \"\";\n  if (!path.endsWith(\"/\")) {\n    path = path ? `${path}/` : \"/\";\n  }\n  return `${path}${suffix}`;\n}\n\nfunction manualExpand(base: string, suffix: string): string {\n  const baseMatch = base.match(/^([^?#]*)(\\?[^#]*)?(#.*)?$/);\n  if (!baseMatch) return base.endsWith(\"/\") ? `${base}${suffix}` : `${base}/${suffix}`;\n  let basePath = baseMatch[1] ?? \"\";\n  const baseSearch = baseMatch[2] ?? \"\";\n  const baseHash = baseMatch[3] ?? \"\";\n  if (!basePath.endsWith(\"/\")) {\n    basePath = basePath ? `${basePath}/` : \"/\";\n  }\n  const suffixParts = splitSuffix(suffix);\n  const combinedPath = `${basePath}${suffixParts.path}`;\n  const combinedSearch = combineQueryStrings(baseSearch, suffixParts.search);\n  const combinedHash = suffixParts.hash || baseHash;\n  return `${combinedPath}${combinedSearch}${combinedHash}`;\n}\n\nexport function normalizeAssetBase(value: string | undefined, fallback: string): string {\n  const candidate = value?.trim()?.length ? value.trim() : fallback;\n  try {\n    const parsed = parseAssetBase(candidate);\n    ensureTrailingSlash(parsed.url);\n    return serializeAssetUrl(parsed);\n  } catch (err) {\n    if (err instanceof UnsupportedAssetSchemeError && candidate !== fallback) {\n      systemLogger({ scope: \"app_config\" }).warn(\"asset_base_invalid_scheme\", {\n        value: candidate,\n        fallback,\n        scheme: err.scheme,\n      });\n    }\n    if (candidate !== fallback) {\n      return normalizeAssetBase(undefined, fallback);\n    }\n    return manualEnsureTrailingSlash(candidate);\n  }\n}\n\nexport function expandAssetBase(assetBase: string, suffix: string): string {\n  const trimmedBase = assetBase.trim();\n  if (!trimmedBase) {\n    return suffix;\n  }\n  try {\n    const parsed = parseAssetBase(trimmedBase);\n    ensureTrailingSlash(parsed.url);\n    const originalSearch = parsed.url.search;\n    const originalHash = parsed.url.hash;\n    const suffixParts = splitSuffix(suffix);\n    parsed.url.pathname = `${parsed.url.pathname}${suffixParts.path}`;\n    const combinedSearch = combineQueryStrings(originalSearch, suffixParts.search);\n    parsed.url.search = combinedSearch ? combinedSearch.slice(1) : \"\";\n    const finalHash = suffixParts.hash || originalHash;\n    parsed.url.hash = finalHash ? finalHash.slice(1) : \"\";\n    return serializeAssetUrl(parsed);\n  } catch {\n    return manualExpand(trimmedBase, suffix);\n  }\n}\n", "import { normalizeAssetBase } from \"./utils/asset-base\";\nimport { systemLogger } from \"./utils/logging\";\nimport type { Env } from \"./env\";\n\nexport interface ResolvedAppConfig {\n  apiBase: string;\n  assetBase: string;\n  returnDefault?: string;\n}\n\nexport const DEFAULT_APP_CONFIG: Pick<ResolvedAppConfig, \"apiBase\" | \"assetBase\"> = {\n  apiBase: \"\",\n  assetBase: \"/app/assets/\",\n};\n\nconst JSON_HTML_SAFE_CHARS = /[<>&\\u2028\\u2029]/g;\nconst JSON_HTML_SAFE_REPLACEMENTS: Record<string, string> = {\n  \"<\": \"\\\\u003C\",\n  \">\": \"\\\\u003E\",\n  \"&\": \"\\\\u0026\",\n  \"\\u2028\": \"\\\\u2028\",\n  \"\\u2029\": \"\\\\u2029\",\n};\nconst ABSOLUTE_SCHEME_PATTERN = /^[a-zA-Z][a-zA-Z\\d+\\-.]*:/;\nconst HTTP_SCHEME_PATTERN = /^https?:\\/\\//i;\nconst PLACEHOLDER_API_ORIGIN = \"https://api-base.invalid\";\n\nfunction sanitizeApiPath(pathname: string): string {\n  if (!pathname || pathname === \"/\") {\n    return \"/\";\n  }\n  const collapsed = pathname.replace(/\\/{2,}/g, \"/\");\n  if (collapsed.endsWith(\"/\")) {\n    return collapsed.replace(/\\/+$/, \"/\");\n  }\n  return collapsed;\n}\n\nfunction normalizeApiBase(value: string | undefined, fallback: string): string {\n  const trimmed = value?.trim() ?? \"\";\n  if (!trimmed) {\n    return fallback;\n  }\n\n  const hasScheme = ABSOLUTE_SCHEME_PATTERN.test(trimmed);\n  if (hasScheme && !HTTP_SCHEME_PATTERN.test(trimmed)) {\n    systemLogger({ scope: \"app_config\" }).warn(\"api_base_invalid_scheme\", {\n      value: trimmed,\n      fallback,\n    });\n    return fallback;\n  }\n\n  try {\n    const isRootRelative = trimmed.startsWith(\"/\");\n    const url = hasScheme ? new URL(trimmed) : new URL(trimmed, PLACEHOLDER_API_ORIGIN);\n    url.pathname = sanitizeApiPath(url.pathname);\n    const serialized = url.toString();\n    if (hasScheme) {\n      return serialized;\n    }\n    const withoutPlaceholder = serialized.replace(PLACEHOLDER_API_ORIGIN, \"\");\n    if (isRootRelative) {\n      return withoutPlaceholder;\n    }\n    return withoutPlaceholder.startsWith(\"/\") ? withoutPlaceholder.slice(1) : withoutPlaceholder;\n  } catch (error) {\n    systemLogger({ scope: \"app_config\" }).warn(\"api_base_normalization_failed\", {\n      value: trimmed,\n      fallback,\n      error,\n    });\n    return fallback;\n  }\n}\n\nexport function resolveAppConfig(env: Env): ResolvedAppConfig {\n  return {\n    apiBase: normalizeApiBase(env.APP_API_BASE, DEFAULT_APP_CONFIG.apiBase),\n    assetBase: normalizeAssetBase(env.APP_ASSET_BASE, DEFAULT_APP_CONFIG.assetBase),\n    returnDefault: env.RETURN_DEFAULT,\n  };\n}\n\nexport function serializeAppConfig(config: ResolvedAppConfig): string {\n  const json = JSON.stringify(config);\n  return json.replace(JSON_HTML_SAFE_CHARS, (char) => JSON_HTML_SAFE_REPLACEMENTS[char] ?? char);\n}\n", "import type { Env } from \"../env\";\nimport type { SecurityHeaderOptions } from \"./responses\";\nimport { resolveAppConfig } from \"../app-config\";\n\nconst SECURITY_OPTION_KEYS: Array<keyof SecurityHeaderOptions> = [\n  \"scriptSrc\",\n  \"scriptHashes\",\n  \"scriptNonces\",\n  \"styleHashes\",\n  \"styleNonces\",\n  \"styleSrc\",\n  \"connectSrc\",\n  \"imgSrc\",\n  \"fontSrc\",\n];\n\nconst ALLOWED_PROTOCOLS = new Set([\"http:\", \"https:\"]);\n\nfunction extractOrigin(value?: string | null): string | null {\n  if (!value) return null;\n  const trimmed = value.trim();\n  if (!trimmed) return null;\n  try {\n    const url = new URL(trimmed);\n    if (ALLOWED_PROTOCOLS.has(url.protocol)) {\n      return url.origin;\n    }\n  } catch {\n    // Ignore invalid URLs or relative paths \u2013 they should not expand CSP beyond 'self'.\n  }\n  return null;\n}\n\nfunction mergeList(base?: string[], extra?: string[]): string[] | undefined {\n  if (!base && !extra) return undefined;\n  const combined = [...(base ?? [])];\n  if (extra) {\n    for (const value of extra) {\n      if (!combined.includes(value)) {\n        combined.push(value);\n      }\n    }\n  }\n  return combined.length ? combined : undefined;\n}\n\nfunction cloneOptions(source: SecurityHeaderOptions): SecurityHeaderOptions {\n  const clone: SecurityHeaderOptions = {};\n  for (const key of SECURITY_OPTION_KEYS) {\n    const list = source[key];\n    if (list && list.length) {\n      clone[key] = [...list];\n    }\n  }\n  return clone;\n}\n\nexport function baseSecurityHeaderOptions(env: Env): SecurityHeaderOptions {\n  const config = resolveAppConfig(env);\n  const apiOrigin = extractOrigin(config.apiBase);\n  const assetOrigin = extractOrigin(config.assetBase);\n\n  const base: SecurityHeaderOptions = {};\n\n  const connectSources: string[] = [];\n  if (apiOrigin) connectSources.push(apiOrigin);\n  if (assetOrigin) connectSources.push(assetOrigin);\n  if (connectSources.length) {\n    base.connectSrc = connectSources;\n  }\n\n  if (assetOrigin) {\n    base.scriptSrc = [assetOrigin];\n    base.imgSrc = [assetOrigin];\n    base.styleSrc = [assetOrigin];\n    base.fontSrc = [assetOrigin];\n  }\n\n  return base;\n}\n\nexport function mergeSecurityHeaderOptions(\n  base: SecurityHeaderOptions,\n  overrides?: SecurityHeaderOptions,\n): SecurityHeaderOptions {\n  if (!overrides) {\n    return cloneOptions(base);\n  }\n\n  const merged: SecurityHeaderOptions = {};\n\n  for (const key of SECURITY_OPTION_KEYS) {\n    const combined = mergeList(base[key], overrides[key]);\n    if (combined && combined.length) {\n      merged[key] = combined;\n    }\n  }\n\n  return merged;\n}\n\nexport function createSecurityHeaderOptions(\n  env: Env,\n  overrides?: SecurityHeaderOptions,\n): SecurityHeaderOptions {\n  const base = baseSecurityHeaderOptions(env);\n  return mergeSecurityHeaderOptions(base, overrides);\n}\n", "import type { Env } from \"../env\";\n\nconst HTTP_SCHEMES = new Set([\"http:\", \"https:\"]);\nconst ABSOLUTE_SCHEME = /^[a-zA-Z][a-zA-Z\\d+\\-.]*:/;\n\nfunction isSafeRelativePath(candidate: string): boolean {\n  return candidate.startsWith(\"/\") && !candidate.startsWith(\"//\");\n}\n\nfunction collectAllowedOrigins(env: Env, requestOrigin: string): Set<string> {\n  const origins = new Set<string>([requestOrigin]);\n  try {\n    const appUrl = new URL(env.APP_BASE_URL);\n    origins.add(appUrl.origin);\n  } catch {\n    // ignore parse errors\n  }\n  if (env.RETURN_DEFAULT) {\n    try {\n      const fallbackUrl = new URL(env.RETURN_DEFAULT, requestOrigin);\n      origins.add(fallbackUrl.origin);\n    } catch {\n      // ignore parse errors\n    }\n  }\n  return origins;\n}\n\nexport function resolveLogoutReturn(raw: string | null, env: Env, requestUrl: URL): string {\n  const fallback = env.RETURN_DEFAULT ?? \"/\";\n  const candidate = raw?.trim();\n  if (!candidate) return fallback;\n\n  if (isSafeRelativePath(candidate)) {\n    return candidate;\n  }\n  if (candidate.startsWith(\"//\")) {\n    return fallback;\n  }\n\n  try {\n    const parsed = new URL(candidate, requestUrl.origin);\n    if (!HTTP_SCHEMES.has(parsed.protocol)) {\n      return fallback;\n    }\n    const allowedOrigins = collectAllowedOrigins(env, requestUrl.origin);\n    if (!allowedOrigins.has(parsed.origin)) {\n      return fallback;\n    }\n\n    if (ABSOLUTE_SCHEME.test(candidate)) {\n      return parsed.toString();\n    }\n\n    return `${parsed.pathname}${parsed.search}${parsed.hash}`;\n  } catch {\n    return fallback;\n  }\n}\n", "// src/r2.ts - Secure R2 API (Access-gated writes + optional signed reads)\r\nimport { createRemoteJWKSet, jwtVerify, type JWTPayload } from \"jose\";\r\n\r\nimport type { Env } from \"./env\";\r\nimport { json as secureJson, withSecurityHeaders } from \"./utils/responses\";\nimport { systemLogger } from \"./utils/logging\";\n\r\nexport interface R2HandlerOptions {\r\n  /**\r\n   * Route prefix (e.g. \"/r2\") stripped before object key evaluation.\r\n   * Defaults to \"\" when running as a dedicated Worker.\r\n   */\r\n  routePrefix?: string;\r\n}\r\n\r\nconst json = secureJson;\r\n\r\nfunction badRequest(msg = \"Bad Request\") {\r\n  return json({ error: msg }, { status: 400 });\r\n}\r\n\r\nfunction unauthorized(msg = \"Unauthorized\") {\r\n  return json({ error: msg }, { status: 401 });\r\n}\r\n\r\nfunction forbidden(msg = \"Forbidden\") {\r\n  return json({ error: msg }, { status: 403 });\r\n}\r\n\r\nfunction notFound() {\r\n  return json({ error: \"Not found\" }, { status: 404 });\r\n}\r\n\r\nfunction normalizeKey(pathname: string): string {\r\n  let key = pathname.replace(/^\\/+/, \"\");\r\n  if (!key) throw new Error(\"empty_key\");\r\n  if (key.split(\"/\").some((segment) => segment === \"..\")) {\r\n    throw new Error(\"invalid_key\");\r\n  }\r\n  return key;\r\n}\r\n\r\nfunction parseAllowedPrefixes(env: Env): string[] | null {\r\n  const raw = env.ALLOWED_PREFIXES?.trim();\r\n  if (!raw) return null;\r\n  const prefixes = new Set<string>();\r\n  for (const token of raw.split(\",\").map((part) => part.trim()).filter(Boolean)) {\r\n    const normalized = token.replace(/^\\/+/, \"\").replace(/\\/+$/, \"\");\r\n    if (!normalized) {\r\n      // Treat a bare slash (\"/\" or \"//\") as allow-all.\r\n      return null;\r\n    }\r\n    prefixes.add(`${normalized}/`);\r\n  }\r\n  return prefixes.size ? [...prefixes] : null;\r\n}\r\n\r\nfunction withinAllowedPrefixes(key: string, prefixes: string[] | null) {\r\n  return !prefixes || prefixes.some((prefix) => key.startsWith(prefix));\r\n}\r\n\r\nconst jwksCache = new Map<string, ReturnType<typeof createRemoteJWKSet>>();\r\nfunction getJwks(env: Env) {\r\n  const url = env.ACCESS_JWKS_URL;\r\n  if (!jwksCache.has(url)) {\r\n    jwksCache.set(url, createRemoteJWKSet(new URL(url)));\r\n  }\r\n  return jwksCache.get(url)!;\r\n}\r\n\r\nasync function requireAccess(req: Request, env: Env): Promise<JWTPayload | null> {\r\n  const jwt = req.headers.get(\"Cf-Access-Jwt-Assertion\");\r\n  if (!jwt) return null;\r\n  try {\r\n    const { payload } = await jwtVerify(jwt, getJwks(env), { audience: env.ACCESS_AUD });\r\n    return payload;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction nowSec() {\r\n  return Math.floor(Date.now() / 1000);\r\n}\r\n\r\nfunction hex(buf: ArrayBuffer): string {\r\n  return [...new Uint8Array(buf)].map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\r\n}\r\n\r\nfunction safeEq(a: string, b: string): boolean {\r\n  if (a.length !== b.length) return false;\r\n  let diff = 0;\r\n  for (let i = 0; i < a.length; i++) {\r\n    diff |= a.charCodeAt(i) ^ b.charCodeAt(i);\r\n  }\r\n  return diff === 0;\r\n}\r\n\r\n// Signed URL: ?exp=<unix_seconds>&sig=<hex(HMAC_SHA256(method+\"\\n\"+key+\"\\n\"+exp))>\r\nasync function verifySignedUrl(url: URL, method: string, env: Env): Promise<boolean> {\r\n  const secret = env.ASSET_SIGNING_SECRET;\r\n  if (!secret) return false;\r\n  const exp = Number(url.searchParams.get(\"exp\"));\r\n  const sig = url.searchParams.get(\"sig\") || \"\";\r\n  if (!Number.isFinite(exp) || exp < nowSec()) return false;\r\n\r\n  let key: string;\r\n  try {\r\n    key = normalizeKey(url.pathname);\r\n  } catch {\r\n    return false;\r\n  }\r\n\r\n  const msg = `${method.toUpperCase()}\\n${key}\\n${exp}`;\r\n  const encoder = new TextEncoder();\r\n  const cryptoKey = await crypto.subtle.importKey(\r\n    \"raw\",\r\n    encoder.encode(secret),\r\n    { name: \"HMAC\", hash: \"SHA-256\" },\r\n    false,\r\n    [\"sign\"],\r\n  );\r\n  const mac = await crypto.subtle.sign(\"HMAC\", cryptoKey, encoder.encode(msg));\r\n  const expected = hex(mac);\r\n  return safeEq(expected, sig);\r\n}\r\n\r\nfunction withCors(res: Response) {\r\n  const headers = new Headers(res.headers);\r\n  // Allow cross-origin consumption of signed GET/HEAD assets.\r\n  headers.set(\"Access-Control-Allow-Origin\", \"*\");\r\n  headers.set(\"Vary\", \"Origin\");\r\n  return withSecurityHeaders(\r\n    new Response(res.body, {\r\n      headers,\r\n      status: res.status,\r\n      statusText: res.statusText,\r\n    }),\r\n  );\r\n}\r\n\r\nfunction rewriteUrlForPrefix(original: URL, prefix: string | undefined): URL | null {\r\n  if (!prefix) return new URL(original);\r\n  const normalized = prefix.endsWith(\"/\") && prefix !== \"/\" ? prefix.slice(0, -1) : prefix;\r\n  if (!normalized.startsWith(\"/\")) {\r\n    throw new Error(`routePrefix must start with \"/\": ${prefix}`);\r\n  }\r\n  const path = original.pathname;\r\n  if (path === normalized) {\r\n    const clone = new URL(original);\r\n    clone.pathname = \"/\";\r\n    return clone;\r\n  }\r\n  if (path.startsWith(`${normalized}/`)) {\r\n    const clone = new URL(original);\r\n    clone.pathname = path.slice(normalized.length) || \"/\";\r\n    return clone;\r\n  }\r\n  return null;\r\n}\r\n\r\nexport async function handleR2Request(\r\n  req: Request,\r\n  env: Env,\r\n  options: R2HandlerOptions = {},\r\n): Promise<Response> {\r\n  const bucket = env.GB_BUCKET;\r\n  if (!bucket) {\r\n    return json({ error: \"R2 bucket not configured\" }, { status: 503 });\r\n  }\r\n\r\n  const rewrittenUrl = rewriteUrlForPrefix(new URL(req.url), options.routePrefix);\r\n  if (!rewrittenUrl) {\r\n    return notFound();\r\n  }\r\n\r\n  let key: string;\r\n  try {\r\n    key = normalizeKey(rewrittenUrl.pathname);\r\n  } catch {\r\n    return badRequest(\"Invalid object key\");\r\n  }\r\n\r\n  const method = req.method.toUpperCase();\r\n  const prefixes = parseAllowedPrefixes(env);\r\n  if (!withinAllowedPrefixes(key, prefixes)) {\r\n    return forbidden(\"Key not allowed\");\r\n  }\r\n\r\n  const accessPayload = await requireAccess(req, env);\r\n  const hasAccess = !!accessPayload;\r\n  const hasValidSignature = await verifySignedUrl(rewrittenUrl, method, env);\r\n\r\n  if (method === \"PUT\") {\n    if (!hasAccess) return unauthorized();\n    const contentType = req.headers.get(\"content-type\") || undefined;\n    try {\n      await bucket.put(key, req.body, { httpMetadata: { contentType } });\n      return json({ ok: true, key });\n    } catch (error: unknown) {\n      systemLogger({ scope: \"r2\" }).error(\"r2.put_failed\", { key, error });\n      return json(\n        { error: \"Write failed\" },\n        { status: 500 },\n      );\n    }\n  }\n\n  if (method === \"DELETE\") {\r\n    if (!hasAccess) return unauthorized();\n    try {\n      await bucket.delete(key);\n      return json({ ok: true, key, deleted: true });\n    } catch (error: unknown) {\n      systemLogger({ scope: \"r2\" }).error(\"r2.delete_failed\", { key, error });\n      return json(\n        { error: \"Delete failed\" },\n        { status: 500 },\n      );\n    }\n  }\n\r\n  if (method === \"GET\") {\r\n    if (!hasAccess && !hasValidSignature) return unauthorized();\r\n    const obj = await bucket.get(key);\r\n    if (!obj) return notFound();\r\n    const headers = new Headers();\r\n    if (obj.httpMetadata?.contentType) headers.set(\"content-type\", obj.httpMetadata.contentType);\r\n    if (obj.httpMetadata?.cacheControl) headers.set(\"cache-control\", obj.httpMetadata.cacheControl);\r\n    if (obj.etag) headers.set(\"etag\", obj.etag);\r\n    if (obj.uploaded) headers.set(\"last-modified\", obj.uploaded.toUTCString());\r\n    return withCors(new Response(obj.body, { headers }));\r\n  }\r\n\r\n  if (method === \"HEAD\") {\r\n    if (!hasAccess && !hasValidSignature) return unauthorized();\r\n    const obj = await bucket.head(key);\r\n    if (!obj) return notFound();\r\n    const headers = new Headers();\r\n    if (obj.httpMetadata?.contentType) headers.set(\"content-type\", obj.httpMetadata.contentType);\r\n    if (obj.httpMetadata?.cacheControl) headers.set(\"cache-control\", obj.httpMetadata.cacheControl);\r\n    if (obj.etag) headers.set(\"etag\", obj.etag);\r\n    if (obj.uploaded) headers.set(\"last-modified\", obj.uploaded.toUTCString());\r\n    headers.set(\"content-length\", String(obj.size));\r\n    return withCors(new Response(null, { headers }));\r\n  }\r\n\r\n  if (method === \"OPTIONS\") {\r\n    const headers = new Headers();\r\n    headers.set(\"Access-Control-Allow-Origin\", \"*\");\r\n    headers.set(\"Access-Control-Allow-Methods\", \"GET,HEAD,PUT,DELETE,OPTIONS\");\r\n    headers.set(\r\n      \"Access-Control-Allow-Headers\",\r\n      \"content-type,Cf-Access-Jwt-Assertion,Cf-Access-Client-Id,Cf-Access-Client-Secret\",\r\n    );\r\n    headers.set(\"Access-Control-Max-Age\", \"600\");\r\n    return withSecurityHeaders(new Response(null, { status: 204, headers }));\r\n  }\r\n\r\n  return json(\r\n    { error: \"Method not allowed\" },\r\n    { status: 405, headers: { Allow: \"GET,HEAD,PUT,DELETE,OPTIONS\" } },\r\n  );\r\n}\r\n\r\nexport default {\r\n  async fetch(req: Request, env: Env): Promise<Response> {\r\n    return handleR2Request(req, env);\r\n  },\r\n};\r\n", "import type { Env } from \"../env\";\nimport { nowISO } from \"../utils\";\n\nconst UPSERT_CURSOR_SQL = `\nINSERT INTO cron_cursors (name, cursor, updated_at)\nVALUES (?1, ?2, ?3)\nON CONFLICT(name) DO UPDATE SET\n  cursor = excluded.cursor,\n  updated_at = excluded.updated_at\n`;\n\nexport async function readCronCursor(env: Env, name: string): Promise<string | null> {\n  const row = await env.DB\n    .prepare(`SELECT cursor FROM cron_cursors WHERE name = ?1 LIMIT 1`)\n    .bind(name)\n    .first<{ cursor: string | null }>();\n  return row?.cursor ?? null;\n}\n\nexport async function writeCronCursor(env: Env, name: string, cursor: string | number): Promise<void> {\n  const cursorValue = typeof cursor === \"number\" ? String(Math.floor(cursor)) : String(cursor);\n  await env.DB.prepare(UPSERT_CURSOR_SQL).bind(name, cursorValue, nowISO()).run();\n}\n\nexport async function clearCronCursor(env: Env, name: string): Promise<void> {\n  await env.DB.prepare(`DELETE FROM cron_cursors WHERE name = ?1`).bind(name).run();\n}\n\n", "import type { Env } from \"../env\";\nimport { recordOpsMetric } from \"../lib/ops-metrics\";\nimport { clearCronCursor, readCronCursor, writeCronCursor } from \"../lib/cron-cursor\";\nimport { systemLogger, type Logger } from \"../utils/logging\";\n\nconst DEFAULT_RETENTION_DAYS = 90;\nconst MIN_RETENTION_DAYS = 7;\nconst MS_PER_DAY = 24 * 60 * 60 * 1000;\nconst TELEMETRY_BATCH_SIZE = 250;\n\nexport const TELEMETRY_RETENTION_CRON = \"15 2 * * *\";\n\ntype Nullable<T> = T | null | undefined;\n\ntype TelemetryRow = {\n  rowid: number;\n  device_id: string;\n  ts: number | string;\n  metrics_json: string;\n  deltaT: number | string | null;\n  thermalKW: number | string | null;\n  cop: number | string | null;\n  cop_quality: string | null;\n  status_json: string | null;\n  faults_json: string | null;\n};\n\ntype RetentionTableSummary = {\n  scanned: number;\n  deleted: number;\n  batches: number;\n  backups: string[];\n  hasMore: boolean;\n  resumeCursor: number | null;\n};\n\nexport type RetentionSummary = {\n  retentionDays: number;\n  cutoffMs: number;\n  cutoffIso: string;\n  telemetry: RetentionTableSummary;\n  opsMetricsDeleted: number;\n  telemetryHasMore: boolean;\n  telemetryCursor: number | null;\n};\n\nexport interface RetentionOptions {\n  dryRun?: boolean;\n  now?: Date;\n  logger?: Logger;\n  jobId?: string;\n}\n\ntype ArchiveTarget = {\n  bucket: R2Bucket;\n  prefix: string;\n};\n\nconst BOOLEAN_TRUE = new Set([\"1\", \"true\", \"yes\", \"on\"]);\nconst MAX_TELEMETRY_BATCHES_PER_RUN = 40;\nconst TELEMETRY_CURSOR_KEY = \"retention.telemetry\";\n\nexport async function runTelemetryRetention(env: Env, options: RetentionOptions = {}): Promise<RetentionSummary> {\n  const startedAt = Date.now();\n  const now = options.now ?? new Date();\n  const retentionDays = parseRetentionDays(env.TELEMETRY_RETENTION_DAYS);\n  const cutoffMs = now.getTime() - retentionDays * MS_PER_DAY;\n  const cutoffIso = new Date(cutoffMs).toISOString();\n  const jobId = options.jobId ?? generateJobId(now);\n\n  const baseLogger = options.logger ?? systemLogger({ task: \"data-retention\" });\n  const log = baseLogger.with({\n    job_id: jobId,\n    retention_days: retentionDays,\n    cutoff_iso: cutoffIso,\n  });\n\n  const archiveTarget = resolveArchiveTarget(env);\n  const backupRequired = isTruthy(env.RETENTION_BACKUP_BEFORE_DELETE);\n  const shouldBackup = !options.dryRun && archiveTarget !== null;\n\n  if (backupRequired && archiveTarget === null) {\n    const err = new Error(\"Data retention job requires backup but no R2 archive bucket is configured\");\n    log.error(\"retention.backup_missing\", { error: err });\n    throw err;\n  }\n\n  if (!options.dryRun && archiveTarget === null) {\n    log.warn(\"retention.backup_skipped\", {\n      reason: \"archive bucket not configured\",\n    });\n  }\n\n  log.info(\"retention.started\", {\n    dry_run: Boolean(options.dryRun),\n    backup_enabled: shouldBackup,\n  });\n\n  let existingCursor: number | null = null;\n  if (!options.dryRun) {\n    const rawCursor = await readCronCursor(env, TELEMETRY_CURSOR_KEY);\n    existingCursor = rawCursor ? Number(rawCursor) : null;\n  }\n\n  const telemetrySummary = await pruneTelemetry(env, {\n    cutoffMs,\n    cutoffIso,\n    jobId,\n    log: log.with({ table: \"telemetry\" }),\n    archive: shouldBackup ? archiveTarget : null,\n    dryRun: Boolean(options.dryRun),\n    cursor: existingCursor,\n  });\n\n  if (!options.dryRun) {\n    if (telemetrySummary.resumeCursor !== null) {\n      await writeCronCursor(env, TELEMETRY_CURSOR_KEY, telemetrySummary.resumeCursor);\n    } else {\n      await clearCronCursor(env, TELEMETRY_CURSOR_KEY);\n    }\n  }\n\n  const opsDeleted = await pruneOpsMetrics(env, {\n    cutoffIso,\n    dryRun: Boolean(options.dryRun),\n    log: log.with({ table: \"ops_metrics\" }),\n  });\n\n  log.info(\"retention.completed\", {\n    telemetry_deleted: telemetrySummary.deleted,\n    telemetry_batches: telemetrySummary.batches,\n    telemetry_backups: telemetrySummary.backups.length,\n    ops_metrics_deleted: opsDeleted,\n    telemetry_has_more: telemetrySummary.hasMore,\n    telemetry_resume_cursor: telemetrySummary.resumeCursor,\n  });\n\n  const statusCode = telemetrySummary.hasMore ? 299 : 200;\n  await recordOpsMetric(env, \"/cron/retention\", statusCode, Date.now() - startedAt, null, log);\n\n  return {\n    retentionDays,\n    cutoffMs,\n    cutoffIso,\n    telemetry: telemetrySummary,\n    opsMetricsDeleted: opsDeleted,\n    telemetryHasMore: telemetrySummary.hasMore,\n    telemetryCursor: telemetrySummary.resumeCursor,\n  };\n}\n\nfunction parseRetentionDays(raw: string | undefined): number {\n  if (!raw) return DEFAULT_RETENTION_DAYS;\n  const parsed = Number(raw);\n  if (!Number.isFinite(parsed)) return DEFAULT_RETENTION_DAYS;\n  const coerced = Math.floor(parsed);\n  if (coerced <= 0) return DEFAULT_RETENTION_DAYS;\n  return Math.max(MIN_RETENTION_DAYS, coerced);\n}\n\nfunction isTruthy(value: string | undefined): boolean {\n  if (!value) return false;\n  return BOOLEAN_TRUE.has(value.trim().toLowerCase());\n}\n\nfunction sanitizePrefix(prefix: string): string {\n  const trimmed = prefix.trim().replace(/^[\\/]+|[\\/]+$/g, \"\");\n  return trimmed ? trimmed : \"data-retention\";\n}\n\nfunction generateJobId(now: Date): string {\n  return now.toISOString().replace(/[:.]/g, \"-\");\n}\n\nfunction resolveArchiveTarget(env: Env): ArchiveTarget | null {\n  const bucket = env.RETENTION_ARCHIVE ?? env.GB_BUCKET ?? null;\n  if (!bucket) return null;\n  const prefixInput = env.RETENTION_BACKUP_PREFIX ?? \"data-retention\";\n  const prefix = sanitizePrefix(prefixInput);\n  return { bucket, prefix };\n}\n\nasync function pruneTelemetry(\n  env: Env,\n  params: {\n    cutoffMs: number;\n    cutoffIso: string;\n    jobId: string;\n    archive: ArchiveTarget | null;\n    dryRun: boolean;\n    log: Logger;\n    cursor: number | null;\n  },\n): Promise<RetentionTableSummary> {\n  const summary: RetentionTableSummary = {\n    scanned: 0,\n    deleted: 0,\n    batches: 0,\n    backups: [],\n    hasMore: false,\n    resumeCursor: params.cursor ?? null,\n  };\n\n  let cursor = params.cursor ?? 0;\n\n  while (true) {\n    const batch = await env.DB\n      .prepare(\n        `SELECT rowid, device_id, ts, metrics_json, deltaT, thermalKW, cop, cop_quality, status_json, faults_json\n           FROM telemetry\n          WHERE ts < ?1\n            AND rowid > ?2\n          ORDER BY rowid\n          LIMIT ?3`,\n      )\n      .bind(params.cutoffMs, cursor, TELEMETRY_BATCH_SIZE)\n      .all<TelemetryRow>();\n\n    const rows = batch.results ?? [];\n    if (!rows.length) {\n      summary.resumeCursor = null;\n      break;\n    }\n\n    summary.scanned += rows.length;\n    summary.batches += 1;\n    const rowIds = rows.map((row) => row.rowid).filter((value) => typeof value === \"number\");\n    const lastRowId = rowIds[rowIds.length - 1] ?? cursor;\n\n    if (!params.dryRun && params.archive) {\n      const key = buildArchiveKey(params.archive.prefix, params.jobId, \"telemetry\", summary.batches);\n      const payload = rows\n        .map((row) =>\n          JSON.stringify({\n            device_id: row.device_id,\n            ts: toNumber(row.ts),\n            metrics_json: row.metrics_json,\n            deltaT: toNumberNullable(row.deltaT),\n            thermalKW: toNumberNullable(row.thermalKW),\n            cop: toNumberNullable(row.cop),\n            cop_quality: row.cop_quality ?? null,\n            status_json: row.status_json ?? null,\n            faults_json: row.faults_json ?? null,\n            retention_cutoff_iso: params.cutoffIso,\n            retention_job_id: params.jobId,\n          }),\n        )\n        .join(\"\\n\")\n        .concat(\"\\n\");\n\n      await params.archive.bucket.put(key, payload, {\n        httpMetadata: { contentType: \"application/x-ndjson\" },\n        customMetadata: {\n          table: \"telemetry\",\n          cutoff_iso: params.cutoffIso,\n          job_id: params.jobId,\n        },\n      });\n      summary.backups.push(key);\n      params.log.info(\"retention.batch_backed_up\", { key, rows: rows.length });\n    }\n\n    if (!params.dryRun) {\n      if (rowIds.length) {\n        const placeholders = rowIds.map(() => \"?\").join(\",\");\n        await env.DB.prepare(`DELETE FROM telemetry WHERE rowid IN (${placeholders})`).bind(...rowIds).run();\n      }\n      summary.deleted += rowIds.length;\n    }\n\n    cursor = lastRowId;\n    summary.resumeCursor = lastRowId;\n\n    if (summary.batches >= MAX_TELEMETRY_BATCHES_PER_RUN) {\n      summary.hasMore = true;\n      params.log.warn(\"retention.batch_limit_reached\", {\n        batches: summary.batches,\n        deleted: params.dryRun ? 0 : summary.deleted,\n      });\n      break;\n    }\n\n    if (rows.length < TELEMETRY_BATCH_SIZE) {\n      summary.hasMore = false;\n      summary.resumeCursor = null;\n      break;\n    }\n  }\n\n  params.log.info(\"retention.table_completed\", {\n    scanned: summary.scanned,\n    deleted: params.dryRun ? 0 : summary.deleted,\n    batches: summary.batches,\n    has_more: summary.hasMore,\n    resume_cursor: summary.resumeCursor,\n  });\n\n  return summary;\n}\n\nasync function pruneOpsMetrics(\n  env: Env,\n  params: { cutoffIso: string; dryRun: boolean; log: Logger },\n): Promise<number> {\n  if (params.dryRun) {\n    const countRow = await env.DB.prepare(\n      `SELECT COUNT(*) AS cnt FROM ops_metrics WHERE ts < ?1`,\n    )\n      .bind(params.cutoffIso)\n      .first<{ cnt: number | string | null }>();\n    const raw = countRow?.cnt ?? 0;\n    const count = typeof raw === \"number\" ? raw : Number(raw);\n    params.log.info(\"retention.table_completed\", {\n      scanned: count,\n      deleted: 0,\n      batches: 0,\n    });\n    return 0;\n  }\n\n  const result = await env.DB.prepare(`DELETE FROM ops_metrics WHERE ts < ?1`)\n    .bind(params.cutoffIso)\n    .run();\n  const deleted = Number(result.meta?.changes ?? 0);\n  params.log.info(\"retention.table_completed\", {\n    scanned: deleted,\n    deleted,\n    batches: 1,\n  });\n  return deleted;\n}\n\nfunction buildArchiveKey(prefix: string, jobId: string, table: string, batch: number): string {\n  const padded = batch.toString().padStart(4, \"0\");\n  return `${prefix}/${jobId}/${table}/batch-${padded}.ndjson`;\n}\n\nfunction toNumber(value: number | string): number {\n  if (typeof value === \"number\") return value;\n  const parsed = Number(value);\n  if (!Number.isFinite(parsed)) {\n    throw new Error(`Failed to coerce numeric value from '${value}'`);\n  }\n  return parsed;\n}\n\nfunction toNumberNullable(value: Nullable<number | string>): number | null {\n  if (value === null || value === undefined) return null;\n  return toNumber(value);\n}\n", "import { validateEnv, type Env } from \"./env\";\r\nimport { ASSETS } from \"./assets\";\r\nimport { STATIC_BUNDLE, type StaticBundleKey } from \"./frontend/static-bundle\";\r\nimport { landingFor, requireAccessUser } from \"./lib/access\";\r\nimport { CORS_BASE, maybeHandlePreflight } from \"./lib/cors\";\r\nimport {\n  HTML_CT,\n  json,\n  text,\n  withSecurityHeaders,\n  type SecurityHeaderOptions,\n} from \"./utils/responses\";\nimport { handleRequest } from \"./router\";\nimport { systemLogger } from \"./utils/logging\";\nimport { resolveAppConfig, serializeAppConfig } from \"./app-config\";\nimport { baseSecurityHeaderOptions, mergeSecurityHeaderOptions } from \"./utils/security-options\";\nimport { expandAssetBase } from \"./utils/asset-base\";\nimport { resolveLogoutReturn } from \"./utils/return-url\";\nimport { handleR2Request } from \"./r2\";\nimport { runTelemetryRetention, TELEMETRY_RETENTION_CRON } from \"./jobs/retention\";\nimport { clearCronCursor, readCronCursor, writeCronCursor } from \"./lib/cron-cursor\";\nimport { recordOpsMetric } from \"./lib/ops-metrics\";\nexport { resolveAppConfig, serializeAppConfig } from \"./app-config\";\r\n\r\nconst STATIC_CONTENT_TYPES: Record<string, string> = {\r\n  \".html\": HTML_CT,\r\n  \".js\": \"application/javascript;charset=utf-8\",\r\n  \".css\": \"text/css;charset=utf-8\",\r\n};\r\nconst APP_R2_PREFIX = \"app/\";\r\nconst DEFAULT_HEARTBEAT_INTERVAL_SECS = 30;\nconst DEFAULT_OFFLINE_MULTIPLIER = 6;\nconst OFFLINE_BATCH_SIZE = 100;\nconst OFFLINE_MAX_BATCHES_PER_RUN = 40;\nconst OFFLINE_CURSOR_KEY = \"offline.devices\";\n\r\nfunction extname(path: string): string {\r\n  const idx = path.lastIndexOf(\".\");\r\n  return idx === -1 ? \"\" : path.slice(idx);\r\n}\r\n\r\nfunction contentTypeFor(path: string): string {\r\n  return STATIC_CONTENT_TYPES[extname(path)] || \"application/octet-stream\";\r\n}\r\n\r\nfunction coerceFiniteNumber(value: string | undefined, fallback: number): number {\r\n  if (value === undefined) return fallback;\r\n  const parsed = Number(value);\r\n  return Number.isFinite(parsed) ? parsed : fallback;\r\n}\r\n\r\ntype StaticAssetResponse = {\r\n  response: Response;\r\n  scriptHashes?: string[];\r\n};\r\n\r\nfunction rewriteStaticAssetBase(html: string, assetBase: string) {\r\n  if (!assetBase) return html;\r\n  return html.replace(/(href|src)=([\"'])\\/(?:app\\/)?assets\\/([^\"']+)/g, (_match, attr, quote, suffix) => {\r\n    const rewritten = expandAssetBase(assetBase, suffix);\r\n    return `${attr}=${quote}${rewritten}`;\r\n  });\r\n}\r\n\r\nfunction defaultCacheControl(key: StaticBundleKey) {\r\n  if (key === \"index.html\") return \"no-store\";\r\n  if (key.startsWith(\"assets/\")) {\r\n    return \"public, max-age=31536000, immutable\";\r\n  }\r\n  return \"public, max-age=900, immutable\";\r\n}\r\n\r\nasync function sha256Base64(content: string) {\r\n  const data = new TextEncoder().encode(content);\r\n  const digest = await crypto.subtle.digest(\"SHA-256\", data);\r\n  const bytes = new Uint8Array(digest);\r\n  let binary = \"\";\r\n  for (const byte of bytes) binary += String.fromCharCode(byte);\r\n  return btoa(binary);\r\n}\r\n\r\nasync function injectAppConfig(html: string, env: Env): Promise<{ html: string; scriptHashes: string[] }> {\r\n  const config = resolveAppConfig(env);\r\n  const rewrittenHtml = rewriteStaticAssetBase(html, config.assetBase);\r\n  const scriptContent = `window.__APP_CONFIG__=${serializeAppConfig(config)};`;\r\n  const hash = await sha256Base64(scriptContent);\r\n  const scriptToken = `'sha256-${hash}'`;\r\n  const scriptTag = `<script>${scriptContent}</script>`;\r\n  const closingHead = /<\\/head>/i;\r\n  const injected =\r\n    closingHead.test(rewrittenHtml) ?\r\n      rewrittenHtml.replace(closingHead, `  ${scriptTag}\\n</head>`) :\r\n      `${scriptTag}\\n${rewrittenHtml}`;\r\n  return { html: injected, scriptHashes: [scriptToken] };\r\n}\r\n\r\nasync function loadFromR2(key: string, env: Env) {\r\n  if (!(\"APP_STATIC\" in env) || !env.APP_STATIC) return null;\r\n  return env.APP_STATIC.get(APP_R2_PREFIX + key);\r\n}\r\n\r\nfunction r2Headers(obj: any, fallbackCt: string, key: StaticBundleKey) {\r\n  const headers = new Headers();\r\n  if (obj?.httpMetadata?.contentType) {\r\n    headers.set(\"content-type\", obj.httpMetadata.contentType);\r\n  } else {\r\n    headers.set(\"content-type\", fallbackCt);\r\n  }\r\n  if (obj?.httpMetadata?.cacheControl) {\r\n    headers.set(\"cache-control\", obj.httpMetadata.cacheControl);\r\n  }\r\n  if (!headers.has(\"cache-control\")) {\r\n    headers.set(\"cache-control\", defaultCacheControl(key));\r\n  }\r\n  return headers;\r\n}\r\n\r\nasync function bundleResponse(key: StaticBundleKey, env: Env): Promise<StaticAssetResponse> {\r\n  const body = STATIC_BUNDLE[key] as string;\r\n  const ct = contentTypeFor(key);\r\n  let payload = body;\r\n  let scriptHashes: string[] | undefined;\r\n  if (key === \"index.html\") {\r\n    const injected = await injectAppConfig(body, env);\r\n    payload = injected.html;\r\n    scriptHashes = injected.scriptHashes;\r\n  }\r\n  const headers = new Headers({\r\n    \"content-type\": ct,\r\n    \"cache-control\": defaultCacheControl(key),\r\n  });\r\n  return { response: new Response(payload, { headers }), scriptHashes };\r\n}\r\n\r\nasync function readR2Text(obj: any) {\r\n  if (obj && typeof obj.text === \"function\") {\r\n    return obj.text();\r\n  }\r\n  return new Response(obj?.body).text();\r\n}\r\n\r\nasync function serveAppStatic(path: string, env: Env): Promise<StaticAssetResponse | null> {\r\n  const normalized = path.replace(/^\\/app\\/?/, \"\");\r\n  const bundleKey = (normalized && !normalized.startsWith(\"assets/\") ? \"index.html\" : normalized || \"index.html\") as StaticBundleKey;\r\n  if (!(bundleKey in STATIC_BUNDLE)) {\r\n    return null;\r\n  }\r\n  const ctHint = contentTypeFor(bundleKey);\r\n  const r2 = await loadFromR2(bundleKey, env);\r\n  if (r2) {\r\n    const headers = r2Headers(r2, ctHint, bundleKey);\r\n    if (bundleKey === \"index.html\") {\r\n      const raw = await readR2Text(r2);\r\n      const injected = await injectAppConfig(raw, env);\r\n      return {\r\n        response: new Response(injected.html, { headers }),\r\n        scriptHashes: injected.scriptHashes,\r\n      };\r\n    }\r\n    return { response: new Response(r2.body, { headers }) };\r\n  }\r\n  return bundleResponse(bundleKey, env);\r\n}\r\n\r\nexport default {\r\n  async fetch(req: Request, env: Env): Promise<Response> {\r\n    validateEnv(env);\r\n    const url = new URL(req.url);\r\n    const path = url.pathname;\r\n    const baseSecurity = baseSecurityHeaderOptions(env);\r\n    const applySecurity = (response: Response, overrides?: SecurityHeaderOptions) =>\r\n      withSecurityHeaders(response, mergeSecurityHeaderOptions(baseSecurity, overrides));\r\n    const canonicalAppRequestUrl = (requestUrl: URL): URL => {\r\n      try {\r\n        const canonical = new URL(env.APP_BASE_URL);\r\n        canonical.pathname = requestUrl.pathname;\r\n        canonical.search = requestUrl.search;\r\n        canonical.hash = requestUrl.hash;\r\n        return canonical;\r\n      } catch {\r\n        return requestUrl;\r\n      }\r\n    };\r\n    const respondUnauthenticated = () => {\r\n      if (req.method === \"GET\" || req.method === \"HEAD\") {\r\n        try {\r\n          const canonicalUrl = canonicalAppRequestUrl(url);\r\n          const loginUrl = new URL(\r\n            `/cdn-cgi/access/login/${encodeURIComponent(env.ACCESS_AUD)}`,\r\n            canonicalUrl,\r\n          );\r\n          loginUrl.searchParams.set(\"redirect_url\", canonicalUrl.toString());\r\n          return applySecurity(Response.redirect(loginUrl.toString(), 302));\r\n        } catch {\r\n          // fall back to 401 below\r\n        }\r\n      }\r\n      return applySecurity(new Response(\"Unauthorized\", { status: 401 }));\r\n    };\r\n\r\n    if (path === \"/\") {\r\n      return Response.redirect(url.origin + \"/app\", 302);\r\n    }\r\n\r\n    const preflight = maybeHandlePreflight(req, path, env);\r\n    if (preflight) return applySecurity(preflight);\r\n\r\n    if (path === \"/favicon.ico\") {\r\n      return applySecurity(new Response(\"\", { status: 204 }));\r\n    }\r\n\r\n    if (path === \"/sw-brand.js\") {\r\n      return applySecurity(\r\n        new Response(\"// stub\\n\", { headers: { \"content-type\": \"application/javascript\" } }),\r\n      );\r\n    }\r\n\r\n    if (path === \"/r2\" || path.startsWith(\"/r2/\")) {\r\n      return handleR2Request(req, env, { routePrefix: \"/r2\" });\r\n    }\r\n\r\n    if (req.method === \"OPTIONS\") {\r\n      return applySecurity(new Response(\"\", { status: 204, headers: CORS_BASE }));\r\n    }\r\n\r\n    if (path.startsWith(\"/assets/\")) {\r\n      const name = decodeURIComponent(path.replace(\"/assets/\", \"\"));\r\n      const asset = ASSETS[name];\r\n      if (!asset) return text(\"Not found\", { status: 404 });\r\n      return applySecurity(new Response(asset.body, { headers: { \"content-type\": asset.ct } }));\r\n    }\r\n\r\n    if (path === \"/app\" || path === \"/app/\") {\r\n      const user = await requireAccessUser(req, env);\r\n      if (!user) {\r\n        return respondUnauthenticated();\r\n      }\r\n      const landingPath = landingFor(user);\r\n      if (!landingPath.startsWith(\"/\") || landingPath.startsWith(\"//\")) {\r\n        throw new Error(`Invalid landing path: ${landingPath}`);\r\n      }\r\n      const landingUrl = new URL(landingPath, env.APP_BASE_URL);\r\n      if (url.pathname !== landingUrl.pathname) {\r\n        return applySecurity(Response.redirect(landingUrl.toString(), 302));\r\n      }\r\n      const spa = await serveAppStatic(\"/app\", env);\r\n      if (spa) {\r\n        const overrides = spa.scriptHashes ? { scriptHashes: spa.scriptHashes } : undefined;\r\n        return applySecurity(spa.response, overrides);\r\n      }\r\n      return text(\"Not found\", { status: 404 });\r\n    }\r\n\r\n    if (path === \"/app/logout\") {\r\n      const ret = resolveLogoutReturn(url.searchParams.get(\"return\"), env, url);\r\n      const logoutUrl = new URL(\"/cdn-cgi/access/logout\", url);\r\n      logoutUrl.searchParams.set(\"return\", ret);\r\n      return Response.redirect(logoutUrl.toString(), 302);\r\n    }\r\n\r\n    if (path.startsWith(\"/app/assets/\")) {\r\n      const user = await requireAccessUser(req, env);\r\n      if (!user) {\r\n        return respondUnauthenticated();\r\n      }\r\n      const assetRes = await serveAppStatic(path, env);\r\n      if (assetRes) {\r\n        const overrides = assetRes.scriptHashes ? { scriptHashes: assetRes.scriptHashes } : undefined;\r\n        return applySecurity(assetRes.response, overrides);\r\n      }\r\n      return text(\"Not found\", { status: 404 });\r\n    }\r\n\r\n    if (path.startsWith(\"/app/\")) {\r\n      const user = await requireAccessUser(req, env);\r\n      if (!user) {\r\n        return respondUnauthenticated();\r\n      }\r\n      const spa = await serveAppStatic(path, env);\r\n      if (spa) {\r\n        const overrides = spa.scriptHashes ? { scriptHashes: spa.scriptHashes } : undefined;\r\n        return applySecurity(spa.response, overrides);\r\n      }\r\n      return text(\"Not found\", { status: 404 });\r\n    }\r\n\r\n    return handleRequest(req, env);\r\n  },\r\n\r\n  async scheduled(event: ScheduledEvent, env: Env, _ctx: ExecutionContext) {\r\n    if (event.cron === TELEMETRY_RETENTION_CRON) {\r\n      const retentionLog = systemLogger({ task: \"retention-cron\" });\r\n      try {\r\n        await runTelemetryRetention(env, { logger: retentionLog });\r\n      } catch (error) {\r\n        retentionLog.error(\"cron.retention.failed\", { error });\r\n      }\r\n      return;\r\n    }\r\n\r\n    const log = systemLogger({ task: \"offline-cron\" });\r\n    try {\r\n      const result = await env.DB.prepare(\r\n        `DELETE FROM ingest_nonces WHERE expires_at < ?1`,\r\n      )\r\n        .bind(Date.now())\r\n        .run();\r\n      log.debug(\"cron.ingest_nonce_prune.completed\", {\r\n        deleted: result.meta?.changes ?? 0,\r\n      });\r\n    } catch (error) {\r\n      log.error(\"cron.ingest_nonce_prune.failed\", { error });\r\n    }\r\n\r\n    const hbInterval = coerceFiniteNumber(\r\n      env.HEARTBEAT_INTERVAL_SECS,\r\n      DEFAULT_HEARTBEAT_INTERVAL_SECS,\r\n    );\r\n    const multiplier = coerceFiniteNumber(env.OFFLINE_MULTIPLIER, DEFAULT_OFFLINE_MULTIPLIER);\r\n    const thresholdSecs = Math.max(60, hbInterval * multiplier);\r\n    const days = thresholdSecs / 86400;\r\n\r\n    const offlineStartedAt = Date.now();\n\n    const totalRow = await env.DB\n      .prepare(\n        `SELECT COUNT(*) AS cnt\n           FROM devices\n          WHERE online = 1\n            AND (last_seen_at IS NULL OR (julianday('now') - julianday(last_seen_at)) > ?1)`,\n      )\n      .bind(days)\n      .first<{ cnt: number | string | null }>();\n    const totalStale = Number(totalRow?.cnt ?? 0);\n\n    if (!Number.isFinite(totalStale) || totalStale <= 0) {\n      await clearCronCursor(env, OFFLINE_CURSOR_KEY);\n      log.debug(\"cron.offline_check.noop\", { stale_count: 0, threshold_secs: thresholdSecs });\n      await recordOpsMetric(env, \"/cron/offline\", 200, Date.now() - offlineStartedAt, null, log);\n      return;\n    }\n\n    log.info(\"cron.offline_check.start\", {\n      stale_count: totalStale,\n      threshold_secs: thresholdSecs,\n    });\n\n    const ts = new Date().toISOString();\n    const existingCursorRaw = await readCronCursor(env, OFFLINE_CURSOR_KEY);\n    let cursor = existingCursorRaw ? Number(existingCursorRaw) : 0;\n    let resumeCursor: number | null = existingCursorRaw ? Number(existingCursorRaw) : null;\n    let processed = 0;\n    let batches = 0;\n    let truncated = false;\n\n    while (true) {\n      const rowsResult = await env.DB\n        .prepare(\n          `SELECT rowid, device_id\n             FROM devices\n            WHERE online = 1\n              AND (last_seen_at IS NULL OR (julianday('now') - julianday(last_seen_at)) > ?1)\n              AND rowid > ?2\n            ORDER BY rowid\n            LIMIT ?3`,\n        )\n        .bind(days, cursor, OFFLINE_BATCH_SIZE)\n        .all<{ rowid: number; device_id: string }>();\n\n      const rows = rowsResult.results ?? [];\n      if (!rows.length) {\n        resumeCursor = null;\n        break;\n      }\n\n      const batchIds = rows.map((row) => row.device_id);\n      batches += 1;\n\n      const devicePlaceholders = batchIds.map(() => \"?\").join(\",\");\n      await env.DB.prepare(\n        `UPDATE devices SET online=0 WHERE online=1 AND device_id IN (${devicePlaceholders})`,\n      )\n        .bind(...batchIds)\n        .run();\n\n      const latestPlaceholders = batchIds.map((_, index) => `?${index + 2}`).join(\",\");\n      await env.DB.prepare(\n        `UPDATE latest_state SET online=0, updated_at=?1 WHERE device_id IN (${latestPlaceholders})`,\n      )\n        .bind(ts, ...batchIds)\n        .run();\n\n      const values = batchIds.map(() => `(?, ?, ?, ?, ?)`).join(\",\");\n      const binds: any[] = [];\n      for (const id of batchIds) {\n        binds.push(ts, \"/cron/offline\", 200, 0, id);\n      }\n      await env.DB.prepare(\n        `INSERT INTO ops_metrics (ts, route, status_code, duration_ms, device_id) VALUES ${values}`,\n      )\n        .bind(...binds)\n        .run();\n\n      processed += batchIds.length;\n      const lastRowId = rows[rows.length - 1]?.rowid ?? cursor;\n      cursor = lastRowId;\n      resumeCursor = lastRowId;\n\n      if (batches >= OFFLINE_MAX_BATCHES_PER_RUN) {\n        truncated = true;\n        break;\n      }\n\n      if (rows.length < OFFLINE_BATCH_SIZE) {\n        resumeCursor = null;\n        break;\n      }\n    }\n\n    if (resumeCursor !== null) {\n      await writeCronCursor(env, OFFLINE_CURSOR_KEY, resumeCursor);\n    } else {\n      await clearCronCursor(env, OFFLINE_CURSOR_KEY);\n    }\n\n    log.info(\"cron.offline_check.completed\", {\n      stale_count: totalStale,\n      processed,\n      batches,\n      truncated,\n      resume_cursor: resumeCursor,\n    });\n\n    await recordOpsMetric(env, \"/cron/offline\", truncated ? 299 : 200, Date.now() - offlineStartedAt, null, log);\n  },\n};\n", "import type { Middleware } from \"./common\";\n\nconst drainBody: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} finally {\n\t\ttry {\n\t\t\tif (request.body !== null && !request.bodyUsed) {\n\t\t\t\tconst reader = request.body.getReader();\n\t\t\t\twhile (!(await reader.read()).done) {}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.error(\"Failed to drain the unused request body.\", e);\n\t\t}\n\t}\n};\n\nexport default drainBody;\n", "import type { Middleware } from \"./common\";\n\ninterface JsonError {\n\tmessage?: string;\n\tname?: string;\n\tstack?: string;\n\tcause?: JsonError;\n}\n\nfunction reduceError(e: any): JsonError {\n\treturn {\n\t\tname: e?.name,\n\t\tmessage: e?.message ?? String(e),\n\t\tstack: e?.stack,\n\t\tcause: e?.cause === undefined ? undefined : reduceError(e.cause),\n\t};\n}\n\n// See comment in `bundle.ts` for details on why this is needed\nconst jsonError: Middleware = async (request, env, _ctx, middlewareCtx) => {\n\ttry {\n\t\treturn await middlewareCtx.next(request, env);\n\t} catch (e: any) {\n\t\tconst error = reduceError(e);\n\t\treturn Response.json(error, {\n\t\t\tstatus: 500,\n\t\t\theaders: { \"MF-Experimental-Error-Stack\": \"true\" },\n\t\t});\n\t}\n};\n\nexport default jsonError;\n", "\t\t\t\timport worker, * as OTHER_EXPORTS from \"D:\\\\Work\\\\GREENBRO\\\\GB-Heat-Pump-App-V1\\\\src\\\\app.ts\";\n\t\t\t\timport * as __MIDDLEWARE_0__ from \"C:\\\\Users\\\\bradl.CRABNEBULA\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-ensure-req-body-drained.ts\";\nimport * as __MIDDLEWARE_1__ from \"C:\\\\Users\\\\bradl.CRABNEBULA\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\middleware-miniflare3-json-error.ts\";\n\n\t\t\t\texport * from \"D:\\\\Work\\\\GREENBRO\\\\GB-Heat-Pump-App-V1\\\\src\\\\app.ts\";\n\t\t\t\tconst MIDDLEWARE_TEST_INJECT = \"__INJECT_FOR_TESTING_WRANGLER_MIDDLEWARE__\";\n\t\t\t\texport const __INTERNAL_WRANGLER_MIDDLEWARE__ = [\n\t\t\t\t\t\n\t\t\t\t\t__MIDDLEWARE_0__.default,__MIDDLEWARE_1__.default\n\t\t\t\t]\n\t\t\t\texport default worker;", "export type Awaitable<T> = T | Promise<T>;\n// TODO: allow dispatching more events?\nexport type Dispatcher = (\n\ttype: \"scheduled\",\n\tinit: { cron?: string }\n) => Awaitable<void>;\n\nexport type IncomingRequest = Request<\n\tunknown,\n\tIncomingRequestCfProperties<unknown>\n>;\n\nexport interface MiddlewareContext {\n\tdispatch: Dispatcher;\n\tnext(request: IncomingRequest, env: any): Awaitable<Response>;\n}\n\nexport type Middleware = (\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tmiddlewareCtx: MiddlewareContext\n) => Awaitable<Response>;\n\nconst __facade_middleware__: Middleware[] = [];\n\n// The register functions allow for the insertion of one or many middleware,\n// We register internal middleware first in the stack, but have no way of controlling\n// the order that addMiddleware is run in service workers so need an internal function.\nexport function __facade_register__(...args: (Middleware | Middleware[])[]) {\n\t__facade_middleware__.push(...args.flat());\n}\nexport function __facade_registerInternal__(\n\t...args: (Middleware | Middleware[])[]\n) {\n\t__facade_middleware__.unshift(...args.flat());\n}\n\nfunction __facade_invokeChain__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tmiddlewareChain: Middleware[]\n): Awaitable<Response> {\n\tconst [head, ...tail] = middlewareChain;\n\tconst middlewareCtx: MiddlewareContext = {\n\t\tdispatch,\n\t\tnext(newRequest, newEnv) {\n\t\t\treturn __facade_invokeChain__(newRequest, newEnv, ctx, dispatch, tail);\n\t\t},\n\t};\n\treturn head(request, env, ctx, middlewareCtx);\n}\n\nexport function __facade_invoke__(\n\trequest: IncomingRequest,\n\tenv: any,\n\tctx: ExecutionContext,\n\tdispatch: Dispatcher,\n\tfinalMiddleware: Middleware\n): Awaitable<Response> {\n\treturn __facade_invokeChain__(request, env, ctx, dispatch, [\n\t\t...__facade_middleware__,\n\t\tfinalMiddleware,\n\t]);\n}\n", "// This loads all middlewares exposed on the middleware object and then starts\n// the invocation chain. The big idea is that we can add these to the middleware\n// export dynamically through wrangler, or we can potentially let users directly\n// add them as a sort of \"plugin\" system.\n\nimport ENTRY, { __INTERNAL_WRANGLER_MIDDLEWARE__ } from \"D:\\\\Work\\\\GREENBRO\\\\GB-Heat-Pump-App-V1\\\\.wrangler\\\\tmp\\\\bundle-Nsbk6Y\\\\middleware-insertion-facade.js\";\nimport { __facade_invoke__, __facade_register__, Dispatcher } from \"C:\\\\Users\\\\bradl.CRABNEBULA\\\\AppData\\\\Roaming\\\\npm\\\\node_modules\\\\wrangler\\\\templates\\\\middleware\\\\common.ts\";\nimport type { WorkerEntrypointConstructor } from \"D:\\\\Work\\\\GREENBRO\\\\GB-Heat-Pump-App-V1\\\\.wrangler\\\\tmp\\\\bundle-Nsbk6Y\\\\middleware-insertion-facade.js\";\n\n// Preserve all the exports from the worker\nexport * from \"D:\\\\Work\\\\GREENBRO\\\\GB-Heat-Pump-App-V1\\\\.wrangler\\\\tmp\\\\bundle-Nsbk6Y\\\\middleware-insertion-facade.js\";\n\nclass __Facade_ScheduledController__ implements ScheduledController {\n\treadonly #noRetry: ScheduledController[\"noRetry\"];\n\n\tconstructor(\n\t\treadonly scheduledTime: number,\n\t\treadonly cron: string,\n\t\tnoRetry: ScheduledController[\"noRetry\"]\n\t) {\n\t\tthis.#noRetry = noRetry;\n\t}\n\n\tnoRetry() {\n\t\tif (!(this instanceof __Facade_ScheduledController__)) {\n\t\t\tthrow new TypeError(\"Illegal invocation\");\n\t\t}\n\t\t// Need to call native method immediately in case uncaught error thrown\n\t\tthis.#noRetry();\n\t}\n}\n\nfunction wrapExportedHandler(worker: ExportedHandler): ExportedHandler {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn worker;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\tconst fetchDispatcher: ExportedHandlerFetchHandler = function (\n\t\trequest,\n\t\tenv,\n\t\tctx\n\t) {\n\t\tif (worker.fetch === undefined) {\n\t\t\tthrow new Error(\"Handler does not export a fetch() function.\");\n\t\t}\n\t\treturn worker.fetch(request, env, ctx);\n\t};\n\n\treturn {\n\t\t...worker,\n\t\tfetch(request, env, ctx) {\n\t\t\tconst dispatcher: Dispatcher = function (type, init) {\n\t\t\t\tif (type === \"scheduled\" && worker.scheduled !== undefined) {\n\t\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\t\tDate.now(),\n\t\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t\t() => {}\n\t\t\t\t\t);\n\t\t\t\t\treturn worker.scheduled(controller, env, ctx);\n\t\t\t\t}\n\t\t\t};\n\t\t\treturn __facade_invoke__(request, env, ctx, dispatcher, fetchDispatcher);\n\t\t},\n\t};\n}\n\nfunction wrapWorkerEntrypoint(\n\tklass: WorkerEntrypointConstructor\n): WorkerEntrypointConstructor {\n\t// If we don't have any middleware defined, just return the handler as is\n\tif (\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__ === undefined ||\n\t\t__INTERNAL_WRANGLER_MIDDLEWARE__.length === 0\n\t) {\n\t\treturn klass;\n\t}\n\t// Otherwise, register all middleware once\n\tfor (const middleware of __INTERNAL_WRANGLER_MIDDLEWARE__) {\n\t\t__facade_register__(middleware);\n\t}\n\n\t// `extend`ing `klass` here so other RPC methods remain callable\n\treturn class extends klass {\n\t\t#fetchDispatcher: ExportedHandlerFetchHandler<Record<string, unknown>> = (\n\t\t\trequest,\n\t\t\tenv,\n\t\t\tctx\n\t\t) => {\n\t\t\tthis.env = env;\n\t\t\tthis.ctx = ctx;\n\t\t\tif (super.fetch === undefined) {\n\t\t\t\tthrow new Error(\"Entrypoint class does not define a fetch() function.\");\n\t\t\t}\n\t\t\treturn super.fetch(request);\n\t\t};\n\n\t\t#dispatcher: Dispatcher = (type, init) => {\n\t\t\tif (type === \"scheduled\" && super.scheduled !== undefined) {\n\t\t\t\tconst controller = new __Facade_ScheduledController__(\n\t\t\t\t\tDate.now(),\n\t\t\t\t\tinit.cron ?? \"\",\n\t\t\t\t\t() => {}\n\t\t\t\t);\n\t\t\t\treturn super.scheduled(controller);\n\t\t\t}\n\t\t};\n\n\t\tfetch(request: Request<unknown, IncomingRequestCfProperties>) {\n\t\t\treturn __facade_invoke__(\n\t\t\t\trequest,\n\t\t\t\tthis.env,\n\t\t\t\tthis.ctx,\n\t\t\t\tthis.#dispatcher,\n\t\t\t\tthis.#fetchDispatcher\n\t\t\t);\n\t\t}\n\t};\n}\n\nlet WRAPPED_ENTRY: ExportedHandler | WorkerEntrypointConstructor | undefined;\nif (typeof ENTRY === \"object\") {\n\tWRAPPED_ENTRY = wrapExportedHandler(ENTRY);\n} else if (typeof ENTRY === \"function\") {\n\tWRAPPED_ENTRY = wrapWorkerEntrypoint(ENTRY);\n}\nexport default WRAPPED_ENTRY;\n"],
  "mappings": ";;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACAO,IAAI;AAAA,CACV,SAAUA,OAAM;AACb,EAAAA,MAAK,cAAc,CAAC,MAAM;AAAA,EAAE;AAC5B,WAAS,SAAS,MAAM;AAAA,EAAE;AAAjB;AACT,EAAAA,MAAK,WAAW;AAChB,WAAS,YAAY,IAAI;AACrB,UAAM,IAAI,MAAM;AAAA,EACpB;AAFS;AAGT,EAAAA,MAAK,cAAc;AACnB,EAAAA,MAAK,cAAc,CAAC,UAAU;AAC1B,UAAM,MAAM,CAAC;AACb,eAAW,QAAQ,OAAO;AACtB,UAAI,IAAI,IAAI;AAAA,IAChB;AACA,WAAO;AAAA,EACX;AACA,EAAAA,MAAK,qBAAqB,CAAC,QAAQ;AAC/B,UAAM,YAAYA,MAAK,WAAW,GAAG,EAAE,OAAO,CAAC,MAAM,OAAO,IAAI,IAAI,CAAC,CAAC,MAAM,QAAQ;AACpF,UAAM,WAAW,CAAC;AAClB,eAAW,KAAK,WAAW;AACvB,eAAS,CAAC,IAAI,IAAI,CAAC;AAAA,IACvB;AACA,WAAOA,MAAK,aAAa,QAAQ;AAAA,EACrC;AACA,EAAAA,MAAK,eAAe,CAAC,QAAQ;AACzB,WAAOA,MAAK,WAAW,GAAG,EAAE,IAAI,SAAU,GAAG;AACzC,aAAO,IAAI,CAAC;AAAA,IAChB,CAAC;AAAA,EACL;AACA,EAAAA,MAAK,aAAa,OAAO,OAAO,SAAS,aACnC,CAAC,QAAQ,OAAO,KAAK,GAAG,IACxB,CAAC,WAAW;AACV,UAAM,OAAO,CAAC;AACd,eAAW,OAAO,QAAQ;AACtB,UAAI,OAAO,UAAU,eAAe,KAAK,QAAQ,GAAG,GAAG;AACnD,aAAK,KAAK,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO;AAAA,EACX;AACJ,EAAAA,MAAK,OAAO,CAAC,KAAK,YAAY;AAC1B,eAAW,QAAQ,KAAK;AACpB,UAAI,QAAQ,IAAI;AACZ,eAAO;AAAA,IACf;AACA,WAAO;AAAA,EACX;AACA,EAAAA,MAAK,YAAY,OAAO,OAAO,cAAc,aACvC,CAAC,QAAQ,OAAO,UAAU,GAAG,IAC7B,CAAC,QAAQ,OAAO,QAAQ,YAAY,OAAO,SAAS,GAAG,KAAK,KAAK,MAAM,GAAG,MAAM;AACtF,WAAS,WAAW,OAAO,YAAY,OAAO;AAC1C,WAAO,MAAM,IAAI,CAAC,QAAS,OAAO,QAAQ,WAAW,IAAI,GAAG,MAAM,GAAI,EAAE,KAAK,SAAS;AAAA,EAC1F;AAFS;AAGT,EAAAA,MAAK,aAAa;AAClB,EAAAA,MAAK,wBAAwB,CAAC,GAAG,UAAU;AACvC,QAAI,OAAO,UAAU,UAAU;AAC3B,aAAO,MAAM,SAAS;AAAA,IAC1B;AACA,WAAO;AAAA,EACX;AACJ,GAAG,SAAS,OAAO,CAAC,EAAE;AACf,IAAI;AAAA,CACV,SAAUC,aAAY;AACnB,EAAAA,YAAW,cAAc,CAAC,OAAO,WAAW;AACxC,WAAO;AAAA,MACH,GAAG;AAAA,MACH,GAAG;AAAA;AAAA,IACP;AAAA,EACJ;AACJ,GAAG,eAAe,aAAa,CAAC,EAAE;AAC3B,IAAM,gBAAgB,KAAK,YAAY;AAAA,EAC1C;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACJ,CAAC;AACM,IAAM,gBAAgB,wBAAC,SAAS;AACnC,QAAMC,KAAI,OAAO;AACjB,UAAQA,IAAG;AAAA,IACP,KAAK;AACD,aAAO,cAAc;AAAA,IACzB,KAAK;AACD,aAAO,cAAc;AAAA,IACzB,KAAK;AACD,aAAO,OAAO,MAAM,IAAI,IAAI,cAAc,MAAM,cAAc;AAAA,IAClE,KAAK;AACD,aAAO,cAAc;AAAA,IACzB,KAAK;AACD,aAAO,cAAc;AAAA,IACzB,KAAK;AACD,aAAO,cAAc;AAAA,IACzB,KAAK;AACD,aAAO,cAAc;AAAA,IACzB,KAAK;AACD,UAAI,MAAM,QAAQ,IAAI,GAAG;AACrB,eAAO,cAAc;AAAA,MACzB;AACA,UAAI,SAAS,MAAM;AACf,eAAO,cAAc;AAAA,MACzB;AACA,UAAI,KAAK,QAAQ,OAAO,KAAK,SAAS,cAAc,KAAK,SAAS,OAAO,KAAK,UAAU,YAAY;AAChG,eAAO,cAAc;AAAA,MACzB;AACA,UAAI,OAAO,QAAQ,eAAe,gBAAgB,KAAK;AACnD,eAAO,cAAc;AAAA,MACzB;AACA,UAAI,OAAO,QAAQ,eAAe,gBAAgB,KAAK;AACnD,eAAO,cAAc;AAAA,MACzB;AACA,UAAI,OAAO,SAAS,eAAe,gBAAgB,MAAM;AACrD,eAAO,cAAc;AAAA,MACzB;AACA,aAAO,cAAc;AAAA,IACzB;AACI,aAAO,cAAc;AAAA,EAC7B;AACJ,GAxC6B;;;AC3FtB,IAAM,eAAe,KAAK,YAAY;AAAA,EACzC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACJ,CAAC;AACM,IAAM,gBAAgB,wBAAC,QAAQ;AAClC,QAAMC,QAAO,KAAK,UAAU,KAAK,MAAM,CAAC;AACxC,SAAOA,MAAK,QAAQ,eAAe,KAAK;AAC5C,GAH6B;AAItB,IAAM,WAAN,MAAM,kBAAiB,MAAM;AAAA,EAvBpC,OAuBoC;AAAA;AAAA;AAAA,EAChC,IAAI,SAAS;AACT,WAAO,KAAK;AAAA,EAChB;AAAA,EACA,YAAY,QAAQ;AAChB,UAAM;AACN,SAAK,SAAS,CAAC;AACf,SAAK,WAAW,CAAC,QAAQ;AACrB,WAAK,SAAS,CAAC,GAAG,KAAK,QAAQ,GAAG;AAAA,IACtC;AACA,SAAK,YAAY,CAAC,OAAO,CAAC,MAAM;AAC5B,WAAK,SAAS,CAAC,GAAG,KAAK,QAAQ,GAAG,IAAI;AAAA,IAC1C;AACA,UAAM,cAAc,WAAW;AAC/B,QAAI,OAAO,gBAAgB;AAEvB,aAAO,eAAe,MAAM,WAAW;AAAA,IAC3C,OACK;AACD,WAAK,YAAY;AAAA,IACrB;AACA,SAAK,OAAO;AACZ,SAAK,SAAS;AAAA,EAClB;AAAA,EACA,OAAO,SAAS;AACZ,UAAM,SAAS,WACX,SAAU,OAAO;AACb,aAAO,MAAM;AAAA,IACjB;AACJ,UAAM,cAAc,EAAE,SAAS,CAAC,EAAE;AAClC,UAAM,eAAe,wBAAC,UAAU;AAC5B,iBAAW,SAAS,MAAM,QAAQ;AAC9B,YAAI,MAAM,SAAS,iBAAiB;AAChC,gBAAM,YAAY,IAAI,YAAY;AAAA,QACtC,WACS,MAAM,SAAS,uBAAuB;AAC3C,uBAAa,MAAM,eAAe;AAAA,QACtC,WACS,MAAM,SAAS,qBAAqB;AACzC,uBAAa,MAAM,cAAc;AAAA,QACrC,WACS,MAAM,KAAK,WAAW,GAAG;AAC9B,sBAAY,QAAQ,KAAK,OAAO,KAAK,CAAC;AAAA,QAC1C,OACK;AACD,cAAI,OAAO;AACX,cAAI,IAAI;AACR,iBAAO,IAAI,MAAM,KAAK,QAAQ;AAC1B,kBAAM,KAAK,MAAM,KAAK,CAAC;AACvB,kBAAM,WAAW,MAAM,MAAM,KAAK,SAAS;AAC3C,gBAAI,CAAC,UAAU;AACX,mBAAK,EAAE,IAAI,KAAK,EAAE,KAAK,EAAE,SAAS,CAAC,EAAE;AAAA,YAQzC,OACK;AACD,mBAAK,EAAE,IAAI,KAAK,EAAE,KAAK,EAAE,SAAS,CAAC,EAAE;AACrC,mBAAK,EAAE,EAAE,QAAQ,KAAK,OAAO,KAAK,CAAC;AAAA,YACvC;AACA,mBAAO,KAAK,EAAE;AACd;AAAA,UACJ;AAAA,QACJ;AAAA,MACJ;AAAA,IACJ,GAvCqB;AAwCrB,iBAAa,IAAI;AACjB,WAAO;AAAA,EACX;AAAA,EACA,OAAO,OAAO,OAAO;AACjB,QAAI,EAAE,iBAAiB,YAAW;AAC9B,YAAM,IAAI,MAAM,mBAAmB,KAAK,EAAE;AAAA,IAC9C;AAAA,EACJ;AAAA,EACA,WAAW;AACP,WAAO,KAAK;AAAA,EAChB;AAAA,EACA,IAAI,UAAU;AACV,WAAO,KAAK,UAAU,KAAK,QAAQ,KAAK,uBAAuB,CAAC;AAAA,EACpE;AAAA,EACA,IAAI,UAAU;AACV,WAAO,KAAK,OAAO,WAAW;AAAA,EAClC;AAAA,EACA,QAAQ,SAAS,CAAC,UAAU,MAAM,SAAS;AACvC,UAAM,cAAc,CAAC;AACrB,UAAM,aAAa,CAAC;AACpB,eAAW,OAAO,KAAK,QAAQ;AAC3B,UAAI,IAAI,KAAK,SAAS,GAAG;AACrB,cAAM,UAAU,IAAI,KAAK,CAAC;AAC1B,oBAAY,OAAO,IAAI,YAAY,OAAO,KAAK,CAAC;AAChD,oBAAY,OAAO,EAAE,KAAK,OAAO,GAAG,CAAC;AAAA,MACzC,OACK;AACD,mBAAW,KAAK,OAAO,GAAG,CAAC;AAAA,MAC/B;AAAA,IACJ;AACA,WAAO,EAAE,YAAY,YAAY;AAAA,EACrC;AAAA,EACA,IAAI,aAAa;AACb,WAAO,KAAK,QAAQ;AAAA,EACxB;AACJ;AACA,SAAS,SAAS,CAAC,WAAW;AAC1B,QAAM,QAAQ,IAAI,SAAS,MAAM;AACjC,SAAO;AACX;;;AClIA,IAAM,WAAW,wBAAC,OAAO,SAAS;AAC9B,MAAIC;AACJ,UAAQ,MAAM,MAAM;AAAA,IAChB,KAAK,aAAa;AACd,UAAI,MAAM,aAAa,cAAc,WAAW;AAC5C,QAAAA,WAAU;AAAA,MACd,OACK;AACD,QAAAA,WAAU,YAAY,MAAM,QAAQ,cAAc,MAAM,QAAQ;AAAA,MACpE;AACA;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU,mCAAmC,KAAK,UAAU,MAAM,UAAU,KAAK,qBAAqB,CAAC;AACvG;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU,kCAAkC,KAAK,WAAW,MAAM,MAAM,IAAI,CAAC;AAC7E;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU;AACV;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU,yCAAyC,KAAK,WAAW,MAAM,OAAO,CAAC;AACjF;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU,gCAAgC,KAAK,WAAW,MAAM,OAAO,CAAC,eAAe,MAAM,QAAQ;AACrG;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU;AACV;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU;AACV;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU;AACV;AAAA,IACJ,KAAK,aAAa;AACd,UAAI,OAAO,MAAM,eAAe,UAAU;AACtC,YAAI,cAAc,MAAM,YAAY;AAChC,UAAAA,WAAU,gCAAgC,MAAM,WAAW,QAAQ;AACnE,cAAI,OAAO,MAAM,WAAW,aAAa,UAAU;AAC/C,YAAAA,WAAU,GAAGA,QAAO,sDAAsD,MAAM,WAAW,QAAQ;AAAA,UACvG;AAAA,QACJ,WACS,gBAAgB,MAAM,YAAY;AACvC,UAAAA,WAAU,mCAAmC,MAAM,WAAW,UAAU;AAAA,QAC5E,WACS,cAAc,MAAM,YAAY;AACrC,UAAAA,WAAU,iCAAiC,MAAM,WAAW,QAAQ;AAAA,QACxE,OACK;AACD,eAAK,YAAY,MAAM,UAAU;AAAA,QACrC;AAAA,MACJ,WACS,MAAM,eAAe,SAAS;AACnC,QAAAA,WAAU,WAAW,MAAM,UAAU;AAAA,MACzC,OACK;AACD,QAAAA,WAAU;AAAA,MACd;AACA;AAAA,IACJ,KAAK,aAAa;AACd,UAAI,MAAM,SAAS;AACf,QAAAA,WAAU,sBAAsB,MAAM,QAAQ,YAAY,MAAM,YAAY,aAAa,WAAW,IAAI,MAAM,OAAO;AAAA,eAChH,MAAM,SAAS;AACpB,QAAAA,WAAU,uBAAuB,MAAM,QAAQ,YAAY,MAAM,YAAY,aAAa,MAAM,IAAI,MAAM,OAAO;AAAA,eAC5G,MAAM,SAAS;AACpB,QAAAA,WAAU,kBAAkB,MAAM,QAAQ,sBAAsB,MAAM,YAAY,8BAA8B,eAAe,GAAG,MAAM,OAAO;AAAA,eAC1I,MAAM,SAAS;AACpB,QAAAA,WAAU,kBAAkB,MAAM,QAAQ,sBAAsB,MAAM,YAAY,8BAA8B,eAAe,GAAG,MAAM,OAAO;AAAA,eAC1I,MAAM,SAAS;AACpB,QAAAA,WAAU,gBAAgB,MAAM,QAAQ,sBAAsB,MAAM,YAAY,8BAA8B,eAAe,GAAG,IAAI,KAAK,OAAO,MAAM,OAAO,CAAC,CAAC;AAAA;AAE/J,QAAAA,WAAU;AACd;AAAA,IACJ,KAAK,aAAa;AACd,UAAI,MAAM,SAAS;AACf,QAAAA,WAAU,sBAAsB,MAAM,QAAQ,YAAY,MAAM,YAAY,YAAY,WAAW,IAAI,MAAM,OAAO;AAAA,eAC/G,MAAM,SAAS;AACpB,QAAAA,WAAU,uBAAuB,MAAM,QAAQ,YAAY,MAAM,YAAY,YAAY,OAAO,IAAI,MAAM,OAAO;AAAA,eAC5G,MAAM,SAAS;AACpB,QAAAA,WAAU,kBAAkB,MAAM,QAAQ,YAAY,MAAM,YAAY,0BAA0B,WAAW,IAAI,MAAM,OAAO;AAAA,eACzH,MAAM,SAAS;AACpB,QAAAA,WAAU,kBAAkB,MAAM,QAAQ,YAAY,MAAM,YAAY,0BAA0B,WAAW,IAAI,MAAM,OAAO;AAAA,eACzH,MAAM,SAAS;AACpB,QAAAA,WAAU,gBAAgB,MAAM,QAAQ,YAAY,MAAM,YAAY,6BAA6B,cAAc,IAAI,IAAI,KAAK,OAAO,MAAM,OAAO,CAAC,CAAC;AAAA;AAEpJ,QAAAA,WAAU;AACd;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU;AACV;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU;AACV;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU,gCAAgC,MAAM,UAAU;AAC1D;AAAA,IACJ,KAAK,aAAa;AACd,MAAAA,WAAU;AACV;AAAA,IACJ;AACI,MAAAA,WAAU,KAAK;AACf,WAAK,YAAY,KAAK;AAAA,EAC9B;AACA,SAAO,EAAE,SAAAA,SAAQ;AACrB,GAzGiB;AA0GjB,IAAO,aAAQ;;;AC3Gf,IAAI,mBAAmB;AAEhB,SAAS,YAAY,KAAK;AAC7B,qBAAmB;AACvB;AAFgB;AAGT,SAAS,cAAc;AAC1B,SAAO;AACX;AAFgB;;;ACJT,IAAM,YAAY,wBAAC,WAAW;AACjC,QAAM,EAAE,MAAM,MAAM,WAAW,UAAU,IAAI;AAC7C,QAAM,WAAW,CAAC,GAAG,MAAM,GAAI,UAAU,QAAQ,CAAC,CAAE;AACpD,QAAM,YAAY;AAAA,IACd,GAAG;AAAA,IACH,MAAM;AAAA,EACV;AACA,MAAI,UAAU,YAAY,QAAW;AACjC,WAAO;AAAA,MACH,GAAG;AAAA,MACH,MAAM;AAAA,MACN,SAAS,UAAU;AAAA,IACvB;AAAA,EACJ;AACA,MAAI,eAAe;AACnB,QAAM,OAAO,UACR,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,EACjB,MAAM,EACN,QAAQ;AACb,aAAW,OAAO,MAAM;AACpB,mBAAe,IAAI,WAAW,EAAE,MAAM,cAAc,aAAa,CAAC,EAAE;AAAA,EACxE;AACA,SAAO;AAAA,IACH,GAAG;AAAA,IACH,MAAM;AAAA,IACN,SAAS;AAAA,EACb;AACJ,GA3ByB;AA4BlB,IAAM,aAAa,CAAC;AACpB,SAAS,kBAAkB,KAAK,WAAW;AAC9C,QAAM,cAAc,YAAY;AAChC,QAAM,QAAQ,UAAU;AAAA,IACpB;AAAA,IACA,MAAM,IAAI;AAAA,IACV,MAAM,IAAI;AAAA,IACV,WAAW;AAAA,MACP,IAAI,OAAO;AAAA;AAAA,MACX,IAAI;AAAA;AAAA,MACJ;AAAA;AAAA,MACA,gBAAgB,aAAkB,SAAY;AAAA;AAAA,IAClD,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;AAAA,EACvB,CAAC;AACD,MAAI,OAAO,OAAO,KAAK,KAAK;AAChC;AAdgB;AAeT,IAAM,cAAN,MAAM,aAAY;AAAA,EA9CzB,OA8CyB;AAAA;AAAA;AAAA,EACrB,cAAc;AACV,SAAK,QAAQ;AAAA,EACjB;AAAA,EACA,QAAQ;AACJ,QAAI,KAAK,UAAU;AACf,WAAK,QAAQ;AAAA,EACrB;AAAA,EACA,QAAQ;AACJ,QAAI,KAAK,UAAU;AACf,WAAK,QAAQ;AAAA,EACrB;AAAA,EACA,OAAO,WAAW,QAAQ,SAAS;AAC/B,UAAM,aAAa,CAAC;AACpB,eAAW,KAAK,SAAS;AACrB,UAAI,EAAE,WAAW;AACb,eAAO;AACX,UAAI,EAAE,WAAW;AACb,eAAO,MAAM;AACjB,iBAAW,KAAK,EAAE,KAAK;AAAA,IAC3B;AACA,WAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,WAAW;AAAA,EACrD;AAAA,EACA,aAAa,iBAAiB,QAAQ,OAAO;AACzC,UAAM,YAAY,CAAC;AACnB,eAAW,QAAQ,OAAO;AACtB,YAAM,MAAM,MAAM,KAAK;AACvB,YAAM,QAAQ,MAAM,KAAK;AACzB,gBAAU,KAAK;AAAA,QACX;AAAA,QACA;AAAA,MACJ,CAAC;AAAA,IACL;AACA,WAAO,aAAY,gBAAgB,QAAQ,SAAS;AAAA,EACxD;AAAA,EACA,OAAO,gBAAgB,QAAQ,OAAO;AAClC,UAAM,cAAc,CAAC;AACrB,eAAW,QAAQ,OAAO;AACtB,YAAM,EAAE,KAAK,MAAM,IAAI;AACvB,UAAI,IAAI,WAAW;AACf,eAAO;AACX,UAAI,MAAM,WAAW;AACjB,eAAO;AACX,UAAI,IAAI,WAAW;AACf,eAAO,MAAM;AACjB,UAAI,MAAM,WAAW;AACjB,eAAO,MAAM;AACjB,UAAI,IAAI,UAAU,gBAAgB,OAAO,MAAM,UAAU,eAAe,KAAK,YAAY;AACrF,oBAAY,IAAI,KAAK,IAAI,MAAM;AAAA,MACnC;AAAA,IACJ;AACA,WAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,YAAY;AAAA,EACtD;AACJ;AACO,IAAM,UAAU,OAAO,OAAO;AAAA,EACjC,QAAQ;AACZ,CAAC;AACM,IAAM,QAAQ,wBAAC,WAAW,EAAE,QAAQ,SAAS,MAAM,IAArC;AACd,IAAM,KAAK,wBAAC,WAAW,EAAE,QAAQ,SAAS,MAAM,IAArC;AACX,IAAM,YAAY,wBAAC,MAAM,EAAE,WAAW,WAApB;AAClB,IAAM,UAAU,wBAAC,MAAM,EAAE,WAAW,SAApB;AAChB,IAAM,UAAU,wBAAC,MAAM,EAAE,WAAW,SAApB;AAChB,IAAM,UAAU,wBAAC,MAAM,OAAO,YAAY,eAAe,aAAa,SAAtD;;;AC5GhB,IAAI;AAAA,CACV,SAAUC,YAAW;AAClB,EAAAA,WAAU,WAAW,CAACC,aAAY,OAAOA,aAAY,WAAW,EAAE,SAAAA,SAAQ,IAAIA,YAAW,CAAC;AAE1F,EAAAD,WAAU,WAAW,CAACC,aAAY,OAAOA,aAAY,WAAWA,WAAUA,UAAS;AACvF,GAAG,cAAc,YAAY,CAAC,EAAE;;;ACAhC,IAAM,qBAAN,MAAyB;AAAA,EALzB,OAKyB;AAAA;AAAA;AAAA,EACrB,YAAY,QAAQ,OAAO,MAAM,KAAK;AAClC,SAAK,cAAc,CAAC;AACpB,SAAK,SAAS;AACd,SAAK,OAAO;AACZ,SAAK,QAAQ;AACb,SAAK,OAAO;AAAA,EAChB;AAAA,EACA,IAAI,OAAO;AACP,QAAI,CAAC,KAAK,YAAY,QAAQ;AAC1B,UAAI,MAAM,QAAQ,KAAK,IAAI,GAAG;AAC1B,aAAK,YAAY,KAAK,GAAG,KAAK,OAAO,GAAG,KAAK,IAAI;AAAA,MACrD,OACK;AACD,aAAK,YAAY,KAAK,GAAG,KAAK,OAAO,KAAK,IAAI;AAAA,MAClD;AAAA,IACJ;AACA,WAAO,KAAK;AAAA,EAChB;AACJ;AACA,IAAM,eAAe,wBAAC,KAAK,WAAW;AAClC,MAAI,QAAQ,MAAM,GAAG;AACjB,WAAO,EAAE,SAAS,MAAM,MAAM,OAAO,MAAM;AAAA,EAC/C,OACK;AACD,QAAI,CAAC,IAAI,OAAO,OAAO,QAAQ;AAC3B,YAAM,IAAI,MAAM,2CAA2C;AAAA,IAC/D;AACA,WAAO;AAAA,MACH,SAAS;AAAA,MACT,IAAI,QAAQ;AACR,YAAI,KAAK;AACL,iBAAO,KAAK;AAChB,cAAM,QAAQ,IAAI,SAAS,IAAI,OAAO,MAAM;AAC5C,aAAK,SAAS;AACd,eAAO,KAAK;AAAA,MAChB;AAAA,IACJ;AAAA,EACJ;AACJ,GAnBqB;AAoBrB,SAAS,oBAAoB,QAAQ;AACjC,MAAI,CAAC;AACD,WAAO,CAAC;AACZ,QAAM,EAAE,UAAAC,WAAU,oBAAoB,gBAAgB,YAAY,IAAI;AACtE,MAAIA,cAAa,sBAAsB,iBAAiB;AACpD,UAAM,IAAI,MAAM,0FAA0F;AAAA,EAC9G;AACA,MAAIA;AACA,WAAO,EAAE,UAAUA,WAAU,YAAY;AAC7C,QAAM,YAAY,wBAAC,KAAK,QAAQ;AAC5B,UAAM,EAAE,SAAAC,SAAQ,IAAI;AACpB,QAAI,IAAI,SAAS,sBAAsB;AACnC,aAAO,EAAE,SAASA,YAAW,IAAI,aAAa;AAAA,IAClD;AACA,QAAI,OAAO,IAAI,SAAS,aAAa;AACjC,aAAO,EAAE,SAASA,YAAW,kBAAkB,IAAI,aAAa;AAAA,IACpE;AACA,QAAI,IAAI,SAAS;AACb,aAAO,EAAE,SAAS,IAAI,aAAa;AACvC,WAAO,EAAE,SAASA,YAAW,sBAAsB,IAAI,aAAa;AAAA,EACxE,GAXkB;AAYlB,SAAO,EAAE,UAAU,WAAW,YAAY;AAC9C;AAtBS;AAuBF,IAAM,UAAN,MAAc;AAAA,EApErB,OAoEqB;AAAA;AAAA;AAAA,EACjB,IAAI,cAAc;AACd,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,SAAS,OAAO;AACZ,WAAO,cAAc,MAAM,IAAI;AAAA,EACnC;AAAA,EACA,gBAAgB,OAAO,KAAK;AACxB,WAAQ,OAAO;AAAA,MACX,QAAQ,MAAM,OAAO;AAAA,MACrB,MAAM,MAAM;AAAA,MACZ,YAAY,cAAc,MAAM,IAAI;AAAA,MACpC,gBAAgB,KAAK,KAAK;AAAA,MAC1B,MAAM,MAAM;AAAA,MACZ,QAAQ,MAAM;AAAA,IAClB;AAAA,EACJ;AAAA,EACA,oBAAoB,OAAO;AACvB,WAAO;AAAA,MACH,QAAQ,IAAI,YAAY;AAAA,MACxB,KAAK;AAAA,QACD,QAAQ,MAAM,OAAO;AAAA,QACrB,MAAM,MAAM;AAAA,QACZ,YAAY,cAAc,MAAM,IAAI;AAAA,QACpC,gBAAgB,KAAK,KAAK;AAAA,QAC1B,MAAM,MAAM;AAAA,QACZ,QAAQ,MAAM;AAAA,MAClB;AAAA,IACJ;AAAA,EACJ;AAAA,EACA,WAAW,OAAO;AACd,UAAM,SAAS,KAAK,OAAO,KAAK;AAChC,QAAI,QAAQ,MAAM,GAAG;AACjB,YAAM,IAAI,MAAM,wCAAwC;AAAA,IAC5D;AACA,WAAO;AAAA,EACX;AAAA,EACA,YAAY,OAAO;AACf,UAAM,SAAS,KAAK,OAAO,KAAK;AAChC,WAAO,QAAQ,QAAQ,MAAM;AAAA,EACjC;AAAA,EACA,MAAM,MAAM,QAAQ;AAChB,UAAM,SAAS,KAAK,UAAU,MAAM,MAAM;AAC1C,QAAI,OAAO;AACP,aAAO,OAAO;AAClB,UAAM,OAAO;AAAA,EACjB;AAAA,EACA,UAAU,MAAM,QAAQ;AACpB,UAAM,MAAM;AAAA,MACR,QAAQ;AAAA,QACJ,QAAQ,CAAC;AAAA,QACT,OAAO,QAAQ,SAAS;AAAA,QACxB,oBAAoB,QAAQ;AAAA,MAChC;AAAA,MACA,MAAM,QAAQ,QAAQ,CAAC;AAAA,MACvB,gBAAgB,KAAK,KAAK;AAAA,MAC1B,QAAQ;AAAA,MACR;AAAA,MACA,YAAY,cAAc,IAAI;AAAA,IAClC;AACA,UAAM,SAAS,KAAK,WAAW,EAAE,MAAM,MAAM,IAAI,MAAM,QAAQ,IAAI,CAAC;AACpE,WAAO,aAAa,KAAK,MAAM;AAAA,EACnC;AAAA,EACA,YAAY,MAAM;AACd,UAAM,MAAM;AAAA,MACR,QAAQ;AAAA,QACJ,QAAQ,CAAC;AAAA,QACT,OAAO,CAAC,CAAC,KAAK,WAAW,EAAE;AAAA,MAC/B;AAAA,MACA,MAAM,CAAC;AAAA,MACP,gBAAgB,KAAK,KAAK;AAAA,MAC1B,QAAQ;AAAA,MACR;AAAA,MACA,YAAY,cAAc,IAAI;AAAA,IAClC;AACA,QAAI,CAAC,KAAK,WAAW,EAAE,OAAO;AAC1B,UAAI;AACA,cAAM,SAAS,KAAK,WAAW,EAAE,MAAM,MAAM,CAAC,GAAG,QAAQ,IAAI,CAAC;AAC9D,eAAO,QAAQ,MAAM,IACf;AAAA,UACE,OAAO,OAAO;AAAA,QAClB,IACE;AAAA,UACE,QAAQ,IAAI,OAAO;AAAA,QACvB;AAAA,MACR,SACO,KAAK;AACR,YAAI,KAAK,SAAS,YAAY,GAAG,SAAS,aAAa,GAAG;AACtD,eAAK,WAAW,EAAE,QAAQ;AAAA,QAC9B;AACA,YAAI,SAAS;AAAA,UACT,QAAQ,CAAC;AAAA,UACT,OAAO;AAAA,QACX;AAAA,MACJ;AAAA,IACJ;AACA,WAAO,KAAK,YAAY,EAAE,MAAM,MAAM,CAAC,GAAG,QAAQ,IAAI,CAAC,EAAE,KAAK,CAAC,WAAW,QAAQ,MAAM,IAClF;AAAA,MACE,OAAO,OAAO;AAAA,IAClB,IACE;AAAA,MACE,QAAQ,IAAI,OAAO;AAAA,IACvB,CAAC;AAAA,EACT;AAAA,EACA,MAAM,WAAW,MAAM,QAAQ;AAC3B,UAAM,SAAS,MAAM,KAAK,eAAe,MAAM,MAAM;AACrD,QAAI,OAAO;AACP,aAAO,OAAO;AAClB,UAAM,OAAO;AAAA,EACjB;AAAA,EACA,MAAM,eAAe,MAAM,QAAQ;AAC/B,UAAM,MAAM;AAAA,MACR,QAAQ;AAAA,QACJ,QAAQ,CAAC;AAAA,QACT,oBAAoB,QAAQ;AAAA,QAC5B,OAAO;AAAA,MACX;AAAA,MACA,MAAM,QAAQ,QAAQ,CAAC;AAAA,MACvB,gBAAgB,KAAK,KAAK;AAAA,MAC1B,QAAQ;AAAA,MACR;AAAA,MACA,YAAY,cAAc,IAAI;AAAA,IAClC;AACA,UAAM,mBAAmB,KAAK,OAAO,EAAE,MAAM,MAAM,IAAI,MAAM,QAAQ,IAAI,CAAC;AAC1E,UAAM,SAAS,OAAO,QAAQ,gBAAgB,IAAI,mBAAmB,QAAQ,QAAQ,gBAAgB;AACrG,WAAO,aAAa,KAAK,MAAM;AAAA,EACnC;AAAA,EACA,OAAO,OAAOA,UAAS;AACnB,UAAM,qBAAqB,wBAAC,QAAQ;AAChC,UAAI,OAAOA,aAAY,YAAY,OAAOA,aAAY,aAAa;AAC/D,eAAO,EAAE,SAAAA,SAAQ;AAAA,MACrB,WACS,OAAOA,aAAY,YAAY;AACpC,eAAOA,SAAQ,GAAG;AAAA,MACtB,OACK;AACD,eAAOA;AAAA,MACX;AAAA,IACJ,GAV2B;AAW3B,WAAO,KAAK,YAAY,CAAC,KAAK,QAAQ;AAClC,YAAM,SAAS,MAAM,GAAG;AACxB,YAAM,WAAW,6BAAM,IAAI,SAAS;AAAA,QAChC,MAAM,aAAa;AAAA,QACnB,GAAG,mBAAmB,GAAG;AAAA,MAC7B,CAAC,GAHgB;AAIjB,UAAI,OAAO,YAAY,eAAe,kBAAkB,SAAS;AAC7D,eAAO,OAAO,KAAK,CAAC,SAAS;AACzB,cAAI,CAAC,MAAM;AACP,qBAAS;AACT,mBAAO;AAAA,UACX,OACK;AACD,mBAAO;AAAA,UACX;AAAA,QACJ,CAAC;AAAA,MACL;AACA,UAAI,CAAC,QAAQ;AACT,iBAAS;AACT,eAAO;AAAA,MACX,OACK;AACD,eAAO;AAAA,MACX;AAAA,IACJ,CAAC;AAAA,EACL;AAAA,EACA,WAAW,OAAO,gBAAgB;AAC9B,WAAO,KAAK,YAAY,CAAC,KAAK,QAAQ;AAClC,UAAI,CAAC,MAAM,GAAG,GAAG;AACb,YAAI,SAAS,OAAO,mBAAmB,aAAa,eAAe,KAAK,GAAG,IAAI,cAAc;AAC7F,eAAO;AAAA,MACX,OACK;AACD,eAAO;AAAA,MACX;AAAA,IACJ,CAAC;AAAA,EACL;AAAA,EACA,YAAY,YAAY;AACpB,WAAO,IAAI,WAAW;AAAA,MAClB,QAAQ;AAAA,MACR,UAAU,sBAAsB;AAAA,MAChC,QAAQ,EAAE,MAAM,cAAc,WAAW;AAAA,IAC7C,CAAC;AAAA,EACL;AAAA,EACA,YAAY,YAAY;AACpB,WAAO,KAAK,YAAY,UAAU;AAAA,EACtC;AAAA,EACA,YAAY,KAAK;AAEb,SAAK,MAAM,KAAK;AAChB,SAAK,OAAO;AACZ,SAAK,QAAQ,KAAK,MAAM,KAAK,IAAI;AACjC,SAAK,YAAY,KAAK,UAAU,KAAK,IAAI;AACzC,SAAK,aAAa,KAAK,WAAW,KAAK,IAAI;AAC3C,SAAK,iBAAiB,KAAK,eAAe,KAAK,IAAI;AACnD,SAAK,MAAM,KAAK,IAAI,KAAK,IAAI;AAC7B,SAAK,SAAS,KAAK,OAAO,KAAK,IAAI;AACnC,SAAK,aAAa,KAAK,WAAW,KAAK,IAAI;AAC3C,SAAK,cAAc,KAAK,YAAY,KAAK,IAAI;AAC7C,SAAK,WAAW,KAAK,SAAS,KAAK,IAAI;AACvC,SAAK,WAAW,KAAK,SAAS,KAAK,IAAI;AACvC,SAAK,UAAU,KAAK,QAAQ,KAAK,IAAI;AACrC,SAAK,QAAQ,KAAK,MAAM,KAAK,IAAI;AACjC,SAAK,UAAU,KAAK,QAAQ,KAAK,IAAI;AACrC,SAAK,KAAK,KAAK,GAAG,KAAK,IAAI;AAC3B,SAAK,MAAM,KAAK,IAAI,KAAK,IAAI;AAC7B,SAAK,YAAY,KAAK,UAAU,KAAK,IAAI;AACzC,SAAK,QAAQ,KAAK,MAAM,KAAK,IAAI;AACjC,SAAK,UAAU,KAAK,QAAQ,KAAK,IAAI;AACrC,SAAK,QAAQ,KAAK,MAAM,KAAK,IAAI;AACjC,SAAK,WAAW,KAAK,SAAS,KAAK,IAAI;AACvC,SAAK,OAAO,KAAK,KAAK,KAAK,IAAI;AAC/B,SAAK,WAAW,KAAK,SAAS,KAAK,IAAI;AACvC,SAAK,aAAa,KAAK,WAAW,KAAK,IAAI;AAC3C,SAAK,aAAa,KAAK,WAAW,KAAK,IAAI;AAC3C,SAAK,WAAW,IAAI;AAAA,MAChB,SAAS;AAAA,MACT,QAAQ;AAAA,MACR,UAAU,wBAAC,SAAS,KAAK,WAAW,EAAE,IAAI,GAAhC;AAAA,IACd;AAAA,EACJ;AAAA,EACA,WAAW;AACP,WAAO,YAAY,OAAO,MAAM,KAAK,IAAI;AAAA,EAC7C;AAAA,EACA,WAAW;AACP,WAAO,YAAY,OAAO,MAAM,KAAK,IAAI;AAAA,EAC7C;AAAA,EACA,UAAU;AACN,WAAO,KAAK,SAAS,EAAE,SAAS;AAAA,EACpC;AAAA,EACA,QAAQ;AACJ,WAAO,SAAS,OAAO,IAAI;AAAA,EAC/B;AAAA,EACA,UAAU;AACN,WAAO,WAAW,OAAO,MAAM,KAAK,IAAI;AAAA,EAC5C;AAAA,EACA,GAAG,QAAQ;AACP,WAAO,SAAS,OAAO,CAAC,MAAM,MAAM,GAAG,KAAK,IAAI;AAAA,EACpD;AAAA,EACA,IAAI,UAAU;AACV,WAAO,gBAAgB,OAAO,MAAM,UAAU,KAAK,IAAI;AAAA,EAC3D;AAAA,EACA,UAAU,WAAW;AACjB,WAAO,IAAI,WAAW;AAAA,MAClB,GAAG,oBAAoB,KAAK,IAAI;AAAA,MAChC,QAAQ;AAAA,MACR,UAAU,sBAAsB;AAAA,MAChC,QAAQ,EAAE,MAAM,aAAa,UAAU;AAAA,IAC3C,CAAC;AAAA,EACL;AAAA,EACA,QAAQ,KAAK;AACT,UAAM,mBAAmB,OAAO,QAAQ,aAAa,MAAM,MAAM;AACjE,WAAO,IAAI,WAAW;AAAA,MAClB,GAAG,oBAAoB,KAAK,IAAI;AAAA,MAChC,WAAW;AAAA,MACX,cAAc;AAAA,MACd,UAAU,sBAAsB;AAAA,IACpC,CAAC;AAAA,EACL;AAAA,EACA,QAAQ;AACJ,WAAO,IAAI,WAAW;AAAA,MAClB,UAAU,sBAAsB;AAAA,MAChC,MAAM;AAAA,MACN,GAAG,oBAAoB,KAAK,IAAI;AAAA,IACpC,CAAC;AAAA,EACL;AAAA,EACA,MAAM,KAAK;AACP,UAAM,iBAAiB,OAAO,QAAQ,aAAa,MAAM,MAAM;AAC/D,WAAO,IAAI,SAAS;AAAA,MAChB,GAAG,oBAAoB,KAAK,IAAI;AAAA,MAChC,WAAW;AAAA,MACX,YAAY;AAAA,MACZ,UAAU,sBAAsB;AAAA,IACpC,CAAC;AAAA,EACL;AAAA,EACA,SAAS,aAAa;AAClB,UAAM,OAAO,KAAK;AAClB,WAAO,IAAI,KAAK;AAAA,MACZ,GAAG,KAAK;AAAA,MACR;AAAA,IACJ,CAAC;AAAA,EACL;AAAA,EACA,KAAK,QAAQ;AACT,WAAO,YAAY,OAAO,MAAM,MAAM;AAAA,EAC1C;AAAA,EACA,WAAW;AACP,WAAO,YAAY,OAAO,IAAI;AAAA,EAClC;AAAA,EACA,aAAa;AACT,WAAO,KAAK,UAAU,MAAS,EAAE;AAAA,EACrC;AAAA,EACA,aAAa;AACT,WAAO,KAAK,UAAU,IAAI,EAAE;AAAA,EAChC;AACJ;AACA,IAAM,YAAY;AAClB,IAAM,aAAa;AACnB,IAAM,YAAY;AAGlB,IAAM,YAAY;AAClB,IAAM,cAAc;AACpB,IAAM,WAAW;AACjB,IAAM,gBAAgB;AAatB,IAAM,aAAa;AAInB,IAAM,cAAc;AACpB,IAAI;AAEJ,IAAM,YAAY;AAClB,IAAM,gBAAgB;AAGtB,IAAM,YAAY;AAClB,IAAM,gBAAgB;AAEtB,IAAM,cAAc;AAEpB,IAAM,iBAAiB;AAMvB,IAAM,kBAAkB;AACxB,IAAM,YAAY,IAAI,OAAO,IAAI,eAAe,GAAG;AACnD,SAAS,gBAAgB,MAAM;AAC3B,MAAI,qBAAqB;AACzB,MAAI,KAAK,WAAW;AAChB,yBAAqB,GAAG,kBAAkB,UAAU,KAAK,SAAS;AAAA,EACtE,WACS,KAAK,aAAa,MAAM;AAC7B,yBAAqB,GAAG,kBAAkB;AAAA,EAC9C;AACA,QAAM,oBAAoB,KAAK,YAAY,MAAM;AACjD,SAAO,8BAA8B,kBAAkB,IAAI,iBAAiB;AAChF;AAVS;AAWT,SAAS,UAAU,MAAM;AACrB,SAAO,IAAI,OAAO,IAAI,gBAAgB,IAAI,CAAC,GAAG;AAClD;AAFS;AAIF,SAAS,cAAc,MAAM;AAChC,MAAI,QAAQ,GAAG,eAAe,IAAI,gBAAgB,IAAI,CAAC;AACvD,QAAM,OAAO,CAAC;AACd,OAAK,KAAK,KAAK,QAAQ,OAAO,GAAG;AACjC,MAAI,KAAK;AACL,SAAK,KAAK,sBAAsB;AACpC,UAAQ,GAAG,KAAK,IAAI,KAAK,KAAK,GAAG,CAAC;AAClC,SAAO,IAAI,OAAO,IAAI,KAAK,GAAG;AAClC;AARgB;AAShB,SAAS,UAAU,IAAI,SAAS;AAC5B,OAAK,YAAY,QAAQ,CAAC,YAAY,UAAU,KAAK,EAAE,GAAG;AACtD,WAAO;AAAA,EACX;AACA,OAAK,YAAY,QAAQ,CAAC,YAAY,UAAU,KAAK,EAAE,GAAG;AACtD,WAAO;AAAA,EACX;AACA,SAAO;AACX;AARS;AAST,SAAS,WAAW,KAAK,KAAK;AAC1B,MAAI,CAAC,SAAS,KAAK,GAAG;AAClB,WAAO;AACX,MAAI;AACA,UAAM,CAAC,MAAM,IAAI,IAAI,MAAM,GAAG;AAC9B,QAAI,CAAC;AACD,aAAO;AAEX,UAAM,SAAS,OACV,QAAQ,MAAM,GAAG,EACjB,QAAQ,MAAM,GAAG,EACjB,OAAO,OAAO,UAAW,IAAK,OAAO,SAAS,KAAM,GAAI,GAAG;AAChE,UAAM,UAAU,KAAK,MAAM,KAAK,MAAM,CAAC;AACvC,QAAI,OAAO,YAAY,YAAY,YAAY;AAC3C,aAAO;AACX,QAAI,SAAS,WAAW,SAAS,QAAQ;AACrC,aAAO;AACX,QAAI,CAAC,QAAQ;AACT,aAAO;AACX,QAAI,OAAO,QAAQ,QAAQ;AACvB,aAAO;AACX,WAAO;AAAA,EACX,QACM;AACF,WAAO;AAAA,EACX;AACJ;AA1BS;AA2BT,SAAS,YAAY,IAAI,SAAS;AAC9B,OAAK,YAAY,QAAQ,CAAC,YAAY,cAAc,KAAK,EAAE,GAAG;AAC1D,WAAO;AAAA,EACX;AACA,OAAK,YAAY,QAAQ,CAAC,YAAY,cAAc,KAAK,EAAE,GAAG;AAC1D,WAAO;AAAA,EACX;AACA,SAAO;AACX;AARS;AASF,IAAM,YAAN,MAAM,mBAAkB,QAAQ;AAAA,EA5dvC,OA4duC;AAAA;AAAA;AAAA,EACnC,OAAO,OAAO;AACV,QAAI,KAAK,KAAK,QAAQ;AAClB,YAAM,OAAO,OAAO,MAAM,IAAI;AAAA,IAClC;AACA,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,QAAQ;AACrC,YAAMC,OAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkBA,MAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAUA,KAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,SAAS,IAAI,YAAY;AAC/B,QAAI,MAAM;AACV,eAAW,SAAS,KAAK,KAAK,QAAQ;AAClC,UAAI,MAAM,SAAS,OAAO;AACtB,YAAI,MAAM,KAAK,SAAS,MAAM,OAAO;AACjC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,YACf,MAAM;AAAA,YACN,WAAW;AAAA,YACX,OAAO;AAAA,YACP,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,OAAO;AAC3B,YAAI,MAAM,KAAK,SAAS,MAAM,OAAO;AACjC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,YACf,MAAM;AAAA,YACN,WAAW;AAAA,YACX,OAAO;AAAA,YACP,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,UAAU;AAC9B,cAAM,SAAS,MAAM,KAAK,SAAS,MAAM;AACzC,cAAM,WAAW,MAAM,KAAK,SAAS,MAAM;AAC3C,YAAI,UAAU,UAAU;AACpB,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,cAAI,QAAQ;AACR,8BAAkB,KAAK;AAAA,cACnB,MAAM,aAAa;AAAA,cACnB,SAAS,MAAM;AAAA,cACf,MAAM;AAAA,cACN,WAAW;AAAA,cACX,OAAO;AAAA,cACP,SAAS,MAAM;AAAA,YACnB,CAAC;AAAA,UACL,WACS,UAAU;AACf,8BAAkB,KAAK;AAAA,cACnB,MAAM,aAAa;AAAA,cACnB,SAAS,MAAM;AAAA,cACf,MAAM;AAAA,cACN,WAAW;AAAA,cACX,OAAO;AAAA,cACP,SAAS,MAAM;AAAA,YACnB,CAAC;AAAA,UACL;AACA,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,SAAS;AAC7B,YAAI,CAAC,WAAW,KAAK,MAAM,IAAI,GAAG;AAC9B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,SAAS;AAC7B,YAAI,CAAC,YAAY;AACb,uBAAa,IAAI,OAAO,aAAa,GAAG;AAAA,QAC5C;AACA,YAAI,CAAC,WAAW,KAAK,MAAM,IAAI,GAAG;AAC9B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,QAAQ;AAC5B,YAAI,CAAC,UAAU,KAAK,MAAM,IAAI,GAAG;AAC7B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,UAAU;AAC9B,YAAI,CAAC,YAAY,KAAK,MAAM,IAAI,GAAG;AAC/B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,QAAQ;AAC5B,YAAI,CAAC,UAAU,KAAK,MAAM,IAAI,GAAG;AAC7B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,SAAS;AAC7B,YAAI,CAAC,WAAW,KAAK,MAAM,IAAI,GAAG;AAC9B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,QAAQ;AAC5B,YAAI,CAAC,UAAU,KAAK,MAAM,IAAI,GAAG;AAC7B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,OAAO;AAC3B,YAAI;AACA,cAAI,IAAI,MAAM,IAAI;AAAA,QACtB,QACM;AACF,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,SAAS;AAC7B,cAAM,MAAM,YAAY;AACxB,cAAM,aAAa,MAAM,MAAM,KAAK,MAAM,IAAI;AAC9C,YAAI,CAAC,YAAY;AACb,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,QAAQ;AAC5B,cAAM,OAAO,MAAM,KAAK,KAAK;AAAA,MACjC,WACS,MAAM,SAAS,YAAY;AAChC,YAAI,CAAC,MAAM,KAAK,SAAS,MAAM,OAAO,MAAM,QAAQ,GAAG;AACnD,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY,EAAE,UAAU,MAAM,OAAO,UAAU,MAAM,SAAS;AAAA,YAC9D,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,eAAe;AACnC,cAAM,OAAO,MAAM,KAAK,YAAY;AAAA,MACxC,WACS,MAAM,SAAS,eAAe;AACnC,cAAM,OAAO,MAAM,KAAK,YAAY;AAAA,MACxC,WACS,MAAM,SAAS,cAAc;AAClC,YAAI,CAAC,MAAM,KAAK,WAAW,MAAM,KAAK,GAAG;AACrC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY,EAAE,YAAY,MAAM,MAAM;AAAA,YACtC,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,YAAY;AAChC,YAAI,CAAC,MAAM,KAAK,SAAS,MAAM,KAAK,GAAG;AACnC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY,EAAE,UAAU,MAAM,MAAM;AAAA,YACpC,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,YAAY;AAChC,cAAM,QAAQ,cAAc,KAAK;AACjC,YAAI,CAAC,MAAM,KAAK,MAAM,IAAI,GAAG;AACzB,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY;AAAA,YACZ,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,QAAQ;AAC5B,cAAM,QAAQ;AACd,YAAI,CAAC,MAAM,KAAK,MAAM,IAAI,GAAG;AACzB,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY;AAAA,YACZ,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,QAAQ;AAC5B,cAAM,QAAQ,UAAU,KAAK;AAC7B,YAAI,CAAC,MAAM,KAAK,MAAM,IAAI,GAAG;AACzB,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY;AAAA,YACZ,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,YAAY;AAChC,YAAI,CAAC,cAAc,KAAK,MAAM,IAAI,GAAG;AACjC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,MAAM;AAC1B,YAAI,CAAC,UAAU,MAAM,MAAM,MAAM,OAAO,GAAG;AACvC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,OAAO;AAC3B,YAAI,CAAC,WAAW,MAAM,MAAM,MAAM,GAAG,GAAG;AACpC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,QAAQ;AAC5B,YAAI,CAAC,YAAY,MAAM,MAAM,MAAM,OAAO,GAAG;AACzC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,UAAU;AAC9B,YAAI,CAAC,YAAY,KAAK,MAAM,IAAI,GAAG;AAC/B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,aAAa;AACjC,YAAI,CAAC,eAAe,KAAK,MAAM,IAAI,GAAG;AAClC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,YAAY;AAAA,YACZ,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,OACK;AACD,aAAK,YAAY,KAAK;AAAA,MAC1B;AAAA,IACJ;AACA,WAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,MAAM,KAAK;AAAA,EACrD;AAAA,EACA,OAAO,OAAO,YAAYD,UAAS;AAC/B,WAAO,KAAK,WAAW,CAAC,SAAS,MAAM,KAAK,IAAI,GAAG;AAAA,MAC/C;AAAA,MACA,MAAM,aAAa;AAAA,MACnB,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA,EACA,UAAU,OAAO;AACb,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ,CAAC,GAAG,KAAK,KAAK,QAAQ,KAAK;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,MAAMA,UAAS;AACX,WAAO,KAAK,UAAU,EAAE,MAAM,SAAS,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC3E;AAAA,EACA,IAAIA,UAAS;AACT,WAAO,KAAK,UAAU,EAAE,MAAM,OAAO,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EACzE;AAAA,EACA,MAAMA,UAAS;AACX,WAAO,KAAK,UAAU,EAAE,MAAM,SAAS,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC3E;AAAA,EACA,KAAKA,UAAS;AACV,WAAO,KAAK,UAAU,EAAE,MAAM,QAAQ,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC1E;AAAA,EACA,OAAOA,UAAS;AACZ,WAAO,KAAK,UAAU,EAAE,MAAM,UAAU,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC5E;AAAA,EACA,KAAKA,UAAS;AACV,WAAO,KAAK,UAAU,EAAE,MAAM,QAAQ,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC1E;AAAA,EACA,MAAMA,UAAS;AACX,WAAO,KAAK,UAAU,EAAE,MAAM,SAAS,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC3E;AAAA,EACA,KAAKA,UAAS;AACV,WAAO,KAAK,UAAU,EAAE,MAAM,QAAQ,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC1E;AAAA,EACA,OAAOA,UAAS;AACZ,WAAO,KAAK,UAAU,EAAE,MAAM,UAAU,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC5E;AAAA,EACA,UAAUA,UAAS;AAEf,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,SAAS;AACT,WAAO,KAAK,UAAU,EAAE,MAAM,OAAO,GAAG,UAAU,SAAS,OAAO,EAAE,CAAC;AAAA,EACzE;AAAA,EACA,GAAG,SAAS;AACR,WAAO,KAAK,UAAU,EAAE,MAAM,MAAM,GAAG,UAAU,SAAS,OAAO,EAAE,CAAC;AAAA,EACxE;AAAA,EACA,KAAK,SAAS;AACV,WAAO,KAAK,UAAU,EAAE,MAAM,QAAQ,GAAG,UAAU,SAAS,OAAO,EAAE,CAAC;AAAA,EAC1E;AAAA,EACA,SAAS,SAAS;AACd,QAAI,OAAO,YAAY,UAAU;AAC7B,aAAO,KAAK,UAAU;AAAA,QAClB,MAAM;AAAA,QACN,WAAW;AAAA,QACX,QAAQ;AAAA,QACR,OAAO;AAAA,QACP,SAAS;AAAA,MACb,CAAC;AAAA,IACL;AACA,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,WAAW,OAAO,SAAS,cAAc,cAAc,OAAO,SAAS;AAAA,MACvE,QAAQ,SAAS,UAAU;AAAA,MAC3B,OAAO,SAAS,SAAS;AAAA,MACzB,GAAG,UAAU,SAAS,SAAS,OAAO;AAAA,IAC1C,CAAC;AAAA,EACL;AAAA,EACA,KAAKA,UAAS;AACV,WAAO,KAAK,UAAU,EAAE,MAAM,QAAQ,SAAAA,SAAQ,CAAC;AAAA,EACnD;AAAA,EACA,KAAK,SAAS;AACV,QAAI,OAAO,YAAY,UAAU;AAC7B,aAAO,KAAK,UAAU;AAAA,QAClB,MAAM;AAAA,QACN,WAAW;AAAA,QACX,SAAS;AAAA,MACb,CAAC;AAAA,IACL;AACA,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,WAAW,OAAO,SAAS,cAAc,cAAc,OAAO,SAAS;AAAA,MACvE,GAAG,UAAU,SAAS,SAAS,OAAO;AAAA,IAC1C,CAAC;AAAA,EACL;AAAA,EACA,SAASA,UAAS;AACd,WAAO,KAAK,UAAU,EAAE,MAAM,YAAY,GAAG,UAAU,SAASA,QAAO,EAAE,CAAC;AAAA,EAC9E;AAAA,EACA,MAAM,OAAOA,UAAS;AAClB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN;AAAA,MACA,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA,EACA,SAAS,OAAO,SAAS;AACrB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN;AAAA,MACA,UAAU,SAAS;AAAA,MACnB,GAAG,UAAU,SAAS,SAAS,OAAO;AAAA,IAC1C,CAAC;AAAA,EACL;AAAA,EACA,WAAW,OAAOA,UAAS;AACvB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN;AAAA,MACA,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA,EACA,SAAS,OAAOA,UAAS;AACrB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN;AAAA,MACA,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,WAAWA,UAAS;AACpB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO;AAAA,MACP,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,WAAWA,UAAS;AACpB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO;AAAA,MACP,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA,EACA,OAAO,KAAKA,UAAS;AACjB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO;AAAA,MACP,GAAG,UAAU,SAASA,QAAO;AAAA,IACjC,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA,EAIA,SAASA,UAAS;AACd,WAAO,KAAK,IAAI,GAAG,UAAU,SAASA,QAAO,CAAC;AAAA,EAClD;AAAA,EACA,OAAO;AACH,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ,CAAC,GAAG,KAAK,KAAK,QAAQ,EAAE,MAAM,OAAO,CAAC;AAAA,IAClD,CAAC;AAAA,EACL;AAAA,EACA,cAAc;AACV,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ,CAAC,GAAG,KAAK,KAAK,QAAQ,EAAE,MAAM,cAAc,CAAC;AAAA,IACzD,CAAC;AAAA,EACL;AAAA,EACA,cAAc;AACV,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ,CAAC,GAAG,KAAK,KAAK,QAAQ,EAAE,MAAM,cAAc,CAAC;AAAA,IACzD,CAAC;AAAA,EACL;AAAA,EACA,IAAI,aAAa;AACb,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,UAAU;AAAA,EACjE;AAAA,EACA,IAAI,SAAS;AACT,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,MAAM;AAAA,EAC7D;AAAA,EACA,IAAI,SAAS;AACT,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,MAAM;AAAA,EAC7D;AAAA,EACA,IAAI,aAAa;AACb,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,UAAU;AAAA,EACjE;AAAA,EACA,IAAI,UAAU;AACV,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,OAAO;AAAA,EAC9D;AAAA,EACA,IAAI,QAAQ;AACR,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,KAAK;AAAA,EAC5D;AAAA,EACA,IAAI,UAAU;AACV,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,OAAO;AAAA,EAC9D;AAAA,EACA,IAAI,SAAS;AACT,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,MAAM;AAAA,EAC7D;AAAA,EACA,IAAI,WAAW;AACX,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,QAAQ;AAAA,EAC/D;AAAA,EACA,IAAI,SAAS;AACT,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,MAAM;AAAA,EAC7D;AAAA,EACA,IAAI,UAAU;AACV,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,OAAO;AAAA,EAC9D;AAAA,EACA,IAAI,SAAS;AACT,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,MAAM;AAAA,EAC7D;AAAA,EACA,IAAI,OAAO;AACP,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,IAAI;AAAA,EAC3D;AAAA,EACA,IAAI,SAAS;AACT,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,MAAM;AAAA,EAC7D;AAAA,EACA,IAAI,WAAW;AACX,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,QAAQ;AAAA,EAC/D;AAAA,EACA,IAAI,cAAc;AAEd,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,WAAW;AAAA,EAClE;AAAA,EACA,IAAI,YAAY;AACZ,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO;AAAA,EACX;AAAA,EACA,IAAI,YAAY;AACZ,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO;AAAA,EACX;AACJ;AACA,UAAU,SAAS,CAAC,WAAW;AAC3B,SAAO,IAAI,UAAU;AAAA,IACjB,QAAQ,CAAC;AAAA,IACT,UAAU,sBAAsB;AAAA,IAChC,QAAQ,QAAQ,UAAU;AAAA,IAC1B,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AAEA,SAAS,mBAAmB,KAAK,MAAM;AACnC,QAAM,eAAe,IAAI,SAAS,EAAE,MAAM,GAAG,EAAE,CAAC,KAAK,IAAI;AACzD,QAAM,gBAAgB,KAAK,SAAS,EAAE,MAAM,GAAG,EAAE,CAAC,KAAK,IAAI;AAC3D,QAAM,WAAW,cAAc,eAAe,cAAc;AAC5D,QAAM,SAAS,OAAO,SAAS,IAAI,QAAQ,QAAQ,EAAE,QAAQ,KAAK,EAAE,CAAC;AACrE,QAAM,UAAU,OAAO,SAAS,KAAK,QAAQ,QAAQ,EAAE,QAAQ,KAAK,EAAE,CAAC;AACvE,SAAQ,SAAS,UAAW,MAAM;AACtC;AAPS;AAQF,IAAM,YAAN,MAAM,mBAAkB,QAAQ;AAAA,EAtiCvC,OAsiCuC;AAAA;AAAA;AAAA,EACnC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,MAAM,KAAK;AAChB,SAAK,MAAM,KAAK;AAChB,SAAK,OAAO,KAAK;AAAA,EACrB;AAAA,EACA,OAAO,OAAO;AACV,QAAI,KAAK,KAAK,QAAQ;AAClB,YAAM,OAAO,OAAO,MAAM,IAAI;AAAA,IAClC;AACA,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,QAAQ;AACrC,YAAMC,OAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkBA,MAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAUA,KAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,QAAI,MAAM;AACV,UAAM,SAAS,IAAI,YAAY;AAC/B,eAAW,SAAS,KAAK,KAAK,QAAQ;AAClC,UAAI,MAAM,SAAS,OAAO;AACtB,YAAI,CAAC,KAAK,UAAU,MAAM,IAAI,GAAG;AAC7B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,UAAU;AAAA,YACV,UAAU;AAAA,YACV,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,OAAO;AAC3B,cAAM,WAAW,MAAM,YAAY,MAAM,OAAO,MAAM,QAAQ,MAAM,QAAQ,MAAM;AAClF,YAAI,UAAU;AACV,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,YACf,MAAM;AAAA,YACN,WAAW,MAAM;AAAA,YACjB,OAAO;AAAA,YACP,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,OAAO;AAC3B,cAAM,SAAS,MAAM,YAAY,MAAM,OAAO,MAAM,QAAQ,MAAM,QAAQ,MAAM;AAChF,YAAI,QAAQ;AACR,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,YACf,MAAM;AAAA,YACN,WAAW,MAAM;AAAA,YACjB,OAAO;AAAA,YACP,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,cAAc;AAClC,YAAI,mBAAmB,MAAM,MAAM,MAAM,KAAK,MAAM,GAAG;AACnD,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY,MAAM;AAAA,YAClB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,UAAU;AAC9B,YAAI,CAAC,OAAO,SAAS,MAAM,IAAI,GAAG;AAC9B,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,OACK;AACD,aAAK,YAAY,KAAK;AAAA,MAC1B;AAAA,IACJ;AACA,WAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,MAAM,KAAK;AAAA,EACrD;AAAA,EACA,IAAI,OAAOD,UAAS;AAChB,WAAO,KAAK,SAAS,OAAO,OAAO,MAAM,UAAU,SAASA,QAAO,CAAC;AAAA,EACxE;AAAA,EACA,GAAG,OAAOA,UAAS;AACf,WAAO,KAAK,SAAS,OAAO,OAAO,OAAO,UAAU,SAASA,QAAO,CAAC;AAAA,EACzE;AAAA,EACA,IAAI,OAAOA,UAAS;AAChB,WAAO,KAAK,SAAS,OAAO,OAAO,MAAM,UAAU,SAASA,QAAO,CAAC;AAAA,EACxE;AAAA,EACA,GAAG,OAAOA,UAAS;AACf,WAAO,KAAK,SAAS,OAAO,OAAO,OAAO,UAAU,SAASA,QAAO,CAAC;AAAA,EACzE;AAAA,EACA,SAAS,MAAM,OAAO,WAAWA,UAAS;AACtC,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ;AAAA,QACJ,GAAG,KAAK,KAAK;AAAA,QACb;AAAA,UACI;AAAA,UACA;AAAA,UACA;AAAA,UACA,SAAS,UAAU,SAASA,QAAO;AAAA,QACvC;AAAA,MACJ;AAAA,IACJ,CAAC;AAAA,EACL;AAAA,EACA,UAAU,OAAO;AACb,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ,CAAC,GAAG,KAAK,KAAK,QAAQ,KAAK;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,IAAIA,UAAS;AACT,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,SAASA,UAAS;AACd,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO;AAAA,MACP,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,SAASA,UAAS;AACd,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO;AAAA,MACP,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,YAAYA,UAAS;AACjB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO;AAAA,MACP,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,YAAYA,UAAS;AACjB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO;AAAA,MACP,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,WAAW,OAAOA,UAAS;AACvB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN;AAAA,MACA,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,OAAOA,UAAS;AACZ,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,KAAKA,UAAS;AACV,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,WAAW;AAAA,MACX,OAAO,OAAO;AAAA,MACd,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC,EAAE,UAAU;AAAA,MACT,MAAM;AAAA,MACN,WAAW;AAAA,MACX,OAAO,OAAO;AAAA,MACd,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,WAAW;AACX,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO;AAAA,EACX;AAAA,EACA,IAAI,WAAW;AACX,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO;AAAA,EACX;AAAA,EACA,IAAI,QAAQ;AACR,WAAO,CAAC,CAAC,KAAK,KAAK,OAAO,KAAK,CAAC,OAAO,GAAG,SAAS,SAAU,GAAG,SAAS,gBAAgB,KAAK,UAAU,GAAG,KAAK,CAAE;AAAA,EACtH;AAAA,EACA,IAAI,WAAW;AACX,QAAI,MAAM;AACV,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,YAAY,GAAG,SAAS,SAAS,GAAG,SAAS,cAAc;AACvE,eAAO;AAAA,MACX,WACS,GAAG,SAAS,OAAO;AACxB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB,WACS,GAAG,SAAS,OAAO;AACxB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO,OAAO,SAAS,GAAG,KAAK,OAAO,SAAS,GAAG;AAAA,EACtD;AACJ;AACA,UAAU,SAAS,CAAC,WAAW;AAC3B,SAAO,IAAI,UAAU;AAAA,IACjB,QAAQ,CAAC;AAAA,IACT,UAAU,sBAAsB;AAAA,IAChC,QAAQ,QAAQ,UAAU;AAAA,IAC1B,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,YAAN,MAAM,mBAAkB,QAAQ;AAAA,EArxCvC,OAqxCuC;AAAA;AAAA;AAAA,EACnC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,MAAM,KAAK;AAChB,SAAK,MAAM,KAAK;AAAA,EACpB;AAAA,EACA,OAAO,OAAO;AACV,QAAI,KAAK,KAAK,QAAQ;AAClB,UAAI;AACA,cAAM,OAAO,OAAO,MAAM,IAAI;AAAA,MAClC,QACM;AACF,eAAO,KAAK,iBAAiB,KAAK;AAAA,MACtC;AAAA,IACJ;AACA,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,QAAQ;AACrC,aAAO,KAAK,iBAAiB,KAAK;AAAA,IACtC;AACA,QAAI,MAAM;AACV,UAAM,SAAS,IAAI,YAAY;AAC/B,eAAW,SAAS,KAAK,KAAK,QAAQ;AAClC,UAAI,MAAM,SAAS,OAAO;AACtB,cAAM,WAAW,MAAM,YAAY,MAAM,OAAO,MAAM,QAAQ,MAAM,QAAQ,MAAM;AAClF,YAAI,UAAU;AACV,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,MAAM;AAAA,YACN,SAAS,MAAM;AAAA,YACf,WAAW,MAAM;AAAA,YACjB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,OAAO;AAC3B,cAAM,SAAS,MAAM,YAAY,MAAM,OAAO,MAAM,QAAQ,MAAM,QAAQ,MAAM;AAChF,YAAI,QAAQ;AACR,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,MAAM;AAAA,YACN,SAAS,MAAM;AAAA,YACf,WAAW,MAAM;AAAA,YACjB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,cAAc;AAClC,YAAI,MAAM,OAAO,MAAM,UAAU,OAAO,CAAC,GAAG;AACxC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,YAAY,MAAM;AAAA,YAClB,SAAS,MAAM;AAAA,UACnB,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,OACK;AACD,aAAK,YAAY,KAAK;AAAA,MAC1B;AAAA,IACJ;AACA,WAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,MAAM,KAAK;AAAA,EACrD;AAAA,EACA,iBAAiB,OAAO;AACpB,UAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,sBAAkB,KAAK;AAAA,MACnB,MAAM,aAAa;AAAA,MACnB,UAAU,cAAc;AAAA,MACxB,UAAU,IAAI;AAAA,IAClB,CAAC;AACD,WAAO;AAAA,EACX;AAAA,EACA,IAAI,OAAOA,UAAS;AAChB,WAAO,KAAK,SAAS,OAAO,OAAO,MAAM,UAAU,SAASA,QAAO,CAAC;AAAA,EACxE;AAAA,EACA,GAAG,OAAOA,UAAS;AACf,WAAO,KAAK,SAAS,OAAO,OAAO,OAAO,UAAU,SAASA,QAAO,CAAC;AAAA,EACzE;AAAA,EACA,IAAI,OAAOA,UAAS;AAChB,WAAO,KAAK,SAAS,OAAO,OAAO,MAAM,UAAU,SAASA,QAAO,CAAC;AAAA,EACxE;AAAA,EACA,GAAG,OAAOA,UAAS;AACf,WAAO,KAAK,SAAS,OAAO,OAAO,OAAO,UAAU,SAASA,QAAO,CAAC;AAAA,EACzE;AAAA,EACA,SAAS,MAAM,OAAO,WAAWA,UAAS;AACtC,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ;AAAA,QACJ,GAAG,KAAK,KAAK;AAAA,QACb;AAAA,UACI;AAAA,UACA;AAAA,UACA;AAAA,UACA,SAAS,UAAU,SAASA,QAAO;AAAA,QACvC;AAAA,MACJ;AAAA,IACJ,CAAC;AAAA,EACL;AAAA,EACA,UAAU,OAAO;AACb,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,QAAQ,CAAC,GAAG,KAAK,KAAK,QAAQ,KAAK;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,SAASA,UAAS;AACd,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO,OAAO,CAAC;AAAA,MACf,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,SAASA,UAAS;AACd,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO,OAAO,CAAC;AAAA,MACf,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,YAAYA,UAAS;AACjB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO,OAAO,CAAC;AAAA,MACf,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,YAAYA,UAAS;AACjB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO,OAAO,CAAC;AAAA,MACf,WAAW;AAAA,MACX,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,WAAW,OAAOA,UAAS;AACvB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN;AAAA,MACA,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,WAAW;AACX,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO;AAAA,EACX;AAAA,EACA,IAAI,WAAW;AACX,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO;AAAA,EACX;AACJ;AACA,UAAU,SAAS,CAAC,WAAW;AAC3B,SAAO,IAAI,UAAU;AAAA,IACjB,QAAQ,CAAC;AAAA,IACT,UAAU,sBAAsB;AAAA,IAChC,QAAQ,QAAQ,UAAU;AAAA,IAC1B,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,aAAN,cAAyB,QAAQ;AAAA,EAr8CxC,OAq8CwC;AAAA;AAAA;AAAA,EACpC,OAAO,OAAO;AACV,QAAI,KAAK,KAAK,QAAQ;AAClB,YAAM,OAAO,QAAQ,MAAM,IAAI;AAAA,IACnC;AACA,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,SAAS;AACtC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AACJ;AACA,WAAW,SAAS,CAAC,WAAW;AAC5B,SAAO,IAAI,WAAW;AAAA,IAClB,UAAU,sBAAsB;AAAA,IAChC,QAAQ,QAAQ,UAAU;AAAA,IAC1B,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,UAAN,MAAM,iBAAgB,QAAQ;AAAA,EA99CrC,OA89CqC;AAAA;AAAA;AAAA,EACjC,OAAO,OAAO;AACV,QAAI,KAAK,KAAK,QAAQ;AAClB,YAAM,OAAO,IAAI,KAAK,MAAM,IAAI;AAAA,IACpC;AACA,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,MAAM;AACnC,YAAMC,OAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkBA,MAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAUA,KAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,QAAI,OAAO,MAAM,MAAM,KAAK,QAAQ,CAAC,GAAG;AACpC,YAAMA,OAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkBA,MAAK;AAAA,QACnB,MAAM,aAAa;AAAA,MACvB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,SAAS,IAAI,YAAY;AAC/B,QAAI,MAAM;AACV,eAAW,SAAS,KAAK,KAAK,QAAQ;AAClC,UAAI,MAAM,SAAS,OAAO;AACtB,YAAI,MAAM,KAAK,QAAQ,IAAI,MAAM,OAAO;AACpC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,YACf,WAAW;AAAA,YACX,OAAO;AAAA,YACP,SAAS,MAAM;AAAA,YACf,MAAM;AAAA,UACV,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,MAAM,SAAS,OAAO;AAC3B,YAAI,MAAM,KAAK,QAAQ,IAAI,MAAM,OAAO;AACpC,gBAAM,KAAK,gBAAgB,OAAO,GAAG;AACrC,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,SAAS,MAAM;AAAA,YACf,WAAW;AAAA,YACX,OAAO;AAAA,YACP,SAAS,MAAM;AAAA,YACf,MAAM;AAAA,UACV,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,OACK;AACD,aAAK,YAAY,KAAK;AAAA,MAC1B;AAAA,IACJ;AACA,WAAO;AAAA,MACH,QAAQ,OAAO;AAAA,MACf,OAAO,IAAI,KAAK,MAAM,KAAK,QAAQ,CAAC;AAAA,IACxC;AAAA,EACJ;AAAA,EACA,UAAU,OAAO;AACb,WAAO,IAAI,SAAQ;AAAA,MACf,GAAG,KAAK;AAAA,MACR,QAAQ,CAAC,GAAG,KAAK,KAAK,QAAQ,KAAK;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,SAASD,UAAS;AAClB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO,QAAQ,QAAQ;AAAA,MACvB,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,SAASA,UAAS;AAClB,WAAO,KAAK,UAAU;AAAA,MAClB,MAAM;AAAA,MACN,OAAO,QAAQ,QAAQ;AAAA,MACvB,SAAS,UAAU,SAASA,QAAO;AAAA,IACvC,CAAC;AAAA,EACL;AAAA,EACA,IAAI,UAAU;AACV,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO,OAAO,OAAO,IAAI,KAAK,GAAG,IAAI;AAAA,EACzC;AAAA,EACA,IAAI,UAAU;AACV,QAAI,MAAM;AACV,eAAW,MAAM,KAAK,KAAK,QAAQ;AAC/B,UAAI,GAAG,SAAS,OAAO;AACnB,YAAI,QAAQ,QAAQ,GAAG,QAAQ;AAC3B,gBAAM,GAAG;AAAA,MACjB;AAAA,IACJ;AACA,WAAO,OAAO,OAAO,IAAI,KAAK,GAAG,IAAI;AAAA,EACzC;AACJ;AACA,QAAQ,SAAS,CAAC,WAAW;AACzB,SAAO,IAAI,QAAQ;AAAA,IACf,QAAQ,CAAC;AAAA,IACT,QAAQ,QAAQ,UAAU;AAAA,IAC1B,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,YAAN,cAAwB,QAAQ;AAAA,EA7kDvC,OA6kDuC;AAAA;AAAA;AAAA,EACnC,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,QAAQ;AACrC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AACJ;AACA,UAAU,SAAS,CAAC,WAAW;AAC3B,SAAO,IAAI,UAAU;AAAA,IACjB,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,eAAN,cAA2B,QAAQ;AAAA,EAlmD1C,OAkmD0C;AAAA;AAAA;AAAA,EACtC,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,WAAW;AACxC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AACJ;AACA,aAAa,SAAS,CAAC,WAAW;AAC9B,SAAO,IAAI,aAAa;AAAA,IACpB,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,UAAN,cAAsB,QAAQ;AAAA,EAvnDrC,OAunDqC;AAAA;AAAA;AAAA,EACjC,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,MAAM;AACnC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AACJ;AACA,QAAQ,SAAS,CAAC,WAAW;AACzB,SAAO,IAAI,QAAQ;AAAA,IACf,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,SAAN,cAAqB,QAAQ;AAAA,EA5oDpC,OA4oDoC;AAAA;AAAA;AAAA,EAChC,cAAc;AACV,UAAM,GAAG,SAAS;AAElB,SAAK,OAAO;AAAA,EAChB;AAAA,EACA,OAAO,OAAO;AACV,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AACJ;AACA,OAAO,SAAS,CAAC,WAAW;AACxB,SAAO,IAAI,OAAO;AAAA,IACd,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,aAAN,cAAyB,QAAQ;AAAA,EA5pDxC,OA4pDwC;AAAA;AAAA;AAAA,EACpC,cAAc;AACV,UAAM,GAAG,SAAS;AAElB,SAAK,WAAW;AAAA,EACpB;AAAA,EACA,OAAO,OAAO;AACV,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AACJ;AACA,WAAW,SAAS,CAAC,WAAW;AAC5B,SAAO,IAAI,WAAW;AAAA,IAClB,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,WAAN,cAAuB,QAAQ;AAAA,EA5qDtC,OA4qDsC;AAAA;AAAA;AAAA,EAClC,OAAO,OAAO;AACV,UAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,sBAAkB,KAAK;AAAA,MACnB,MAAM,aAAa;AAAA,MACnB,UAAU,cAAc;AAAA,MACxB,UAAU,IAAI;AAAA,IAClB,CAAC;AACD,WAAO;AAAA,EACX;AACJ;AACA,SAAS,SAAS,CAAC,WAAW;AAC1B,SAAO,IAAI,SAAS;AAAA,IAChB,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,UAAN,cAAsB,QAAQ;AAAA,EA7rDrC,OA6rDqC;AAAA;AAAA;AAAA,EACjC,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,WAAW;AACxC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AACJ;AACA,QAAQ,SAAS,CAAC,WAAW;AACzB,SAAO,IAAI,QAAQ;AAAA,IACf,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,WAAN,MAAM,kBAAiB,QAAQ;AAAA,EAltDtC,OAktDsC;AAAA;AAAA;AAAA,EAClC,OAAO,OAAO;AACV,UAAM,EAAE,KAAK,OAAO,IAAI,KAAK,oBAAoB,KAAK;AACtD,UAAM,MAAM,KAAK;AACjB,QAAI,IAAI,eAAe,cAAc,OAAO;AACxC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,QAAI,IAAI,gBAAgB,MAAM;AAC1B,YAAM,SAAS,IAAI,KAAK,SAAS,IAAI,YAAY;AACjD,YAAM,WAAW,IAAI,KAAK,SAAS,IAAI,YAAY;AACnD,UAAI,UAAU,UAAU;AACpB,0BAAkB,KAAK;AAAA,UACnB,MAAM,SAAS,aAAa,UAAU,aAAa;AAAA,UACnD,SAAU,WAAW,IAAI,YAAY,QAAQ;AAAA,UAC7C,SAAU,SAAS,IAAI,YAAY,QAAQ;AAAA,UAC3C,MAAM;AAAA,UACN,WAAW;AAAA,UACX,OAAO;AAAA,UACP,SAAS,IAAI,YAAY;AAAA,QAC7B,CAAC;AACD,eAAO,MAAM;AAAA,MACjB;AAAA,IACJ;AACA,QAAI,IAAI,cAAc,MAAM;AACxB,UAAI,IAAI,KAAK,SAAS,IAAI,UAAU,OAAO;AACvC,0BAAkB,KAAK;AAAA,UACnB,MAAM,aAAa;AAAA,UACnB,SAAS,IAAI,UAAU;AAAA,UACvB,MAAM;AAAA,UACN,WAAW;AAAA,UACX,OAAO;AAAA,UACP,SAAS,IAAI,UAAU;AAAA,QAC3B,CAAC;AACD,eAAO,MAAM;AAAA,MACjB;AAAA,IACJ;AACA,QAAI,IAAI,cAAc,MAAM;AACxB,UAAI,IAAI,KAAK,SAAS,IAAI,UAAU,OAAO;AACvC,0BAAkB,KAAK;AAAA,UACnB,MAAM,aAAa;AAAA,UACnB,SAAS,IAAI,UAAU;AAAA,UACvB,MAAM;AAAA,UACN,WAAW;AAAA,UACX,OAAO;AAAA,UACP,SAAS,IAAI,UAAU;AAAA,QAC3B,CAAC;AACD,eAAO,MAAM;AAAA,MACjB;AAAA,IACJ;AACA,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,QAAQ,IAAI,CAAC,GAAG,IAAI,IAAI,EAAE,IAAI,CAAC,MAAM,MAAM;AAC9C,eAAO,IAAI,KAAK,YAAY,IAAI,mBAAmB,KAAK,MAAM,IAAI,MAAM,CAAC,CAAC;AAAA,MAC9E,CAAC,CAAC,EAAE,KAAK,CAACE,YAAW;AACjB,eAAO,YAAY,WAAW,QAAQA,OAAM;AAAA,MAChD,CAAC;AAAA,IACL;AACA,UAAM,SAAS,CAAC,GAAG,IAAI,IAAI,EAAE,IAAI,CAAC,MAAM,MAAM;AAC1C,aAAO,IAAI,KAAK,WAAW,IAAI,mBAAmB,KAAK,MAAM,IAAI,MAAM,CAAC,CAAC;AAAA,IAC7E,CAAC;AACD,WAAO,YAAY,WAAW,QAAQ,MAAM;AAAA,EAChD;AAAA,EACA,IAAI,UAAU;AACV,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,IAAI,WAAWF,UAAS;AACpB,WAAO,IAAI,UAAS;AAAA,MAChB,GAAG,KAAK;AAAA,MACR,WAAW,EAAE,OAAO,WAAW,SAAS,UAAU,SAASA,QAAO,EAAE;AAAA,IACxE,CAAC;AAAA,EACL;AAAA,EACA,IAAI,WAAWA,UAAS;AACpB,WAAO,IAAI,UAAS;AAAA,MAChB,GAAG,KAAK;AAAA,MACR,WAAW,EAAE,OAAO,WAAW,SAAS,UAAU,SAASA,QAAO,EAAE;AAAA,IACxE,CAAC;AAAA,EACL;AAAA,EACA,OAAO,KAAKA,UAAS;AACjB,WAAO,IAAI,UAAS;AAAA,MAChB,GAAG,KAAK;AAAA,MACR,aAAa,EAAE,OAAO,KAAK,SAAS,UAAU,SAASA,QAAO,EAAE;AAAA,IACpE,CAAC;AAAA,EACL;AAAA,EACA,SAASA,UAAS;AACd,WAAO,KAAK,IAAI,GAAGA,QAAO;AAAA,EAC9B;AACJ;AACA,SAAS,SAAS,CAAC,QAAQ,WAAW;AAClC,SAAO,IAAI,SAAS;AAAA,IAChB,MAAM;AAAA,IACN,WAAW;AAAA,IACX,WAAW;AAAA,IACX,aAAa;AAAA,IACb,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACA,SAAS,eAAe,QAAQ;AAC5B,MAAI,kBAAkB,WAAW;AAC7B,UAAM,WAAW,CAAC;AAClB,eAAW,OAAO,OAAO,OAAO;AAC5B,YAAM,cAAc,OAAO,MAAM,GAAG;AACpC,eAAS,GAAG,IAAI,YAAY,OAAO,eAAe,WAAW,CAAC;AAAA,IAClE;AACA,WAAO,IAAI,UAAU;AAAA,MACjB,GAAG,OAAO;AAAA,MACV,OAAO,6BAAM,UAAN;AAAA,IACX,CAAC;AAAA,EACL,WACS,kBAAkB,UAAU;AACjC,WAAO,IAAI,SAAS;AAAA,MAChB,GAAG,OAAO;AAAA,MACV,MAAM,eAAe,OAAO,OAAO;AAAA,IACvC,CAAC;AAAA,EACL,WACS,kBAAkB,aAAa;AACpC,WAAO,YAAY,OAAO,eAAe,OAAO,OAAO,CAAC,CAAC;AAAA,EAC7D,WACS,kBAAkB,aAAa;AACpC,WAAO,YAAY,OAAO,eAAe,OAAO,OAAO,CAAC,CAAC;AAAA,EAC7D,WACS,kBAAkB,UAAU;AACjC,WAAO,SAAS,OAAO,OAAO,MAAM,IAAI,CAAC,SAAS,eAAe,IAAI,CAAC,CAAC;AAAA,EAC3E,OACK;AACD,WAAO;AAAA,EACX;AACJ;AA9BS;AA+BF,IAAM,YAAN,MAAM,mBAAkB,QAAQ;AAAA,EAt1DvC,OAs1DuC;AAAA;AAAA;AAAA,EACnC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,UAAU;AAKf,SAAK,YAAY,KAAK;AAqCtB,SAAK,UAAU,KAAK;AAAA,EACxB;AAAA,EACA,aAAa;AACT,QAAI,KAAK,YAAY;AACjB,aAAO,KAAK;AAChB,UAAM,QAAQ,KAAK,KAAK,MAAM;AAC9B,UAAM,OAAO,KAAK,WAAW,KAAK;AAClC,SAAK,UAAU,EAAE,OAAO,KAAK;AAC7B,WAAO,KAAK;AAAA,EAChB;AAAA,EACA,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,QAAQ;AACrC,YAAMC,OAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkBA,MAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAUA,KAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,UAAM,EAAE,OAAO,MAAM,UAAU,IAAI,KAAK,WAAW;AACnD,UAAM,YAAY,CAAC;AACnB,QAAI,EAAE,KAAK,KAAK,oBAAoB,YAAY,KAAK,KAAK,gBAAgB,UAAU;AAChF,iBAAW,OAAO,IAAI,MAAM;AACxB,YAAI,CAAC,UAAU,SAAS,GAAG,GAAG;AAC1B,oBAAU,KAAK,GAAG;AAAA,QACtB;AAAA,MACJ;AAAA,IACJ;AACA,UAAM,QAAQ,CAAC;AACf,eAAW,OAAO,WAAW;AACzB,YAAM,eAAe,MAAM,GAAG;AAC9B,YAAM,QAAQ,IAAI,KAAK,GAAG;AAC1B,YAAM,KAAK;AAAA,QACP,KAAK,EAAE,QAAQ,SAAS,OAAO,IAAI;AAAA,QACnC,OAAO,aAAa,OAAO,IAAI,mBAAmB,KAAK,OAAO,IAAI,MAAM,GAAG,CAAC;AAAA,QAC5E,WAAW,OAAO,IAAI;AAAA,MAC1B,CAAC;AAAA,IACL;AACA,QAAI,KAAK,KAAK,oBAAoB,UAAU;AACxC,YAAM,cAAc,KAAK,KAAK;AAC9B,UAAI,gBAAgB,eAAe;AAC/B,mBAAW,OAAO,WAAW;AACzB,gBAAM,KAAK;AAAA,YACP,KAAK,EAAE,QAAQ,SAAS,OAAO,IAAI;AAAA,YACnC,OAAO,EAAE,QAAQ,SAAS,OAAO,IAAI,KAAK,GAAG,EAAE;AAAA,UACnD,CAAC;AAAA,QACL;AAAA,MACJ,WACS,gBAAgB,UAAU;AAC/B,YAAI,UAAU,SAAS,GAAG;AACtB,4BAAkB,KAAK;AAAA,YACnB,MAAM,aAAa;AAAA,YACnB,MAAM;AAAA,UACV,CAAC;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,WACS,gBAAgB,SAAS;AAAA,MAClC,OACK;AACD,cAAM,IAAI,MAAM,sDAAsD;AAAA,MAC1E;AAAA,IACJ,OACK;AAED,YAAM,WAAW,KAAK,KAAK;AAC3B,iBAAW,OAAO,WAAW;AACzB,cAAM,QAAQ,IAAI,KAAK,GAAG;AAC1B,cAAM,KAAK;AAAA,UACP,KAAK,EAAE,QAAQ,SAAS,OAAO,IAAI;AAAA,UACnC,OAAO,SAAS;AAAA,YAAO,IAAI,mBAAmB,KAAK,OAAO,IAAI,MAAM,GAAG;AAAA;AAAA,UACvE;AAAA,UACA,WAAW,OAAO,IAAI;AAAA,QAC1B,CAAC;AAAA,MACL;AAAA,IACJ;AACA,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,QAAQ,QAAQ,EAClB,KAAK,YAAY;AAClB,cAAM,YAAY,CAAC;AACnB,mBAAW,QAAQ,OAAO;AACtB,gBAAM,MAAM,MAAM,KAAK;AACvB,gBAAM,QAAQ,MAAM,KAAK;AACzB,oBAAU,KAAK;AAAA,YACX;AAAA,YACA;AAAA,YACA,WAAW,KAAK;AAAA,UACpB,CAAC;AAAA,QACL;AACA,eAAO;AAAA,MACX,CAAC,EACI,KAAK,CAAC,cAAc;AACrB,eAAO,YAAY,gBAAgB,QAAQ,SAAS;AAAA,MACxD,CAAC;AAAA,IACL,OACK;AACD,aAAO,YAAY,gBAAgB,QAAQ,KAAK;AAAA,IACpD;AAAA,EACJ;AAAA,EACA,IAAI,QAAQ;AACR,WAAO,KAAK,KAAK,MAAM;AAAA,EAC3B;AAAA,EACA,OAAOD,UAAS;AACZ,cAAU;AACV,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,aAAa;AAAA,MACb,GAAIA,aAAY,SACV;AAAA,QACE,UAAU,wBAAC,OAAO,QAAQ;AACtB,gBAAM,eAAe,KAAK,KAAK,WAAW,OAAO,GAAG,EAAE,WAAW,IAAI;AACrE,cAAI,MAAM,SAAS;AACf,mBAAO;AAAA,cACH,SAAS,UAAU,SAASA,QAAO,EAAE,WAAW;AAAA,YACpD;AACJ,iBAAO;AAAA,YACH,SAAS;AAAA,UACb;AAAA,QACJ,GATU;AAAA,MAUd,IACE,CAAC;AAAA,IACX,CAAC;AAAA,EACL;AAAA,EACA,QAAQ;AACJ,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,aAAa;AAAA,IACjB,CAAC;AAAA,EACL;AAAA,EACA,cAAc;AACV,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,aAAa;AAAA,IACjB,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAkBA,OAAO,cAAc;AACjB,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,OAAO,8BAAO;AAAA,QACV,GAAG,KAAK,KAAK,MAAM;AAAA,QACnB,GAAG;AAAA,MACP,IAHO;AAAA,IAIX,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,MAAM,SAAS;AACX,UAAM,SAAS,IAAI,WAAU;AAAA,MACzB,aAAa,QAAQ,KAAK;AAAA,MAC1B,UAAU,QAAQ,KAAK;AAAA,MACvB,OAAO,8BAAO;AAAA,QACV,GAAG,KAAK,KAAK,MAAM;AAAA,QACnB,GAAG,QAAQ,KAAK,MAAM;AAAA,MAC1B,IAHO;AAAA,MAIP,UAAU,sBAAsB;AAAA,IACpC,CAAC;AACD,WAAO;AAAA,EACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAoCA,OAAO,KAAK,QAAQ;AAChB,WAAO,KAAK,QAAQ,EAAE,CAAC,GAAG,GAAG,OAAO,CAAC;AAAA,EACzC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAsBA,SAAS,OAAO;AACZ,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,UAAU;AAAA,IACd,CAAC;AAAA,EACL;AAAA,EACA,KAAK,MAAM;AACP,UAAM,QAAQ,CAAC;AACf,eAAW,OAAO,KAAK,WAAW,IAAI,GAAG;AACrC,UAAI,KAAK,GAAG,KAAK,KAAK,MAAM,GAAG,GAAG;AAC9B,cAAM,GAAG,IAAI,KAAK,MAAM,GAAG;AAAA,MAC/B;AAAA,IACJ;AACA,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,OAAO,6BAAM,OAAN;AAAA,IACX,CAAC;AAAA,EACL;AAAA,EACA,KAAK,MAAM;AACP,UAAM,QAAQ,CAAC;AACf,eAAW,OAAO,KAAK,WAAW,KAAK,KAAK,GAAG;AAC3C,UAAI,CAAC,KAAK,GAAG,GAAG;AACZ,cAAM,GAAG,IAAI,KAAK,MAAM,GAAG;AAAA,MAC/B;AAAA,IACJ;AACA,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,OAAO,6BAAM,OAAN;AAAA,IACX,CAAC;AAAA,EACL;AAAA;AAAA;AAAA;AAAA,EAIA,cAAc;AACV,WAAO,eAAe,IAAI;AAAA,EAC9B;AAAA,EACA,QAAQ,MAAM;AACV,UAAM,WAAW,CAAC;AAClB,eAAW,OAAO,KAAK,WAAW,KAAK,KAAK,GAAG;AAC3C,YAAM,cAAc,KAAK,MAAM,GAAG;AAClC,UAAI,QAAQ,CAAC,KAAK,GAAG,GAAG;AACpB,iBAAS,GAAG,IAAI;AAAA,MACpB,OACK;AACD,iBAAS,GAAG,IAAI,YAAY,SAAS;AAAA,MACzC;AAAA,IACJ;AACA,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,OAAO,6BAAM,UAAN;AAAA,IACX,CAAC;AAAA,EACL;AAAA,EACA,SAAS,MAAM;AACX,UAAM,WAAW,CAAC;AAClB,eAAW,OAAO,KAAK,WAAW,KAAK,KAAK,GAAG;AAC3C,UAAI,QAAQ,CAAC,KAAK,GAAG,GAAG;AACpB,iBAAS,GAAG,IAAI,KAAK,MAAM,GAAG;AAAA,MAClC,OACK;AACD,cAAM,cAAc,KAAK,MAAM,GAAG;AAClC,YAAI,WAAW;AACf,eAAO,oBAAoB,aAAa;AACpC,qBAAW,SAAS,KAAK;AAAA,QAC7B;AACA,iBAAS,GAAG,IAAI;AAAA,MACpB;AAAA,IACJ;AACA,WAAO,IAAI,WAAU;AAAA,MACjB,GAAG,KAAK;AAAA,MACR,OAAO,6BAAM,UAAN;AAAA,IACX,CAAC;AAAA,EACL;AAAA,EACA,QAAQ;AACJ,WAAO,cAAc,KAAK,WAAW,KAAK,KAAK,CAAC;AAAA,EACpD;AACJ;AACA,UAAU,SAAS,CAAC,OAAO,WAAW;AAClC,SAAO,IAAI,UAAU;AAAA,IACjB,OAAO,6BAAM,OAAN;AAAA,IACP,aAAa;AAAA,IACb,UAAU,SAAS,OAAO;AAAA,IAC1B,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACA,UAAU,eAAe,CAAC,OAAO,WAAW;AACxC,SAAO,IAAI,UAAU;AAAA,IACjB,OAAO,6BAAM,OAAN;AAAA,IACP,aAAa;AAAA,IACb,UAAU,SAAS,OAAO;AAAA,IAC1B,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACA,UAAU,aAAa,CAAC,OAAO,WAAW;AACtC,SAAO,IAAI,UAAU;AAAA,IACjB;AAAA,IACA,aAAa;AAAA,IACb,UAAU,SAAS,OAAO;AAAA,IAC1B,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,WAAN,cAAuB,QAAQ;AAAA,EA1tEtC,OA0tEsC;AAAA;AAAA;AAAA,EAClC,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAC9C,UAAM,UAAU,KAAK,KAAK;AAC1B,aAAS,cAAc,SAAS;AAE5B,iBAAW,UAAU,SAAS;AAC1B,YAAI,OAAO,OAAO,WAAW,SAAS;AAClC,iBAAO,OAAO;AAAA,QAClB;AAAA,MACJ;AACA,iBAAW,UAAU,SAAS;AAC1B,YAAI,OAAO,OAAO,WAAW,SAAS;AAElC,cAAI,OAAO,OAAO,KAAK,GAAG,OAAO,IAAI,OAAO,MAAM;AAClD,iBAAO,OAAO;AAAA,QAClB;AAAA,MACJ;AAEA,YAAM,cAAc,QAAQ,IAAI,CAAC,WAAW,IAAI,SAAS,OAAO,IAAI,OAAO,MAAM,CAAC;AAClF,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB;AAAA,MACJ,CAAC;AACD,aAAO;AAAA,IACX;AArBS;AAsBT,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,QAAQ,IAAI,QAAQ,IAAI,OAAO,WAAW;AAC7C,cAAM,WAAW;AAAA,UACb,GAAG;AAAA,UACH,QAAQ;AAAA,YACJ,GAAG,IAAI;AAAA,YACP,QAAQ,CAAC;AAAA,UACb;AAAA,UACA,QAAQ;AAAA,QACZ;AACA,eAAO;AAAA,UACH,QAAQ,MAAM,OAAO,YAAY;AAAA,YAC7B,MAAM,IAAI;AAAA,YACV,MAAM,IAAI;AAAA,YACV,QAAQ;AAAA,UACZ,CAAC;AAAA,UACD,KAAK;AAAA,QACT;AAAA,MACJ,CAAC,CAAC,EAAE,KAAK,aAAa;AAAA,IAC1B,OACK;AACD,UAAI,QAAQ;AACZ,YAAM,SAAS,CAAC;AAChB,iBAAW,UAAU,SAAS;AAC1B,cAAM,WAAW;AAAA,UACb,GAAG;AAAA,UACH,QAAQ;AAAA,YACJ,GAAG,IAAI;AAAA,YACP,QAAQ,CAAC;AAAA,UACb;AAAA,UACA,QAAQ;AAAA,QACZ;AACA,cAAM,SAAS,OAAO,WAAW;AAAA,UAC7B,MAAM,IAAI;AAAA,UACV,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AACD,YAAI,OAAO,WAAW,SAAS;AAC3B,iBAAO;AAAA,QACX,WACS,OAAO,WAAW,WAAW,CAAC,OAAO;AAC1C,kBAAQ,EAAE,QAAQ,KAAK,SAAS;AAAA,QACpC;AACA,YAAI,SAAS,OAAO,OAAO,QAAQ;AAC/B,iBAAO,KAAK,SAAS,OAAO,MAAM;AAAA,QACtC;AAAA,MACJ;AACA,UAAI,OAAO;AACP,YAAI,OAAO,OAAO,KAAK,GAAG,MAAM,IAAI,OAAO,MAAM;AACjD,eAAO,MAAM;AAAA,MACjB;AACA,YAAM,cAAc,OAAO,IAAI,CAACG,YAAW,IAAI,SAASA,OAAM,CAAC;AAC/D,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB;AAAA,MACJ,CAAC;AACD,aAAO;AAAA,IACX;AAAA,EACJ;AAAA,EACA,IAAI,UAAU;AACV,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,SAAS,SAAS,CAACC,QAAO,WAAW;AACjC,SAAO,IAAI,SAAS;AAAA,IAChB,SAASA;AAAA,IACT,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AAQA,IAAM,mBAAmB,wBAAC,SAAS;AAC/B,MAAI,gBAAgB,SAAS;AACzB,WAAO,iBAAiB,KAAK,MAAM;AAAA,EACvC,WACS,gBAAgB,YAAY;AACjC,WAAO,iBAAiB,KAAK,UAAU,CAAC;AAAA,EAC5C,WACS,gBAAgB,YAAY;AACjC,WAAO,CAAC,KAAK,KAAK;AAAA,EACtB,WACS,gBAAgB,SAAS;AAC9B,WAAO,KAAK;AAAA,EAChB,WACS,gBAAgB,eAAe;AAEpC,WAAO,KAAK,aAAa,KAAK,IAAI;AAAA,EACtC,WACS,gBAAgB,YAAY;AACjC,WAAO,iBAAiB,KAAK,KAAK,SAAS;AAAA,EAC/C,WACS,gBAAgB,cAAc;AACnC,WAAO,CAAC,MAAS;AAAA,EACrB,WACS,gBAAgB,SAAS;AAC9B,WAAO,CAAC,IAAI;AAAA,EAChB,WACS,gBAAgB,aAAa;AAClC,WAAO,CAAC,QAAW,GAAG,iBAAiB,KAAK,OAAO,CAAC,CAAC;AAAA,EACzD,WACS,gBAAgB,aAAa;AAClC,WAAO,CAAC,MAAM,GAAG,iBAAiB,KAAK,OAAO,CAAC,CAAC;AAAA,EACpD,WACS,gBAAgB,YAAY;AACjC,WAAO,iBAAiB,KAAK,OAAO,CAAC;AAAA,EACzC,WACS,gBAAgB,aAAa;AAClC,WAAO,iBAAiB,KAAK,OAAO,CAAC;AAAA,EACzC,WACS,gBAAgB,UAAU;AAC/B,WAAO,iBAAiB,KAAK,KAAK,SAAS;AAAA,EAC/C,OACK;AACD,WAAO,CAAC;AAAA,EACZ;AACJ,GA5CyB;AA6ClB,IAAM,wBAAN,MAAM,+BAA8B,QAAQ;AAAA,EA92EnD,OA82EmD;AAAA;AAAA;AAAA,EAC/C,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAC9C,QAAI,IAAI,eAAe,cAAc,QAAQ;AACzC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,gBAAgB,KAAK;AAC3B,UAAM,qBAAqB,IAAI,KAAK,aAAa;AACjD,UAAM,SAAS,KAAK,WAAW,IAAI,kBAAkB;AACrD,QAAI,CAAC,QAAQ;AACT,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,SAAS,MAAM,KAAK,KAAK,WAAW,KAAK,CAAC;AAAA,QAC1C,MAAM,CAAC,aAAa;AAAA,MACxB,CAAC;AACD,aAAO;AAAA,IACX;AACA,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,OAAO,YAAY;AAAA,QACtB,MAAM,IAAI;AAAA,QACV,MAAM,IAAI;AAAA,QACV,QAAQ;AAAA,MACZ,CAAC;AAAA,IACL,OACK;AACD,aAAO,OAAO,WAAW;AAAA,QACrB,MAAM,IAAI;AAAA,QACV,MAAM,IAAI;AAAA,QACV,QAAQ;AAAA,MACZ,CAAC;AAAA,IACL;AAAA,EACJ;AAAA,EACA,IAAI,gBAAgB;AAChB,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,IAAI,UAAU;AACV,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,IAAI,aAAa;AACb,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASA,OAAO,OAAO,eAAe,SAAS,QAAQ;AAE1C,UAAM,aAAa,oBAAI,IAAI;AAE3B,eAAW,QAAQ,SAAS;AACxB,YAAM,sBAAsB,iBAAiB,KAAK,MAAM,aAAa,CAAC;AACtE,UAAI,CAAC,oBAAoB,QAAQ;AAC7B,cAAM,IAAI,MAAM,mCAAmC,aAAa,mDAAmD;AAAA,MACvH;AACA,iBAAW,SAAS,qBAAqB;AACrC,YAAI,WAAW,IAAI,KAAK,GAAG;AACvB,gBAAM,IAAI,MAAM,0BAA0B,OAAO,aAAa,CAAC,wBAAwB,OAAO,KAAK,CAAC,EAAE;AAAA,QAC1G;AACA,mBAAW,IAAI,OAAO,IAAI;AAAA,MAC9B;AAAA,IACJ;AACA,WAAO,IAAI,uBAAsB;AAAA,MAC7B,UAAU,sBAAsB;AAAA,MAChC;AAAA,MACA;AAAA,MACA;AAAA,MACA,GAAG,oBAAoB,MAAM;AAAA,IACjC,CAAC;AAAA,EACL;AACJ;AACA,SAAS,YAAY,GAAG,GAAG;AACvB,QAAM,QAAQ,cAAc,CAAC;AAC7B,QAAM,QAAQ,cAAc,CAAC;AAC7B,MAAI,MAAM,GAAG;AACT,WAAO,EAAE,OAAO,MAAM,MAAM,EAAE;AAAA,EAClC,WACS,UAAU,cAAc,UAAU,UAAU,cAAc,QAAQ;AACvE,UAAM,QAAQ,KAAK,WAAW,CAAC;AAC/B,UAAM,aAAa,KAAK,WAAW,CAAC,EAAE,OAAO,CAAC,QAAQ,MAAM,QAAQ,GAAG,MAAM,EAAE;AAC/E,UAAM,SAAS,EAAE,GAAG,GAAG,GAAG,EAAE;AAC5B,eAAW,OAAO,YAAY;AAC1B,YAAM,cAAc,YAAY,EAAE,GAAG,GAAG,EAAE,GAAG,CAAC;AAC9C,UAAI,CAAC,YAAY,OAAO;AACpB,eAAO,EAAE,OAAO,MAAM;AAAA,MAC1B;AACA,aAAO,GAAG,IAAI,YAAY;AAAA,IAC9B;AACA,WAAO,EAAE,OAAO,MAAM,MAAM,OAAO;AAAA,EACvC,WACS,UAAU,cAAc,SAAS,UAAU,cAAc,OAAO;AACrE,QAAI,EAAE,WAAW,EAAE,QAAQ;AACvB,aAAO,EAAE,OAAO,MAAM;AAAA,IAC1B;AACA,UAAM,WAAW,CAAC;AAClB,aAAS,QAAQ,GAAG,QAAQ,EAAE,QAAQ,SAAS;AAC3C,YAAM,QAAQ,EAAE,KAAK;AACrB,YAAM,QAAQ,EAAE,KAAK;AACrB,YAAM,cAAc,YAAY,OAAO,KAAK;AAC5C,UAAI,CAAC,YAAY,OAAO;AACpB,eAAO,EAAE,OAAO,MAAM;AAAA,MAC1B;AACA,eAAS,KAAK,YAAY,IAAI;AAAA,IAClC;AACA,WAAO,EAAE,OAAO,MAAM,MAAM,SAAS;AAAA,EACzC,WACS,UAAU,cAAc,QAAQ,UAAU,cAAc,QAAQ,CAAC,MAAM,CAAC,GAAG;AAChF,WAAO,EAAE,OAAO,MAAM,MAAM,EAAE;AAAA,EAClC,OACK;AACD,WAAO,EAAE,OAAO,MAAM;AAAA,EAC1B;AACJ;AAzCS;AA0CF,IAAM,kBAAN,cAA8B,QAAQ;AAAA,EAv+E7C,OAu+E6C;AAAA;AAAA;AAAA,EACzC,OAAO,OAAO;AACV,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,UAAM,eAAe,wBAAC,YAAY,gBAAgB;AAC9C,UAAI,UAAU,UAAU,KAAK,UAAU,WAAW,GAAG;AACjD,eAAO;AAAA,MACX;AACA,YAAM,SAAS,YAAY,WAAW,OAAO,YAAY,KAAK;AAC9D,UAAI,CAAC,OAAO,OAAO;AACf,0BAAkB,KAAK;AAAA,UACnB,MAAM,aAAa;AAAA,QACvB,CAAC;AACD,eAAO;AAAA,MACX;AACA,UAAI,QAAQ,UAAU,KAAK,QAAQ,WAAW,GAAG;AAC7C,eAAO,MAAM;AAAA,MACjB;AACA,aAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,OAAO,KAAK;AAAA,IACtD,GAfqB;AAgBrB,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,QAAQ,IAAI;AAAA,QACf,KAAK,KAAK,KAAK,YAAY;AAAA,UACvB,MAAM,IAAI;AAAA,UACV,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AAAA,QACD,KAAK,KAAK,MAAM,YAAY;AAAA,UACxB,MAAM,IAAI;AAAA,UACV,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AAAA,MACL,CAAC,EAAE,KAAK,CAAC,CAAC,MAAM,KAAK,MAAM,aAAa,MAAM,KAAK,CAAC;AAAA,IACxD,OACK;AACD,aAAO,aAAa,KAAK,KAAK,KAAK,WAAW;AAAA,QAC1C,MAAM,IAAI;AAAA,QACV,MAAM,IAAI;AAAA,QACV,QAAQ;AAAA,MACZ,CAAC,GAAG,KAAK,KAAK,MAAM,WAAW;AAAA,QAC3B,MAAM,IAAI;AAAA,QACV,MAAM,IAAI;AAAA,QACV,QAAQ;AAAA,MACZ,CAAC,CAAC;AAAA,IACN;AAAA,EACJ;AACJ;AACA,gBAAgB,SAAS,CAAC,MAAM,OAAO,WAAW;AAC9C,SAAO,IAAI,gBAAgB;AAAA,IACvB;AAAA,IACA;AAAA,IACA,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AAEO,IAAM,WAAN,MAAM,kBAAiB,QAAQ;AAAA,EA9hFtC,OA8hFsC;AAAA;AAAA;AAAA,EAClC,OAAO,OAAO;AACV,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,QAAI,IAAI,eAAe,cAAc,OAAO;AACxC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,QAAI,IAAI,KAAK,SAAS,KAAK,KAAK,MAAM,QAAQ;AAC1C,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,SAAS,KAAK,KAAK,MAAM;AAAA,QACzB,WAAW;AAAA,QACX,OAAO;AAAA,QACP,MAAM;AAAA,MACV,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,OAAO,KAAK,KAAK;AACvB,QAAI,CAAC,QAAQ,IAAI,KAAK,SAAS,KAAK,KAAK,MAAM,QAAQ;AACnD,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,SAAS,KAAK,KAAK,MAAM;AAAA,QACzB,WAAW;AAAA,QACX,OAAO;AAAA,QACP,MAAM;AAAA,MACV,CAAC;AACD,aAAO,MAAM;AAAA,IACjB;AACA,UAAM,QAAQ,CAAC,GAAG,IAAI,IAAI,EACrB,IAAI,CAAC,MAAM,cAAc;AAC1B,YAAM,SAAS,KAAK,KAAK,MAAM,SAAS,KAAK,KAAK,KAAK;AACvD,UAAI,CAAC;AACD,eAAO;AACX,aAAO,OAAO,OAAO,IAAI,mBAAmB,KAAK,MAAM,IAAI,MAAM,SAAS,CAAC;AAAA,IAC/E,CAAC,EACI,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;AACtB,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,QAAQ,IAAI,KAAK,EAAE,KAAK,CAAC,YAAY;AACxC,eAAO,YAAY,WAAW,QAAQ,OAAO;AAAA,MACjD,CAAC;AAAA,IACL,OACK;AACD,aAAO,YAAY,WAAW,QAAQ,KAAK;AAAA,IAC/C;AAAA,EACJ;AAAA,EACA,IAAI,QAAQ;AACR,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,KAAK,MAAM;AACP,WAAO,IAAI,UAAS;AAAA,MAChB,GAAG,KAAK;AAAA,MACR;AAAA,IACJ,CAAC;AAAA,EACL;AACJ;AACA,SAAS,SAAS,CAAC,SAAS,WAAW;AACnC,MAAI,CAAC,MAAM,QAAQ,OAAO,GAAG;AACzB,UAAM,IAAI,MAAM,uDAAuD;AAAA,EAC3E;AACA,SAAO,IAAI,SAAS;AAAA,IAChB,OAAO;AAAA,IACP,UAAU,sBAAsB;AAAA,IAChC,MAAM;AAAA,IACN,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,YAAN,MAAM,mBAAkB,QAAQ;AAAA,EApmFvC,OAomFuC;AAAA;AAAA;AAAA,EACnC,IAAI,YAAY;AACZ,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,IAAI,cAAc;AACd,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,OAAO,OAAO;AACV,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,QAAI,IAAI,eAAe,cAAc,QAAQ;AACzC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,QAAQ,CAAC;AACf,UAAM,UAAU,KAAK,KAAK;AAC1B,UAAM,YAAY,KAAK,KAAK;AAC5B,eAAW,OAAO,IAAI,MAAM;AACxB,YAAM,KAAK;AAAA,QACP,KAAK,QAAQ,OAAO,IAAI,mBAAmB,KAAK,KAAK,IAAI,MAAM,GAAG,CAAC;AAAA,QACnE,OAAO,UAAU,OAAO,IAAI,mBAAmB,KAAK,IAAI,KAAK,GAAG,GAAG,IAAI,MAAM,GAAG,CAAC;AAAA,QACjF,WAAW,OAAO,IAAI;AAAA,MAC1B,CAAC;AAAA,IACL;AACA,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,YAAY,iBAAiB,QAAQ,KAAK;AAAA,IACrD,OACK;AACD,aAAO,YAAY,gBAAgB,QAAQ,KAAK;AAAA,IACpD;AAAA,EACJ;AAAA,EACA,IAAI,UAAU;AACV,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,OAAO,OAAO,OAAO,QAAQ,OAAO;AAChC,QAAI,kBAAkB,SAAS;AAC3B,aAAO,IAAI,WAAU;AAAA,QACjB,SAAS;AAAA,QACT,WAAW;AAAA,QACX,UAAU,sBAAsB;AAAA,QAChC,GAAG,oBAAoB,KAAK;AAAA,MAChC,CAAC;AAAA,IACL;AACA,WAAO,IAAI,WAAU;AAAA,MACjB,SAAS,UAAU,OAAO;AAAA,MAC1B,WAAW;AAAA,MACX,UAAU,sBAAsB;AAAA,MAChC,GAAG,oBAAoB,MAAM;AAAA,IACjC,CAAC;AAAA,EACL;AACJ;AACO,IAAM,SAAN,cAAqB,QAAQ;AAAA,EA1pFpC,OA0pFoC;AAAA;AAAA;AAAA,EAChC,IAAI,YAAY;AACZ,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,IAAI,cAAc;AACd,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,OAAO,OAAO;AACV,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,QAAI,IAAI,eAAe,cAAc,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,UAAU,KAAK,KAAK;AAC1B,UAAM,YAAY,KAAK,KAAK;AAC5B,UAAM,QAAQ,CAAC,GAAG,IAAI,KAAK,QAAQ,CAAC,EAAE,IAAI,CAAC,CAAC,KAAK,KAAK,GAAG,UAAU;AAC/D,aAAO;AAAA,QACH,KAAK,QAAQ,OAAO,IAAI,mBAAmB,KAAK,KAAK,IAAI,MAAM,CAAC,OAAO,KAAK,CAAC,CAAC;AAAA,QAC9E,OAAO,UAAU,OAAO,IAAI,mBAAmB,KAAK,OAAO,IAAI,MAAM,CAAC,OAAO,OAAO,CAAC,CAAC;AAAA,MAC1F;AAAA,IACJ,CAAC;AACD,QAAI,IAAI,OAAO,OAAO;AAClB,YAAM,WAAW,oBAAI,IAAI;AACzB,aAAO,QAAQ,QAAQ,EAAE,KAAK,YAAY;AACtC,mBAAW,QAAQ,OAAO;AACtB,gBAAM,MAAM,MAAM,KAAK;AACvB,gBAAM,QAAQ,MAAM,KAAK;AACzB,cAAI,IAAI,WAAW,aAAa,MAAM,WAAW,WAAW;AACxD,mBAAO;AAAA,UACX;AACA,cAAI,IAAI,WAAW,WAAW,MAAM,WAAW,SAAS;AACpD,mBAAO,MAAM;AAAA,UACjB;AACA,mBAAS,IAAI,IAAI,OAAO,MAAM,KAAK;AAAA,QACvC;AACA,eAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,SAAS;AAAA,MACnD,CAAC;AAAA,IACL,OACK;AACD,YAAM,WAAW,oBAAI,IAAI;AACzB,iBAAW,QAAQ,OAAO;AACtB,cAAM,MAAM,KAAK;AACjB,cAAM,QAAQ,KAAK;AACnB,YAAI,IAAI,WAAW,aAAa,MAAM,WAAW,WAAW;AACxD,iBAAO;AAAA,QACX;AACA,YAAI,IAAI,WAAW,WAAW,MAAM,WAAW,SAAS;AACpD,iBAAO,MAAM;AAAA,QACjB;AACA,iBAAS,IAAI,IAAI,OAAO,MAAM,KAAK;AAAA,MACvC;AACA,aAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,SAAS;AAAA,IACnD;AAAA,EACJ;AACJ;AACA,OAAO,SAAS,CAAC,SAAS,WAAW,WAAW;AAC5C,SAAO,IAAI,OAAO;AAAA,IACd;AAAA,IACA;AAAA,IACA,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,SAAN,MAAM,gBAAe,QAAQ;AAAA,EA7tFpC,OA6tFoC;AAAA;AAAA;AAAA,EAChC,OAAO,OAAO;AACV,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,QAAI,IAAI,eAAe,cAAc,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,MAAM,KAAK;AACjB,QAAI,IAAI,YAAY,MAAM;AACtB,UAAI,IAAI,KAAK,OAAO,IAAI,QAAQ,OAAO;AACnC,0BAAkB,KAAK;AAAA,UACnB,MAAM,aAAa;AAAA,UACnB,SAAS,IAAI,QAAQ;AAAA,UACrB,MAAM;AAAA,UACN,WAAW;AAAA,UACX,OAAO;AAAA,UACP,SAAS,IAAI,QAAQ;AAAA,QACzB,CAAC;AACD,eAAO,MAAM;AAAA,MACjB;AAAA,IACJ;AACA,QAAI,IAAI,YAAY,MAAM;AACtB,UAAI,IAAI,KAAK,OAAO,IAAI,QAAQ,OAAO;AACnC,0BAAkB,KAAK;AAAA,UACnB,MAAM,aAAa;AAAA,UACnB,SAAS,IAAI,QAAQ;AAAA,UACrB,MAAM;AAAA,UACN,WAAW;AAAA,UACX,OAAO;AAAA,UACP,SAAS,IAAI,QAAQ;AAAA,QACzB,CAAC;AACD,eAAO,MAAM;AAAA,MACjB;AAAA,IACJ;AACA,UAAM,YAAY,KAAK,KAAK;AAC5B,aAAS,YAAYC,WAAU;AAC3B,YAAM,YAAY,oBAAI,IAAI;AAC1B,iBAAW,WAAWA,WAAU;AAC5B,YAAI,QAAQ,WAAW;AACnB,iBAAO;AACX,YAAI,QAAQ,WAAW;AACnB,iBAAO,MAAM;AACjB,kBAAU,IAAI,QAAQ,KAAK;AAAA,MAC/B;AACA,aAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,UAAU;AAAA,IACpD;AAVS;AAWT,UAAM,WAAW,CAAC,GAAG,IAAI,KAAK,OAAO,CAAC,EAAE,IAAI,CAAC,MAAM,MAAM,UAAU,OAAO,IAAI,mBAAmB,KAAK,MAAM,IAAI,MAAM,CAAC,CAAC,CAAC;AACzH,QAAI,IAAI,OAAO,OAAO;AAClB,aAAO,QAAQ,IAAI,QAAQ,EAAE,KAAK,CAACA,cAAa,YAAYA,SAAQ,CAAC;AAAA,IACzE,OACK;AACD,aAAO,YAAY,QAAQ;AAAA,IAC/B;AAAA,EACJ;AAAA,EACA,IAAI,SAASL,UAAS;AAClB,WAAO,IAAI,QAAO;AAAA,MACd,GAAG,KAAK;AAAA,MACR,SAAS,EAAE,OAAO,SAAS,SAAS,UAAU,SAASA,QAAO,EAAE;AAAA,IACpE,CAAC;AAAA,EACL;AAAA,EACA,IAAI,SAASA,UAAS;AAClB,WAAO,IAAI,QAAO;AAAA,MACd,GAAG,KAAK;AAAA,MACR,SAAS,EAAE,OAAO,SAAS,SAAS,UAAU,SAASA,QAAO,EAAE;AAAA,IACpE,CAAC;AAAA,EACL;AAAA,EACA,KAAK,MAAMA,UAAS;AAChB,WAAO,KAAK,IAAI,MAAMA,QAAO,EAAE,IAAI,MAAMA,QAAO;AAAA,EACpD;AAAA,EACA,SAASA,UAAS;AACd,WAAO,KAAK,IAAI,GAAGA,QAAO;AAAA,EAC9B;AACJ;AACA,OAAO,SAAS,CAAC,WAAW,WAAW;AACnC,SAAO,IAAI,OAAO;AAAA,IACd;AAAA,IACA,SAAS;AAAA,IACT,SAAS;AAAA,IACT,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,cAAN,MAAM,qBAAoB,QAAQ;AAAA,EAnzFzC,OAmzFyC;AAAA;AAAA;AAAA,EACrC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,WAAW,KAAK;AAAA,EACzB;AAAA,EACA,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAC9C,QAAI,IAAI,eAAe,cAAc,UAAU;AAC3C,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,aAAS,cAAc,MAAM,OAAO;AAChC,aAAO,UAAU;AAAA,QACb,MAAM;AAAA,QACN,MAAM,IAAI;AAAA,QACV,WAAW,CAAC,IAAI,OAAO,oBAAoB,IAAI,gBAAgB,YAAY,GAAG,UAAe,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;AAAA,QAChH,WAAW;AAAA,UACP,MAAM,aAAa;AAAA,UACnB,gBAAgB;AAAA,QACpB;AAAA,MACJ,CAAC;AAAA,IACL;AAVS;AAWT,aAAS,iBAAiB,SAAS,OAAO;AACtC,aAAO,UAAU;AAAA,QACb,MAAM;AAAA,QACN,MAAM,IAAI;AAAA,QACV,WAAW,CAAC,IAAI,OAAO,oBAAoB,IAAI,gBAAgB,YAAY,GAAG,UAAe,EAAE,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC;AAAA,QAChH,WAAW;AAAA,UACP,MAAM,aAAa;AAAA,UACnB,iBAAiB;AAAA,QACrB;AAAA,MACJ,CAAC;AAAA,IACL;AAVS;AAWT,UAAM,SAAS,EAAE,UAAU,IAAI,OAAO,mBAAmB;AACzD,UAAM,KAAK,IAAI;AACf,QAAI,KAAK,KAAK,mBAAmB,YAAY;AAIzC,YAAM,KAAK;AACX,aAAO,GAAG,kBAAmB,MAAM;AAC/B,cAAM,QAAQ,IAAI,SAAS,CAAC,CAAC;AAC7B,cAAM,aAAa,MAAM,GAAG,KAAK,KAAK,WAAW,MAAM,MAAM,EAAE,MAAM,CAAC,MAAM;AACxE,gBAAM,SAAS,cAAc,MAAM,CAAC,CAAC;AACrC,gBAAM;AAAA,QACV,CAAC;AACD,cAAM,SAAS,MAAM,QAAQ,MAAM,IAAI,MAAM,UAAU;AACvD,cAAM,gBAAgB,MAAM,GAAG,KAAK,QAAQ,KAAK,KAC5C,WAAW,QAAQ,MAAM,EACzB,MAAM,CAAC,MAAM;AACd,gBAAM,SAAS,iBAAiB,QAAQ,CAAC,CAAC;AAC1C,gBAAM;AAAA,QACV,CAAC;AACD,eAAO;AAAA,MACX,CAAC;AAAA,IACL,OACK;AAID,YAAM,KAAK;AACX,aAAO,GAAG,YAAa,MAAM;AACzB,cAAM,aAAa,GAAG,KAAK,KAAK,UAAU,MAAM,MAAM;AACtD,YAAI,CAAC,WAAW,SAAS;AACrB,gBAAM,IAAI,SAAS,CAAC,cAAc,MAAM,WAAW,KAAK,CAAC,CAAC;AAAA,QAC9D;AACA,cAAM,SAAS,QAAQ,MAAM,IAAI,MAAM,WAAW,IAAI;AACtD,cAAM,gBAAgB,GAAG,KAAK,QAAQ,UAAU,QAAQ,MAAM;AAC9D,YAAI,CAAC,cAAc,SAAS;AACxB,gBAAM,IAAI,SAAS,CAAC,iBAAiB,QAAQ,cAAc,KAAK,CAAC,CAAC;AAAA,QACtE;AACA,eAAO,cAAc;AAAA,MACzB,CAAC;AAAA,IACL;AAAA,EACJ;AAAA,EACA,aAAa;AACT,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,aAAa;AACT,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,QAAQ,OAAO;AACX,WAAO,IAAI,aAAY;AAAA,MACnB,GAAG,KAAK;AAAA,MACR,MAAM,SAAS,OAAO,KAAK,EAAE,KAAK,WAAW,OAAO,CAAC;AAAA,IACzD,CAAC;AAAA,EACL;AAAA,EACA,QAAQ,YAAY;AAChB,WAAO,IAAI,aAAY;AAAA,MACnB,GAAG,KAAK;AAAA,MACR,SAAS;AAAA,IACb,CAAC;AAAA,EACL;AAAA,EACA,UAAU,MAAM;AACZ,UAAM,gBAAgB,KAAK,MAAM,IAAI;AACrC,WAAO;AAAA,EACX;AAAA,EACA,gBAAgB,MAAM;AAClB,UAAM,gBAAgB,KAAK,MAAM,IAAI;AACrC,WAAO;AAAA,EACX;AAAA,EACA,OAAO,OAAO,MAAM,SAAS,QAAQ;AACjC,WAAO,IAAI,aAAY;AAAA,MACnB,MAAO,OAAO,OAAO,SAAS,OAAO,CAAC,CAAC,EAAE,KAAK,WAAW,OAAO,CAAC;AAAA,MACjE,SAAS,WAAW,WAAW,OAAO;AAAA,MACtC,UAAU,sBAAsB;AAAA,MAChC,GAAG,oBAAoB,MAAM;AAAA,IACjC,CAAC;AAAA,EACL;AACJ;AACO,IAAM,UAAN,cAAsB,QAAQ;AAAA,EAr6FrC,OAq6FqC;AAAA;AAAA;AAAA,EACjC,IAAI,SAAS;AACT,WAAO,KAAK,KAAK,OAAO;AAAA,EAC5B;AAAA,EACA,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAC9C,UAAM,aAAa,KAAK,KAAK,OAAO;AACpC,WAAO,WAAW,OAAO,EAAE,MAAM,IAAI,MAAM,MAAM,IAAI,MAAM,QAAQ,IAAI,CAAC;AAAA,EAC5E;AACJ;AACA,QAAQ,SAAS,CAAC,QAAQ,WAAW;AACjC,SAAO,IAAI,QAAQ;AAAA,IACf;AAAA,IACA,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,aAAN,cAAyB,QAAQ;AAAA,EAt7FxC,OAs7FwC;AAAA;AAAA;AAAA,EACpC,OAAO,OAAO;AACV,QAAI,MAAM,SAAS,KAAK,KAAK,OAAO;AAChC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,UAAU,IAAI;AAAA,QACd,MAAM,aAAa;AAAA,QACnB,UAAU,KAAK,KAAK;AAAA,MACxB,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,EAAE,QAAQ,SAAS,OAAO,MAAM,KAAK;AAAA,EAChD;AAAA,EACA,IAAI,QAAQ;AACR,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,WAAW,SAAS,CAAC,OAAO,WAAW;AACnC,SAAO,IAAI,WAAW;AAAA,IAClB;AAAA,IACA,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACA,SAAS,cAAc,QAAQ,QAAQ;AACnC,SAAO,IAAI,QAAQ;AAAA,IACf;AAAA,IACA,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AANS;AAOF,IAAM,UAAN,MAAM,iBAAgB,QAAQ;AAAA,EAr9FrC,OAq9FqC;AAAA;AAAA;AAAA,EACjC,OAAO,OAAO;AACV,QAAI,OAAO,MAAM,SAAS,UAAU;AAChC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,YAAM,iBAAiB,KAAK,KAAK;AACjC,wBAAkB,KAAK;AAAA,QACnB,UAAU,KAAK,WAAW,cAAc;AAAA,QACxC,UAAU,IAAI;AAAA,QACd,MAAM,aAAa;AAAA,MACvB,CAAC;AACD,aAAO;AAAA,IACX;AACA,QAAI,CAAC,KAAK,QAAQ;AACd,WAAK,SAAS,IAAI,IAAI,KAAK,KAAK,MAAM;AAAA,IAC1C;AACA,QAAI,CAAC,KAAK,OAAO,IAAI,MAAM,IAAI,GAAG;AAC9B,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,YAAM,iBAAiB,KAAK,KAAK;AACjC,wBAAkB,KAAK;AAAA,QACnB,UAAU,IAAI;AAAA,QACd,MAAM,aAAa;AAAA,QACnB,SAAS;AAAA,MACb,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AAAA,EACA,IAAI,UAAU;AACV,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,IAAI,OAAO;AACP,UAAM,aAAa,CAAC;AACpB,eAAW,OAAO,KAAK,KAAK,QAAQ;AAChC,iBAAW,GAAG,IAAI;AAAA,IACtB;AACA,WAAO;AAAA,EACX;AAAA,EACA,IAAI,SAAS;AACT,UAAM,aAAa,CAAC;AACpB,eAAW,OAAO,KAAK,KAAK,QAAQ;AAChC,iBAAW,GAAG,IAAI;AAAA,IACtB;AACA,WAAO;AAAA,EACX;AAAA,EACA,IAAI,OAAO;AACP,UAAM,aAAa,CAAC;AACpB,eAAW,OAAO,KAAK,KAAK,QAAQ;AAChC,iBAAW,GAAG,IAAI;AAAA,IACtB;AACA,WAAO;AAAA,EACX;AAAA,EACA,QAAQ,QAAQ,SAAS,KAAK,MAAM;AAChC,WAAO,SAAQ,OAAO,QAAQ;AAAA,MAC1B,GAAG,KAAK;AAAA,MACR,GAAG;AAAA,IACP,CAAC;AAAA,EACL;AAAA,EACA,QAAQ,QAAQ,SAAS,KAAK,MAAM;AAChC,WAAO,SAAQ,OAAO,KAAK,QAAQ,OAAO,CAAC,QAAQ,CAAC,OAAO,SAAS,GAAG,CAAC,GAAG;AAAA,MACvE,GAAG,KAAK;AAAA,MACR,GAAG;AAAA,IACP,CAAC;AAAA,EACL;AACJ;AACA,QAAQ,SAAS;AACV,IAAM,gBAAN,cAA4B,QAAQ;AAAA,EAthG3C,OAshG2C;AAAA;AAAA;AAAA,EACvC,OAAO,OAAO;AACV,UAAM,mBAAmB,KAAK,mBAAmB,KAAK,KAAK,MAAM;AACjE,UAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,QAAI,IAAI,eAAe,cAAc,UAAU,IAAI,eAAe,cAAc,QAAQ;AACpF,YAAM,iBAAiB,KAAK,aAAa,gBAAgB;AACzD,wBAAkB,KAAK;AAAA,QACnB,UAAU,KAAK,WAAW,cAAc;AAAA,QACxC,UAAU,IAAI;AAAA,QACd,MAAM,aAAa;AAAA,MACvB,CAAC;AACD,aAAO;AAAA,IACX;AACA,QAAI,CAAC,KAAK,QAAQ;AACd,WAAK,SAAS,IAAI,IAAI,KAAK,mBAAmB,KAAK,KAAK,MAAM,CAAC;AAAA,IACnE;AACA,QAAI,CAAC,KAAK,OAAO,IAAI,MAAM,IAAI,GAAG;AAC9B,YAAM,iBAAiB,KAAK,aAAa,gBAAgB;AACzD,wBAAkB,KAAK;AAAA,QACnB,UAAU,IAAI;AAAA,QACd,MAAM,aAAa;AAAA,QACnB,SAAS;AAAA,MACb,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,GAAG,MAAM,IAAI;AAAA,EACxB;AAAA,EACA,IAAI,OAAO;AACP,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,cAAc,SAAS,CAAC,QAAQ,WAAW;AACvC,SAAO,IAAI,cAAc;AAAA,IACrB;AAAA,IACA,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,aAAN,cAAyB,QAAQ;AAAA,EA5jGxC,OA4jGwC;AAAA;AAAA;AAAA,EACpC,SAAS;AACL,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAC9C,QAAI,IAAI,eAAe,cAAc,WAAW,IAAI,OAAO,UAAU,OAAO;AACxE,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,UAAM,cAAc,IAAI,eAAe,cAAc,UAAU,IAAI,OAAO,QAAQ,QAAQ,IAAI,IAAI;AAClG,WAAO,GAAG,YAAY,KAAK,CAAC,SAAS;AACjC,aAAO,KAAK,KAAK,KAAK,WAAW,MAAM;AAAA,QACnC,MAAM,IAAI;AAAA,QACV,UAAU,IAAI,OAAO;AAAA,MACzB,CAAC;AAAA,IACL,CAAC,CAAC;AAAA,EACN;AACJ;AACA,WAAW,SAAS,CAAC,QAAQ,WAAW;AACpC,SAAO,IAAI,WAAW;AAAA,IAClB,MAAM;AAAA,IACN,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,aAAN,cAAyB,QAAQ;AAAA,EA1lGxC,OA0lGwC;AAAA;AAAA;AAAA,EACpC,YAAY;AACR,WAAO,KAAK,KAAK;AAAA,EACrB;AAAA,EACA,aAAa;AACT,WAAO,KAAK,KAAK,OAAO,KAAK,aAAa,sBAAsB,aAC1D,KAAK,KAAK,OAAO,WAAW,IAC5B,KAAK,KAAK;AAAA,EACpB;AAAA,EACA,OAAO,OAAO;AACV,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,UAAM,SAAS,KAAK,KAAK,UAAU;AACnC,UAAM,WAAW;AAAA,MACb,UAAU,wBAAC,QAAQ;AACf,0BAAkB,KAAK,GAAG;AAC1B,YAAI,IAAI,OAAO;AACX,iBAAO,MAAM;AAAA,QACjB,OACK;AACD,iBAAO,MAAM;AAAA,QACjB;AAAA,MACJ,GARU;AAAA,MASV,IAAI,OAAO;AACP,eAAO,IAAI;AAAA,MACf;AAAA,IACJ;AACA,aAAS,WAAW,SAAS,SAAS,KAAK,QAAQ;AACnD,QAAI,OAAO,SAAS,cAAc;AAC9B,YAAM,YAAY,OAAO,UAAU,IAAI,MAAM,QAAQ;AACrD,UAAI,IAAI,OAAO,OAAO;AAClB,eAAO,QAAQ,QAAQ,SAAS,EAAE,KAAK,OAAOM,eAAc;AACxD,cAAI,OAAO,UAAU;AACjB,mBAAO;AACX,gBAAM,SAAS,MAAM,KAAK,KAAK,OAAO,YAAY;AAAA,YAC9C,MAAMA;AAAA,YACN,MAAM,IAAI;AAAA,YACV,QAAQ;AAAA,UACZ,CAAC;AACD,cAAI,OAAO,WAAW;AAClB,mBAAO;AACX,cAAI,OAAO,WAAW;AAClB,mBAAO,MAAM,OAAO,KAAK;AAC7B,cAAI,OAAO,UAAU;AACjB,mBAAO,MAAM,OAAO,KAAK;AAC7B,iBAAO;AAAA,QACX,CAAC;AAAA,MACL,OACK;AACD,YAAI,OAAO,UAAU;AACjB,iBAAO;AACX,cAAM,SAAS,KAAK,KAAK,OAAO,WAAW;AAAA,UACvC,MAAM;AAAA,UACN,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AACD,YAAI,OAAO,WAAW;AAClB,iBAAO;AACX,YAAI,OAAO,WAAW;AAClB,iBAAO,MAAM,OAAO,KAAK;AAC7B,YAAI,OAAO,UAAU;AACjB,iBAAO,MAAM,OAAO,KAAK;AAC7B,eAAO;AAAA,MACX;AAAA,IACJ;AACA,QAAI,OAAO,SAAS,cAAc;AAC9B,YAAM,oBAAoB,wBAAC,QAAQ;AAC/B,cAAM,SAAS,OAAO,WAAW,KAAK,QAAQ;AAC9C,YAAI,IAAI,OAAO,OAAO;AAClB,iBAAO,QAAQ,QAAQ,MAAM;AAAA,QACjC;AACA,YAAI,kBAAkB,SAAS;AAC3B,gBAAM,IAAI,MAAM,2FAA2F;AAAA,QAC/G;AACA,eAAO;AAAA,MACX,GAT0B;AAU1B,UAAI,IAAI,OAAO,UAAU,OAAO;AAC5B,cAAM,QAAQ,KAAK,KAAK,OAAO,WAAW;AAAA,UACtC,MAAM,IAAI;AAAA,UACV,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AACD,YAAI,MAAM,WAAW;AACjB,iBAAO;AACX,YAAI,MAAM,WAAW;AACjB,iBAAO,MAAM;AAEjB,0BAAkB,MAAM,KAAK;AAC7B,eAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,MAAM,MAAM;AAAA,MACtD,OACK;AACD,eAAO,KAAK,KAAK,OAAO,YAAY,EAAE,MAAM,IAAI,MAAM,MAAM,IAAI,MAAM,QAAQ,IAAI,CAAC,EAAE,KAAK,CAAC,UAAU;AACjG,cAAI,MAAM,WAAW;AACjB,mBAAO;AACX,cAAI,MAAM,WAAW;AACjB,mBAAO,MAAM;AACjB,iBAAO,kBAAkB,MAAM,KAAK,EAAE,KAAK,MAAM;AAC7C,mBAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,MAAM,MAAM;AAAA,UACtD,CAAC;AAAA,QACL,CAAC;AAAA,MACL;AAAA,IACJ;AACA,QAAI,OAAO,SAAS,aAAa;AAC7B,UAAI,IAAI,OAAO,UAAU,OAAO;AAC5B,cAAM,OAAO,KAAK,KAAK,OAAO,WAAW;AAAA,UACrC,MAAM,IAAI;AAAA,UACV,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AACD,YAAI,CAAC,QAAQ,IAAI;AACb,iBAAO;AACX,cAAM,SAAS,OAAO,UAAU,KAAK,OAAO,QAAQ;AACpD,YAAI,kBAAkB,SAAS;AAC3B,gBAAM,IAAI,MAAM,iGAAiG;AAAA,QACrH;AACA,eAAO,EAAE,QAAQ,OAAO,OAAO,OAAO,OAAO;AAAA,MACjD,OACK;AACD,eAAO,KAAK,KAAK,OAAO,YAAY,EAAE,MAAM,IAAI,MAAM,MAAM,IAAI,MAAM,QAAQ,IAAI,CAAC,EAAE,KAAK,CAAC,SAAS;AAChG,cAAI,CAAC,QAAQ,IAAI;AACb,mBAAO;AACX,iBAAO,QAAQ,QAAQ,OAAO,UAAU,KAAK,OAAO,QAAQ,CAAC,EAAE,KAAK,CAAC,YAAY;AAAA,YAC7E,QAAQ,OAAO;AAAA,YACf,OAAO;AAAA,UACX,EAAE;AAAA,QACN,CAAC;AAAA,MACL;AAAA,IACJ;AACA,SAAK,YAAY,MAAM;AAAA,EAC3B;AACJ;AACA,WAAW,SAAS,CAAC,QAAQ,QAAQ,WAAW;AAC5C,SAAO,IAAI,WAAW;AAAA,IAClB;AAAA,IACA,UAAU,sBAAsB;AAAA,IAChC;AAAA,IACA,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACA,WAAW,uBAAuB,CAAC,YAAY,QAAQ,WAAW;AAC9D,SAAO,IAAI,WAAW;AAAA,IAClB;AAAA,IACA,QAAQ,EAAE,MAAM,cAAc,WAAW,WAAW;AAAA,IACpD,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AAEO,IAAM,cAAN,cAA0B,QAAQ;AAAA,EA7uGzC,OA6uGyC;AAAA;AAAA;AAAA,EACrC,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,WAAW;AACxC,aAAO,GAAG,MAAS;AAAA,IACvB;AACA,WAAO,KAAK,KAAK,UAAU,OAAO,KAAK;AAAA,EAC3C;AAAA,EACA,SAAS;AACL,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,YAAY,SAAS,CAAC,MAAM,WAAW;AACnC,SAAO,IAAI,YAAY;AAAA,IACnB,WAAW;AAAA,IACX,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,cAAN,cAA0B,QAAQ;AAAA,EAhwGzC,OAgwGyC;AAAA;AAAA;AAAA,EACrC,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,MAAM;AACnC,aAAO,GAAG,IAAI;AAAA,IAClB;AACA,WAAO,KAAK,KAAK,UAAU,OAAO,KAAK;AAAA,EAC3C;AAAA,EACA,SAAS;AACL,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,YAAY,SAAS,CAAC,MAAM,WAAW;AACnC,SAAO,IAAI,YAAY;AAAA,IACnB,WAAW;AAAA,IACX,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,aAAN,cAAyB,QAAQ;AAAA,EAnxGxC,OAmxGwC;AAAA;AAAA;AAAA,EACpC,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAC9C,QAAI,OAAO,IAAI;AACf,QAAI,IAAI,eAAe,cAAc,WAAW;AAC5C,aAAO,KAAK,KAAK,aAAa;AAAA,IAClC;AACA,WAAO,KAAK,KAAK,UAAU,OAAO;AAAA,MAC9B;AAAA,MACA,MAAM,IAAI;AAAA,MACV,QAAQ;AAAA,IACZ,CAAC;AAAA,EACL;AAAA,EACA,gBAAgB;AACZ,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,WAAW,SAAS,CAAC,MAAM,WAAW;AAClC,SAAO,IAAI,WAAW;AAAA,IAClB,WAAW;AAAA,IACX,UAAU,sBAAsB;AAAA,IAChC,cAAc,OAAO,OAAO,YAAY,aAAa,OAAO,UAAU,MAAM,OAAO;AAAA,IACnF,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,WAAN,cAAuB,QAAQ;AAAA,EA5yGtC,OA4yGsC;AAAA;AAAA;AAAA,EAClC,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAE9C,UAAM,SAAS;AAAA,MACX,GAAG;AAAA,MACH,QAAQ;AAAA,QACJ,GAAG,IAAI;AAAA,QACP,QAAQ,CAAC;AAAA,MACb;AAAA,IACJ;AACA,UAAM,SAAS,KAAK,KAAK,UAAU,OAAO;AAAA,MACtC,MAAM,OAAO;AAAA,MACb,MAAM,OAAO;AAAA,MACb,QAAQ;AAAA,QACJ,GAAG;AAAA,MACP;AAAA,IACJ,CAAC;AACD,QAAI,QAAQ,MAAM,GAAG;AACjB,aAAO,OAAO,KAAK,CAACC,YAAW;AAC3B,eAAO;AAAA,UACH,QAAQ;AAAA,UACR,OAAOA,QAAO,WAAW,UACnBA,QAAO,QACP,KAAK,KAAK,WAAW;AAAA,YACnB,IAAI,QAAQ;AACR,qBAAO,IAAI,SAAS,OAAO,OAAO,MAAM;AAAA,YAC5C;AAAA,YACA,OAAO,OAAO;AAAA,UAClB,CAAC;AAAA,QACT;AAAA,MACJ,CAAC;AAAA,IACL,OACK;AACD,aAAO;AAAA,QACH,QAAQ;AAAA,QACR,OAAO,OAAO,WAAW,UACnB,OAAO,QACP,KAAK,KAAK,WAAW;AAAA,UACnB,IAAI,QAAQ;AACR,mBAAO,IAAI,SAAS,OAAO,OAAO,MAAM;AAAA,UAC5C;AAAA,UACA,OAAO,OAAO;AAAA,QAClB,CAAC;AAAA,MACT;AAAA,IACJ;AAAA,EACJ;AAAA,EACA,cAAc;AACV,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,SAAS,SAAS,CAAC,MAAM,WAAW;AAChC,SAAO,IAAI,SAAS;AAAA,IAChB,WAAW;AAAA,IACX,UAAU,sBAAsB;AAAA,IAChC,YAAY,OAAO,OAAO,UAAU,aAAa,OAAO,QAAQ,MAAM,OAAO;AAAA,IAC7E,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,SAAN,cAAqB,QAAQ;AAAA,EAv2GpC,OAu2GoC;AAAA;AAAA;AAAA,EAChC,OAAO,OAAO;AACV,UAAM,aAAa,KAAK,SAAS,KAAK;AACtC,QAAI,eAAe,cAAc,KAAK;AAClC,YAAM,MAAM,KAAK,gBAAgB,KAAK;AACtC,wBAAkB,KAAK;AAAA,QACnB,MAAM,aAAa;AAAA,QACnB,UAAU,cAAc;AAAA,QACxB,UAAU,IAAI;AAAA,MAClB,CAAC;AACD,aAAO;AAAA,IACX;AACA,WAAO,EAAE,QAAQ,SAAS,OAAO,MAAM,KAAK;AAAA,EAChD;AACJ;AACA,OAAO,SAAS,CAAC,WAAW;AACxB,SAAO,IAAI,OAAO;AAAA,IACd,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AACO,IAAM,QAAQ,OAAO,WAAW;AAChC,IAAM,aAAN,cAAyB,QAAQ;AAAA,EA73GxC,OA63GwC;AAAA;AAAA;AAAA,EACpC,OAAO,OAAO;AACV,UAAM,EAAE,IAAI,IAAI,KAAK,oBAAoB,KAAK;AAC9C,UAAM,OAAO,IAAI;AACjB,WAAO,KAAK,KAAK,KAAK,OAAO;AAAA,MACzB;AAAA,MACA,MAAM,IAAI;AAAA,MACV,QAAQ;AAAA,IACZ,CAAC;AAAA,EACL;AAAA,EACA,SAAS;AACL,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACO,IAAM,cAAN,MAAM,qBAAoB,QAAQ;AAAA,EA34GzC,OA24GyC;AAAA;AAAA;AAAA,EACrC,OAAO,OAAO;AACV,UAAM,EAAE,QAAQ,IAAI,IAAI,KAAK,oBAAoB,KAAK;AACtD,QAAI,IAAI,OAAO,OAAO;AAClB,YAAM,cAAc,mCAAY;AAC5B,cAAM,WAAW,MAAM,KAAK,KAAK,GAAG,YAAY;AAAA,UAC5C,MAAM,IAAI;AAAA,UACV,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AACD,YAAI,SAAS,WAAW;AACpB,iBAAO;AACX,YAAI,SAAS,WAAW,SAAS;AAC7B,iBAAO,MAAM;AACb,iBAAO,MAAM,SAAS,KAAK;AAAA,QAC/B,OACK;AACD,iBAAO,KAAK,KAAK,IAAI,YAAY;AAAA,YAC7B,MAAM,SAAS;AAAA,YACf,MAAM,IAAI;AAAA,YACV,QAAQ;AAAA,UACZ,CAAC;AAAA,QACL;AAAA,MACJ,GAnBoB;AAoBpB,aAAO,YAAY;AAAA,IACvB,OACK;AACD,YAAM,WAAW,KAAK,KAAK,GAAG,WAAW;AAAA,QACrC,MAAM,IAAI;AAAA,QACV,MAAM,IAAI;AAAA,QACV,QAAQ;AAAA,MACZ,CAAC;AACD,UAAI,SAAS,WAAW;AACpB,eAAO;AACX,UAAI,SAAS,WAAW,SAAS;AAC7B,eAAO,MAAM;AACb,eAAO;AAAA,UACH,QAAQ;AAAA,UACR,OAAO,SAAS;AAAA,QACpB;AAAA,MACJ,OACK;AACD,eAAO,KAAK,KAAK,IAAI,WAAW;AAAA,UAC5B,MAAM,SAAS;AAAA,UACf,MAAM,IAAI;AAAA,UACV,QAAQ;AAAA,QACZ,CAAC;AAAA,MACL;AAAA,IACJ;AAAA,EACJ;AAAA,EACA,OAAO,OAAO,GAAG,GAAG;AAChB,WAAO,IAAI,aAAY;AAAA,MACnB,IAAI;AAAA,MACJ,KAAK;AAAA,MACL,UAAU,sBAAsB;AAAA,IACpC,CAAC;AAAA,EACL;AACJ;AACO,IAAM,cAAN,cAA0B,QAAQ;AAAA,EAr8GzC,OAq8GyC;AAAA;AAAA;AAAA,EACrC,OAAO,OAAO;AACV,UAAM,SAAS,KAAK,KAAK,UAAU,OAAO,KAAK;AAC/C,UAAM,SAAS,wBAAC,SAAS;AACrB,UAAI,QAAQ,IAAI,GAAG;AACf,aAAK,QAAQ,OAAO,OAAO,KAAK,KAAK;AAAA,MACzC;AACA,aAAO;AAAA,IACX,GALe;AAMf,WAAO,QAAQ,MAAM,IAAI,OAAO,KAAK,CAAC,SAAS,OAAO,IAAI,CAAC,IAAI,OAAO,MAAM;AAAA,EAChF;AAAA,EACA,SAAS;AACL,WAAO,KAAK,KAAK;AAAA,EACrB;AACJ;AACA,YAAY,SAAS,CAAC,MAAM,WAAW;AACnC,SAAO,IAAI,YAAY;AAAA,IACnB,WAAW;AAAA,IACX,UAAU,sBAAsB;AAAA,IAChC,GAAG,oBAAoB,MAAM;AAAA,EACjC,CAAC;AACL;AAQA,SAAS,YAAY,QAAQ,MAAM;AAC/B,QAAMC,KAAI,OAAO,WAAW,aAAa,OAAO,IAAI,IAAI,OAAO,WAAW,WAAW,EAAE,SAAS,OAAO,IAAI;AAC3G,QAAMC,MAAK,OAAOD,OAAM,WAAW,EAAE,SAASA,GAAE,IAAIA;AACpD,SAAOC;AACX;AAJS;AAKF,SAAS,OAAO,OAAO,UAAU,CAAC,GAWzC,OAAO;AACH,MAAI;AACA,WAAO,OAAO,OAAO,EAAE,YAAY,CAAC,MAAM,QAAQ;AAC9C,YAAMC,KAAI,MAAM,IAAI;AACpB,UAAIA,cAAa,SAAS;AACtB,eAAOA,GAAE,KAAK,CAACA,OAAM;AACjB,cAAI,CAACA,IAAG;AACJ,kBAAM,SAAS,YAAY,SAAS,IAAI;AACxC,kBAAM,SAAS,OAAO,SAAS,SAAS;AACxC,gBAAI,SAAS,EAAE,MAAM,UAAU,GAAG,QAAQ,OAAO,OAAO,CAAC;AAAA,UAC7D;AAAA,QACJ,CAAC;AAAA,MACL;AACA,UAAI,CAACA,IAAG;AACJ,cAAM,SAAS,YAAY,SAAS,IAAI;AACxC,cAAM,SAAS,OAAO,SAAS,SAAS;AACxC,YAAI,SAAS,EAAE,MAAM,UAAU,GAAG,QAAQ,OAAO,OAAO,CAAC;AAAA,MAC7D;AACA;AAAA,IACJ,CAAC;AACL,SAAO,OAAO,OAAO;AACzB;AAhCgB;AAkCT,IAAM,OAAO;AAAA,EAChB,QAAQ,UAAU;AACtB;AACO,IAAI;AAAA,CACV,SAAUC,wBAAuB;AAC9B,EAAAA,uBAAsB,WAAW,IAAI;AACrC,EAAAA,uBAAsB,WAAW,IAAI;AACrC,EAAAA,uBAAsB,QAAQ,IAAI;AAClC,EAAAA,uBAAsB,WAAW,IAAI;AACrC,EAAAA,uBAAsB,YAAY,IAAI;AACtC,EAAAA,uBAAsB,SAAS,IAAI;AACnC,EAAAA,uBAAsB,WAAW,IAAI;AACrC,EAAAA,uBAAsB,cAAc,IAAI;AACxC,EAAAA,uBAAsB,SAAS,IAAI;AACnC,EAAAA,uBAAsB,QAAQ,IAAI;AAClC,EAAAA,uBAAsB,YAAY,IAAI;AACtC,EAAAA,uBAAsB,UAAU,IAAI;AACpC,EAAAA,uBAAsB,SAAS,IAAI;AACnC,EAAAA,uBAAsB,UAAU,IAAI;AACpC,EAAAA,uBAAsB,WAAW,IAAI;AACrC,EAAAA,uBAAsB,UAAU,IAAI;AACpC,EAAAA,uBAAsB,uBAAuB,IAAI;AACjD,EAAAA,uBAAsB,iBAAiB,IAAI;AAC3C,EAAAA,uBAAsB,UAAU,IAAI;AACpC,EAAAA,uBAAsB,WAAW,IAAI;AACrC,EAAAA,uBAAsB,QAAQ,IAAI;AAClC,EAAAA,uBAAsB,QAAQ,IAAI;AAClC,EAAAA,uBAAsB,aAAa,IAAI;AACvC,EAAAA,uBAAsB,SAAS,IAAI;AACnC,EAAAA,uBAAsB,YAAY,IAAI;AACtC,EAAAA,uBAAsB,SAAS,IAAI;AACnC,EAAAA,uBAAsB,YAAY,IAAI;AACtC,EAAAA,uBAAsB,eAAe,IAAI;AACzC,EAAAA,uBAAsB,aAAa,IAAI;AACvC,EAAAA,uBAAsB,aAAa,IAAI;AACvC,EAAAA,uBAAsB,YAAY,IAAI;AACtC,EAAAA,uBAAsB,UAAU,IAAI;AACpC,EAAAA,uBAAsB,YAAY,IAAI;AACtC,EAAAA,uBAAsB,YAAY,IAAI;AACtC,EAAAA,uBAAsB,aAAa,IAAI;AACvC,EAAAA,uBAAsB,aAAa,IAAI;AAC3C,GAAG,0BAA0B,wBAAwB,CAAC,EAAE;AAKxD,IAAM,iBAAiB,wBAEvB,KAAK,SAAS;AAAA,EACV,SAAS,yBAAyB,IAAI,IAAI;AAC9C,MAAM,OAAO,CAAC,SAAS,gBAAgB,KAAK,MAAM,GAJ3B;AAKvB,IAAM,aAAa,UAAU;AAC7B,IAAM,aAAa,UAAU;AAC7B,IAAM,UAAU,OAAO;AACvB,IAAM,aAAa,UAAU;AAC7B,IAAM,cAAc,WAAW;AAC/B,IAAM,WAAW,QAAQ;AACzB,IAAM,aAAa,UAAU;AAC7B,IAAM,gBAAgB,aAAa;AACnC,IAAM,WAAW,QAAQ;AACzB,IAAM,UAAU,OAAO;AACvB,IAAM,cAAc,WAAW;AAC/B,IAAM,YAAY,SAAS;AAC3B,IAAM,WAAW,QAAQ;AACzB,IAAM,YAAY,SAAS;AAC3B,IAAM,aAAa,UAAU;AAC7B,IAAM,mBAAmB,UAAU;AACnC,IAAM,YAAY,SAAS;AAC3B,IAAM,yBAAyB,sBAAsB;AACrD,IAAM,mBAAmB,gBAAgB;AACzC,IAAM,YAAY,SAAS;AAC3B,IAAM,aAAa,UAAU;AAC7B,IAAM,UAAU,OAAO;AACvB,IAAM,UAAU,OAAO;AACvB,IAAM,eAAe,YAAY;AACjC,IAAM,WAAW,QAAQ;AACzB,IAAM,cAAc,WAAW;AAC/B,IAAM,WAAW,QAAQ;AACzB,IAAM,iBAAiB,cAAc;AACrC,IAAM,cAAc,WAAW;AAC/B,IAAM,cAAc,WAAW;AAC/B,IAAM,eAAe,YAAY;AACjC,IAAM,eAAe,YAAY;AACjC,IAAM,iBAAiB,WAAW;AAClC,IAAM,eAAe,YAAY;AACjC,IAAM,UAAU,6BAAM,WAAW,EAAE,SAAS,GAA5B;AAChB,IAAM,UAAU,6BAAM,WAAW,EAAE,SAAS,GAA5B;AAChB,IAAM,WAAW,6BAAM,YAAY,EAAE,SAAS,GAA7B;AACV,IAAM,SAAS;AAAA,EAClB,QAAS,wBAAC,QAAQ,UAAU,OAAO,EAAE,GAAG,KAAK,QAAQ,KAAK,CAAC,GAAlD;AAAA,EACT,QAAS,wBAAC,QAAQ,UAAU,OAAO,EAAE,GAAG,KAAK,QAAQ,KAAK,CAAC,GAAlD;AAAA,EACT,SAAU,wBAAC,QAAQ,WAAW,OAAO;AAAA,IACjC,GAAG;AAAA,IACH,QAAQ;AAAA,EACZ,CAAC,GAHS;AAAA,EAIV,QAAS,wBAAC,QAAQ,UAAU,OAAO,EAAE,GAAG,KAAK,QAAQ,KAAK,CAAC,GAAlD;AAAA,EACT,MAAO,wBAAC,QAAQ,QAAQ,OAAO,EAAE,GAAG,KAAK,QAAQ,KAAK,CAAC,GAAhD;AACX;AAEO,IAAM,QAAQ;;;ACljHd,IAAM,qBAAN,cAAiC,MAAM;AAAA,EA1D9C,OA0D8C;AAAA;AAAA;AAAA,EACnC;AAAA,EAET,YAAY,QAAkB;AAC5B,UAAM,sCAAsC,OAAO,KAAK,IAAI,CAAC,EAAE;AAC/D,SAAK,OAAO;AACZ,SAAK,SAAS;AAAA,EAChB;AACF;AAEA,IAAM,eAAe,oBAAI,IAAI,CAAC,SAAS,QAAQ,CAAC;AAChD,IAAM,0BAA0B;AAChC,IAAM,oBAAoB,oBAAI,IAAI,CAAC,KAAK,QAAQ,OAAO,IAAI,CAAC;AAC5D,IAAM,wBAAwB,oBAAI,IAAI,CAAC,eAAe,OAAO,OAAO,CAAC;AAErE,SAAS,UAAU,WAA4B;AAC7C,MAAI;AACF,UAAM,SAAS,IAAI,IAAI,SAAS;AAChC,WAAO,aAAa,IAAI,OAAO,QAAQ;AAAA,EACzC,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAPS;AAST,SAAS,mBAAmB,WAA4B;AACtD,SAAO,UAAU,WAAW,GAAG,KAAK,CAAC,UAAU,WAAW,IAAI;AAChE;AAFS;AAIT,IAAM,YAAY,iBACf,OAAO;AAAA,EACN,iBAAiB,iBACd,OAAO,EACP,IAAI,GAAG,6BAA6B,EACpC,OAAO,CAAC,UAAkB,UAAU,MAAM,KAAK,CAAC,GAAG;AAAA,IAClD,SAAS;AAAA,EACX,CAAC;AAAA,EACH,YAAY,iBACT,OAAO,EACP,KAAK,EACL,IAAI,GAAG,wBAAwB;AAAA,EAClC,cAAc,iBACX,OAAO,EACP,IAAI,GAAG,0BAA0B,EACjC,OAAO,CAAC,UAAkB,UAAU,MAAM,KAAK,CAAC,GAAG;AAAA,IAClD,SAAS;AAAA,EACX,CAAC;AAAA,EACH,gBAAgB,iBAAE,OAAO,EAAE,IAAI,GAAG,4BAA4B;AAAA,EAC9D,eAAe,iBACZ,OAAO,EACP,KAAK,EACL,IAAI,IAAI,mDAAmD;AAChE,CAAC,EACA,YAAY,EACZ,YAAY,CAAC,OAAgC,QAAyB;AACrE,QAAM,UAAU,MAAM;AACtB,MACE,CAAC,WACD,OAAO,YAAY,YACnB,OAAQ,QAAkC,YAAY,YACtD;AACA,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,IAAI;AAAA,MACX,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AAEA,QAAM,UAAU,OAAO,MAAM,iBAAiB,WAAW,MAAM,aAAa,KAAK,IAAI;AACrF,MAAI,CAAC,WAAW,CAAC,UAAU,OAAO,GAAG;AACnC,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,cAAc;AAAA,MACrB,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AAEA,QAAM,gBAAgB,OAAO,MAAM,mBAAmB,WAAW,MAAM,eAAe,KAAK,IAAI;AAC/F,MAAI,CAAC,eAAe;AAClB,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,gBAAgB;AAAA,MACvB,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH,WAAW,CAAC,mBAAmB,aAAa,KAAK,CAAC,UAAU,aAAa,GAAG;AAC1E,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,gBAAgB;AAAA,MACvB,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AAEA,QAAM,aAAa,OAAO,MAAM,iBAAiB,WAAW,MAAM,aAAa,KAAK,IAAI;AACxF,MAAI,cAAc,wBAAwB,KAAK,UAAU,KAAK,CAAC,UAAU,UAAU,GAAG;AACpF,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,cAAc;AAAA,MACrB,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AAEA,QAAM,eAAe,OAAO,MAAM,mBAAmB,WAAW,MAAM,eAAe,KAAK,IAAI;AAC9F,MAAI,cAAc;AAChB,QAAI,aAAa,WAAW,IAAI,GAAG;AAGjC,UAAI;AACF,cAAM,SAAS,IAAI,IAAI,SAAS,YAAY,EAAE;AAC9C,YAAI,CAAC,OAAO,MAAM;AAChB,gBAAM,IAAI,MAAM,cAAc;AAAA,QAChC;AAAA,MACF,QAAQ;AACN,YAAI,SAAS;AAAA,UACX,MAAM,CAAC,gBAAgB;AAAA,UACvB,MAAM,iBAAE,aAAa;AAAA,UACrB,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAAA,IACF,WAAW,wBAAwB,KAAK,YAAY,KAAK,CAAC,UAAU,YAAY,GAAG;AACjF,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,gBAAgB;AAAA,QACvB,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,QAAM,mBACJ,OAAO,MAAM,2BAA2B,WAAW,MAAM,uBAAuB,KAAK,IAAI;AAC3F,QAAM,qBACJ,OAAO,MAAM,8BAA8B,WACvC,MAAM,0BAA0B,KAAK,IACrC;AACN,QAAM,wBACJ,OAAO,MAAM,iCAAiC,WAC1C,MAAM,6BAA6B,KAAK,IACxC;AACN,QAAM,qBACJ,OAAO,MAAM,oCAAoC,WAC7C,MAAM,gCAAgC,KAAK,IAC3C;AACN,QAAM,mBACJ,OAAO,MAAM,4BAA4B,WACrC,MAAM,wBAAwB,KAAK,IACnC;AACN,QAAM,mBACJ,OAAO,MAAM,4BAA4B,WACrC,MAAM,wBAAwB,KAAK,IACnC;AACN,QAAM,sBACJ,OAAO,MAAM,0BAA0B,WACnC,MAAM,sBAAsB,KAAK,EAAE,YAAY,IAC/C;AACN,QAAM,gBACJ,oBAAoB,SAAS,KAAK,kBAAkB,IAAI,mBAAmB;AAC7E,QAAM,aACJ,OAAO,MAAM,mBAAmB,YAAY,MAAM,eAAe,KAAK,EAAE,SAAS;AACnF,QAAM,iBACJ,OAAO,MAAM,gBAAgB,WAAW,MAAM,YAAY,KAAK,EAAE,YAAY,IAAI;AACnF,QAAM,wBACJ,eAAe,SAAS,KAAK,sBAAsB,IAAI,cAAc;AACvE,QAAM,eAAe,QAAQ,YAAY;AACzC,QAAM,iBACJ,aAAa,WAAW,kBAAkB,KAC1C,aAAa,WAAW,kBAAkB,KAC1C,aAAa,WAAW,gBAAgB,KACxC,aAAa,WAAW,cAAc;AAExC,MAAI,iBAAiB,CAAC,uBAAuB;AAC3C,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,uBAAuB;AAAA,MAC9B,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AAEA,MAAI,iBAAiB,CAAC,gBAAgB;AACpC,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,uBAAuB;AAAA,MAC9B,MAAM,iBAAE,aAAa;AAAA,MACrB,SACE;AAAA,IACJ,CAAC;AAAA,EACH;AAEA,QAAM,aAAa,cAAc,kBAAkB;AAEnD,MAAI,CAAC,kBAAkB;AACrB,QAAI,YAAY;AACd,cAAQ,KAAK,gFAAgF;AAAA,IAC/F,OAAO;AACL,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,wBAAwB;AAAA,QAC/B,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,MAAI,kBAAkB;AACpB,UAAM,SAAS,OAAO,SAAS,kBAAkB,EAAE;AACnD,QAAI,CAAC,OAAO,SAAS,MAAM,KAAK,SAAS,GAAG;AAC1C,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,yBAAyB;AAAA,QAChC,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AACA,QAAI,SAAS,KAAK,kBAAkB;AAClC,YAAM,QAAQ,OAAO,SAAS,kBAAkB,EAAE;AAClD,UAAI,CAAC,OAAO,SAAS,KAAK,KAAK,SAAS,GAAG;AACzC,YAAI,SAAS;AAAA,UACX,MAAM,CAAC,yBAAyB;AAAA,UAChC,MAAM,iBAAE,aAAa;AAAA,UACrB,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAAA,IACF;AACA,QAAI,SAAS,KAAK,CAAC,MAAM,qBAAqB,CAAC,YAAY;AACzD,cAAQ;AAAA,QACN;AAAA,MACF;AAAA,IACF;AAAA,EACF,WAAW,kBAAkB;AAC3B,UAAM,QAAQ,OAAO,SAAS,kBAAkB,EAAE;AAClD,QAAI,CAAC,OAAO,SAAS,KAAK,KAAK,SAAS,GAAG;AACzC,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,yBAAyB;AAAA,QAChC,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,MAAI,CAAC,oBAAoB;AACvB,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,2BAA2B;AAAA,MAClC,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH,OAAO;AACL,UAAM,SAAS,OAAO,SAAS,oBAAoB,EAAE;AACrD,QAAI,OAAO,MAAM,MAAM,KAAK,UAAU,GAAG;AACvC,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,2BAA2B;AAAA,QAClC,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,MAAI,uBAAuB;AACzB,UAAM,SAAS,OAAO,SAAS,uBAAuB,EAAE;AACxD,QAAI,OAAO,MAAM,MAAM,KAAK,SAAS,GAAG;AACtC,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,8BAA8B;AAAA,QACrC,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,MAAI,CAAC,oBAAoB;AACvB,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,iCAAiC;AAAA,MACxC,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH,OAAO;AACL,UAAM,SAAS,OAAO,SAAS,oBAAoB,EAAE;AACrD,QAAI,OAAO,MAAM,MAAM,KAAK,SAAS,GAAG;AACtC,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,iCAAiC;AAAA,QACxC,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,QAAM,cAAc,OAAO,MAAM,cAAc,WAAW,MAAM,UAAU,KAAK,EAAE,YAAY,IAAI;AACjG,MAAI,eAAe,CAAC,CAAC,SAAS,QAAQ,QAAQ,OAAO,EAAE,SAAS,WAAW,GAAG;AAC5E,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,WAAW;AAAA,MAClB,MAAM,iBAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AAEA,QAAM,eACJ,OAAO,MAAM,0BAA0B,WAAW,MAAM,sBAAsB,KAAK,IAAI;AACzF,MAAI,cAAc;AAChB,UAAM,SAAS,OAAO,YAAY;AAClC,QAAI,CAAC,OAAO,SAAS,MAAM,KAAK,UAAU,GAAG;AAC3C,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,uBAAuB;AAAA,QAC9B,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,QAAM,sBACJ,OAAO,MAAM,4BAA4B,WAAW,MAAM,wBAAwB,KAAK,IAAI;AAC7F,MAAI,qBAAqB;AACvB,UAAM,SAAS,OAAO,mBAAmB;AACzC,QAAI,CAAC,OAAO,SAAS,MAAM,KAAK,UAAU,GAAG;AAC3C,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,yBAAyB;AAAA,QAChC,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AAEA,QAAM,kBACJ,OAAO,MAAM,gCAAgC,WACzC,MAAM,4BAA4B,KAAK,IACvC;AACN,MAAI,iBAAiB;AACnB,UAAM,SAAS,OAAO,SAAS,iBAAiB,EAAE;AAClD,QAAI,CAAC,OAAO,SAAS,MAAM,KAAK,UAAU,GAAG;AAC3C,UAAI,SAAS;AAAA,QACX,MAAM,CAAC,6BAA6B;AAAA,QACpC,MAAM,iBAAE,aAAa;AAAA,QACrB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AAAA,EACF;AACF,CAAC;AAEH,IAAM,gBAAgB,oBAAI,QAAgB;AAEnC,SAAS,YAAY,KAAe;AACzC,MAAI,cAAc,IAAI,GAAwB,GAAG;AAC/C,WAAO;AAAA,EACT;AAEA,QAAM,SAAS,UAAU,UAAU,GAAG;AACtC,MAAI,CAAC,OAAO,SAAS;AACnB,UAAM,SAAS,OAAO,MAAM,OAAO,IAAI,CAAC,UAAsB;AAC5D,YAAM,OAAO,MAAM,KAAK,SAAS,MAAM,KAAK,KAAK,GAAG,IAAI;AACxD,aAAO,GAAG,IAAI,KAAK,MAAM,OAAO;AAAA,IAClC,CAAC;AACD,UAAM,IAAI,mBAAmB,MAAM;AAAA,EACrC;AAEA,gBAAc,IAAI,GAAwB;AAC1C,SAAO;AACT;AAhBgB;;;ACrYhB;AAAA,EACI,oBAAqB;AAAA,EACrB,yBAA0B;AAAA,EAC1B,oBAAqB;AAAA,EACrB,oBAAqB;AACzB;;;ACJO,IAAM,gBAAgB;AAAA,EAC3B,cAAc;AAAA,EACd,uCAAuC;AAAA,EACvC,gCAAgC;AAAA,EAChC,iCAAiC;AAAA,EACjC,wCAAwC;AAAA,EACxC,2CAA2C;AAAA,EAC3C,uCAAuC;AAAA,EACvC,kCAAkC;AAAA,EAClC,gCAAgC;AAAA,EAChC,2BAA2B;AAAA,EAC3B,2BAA2B;AAAA,EAC3B,2BAA2B;AAAA,EAC3B,8BAA8B;AAAA,EAC9B,mCAAmC;AAAA,EACnC,0CAA0C;AAAA,EAC1C,gCAAgC;AAAA,EAChC,6BAA6B;AAAA,EAC7B,6BAA6B;AAC/B;;;ACpBO,IAAM,UAAU;AAChB,IAAM,UAAU;AAChB,IAAM,SAAS;AActB,SAAS,aAAa,QAAkB,QAAmB;AACzD,MAAI,CAAC,OAAQ;AACb,aAAW,SAAS,QAAQ;AAC1B,QAAI,CAAC,OAAO,SAAS,KAAK,GAAG;AAC3B,aAAO,KAAK,KAAK;AAAA,IACnB;AAAA,EACF;AACF;AAPS;AASF,SAAS,oBAAoB,KAAe,UAAiC,CAAC,GAAG;AACtF,QAAM,YAAY,CAAC,QAAQ;AAC3B,eAAa,WAAW,QAAQ,SAAS;AACzC,eAAa,WAAW,QAAQ,YAAY;AAC5C,eAAa,WAAW,QAAQ,YAAY;AAE5C,QAAM,WAAW,CAAC,QAAQ;AAC1B,eAAa,UAAU,QAAQ,WAAW;AAC1C,eAAa,UAAU,QAAQ,WAAW;AAC1C,eAAa,UAAU,QAAQ,QAAQ;AAEvC,QAAM,aAAa,CAAC,QAAQ;AAC5B,eAAa,YAAY,QAAQ,UAAU;AAE3C,QAAM,SAAS,CAAC,UAAU,OAAO;AACjC,eAAa,QAAQ,QAAQ,MAAM;AAEnC,QAAM,UAAU,CAAC,UAAU,OAAO;AAClC,eAAa,SAAS,QAAQ,OAAO;AAErC,QAAM,MAAM;AAAA,IACV;AAAA,IACA,cAAc,UAAU,KAAK,GAAG,CAAC;AAAA,IACjC,aAAa,SAAS,KAAK,GAAG,CAAC;AAAA,IAC/B,WAAW,OAAO,KAAK,GAAG,CAAC;AAAA,IAC3B,eAAe,WAAW,KAAK,GAAG,CAAC;AAAA,IACnC,YAAY,QAAQ,KAAK,GAAG,CAAC;AAAA,IAC7B;AAAA,IACA;AAAA,IACA;AAAA,EACF,EAAE,KAAK,IAAI;AAEX,QAAMC,KAAI,IAAI,QAAQ,IAAI,OAAO;AACjC,EAAAA,GAAE,IAAI,2BAA2B,GAAG;AACpC,EAAAA,GAAE,IAAI,0BAA0B,SAAS;AACzC,EAAAA,GAAE,IAAI,mBAAmB,aAAa;AACtC,EAAAA,GAAE,IAAI,8BAA8B,aAAa;AACjD,EAAAA,GAAE,IAAI,6BAA6B,qCAAqC;AAExE,SAAO,IAAI,SAAS,IAAI,MAAM;AAAA,IAC5B,SAASA;AAAA,IACT,QAAQ,IAAI;AAAA,IACZ,YAAY,IAAI;AAAA,EAClB,CAAC;AACH;AA5CgB;AA8CT,SAAS,KAAK,MAAe,OAAqB,CAAC,GAAG;AAC3D,QAAM,UAAU,IAAI,QAAQ,EAAE,gBAAgB,QAAQ,CAAC;AACvD,MAAI,KAAK,SAAS;AAChB,UAAM,cAAc,IAAI,QAAQ,KAAK,OAAO;AAC5C,gBAAY,QAAQ,CAAC,OAAO,QAAQ;AAClC,cAAQ,IAAI,KAAK,KAAK;AAAA,IACxB,CAAC;AAAA,EACH;AACA,QAAM,eAA6B,EAAE,GAAG,MAAM,QAAQ;AACtD,SAAO,oBAAoB,IAAI,SAAS,KAAK,UAAU,IAAI,GAAG,YAAY,CAAC;AAC7E;AAVgB;AAYT,SAAS,KAAK,MAAc,OAAqB,CAAC,GAAG;AAC1D,SAAO,oBAAoB,IAAI,SAAS,MAAM,IAAI,CAAC;AACrD;AAFgB;;;AC7EhB,IAAM,WAAW;AAEjB,SAAS,iBAAiB,MAA6B;AACrD,QAAM,MAAM,UAAU,IAAI;AAC1B,QAAM,UAAW,cAAqD,GAAG;AACzE,SAAO,OAAO,YAAY,WAAW,UAAU;AACjD;AAJS;AAMF,IAAM,SAAuD,OAAO;AAAA,EACzE,OAAO,QAAQ,QAAQ,EAAE,IAAI,CAAC,CAAC,MAAM,QAAQ,MAAM;AACjD,UAAM,OAAO,iBAAiB,IAAI,KAAK;AACvC,WAAO,CAAC,MAAM,EAAE,IAAI,QAAQ,KAAK,CAAC;AAAA,EACpC,CAAC;AACH;;;ACnBA,IAAO,oBAAQ;AACR,IAAM,cAAc,wBAAC,QAAQ,eAAe,WAAxB;;;ACApB,IAAM,UAAU,IAAI,YAAY;AAChC,IAAM,UAAU,IAAI,YAAY;AACvC,IAAM,YAAY,KAAK;AAChB,SAAS,UAAU,SAAS;AAC/B,QAAM,OAAO,QAAQ,OAAO,CAAC,KAAK,EAAE,OAAO,MAAM,MAAM,QAAQ,CAAC;AAChE,QAAM,MAAM,IAAI,WAAW,IAAI;AAC/B,MAAI,IAAI;AACR,aAAW,UAAU,SAAS;AAC1B,QAAI,IAAI,QAAQ,CAAC;AACjB,SAAK,OAAO;AAAA,EAChB;AACA,SAAO;AACX;AATgB;;;ACYT,IAAM,eAAe,wBAAC,YAAY;AACrC,QAAM,SAAS,KAAK,OAAO;AAC3B,QAAM,QAAQ,IAAI,WAAW,OAAO,MAAM;AAC1C,WAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACpC,UAAM,CAAC,IAAI,OAAO,WAAW,CAAC;AAAA,EAClC;AACA,SAAO;AACX,GAP4B;AAQrB,IAAM,SAAS,wBAAC,UAAU;AAC7B,MAAI,UAAU;AACd,MAAI,mBAAmB,YAAY;AAC/B,cAAU,QAAQ,OAAO,OAAO;AAAA,EACpC;AACA,YAAU,QAAQ,QAAQ,MAAM,GAAG,EAAE,QAAQ,MAAM,GAAG,EAAE,QAAQ,OAAO,EAAE;AACzE,MAAI;AACA,WAAO,aAAa,OAAO;AAAA,EAC/B,QACM;AACF,UAAM,IAAI,UAAU,mDAAmD;AAAA,EAC3E;AACJ,GAZsB;;;ACxBf,IAAM,YAAN,cAAwB,MAAM;AAAA,EAArC,OAAqC;AAAA;AAAA;AAAA,EACjC,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AAAA,EACA,YAAYC,UAAS;AACjB,UAAMA,QAAO;AACb,SAAK,OAAO;AACZ,SAAK,OAAO,KAAK,YAAY;AAC7B,UAAM,oBAAoB,MAAM,KAAK,WAAW;AAAA,EACpD;AACJ;AACO,IAAM,2BAAN,cAAuC,UAAU;AAAA,EAXxD,OAWwD;AAAA;AAAA;AAAA,EACpD,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AAAA,EACA,YAAYA,UAAS,SAAS,QAAQ,eAAe,SAAS,eAAe;AACzE,UAAMA,QAAO;AACb,SAAK,OAAO;AACZ,SAAK,QAAQ;AACb,SAAK,SAAS;AACd,SAAK,UAAU;AAAA,EACnB;AACJ;AACO,IAAM,aAAN,cAAyB,UAAU;AAAA,EAvB1C,OAuB0C;AAAA;AAAA;AAAA,EACtC,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AAAA,EACA,YAAYA,UAAS,SAAS,QAAQ,eAAe,SAAS,eAAe;AACzE,UAAMA,QAAO;AACb,SAAK,OAAO;AACZ,SAAK,QAAQ;AACb,SAAK,SAAS;AACd,SAAK,UAAU;AAAA,EACnB;AACJ;AACO,IAAM,oBAAN,cAAgC,UAAU;AAAA,EAnCjD,OAmCiD;AAAA;AAAA;AAAA,EAC7C,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AAAA,EAChB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AACO,IAAM,mBAAN,cAA+B,UAAU;AAAA,EA5ChD,OA4CgD;AAAA;AAAA;AAAA,EAC5C,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AAAA,EAChB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AAoBO,IAAM,aAAN,cAAyB,UAAU;AAAA,EAxE1C,OAwE0C;AAAA;AAAA;AAAA,EACtC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AAAA,EAChB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AACO,IAAM,aAAN,cAAyB,UAAU;AAAA,EAjF1C,OAiF0C;AAAA;AAAA;AAAA,EACtC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AAAA,EAChB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AAUO,IAAM,cAAN,cAA0B,UAAU;AAAA,EAnG3C,OAmG2C;AAAA;AAAA;AAAA,EACvC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AAAA,EAChB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AACO,IAAM,oBAAN,cAAgC,UAAU;AAAA,EA5GjD,OA4GiD;AAAA;AAAA;AAAA,EAC7C,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AACZ,SAAK,UAAU;AAAA,EACnB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AACO,IAAM,2BAAN,cAAuC,UAAU;AAAA,EAtHxD,OAsHwD;AAAA;AAAA;AAAA,EACpD,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AACZ,SAAK,UAAU;AAAA,EACnB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AAEO,IAAM,cAAN,cAA0B,UAAU;AAAA,EAjI3C,OAiI2C;AAAA;AAAA;AAAA,EACvC,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AACZ,SAAK,UAAU;AAAA,EACnB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;AACO,IAAM,iCAAN,cAA6C,UAAU;AAAA,EA3I9D,OA2I8D;AAAA;AAAA;AAAA,EAC1D,cAAc;AACV,UAAM,GAAG,SAAS;AAClB,SAAK,OAAO;AACZ,SAAK,UAAU;AAAA,EACnB;AAAA,EACA,WAAW,OAAO;AACd,WAAO;AAAA,EACX;AACJ;;;ACpJA,SAAS,SAAS,MAAM,OAAO,kBAAkB;AAC7C,SAAO,IAAI,UAAU,kDAAkD,IAAI,YAAY,IAAI,EAAE;AACjG;AAFS;AAGT,SAAS,YAAY,WAAW,MAAM;AAClC,SAAO,UAAU,SAAS;AAC9B;AAFS;AAGT,SAAS,cAAc,MAAM;AACzB,SAAO,SAAS,KAAK,KAAK,MAAM,CAAC,GAAG,EAAE;AAC1C;AAFS;AAGT,SAAS,cAAc,KAAK;AACxB,UAAQ,KAAK;AAAA,IACT,KAAK;AACD,aAAO;AAAA,IACX,KAAK;AACD,aAAO;AAAA,IACX,KAAK;AACD,aAAO;AAAA,IACX;AACI,YAAM,IAAI,MAAM,aAAa;AAAA,EACrC;AACJ;AAXS;AAYT,SAAS,WAAW,KAAK,QAAQ;AAC7B,MAAI,OAAO,UAAU,CAAC,OAAO,KAAK,CAAC,aAAa,IAAI,OAAO,SAAS,QAAQ,CAAC,GAAG;AAC5E,QAAI,MAAM;AACV,QAAI,OAAO,SAAS,GAAG;AACnB,YAAM,OAAO,OAAO,IAAI;AACxB,aAAO,UAAU,OAAO,KAAK,IAAI,CAAC,QAAQ,IAAI;AAAA,IAClD,WACS,OAAO,WAAW,GAAG;AAC1B,aAAO,UAAU,OAAO,CAAC,CAAC,OAAO,OAAO,CAAC,CAAC;AAAA,IAC9C,OACK;AACD,aAAO,GAAG,OAAO,CAAC,CAAC;AAAA,IACvB;AACA,UAAM,IAAI,UAAU,GAAG;AAAA,EAC3B;AACJ;AAfS;AAgBF,SAAS,kBAAkB,KAAK,QAAQ,QAAQ;AACnD,UAAQ,KAAK;AAAA,IACT,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK,SAAS;AACV,UAAI,CAAC,YAAY,IAAI,WAAW,MAAM;AAClC,cAAM,SAAS,MAAM;AACzB,YAAM,WAAW,SAAS,IAAI,MAAM,CAAC,GAAG,EAAE;AAC1C,YAAM,SAAS,cAAc,IAAI,UAAU,IAAI;AAC/C,UAAI,WAAW;AACX,cAAM,SAAS,OAAO,QAAQ,IAAI,gBAAgB;AACtD;AAAA,IACJ;AAAA,IACA,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK,SAAS;AACV,UAAI,CAAC,YAAY,IAAI,WAAW,mBAAmB;AAC/C,cAAM,SAAS,mBAAmB;AACtC,YAAM,WAAW,SAAS,IAAI,MAAM,CAAC,GAAG,EAAE;AAC1C,YAAM,SAAS,cAAc,IAAI,UAAU,IAAI;AAC/C,UAAI,WAAW;AACX,cAAM,SAAS,OAAO,QAAQ,IAAI,gBAAgB;AACtD;AAAA,IACJ;AAAA,IACA,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK,SAAS;AACV,UAAI,CAAC,YAAY,IAAI,WAAW,SAAS;AACrC,cAAM,SAAS,SAAS;AAC5B,YAAM,WAAW,SAAS,IAAI,MAAM,CAAC,GAAG,EAAE;AAC1C,YAAM,SAAS,cAAc,IAAI,UAAU,IAAI;AAC/C,UAAI,WAAW;AACX,cAAM,SAAS,OAAO,QAAQ,IAAI,gBAAgB;AACtD;AAAA,IACJ;AAAA,IACA,KAAK,SAAS;AACV,UAAI,IAAI,UAAU,SAAS,aAAa,IAAI,UAAU,SAAS,SAAS;AACpE,cAAM,SAAS,kBAAkB;AAAA,MACrC;AACA;AAAA,IACJ;AAAA,IACA,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK,SAAS;AACV,UAAI,CAAC,YAAY,IAAI,WAAW,OAAO;AACnC,cAAM,SAAS,OAAO;AAC1B,YAAM,WAAW,cAAc,GAAG;AAClC,YAAM,SAAS,IAAI,UAAU;AAC7B,UAAI,WAAW;AACX,cAAM,SAAS,UAAU,sBAAsB;AACnD;AAAA,IACJ;AAAA,IACA;AACI,YAAM,IAAI,UAAU,2CAA2C;AAAA,EACvE;AACA,aAAW,KAAK,MAAM;AAC1B;AAxDgB;;;ACrChB,SAAS,QAAQ,KAAK,WAAWC,QAAO;AACpC,EAAAA,SAAQA,OAAM,OAAO,OAAO;AAC5B,MAAIA,OAAM,SAAS,GAAG;AAClB,UAAM,OAAOA,OAAM,IAAI;AACvB,WAAO,eAAeA,OAAM,KAAK,IAAI,CAAC,QAAQ,IAAI;AAAA,EACtD,WACSA,OAAM,WAAW,GAAG;AACzB,WAAO,eAAeA,OAAM,CAAC,CAAC,OAAOA,OAAM,CAAC,CAAC;AAAA,EACjD,OACK;AACD,WAAO,WAAWA,OAAM,CAAC,CAAC;AAAA,EAC9B;AACA,MAAI,UAAU,MAAM;AAChB,WAAO,aAAa,MAAM;AAAA,EAC9B,WACS,OAAO,WAAW,cAAc,OAAO,MAAM;AAClD,WAAO,sBAAsB,OAAO,IAAI;AAAA,EAC5C,WACS,OAAO,WAAW,YAAY,UAAU,MAAM;AACnD,QAAI,OAAO,aAAa,MAAM;AAC1B,aAAO,4BAA4B,OAAO,YAAY,IAAI;AAAA,IAC9D;AAAA,EACJ;AACA,SAAO;AACX;AAxBS;AAyBT,IAAO,4BAAQ,wBAAC,WAAWA,WAAU;AACjC,SAAO,QAAQ,gBAAgB,QAAQ,GAAGA,MAAK;AACnD,GAFe;AAGR,SAAS,QAAQ,KAAK,WAAWA,QAAO;AAC3C,SAAO,QAAQ,eAAe,GAAG,uBAAuB,QAAQ,GAAGA,MAAK;AAC5E;AAFgB;;;AC3BhB,IAAO,sBAAQ,wBAAC,QAAQ;AACpB,MAAI,YAAY,GAAG,GAAG;AAClB,WAAO;AAAA,EACX;AACA,SAAO,MAAM,OAAO,WAAW,MAAM;AACzC,GALe;AAMR,IAAM,QAAQ,CAAC,WAAW;;;ACPjC,IAAM,aAAa,2BAAI,YAAY;AAC/B,QAAM,UAAU,QAAQ,OAAO,OAAO;AACtC,MAAI,QAAQ,WAAW,KAAK,QAAQ,WAAW,GAAG;AAC9C,WAAO;AAAA,EACX;AACA,MAAI;AACJ,aAAW,UAAU,SAAS;AAC1B,UAAM,aAAa,OAAO,KAAK,MAAM;AACrC,QAAI,CAAC,OAAO,IAAI,SAAS,GAAG;AACxB,YAAM,IAAI,IAAI,UAAU;AACxB;AAAA,IACJ;AACA,eAAW,aAAa,YAAY;AAChC,UAAI,IAAI,IAAI,SAAS,GAAG;AACpB,eAAO;AAAA,MACX;AACA,UAAI,IAAI,SAAS;AAAA,IACrB;AAAA,EACJ;AACA,SAAO;AACX,GApBmB;AAqBnB,IAAO,sBAAQ;;;ACrBf,SAAS,aAAa,OAAO;AACzB,SAAO,OAAO,UAAU,YAAY,UAAU;AAClD;AAFS;AAGM,SAAR,SAA0B,OAAO;AACpC,MAAI,CAAC,aAAa,KAAK,KAAK,OAAO,UAAU,SAAS,KAAK,KAAK,MAAM,mBAAmB;AACrF,WAAO;AAAA,EACX;AACA,MAAI,OAAO,eAAe,KAAK,MAAM,MAAM;AACvC,WAAO;AAAA,EACX;AACA,MAAI,QAAQ;AACZ,SAAO,OAAO,eAAe,KAAK,MAAM,MAAM;AAC1C,YAAQ,OAAO,eAAe,KAAK;AAAA,EACvC;AACA,SAAO,OAAO,eAAe,KAAK,MAAM;AAC5C;AAZwB;;;ACHxB,IAAO,2BAAQ,wBAAC,KAAK,QAAQ;AACzB,MAAI,IAAI,WAAW,IAAI,KAAK,IAAI,WAAW,IAAI,GAAG;AAC9C,UAAM,EAAE,cAAc,IAAI,IAAI;AAC9B,QAAI,OAAO,kBAAkB,YAAY,gBAAgB,MAAM;AAC3D,YAAM,IAAI,UAAU,GAAG,GAAG,uDAAuD;AAAA,IACrF;AAAA,EACJ;AACJ,GAPe;;;ACCR,SAAS,MAAM,KAAK;AACvB,SAAO,SAAS,GAAG,KAAK,OAAO,IAAI,QAAQ;AAC/C;AAFgB;AAGT,SAAS,aAAa,KAAK;AAC9B,SAAO,IAAI,QAAQ,SAAS,OAAO,IAAI,MAAM;AACjD;AAFgB;AAGT,SAAS,YAAY,KAAK;AAC7B,SAAO,IAAI,QAAQ,SAAS,OAAO,IAAI,MAAM;AACjD;AAFgB;AAGT,SAAS,YAAY,KAAK;AAC7B,SAAO,MAAM,GAAG,KAAK,IAAI,QAAQ,SAAS,OAAO,IAAI,MAAM;AAC/D;AAFgB;;;ACRhB,SAAS,cAAc,KAAK;AACxB,MAAI;AACJ,MAAI;AACJ,UAAQ,IAAI,KAAK;AAAA,IACb,KAAK,OAAO;AACR,cAAQ,IAAI,KAAK;AAAA,QACb,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AACD,sBAAY,EAAE,MAAM,WAAW,MAAM,OAAO,IAAI,IAAI,MAAM,EAAE,CAAC,GAAG;AAChE,sBAAY,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,QAAQ;AACxC;AAAA,QACJ,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AACD,sBAAY,EAAE,MAAM,qBAAqB,MAAM,OAAO,IAAI,IAAI,MAAM,EAAE,CAAC,GAAG;AAC1E,sBAAY,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,QAAQ;AACxC;AAAA,QACJ,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AACD,sBAAY;AAAA,YACR,MAAM;AAAA,YACN,MAAM,OAAO,SAAS,IAAI,IAAI,MAAM,EAAE,GAAG,EAAE,KAAK,CAAC;AAAA,UACrD;AACA,sBAAY,IAAI,IAAI,CAAC,WAAW,WAAW,IAAI,CAAC,WAAW,SAAS;AACpE;AAAA,QACJ;AACI,gBAAM,IAAI,iBAAiB,8DAA8D;AAAA,MACjG;AACA;AAAA,IACJ;AAAA,IACA,KAAK,MAAM;AACP,cAAQ,IAAI,KAAK;AAAA,QACb,KAAK;AACD,sBAAY,EAAE,MAAM,SAAS,YAAY,QAAQ;AACjD,sBAAY,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,QAAQ;AACxC;AAAA,QACJ,KAAK;AACD,sBAAY,EAAE,MAAM,SAAS,YAAY,QAAQ;AACjD,sBAAY,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,QAAQ;AACxC;AAAA,QACJ,KAAK;AACD,sBAAY,EAAE,MAAM,SAAS,YAAY,QAAQ;AACjD,sBAAY,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,QAAQ;AACxC;AAAA,QACJ,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AACD,sBAAY,EAAE,MAAM,QAAQ,YAAY,IAAI,IAAI;AAChD,sBAAY,IAAI,IAAI,CAAC,YAAY,IAAI,CAAC;AACtC;AAAA,QACJ;AACI,gBAAM,IAAI,iBAAiB,8DAA8D;AAAA,MACjG;AACA;AAAA,IACJ;AAAA,IACA,KAAK,OAAO;AACR,cAAQ,IAAI,KAAK;AAAA,QACb,KAAK;AACD,sBAAY,EAAE,MAAM,IAAI,IAAI;AAC5B,sBAAY,IAAI,IAAI,CAAC,MAAM,IAAI,CAAC,QAAQ;AACxC;AAAA,QACJ,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AACD,sBAAY,EAAE,MAAM,IAAI,IAAI;AAC5B,sBAAY,IAAI,IAAI,CAAC,YAAY,IAAI,CAAC;AACtC;AAAA,QACJ;AACI,gBAAM,IAAI,iBAAiB,8DAA8D;AAAA,MACjG;AACA;AAAA,IACJ;AAAA,IACA;AACI,YAAM,IAAI,iBAAiB,6DAA6D;AAAA,EAChG;AACA,SAAO,EAAE,WAAW,UAAU;AAClC;AAjFS;AAkFT,IAAM,QAAQ,8BAAO,QAAQ;AACzB,MAAI,CAAC,IAAI,KAAK;AACV,UAAM,IAAI,UAAU,0DAA0D;AAAA,EAClF;AACA,QAAM,EAAE,WAAW,UAAU,IAAI,cAAc,GAAG;AAClD,QAAM,OAAO;AAAA,IACT;AAAA,IACA,IAAI,OAAO;AAAA,IACX,IAAI,WAAW;AAAA,EACnB;AACA,QAAM,UAAU,EAAE,GAAG,IAAI;AACzB,SAAO,QAAQ;AACf,SAAO,QAAQ;AACf,SAAO,kBAAO,OAAO,UAAU,OAAO,SAAS,GAAG,IAAI;AAC1D,GAdc;AAed,IAAO,qBAAQ;;;AChGf,IAAM,iBAAiB,wBAAC,MAAM,OAAO,CAAC,GAAf;AACvB,IAAI;AACJ,IAAI;AACJ,IAAM,cAAc,wBAAC,QAAQ;AACzB,SAAO,MAAM,OAAO,WAAW,MAAM;AACzC,GAFoB;AAGpB,IAAM,iBAAiB,8BAAO,OAAO,KAAK,KAAK,KAAK,SAAS,UAAU;AACnE,MAAI,SAAS,MAAM,IAAI,GAAG;AAC1B,MAAI,SAAS,GAAG,GAAG;AACf,WAAO,OAAO,GAAG;AAAA,EACrB;AACA,QAAM,YAAY,MAAM,mBAAU,EAAE,GAAG,KAAK,IAAI,CAAC;AACjD,MAAI;AACA,WAAO,OAAO,GAAG;AACrB,MAAI,CAAC,QAAQ;AACT,UAAM,IAAI,KAAK,EAAE,CAAC,GAAG,GAAG,UAAU,CAAC;AAAA,EACvC,OACK;AACD,WAAO,GAAG,IAAI;AAAA,EAClB;AACA,SAAO;AACX,GAfuB;AAgBvB,IAAM,qBAAqB,wBAAC,KAAK,QAAQ;AACrC,MAAI,YAAY,GAAG,GAAG;AAClB,QAAI,MAAM,IAAI,OAAO,EAAE,QAAQ,MAAM,CAAC;AACtC,WAAO,IAAI;AACX,WAAO,IAAI;AACX,WAAO,IAAI;AACX,WAAO,IAAI;AACX,WAAO,IAAI;AACX,WAAO,IAAI;AACX,QAAI,IAAI,GAAG;AACP,aAAO,eAAe,IAAI,CAAC;AAAA,IAC/B;AACA,iBAAa,WAAW,oBAAI,QAAQ;AACpC,WAAO,eAAe,UAAU,KAAK,KAAK,GAAG;AAAA,EACjD;AACA,MAAI,MAAM,GAAG,GAAG;AACZ,QAAI,IAAI;AACJ,aAAO,OAAO,IAAI,CAAC;AACvB,iBAAa,WAAW,oBAAI,QAAQ;AACpC,UAAM,YAAY,eAAe,UAAU,KAAK,KAAK,KAAK,IAAI;AAC9D,WAAO;AAAA,EACX;AACA,SAAO;AACX,GAvB2B;AAwB3B,IAAM,sBAAsB,wBAAC,KAAK,QAAQ;AACtC,MAAI,YAAY,GAAG,GAAG;AAClB,QAAI,MAAM,IAAI,OAAO,EAAE,QAAQ,MAAM,CAAC;AACtC,QAAI,IAAI,GAAG;AACP,aAAO,eAAe,IAAI,CAAC;AAAA,IAC/B;AACA,kBAAc,YAAY,oBAAI,QAAQ;AACtC,WAAO,eAAe,WAAW,KAAK,KAAK,GAAG;AAAA,EAClD;AACA,MAAI,MAAM,GAAG,GAAG;AACZ,QAAI,IAAI;AACJ,aAAO,OAAO,IAAI,CAAC;AACvB,kBAAc,YAAY,oBAAI,QAAQ;AACtC,UAAM,YAAY,eAAe,WAAW,KAAK,KAAK,KAAK,IAAI;AAC/D,WAAO;AAAA,EACX;AACA,SAAO;AACX,GAjB4B;AAkB5B,IAAO,wBAAQ,EAAE,oBAAoB,oBAAoB;;;AC5CzD,eAAsB,UAAU,KAAK,KAAK;AACtC,MAAI,CAAC,SAAS,GAAG,GAAG;AAChB,UAAM,IAAI,UAAU,uBAAuB;AAAA,EAC/C;AACA,UAAQ,MAAM,IAAI;AAClB,UAAQ,IAAI,KAAK;AAAA,IACb,KAAK;AACD,UAAI,OAAO,IAAI,MAAM,YAAY,CAAC,IAAI,GAAG;AACrC,cAAM,IAAI,UAAU,yCAAyC;AAAA,MACjE;AACA,aAAO,OAAgB,IAAI,CAAC;AAAA,IAChC,KAAK;AACD,UAAI,IAAI,QAAQ,QAAW;AACvB,cAAM,IAAI,iBAAiB,oEAAoE;AAAA,MACnG;AAAA,IACJ,KAAK;AAAA,IACL,KAAK;AACD,aAAO,mBAAY,EAAE,GAAG,KAAK,IAAI,CAAC;AAAA,IACtC;AACI,YAAM,IAAI,iBAAiB,8CAA8C;AAAA,EACjF;AACJ;AArBsB;;;ACpBtB,IAAM,MAAM,wBAAC,QAAQ,MAAM,OAAO,WAAW,GAAjC;AACZ,IAAM,eAAe,wBAAC,KAAK,KAAK,UAAU;AACtC,MAAI,IAAI,QAAQ,UAAa,IAAI,QAAQ,OAAO;AAC5C,UAAM,IAAI,UAAU,kEAAkE;AAAA,EAC1F;AACA,MAAI,IAAI,YAAY,UAAa,IAAI,QAAQ,WAAW,KAAK,MAAM,MAAM;AACrE,UAAM,IAAI,UAAU,yEAAyE,KAAK,EAAE;AAAA,EACxG;AACA,MAAI,IAAI,QAAQ,UAAa,IAAI,QAAQ,KAAK;AAC1C,UAAM,IAAI,UAAU,gEAAgE,GAAG,EAAE;AAAA,EAC7F;AACA,SAAO;AACX,GAXqB;AAYrB,IAAM,qBAAqB,wBAAC,KAAK,KAAK,OAAO,aAAa;AACtD,MAAI,eAAe;AACf;AACJ,MAAI,YAAgB,MAAM,GAAG,GAAG;AAC5B,QAAQ,YAAY,GAAG,KAAK,aAAa,KAAK,KAAK,KAAK;AACpD;AACJ,UAAM,IAAI,UAAU,yHAAyH;AAAA,EACjJ;AACA,MAAI,CAAC,oBAAU,GAAG,GAAG;AACjB,UAAM,IAAI,UAAU,QAAgB,KAAK,KAAK,GAAG,OAAO,cAAc,WAAW,iBAAiB,IAAI,CAAC;AAAA,EAC3G;AACA,MAAI,IAAI,SAAS,UAAU;AACvB,UAAM,IAAI,UAAU,GAAG,IAAI,GAAG,CAAC,8DAA8D;AAAA,EACjG;AACJ,GAd2B;AAe3B,IAAM,sBAAsB,wBAAC,KAAK,KAAK,OAAO,aAAa;AACvD,MAAI,YAAgB,MAAM,GAAG,GAAG;AAC5B,YAAQ,OAAO;AAAA,MACX,KAAK;AACD,YAAQ,aAAa,GAAG,KAAK,aAAa,KAAK,KAAK,KAAK;AACrD;AACJ,cAAM,IAAI,UAAU,kDAAkD;AAAA,MAC1E,KAAK;AACD,YAAQ,YAAY,GAAG,KAAK,aAAa,KAAK,KAAK,KAAK;AACpD;AACJ,cAAM,IAAI,UAAU,iDAAiD;AAAA,IAC7E;AAAA,EACJ;AACA,MAAI,CAAC,oBAAU,GAAG,GAAG;AACjB,UAAM,IAAI,UAAU,QAAgB,KAAK,KAAK,GAAG,OAAO,WAAW,iBAAiB,IAAI,CAAC;AAAA,EAC7F;AACA,MAAI,IAAI,SAAS,UAAU;AACvB,UAAM,IAAI,UAAU,GAAG,IAAI,GAAG,CAAC,mEAAmE;AAAA,EACtG;AACA,MAAI,UAAU,UAAU,IAAI,SAAS,UAAU;AAC3C,UAAM,IAAI,UAAU,GAAG,IAAI,GAAG,CAAC,uEAAuE;AAAA,EAC1G;AACA,MAAI,UAAU,aAAa,IAAI,SAAS,UAAU;AAC9C,UAAM,IAAI,UAAU,GAAG,IAAI,GAAG,CAAC,0EAA0E;AAAA,EAC7G;AACA,MAAI,IAAI,aAAa,UAAU,YAAY,IAAI,SAAS,WAAW;AAC/D,UAAM,IAAI,UAAU,GAAG,IAAI,GAAG,CAAC,wEAAwE;AAAA,EAC3G;AACA,MAAI,IAAI,aAAa,UAAU,aAAa,IAAI,SAAS,WAAW;AAChE,UAAM,IAAI,UAAU,GAAG,IAAI,GAAG,CAAC,yEAAyE;AAAA,EAC5G;AACJ,GA/B4B;AAgC5B,SAAS,aAAa,UAAU,KAAK,KAAK,OAAO;AAC7C,QAAM,YAAY,IAAI,WAAW,IAAI,KACjC,QAAQ,SACR,IAAI,WAAW,OAAO,KACtB,qBAAqB,KAAK,GAAG;AACjC,MAAI,WAAW;AACX,uBAAmB,KAAK,KAAK,OAAO,QAAQ;AAAA,EAChD,OACK;AACD,wBAAoB,KAAK,KAAK,OAAO,QAAQ;AAAA,EACjD;AACJ;AAXS;AAYT,IAAO,yBAAQ,aAAa,KAAK,QAAW,KAAK;AAC1C,IAAM,sBAAsB,aAAa,KAAK,QAAW,IAAI;;;AC3EpE,SAAS,aAAa,KAAK,mBAAmB,kBAAkB,iBAAiB,YAAY;AACzF,MAAI,WAAW,SAAS,UAAa,iBAAiB,SAAS,QAAW;AACtE,UAAM,IAAI,IAAI,gEAAgE;AAAA,EAClF;AACA,MAAI,CAAC,mBAAmB,gBAAgB,SAAS,QAAW;AACxD,WAAO,oBAAI,IAAI;AAAA,EACnB;AACA,MAAI,CAAC,MAAM,QAAQ,gBAAgB,IAAI,KACnC,gBAAgB,KAAK,WAAW,KAChC,gBAAgB,KAAK,KAAK,CAAC,UAAU,OAAO,UAAU,YAAY,MAAM,WAAW,CAAC,GAAG;AACvF,UAAM,IAAI,IAAI,uFAAuF;AAAA,EACzG;AACA,MAAI;AACJ,MAAI,qBAAqB,QAAW;AAChC,iBAAa,IAAI,IAAI,CAAC,GAAG,OAAO,QAAQ,gBAAgB,GAAG,GAAG,kBAAkB,QAAQ,CAAC,CAAC;AAAA,EAC9F,OACK;AACD,iBAAa;AAAA,EACjB;AACA,aAAW,aAAa,gBAAgB,MAAM;AAC1C,QAAI,CAAC,WAAW,IAAI,SAAS,GAAG;AAC5B,YAAM,IAAI,iBAAiB,+BAA+B,SAAS,qBAAqB;AAAA,IAC5F;AACA,QAAI,WAAW,SAAS,MAAM,QAAW;AACrC,YAAM,IAAI,IAAI,+BAA+B,SAAS,cAAc;AAAA,IACxE;AACA,QAAI,WAAW,IAAI,SAAS,KAAK,gBAAgB,SAAS,MAAM,QAAW;AACvE,YAAM,IAAI,IAAI,+BAA+B,SAAS,+BAA+B;AAAA,IACzF;AAAA,EACJ;AACA,SAAO,IAAI,IAAI,gBAAgB,IAAI;AACvC;AA/BS;AAgCT,IAAO,wBAAQ;;;ACjCf,IAAM,qBAAqB,wBAAC,QAAQ,eAAe;AAC/C,MAAI,eAAe,WACd,CAAC,MAAM,QAAQ,UAAU,KAAK,WAAW,KAAK,CAAC,MAAM,OAAO,MAAM,QAAQ,IAAI;AAC/E,UAAM,IAAI,UAAU,IAAI,MAAM,sCAAsC;AAAA,EACxE;AACA,MAAI,CAAC,YAAY;AACb,WAAO;AAAA,EACX;AACA,SAAO,IAAI,IAAI,UAAU;AAC7B,GAT2B;AAU3B,IAAO,8BAAQ;;;ACTA,SAAR,UAA2B,KAAK,WAAW;AAC9C,QAAM,OAAO,OAAO,IAAI,MAAM,EAAE,CAAC;AACjC,UAAQ,KAAK;AAAA,IACT,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,aAAO,EAAE,MAAM,MAAM,OAAO;AAAA,IAChC,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,aAAO,EAAE,MAAM,MAAM,WAAW,YAAY,IAAI,MAAM,EAAE,KAAK,EAAE;AAAA,IACnE,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,aAAO,EAAE,MAAM,MAAM,oBAAoB;AAAA,IAC7C,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,aAAO,EAAE,MAAM,MAAM,SAAS,YAAY,UAAU,WAAW;AAAA,IACnE,KAAK;AACD,aAAO,EAAE,MAAM,UAAU,KAAK;AAAA,IAClC;AACI,YAAM,IAAI,iBAAiB,OAAO,GAAG,6DAA6D;AAAA,EAC1G;AACJ;AAxBwB;;;ACIxB,eAAO,aAAoC,KAAK,KAAK,OAAO;AACxD,MAAI,UAAU,QAAQ;AAClB,UAAM,MAAM,sBAAU,oBAAoB,KAAK,GAAG;AAAA,EACtD;AACA,MAAI,UAAU,UAAU;AACpB,UAAM,MAAM,sBAAU,mBAAmB,KAAK,GAAG;AAAA,EACrD;AACA,MAAI,YAAY,GAAG,GAAG;AAClB,sBAAkB,KAAK,KAAK,KAAK;AACjC,WAAO;AAAA,EACX;AACA,MAAI,eAAe,YAAY;AAC3B,QAAI,CAAC,IAAI,WAAW,IAAI,GAAG;AACvB,YAAM,IAAI,UAAU,0BAAgB,KAAK,GAAG,KAAK,CAAC;AAAA,IACtD;AACA,WAAO,kBAAO,OAAO,UAAU,OAAO,KAAK,EAAE,MAAM,OAAO,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,OAAO,GAAG,OAAO,CAAC,KAAK,CAAC;AAAA,EAC7G;AACA,QAAM,IAAI,UAAU,0BAAgB,KAAK,GAAG,OAAO,cAAc,cAAc,CAAC;AACpF;AAlB8B;;;ACD9B,IAAM,SAAS,8BAAO,KAAK,KAAK,WAAW,SAAS;AAChD,QAAM,YAAY,MAAM,aAAa,KAAK,KAAK,QAAQ;AACvD,2BAAe,KAAK,SAAS;AAC7B,QAAM,YAAY,UAAgB,KAAK,UAAU,SAAS;AAC1D,MAAI;AACA,WAAO,MAAM,kBAAO,OAAO,OAAO,WAAW,WAAW,WAAW,IAAI;AAAA,EAC3E,QACM;AACF,WAAO;AAAA,EACX;AACJ,GAVe;AAWf,IAAO,iBAAQ;;;ACJf,eAAsB,gBAAgB,KAAK,KAAK,SAAS;AACrD,MAAI,CAAC,SAAS,GAAG,GAAG;AAChB,UAAM,IAAI,WAAW,iCAAiC;AAAA,EAC1D;AACA,MAAI,IAAI,cAAc,UAAa,IAAI,WAAW,QAAW;AACzD,UAAM,IAAI,WAAW,uEAAuE;AAAA,EAChG;AACA,MAAI,IAAI,cAAc,UAAa,OAAO,IAAI,cAAc,UAAU;AAClE,UAAM,IAAI,WAAW,qCAAqC;AAAA,EAC9D;AACA,MAAI,IAAI,YAAY,QAAW;AAC3B,UAAM,IAAI,WAAW,qBAAqB;AAAA,EAC9C;AACA,MAAI,OAAO,IAAI,cAAc,UAAU;AACnC,UAAM,IAAI,WAAW,yCAAyC;AAAA,EAClE;AACA,MAAI,IAAI,WAAW,UAAa,CAAC,SAAS,IAAI,MAAM,GAAG;AACnD,UAAM,IAAI,WAAW,uCAAuC;AAAA,EAChE;AACA,MAAI,aAAa,CAAC;AAClB,MAAI,IAAI,WAAW;AACf,QAAI;AACA,YAAM,kBAAkB,OAAU,IAAI,SAAS;AAC/C,mBAAa,KAAK,MAAM,QAAQ,OAAO,eAAe,CAAC;AAAA,IAC3D,QACM;AACF,YAAM,IAAI,WAAW,iCAAiC;AAAA,IAC1D;AAAA,EACJ;AACA,MAAI,CAAC,oBAAW,YAAY,IAAI,MAAM,GAAG;AACrC,UAAM,IAAI,WAAW,2EAA2E;AAAA,EACpG;AACA,QAAM,aAAa;AAAA,IACf,GAAG;AAAA,IACH,GAAG,IAAI;AAAA,EACX;AACA,QAAM,aAAa,sBAAa,YAAY,oBAAI,IAAI,CAAC,CAAC,OAAO,IAAI,CAAC,CAAC,GAAG,SAAS,MAAM,YAAY,UAAU;AAC3G,MAAI,MAAM;AACV,MAAI,WAAW,IAAI,KAAK,GAAG;AACvB,UAAM,WAAW;AACjB,QAAI,OAAO,QAAQ,WAAW;AAC1B,YAAM,IAAI,WAAW,yEAAyE;AAAA,IAClG;AAAA,EACJ;AACA,QAAM,EAAE,IAAI,IAAI;AAChB,MAAI,OAAO,QAAQ,YAAY,CAAC,KAAK;AACjC,UAAM,IAAI,WAAW,2DAA2D;AAAA,EACpF;AACA,QAAM,aAAa,WAAW,4BAAmB,cAAc,QAAQ,UAAU;AACjF,MAAI,cAAc,CAAC,WAAW,IAAI,GAAG,GAAG;AACpC,UAAM,IAAI,kBAAkB,sDAAsD;AAAA,EACtF;AACA,MAAI,KAAK;AACL,QAAI,OAAO,IAAI,YAAY,UAAU;AACjC,YAAM,IAAI,WAAW,8BAA8B;AAAA,IACvD;AAAA,EACJ,WACS,OAAO,IAAI,YAAY,YAAY,EAAE,IAAI,mBAAmB,aAAa;AAC9E,UAAM,IAAI,WAAW,wDAAwD;AAAA,EACjF;AACA,MAAI,cAAc;AAClB,MAAI,OAAO,QAAQ,YAAY;AAC3B,UAAM,MAAM,IAAI,YAAY,GAAG;AAC/B,kBAAc;AACd,wBAAoB,KAAK,KAAK,QAAQ;AACtC,QAAI,MAAM,GAAG,GAAG;AACZ,YAAM,MAAM,UAAU,KAAK,GAAG;AAAA,IAClC;AAAA,EACJ,OACK;AACD,wBAAoB,KAAK,KAAK,QAAQ;AAAA,EAC1C;AACA,QAAM,OAAO,OAAO,QAAQ,OAAO,IAAI,aAAa,EAAE,GAAG,QAAQ,OAAO,GAAG,GAAG,OAAO,IAAI,YAAY,WAAW,QAAQ,OAAO,IAAI,OAAO,IAAI,IAAI,OAAO;AACzJ,MAAI;AACJ,MAAI;AACA,gBAAY,OAAU,IAAI,SAAS;AAAA,EACvC,QACM;AACF,UAAM,IAAI,WAAW,0CAA0C;AAAA,EACnE;AACA,QAAM,WAAW,MAAM,eAAO,KAAK,KAAK,WAAW,IAAI;AACvD,MAAI,CAAC,UAAU;AACX,UAAM,IAAI,+BAA+B;AAAA,EAC7C;AACA,MAAI;AACJ,MAAI,KAAK;AACL,QAAI;AACA,gBAAU,OAAU,IAAI,OAAO;AAAA,IACnC,QACM;AACF,YAAM,IAAI,WAAW,wCAAwC;AAAA,IACjE;AAAA,EACJ,WACS,OAAO,IAAI,YAAY,UAAU;AACtC,cAAU,QAAQ,OAAO,IAAI,OAAO;AAAA,EACxC,OACK;AACD,cAAU,IAAI;AAAA,EAClB;AACA,QAAM,SAAS,EAAE,QAAQ;AACzB,MAAI,IAAI,cAAc,QAAW;AAC7B,WAAO,kBAAkB;AAAA,EAC7B;AACA,MAAI,IAAI,WAAW,QAAW;AAC1B,WAAO,oBAAoB,IAAI;AAAA,EACnC;AACA,MAAI,aAAa;AACb,WAAO,EAAE,GAAG,QAAQ,IAAI;AAAA,EAC5B;AACA,SAAO;AACX;AA9GsB;;;ACRtB,eAAsB,cAAc,KAAK,KAAK,SAAS;AACnD,MAAI,eAAe,YAAY;AAC3B,UAAM,QAAQ,OAAO,GAAG;AAAA,EAC5B;AACA,MAAI,OAAO,QAAQ,UAAU;AACzB,UAAM,IAAI,WAAW,4CAA4C;AAAA,EACrE;AACA,QAAM,EAAE,GAAG,iBAAiB,GAAG,SAAS,GAAG,WAAW,OAAO,IAAI,IAAI,MAAM,GAAG;AAC9E,MAAI,WAAW,GAAG;AACd,UAAM,IAAI,WAAW,qBAAqB;AAAA,EAC9C;AACA,QAAM,WAAW,MAAM,gBAAgB,EAAE,SAAS,WAAW,iBAAiB,UAAU,GAAG,KAAK,OAAO;AACvG,QAAM,SAAS,EAAE,SAAS,SAAS,SAAS,iBAAiB,SAAS,gBAAgB;AACtF,MAAI,OAAO,QAAQ,YAAY;AAC3B,WAAO,EAAE,GAAG,QAAQ,KAAK,SAAS,IAAI;AAAA,EAC1C;AACA,SAAO;AACX;AAjBsB;;;ACHtB,IAAO,gBAAQ,wBAAC,SAAS,KAAK,MAAM,KAAK,QAAQ,IAAI,GAAI,GAA1C;;;ACAf,IAAM,SAAS;AACf,IAAM,OAAO,SAAS;AACtB,IAAM,MAAM,OAAO;AACnB,IAAM,OAAO,MAAM;AACnB,IAAM,OAAO,MAAM;AACnB,IAAM,QAAQ;AACd,IAAO,eAAQ,wBAAC,QAAQ;AACpB,QAAM,UAAU,MAAM,KAAK,GAAG;AAC9B,MAAI,CAAC,WAAY,QAAQ,CAAC,KAAK,QAAQ,CAAC,GAAI;AACxC,UAAM,IAAI,UAAU,4BAA4B;AAAA,EACpD;AACA,QAAM,QAAQ,WAAW,QAAQ,CAAC,CAAC;AACnC,QAAM,OAAO,QAAQ,CAAC,EAAE,YAAY;AACpC,MAAI;AACJ,UAAQ,MAAM;AAAA,IACV,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,oBAAc,KAAK,MAAM,KAAK;AAC9B;AAAA,IACJ,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,oBAAc,KAAK,MAAM,QAAQ,MAAM;AACvC;AAAA,IACJ,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,oBAAc,KAAK,MAAM,QAAQ,IAAI;AACrC;AAAA,IACJ,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,oBAAc,KAAK,MAAM,QAAQ,GAAG;AACpC;AAAA,IACJ,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACD,oBAAc,KAAK,MAAM,QAAQ,IAAI;AACrC;AAAA,IACJ;AACI,oBAAc,KAAK,MAAM,QAAQ,IAAI;AACrC;AAAA,EACR;AACA,MAAI,QAAQ,CAAC,MAAM,OAAO,QAAQ,CAAC,MAAM,OAAO;AAC5C,WAAO,CAAC;AAAA,EACZ;AACA,SAAO;AACX,GAhDe;;;ACDf,IAAM,eAAe,wBAAC,UAAU,MAAM,YAAY,EAAE,QAAQ,kBAAkB,EAAE,GAA3D;AACrB,IAAM,wBAAwB,wBAAC,YAAY,cAAc;AACrD,MAAI,OAAO,eAAe,UAAU;AAChC,WAAO,UAAU,SAAS,UAAU;AAAA,EACxC;AACA,MAAI,MAAM,QAAQ,UAAU,GAAG;AAC3B,WAAO,UAAU,KAAK,IAAI,UAAU,IAAI,KAAK,IAAI,IAAI,UAAU,CAAC,CAAC;AAAA,EACrE;AACA,SAAO;AACX,GAR8B;AAS9B,IAAO,yBAAQ,wBAAC,iBAAiB,gBAAgB,UAAU,CAAC,MAAM;AAC9D,MAAI;AACJ,MAAI;AACA,cAAU,KAAK,MAAM,QAAQ,OAAO,cAAc,CAAC;AAAA,EACvD,QACM;AAAA,EACN;AACA,MAAI,CAAC,SAAS,OAAO,GAAG;AACpB,UAAM,IAAI,WAAW,gDAAgD;AAAA,EACzE;AACA,QAAM,EAAE,IAAI,IAAI;AAChB,MAAI,QACC,OAAO,gBAAgB,QAAQ,YAC5B,aAAa,gBAAgB,GAAG,MAAM,aAAa,GAAG,IAAI;AAC9D,UAAM,IAAI,yBAAyB,qCAAqC,SAAS,OAAO,cAAc;AAAA,EAC1G;AACA,QAAM,EAAE,iBAAiB,CAAC,GAAG,QAAQ,SAAS,UAAU,YAAY,IAAI;AACxE,QAAM,gBAAgB,CAAC,GAAG,cAAc;AACxC,MAAI,gBAAgB;AAChB,kBAAc,KAAK,KAAK;AAC5B,MAAI,aAAa;AACb,kBAAc,KAAK,KAAK;AAC5B,MAAI,YAAY;AACZ,kBAAc,KAAK,KAAK;AAC5B,MAAI,WAAW;AACX,kBAAc,KAAK,KAAK;AAC5B,aAAW,SAAS,IAAI,IAAI,cAAc,QAAQ,CAAC,GAAG;AAClD,QAAI,EAAE,SAAS,UAAU;AACrB,YAAM,IAAI,yBAAyB,qBAAqB,KAAK,WAAW,SAAS,OAAO,SAAS;AAAA,IACrG;AAAA,EACJ;AACA,MAAI,UACA,EAAE,MAAM,QAAQ,MAAM,IAAI,SAAS,CAAC,MAAM,GAAG,SAAS,QAAQ,GAAG,GAAG;AACpE,UAAM,IAAI,yBAAyB,gCAAgC,SAAS,OAAO,cAAc;AAAA,EACrG;AACA,MAAI,WAAW,QAAQ,QAAQ,SAAS;AACpC,UAAM,IAAI,yBAAyB,gCAAgC,SAAS,OAAO,cAAc;AAAA,EACrG;AACA,MAAI,YACA,CAAC,sBAAsB,QAAQ,KAAK,OAAO,aAAa,WAAW,CAAC,QAAQ,IAAI,QAAQ,GAAG;AAC3F,UAAM,IAAI,yBAAyB,gCAAgC,SAAS,OAAO,cAAc;AAAA,EACrG;AACA,MAAI;AACJ,UAAQ,OAAO,QAAQ,gBAAgB;AAAA,IACnC,KAAK;AACD,kBAAY,aAAK,QAAQ,cAAc;AACvC;AAAA,IACJ,KAAK;AACD,kBAAY,QAAQ;AACpB;AAAA,IACJ,KAAK;AACD,kBAAY;AACZ;AAAA,IACJ;AACI,YAAM,IAAI,UAAU,oCAAoC;AAAA,EAChE;AACA,QAAM,EAAE,YAAY,IAAI;AACxB,QAAM,MAAM,cAAM,eAAe,oBAAI,KAAK,CAAC;AAC3C,OAAK,QAAQ,QAAQ,UAAa,gBAAgB,OAAO,QAAQ,QAAQ,UAAU;AAC/E,UAAM,IAAI,yBAAyB,gCAAgC,SAAS,OAAO,SAAS;AAAA,EAChG;AACA,MAAI,QAAQ,QAAQ,QAAW;AAC3B,QAAI,OAAO,QAAQ,QAAQ,UAAU;AACjC,YAAM,IAAI,yBAAyB,gCAAgC,SAAS,OAAO,SAAS;AAAA,IAChG;AACA,QAAI,QAAQ,MAAM,MAAM,WAAW;AAC/B,YAAM,IAAI,yBAAyB,sCAAsC,SAAS,OAAO,cAAc;AAAA,IAC3G;AAAA,EACJ;AACA,MAAI,QAAQ,QAAQ,QAAW;AAC3B,QAAI,OAAO,QAAQ,QAAQ,UAAU;AACjC,YAAM,IAAI,yBAAyB,gCAAgC,SAAS,OAAO,SAAS;AAAA,IAChG;AACA,QAAI,QAAQ,OAAO,MAAM,WAAW;AAChC,YAAM,IAAI,WAAW,sCAAsC,SAAS,OAAO,cAAc;AAAA,IAC7F;AAAA,EACJ;AACA,MAAI,aAAa;AACb,UAAM,MAAM,MAAM,QAAQ;AAC1B,UAAM,MAAM,OAAO,gBAAgB,WAAW,cAAc,aAAK,WAAW;AAC5E,QAAI,MAAM,YAAY,KAAK;AACvB,YAAM,IAAI,WAAW,4DAA4D,SAAS,OAAO,cAAc;AAAA,IACnH;AACA,QAAI,MAAM,IAAI,WAAW;AACrB,YAAM,IAAI,yBAAyB,iEAAiE,SAAS,OAAO,cAAc;AAAA,IACtI;AAAA,EACJ;AACA,SAAO;AACX,GAxFe;;;ACZf,eAAsB,UAAU,KAAK,KAAK,SAAS;AAC/C,QAAM,WAAW,MAAM,cAAc,KAAK,KAAK,OAAO;AACtD,MAAI,SAAS,gBAAgB,MAAM,SAAS,KAAK,KAAK,SAAS,gBAAgB,QAAQ,OAAO;AAC1F,UAAM,IAAI,WAAW,qCAAqC;AAAA,EAC9D;AACA,QAAM,UAAU,uBAAW,SAAS,iBAAiB,SAAS,SAAS,OAAO;AAC9E,QAAM,SAAS,EAAE,SAAS,iBAAiB,SAAS,gBAAgB;AACpE,MAAI,OAAO,QAAQ,YAAY;AAC3B,WAAO,EAAE,GAAG,QAAQ,KAAK,SAAS,IAAI;AAAA,EAC1C;AACA,SAAO;AACX;AAXsB;;;ACAtB,SAAS,cAAc,KAAK;AACxB,UAAQ,OAAO,QAAQ,YAAY,IAAI,MAAM,GAAG,CAAC,GAAG;AAAA,IAChD,KAAK;AAAA,IACL,KAAK;AACD,aAAO;AAAA,IACX,KAAK;AACD,aAAO;AAAA,IACX,KAAK;AACD,aAAO;AAAA,IACX;AACI,YAAM,IAAI,iBAAiB,gDAAgD;AAAA,EACnF;AACJ;AAZS;AAaT,SAAS,WAAW,MAAM;AACtB,SAAQ,QACJ,OAAO,SAAS,YAChB,MAAM,QAAQ,KAAK,IAAI,KACvB,KAAK,KAAK,MAAM,SAAS;AACjC;AALS;AAMT,SAAS,UAAU,KAAK;AACpB,SAAO,SAAS,GAAG;AACvB;AAFS;AAGT,SAAS,MAAM,KAAK;AAChB,MAAI,OAAO,oBAAoB,YAAY;AACvC,WAAO,gBAAgB,GAAG;AAAA,EAC9B;AACA,SAAO,KAAK,MAAM,KAAK,UAAU,GAAG,CAAC;AACzC;AALS;AAMT,IAAM,cAAN,MAAkB;AAAA,EA/BlB,OA+BkB;AAAA;AAAA;AAAA,EACd,YAAY,MAAM;AACd,SAAK,UAAU,oBAAI,QAAQ;AAC3B,QAAI,CAAC,WAAW,IAAI,GAAG;AACnB,YAAM,IAAI,YAAY,4BAA4B;AAAA,IACtD;AACA,SAAK,QAAQ,MAAM,IAAI;AAAA,EAC3B;AAAA,EACA,MAAM,OAAO,iBAAiB,OAAO;AACjC,UAAM,EAAE,KAAK,IAAI,IAAI,EAAE,GAAG,iBAAiB,GAAG,OAAO,OAAO;AAC5D,UAAM,MAAM,cAAc,GAAG;AAC7B,UAAM,aAAa,KAAK,MAAM,KAAK,OAAO,CAACC,SAAQ;AAC/C,UAAI,YAAY,QAAQA,KAAI;AAC5B,UAAI,aAAa,OAAO,QAAQ,UAAU;AACtC,oBAAY,QAAQA,KAAI;AAAA,MAC5B;AACA,UAAI,aAAa,OAAOA,KAAI,QAAQ,UAAU;AAC1C,oBAAY,QAAQA,KAAI;AAAA,MAC5B;AACA,UAAI,aAAa,OAAOA,KAAI,QAAQ,UAAU;AAC1C,oBAAYA,KAAI,QAAQ;AAAA,MAC5B;AACA,UAAI,aAAa,MAAM,QAAQA,KAAI,OAAO,GAAG;AACzC,oBAAYA,KAAI,QAAQ,SAAS,QAAQ;AAAA,MAC7C;AACA,UAAI,aAAa,QAAQ,SAAS;AAC9B,oBAAYA,KAAI,QAAQ,aAAaA,KAAI,QAAQ;AAAA,MACrD;AACA,UAAI,WAAW;AACX,gBAAQ,KAAK;AAAA,UACT,KAAK;AACD,wBAAYA,KAAI,QAAQ;AACxB;AAAA,UACJ,KAAK;AACD,wBAAYA,KAAI,QAAQ;AACxB;AAAA,UACJ,KAAK;AACD,wBAAYA,KAAI,QAAQ;AACxB;AAAA,UACJ,KAAK;AACD,wBAAYA,KAAI,QAAQ;AACxB;AAAA,QACR;AAAA,MACJ;AACA,aAAO;AAAA,IACX,CAAC;AACD,UAAM,EAAE,GAAG,KAAK,OAAO,IAAI;AAC3B,QAAI,WAAW,GAAG;AACd,YAAM,IAAI,kBAAkB;AAAA,IAChC;AACA,QAAI,WAAW,GAAG;AACd,YAAM,QAAQ,IAAI,yBAAyB;AAC3C,YAAM,EAAE,QAAQ,IAAI;AACpB,YAAM,OAAO,aAAa,IAAI,mBAAmB;AAC7C,mBAAWA,QAAO,YAAY;AAC1B,cAAI;AACA,kBAAM,MAAM,mBAAmB,SAASA,MAAK,GAAG;AAAA,UACpD,QACM;AAAA,UAAE;AAAA,QACZ;AAAA,MACJ;AACA,YAAM;AAAA,IACV;AACA,WAAO,mBAAmB,KAAK,SAAS,KAAK,GAAG;AAAA,EACpD;AACJ;AACA,eAAe,mBAAmB,OAAO,KAAK,KAAK;AAC/C,QAAM,SAAS,MAAM,IAAI,GAAG,KAAK,MAAM,IAAI,KAAK,CAAC,CAAC,EAAE,IAAI,GAAG;AAC3D,MAAI,OAAO,GAAG,MAAM,QAAW;AAC3B,UAAM,MAAM,MAAM,UAAU,EAAE,GAAG,KAAK,KAAK,KAAK,GAAG,GAAG;AACtD,QAAI,eAAe,cAAc,IAAI,SAAS,UAAU;AACpD,YAAM,IAAI,YAAY,8CAA8C;AAAA,IACxE;AACA,WAAO,GAAG,IAAI;AAAA,EAClB;AACA,SAAO,OAAO,GAAG;AACrB;AAVe;AAWR,SAAS,kBAAkB,MAAM;AACpC,QAAM,MAAM,IAAI,YAAY,IAAI;AAChC,QAAM,cAAc,8BAAO,iBAAiB,UAAU,IAAI,OAAO,iBAAiB,KAAK,GAAnE;AACpB,SAAO,iBAAiB,aAAa;AAAA,IACjC,MAAM;AAAA,MACF,OAAO,6BAAM,MAAM,IAAI,KAAK,GAArB;AAAA,MACP,YAAY;AAAA,MACZ,cAAc;AAAA,MACd,UAAU;AAAA,IACd;AAAA,EACJ,CAAC;AACD,SAAO;AACX;AAZgB;;;AC3GhB,IAAM,YAAY,8BAAO,KAAK,SAAS,YAAY;AAC/C,MAAI;AACJ,MAAI;AACJ,MAAI,WAAW;AACf,MAAI,OAAO,oBAAoB,YAAY;AACvC,iBAAa,IAAI,gBAAgB;AACjC,SAAK,WAAW,MAAM;AAClB,iBAAW;AACX,iBAAW,MAAM;AAAA,IACrB,GAAG,OAAO;AAAA,EACd;AACA,QAAM,WAAW,MAAM,MAAM,IAAI,MAAM;AAAA,IACnC,QAAQ,aAAa,WAAW,SAAS;AAAA,IACzC,UAAU;AAAA,IACV,SAAS,QAAQ;AAAA,EACrB,CAAC,EAAE,MAAM,CAAC,QAAQ;AACd,QAAI;AACA,YAAM,IAAI,YAAY;AAC1B,UAAM;AAAA,EACV,CAAC;AACD,MAAI,OAAO;AACP,iBAAa,EAAE;AACnB,MAAI,SAAS,WAAW,KAAK;AACzB,UAAM,IAAI,UAAU,yDAAyD;AAAA,EACjF;AACA,MAAI;AACA,WAAO,MAAM,SAAS,KAAK;AAAA,EAC/B,QACM;AACF,UAAM,IAAI,UAAU,4DAA4D;AAAA,EACpF;AACJ,GA/BkB;AAgClB,IAAO,qBAAQ;;;AC7Bf,SAAS,sBAAsB;AAC3B,SAAQ,OAAO,kBAAkB,eAC5B,OAAO,cAAc,eAAe,QACpC,OAAO,gBAAgB,eAAe,gBAAgB;AAC/D;AAJS;AAKT,IAAI;AACJ,IAAI,OAAO,cAAc,eAAe,CAAC,sBAAqB,aAAa,cAAc,GAAG;AACxF,QAAM,OAAO;AACb,QAAM,UAAU;AAChB,eAAa,GAAG,IAAI,IAAI,OAAO;AACnC;AACO,IAAM,YAAY,OAAO;AAChC,SAAS,iBAAiB,OAAO,aAAa;AAC1C,MAAI,OAAO,UAAU,YAAY,UAAU,MAAM;AAC7C,WAAO;AAAA,EACX;AACA,MAAI,EAAE,SAAS,UAAU,OAAO,MAAM,QAAQ,YAAY,KAAK,IAAI,IAAI,MAAM,OAAO,aAAa;AAC7F,WAAO;AAAA,EACX;AACA,MAAI,EAAE,UAAU,UACZ,CAAC,SAAS,MAAM,IAAI,KACpB,CAAC,MAAM,QAAQ,MAAM,KAAK,IAAI,KAC9B,CAAC,MAAM,UAAU,MAAM,KAAK,MAAM,KAAK,MAAM,QAAQ,GAAG;AACxD,WAAO;AAAA,EACX;AACA,SAAO;AACX;AAdS;AAeT,IAAM,eAAN,MAAmB;AAAA,EA/BnB,OA+BmB;AAAA;AAAA;AAAA,EACf,YAAY,KAAK,SAAS;AACtB,QAAI,EAAE,eAAe,MAAM;AACvB,YAAM,IAAI,UAAU,gCAAgC;AAAA,IACxD;AACA,SAAK,OAAO,IAAI,IAAI,IAAI,IAAI;AAC5B,SAAK,WAAW,EAAE,OAAO,SAAS,OAAO,SAAS,SAAS,QAAQ;AACnE,SAAK,mBACD,OAAO,SAAS,oBAAoB,WAAW,SAAS,kBAAkB;AAC9E,SAAK,oBACD,OAAO,SAAS,qBAAqB,WAAW,SAAS,mBAAmB;AAChF,SAAK,eAAe,OAAO,SAAS,gBAAgB,WAAW,SAAS,cAAc;AACtF,QAAI,UAAU,SAAS,MAAM,QAAW;AACpC,WAAK,SAAS,UAAU,SAAS;AACjC,UAAI,iBAAiB,UAAU,SAAS,GAAG,KAAK,YAAY,GAAG;AAC3D,aAAK,iBAAiB,KAAK,OAAO;AAClC,aAAK,SAAS,kBAAkB,KAAK,OAAO,IAAI;AAAA,MACpD;AAAA,IACJ;AAAA,EACJ;AAAA,EACA,cAAc;AACV,WAAO,OAAO,KAAK,mBAAmB,WAChC,KAAK,IAAI,IAAI,KAAK,iBAAiB,KAAK,oBACxC;AAAA,EACV;AAAA,EACA,QAAQ;AACJ,WAAO,OAAO,KAAK,mBAAmB,WAChC,KAAK,IAAI,IAAI,KAAK,iBAAiB,KAAK,eACxC;AAAA,EACV;AAAA,EACA,MAAM,OAAO,iBAAiB,OAAO;AACjC,QAAI,CAAC,KAAK,UAAU,CAAC,KAAK,MAAM,GAAG;AAC/B,YAAM,KAAK,OAAO;AAAA,IACtB;AACA,QAAI;AACA,aAAO,MAAM,KAAK,OAAO,iBAAiB,KAAK;AAAA,IACnD,SACO,KAAK;AACR,UAAI,eAAe,mBAAmB;AAClC,YAAI,KAAK,YAAY,MAAM,OAAO;AAC9B,gBAAM,KAAK,OAAO;AAClB,iBAAO,KAAK,OAAO,iBAAiB,KAAK;AAAA,QAC7C;AAAA,MACJ;AACA,YAAM;AAAA,IACV;AAAA,EACJ;AAAA,EACA,MAAM,SAAS;AACX,QAAI,KAAK,iBAAiB,oBAAoB,GAAG;AAC7C,WAAK,gBAAgB;AAAA,IACzB;AACA,UAAM,UAAU,IAAI,QAAQ,KAAK,SAAS,OAAO;AACjD,QAAI,cAAc,CAAC,QAAQ,IAAI,YAAY,GAAG;AAC1C,cAAQ,IAAI,cAAc,UAAU;AACpC,WAAK,SAAS,UAAU,OAAO,YAAY,QAAQ,QAAQ,CAAC;AAAA,IAChE;AACA,SAAK,kBAAkB,KAAK,gBAAgB,mBAAU,KAAK,MAAM,KAAK,kBAAkB,KAAK,QAAQ,EAChG,KAAK,CAACC,UAAS;AAChB,WAAK,SAAS,kBAAkBA,KAAI;AACpC,UAAI,KAAK,QAAQ;AACb,aAAK,OAAO,MAAM,KAAK,IAAI;AAC3B,aAAK,OAAO,OAAOA;AAAA,MACvB;AACA,WAAK,iBAAiB,KAAK,IAAI;AAC/B,WAAK,gBAAgB;AAAA,IACzB,CAAC,EACI,MAAM,CAAC,QAAQ;AAChB,WAAK,gBAAgB;AACrB,YAAM;AAAA,IACV,CAAC;AACD,UAAM,KAAK;AAAA,EACf;AACJ;AACO,SAAS,mBAAmB,KAAK,SAAS;AAC7C,QAAM,MAAM,IAAI,aAAa,KAAK,OAAO;AACzC,QAAM,eAAe,8BAAO,iBAAiB,UAAU,IAAI,OAAO,iBAAiB,KAAK,GAAnE;AACrB,SAAO,iBAAiB,cAAc;AAAA,IAClC,aAAa;AAAA,MACT,KAAK,6BAAM,IAAI,YAAY,GAAtB;AAAA,MACL,YAAY;AAAA,MACZ,cAAc;AAAA,IAClB;AAAA,IACA,OAAO;AAAA,MACH,KAAK,6BAAM,IAAI,MAAM,GAAhB;AAAA,MACL,YAAY;AAAA,MACZ,cAAc;AAAA,IAClB;AAAA,IACA,QAAQ;AAAA,MACJ,OAAO,6BAAM,IAAI,OAAO,GAAjB;AAAA,MACP,YAAY;AAAA,MACZ,cAAc;AAAA,MACd,UAAU;AAAA,IACd;AAAA,IACA,WAAW;AAAA,MACP,KAAK,6BAAM,CAAC,CAAC,IAAI,eAAZ;AAAA,MACL,YAAY;AAAA,MACZ,cAAc;AAAA,IAClB;AAAA,IACA,MAAM;AAAA,MACF,OAAO,6BAAM,IAAI,QAAQ,KAAK,GAAvB;AAAA,MACP,YAAY;AAAA,MACZ,cAAc;AAAA,MACd,UAAU;AAAA,IACd;AAAA,EACJ,CAAC;AACD,SAAO;AACX;AAjCgB;;;ACtGT,IAAMC,UAAmB;;;ACEzB,SAAS,UAAU,KAAK;AAC3B,MAAI,OAAO,QAAQ;AACf,UAAM,IAAI,WAAW,+DAA+D;AACxF,QAAM,EAAE,GAAG,SAAS,OAAO,IAAI,IAAI,MAAM,GAAG;AAC5C,MAAI,WAAW;AACX,UAAM,IAAI,WAAW,0DAA0D;AACnF,MAAI,WAAW;AACX,UAAM,IAAI,WAAW,aAAa;AACtC,MAAI,CAAC;AACD,UAAM,IAAI,WAAW,6BAA6B;AACtD,MAAI;AACJ,MAAI;AACA,cAAUC,QAAU,OAAO;AAAA,EAC/B,QACM;AACF,UAAM,IAAI,WAAW,wCAAwC;AAAA,EACjE;AACA,MAAI;AACJ,MAAI;AACA,aAAS,KAAK,MAAM,QAAQ,OAAO,OAAO,CAAC;AAAA,EAC/C,QACM;AACF,UAAM,IAAI,WAAW,6CAA6C;AAAA,EACtE;AACA,MAAI,CAAC,SAAS,MAAM;AAChB,UAAM,IAAI,WAAW,wBAAwB;AACjD,SAAO;AACX;AA3BgB;;;ACAhB,IAAM,WAAkD;AAAA,EACtD,OAAO;AAAA,EACP,YAAY;AAAA,EACZ,QAAQ;AACV;AAEO,SAAS,cAAc,WAAiD;AAC7E,QAAM,aAAa,UAAU,KAAK,EAAE,YAAY;AAChD,MAAI,CAAC,WAAY,QAAO;AACxB,SAAO,SAAS,UAAU,KAAK;AACjC;AAJgB;AAYT,SAAS,qBAAqB,QAA0B;AAC7D,QAAM,QAAS,OAAe,SAAS,OAAO,OAAO;AAGrD,QAAM,cAAyB,MAAM,QAAS,OAAe,KAAK,IAC7D,OAAe,QAChB,MAAM,QAAS,OAAe,MAAM,IACnC,OAAe,SAChB,CAAC;AACL,QAAM,WAAqB,YAAY,IAAI,CAACC,OAAM,OAAOA,EAAC,CAAC;AAE3D,QAAM,QAAQ,oBAAI,IAA2B;AAC7C,aAAWA,MAAK,UAAU;AACxB,UAAM,YAAY,cAAcA,EAAC;AACjC,QAAI,WAAW;AACb,YAAM,IAAI,SAAS;AAAA,IACrB;AAAA,EACF;AAIA,QAAM,gBAA2B,MAAM,QAAS,OAAe,MAAM,IAChE,OAAe,SAChB,CAAC;AACL,QAAM,SAAmB,cAAc,IAAI,CAACC,OAAM,OAAOA,EAAC,CAAC;AAE3D,QAAM,aAAuB,OAC1B,OAAO,CAACA,OAAcA,GAAE,WAAW,SAAS,CAAC,EAC7C,IAAI,CAACA,OAAcA,GAAE,MAAM,UAAU,MAAM,CAAC;AAE/C,QAAM,kBAA6B,MAAM,QAAS,OAAe,SAAS,IACrE,OAAe,YAChB,CAAC;AACL,QAAM,YAAsB,gBAAgB,IAAI,CAAC,OAAO,OAAO,EAAE,CAAC;AAElE,QAAM,YAAY,MAAM,KAAK,oBAAI,IAAY,CAAC,GAAG,YAAY,GAAG,SAAS,CAAC,CAAC;AAE3E,SAAO,EAAE,OAAO,OAAO,MAAM,KAAK,KAAK,GAAG,UAAU;AACtD;AAtCgB;AAwCT,SAAS,WAAW,MAAoB;AAC7C,MAAI,KAAK,MAAM,SAAS,OAAO,EAAG,QAAO;AACzC,MAAI,KAAK,MAAM,SAAS,QAAQ,EAAG,QAAO;AAC1C,MAAI,KAAK,MAAM,SAAS,YAAY,EAAG,QAAO;AAE9C,SAAO;AACT;AANgB;;;AC9ChB,IAAM,iBAA2C;AAAA,EAC/C,OAAO;AAAA,EACP,MAAM;AAAA,EACN,MAAM;AAAA,EACN,OAAO;AACT;AAEA,IAAM,oBAAsC;AAAA,EAC1C,UAAU;AAAA,EACV,WAAW;AAAA,EACX,OAAO;AACT;AAEA,IAAI,gBAA+B;AAAA,EACjC,OAAO;AAAA,EACP,iBAAiB;AAAA,EACjB,WAAW;AACb;AAEA,IAAI,oBAAoB;AAkBxB,IAAM,aAAN,MAAM,YAA6B;AAAA,EArDnC,OAqDmC;AAAA;AAAA;AAAA,EAChB;AAAA,EAEjB,YAAY,OAAkB,CAAC,GAAG;AAChC,SAAK,OAAO,eAAe,IAAI;AAAA,EACjC;AAAA,EAEA,MAAMC,UAAiB,QAAoB;AACzC,QAAI,CAAC,UAAU,OAAO,EAAG;AACzB,SAAK,KAAK,SAASA,UAAS,MAAM;AAAA,EACpC;AAAA,EAEA,KAAKA,UAAiB,QAAoB;AACxC,QAAI,CAAC,UAAU,MAAM,EAAG;AACxB,SAAK,KAAK,QAAQA,UAAS,MAAM;AAAA,EACnC;AAAA,EAEA,KAAKA,UAAiB,QAAoB;AACxC,QAAI,CAAC,UAAU,MAAM,EAAG;AACxB,SAAK,KAAK,QAAQA,UAAS,MAAM;AAAA,EACnC;AAAA,EAEA,MAAMA,UAAiB,QAAoB;AACzC,QAAI,CAAC,UAAU,OAAO,EAAG;AACzB,SAAK,KAAK,SAASA,UAAS,MAAM;AAAA,EACpC;AAAA,EAEA,KAAK,OAA0B;AAC7B,UAAM,SAAoB,EAAE,GAAG,KAAK,MAAM,GAAG,eAAe,KAAK,EAAE;AACnE,WAAO,IAAI,YAAW,MAAM;AAAA,EAC9B;AAAA,EAEQ,KAAK,OAAiBA,UAAiB,QAAoB;AACjE,UAAM,QAAkB;AAAA,MACtB,KAAI,oBAAI,KAAK,GAAE,YAAY;AAAA,MAC3B;AAAA,MACA,KAAKA;AAAA,MACL,GAAG,KAAK;AAAA,MACR,GAAG,eAAgB,UAAU,CAAC,CAAe;AAAA,IAC/C;AAEA,QAAI,MAAM,iBAAiB,OAAO;AAChC,YAAM,QAAQ,eAAe,MAAM,KAAK;AAAA,IAC1C,WAAW,MAAM,SAAS,OAAO,MAAM,UAAU,UAAU;AACzD,YAAM,QAAQ,mBAAmB,MAAM,KAAgC;AAAA,IACzE;AAEA,aAAS,eAAe,KAAK,CAAC;AAAA,EAChC;AACF;AAEA,IAAM,iBAAiB,oBAAI,QAAyB;AAE7C,SAAS,kBAAkB,KAAc,KAAU,OAA2B;AACnF,0BAAwB,GAAG;AAC3B,QAAM,OAAkB;AAAA,IACtB,YAAY,gBAAgB,GAAG;AAAA,IAC/B,QAAQ,IAAI;AAAA,IACZ,MAAM,SAAS,IAAI,GAAG;AAAA,IACtB,MAAM,SAAS,IAAI,GAAG;AAAA,IACtB,YAAY,aAAa,KAAK,YAAY;AAAA,IAC1C,WAAW,aAAa,KAAK,kBAAkB;AAAA,IAC/C,QAAQ,aAAa,KAAK,QAAQ;AAAA,IAClC,GAAG,eAAgB,SAAS,CAAC,CAAe;AAAA,EAC9C;AAEA,QAAM,SAAS,IAAI,WAAW,IAAI;AAClC,iBAAe,IAAI,KAAK,MAAM;AAC9B,SAAO;AACT;AAhBgB;AAkBT,SAAS,iBAAiB,KAAc,OAA2B;AACxE,QAAM,WAAW,eAAe,IAAI,GAAG;AACvC,MAAI,UAAU;AACZ,WAAO,SAAS,OAAO,KAAK,KAAK,EAAE,SAAS,SAAS,KAAK,KAAK,IAAI;AAAA,EACrE;AAEA,QAAM,SAAS,IAAI,WAAW,eAAgB,SAAS,CAAC,CAAe,CAAC;AACxE,iBAAe,IAAI,KAAK,MAAM;AAC9B,SAAO;AACT;AATgB;AAWT,SAAS,qBAAqB,KAAc;AACjD,iBAAe,OAAO,GAAG;AAC3B;AAFgB;AAIT,SAAS,aAAa,OAA2B;AACtD,SAAO,IAAI,WAAW,EAAE,OAAO,UAAU,GAAG,eAAgB,SAAS,CAAC,CAAe,EAAE,CAAC;AAC1F;AAFgB;AAIT,SAAS,eAAe,KAAc;AAC3C,MAAI,eAAe,OAAO;AACxB,WAAO;AAAA,MACL,MAAM,IAAI;AAAA,MACV,SAAS,IAAI;AAAA,MACb,OAAO,IAAI;AAAA,IACb;AAAA,EACF;AACA,MAAI,OAAO,QAAQ,UAAU;AAC3B,WAAO,EAAE,SAAS,IAAI;AAAA,EACxB;AACA,MAAI,OAAO,QAAQ,YAAY,QAAQ,MAAM;AAC3C,UAAM,MAAM;AACZ,WAAO;AAAA,MACL,MAAM,OAAO,IAAI,SAAS,WAAW,IAAI,OAAO;AAAA,MAChD,SAAS,OAAO,IAAI,YAAY,WAAW,IAAI,UAAU,KAAK,UAAU,GAAG;AAAA,IAC7E;AAAA,EACF;AACA,SAAO,EAAE,SAAS,OAAO,GAAG,EAAE;AAChC;AAnBgB;AAqBhB,SAAS,mBAAmB,WAAoC;AAC9D,QAAM,aAAsC,CAAC;AAC7C,aAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,SAAS,GAAG;AACpD,QAAI,iBAAiB,OAAO;AAC1B,iBAAW,GAAG,IAAI,eAAe,KAAK;AAAA,IACxC,WAAW,OAAO,UAAU,UAAU;AACpC,iBAAW,GAAG,IAAI,MAAM,SAAS;AAAA,IACnC,OAAO;AACL,iBAAW,GAAG,IAAI;AAAA,IACpB;AAAA,EACF;AACA,SAAO;AACT;AAZS;AAcT,SAAS,eAAe,QAA8B;AACpD,QAAM,SAAoB,CAAC;AAC3B,aAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,MAAM,GAAG;AACjD,QAAI,UAAU,OAAW;AACzB,QAAI,OAAO,UAAU,UAAU;AAC7B,aAAO,GAAG,IAAI,MAAM,SAAS;AAAA,IAC/B,WAAW,iBAAiB,OAAO;AACjC,aAAO,GAAG,IAAI,eAAe,KAAK;AAAA,IACpC,OAAO;AACL,aAAO,GAAG,IAAI;AAAA,IAChB;AAAA,EACF;AACA,SAAO;AACT;AAbS;AAeT,SAAS,SAAS,KAAa;AAC7B,MAAI;AACF,WAAO,IAAI,IAAI,GAAG,EAAE;AAAA,EACtB,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AANS;AAQT,SAAS,SAAS,KAAa;AAC7B,MAAI;AACF,WAAO,IAAI,IAAI,GAAG,EAAE;AAAA,EACtB,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AANS;AAQT,SAAS,aAAa,KAAc,KAAa;AAC/C,QAAM,QAAQ,IAAI,QAAQ,IAAI,GAAG;AACjC,SAAO,SAAS;AAClB;AAHS;AAKT,SAAS,gBAAgB,KAAc;AACrC,QAAM,WAAW,IAAI,QAAQ,IAAI,cAAc,KAAK,IAAI,QAAQ,IAAI,QAAQ;AAC5E,MAAI,SAAU,QAAO;AACrB,MAAI,OAAO,QAAQ,eAAe,YAAY;AAC5C,WAAO,OAAO,WAAW;AAAA,EAC3B;AACA,SAAO,OAAO,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,MAAM,CAAC,CAAC;AACjE;AAPS;AAST,SAAS,SAAS,OAAiB;AACjC,MAAI;AACF,YAAQ,IAAI,KAAK,UAAU,OAAO,QAAQ,CAAC;AAAA,EAC7C,SAAS,KAAK;AACZ,YAAQ;AAAA,MACN,KAAK,UAAU;AAAA,QACb,KAAI,oBAAI,KAAK,GAAE,YAAY;AAAA,QAC3B,OAAO;AAAA,QACP,KAAK;AAAA,QACL,kBAAkB,MAAM;AAAA,QACxB,OAAO,eAAe,GAAG;AAAA,MAC3B,CAAC;AAAA,IACH;AAAA,EACF;AACF;AAdS;AAgBT,SAAS,SAAS,MAAc,OAAgB;AAC9C,MAAI,iBAAiB,MAAO,QAAO,eAAe,KAAK;AACvD,MAAI,OAAO,UAAU,SAAU,QAAO,MAAM,SAAS;AACrD,MAAI,OAAO,UAAU,WAAY,QAAO;AACxC,MAAI,iBAAiB,SAAS;AAC5B,WAAO,EAAE,QAAQ,MAAM,QAAQ,KAAK,MAAM,IAAI;AAAA,EAChD;AACA,MAAI,iBAAiB,UAAU;AAC7B,WAAO,EAAE,QAAQ,MAAM,OAAO;AAAA,EAChC;AACA,SAAO;AACT;AAXS;AAaT,SAAS,UAAU,OAA0B;AAC3C,MAAI,eAAe,KAAK,IAAI,eAAe,cAAc,KAAK,GAAG;AAC/D,WAAO;AAAA,EACT;AACA,MAAI,UAAU,WAAW,cAAc,kBAAkB,GAAG;AAC1D,WAAO,KAAK,OAAO,IAAI,cAAc;AAAA,EACvC;AACA,SAAO;AACT;AARS;AAUT,SAAS,eAAe,OAA2B;AACjD,QAAM,EAAE,UAAU,IAAI;AACtB,MAAI,CAAC,UAAU,YAAY,CAAC,UAAU,aAAa,CAAC,UAAU,OAAO;AACnE,WAAO;AAAA,EACT;AACA,QAAMC,SAAkB,EAAE,GAAG,MAAM;AACnC,MAAI,UAAU,YAAY,eAAeA,QAAO;AAC9C,IAAAA,OAAM,YAAY;AAAA,EACpB;AACA,MAAI,UAAU,aAAa,gBAAgBA,QAAO;AAChD,IAAAA,OAAM,aAAa;AAAA,EACrB;AACA,MAAI,UAAU,SAAS,YAAYA,QAAO;AACxC,IAAAA,OAAM,SAAS;AAAA,EACjB;AACA,SAAOA;AACT;AAhBS;AAkBF,SAAS,iBAAiB,SAAiC;AAChE,MAAI,QAAQ,MAAO,eAAc,QAAQ,QAAQ;AACjD,MAAI,OAAO,QAAQ,oBAAoB,YAAY,QAAQ,kBAAkB,GAAG;AAC9E,kBAAc,kBAAkB,KAAK,IAAI,QAAQ,iBAAiB,CAAC;AAAA,EACrE;AACA,MAAI,QAAQ,WAAW;AACrB,kBAAc,YAAY;AAAA,MACxB,GAAG,cAAc;AAAA,MACjB,GAAG,QAAQ;AAAA,IACb;AAAA,EACF;AACF;AAXgB;AAahB,SAAS,cAAc,WAAgD;AACrE,MAAI,CAAC,UAAW,QAAO;AACvB,QAAM,aAAa,UAAU,KAAK,EAAE,YAAY;AAChD,MAAI,eAAe,WAAW,eAAe,UAAU,eAAe,UAAU,eAAe,SAAS;AACtG,WAAO;AAAA,EACT;AACA,SAAO;AACT;AAPS;AAST,SAAS,gBAAgB,KAAwC;AAC/D,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,SAAS,OAAO,GAAG;AACzB,MAAI,CAAC,OAAO,SAAS,MAAM,EAAG,QAAO;AACrC,MAAI,UAAU,EAAG,QAAO;AACxB,SAAO,SAAS,IAAI,IAAI;AAC1B;AANS;AAQF,SAAS,wBAAwB,KAAU;AAChD,MAAI,kBAAmB;AACvB,sBAAoB;AACpB,QAAM,QAAQ,cAAc,IAAI,SAAS;AACzC,QAAM,aAAa,gBAAgB,IAAI,qBAAqB;AAC5D,mBAAiB;AAAA,IACf,OAAO,SAAS,cAAc;AAAA,IAC9B,iBAAiB,cAAc,cAAc;AAAA,IAC7C,WAAW;AAAA,MACT,UAAU,YAAY,IAAI,oBAAoB;AAAA,MAC9C,WAAW,YAAY,IAAI,qBAAqB;AAAA,MAChD,OAAO,YAAY,IAAI,iBAAiB;AAAA,IAC1C;AAAA,EACF,CAAC;AACH;AAdgB;AA0BhB,SAAS,YAAY,OAAyB;AAC5C,MAAI,OAAO,UAAU,SAAU,QAAO;AACtC,QAAM,aAAa,MAAM,KAAK,EAAE,YAAY;AAC5C,MAAI,CAAC,WAAY,QAAO;AACxB,SAAO,eAAe,UAAU,eAAe,OAAO,eAAe,SAAS,eAAe;AAC/F;AALS;;;AC3UT,IAAMC,aAAY,oBAAI,IAAmD;AACzE,IAAM,eAAe,oBAAI,QAGvB;AACF,IAAM,mBAAmB,oBAAI,QAA8B;AAC3D,IAAM,kBAAkB,oBAAI,IAAI,CAAC,KAAK,SAAS,OAAO,IAAI,CAAC;AAC3D,IAAM,iBAAiB,oBAAI,IAAI,CAAC,KAAK,QAAQ,MAAM,KAAK,CAAC;AACzD,IAAM,gBAAsD,CAAC,SAAS,UAAU,YAAY;AAC5F,IAAMC,yBAAwB,oBAAI,IAAI,CAAC,eAAe,OAAO,OAAO,CAAC;AAErE,SAAS,iBAAiB,KAAc,MAAmB;AACzD,mBAAiB,IAAI,KAAK,IAAI;AAChC;AAFS;AAIT,SAAS,qBAAqB,KAAuC;AACnE,SAAO,iBAAiB,IAAI,GAAG;AACjC;AAFS;AAIF,SAAS,QAAQ,KAAU;AAChC,QAAM,MAAM,IAAI;AAChB,MAAI,CAACD,WAAU,IAAI,GAAG,GAAG;AACvB,IAAAA,WAAU,IAAI,KAAK,mBAAmB,IAAI,IAAI,GAAG,CAAC,CAAC;AAAA,EACrD;AACA,SAAOA,WAAU,IAAI,GAAG;AAC1B;AANgB;AAQhB,SAAS,eAAe,KAAuB;AAC7C,QAAM,WAAW,OAAO,IAAI,mBAAmB,WAAW,IAAI,iBAAiB;AAC/E,QAAM,UAAU,OAAO,IAAI,0BAA0B,WAAW,IAAI,wBAAwB;AAC5F,QAAM,SAAS,aAAa,IAAI,GAAG;AACnC,MAAI,UAAU,OAAO,YAAY,YAAY,OAAO,YAAY,SAAS;AACvE,WAAO,OAAO;AAAA,EAChB;AAEA,QAAM,iBAAiB,SAAS,KAAK,EAAE,YAAY,KAAK;AACxD,MAAI,CAAC,kBAAkB,gBAAgB,IAAI,cAAc,KAAK,CAAC,eAAe,IAAI,cAAc,GAAG;AACjG,iBAAa,IAAI,KAAK,EAAE,SAAS,UAAU,SAAS,MAAM,KAAK,CAAC;AAChE,WAAO;AAAA,EACT;AAEA,MAAI,CAAC,UAAU;AACb,iBAAa,IAAI,KAAK,EAAE,SAAS,MAAM,SAAS,MAAM,KAAK,CAAC;AAC5D,WAAO;AAAA,EACT;AAEA,QAAM,UAAU,SAAS,KAAK;AAC9B,MAAI,CAAC,WAAW,gBAAgB,IAAI,QAAQ,YAAY,CAAC,GAAG;AAC1D,iBAAa,IAAI,KAAK,EAAE,SAAS,UAAU,SAAS,MAAM,KAAK,CAAC;AAChE,WAAO;AAAA,EACT;AAEA,MAAI,SAAkB;AACtB,MAAI;AACF,aAAS,KAAK,MAAM,OAAO;AAAA,EAC7B,QAAQ;AAAA,EAER;AAEA,MAAI,QAAQ;AACZ,MAAI,QAAuB,CAAC,OAAO;AACnC,MAAI,YAAsB,CAAC;AAE3B,MAAI,OAAO,WAAW,UAAU;AAC9B,UAAM,YAAY,OAAO,KAAK;AAC9B,QAAI,WAAW;AACb,cAAQ;AAAA,IACV;AAAA,EACF,WAAW,UAAU,OAAO,WAAW,UAAU;AAC/C,UAAM,iBAAkB,OAA+B;AACvD,QAAI,OAAO,mBAAmB,YAAY,eAAe,KAAK,GAAG;AAC/D,cAAQ,eAAe,KAAK;AAAA,IAC9B;AAEA,UAAM,iBAAkB,OAA+B;AACvD,QAAI,MAAM,QAAQ,cAAc,GAAG;AACjC,YAAM,aAAa,eAChB,IAAI,CAAC,SAAU,OAAO,SAAS,WAAW,KAAK,KAAK,EAAE,YAAY,IAAI,EAAG,EACzE,OAAO,CAAC,SAAS,KAAK,SAAS,CAAC;AACnC,YAAM,WAAW,WACd,IAAI,CAAC,SAAS,cAAc,KAAK,CAAC,YAAY,YAAY,IAAI,CAAC,EAC/D,OAAO,CAAC,SAAwC,QAAQ,IAAI,CAAC;AAChE,UAAI,SAAS,SAAS,GAAG;AACvB,gBAAQ,MAAM,KAAK,IAAI,IAAI,QAAQ,CAAC;AAAA,MACtC;AAAA,IACF;AAEA,UAAM,qBAAsB,OAAmC;AAC/D,QAAI,MAAM,QAAQ,kBAAkB,GAAG;AACrC,YAAM,aAAa,mBAChB,IAAI,CAAC,OAAQ,OAAO,OAAO,WAAW,GAAG,KAAK,IAAI,EAAG,EACrD,OAAO,CAAC,OAAO,GAAG,SAAS,CAAC;AAC/B,UAAI,WAAW,SAAS,GAAG;AACzB,oBAAY,MAAM,KAAK,IAAI,IAAI,UAAU,CAAC;AAAA,MAC5C;AAAA,IACF;AAAA,EACF,OAAO;AACL,UAAM,YAAY,OAAO,MAAM,EAAE,KAAK;AACtC,QAAI,WAAW;AACb,cAAQ;AAAA,IACV;AAAA,EACF;AAEA,QAAM,OAAa,EAAE,OAAO,OAAO,UAAU;AAC7C,eAAa,IAAI,KAAK,EAAE,SAAS,UAAU,SAAS,KAAK,CAAC;AAC1D,SAAO;AACT;AA/ES;AAiFT,eAAsB,kBAAkB,KAAc,KAAgC;AACpF,QAAM,SAAS,qBAAqB,GAAG;AACvC,MAAI,WAAW,QAAW;AACxB,WAAO;AAAA,EACT;AAEA,QAAM,MAAM,IAAI,QAAQ,IAAI,yBAAyB;AACrD,MAAI,KAAK;AACP,QAAI;AACF,YAAM,EAAE,QAAQ,IAAI,MAAM,UAAU,KAAK,QAAQ,GAAG,GAAG,EAAE,UAAU,IAAI,WAAW,CAAC;AACnF,YAAM,OAAO,qBAAqB,OAAqB;AACvD,uBAAiB,KAAK,IAAI;AAC1B,aAAO;AAAA,IACT,SAAS,OAAO;AACd,YAAM,MAAM,iBAAiB,KAAK,EAAE,OAAO,SAAS,CAAC;AACrD,YAAM,UAAU,cAAc,GAAG;AACjC,YAAM,SAAS,iBAAiB,QAAQ,MAAM,UAAU,OAAO,KAAK;AACpE,YAAM,cAAc,IAAI,QAAQ,IAAI,oCAAoC;AACxE,YAAM,eACJ,OAAO,SAAS,UAAU,WAAW,QAAQ,QAC7C,OAAO,SAAS,QAAQ,WAAW,QAAQ,MAC3C;AACF,YAAM,iBAAiB,oBAAoB,eAAe,YAAY;AACtE,YAAM,QAAQ,IAAI,QAAQ,IAAI,QAAQ;AACtC,YAAM,YAAqC;AAAA,QACzC;AAAA,QACA,UAAU,IAAI;AAAA,QACd,QAAQ,SAAS;AAAA,QACjB,QAAQ;AAAA,QACR,YAAY;AAAA,QACZ,OAAO;AAAA,MACT;AACA,YAAM,gBAAgB,kBAAkB,SAAS,GAAG;AACpD,UAAI,eAAe;AACjB,kBAAU,iBAAiB;AAAA,MAC7B;AACA,UAAI,gBAAgB;AAClB,kBAAU,kBAAkB;AAAA,MAC9B;AACA,UAAI,KAAK,4BAA4B,SAAS;AAAA,IAChD;AAAA,EACF;AAEA,QAAM,cACJ,OAAO,IAAI,gBAAgB,WAAW,IAAI,YAAY,KAAK,EAAE,YAAY,IAAI;AAC/E,QAAM,wBAAwB,YAAY,SAAS,KAAKC,uBAAsB,IAAI,WAAW;AAC7F,QAAM,cACJ,OAAO,IAAI,0BAA0B,YACrC,IAAI,sBAAsB,KAAK,EAAE,SAAS,KAC1C,eAAe,IAAI,IAAI,sBAAsB,KAAK,EAAE,YAAY,CAAC;AAEnE,MAAI,eAAe,CAAC,uBAAuB;AACzC,qBAAiB,KAAK,EAAE,OAAO,SAAS,CAAC,EAAE,KAAK,2BAA2B;AAAA,MACzE,aAAa,eAAe;AAAA,IAC9B,CAAC;AACD,qBAAiB,KAAK,IAAI;AAC1B,WAAO;AAAA,EACT;AAEA,MAAI,CAAC,uBAAuB;AAC1B,qBAAiB,KAAK,IAAI;AAC1B,WAAO;AAAA,EACT;AAEA,QAAM,UAAU,eAAe,GAAG;AAClC,MAAI,SAAS;AACX,qBAAiB,KAAK,EAAE,OAAO,SAAS,CAAC,EAAE,KAAK,wBAAwB;AAAA,MACtE,OAAO,QAAQ;AAAA,MACf;AAAA,IACF,CAAC;AACD,qBAAiB,KAAK,OAAO;AAC7B,WAAO;AAAA,EACT;AAEA,mBAAiB,KAAK,IAAI;AAC1B,SAAO;AACT;AA5EsB;AA8Ef,SAAS,YAAY,MAAY;AACtC,SAAO,KAAK,OAAO,SAAS,OAAO,KAAK;AAC1C;AAFgB;AAMhB,SAAS,cAAc,OAAkC;AACvD,MAAI;AACF,WAAO,UAAU,KAAK;AAAA,EACxB,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AANS;AAQT,SAAS,kBAAkB,KAA4C;AACrE,MAAI,CAAC,IAAK,QAAO;AACjB,MAAI,OAAO,QAAQ,SAAU,QAAO;AACpC,MAAI,MAAM,QAAQ,GAAG,EAAG,QAAO,IAAI,KAAK,GAAG;AAC3C,SAAO;AACT;AALS;AAOT,SAAS,oBAAoB,WAAwC;AACnE,MAAI,OAAO,cAAc,SAAU,QAAO;AAC1C,QAAM,UAAU,UAAU,KAAK,EAAE,YAAY;AAC7C,MAAI,CAAC,QAAS,QAAO;AACrB,QAAM,QAAQ,QAAQ,MAAM,GAAG;AAC/B,MAAI,MAAM,WAAW,EAAG,QAAO;AAC/B,QAAM,CAAC,cAAc,SAAS,IAAI;AAClC,QAAM,SAAS,UAAU,KAAK;AAC9B,MAAI,CAAC,OAAQ,QAAO;AACpB,QAAM,YAAY,aAAa,KAAK;AACpC,MAAI,CAAC,UAAW,QAAO,KAAK,MAAM;AAClC,MAAI,UAAU,WAAW,EAAG,QAAO,KAAK,MAAM;AAC9C,MAAI,UAAU,WAAW,EAAG,QAAO,GAAG,UAAU,CAAC,CAAC,KAAK,MAAM;AAC7D,SAAO,GAAG,UAAU,CAAC,CAAC,MAAM,UAAU,MAAM,EAAE,CAAC,IAAI,MAAM;AAC3D;AAdS;;;ACjNT,IAAM,gBAAgB;AACtB,IAAM,gBACJ;AAEK,IAAM,YAAoC;AAAA,EAC/C,+BAA+B;AAAA,EAC/B,gCAAgC;AAAA,EAChC,gCAAgC;AAClC;AAQA,SAAS,WAAW,SAAkB,OAAe;AACnD,QAAM,WAAW,QAAQ,IAAI,MAAM;AACnC,MAAI,CAAC,UAAU;AACb,YAAQ,IAAI,QAAQ,KAAK;AACzB;AAAA,EACF;AACA,QAAM,QAAQ,SACX,MAAM,GAAG,EACT,IAAI,CAAC,UAAU,MAAM,KAAK,CAAC,EAC3B,OAAO,OAAO;AACjB,MAAI,CAAC,MAAM,KAAK,CAAC,UAAU,MAAM,YAAY,MAAM,MAAM,YAAY,CAAC,GAAG;AACvE,UAAM,KAAK,KAAK;AAChB,YAAQ,IAAI,QAAQ,MAAM,KAAK,IAAI,CAAC;AAAA,EACtC;AACF;AAdS;AAgBT,SAAS,oBAAoB,KAAsD;AACjF,QAAM,MAAM,IAAI;AAChB,MAAI,OAAO,QAAQ,UAAU;AAC3B,WAAO,EAAE,SAAS,CAAC,GAAG,YAAY,MAAM;AAAA,EAC1C;AACA,QAAM,UAAU,IACb,MAAM,WAAW,EACjB,IAAI,CAAC,UAAU,MAAM,KAAK,CAAC,EAC3B,OAAO,OAAO;AACjB,SAAO,EAAE,SAAS,YAAY,QAAQ,SAAS,EAAE;AACnD;AAVS;AAYT,SAAS,cAAc,QAAgB,MAAc;AACnD,MAAI,SAAS,IAAK,QAAO;AACzB,QAAM,aAAa,OAAO,YAAY;AACtC,QAAM,WAAW,KAAK,YAAY;AAClC,MAAI,SAAS,WAAW,IAAI,GAAG;AAC7B,UAAM,SAAS,SAAS,MAAM,CAAC;AAC/B,WAAO,WAAW,SAAS,MAAM;AAAA,EACnC;AACA,SAAO,eAAe;AACxB;AATS;AAWF,SAAS,aAAa,KAAc,KAA0B;AACnE,QAAM,SAAS,IAAI,QAAQ,IAAI,QAAQ;AACvC,QAAM,EAAE,SAAS,gBAAgB,WAAW,IAAI,oBAAoB,GAAG;AACvE,MAAI,CAAC,YAAY;AACf,WAAO,EAAE,SAAS,OAAO,QAAQ,UAAU,MAAM,aAAa,KAAK;AAAA,EACrE;AACA,MAAI,CAAC,QAAQ;AACX,UAAM,WAAW,eAAe,SAAS,GAAG;AAC5C,WAAO;AAAA,MACL,SAAS;AAAA,MACT,QAAQ;AAAA,MACR,aAAa,WAAW,MAAM;AAAA,IAChC;AAAA,EACF;AAEA,aAAW,aAAa,gBAAgB;AACtC,QAAI,cAAc,QAAQ,SAAS,GAAG;AACpC,YAAM,cAAc,cAAc,MAAM,MAAM;AAC9C,aAAO,EAAE,SAAS,MAAM,QAAQ,YAAY;AAAA,IAC9C;AAAA,EACF;AAEA,SAAO,EAAE,SAAS,OAAO,QAAQ,aAAa,KAAK;AACrD;AAvBgB;AAyBT,SAAS,SACd,KACA,KACA,KACA,YACA;AACA,QAAM,SAAS,cAAc,aAAa,KAAK,GAAG;AAClD,QAAM,UAAU,IAAI,QAAQ,IAAI,OAAO;AACvC,MAAI,OAAO,aAAa;AACtB,YAAQ,IAAI,+BAA+B,OAAO,WAAW;AAAA,EAC/D,OAAO;AACL,YAAQ,OAAO,6BAA6B;AAAA,EAC9C;AACA,UAAQ,IAAI,gCAAgC,aAAa;AACzD,UAAQ,IAAI,gCAAgC,aAAa;AACzD,aAAW,SAAS,QAAQ;AAC5B,SAAO,IAAI,SAAS,IAAI,MAAM;AAAA,IAC5B;AAAA,IACA,QAAQ,IAAI;AAAA,IACZ,YAAY,IAAI;AAAA,EAClB,CAAC;AACH;AArBgB;AAuBT,SAAS,qBAAqB,KAAc,UAAkB,KAAU;AAC7E,MAAI,IAAI,WAAW,UAAW,QAAO;AAErC,MACE,SAAS,WAAW,cAAc,KAClC,SAAS,WAAW,iBAAiB,KACrC,kCAAkC,KAAK,QAAQ,GAC/C;AACA,UAAM,aAAa,aAAa,KAAK,GAAG;AACxC,QAAI,CAAC,WAAW,SAAS;AACvB,aAAO;AAAA,QACL;AAAA,QACA;AAAA,QACA,KAAK,EAAE,OAAO,qBAAqB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,QACrD;AAAA,MACF;AAAA,IACF;AACA,UAAM,UAAU,IAAI,QAAQ;AAAA,MAC1B,gCAAgC;AAAA,MAChC,gCAAgC;AAAA,MAChC,0BAA0B;AAAA,IAC5B,CAAC;AACD,eAAW,SAAS,QAAQ;AAC5B,QAAI,WAAW,aAAa;AAC1B,cAAQ,IAAI,+BAA+B,WAAW,WAAW;AAAA,IACnE;AACA,WAAO,oBAAoB,IAAI,SAAS,IAAI,EAAE,QAAQ,KAAK,QAAQ,CAAC,CAAC;AAAA,EACvE;AACA,SAAO;AACT;AA7BgB;;;AC1GhB,IAAqoB,IAAE,wBAAC,EAAC,MAAK,IAAE,IAAG,QAAOC,KAAE,CAAC,GAAE,GAAGC,GAAC,IAAE,CAAC,OAAK,EAAC,WAAU,IAAI,MAAM,CAAC,GAAE,EAAC,KAAI,wBAACA,IAAEC,IAAE,GAAE,MAAI,CAACD,OAAK,MAAID,GAAE,KAAK,CAACE,GAAE,cAAc,GAAE,OAAO,KAAK,KAAG,IAAED,IAAG,QAAQ,cAAa,IAAI,GAAG,QAAQ,qBAAoB,cAAc,EAAE,QAAQ,mBAAkB,qBAAqB,EAAE,QAAQ,OAAM,KAAK,EAAE,QAAQ,YAAW,SAAS,CAAC,KAAK,GAAE,GAAE,CAAC,CAAC,KAAG,GAA5P,OAA6P,CAAC,GAAE,QAAOD,IAAE,GAAGC,IAAE,MAAM,MAAME,OAAKD,IAAE;AAAC,MAAI,GAAE,GAAE,IAAE,IAAI,IAAIC,GAAE,GAAG,GAAE,IAAEA,GAAE,QAAM,EAAC,WAAU,KAAI;AAAE,WAAO,CAACA,IAAEH,EAAC,KAAI,EAAE,aAAa,GAAEG,EAAC,IAAE,EAAEA,EAAC,IAAE,CAAC,EAAE,OAAO,EAAEA,EAAC,GAAEH,EAAC,IAAEA;AAAE,IAAE,KAAG;AAAC,aAAQA,MAAKC,GAAE,UAAQ,CAAC,EAAE,KAAG,SAAO,IAAE,MAAMD,GAAEG,GAAE,SAAOA,IAAE,GAAGD,EAAC,GAAG,OAAM;AAAE,MAAE,UAAO,CAACD,IAAEG,IAAE,GAAE,CAAC,KAAIJ,GAAE,MAAIC,MAAGE,GAAE,UAAQ,SAAOF,QAAK,IAAE,EAAE,SAAS,MAAMG,EAAC,IAAG;AAAC,MAAAD,GAAE,SAAO,EAAE,UAAQ,CAAC,GAAEA,GAAE,QAAM;AAAE,eAAQH,MAAK,EAAE,KAAG,SAAO,IAAE,MAAMA,GAAEG,GAAE,SAAOA,IAAE,GAAGD,EAAC,GAAG,OAAM;AAAA,IAAC;AAAA,EAAC,SAAOF,IAAE;AAAC,QAAG,CAACC,GAAE,MAAM,OAAMD;AAAE,QAAE,MAAMC,GAAE,MAAMD,IAAEG,GAAE,SAAOA,IAAE,GAAGD,EAAC;AAAA,EAAC;AAAC,MAAG;AAAC,aAAQF,MAAKC,GAAE,WAAS,CAAC,EAAE,KAAE,MAAMD,GAAE,GAAEG,GAAE,SAAOA,IAAE,GAAGD,EAAC,KAAG;AAAA,EAAC,SAAOF,IAAE;AAAC,QAAG,CAACC,GAAE,MAAM,OAAMD;AAAE,QAAE,MAAMC,GAAE,MAAMD,IAAEG,GAAE,SAAOA,IAAE,GAAGD,EAAC;AAAA,EAAC;AAAC,SAAO;AAAC,EAAC,IAAn5B;AAAvoB,IAA6hD,IAAE,wBAAC,IAAE,6BAA4BF,OAAI,CAACC,IAAEC,KAAE,CAAC,MAAI;AAAC,MAAG,WAASD,MAAGA,cAAa,SAAS,QAAOA;AAAE,QAAM,IAAE,IAAI,SAASD,KAAIC,EAAC,KAAGA,IAAEC,GAAE,MAAI,SAAOA,EAAC;AAAE,SAAO,EAAE,QAAQ,IAAI,gBAAe,CAAC,GAAE;AAAC,GAAnL;AAA/hD,IAAotD,IAAE,EAAE,mCAAkC,KAAK,SAAS;AAA0qB,IAAkD,IAAE,EAAE,6BAA4B,MAAM;AAAxF,IAA0F,IAAE,EAAE,WAAW;AAAzG,IAA2G,IAAE,EAAE,YAAY;AAA3H,IAA6H,IAAE,EAAE,WAAW;AAA5I,IAA8I,IAAE,EAAE,YAAY;;;ACA/kF,eAAsB,UAAU,OAAe;AAC9C,QAAM,OAAO,IAAI,YAAY,EAAE,OAAO,KAAK;AAC3C,QAAM,SAAS,MAAM,OAAO,OAAO,OAAO,WAAW,IAAI;AACzD,SAAO,CAAC,GAAG,IAAI,WAAW,MAAM,CAAC,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AACxF;AAJuB;AAMhB,SAAS,WAAWG,MAAa;AACtC,QAAM,aAAaA,KAAI,QAAQ,QAAQ,EAAE,EAAE,YAAY;AACvD,MAAI,WAAW,SAAS,MAAM,GAAG;AAC/B,UAAM,IAAI,MAAM,qCAAqC;AAAA,EACvD;AACA,QAAM,QAAQ,IAAI,WAAW,WAAW,SAAS,CAAC;AAClD,WAAS,IAAI,GAAG,IAAI,WAAW,QAAQ,KAAK,GAAG;AAC7C,UAAM,OAAO,OAAO,SAAS,WAAW,MAAM,GAAG,IAAI,CAAC,GAAG,EAAE;AAC3D,QAAI,OAAO,MAAM,IAAI,GAAG;AACtB,YAAM,IAAI,MAAM,oBAAoB;AAAA,IACtC;AACA,UAAM,IAAI,CAAC,IAAI;AAAA,EACjB;AACA,SAAO;AACT;AAdgB;AAgBT,SAAS,WAAW,OAAmB;AAC5C,SAAO,CAAC,GAAG,KAAK,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AACvE;AAFgB;AAIhB,eAAsB,cAAc,QAAgB,SAAiB;AACnE,QAAM,WAAW,WAAW,MAAM;AAClC,QAAM,YAAY,MAAM,OAAO,OAAO;AAAA,IACpC;AAAA,IACA;AAAA,IACA,EAAE,MAAM,QAAQ,MAAM,UAAU;AAAA,IAChC;AAAA,IACA,CAAC,MAAM;AAAA,EACT;AACA,QAAM,OAAO,IAAI,YAAY,EAAE,OAAO,OAAO;AAC7C,QAAM,YAAY,MAAM,OAAO,OAAO,KAAK,QAAQ,WAAW,IAAI;AAClE,SAAO,WAAW,IAAI,WAAW,SAAS,CAAC;AAC7C;AAZsB;AAcf,SAAS,gBAAgB,GAAW,GAAW;AACpD,QAAM,MAAM,KAAK,IAAI,EAAE,QAAQ,EAAE,MAAM;AACvC,MAAI,WAAW,EAAE,WAAW,EAAE,SAAS,IAAI;AAC3C,WAAS,IAAI,GAAG,IAAI,KAAK,KAAK;AAC5B,UAAM,KAAK,IAAI,EAAE,SAAS,EAAE,WAAW,CAAC,IAAI;AAC5C,UAAM,KAAK,IAAI,EAAE,SAAS,EAAE,WAAW,CAAC,IAAI;AAC5C,gBAAY,KAAK;AAAA,EACnB;AACA,SAAO,aAAa;AACtB;AATgB;AAWT,SAAS,MAAM,GAAY,IAAY;AAC5C,MAAI,OAAO,MAAM,YAAY,OAAO,MAAM,CAAC,EAAG,QAAO;AACrD,QAAMC,KAAI,KAAK,IAAI,IAAI,EAAE;AACzB,SAAO,KAAK,MAAM,IAAIA,EAAC,IAAIA;AAC7B;AAJgB;AAMT,SAAS,SAAS;AACvB,UAAO,oBAAI,KAAK,GAAE,YAAY;AAChC;AAFgB;AAIT,SAAS,OAAO,IAA+B;AACpD,MAAI,CAAC,GAAI,QAAO;AAChB,MAAI,GAAG,UAAU,EAAG,QAAO;AAC3B,SAAO,GAAG,MAAM,GAAG,CAAC,IAAI,QAAQ,GAAG,MAAM,EAAE;AAC7C;AAJgB;AAMT,SAAS,gBAAgB,IAAY;AAC1C,QAAM,KAAK,KAAK,MAAM,EAAE;AACxB,MAAI,OAAO,MAAM,EAAE,EAAG,QAAO,EAAE,IAAI,OAAgB,QAAQ,oBAAoB;AAC/E,QAAM,MAAM,KAAK,IAAI;AACrB,QAAM,QAAQ,IAAI,KAAK;AACvB,QAAM,SAAS,MAAM,KAAK,KAAK,KAAK;AACpC,MAAI,KAAK,MAAM,MAAO,QAAO,EAAE,IAAI,OAAgB,QAAQ,8BAA8B;AACzF,MAAI,KAAK,MAAM,OAAQ,QAAO,EAAE,IAAI,OAAgB,QAAQ,oBAAoB;AAChF,SAAO,EAAE,IAAI,MAAe,GAAG;AACjC;AATgB;AAiBT,SAAS,WAAW,MAAoC;AAC7D,MAAI,CAAC,KAAM,QAAO;AAClB,MAAI;AACF,WAAO,mBAAmB,IAAI;AAAA,EAChC,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAPgB;AAST,SAAS,gBAAgB,MAAkB;AAChD,MAAI,SAAS;AACb,aAAW,QAAQ,KAAM,WAAU,OAAO,aAAa,IAAI;AAC3D,SAAO,KAAK,MAAM,EAAE,QAAQ,OAAO,GAAG,EAAE,QAAQ,OAAO,GAAG,EAAE,QAAQ,QAAQ,EAAE;AAChF;AAJgB;AAMT,SAAS,gBAAgB,OAAkC;AAChE,MAAI;AACF,QAAI,aAAa,MAAM,QAAQ,MAAM,GAAG,EAAE,QAAQ,MAAM,GAAG;AAC3D,WAAO,WAAW,SAAS,EAAG,eAAc;AAC5C,UAAM,SAAS,KAAK,UAAU;AAC9B,UAAM,MAAM,IAAI,WAAW,OAAO,MAAM;AACxC,aAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,IAAK,KAAI,CAAC,IAAI,OAAO,WAAW,CAAC;AACpE,WAAO;AAAA,EACT,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAXgB;AAaT,SAAS,SAAS,OAAe,QAAgB;AACtD,SAAO,QAAQ,GAAG,KAAK,QAAQ,MAAM,KAAK,SAAS,MAAM;AAC3D;AAFgB;AAIT,SAAS,gBAAgB,SAA8C;AAC5E,MAAI,CAAC,QAAS,QAAO,CAAC;AACtB,MAAI;AACF,UAAM,SAAS,KAAK,MAAM,OAAO;AACjC,WAAO,MAAM,QAAQ,MAAM,IAAI,OAAO,OAAO,CAACC,OAAM,OAAOA,OAAM,QAAQ,IAAI,CAAC;AAAA,EAChF,QAAQ;AACN,WAAO,CAAC;AAAA,EACV;AACF;AARgB;AAUT,SAAS,iBAAiB,SAAyD;AACxF,MAAI,CAAC,QAAS,QAAO,CAAC;AACtB,MAAI;AACF,UAAM,SAAS,KAAK,MAAM,OAAO;AACjC,WAAO,OAAO,WAAW,YAAY,WAAW,OAAQ,SAAiC,CAAC;AAAA,EAC5F,QAAQ;AACN,WAAO,CAAC;AAAA,EACV;AACF;AARgB;;;AC3HhB,IAAM,iBAAiB,oBAAI,IAAgC;AAE3D,SAAS,mBAAmB,KAAU;AACpC,QAAM,SAAS,IAAI;AACnB,MAAI,CAAC,UAAU,OAAO,SAAS,IAAI;AACjC,UAAM,IAAI,MAAM,qDAAqD;AAAA,EACvE;AACA,SAAO;AACT;AANS;AAQT,eAAe,gBAAgB,QAAgB;AAC7C,MAAI,CAAC,eAAe,IAAI,MAAM,GAAG;AAC/B,UAAMC,WAAU,IAAI,YAAY;AAChC,UAAM,aAAa,MAAM,OAAO,OAAO,OAAO,WAAWA,SAAQ,OAAO,MAAM,CAAC;AAC/E,UAAM,aAAa,OAAO,OAAO;AAAA,MAC/B;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,CAAC,WAAW,SAAS;AAAA,IACvB;AACA,mBAAe,IAAI,QAAQ,UAAU;AAAA,EACvC;AACA,SAAO,eAAe,IAAI,MAAM;AAClC;AAde;AAgBf,eAAsB,aAAa,KAAU,UAAkB;AAC7D,QAAM,SAAS,mBAAmB,GAAG;AACrC,QAAM,MAAM,MAAM,gBAAgB,MAAM;AACxC,QAAM,KAAK,OAAO,gBAAgB,IAAI,WAAW,EAAE,CAAC;AACpD,QAAMA,WAAU,IAAI,YAAY;AAChC,QAAM,aAAa,MAAM,OAAO,OAAO;AAAA,IACrC,EAAE,MAAM,WAAW,GAAG;AAAA,IACtB;AAAA,IACAA,SAAQ,OAAO,QAAQ;AAAA,EACzB;AACA,SAAO,OAAO,gBAAgB,EAAE,CAAC,IAAI,gBAAgB,IAAI,WAAW,UAAU,CAAC,CAAC;AAClF;AAXsB;AAatB,eAAsB,eAAe,KAAU,OAAe;AAC5D,QAAM,SAAS,mBAAmB,GAAG;AACrC,QAAM,MAAM,MAAM,gBAAgB,MAAM;AACxC,QAAM,CAAC,EAAE,QAAQ,QAAQ,IAAI,MAAM,MAAM,KAAK,CAAC;AAC/C,MAAI,CAAC,UAAU,CAAC,SAAU,QAAO;AACjC,QAAM,UAAU,gBAAgB,MAAM;AACtC,QAAM,eAAe,gBAAgB,QAAQ;AAC7C,MAAI,CAAC,WAAW,CAAC,aAAc,QAAO;AACtC,QAAM,WAAW,IAAI,YAAY,QAAQ,MAAM;AAC/C,MAAI,WAAW,QAAQ,EAAE,IAAI,OAAO;AACpC,QAAM,gBAAgB,IAAI,YAAY,aAAa,MAAM;AACzD,MAAI,WAAW,aAAa,EAAE,IAAI,YAAY;AAC9C,MAAI;AACF,UAAM,QAAQ,MAAM,OAAO,OAAO,QAAQ,EAAE,MAAM,WAAW,IAAI,SAAS,GAAG,KAAK,aAAa;AAC/F,WAAO,IAAI,YAAY,EAAE,OAAO,KAAK;AAAA,EACvC,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAlBsB;AAoBtB,eAAsB,cACpB,SACA,KACA,SAC0D;AAC1D,MAAI,CAAC,QAAS,QAAO,EAAE,IAAI,MAAM,IAAI,KAAK;AAC1C,MAAI,CAAC,QAAQ,WAAW,MAAM,GAAG;AAC/B,WAAO,UAAU,EAAE,IAAI,MAAM,IAAI,QAAQ,IAAI,EAAE,IAAI,MAAM;AAAA,EAC3D;AACA,MAAI;AACF,UAAM,WAAW,MAAM,eAAe,KAAK,OAAO;AAClD,QAAI,CAAC,SAAU,QAAO,EAAE,IAAI,MAAM;AAClC,WAAO,EAAE,IAAI,MAAM,IAAI,SAAS;AAAA,EAClC,QAAQ;AACN,WAAO,EAAE,IAAI,MAAM;AAAA,EACrB;AACF;AAhBsB;;;ACzDf,SAAS,iBAAiB,MAAY,QAAQ,KAAK;AACxD,QAAM,UAAU,YAAY,IAAI;AAChC,MAAI,SAAS;AACX,WAAO,EAAE,SAAS,MAAM,OAAO,OAAO,QAAQ,IAAI,MAAM,CAAC,EAAW;AAAA,EACtE;AACA,QAAM,MAAM,KAAK,aAAa,CAAC;AAC/B,MAAI,CAAC,IAAI,QAAQ;AACf,WAAO,EAAE,SAAS,OAAO,OAAO,MAAM,QAAQ,IAAI,MAAM,CAAC,EAAW;AAAA,EACtE;AACA,QAAM,eAAe,IAAI,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AAChD,SAAO;AAAA,IACL,SAAS;AAAA,IACT,OAAO;AAAA,IACP,QAAQ,GAAG,KAAK,mBAAmB,YAAY;AAAA,IAC/C,MAAM,CAAC,GAAG,GAAG;AAAA,EACf;AACF;AAhBgB;AAkBT,SAAS,gBAAgB,IAAY,SAAkB;AAC5D,SAAO,UAAU,KAAK,OAAO,EAAE;AACjC;AAFgB;AAIhB,eAAsB,gBAAgB,KAAa,KAAU,SAA0C;AACrG,MAAI,QAAS,QAAO;AACpB,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,SAAS,MAAM,cAAc,KAAK,KAAK,OAAO;AACpD,MAAI,CAAC,OAAO,MAAM,CAAC,OAAO,GAAI,QAAO;AACrC,SAAO,OAAO;AAChB;AANsB;AAQtB,eAAsB,kBAAkB,IAAY,KAAU,SAAkB;AAC9E,SAAO,UAAU,KAAK,aAAa,KAAK,EAAE;AAC5C;AAFsB;AAItB,eAAsB,qBAAqB,KAAU,UAAkB,WAAmB;AACxF,QAAM,IAAI,GAAG;AAAA,IACX;AAAA,EACF,EAAE,KAAK,UAAU,SAAS,EAAE,IAAI;AAEhC,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,qDAAqD,EAC7D,KAAK,QAAQ,EACb,MAAsC;AAEzC,MAAI,CAAC,IAAK,QAAO,EAAE,IAAI,OAAgB,QAAQ,iBAAiB;AAChE,MAAI,IAAI,cAAc,IAAI,eAAe,WAAW;AAClD,WAAO,EAAE,IAAI,OAAgB,QAAQ,oBAAoB,OAAO,IAAI,WAAW;AAAA,EACjF;AACA,SAAO,EAAE,IAAI,KAAc;AAC7B;AAfsB;AA2BtB,eAAsB,gBACpB,KACA,UACA,WACgC;AAChC,MAAI,CAAC,UAAW,QAAO,EAAE,IAAI,OAAO,QAAQ,cAAc;AAC1D,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,0DAA0D,EAClE,KAAK,QAAQ,EACb,MAAoC;AACvC,MAAI,CAAC,IAAK,QAAO,EAAE,IAAI,OAAO,QAAQ,iBAAiB;AACvD,MAAI,CAAC,IAAI,gBAAiB,QAAO,EAAE,IAAI,OAAO,QAAQ,qBAAqB;AAC3E,QAAM,OAAO,MAAM,UAAU,SAAS;AACtC,MAAI,KAAK,YAAY,MAAM,OAAO,IAAI,eAAe,EAAE,YAAY,GAAG;AACpE,WAAO,EAAE,IAAI,OAAO,QAAQ,WAAW;AAAA,EACzC;AACA,SAAO,EAAE,IAAI,MAAM,eAAe,KAAK;AACzC;AAjBsB;AA2BtB,eAAsB,gBAAgB,KAAU,WAAuD;AACrG,MAAI,CAAC,UAAU,OAAQ,QAAO,oBAAI,IAAI;AACtC,QAAM,SAAS,CAAC,GAAG,IAAI,IAAI,SAAS,CAAC;AACrC,QAAM,eAAe,OAAO,IAAI,CAAC,GAAG,QAAQ,IAAI,MAAM,CAAC,EAAE,EAAE,KAAK,GAAG;AACnE,QAAM,OAAO,MAAM,IAAI,GACpB;AAAA,IACC;AAAA;AAAA,8BAEwB,YAAY;AAAA,EACtC,EACC,KAAK,GAAG,MAAM,EACd,IAAgB;AAEnB,QAAM,MAAM,oBAAI,IAAwB;AACxC,aAAW,OAAO,KAAK,WAAW,CAAC,GAAG;AACpC,QAAI,IAAI,IAAI,WAAW,GAAG;AAAA,EAC5B;AACA,SAAO;AACT;AAlBsB;;;AC3FtB,SAAS,aAAa,OAAgB;AACpC,MAAI,UAAU,UAAa,UAAU,KAAM,QAAO;AAClD,MAAI,OAAO,UAAU,SAAU,QAAO;AACtC,MAAI,OAAO,UAAU,UAAU;AAC7B,UAAM,UAAU,MAAM,KAAK;AAC3B,QAAI,YAAY,GAAI,QAAO;AAC3B,UAAM,SAAS,OAAO,OAAO;AAC7B,WAAO,OAAO,SAAS,MAAM,IAAI,SAAS,OAAO;AAAA,EACnD;AACA,SAAO,OAAO;AAChB;AAVS;AAYF,SAAS,aAAa,SAK1B;AACD,MAAI,SAAS,iBAAE,OAAO;AACtB,MAAI,QAAQ,QAAS,UAAS,OAAO,IAAI;AACzC,MAAI,QAAQ,QAAQ,OAAW,UAAS,OAAO,IAAI,QAAQ,GAAG;AAC9D,MAAI,QAAQ,QAAQ,OAAW,UAAS,OAAO,IAAI,QAAQ,GAAG;AAE9D,QAAM,iBAAiB,iBAAE,WAAW,cAAc,MAAM;AACxD,SAAO,QAAQ,iBAAiB,SAC5B,eAAe,QAAQ,QAAQ,YAAY,IAC3C,eAAe,SAAS;AAC9B;AAfgB;AA8CT,IAAM,sBAAsB,iBAChC,WAAW,CAAC,UAAmB;AAC9B,MAAI,UAAU,UAAa,UAAU,KAAM,QAAO;AAClD,MAAI,OAAO,UAAU,UAAW,QAAO;AACvC,MAAI,OAAO,UAAU,SAAU,QAAO,UAAU;AAChD,MAAI,OAAO,UAAU,UAAU;AAC7B,UAAM,UAAU,MAAM,KAAK,EAAE,YAAY;AACzC,QAAI,YAAY,GAAI,QAAO;AAC3B,QAAI,YAAY,OAAO,YAAY,UAAU,YAAY,MAAO,QAAO;AACvE,QAAI,YAAY,OAAO,YAAY,WAAW,YAAY,KAAM,QAAO;AAAA,EACzE;AACA,SAAO;AACT,GAAG,iBAAE,QAAQ,CAAC,EACb,SAAS;AAEL,IAAM,wBAAwB,iBAClC,WAAW,CAAC,UAAmB;AAC9B,MAAI,UAAU,UAAa,UAAU,KAAM,QAAO;AAClD,MAAI,OAAO,UAAU,SAAU,QAAO;AACtC,QAAM,UAAU,MAAM,KAAK;AAC3B,SAAO,YAAY,KAAK,SAAY;AACtC,GAAG,iBAAE,OAAO,EAAE,IAAI,GAAG,mBAAmB,CAAC,EACxC,SAAS;;;AC/EL,IAAM,2BAA2B,iBACrC,OAAO;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAC3E,CAAC,EACA,OAAO;;;ACKH,SAAS,aAAa,OAAsC;AACjE,SAAO,MAAM,OAAO,IAAI,CAAC,WAAuB;AAAA,IAC9C,MAAM,MAAM,KAAK,SAAS,MAAM,KAAK,KAAK,GAAG,IAAI;AAAA,IACjD,SAAS,MAAM;AAAA,EACjB,EAAE;AACJ;AALgB;AAOT,SAAS,mBACd,QACA,SACsB;AACtB,MAAI,CAAC,QAAQ;AACX,WAAO;AAAA,MACL,SAAS;AAAA,MACT,QAAQ,CAAC,EAAE,MAAM,QAAQ,SAAS,yBAAyB,CAAC;AAAA,IAC9D;AAAA,EACF;AAEA,QAAM,SAAS,OAAO,UAAU,OAAO;AACvC,MAAI,OAAO,SAAS;AAClB,WAAO,EAAE,SAAS,MAAM,MAAM,OAAO,KAAK;AAAA,EAC5C;AACA,SAAO,EAAE,SAAS,OAAO,QAAQ,aAAa,OAAO,KAAK,EAAE;AAC9D;AAhBgB;AAkBT,SAAS,wBACd,QACA,MACU;AACV,QAAM,UAAU,kBAAkB,iBAAE,WAAW,aAAa,MAAM,IAAI;AACtE,SAAO;AAAA,IACL;AAAA,MACE,OAAO;AAAA,MACP;AAAA,IACF;AAAA,IACA;AAAA,MACE,QAAQ;AAAA,MACR,GAAG;AAAA,IACL;AAAA,EACF;AACF;AAfgB;;;AChChB,IAAM,SAAS;AACR,IAAM,0BAA0B;AAChC,IAAM,wBAAwB,0BAA0B;AAC/D,IAAM,gCAAgC,KAAK,KAAK;AAEhD,IAAI,qBAAqB;AAElB,SAAS,sBAAsB,MAAM,KAAK,IAAI,GAAW;AAC9D,QAAM,UAAU,MAAM;AACtB,SAAO,IAAI,KAAK,OAAO,EAAE,YAAY;AACvC;AAHgB;AAKhB,eAAsB,gBAAgB,KAAU,MAAM,KAAK,IAAI,GAAkB;AAC/E,MAAI,MAAM,qBAAqB,+BAA+B;AAC5D;AAAA,EACF;AACA,uBAAqB;AACrB,QAAM,SAAS,sBAAsB,GAAG;AACxC,MAAI;AACF,UAAM,IAAI,GAAG,QAAQ,uCAAuC,EAAE,KAAK,MAAM,EAAE,IAAI;AAAA,EACjF,SAAS,OAAO;AACd,iBAAa,EAAE,OAAO,cAAc,CAAC,EAAE,KAAK,4BAA4B,EAAE,QAAQ,MAAM,CAAC;AAAA,EAC3F;AACF;AAXsB;AAatB,eAAsB,gBACpB,KACA,OACA,YACA,YACA,UACA,QACe;AACf,MAAI;AACF,UAAM,IAAI,GAAG;AAAA,MACX;AAAA,IACF,EACG,KAAK,OAAO,GAAG,OAAO,YAAY,YAAY,QAAQ,EACtD,IAAI;AAAA,EACT,SAAS,OAAO;AACd,UAAM,WAAW,KAAK,MAAM,KAAK,IAAI,IAAI,GAAM,IAAI;AACnD,UAAM,eAAe,UAAU,aAAa,EAAE,MAAM,CAAC;AACrD,iBAAa,MAAM,6BAA6B;AAAA,MAC9C;AAAA,MACA,aAAa;AAAA,MACb,WAAW,YAAY;AAAA,MACvB,aAAa;AAAA,MACb,QAAQ;AAAA,MACR,YAAY;AAAA,MACZ,OAAO;AAAA,MACP,eAAe,IAAI,KAAK,QAAQ,EAAE,YAAY;AAAA,MAC9C;AAAA,IACF,CAAC;AAAA,EACH;AACF;AA7BsB;;;AChBtB,eAAe,sBACb,KACA,KACA,MACA,UACA;AACA,QAAM,MAAM,iBAAiB,KAAK,EAAE,OAAO,SAAS,CAAC;AACrD,QAAM,QAAQ,iBAAiB,IAAI;AACnC,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,yBAAyB,UAAU;AAAA,IACtD,OAAO,IAAI,aAAa,IAAI,OAAO;AAAA,EACrC,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,MAAM,IAAI,aAAa;AAE/B,QAAM,MAAM,KAAK,IAAI;AACrB,QAAM,cAAc,sBAAsB,GAAG;AAC7C,QAAM,gBAAgB,KAAK,GAAG;AAE9B,MAAI;AACJ,MAAI,MAAM,SAAS;AACjB,cAAU,MAAM,IAAI,GACjB;AAAA,MACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAMF,EACC,IAIE;AAAA,EACP,WAAW,MAAM,OAAO;AACtB,cAAU,EAAE,SAAS,CAAC,EAAW;AAAA,EACnC,OAAO;AACL,UAAM,QAAQ,SAAS,IAAI,MAAM,MAAM;AACvC,cAAU,MAAM,IAAI,GACjB;AAAA,MACC;AAAA;AAAA;AAAA;AAAA,aAIK,KAAK;AAAA;AAAA,IAEZ,EACC,KAAK,GAAG,MAAM,IAAI,EAClB,IAIE;AAAA,EACP;AAEA,MAAI;AACJ,MAAI,MAAM,SAAS;AACjB,cAAU,MAAM,IAAI,GACjB;AAAA,MACC;AAAA;AAAA;AAAA;AAAA;AAAA,IAKF,EACC,KAAK,aAAa,KAAK,EACvB,IAME;AAAA,EACP,WAAW,MAAM,OAAO;AACtB,cAAU,EAAE,SAAS,CAAC,EAAW;AAAA,EACnC,OAAO;AACL,UAAM,eAAe,MAAM,OAAO,QAAQ,UAAU,UAAU;AAC9D,UAAM,QAAQ,SAAS,mBAAmB,YAAY;AACtD,cAAU,MAAM,IAAI,GACjB;AAAA,MACC;AAAA;AAAA;AAAA,aAGK,KAAK;AAAA;AAAA;AAAA,IAGZ,EACC,KAAK,aAAa,GAAG,MAAM,MAAM,KAAK,EACtC,IAME;AAAA,EACP;AAEA,QAAM,MAAM,CAAC;AACb,aAAW,OAAO,QAAQ,WAAW,CAAC,GAAG;AACvC,UAAM,WAAW,IAAI;AACrB,QAAI,cAA6B;AACjC,QAAI,YAA2B;AAC/B,QAAI,UAAU;AACZ,kBAAY,gBAAgB,UAAU,MAAM,OAAO;AACnD,UAAI;AACF,sBAAc,MAAM,kBAAkB,UAAU,KAAK,MAAM,OAAO;AAAA,MACpE,SAAS,KAAK;AACZ,YAAI,MAAM,uBAAuB,EAAE,WAAW,UAAU,OAAO,IAAI,CAAC;AACpE;AAAA,MACF;AAAA,IACF;AAEA,QAAI,KAAK;AAAA,MACP,IAAI,IAAI;AAAA,MACR,OAAO,IAAI;AAAA,MACX,aAAa,IAAI;AAAA,MACjB,aAAa,IAAI;AAAA,MACjB,WAAW;AAAA,MACX,QAAQ;AAAA,IACV,CAAC;AAAA,EACH;AAEA,QAAM,eAAe,IAAI,OAA+B,CAAC,KAAK,SAAS;AACrE,UAAM,SAAS,KAAK,eAAe,MAAM,QAAQ,KAAK,eAAe,MAAM,QAAQ;AACnF,QAAI,MAAM,KAAK,IAAI,MAAM,KAAK,KAAK;AACnC,WAAO;AAAA,EACT,GAAG,CAAC,CAAC;AAEL,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB,OAAO,MAAM,UAAU,UAAU,MAAM,QAAQ,UAAU;AAAA,IACzD,SACE,QAAQ,SAAS,IAAI,CAAC,SAAS;AAAA,MAC7B,YAAY,IAAI,cAAc;AAAA,MAC9B,cAAc,IAAI,gBAAgB;AAAA,MAClC,cAAc,IAAI,gBAAgB;AAAA,IACpC,EAAE,KAAK,CAAC;AAAA,IACV;AAAA,IACA,aAAa;AAAA,IACb,YAAY;AAAA,MACV,OAAO;AAAA,MACP,MAAM;AAAA,IACR;AAAA,EACF,CAAC;AACH;AAnJe;AAqJf,eAAsB,oBAAoB,KAAc,KAAU;AAChE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AACjE,MAAI,CAAC,YAAY,IAAI,EAAG,QAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC3E,SAAO,sBAAsB,KAAK,KAAK,MAAM,qBAAqB;AACpE;AALsB;AAOtB,eAAsB,yBAAyB,KAAc,KAAU;AACrE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AACjE,SAAO,sBAAsB,KAAK,KAAK,MAAM,2BAA2B;AAC1E;AAJsB;;;ACvKf,IAAM,wBAAwB,iBAClC,OAAO;AAAA,EACN,aAAa,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC/C,WAAW,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC7C,UAAU,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC5C,QAAQ,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC1C,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,IAAI,CAAC;AAAA,EAC1E,OAAO,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AAAA,EACtD,OAAO,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AACxD,CAAC,EACA,OAAO;AAEH,IAAM,yBAAyB,iBACnC,OAAO;AAAA,EACN,UAAU,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC5C,UAAU,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC5C,aAAa,iBAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,SAAS;AAAA,EAChD,YAAY,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC9C,QAAQ,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC;AAAA,EAC/B,aAAa,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC/C,WAAW,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC7C,UAAU,iBAAE,OAAO,iBAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EACrC,YAAY,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC9C,YAAY,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AAC7D,CAAC,EACA,OAAO;;;AC4BV,SAAS,YAAY,KAA4B;AAC/C,MAAI,WAA2C;AAC/C,MAAI,IAAI,eAAe;AACrB,QAAI;AACF,YAAM,SAAS,KAAK,MAAM,IAAI,aAAa;AAC3C,UAAI,UAAU,OAAO,WAAW,UAAU;AACxC,mBAAW;AAAA,MACb;AAAA,IACF,QAAQ;AACN,iBAAW;AAAA,IACb;AAAA,EACF;AAEA,SAAO;AAAA,IACL,UAAU,IAAI;AAAA,IACd,UAAU,IAAI;AAAA,IACd,aAAa,IAAI;AAAA,IACjB,YAAY,IAAI;AAAA,IAChB,QAAQ,IAAI;AAAA,IACZ,aAAa,IAAI;AAAA,IACjB,WAAW,IAAI;AAAA,IACf;AAAA,IACA,YAAY,IAAI;AAAA,IAChB,YAAY,IAAI;AAAA,EAClB;AACF;AAzBS;AA2BT,eAAsB,iBACpB,KACA,QAC4B;AAC5B,QAAM,KAAK,OAAO,YAAY,OAAO,WAAW;AAChD,QAAM,YAAY,OAAO,cAAc,OAAO;AAC9C,QAAM,eAAe,OAAO,WAAW,KAAK,UAAU,OAAO,QAAQ,IAAI;AACzE,QAAM,aAAa,OAAO,eAAe;AACzC,QAAM,YAAY,OAAO,cAAc;AACvC,QAAM,aAAa,OAAO,eAAe;AACzC,QAAM,WAAW,OAAO,aAAa;AACrC,QAAM,YAAY,OAAO,cAAc;AAEvC,MAAI;AACF,UAAM,IAAI,GACP;AAAA,MACC;AAAA;AAAA;AAAA;AAAA,IAIF,EACC;AAAA,MACC;AAAA,MACA,OAAO;AAAA,MACP;AAAA,MACA;AAAA,MACA,OAAO;AAAA,MACP;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,EACC,IAAI;AAAA,EACT,SAAS,KAAU;AACjB,UAAMC,WAAU,OAAO,KAAK,YAAY,WAAW,IAAI,UAAU,OAAO,GAAG;AAC3E,QAAIA,SAAQ,SAAS,0BAA0B,GAAG;AAChD,aAAO,EAAE,IAAI,OAAO,QAAQ,WAAW;AAAA,IACzC;AACA,UAAM;AAAA,EACR;AAEA,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,uDAAuD,EAC/D,KAAK,EAAE,EACP,MAAgB;AAEnB,MAAI,CAAC,KAAK;AACR,WAAO,EAAE,IAAI,OAAO,QAAQ,WAAW;AAAA,EACzC;AAEA,SAAO,EAAE,IAAI,MAAM,OAAO,YAAY,GAAG,EAAE;AAC7C;AApDsB;AAsDtB,eAAsB,eACpB,KACA,SACwB;AACxB,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AAErB,MAAI,QAAQ,aAAa;AACvB,YAAQ,SAAS,OAAO,iBAAiB;AACzC,SAAK,KAAK,QAAQ,WAAW;AAAA,EAC/B;AAEA,MAAI,QAAQ,WAAW;AACrB,YAAQ,SAAS,OAAO,eAAe;AACvC,SAAK,KAAK,QAAQ,SAAS;AAAA,EAC7B;AAEA,MAAI,QAAQ,UAAU;AACpB,YAAQ,SAAS,OAAO,cAAc;AACtC,SAAK,KAAK,QAAQ,QAAQ;AAAA,EAC5B;AAEA,MAAI,QAAQ,QAAQ;AAClB,YAAQ,SAAS,OAAO,YAAY;AACpC,SAAK,KAAK,QAAQ,MAAM;AAAA,EAC1B;AAEA,MAAI,QAAQ,OAAO;AACjB,YAAQ,SAAS,OAAO,iBAAiB;AACzC,SAAK,KAAK,QAAQ,KAAK;AAAA,EACzB;AAEA,MAAI,QAAQ,OAAO;AACjB,YAAQ,SAAS,OAAO,iBAAiB;AACzC,SAAK,KAAK,QAAQ,KAAK;AAAA,EACzB;AAEA,QAAM,MAAM,6BAA6B,KAAK;AAC9C,OAAK,KAAK,QAAQ,KAAK;AAEvB,QAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,GAAG,EAAE,KAAK,GAAG,IAAI,EAAE,IAAc;AACnE,UAAQ,KAAK,WAAW,CAAC,GAAG,IAAI,WAAW;AAC7C;AA1CsB;;;AC5HtB,eAAsB,qBAAqB,KAAc,KAAU;AACjE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,QAAQ,CAAC,YAAY,IAAI,GAAG;AAC/B,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,mBAAoC,uBAAuB;AAAA,IAC9E,aAAa,IAAI,aAAa,IAAI,aAAa,KAAK;AAAA,IACpD,WAAW,IAAI,aAAa,IAAI,WAAW,KAAK;AAAA,IAChD,UAAU,IAAI,aAAa,IAAI,UAAU,KAAK;AAAA,IAC9C,QAAQ,IAAI,aAAa,IAAI,QAAQ,KAAK;AAAA,IAC1C,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,IACxC,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,IACxC,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,EAC1C,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,MAAM;AAAA,EACpD;AACA,QAAM,SAAS,aAAa;AAE5B,MAAI,OAAO,SAAS,OAAO,OAAO;AAChC,UAAM,UAAU,KAAK,MAAM,OAAO,KAAK;AACvC,UAAM,UAAU,KAAK,MAAM,OAAO,KAAK;AACvC,QAAI,CAAC,OAAO,MAAM,OAAO,KAAK,CAAC,OAAO,MAAM,OAAO,KAAK,UAAU,SAAS;AACzE,aAAO,KAAK,EAAE,OAAO,gBAAgB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACzD;AAAA,EACF;AAEA,QAAM,QAAQ,OAAO,SAAS;AAE9B,QAAM,UAAU,MAAM,eAAe,KAAK;AAAA,IACxC,aAAa,OAAO,eAAe;AAAA,IACnC,WAAW,OAAO,aAAa;AAAA,IAC/B,UAAU,OAAO,YAAY;AAAA,IAC7B,QAAQ,OAAO,UAAU;AAAA,IACzB,OAAO,OAAO,SAAS;AAAA,IACvB,OAAO,OAAO,SAAS;AAAA,IACvB;AAAA,EACF,CAAC;AAED,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB;AAAA,EACF,CAAC;AACH;AA7CsB;AA+CtB,eAAsB,uBAAuB,KAAc,KAAU;AACnE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AACjE,MAAI,CAAC,YAAY,IAAI,GAAG;AACtB,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,cAAc,mBAA0C,wBAAwB,OAAO;AAC7F,MAAI,CAAC,YAAY,SAAS;AACxB,WAAO,wBAAwB,YAAY,MAAM;AAAA,EACnD;AACA,QAAM,OAAO,YAAY;AAEzB,QAAM,kBAAkB,KAAK;AAC7B,QAAM,qBAAqB,KAAK;AAEhC,MAAI,KAAK,YAAY,KAAK,aAAa,iBAAiB;AACtD,WAAO,KAAK,EAAE,OAAO,0BAA0B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACnE;AACA,MAAI,KAAK,eAAe,KAAK,gBAAgB,oBAAoB;AAC/D,WAAO,KAAK,EAAE,OAAO,0BAA0B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACnE;AAEA,QAAM,KACJ,KAAK,cACL,IAAI,QAAQ,IAAI,kBAAkB,KAClC,IAAI,QAAQ,IAAI,iBAAiB,KACjC;AAEF,QAAM,SAAS,MAAM,iBAAiB,KAAK;AAAA,IACzC,UAAU,KAAK;AAAA,IACf,UAAU;AAAA,IACV,aAAa;AAAA,IACb,YAAY,KAAK,cAAc;AAAA,IAC/B,QAAQ,KAAK;AAAA,IACb,aAAa,KAAK,eAAe;AAAA,IACjC,WAAW,KAAK,aAAa;AAAA,IAC7B,UAAU,KAAK,YAAY;AAAA,IAC3B,YAAY;AAAA,IACZ,YAAY,KAAK;AAAA,EACnB,CAAC;AAED,MAAI,CAAC,OAAO,IAAI;AACd,QAAI,OAAO,WAAW,YAAY;AAChC,aAAO,KAAK,EAAE,OAAO,6BAA6B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACtE;AACA,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,SAAO,KAAK,EAAE,IAAI,MAAM,OAAO,OAAO,MAAM,GAAG,EAAE,QAAQ,IAAI,CAAC;AAChE;AAzDsB;;;ACnBtB,IAAM,yBAAyB;AAC/B,IAAM,kCAAkC;AACxC,IAAM,mBAAmB;AAElB,IAAM,mBAAmB;AAAA,EAC9B,SAAS;AAAA,IACP,eAAe,EAAE,MAAM,KAAK,UAAU,KAAK;AAAA,IAC3C,uBAAuB,EAAE,MAAM,GAAG,UAAU,GAAG;AAAA,EACjD;AAAA,EACA,KAAK;AAAA,IACH,YAAY,EAAE,MAAM,MAAM,UAAU,KAAK;AAAA,IACzC,mBAAmB,EAAE,MAAM,MAAM,UAAU,KAAK;AAAA,IAChD,iBAAiB,EAAE,MAAM,MAAM,UAAU,IAAK;AAAA,EAChD;AAAA,EACA,QAAQ;AAAA,IACN,sBAAsB,EAAE,MAAM,GAAG,UAAU,EAAE;AAAA,IAC7C,uBAAuB,EAAE,MAAM,IAAI,UAAU,IAAI;AAAA,EACnD;AACF;AAEA,SAASC,cAAa,OAAgB,WAAW,GAAW;AAC1D,MAAI,OAAO,UAAU,SAAU,QAAO,OAAO,SAAS,KAAK,IAAI,QAAQ;AACvE,MAAI,OAAO,UAAU,UAAU;AAC7B,UAAM,SAAS,OAAO,KAAK;AAC3B,WAAO,OAAO,SAAS,MAAM,IAAI,SAAS;AAAA,EAC5C;AACA,SAAO;AACT;AAPS,OAAAA,eAAA;AASF,SAAS,kBAAkB,UAAqC,cAAwD;AAC7H,MAAI,aAAa,UAAU,aAAa,OAAQ,QAAO;AACvD,MAAI,OAAO,iBAAiB,YAAY,aAAa,YAAY,EAAE,SAAS,kBAAkB,GAAG;AAC/F,WAAO;AAAA,EACT;AACA,SAAO;AACT;AANgB;AAQT,SAAS,aAAa,SAAkB,SAAiC;AAC9E,MAAI,OAAO,YAAY,YAAY,OAAO,YAAY,SAAU,QAAO;AACvE,SAAO,MAAM,UAAU,SAAS,CAAC;AACnC;AAHgB;AAKT,SAAS,gBAAgB,QAAuB,SAAiC;AACtF,MAAI,WAAW,QAAQ,OAAO,YAAY,SAAU,QAAO;AAC3D,SAAO,MAAM,yBAAyB,kCAAkC,UAAU,QAAQ,CAAC;AAC7F;AAHgB;AAKT,SAAS,UAAU,WAA0B,SAAsE;AACxH,MAAI,cAAc,QAAQ,OAAO,YAAY,YAAY,WAAW,kBAAkB;AACpF,WAAO,EAAE,KAAK,MAAM,SAAS,KAAK;AAAA,EACpC;AACA,SAAO;AAAA,IACL,KAAK,MAAM,YAAY,SAAS,CAAC;AAAA,IACjC,SAAS;AAAA,EACX;AACF;AARgB;AAUT,SAAS,uBAAuB,OAAwC;AAC7E,QAAM,SAAS,aAAa,MAAM,WAAW,MAAM,MAAM,WAAW,IAAI;AACxE,QAAM,YAAY,gBAAgB,QAAQ,MAAM,WAAW,IAAI;AAC/D,QAAM,UAAU,UAAU,WAAW,MAAM,WAAW,IAAI;AAC1D,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA,KAAK,QAAQ;AAAA,IACb,aAAa,QAAQ;AAAA,EACvB;AACF;AAVgB;AAYT,SAAS,oBACd,OACA,SACA,kBAAkB,GAClB,gBACe;AACf,MAAI,OAAO,UAAU,YAAY,OAAO,MAAM,KAAK,EAAG,QAAO;AAC7D,MAAI,SAAS;AACX,WAAO,OAAO,mBAAmB,WAAW,OAAO,MAAM,QAAQ,cAAc,CAAC,IAAI;AAAA,EACtF;AACA,SAAO,OAAO,MAAM,QAAQ,eAAe,CAAC;AAC9C;AAXgB;AAaT,SAAS,uBAAuB,OAA2B;AAChE,QAAM,QAAQ,OAAO,SAAS,MAAM,KAAe,IAAK,MAAM,QAAmB;AACjF,QAAM,SAAS,OAAO,SAAS,MAAM,MAAgB,IAAK,MAAM,SAAoB;AACpF,QAAM,UAAU,KAAK,IAAI,GAAG,QAAQ,MAAM;AAC1C,SAAO,EAAE,OAAO,QAAQ,QAAQ;AAClC;AALgB;AAOT,SAAS,oBAAoB,MAA+C;AACjF,SAAO,KAAK,IAAI,CAAC,QAAQ;AACvB,UAAM,QAAQ,IAAI,SAAS;AAC3B,UAAM,gBACJ,OAAO,IAAI,gBAAgB,WAAW,IAAI,cAAcA,cAAa,IAAI,WAAW;AACtF,UAAM,aAAa,OAAO,SAAS,aAAa,IAAI,KAAK,MAAM,aAAa,IAAI;AAChF,UAAM,QAAQA,cAAa,IAAI,KAAK;AACpC,UAAM,gBAAgBA,cAAa,IAAI,iBAAiB;AACxD,UAAM,cACJ,QAAQ,IAAI,gBAAgB,QAAQA,cAAa,IAAI,eAAe;AACtE,UAAM,cAAcA,cAAa,IAAI,eAAe;AAEpD,WAAO;AAAA,MACL;AAAA,MACA,aAAa;AAAA,MACb;AAAA,MACA,mBAAmB;AAAA,MACnB,iBAAiB;AAAA,MACjB,iBAAiB;AAAA,IACnB;AAAA,EACF,CAAC;AACH;AArBgB;AAuBT,SAAS,oBAAoB,MAA6B;AAC/D,MAAI,QAAQ;AACZ,MAAI,eAAe;AACnB,MAAI,eAAe;AACnB,MAAI,OAAO;AAEX,QAAM,aAKD,CAAC;AACN,QAAM,oBAAkF,CAAC;AAEzF,aAAW,OAAO,MAAM;AACtB,aAAS,IAAI;AACb,QAAI,IAAI,eAAe,KAAK;AAC1B,sBAAgB,IAAI;AACpB,wBAAkB,KAAK;AAAA,QACrB,OAAO,IAAI;AAAA,QACX,aAAa,IAAI;AAAA,QACjB,OAAO,IAAI;AAAA,MACb,CAAC;AAAA,IACH,WAAW,IAAI,eAAe,KAAK;AACjC,sBAAgB,IAAI;AAAA,IACtB;AACA,QAAI,IAAI,mBAAmB,iBAAiB,IAAI,gBAAgB,MAAM;AACpE,cAAQ,IAAI;AACZ,iBAAW,KAAK;AAAA,QACd,OAAO,IAAI;AAAA,QACX,aAAa,IAAI;AAAA,QACjB,iBAAiB,OAAO,IAAI,gBAAgB,QAAQ,CAAC,CAAC;AAAA,QACtD,OAAO,IAAI;AAAA,MACb,CAAC;AAAA,IACH;AAAA,EACF;AAEA,aAAW,KAAK,CAAC,GAAG,MAAM,EAAE,kBAAkB,EAAE,eAAe;AAC/D,oBAAkB,KAAK,CAAC,GAAG,MAAM,EAAE,QAAQ,EAAE,KAAK;AAElD,QAAM,gBAAgB;AACtB,QAAM,cAAc,gBAAgB,IAAI,gBAAgB;AAExD,SAAO;AAAA,IACL,gBAAgB;AAAA,IAChB,mBAAmB,gBAAgB,IAAI,QAAQ,eAAe,aAAa,QAAQ,CAAC,CAAC,IAAI;AAAA,IACzF,mBAAmB,gBAAgB,IAAI,QAAQ,eAAe,aAAa,QAAQ,CAAC,CAAC,IAAI;AAAA,IACzF,WAAW,gBAAgB,IAAI,QAAQ,OAAO,aAAa,QAAQ,CAAC,CAAC,IAAI;AAAA,IACzE,aAAa,WAAW,MAAM,GAAG,CAAC;AAAA,IAClC,yBAAyB,kBAAkB,MAAM,GAAG,CAAC;AAAA,EACvD;AACF;AAnDgB;AAqDT,SAAS,kBACd,SACA,SACA,cAAsB,OAAO,GAC7B;AACA,QAAM,UAAU,uBAAuB,OAAO;AAC9C,QAAM,MAAM,oBAAoB,OAAO;AACvC,QAAM,aAAa,oBAAoB,GAAG;AAC1C,QAAM,eAAe,QAAQ,QAAQ,IAAI,QAAQ,UAAU,QAAQ,QAAQ;AAE3E,SAAO;AAAA,IACL,SAAS;AAAA,MACP,GAAG;AAAA,MACH,eAAe,OAAO,aAAa,QAAQ,CAAC,CAAC;AAAA,IAC/C;AAAA,IACA;AAAA,IACA,aAAa;AAAA,IACb,YAAY;AAAA,IACZ,cAAc;AAAA,EAChB;AACF;AApBgB;AAsBT,SAAS,kBACd,SACA,SACA,cAAsB,KAAK,IAAI,GAC/B;AACA,QAAM,UAAU,uBAAuB,OAAO;AAC9C,QAAM,MAAM,oBAAoB,OAAO;AACvC,QAAM,aAAa,oBAAoB,GAAG;AAC1C,QAAM,eAAe,QAAQ,QAAQ,IAAI,QAAQ,UAAU,QAAQ,QAAQ;AAC3E,QAAM,QAAkB;AAAA,IACtB;AAAA,IACA;AAAA,IACA,0BAA0B,QAAQ,KAAK;AAAA,IACvC;AAAA,IACA;AAAA,IACA,iCAAiC,QAAQ,MAAM;AAAA,IAC/C;AAAA,IACA;AAAA,IACA,kCAAkC,QAAQ,OAAO;AAAA,IACjD;AAAA,IACA;AAAA,IACA,kCAAkC,YAAY;AAAA,IAC9C;AAAA,IACA;AAAA,EACF;AAEA,aAAW,OAAO,KAAK;AACrB,UAAM,aAAa,IAAI,MAAM,QAAQ,MAAM,KAAK;AAChD,UAAM;AAAA,MACJ,sCAAsC,UAAU,aAAa,IAAI,WAAW,MAAM,IAAI,KAAK;AAAA,IAC7F;AAAA,EACF;AAEA,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,EACF;AACA,QAAM,KAAK,iCAAiC,KAAK,MAAM,cAAc,GAAI,CAAC,EAAE;AAC5E,QAAM,KAAK,qFAAqF;AAChG,QAAM,KAAK,oDAAoD;AAC/D,QAAM,KAAK,uCAAuC,WAAW,cAAc,EAAE;AAC7E,QAAM,KAAK,uEAAuE;AAClF,QAAM,KAAK,6CAA6C;AACxD,QAAM,KAAK,kCAAkC,WAAW,iBAAiB,EAAE;AAC3E,QAAM,KAAK,uEAAuE;AAClF,QAAM,KAAK,6CAA6C;AACxD,QAAM,KAAK,kCAAkC,WAAW,iBAAiB,EAAE;AAC3E,QAAM,KAAK,6EAA6E;AACxF,QAAM,KAAK,qCAAqC;AAChD,QAAM,KAAK,0BAA0B,WAAW,SAAS,EAAE;AAE3D,SAAO,MAAM,KAAK,IAAI,IAAI;AAC5B;AApDgB;;;ACjOT,IAAM,yBAAyB,iBACnC,OAAO;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAC3E,CAAC,EACA,OAAO;;;ACOV,eAAsB,kBAAkB,KAAc,KAAU;AAC9D,QAAM,MAAM,iBAAiB,KAAK,EAAE,OAAO,oBAAoB,CAAC;AAChE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AACjE,MAAI,CAAC,YAAY,IAAI,GAAG;AACtB,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,uBAAuB,UAAU;AAAA,IACpD,OAAO,IAAI,aAAa,IAAI,OAAO;AAAA,EACrC,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,MAAM,IAAI,aAAa;AAE/B,QAAM,MAAM,KAAK,IAAI;AACrB,QAAM,cAAc,sBAAsB,GAAG;AAC7C,QAAM,gBAAgB,KAAK,GAAG;AAE9B,QAAM,cACH,MAAM,IAAI,GAAG,QAAQ,8DAA8D,EAAE,MAGnF,KAAM;AAEX,QAAM,WAEF,MAAM,IAAI,GAAG;AAAA,IACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUF,EACG,KAAK,WAAW,EAChB,IAOE,GACL,WAAW,CAAC;AAEhB,QAAM,UAAU,kBAAkB,eAAe,EAAE,OAAO,GAAG,QAAQ,EAAE,GAAG,OAAO;AAEjF,QAAM,cAEF,MAAM,IAAI,GAAG;AAAA,IACX;AAAA;AAAA;AAAA;AAAA;AAAA,EAKF,EACG,KAAK,aAAa,KAAK,EACvB,IAME,GACL,WAAW,CAAC;AAEhB,QAAM,SAAS,CAAC;AAShB,aAAW,OAAO,YAAY;AAC5B,QAAI,SAAwB;AAC5B,QAAI,YAA2B;AAC/B,QAAI,IAAI,WAAW;AACjB,kBAAY,gBAAgB,IAAI,WAAW,IAAI;AAC/C,UAAI;AACF,iBAAS,MAAM,kBAAkB,IAAI,WAAW,KAAK,IAAI;AAAA,MAC3D,SAAS,OAAO;AACd,YAAI,MAAM,4BAA4B,EAAE,WAAW,IAAI,WAAW,MAAM,CAAC;AACzE,iBAAS;AAAA,MACX;AAAA,IACF;AACA,WAAO,KAAK;AAAA,MACV,IAAI,IAAI;AAAA,MACR,OAAO,IAAI;AAAA,MACX,aAAa,IAAI;AAAA,MACjB,aAAa,IAAI;AAAA,MACjB,WAAW;AAAA,MACX;AAAA,IACF,CAAC;AAAA,EACH;AAEA,SAAO,KAAK;AAAA,IACV,cAAc,QAAQ;AAAA,IACtB,OAAO;AAAA,IACP,SAAS,QAAQ;AAAA,IAClB,KAAK,QAAQ;AAAA,IACb,aAAa,QAAQ;AAAA,IACrB,YAAY,QAAQ,YAAY,OAAO;AAAA,IACtC,YAAY;AAAA,MACV,OAAO;AAAA,MACP,MAAM;AAAA,IACR;AAAA,IACA;AAAA,EACF,CAAC;AACH;AArHsB;;;ACLf,SAAS,WAAW,SAAqC;AAC9D,SAAO,OAAO,KAAK,KAAK,QAAQ;AAC9B,UAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,QAAI,CAAC,MAAM;AACT,aAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACxD;AACA,WAAO,QAAQ,KAAK,KAAK,GAAG;AAAA,EAC9B;AACF;AARgB;;;ACFT,SAAS,oBAAoBC,SAAmB;AACrD,EAAAA,QACG,IAAI,uBAAuB,WAAW,CAAC,KAAK,QAAQ,oBAAoB,KAAK,GAAG,CAAC,CAAC,EAClF,IAAI,qBAAqB,WAAW,CAAC,KAAK,QAAQ,kBAAkB,KAAK,GAAG,CAAC,CAAC,EAC9E,IAAI,mBAAmB,WAAW,CAAC,KAAK,QAAQ,qBAAqB,KAAK,GAAG,CAAC,CAAC,EAC/E,KAAK,mBAAmB,WAAW,CAAC,KAAK,QAAQ,uBAAuB,KAAK,GAAG,CAAC,CAAC;AACvF;AANgB;;;ACJT,IAAM,yBAAyB,iBACnC,OAAO;AAAA,EACN,MAAM;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAAA,EACzE,QAAQ;AACV,CAAC,EACA,OAAO;AAIH,IAAM,2BAA2B,iBACrC,OAAO;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAC3E,CAAC,EACA,OAAO;;;ACDV,eAAsB,aAAa,KAAc,KAAU,UAAkB;AAC3E,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,UAAU,YAAY,IAAI;AAChC,QAAM,aAAa,MAAM,gBAAgB,UAAU,KAAK,OAAO;AAC/D,MAAI,CAAC,WAAY,QAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AACpE,MAAI;AAEJ,MAAI,SAAS;AACX,UAAM,MAAM,IAAI,GAAG,QAAQ,yDAAyD,EACjF,KAAK,UAAU,EACf,MAAM;AAAA,EACX,OAAO;AACL,QAAI,CAAC,KAAK,aAAa,KAAK,UAAU,WAAW,GAAG;AAClD,aAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AACA,UAAM,eAAe,KAAK,UAAU,IAAI,CAAC,GAAG,MAAM,IAAI,IAAI,CAAC,EAAE,EAAE,KAAK,GAAG;AACvE,UAAM,MAAM,IAAI,GAAG;AAAA,MACjB;AAAA;AAAA;AAAA;AAAA,iCAI2B,YAAY;AAAA;AAAA,IAEzC,EACG,KAAK,YAAY,GAAG,KAAK,SAAS,EAClC,MAAM;AAAA,EACX;AAEA,MAAI,CAAC,IAAK,QAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAE7D,MAAI,kBAAkB,gBAAgB,YAAY,OAAO;AACzD,MAAI,SAAS;AACb,MAAI,CAAC,SAAS;AACZ,UAAM,EAAE,WAAW,OAAO,GAAG,KAAK,IAAI;AACtC,aAAS;AAAA,EACX;AAEA,SAAO,KAAK,EAAE,WAAW,iBAAiB,OAAO,CAAC;AACpD;AAxCsB;AA0CtB,eAAsB,kBAAkB,KAAc,KAAU;AAC9D,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,UAAU,YAAY,IAAI;AAChC,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,uBAAuB,UAAU;AAAA,IACpD,MAAM,IAAI,aAAa,IAAI,MAAM,KAAK;AAAA,IACtC,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,IACxC,QAAQ,IAAI,aAAa,IAAI,QAAQ,KAAK;AAAA,EAC5C,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,MAAM,WAAW,QAAQ,IAAI,OAAO,IAAI,aAAa;AAC7D,QAAM,OAAO,UAAU,aAAa,QAAQ;AAC5C,QAAM,YAAY,UAAU;AAC5B,MAAI,cAAoC;AACxC,MAAI,WAA0B;AAC9B,MAAI,WAA0B;AAC9B,MAAI,WAAW;AACb,UAAM,QAAQ,UAAU,MAAM,KAAK,CAAC;AACpC,UAAM,QAAQ,MAAM,CAAC;AACrB,QAAI,UAAU,MAAM;AAClB,oBAAc;AACd,YAAM,SAAS,MAAM,CAAC,KAAK;AAC3B,iBAAW,WAAW,MAAM;AAC5B,UAAI,UAAU,aAAa,KAAM,QAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AACzF,YAAM,YAAY,MAAM,UAAU,IAAI,MAAM,CAAC,KAAK,OAAO;AACzD,YAAM,SAAS,WAAW,SAAS;AACnC,UAAI,aAAa,WAAW,KAAM,QAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC1F,UAAI,QAAQ;AACV,cAAM,SAAS,MAAM,cAAc,QAAQ,KAAK,OAAO;AACvD,YAAI,CAAC,OAAO,GAAI,QAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AACxE,mBAAW,OAAO;AAAA,MACpB;AAAA,IACF,WAAW,UAAU,QAAQ;AAC3B,oBAAc;AACd,YAAM,YAAY,MAAM,CAAC,KAAK;AAC9B,YAAM,SAAS,WAAW,SAAS;AACnC,UAAI,CAAC,OAAQ,QAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AACrE,YAAM,SAAS,MAAM,cAAc,QAAQ,KAAK,OAAO;AACvD,UAAI,CAAC,OAAO,MAAM,CAAC,OAAO,GAAI,QAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AACtF,iBAAW,OAAO;AAAA,IACpB;AAAA,EACF;AAEA,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AAErB,MAAI,MAAM;AACR,QAAI,CAAC,KAAK,WAAW,OAAQ,QAAO,KAAK,EAAE,OAAO,CAAC,GAAG,MAAM,KAAK,CAAC;AAClE,UAAM,KAAK,KAAK,UAAU,IAAI,CAAC,GAAG,MAAM,IAAI,IAAI,CAAC,EAAE,EAAE,KAAK,GAAG;AAC7D,YAAQ,0BAA0B,EAAE;AACpC,SAAK,KAAK,GAAG,KAAK,SAAS;AAAA,EAC7B;AAEA,MAAI,gBAAgB,QAAQ,UAAU;AACpC,aAAS,QAAQ,SAAS;AAC1B,QAAI,UAAU;AACZ,eACE;AACF,WAAK,KAAK,UAAU,UAAU,QAAQ;AAAA,IACxC,OAAO;AACL,eAAS;AACT,WAAK,KAAK,QAAQ;AAAA,IACpB;AAAA,EACF,WAAW,gBAAgB,UAAU,UAAU;AAC7C,aAAS,QAAQ,SAAS;AAC1B,aAAS;AACT,SAAK,KAAK,QAAQ;AAAA,EACpB;AAEA,QAAM,MAAM;AAAA;AAAA;AAAA;AAAA,QAIN,KAAK;AAAA;AAAA,aAEA,QAAQ,CAAC;AAAA;AAGpB,QAAM,QACJ,MAAM,IAAI,GAAG,QAAQ,GAAG,EAAE,KAAK,GAAG,IAAI,EAAE,IAKrC,GACH,WAAW,CAAC;AAEd,QAAM,UAAU,KAAK,SAAS;AAC9B,QAAM,QAAQ,UAAU,KAAK,MAAM,GAAG,KAAK,IAAI;AAE/C,MAAI;AACJ,MAAI;AACF,YAAQ,MAAM,QAAQ;AAAA,MACpB,MAAM,IAAI,OAAOC,QAAO;AAAA,QACtB,WAAW,gBAAgBA,GAAE,WAAW,OAAO;AAAA,QAC/C,QAAQ,MAAM,kBAAkBA,GAAE,WAAW,KAAK,OAAO;AAAA,QACzD,YAAYA,GAAE;AAAA,QACd,QAAQ,CAAC,CAACA,GAAE;AAAA,QACZ,cAAcA,GAAE;AAAA,QAChB,MAAOA,GAAU,QAAQ;AAAA,QACzB,UAAWA,GAAU,YAAY;AAAA,QACjC,aAAcA,GAAU,eAAe;AAAA,MACzC,EAAE;AAAA,IACJ;AAAA,EACF,SAAS,KAAK;AACZ,qBAAiB,KAAK,EAAE,OAAO,eAAe,CAAC,EAAE,MAAM,uBAAuB;AAAA,MAC5E,OAAO;AAAA,IACT,CAAC;AACD,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,MAAI,OAAsB;AAC1B,MAAI,SAAS;AACX,UAAM,OAAO,MAAM,MAAM,SAAS,CAAC;AACnC,QAAI,iBAAiB,KAAK;AAC1B,QAAI,CAAC,SAAS;AACZ,UAAI;AACF,yBAAiB,MAAM,aAAa,KAAK,KAAK,SAAS;AAAA,MACzD,SAAS,KAAK;AACZ,yBAAiB,KAAK,EAAE,OAAO,eAAe,CAAC,EAAE,MAAM,8BAA8B;AAAA,UACnF,OAAO;AAAA,QACT,CAAC;AACD,eAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MACxD;AAAA,IACF;AACA,WAAO,KAAK,eACR,MAAM,mBAAmB,KAAK,YAAY,CAAC,IAAI,mBAAmB,cAAc,CAAC,KACjF,QAAQ,mBAAmB,cAAc,CAAC;AAAA,EAChD;AAEA,SAAO,KAAK,EAAE,OAAO,KAAK,CAAC;AAC7B;AAvIsB;AAyItB,eAAsB,oBAAoB,KAAc,KAAU,aAAqB;AACrF,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,IAAI;AACnC,QAAM,aAAa,MAAM,gBAAgB,aAAa,KAAK,MAAM,OAAO;AACxE,MAAI,CAAC,WAAY,QAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEpE,MAAI,CAAC,MAAM,SAAS;AAClB,QAAI,MAAM,MAAO,QAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AACpE,UAAM,QAAQ,MAAM,IAAI,GAAG;AAAA,MACzB,sDAAsD,MAAM,MAAM;AAAA,IACpE,EACG,KAAK,YAAY,GAAG,MAAM,IAAI,EAC9B,MAAM;AACT,QAAI,CAAC,MAAO,QAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACjE;AAEA,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,yBAAyB,UAAU;AAAA,IACtD,OAAO,IAAI,aAAa,IAAI,OAAO;AAAA,EACrC,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,QAAQ,GAAG,IAAI,aAAa;AAEpC,QAAM,OAAO,MAAM,IAAI,GACpB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA,gBAIU,KAAK;AAAA,EACjB,EACC,KAAK,UAAU,EACf,IAME;AAEL,QAAM,SAAS,KAAK,WAAW,CAAC,GAAG,IAAI,CAAC,QAAQ;AAC9C,UAAM,UAAU,iBAAiB,IAAI,YAAY;AACjD,WAAO;AAAA,MACL,IAAI,IAAI,KAAK,IAAI,EAAE,EAAE,YAAY;AAAA,MACjC,QAAQ,IAAI,UAAU;AAAA,MACtB,WAAW,IAAI,aAAa;AAAA,MAC5B,KAAK,IAAI,OAAO;AAAA,MAChB,SAAS,QAAQ,WAAW;AAAA,MAC5B,SAAS,QAAQ,WAAW;AAAA,MAC5B,OAAO,QAAQ,SAAS;AAAA,MACxB,UAAU,QAAQ,YAAY;AAAA,MAC9B,SAAS,QAAQ,WAAW;AAAA,MAC5B,SAAS,QAAQ,WAAW;AAAA,MAC5B,MAAM,QAAQ,QAAQ;AAAA,MACtB,SAAS,QAAQ,WAAW;AAAA,IAC9B;AAAA,EACF,CAAC,EAAE,QAAQ;AAEX,MAAI;AACJ,MAAI;AACF,kBAAc,MAAM,kBAAkB,YAAY,KAAK,MAAM,OAAO;AAAA,EACtE,SAAS,KAAK;AACZ,qBAAiB,KAAK;AAAA,MACpB,OAAO;AAAA,MACP,WAAW;AAAA,MACX,mBAAmB;AAAA,IACrB,CAAC,EAAE,MAAM,iCAAiC,EAAE,OAAO,IAAI,CAAC;AACxD,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,SAAO,KAAK;AAAA,IACV,WAAW,gBAAgB,YAAY,MAAM,OAAO;AAAA,IACpD,QAAQ;AAAA,IACR;AAAA,EACF,CAAC;AACH;AA/EsB;;;AC9Lf,SAAS,qBAAqBC,SAAmBC,YAAsB;AAC5E,EAAAD,QACG,IAAI,gBAAgB,WAAW,CAAC,KAAK,QAAQ,kBAAkB,KAAK,GAAG,CAAC,CAAC,EACzE;AAAA,IACC;AAAA,IACA;AAAA,MACEC,WAAU,MAAM,CAAC,KAAK,KAAK,aAAa,aAAa,KAAK,KAAK,QAAQ,CAAC;AAAA,IAC1E;AAAA,EACF,EACC;AAAA,IACC;AAAA,IACA;AAAA,MACEA,WAAU,MAAM,CAAC,KAAK,KAAK,aAAa,oBAAoB,KAAK,KAAK,QAAQ,CAAC;AAAA,IACjF;AAAA,EACF;AACJ;AAfgB;;;ACiBhB,SAAS,YAAY,KAAoB,KAA4B;AACnE,QAAM,MAAM,IAAI,SAAS,GAAG,KAAK;AACjC,QAAM,UAAU,WAAW,GAAG;AAC9B,MAAI,YAAY,QAAQ,YAAY,GAAI,QAAO;AAC/C,SAAO;AACT;AALS;AAOF,IAAM,YAAuB,wBAAC,OAAO,YAAY;AACtD,SAAO,CAAC,KAAK,KAAK,QAAQ;AACxB,UAAM,QAAQ,YAAY,KAAsB,KAAK;AACrD,QAAI,CAAC,OAAO;AACV,aAAO,KAAK,EAAE,OAAO,WAAW,KAAK,GAAG,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC5D;AACA,WAAO,QAAQ,KAAK,KAAK,OAAO,GAAG;AAAA,EACrC;AACF,GARoC;;;AC3B7B,IAAM,qBAAqB,iBAC/B,OAAO;AAAA,EACN,QAAQ,iBAAE;AAAA,IACR,CAAC,UAAmB;AAClB,UAAI,UAAU,UAAa,UAAU,KAAM,QAAO;AAClD,UAAI,OAAO,UAAU,SAAU,QAAO;AACtC,YAAM,UAAU,MAAM,KAAK,EAAE,YAAY;AACzC,aAAO,YAAY,KAAK,SAAY;AAAA,IACtC;AAAA,IACA,iBAAE,KAAK,CAAC,QAAQ,QAAQ,WAAW,CAAC,EAAE,SAAS;AAAA,EACjD;AACF,CAAC,EACA,OAAO;;;ACFV,eAAsB,cAAc,KAAc,KAAU;AAC1D,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AACjE,MAAI,CAAC,YAAY,IAAI,GAAG;AACtB,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,mBAAmB,UAAU;AAAA,IAChD,QAAQ,IAAI,aAAa,IAAI,QAAQ;AAAA,EACvC,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,cAAc,aAAa,KAAK;AACtC,QAAM,oBAAqB,gBAAuC;AAElE,QAAM,MAAM,KAAK,IAAI;AACrB,QAAM,cAAc,sBAAsB,GAAG;AAC7C,QAAM,gBAAgB,KAAK,GAAG;AAE9B,QAAM,cACH,MAAM,IAAI,GAAG,QAAQ,8DAA8D,EAAE,MAGnF,KAAM;AAEX,QAAM,WAEF,MAAM,IAAI,GAAG;AAAA,IACX;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUF,EACG,KAAK,WAAW,EAChB,IAOE,GACL,WAAW,CAAC;AAEhB,QAAM,gBAAgB;AAAA,IACpB,OAAO,aAAa,SAAS;AAAA,IAC7B,QAAQ,aAAa,UAAU;AAAA,EACjC;AAEA,QAAM,iBAAiB,kBAAkB,eAAe,OAAO;AAE/D,MAAI,mBAAmB;AACrB,UAAM,YAAY,sBAAsB,cAAc;AACtD,WAAO,KAAK;AAAA,MACV,GAAG;AAAA,MACH,YAAY;AAAA,QACV,OAAO;AAAA,QACP,MAAM;AAAA,MACR;AAAA,IACF,CAAC;AAAA,EACH;AAEA,QAAM,SAAS,kBAAkB,aAAa,IAAI,QAAQ,IAAI,QAAQ,KAAK,EAAE;AAE7E,MAAI,WAAW,QAAQ;AACrB,WAAO,KAAK;AAAA,MACV,GAAG;AAAA,MACH,YAAY;AAAA,QACV,OAAO;AAAA,QACP,MAAM;AAAA,MACR;AAAA,IACF,CAAC;AAAA,EACH;AAEA,QAAM,cAAc,kBAAkB,eAAe,OAAO;AAC5D,SAAO,KAAK,aAAa;AAAA,IACvB,SAAS;AAAA,MACP,gBAAgB;AAAA,IAClB;AAAA,EACF,CAAC;AACH;AAxFsB;AA6FtB,SAAS,sBAAsB,SAA6B;AAC1D,QAAM,gBAAgB;AAAA,IACpB,QAAQ,QAAQ;AAAA,IAChB,QAAQ,WAAW,QAAQ;AAAA,EAC7B;AAEA,QAAM,iBAAiB;AAAA,IACrB,QAAQ,YAAY;AAAA,IACpB,QAAQ,WAAW,IAAI;AAAA,EACzB;AACA,QAAM,iBAAiB;AAAA,IACrB,QAAQ,YAAY;AAAA,IACpB,QAAQ,WAAW,IAAI;AAAA,EACzB;AACA,QAAM,iBAAiB,QAAQ,YAAY,YAAY,CAAC,GAAG,mBAAmB;AAC9E,QAAM,kBAAkB;AAAA,IACtB;AAAA,IACA,QAAQ,WAAW,IAAI;AAAA,EACzB;AAEA,QAAM,qBAAqB,CAAC,gBAAgB,gBAAgB,eAAe,EAAE;AAAA,IAC3E,CAAC,KAAK,YAAa,eAAe,OAAO,IAAI,eAAe,GAAG,IAAI,UAAU;AAAA,IAC7E;AAAA,EACF;AAEA,SAAO;AAAA,IACL,cAAc,QAAQ;AAAA,IACtB,SAAS;AAAA,MACP,GAAG,QAAQ;AAAA,MACX,QAAQ;AAAA,MACR,YAAY,QAAQ,WAAW;AAAA,IACjC;AAAA,IACA,KAAK;AAAA,MACH,SAAS,QAAQ;AAAA,MACjB,QAAQ;AAAA,MACR,SAAS;AAAA,QACP,mBAAmB;AAAA,UACjB,OAAO,QAAQ,YAAY;AAAA,UAC3B,QAAQ;AAAA,UACR,YAAY,QAAQ,WAAW,IAAI;AAAA,QACrC;AAAA,QACA,mBAAmB;AAAA,UACjB,OAAO,QAAQ,YAAY;AAAA,UAC3B,QAAQ;AAAA,UACR,YAAY,QAAQ,WAAW,IAAI;AAAA,QACrC;AAAA,QACA,qBAAqB;AAAA,UACnB,OAAO;AAAA,UACP,QAAQ;AAAA,UACR,YAAY,QAAQ,WAAW,IAAI;AAAA,QACrC;AAAA,MACF;AAAA,MACA,aAAa,QAAQ,YAAY;AAAA,MACjC,yBAAyB,QAAQ,YAAY;AAAA,IAC/C;AAAA,IACA,YAAY,QAAQ;AAAA,EACtB;AACF;AAzDS;AA2DT,SAAS,eACP,OACA,YACe;AACf,MAAI,SAAS,WAAW,SAAU,QAAO;AACzC,MAAI,SAAS,WAAW,KAAM,QAAO;AACrC,SAAO;AACT;AAPS;AAST,SAAS,eAAe,OAA8B;AACpD,UAAQ,OAAO;AAAA,IACb,KAAK;AACH,aAAO;AAAA,IACT,KAAK;AACH,aAAO;AAAA,IACT;AACE,aAAO;AAAA,EACX;AACF;AATS;;;ACzKF,SAAS,sBAAsBC,SAAmB;AACvD,EAAAA,QAAO,IAAI,YAAY,CAAC,KAAK,QAAQ,cAAc,KAAK,GAAG,CAAC;AAC9D;AAFgB;;;ACIhB,IAAM,kBAAkB;AAEjB,IAAM,6BAA6B,iBACvC,OAAO;AAAA,EACN,SAAS,iBACN;AAAA,IACC,iBACG,OAAO;AAAA,MACN,gBAAgB;AAAA,MAChB,oBAAoB;AAAA,IACtB,CAAC,EACA,KAAK,EACL,IAAI,GAAG,qCAAqC;AAAA,EACjD,EACC,IAAI,iBAAiB,4BAA4B,eAAe,UAAU,EAC1E,QAAQ,CAAC,CAAC;AAAA,EACb,SAAS,iBACN,OAAO;AAAA,IACN,QAAQ,oBAAoB,QAAQ,IAAI;AAAA,IACxC,SAAS,oBAAoB,QAAQ,IAAI;AAAA,EAC3C,CAAC,EACA,QAAQ;AAAA,IACP,QAAQ;AAAA,IACR,SAAS;AAAA,EACX,CAAC;AACL,CAAC,EACA,OAAO;AAIH,IAAM,6BAA6B,iBACvC,OAAO;AAAA,EACN,OAAO,sBACJ;AAAA,IAAU,CAAC,UACV,QAAQ,MAAM,YAAY,IAAI;AAAA,EAChC,EACC;AAAA,IACC,CAAC,UACC,CAAC,SAAS,CAAC,UAAU,WAAW,OAAO,EAAE,SAAS,KAAK;AAAA,IACzD;AAAA,EACF,EACC,QAAQ,QAAQ;AAAA,EACnB,QAAQ;AAAA,EACR,SAAS;AAAA,EACT,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,KAAK;AAAA,EACL,UAAU;AAAA,EACV,MAAM;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAM,cAAc,IAAI,CAAC;AAC7E,CAAC,EACA,OAAO;AAIH,IAAM,4BAA4B;AAAA,EACvC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEO,IAAM,yBAAiD;AAAA,EAC5D,MAAM;AAAA,EACN,MAAM;AAAA,EACN,OAAO;AAAA,EACP,MAAM;AAAA,EACN,MAAM;AACR;;;AC5DA,IAAM,yBAAyB,CAAC,UAAU,SAAS,YAAY,OAAO,aAAa,MAAM;AAoDzF,eAAsB,0BACpB,KACA,MACA,cACgC;AAChC,QAAM,QAAQ,iBAAiB,IAAI;AACnC,QAAM,YAA0C,aAAa,IAAI,CAAC,OAAO,WAAW;AAAA,IAClF;AAAA,IACA;AAAA,IACA,UAAU;AAAA,EACZ,EAAE;AAEF,QAAM,gBAA0B,CAAC;AACjC,MAAI,CAAC,aAAa,QAAQ;AACxB,WAAO,EAAE,OAAO,WAAW,aAAa,CAAC,GAAG,cAAc;AAAA,EAC5D;AAEA,QAAM,cAAc,MAAM,QAAQ;AAAA,IAChC,UAAU,IAAI,CAAC,UAAU,gBAAgB,MAAM,OAAO,KAAK,MAAM,OAAO,CAAC;AAAA,EAC3E;AACA,cAAY,QAAQ,CAAC,UAAU,UAAU;AACvC,QAAI,CAAC,UAAU;AACb,oBAAc,KAAK,UAAU,KAAK,EAAG,KAAK;AAC1C;AAAA,IACF;AACA,cAAU,KAAK,EAAG,WAAW;AAAA,EAC/B,CAAC;AAED,QAAM,cAAc,MAAM;AAAA,IACxB,IAAI,IAAI,UAAU,OAAO,CAAC,cAAc,UAAU,QAAQ,EAAE,IAAI,CAAC,cAAc,UAAU,QAAS,CAAC;AAAA,EACrG;AAEA,SAAO,EAAE,OAAO,WAAW,aAAa,cAAc;AACxD;AAjCsB;AAmCtB,eAAsB,sBACpB,KACA,KACA,SACA,MACA;AACA,QAAM,UAAU,YAAY,IAAI;AAChC,QAAM,SAAS,MAAM,kBAAkB,IAAI,WAAW,KAAK,OAAO;AAClE,QAAM,YAAY,gBAAgB,IAAI,WAAW,OAAO;AACxD,QAAM,QAA+B,WAAW,EAAE,QAAQ,MAAM,SAAS,KAAK;AAC9E,QAAM,iBAAiB,MAAM,YAAY;AACzC,QAAM,gBAAgB,MAAM,WAAW;AAEvC,QAAM,SAAkC;AAAA,IACtC,IAAI,IAAI,MAAM;AAAA,IACd,YAAY,IAAI,cAAc;AAAA,IAC9B,QAAQ,IAAI,kBAAkB;AAAA,IAC9B,MAAM,IAAI,QAAQ;AAAA,IAClB,SAAS,IAAI,WAAW;AAAA,IACxB,aAAa,IAAI,eAAe;AAAA,EAClC;AAEA,MAAI,gBAAgB;AAClB,QAAI,SAAS;AACX,YAAM,gBAAgB,cAAc,IAAI,YAAY;AACpD,YAAM,YAAY,kBAAkB,OAAO,OAAO,yBAAyB,aAAa;AACxF,aAAO,UAAU,aAAa;AAAA,IAChC;AACA,WAAO,UAAU,oBAAoB,IAAI,SAAS,OAAO;AACzD,WAAO,UAAU,oBAAoB,IAAI,SAAS,OAAO;AACzD,WAAO,QAAQ,oBAAoB,IAAI,OAAO,OAAO;AACrD,WAAO,WAAW,oBAAoB,IAAI,UAAU,OAAO;AAC3D,WAAO,UAAU,oBAAoB,IAAI,SAAS,SAAS,CAAC;AAC5D,WAAO,eAAe,oBAAoB,IAAI,cAAc,SAAS,CAAC;AACtE,WAAO,WAAW,oBAAoB,IAAI,UAAU,SAAS,CAAC;AAC9D,WAAO,UAAU,oBAAoB,IAAI,SAAS,SAAS,CAAC;AAC5D,WAAO,SAAS,oBAAoB,IAAI,QAAQ,SAAS,CAAC;AAC1D,WAAO,YAAY,oBAAoB,IAAI,WAAW,SAAS,CAAC;AAChE,WAAO,MAAM,oBAAoB,IAAI,KAAK,SAAS,CAAC;AAAA,EACtD,WAAW,SAAS;AAClB,UAAM,gBAAgB,cAAc,IAAI,YAAY;AACpD,QAAI,kBAAkB,MAAM;AAC1B,YAAM,YAAY,yBAAyB,aAAa;AACxD,UAAI,cAAc,QAAW;AAC3B,eAAO,UAAU;AAAA,MACnB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,eAAe;AACjB,WAAO,SAAS,gBAAgB,IAAI,WAAW;AAAA,EACjD;AAEA,SAAO;AAAA,IACL;AAAA,IACA,WAAW;AAAA,IACX,YAAY,IAAI,cAAc;AAAA,IAC9B,MAAM,IAAI,QAAQ;AAAA,IAClB,QAAQ,IAAI,kBAAkB;AAAA,IAC9B,cAAc,IAAI,gBAAgB;AAAA,IAClC;AAAA,EACF;AACF;AA9DsB;AAgEtB,eAAsB,6BACpB,QACA,KACA,MACsC;AACtC,QAAM,UAAU,eAAe,OAAO,MAAM;AAC5C,MAAI,CAAC,QAAQ,QAAQ;AACnB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,kBAAkB;AAAA,EAC5D;AAEA,QAAM,WAAW,gBAAgB,OAAO,YAAY,IAAI;AACxD,MAAI,CAAC,UAAU;AACb,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,mBAAmB;AAAA,EAC7D;AAEA,QAAM,MAAM,KAAK,IAAI;AACrB,QAAM,QAAQ,eAAe,OAAO,KAAK,GAAG;AAC5C,MAAI,UAAU,MAAM;AAClB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,wBAAwB;AAAA,EAClE;AAEA,QAAM,eAAe,QAAQ,KAAK,KAAK,KAAK;AAC5C,MAAI,UAAU,eAAe,OAAO,OAAO,YAAY;AACvD,MAAI,YAAY,MAAM;AACpB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,0BAA0B;AAAA,EACpE;AAEA,MAAI,WAAW,OAAO;AACpB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,2BAA2B;AAAA,EACrE;AAEA,QAAM,QAAQ,OAAO,SAAS;AAC9B,QAAM,YAAY,QAAQ;AAC1B,MAAI,QAAQ,UAAU,WAAW;AAC/B,cAAU,QAAQ;AAAA,EACpB;AAEA,QAAM,QAAQ,iBAAiB,MAAM,GAAG;AACxC,QAAM,UAAU,MAAM;AACtB,QAAM,WAAW,OAAO,SAAS,UAAU,UAAU;AACrD,QAAM,kBAAkB,UAAU,IAAI;AAEtC,QAAM,aAAuB,CAAC,gDAAgD;AAC9E,QAAM,WAAkB,CAAC;AACzB,MAAI;AAEJ,MAAI,OAAO,UAAU,UAAU;AAC7B,QAAI,CAAC,OAAO,QAAQ;AAClB,aAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,gDAAgD;AAAA,IAC1F;AACA,UAAM,aAAa,MAAM,gBAAgB,OAAO,QAAQ,KAAK,OAAO;AACpE,QAAI,CAAC,YAAY;AACf,aAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,mBAAmB;AAAA,IAC7D;AAEA,UAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,wEAAwE,EAChF,KAAK,UAAU,EACf,MAAwD;AAC3D,QAAI,CAAC,KAAK;AACR,aAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,mBAAmB;AAAA,IAC7D;AAEA,QAAI,CAAC,SAAS;AACZ,YAAM,UAAW,MAAM,QAAqB,CAAC;AAC7C,UAAI,CAAC,QAAQ,SAAS,IAAI,cAAc,EAAE,GAAG;AAC3C,eAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,YAAY;AAAA,MACtD;AAAA,IACF;AAEA,eAAW,KAAK,iBAAiB;AACjC,aAAS,KAAK,IAAI,SAAS;AAE3B,UAAM,YAAY,gBAAgB,IAAI,WAAW,OAAO;AACxD,UAAM,SAAS,MAAM,kBAAkB,IAAI,WAAW,KAAK,OAAO;AAClE,sBAAkB,EAAE,MAAM,UAAU,WAAW,WAAW,OAAO;AAAA,EACnE,WAAW,OAAO,UAAU,WAAW;AACrC,QAAI,SAAS;AACX,UAAI,CAAC,OAAO,SAAS;AACnB,eAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,kDAAkD;AAAA,MAC5F;AACA,iBAAW,KAAK,cAAc,gBAAgB,CAAC,OAAO,OAAO,CAAC,CAAC;AAC/D,eAAS,KAAK,OAAO,OAAO;AAC5B,wBAAkB,EAAE,MAAM,WAAW,aAAa,CAAC,OAAO,OAAO,EAAE;AAAA,IACrE,OAAO;AACL,YAAM,UAAW,MAAM,QAAqB,CAAC;AAC7C,UAAI,CAAC,QAAQ,QAAQ;AACnB,mBAAW,KAAK,KAAK;AACrB,0BAAkB,EAAE,MAAM,WAAW,aAAa,CAAC,EAAE;AAAA,MACvD,OAAO;AACL,YAAI;AACJ,YAAI,OAAO,SAAS;AAClB,cAAI,CAAC,QAAQ,SAAS,OAAO,OAAO,GAAG;AACrC,mBAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,YAAY;AAAA,UACtD;AACA,qBAAW,CAAC,OAAO,OAAO;AAAA,QAC5B,WAAW,QAAQ,WAAW,GAAG;AAC/B,qBAAW,CAAC,GAAG,OAAO;AAAA,QACxB,OAAO;AACL,iBAAO;AAAA,YACL,IAAI;AAAA,YACJ,QAAQ;AAAA,YACR,OAAO;AAAA,UACT;AAAA,QACF;AACA,mBAAW,KAAK,cAAc,gBAAgB,QAAQ,CAAC;AACvD,iBAAS,KAAK,GAAG,QAAQ;AACzB,0BAAkB,EAAE,MAAM,WAAW,aAAa,SAAS;AAAA,MAC7D;AAAA,IACF;AAAA,EACF,OAAO;AACL,QAAI,SAAS;AACX,UAAI,OAAO,SAAS;AAClB,mBAAW,KAAK,cAAc,gBAAgB,CAAC,OAAO,OAAO,CAAC,CAAC;AAC/D,iBAAS,KAAK,OAAO,OAAO;AAC5B,0BAAkB,EAAE,MAAM,SAAS,aAAa,CAAC,OAAO,OAAO,EAAE;AAAA,MACnE,OAAO;AACL,0BAAkB,EAAE,MAAM,SAAS,aAAa,KAAK;AAAA,MACvD;AAAA,IACF,OAAO;AACL,YAAM,UAAW,MAAM,QAAqB,CAAC;AAC7C,UAAI,CAAC,QAAQ,QAAQ;AACnB,mBAAW,KAAK,KAAK;AACrB,0BAAkB,EAAE,MAAM,SAAS,aAAa,CAAC,EAAE;AAAA,MACrD,OAAO;AACL,YAAI,WAAW,CAAC,GAAG,OAAO;AAC1B,YAAI,OAAO,SAAS;AAClB,cAAI,CAAC,QAAQ,SAAS,OAAO,OAAO,GAAG;AACrC,mBAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,YAAY;AAAA,UACtD;AACA,qBAAW,CAAC,OAAO,OAAO;AAAA,QAC5B;AACA,mBAAW,KAAK,cAAc,gBAAgB,QAAQ,CAAC;AACvD,iBAAS,KAAK,GAAG,QAAQ;AACzB,0BAAkB,EAAE,MAAM,SAAS,aAAa,SAAS;AAAA,MAC3D;AAAA,IACF;AAAA,EACF;AAEA,MAAI,CAAC,WAAW,MAAM,QAAQ;AAC5B,eAAW,KAAK,MAAM,MAAM;AAC5B,aAAS,KAAK,GAAG,MAAM,IAAI;AAAA,EAC7B;AAEA,QAAM,cAAc,WAAW,KAAK,OAAO;AAE3C,SAAO;AAAA,IACL,IAAI;AAAA,IACJ,QAAQ;AAAA,MACN;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;AAhKsB;AAkKtB,SAAS,eAAe,KAAgC;AACtD,MAAI,CAAC,IAAK,QAAO,CAAC,GAAG,yBAAyB;AAC9C,QAAM,QAAQ,IACX,MAAM,GAAG,EACT,IAAI,CAAC,SAAS,KAAK,KAAK,CAAC,EACzB,OAAO,OAAO;AACjB,QAAM,UAAU,IAAI,IAAI,yBAAyB;AACjD,SAAO,MAAM,OAAO,CAAC,SAAS,QAAQ,IAAI,IAAI,CAAC;AACjD;AARS;AAUT,SAAS,gBAAgB,UAA8B;AACrD,MAAI,CAAC,SAAU,QAAO,uBAAuB,IAAI;AACjD,SAAO,uBAAuB,QAAQ,KAAK;AAC7C;AAHS;AAKT,SAAS,eAAe,OAA2C,UAAiC;AAClG,MAAI,SAAS,KAAM,QAAO;AAC1B,MAAI,OAAO,UAAU,SAAU,QAAO,OAAO,SAAS,KAAK,IAAI,QAAQ;AACvE,QAAM,UAAU,OAAO,KAAK,EAAE,KAAK;AACnC,MAAI,CAAC,QAAS,QAAO;AACrB,MAAI,QAAQ,KAAK,OAAO,GAAG;AACzB,UAAMC,UAAS,OAAO,SAAS,SAAS,EAAE;AAC1C,WAAO,OAAO,MAAMA,OAAM,IAAI,OAAOA;AAAA,EACvC;AACA,QAAM,SAAS,KAAK,MAAM,OAAO;AACjC,SAAO,OAAO,MAAM,MAAM,IAAI,OAAO;AACvC;AAXS;AAaT,SAAS,cAAc,QAAgB,QAAkB;AACvD,MAAI,CAAC,OAAO,OAAQ,QAAO;AAC3B,QAAM,eAAe,OAAO,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AACnD,SAAO,GAAG,MAAM,QAAQ,YAAY;AACtC;AAJS;AAMT,SAAS,yBAAyB,SAAkB,QAAQ,GAAY;AACtE,MAAI,YAAY,KAAM,QAAO;AAC7B,MAAI,SAAS,EAAG,QAAO;AAEvB,MAAI,MAAM,QAAQ,OAAO,GAAG;AAC1B,UAAM,QAAQ,QACX,MAAM,GAAG,EAAE,EACX,IAAI,CAAC,SAAS,yBAAyB,MAAM,QAAQ,CAAC,CAAC,EACvD,OAAO,CAAC,SAAS,SAAS,MAAS;AACtC,WAAO;AAAA,EACT;AAEA,MAAI,OAAO,YAAY,UAAU;AAC/B,UAAM,UAAU,OAAO,QAAQ,OAAkC;AACjE,UAAM,SAAkC,CAAC;AACzC,eAAW,CAAC,KAAK,KAAK,KAAK,SAAS;AAClC,UAAI,CAAC,IAAK;AACV,YAAM,aAAa,IAAI,YAAY;AACnC,UAAI,uBAAuB,KAAK,CAAC,aAAa,WAAW,SAAS,QAAQ,CAAC,GAAG;AAC5E,eAAO,GAAG,IAAI;AACd;AAAA,MACF;AACA,YAAM,YAAY,yBAAyB,OAAO,QAAQ,CAAC;AAC3D,UAAI,cAAc,QAAW;AAC3B,eAAO,GAAG,IAAI;AAAA,MAChB;AAAA,IACF;AACA,WAAO;AAAA,EACT;AAEA,MAAI,OAAO,YAAY,UAAU;AAC/B,QAAI,CAAC,QAAQ,KAAK,EAAG,QAAO;AAC5B,WAAO,QAAQ,SAAS,MAAM,GAAG,QAAQ,MAAM,GAAG,GAAG,CAAC,QAAQ;AAAA,EAChE;AAEA,MAAI,OAAO,YAAY,YAAY,OAAO,YAAY,WAAW;AAC/D,WAAO;AAAA,EACT;AAEA,SAAO;AACT;AAxCS;AA0CT,SAAS,cAAc,SAAoC;AACzD,MAAI,CAAC,QAAS,QAAO;AACrB,MAAI;AACF,WAAO,KAAK,MAAM,OAAO;AAAA,EAC3B,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAPS;;;ACpZF,IAAM,+BAA+B;AAyD5C,eAAsB,0BACpB,KACA,WACA,OAC+B;AAC/B,MAAI,CAAC,UAAU,QAAQ;AACrB,WAAO,CAAC;AAAA,EACV;AAEA,QAAM,OAA6B,CAAC;AACpC,WAAS,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK,8BAA8B;AACvE,UAAM,QAAQ,UAAU,MAAM,GAAG,IAAI,4BAA4B;AACjE,UAAM,eAAe,MAAM,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AAClD,QAAI,QAAQ,oBAAoB,YAAY;AAC5C,UAAM,OAAkB,CAAC,GAAG,KAAK;AAEjC,QAAI,CAAC,MAAM,WAAW,MAAM,QAAQ;AAClC,cAAQ,SAAS,OAAO,MAAM,OAAO,QAAQ,cAAc,EAAE,CAAC;AAC9D,WAAK,KAAK,GAAG,MAAM,IAAI;AAAA,IACzB;AAEA,UAAM,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cA4BJ,KAAK;AAAA;AAGf,UAAM,SAAS,MAAM,IAAI,GAAG,QAAQ,KAAK,EACtC,KAAK,GAAG,IAAI,EACZ,IAAwB;AAC3B,SAAK,KAAK,GAAI,OAAO,WAAW,CAAC,CAAE;AAAA,EACrC;AAEA,SAAO;AACT;AA3DsB;AA6DtB,eAAsB,qBACpB,KACA,QAC+B;AAC/B,QAAM,QAAQ,eAAe,OAAO,WAAW;AAC/C,QAAM,WAAW;AAAA,IACf,OAAO;AAAA,IACP,OAAO;AAAA,IACP,OAAO;AAAA,IACP,GAAG,OAAO;AAAA,EACZ;AACA,QAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,KAAK,EACpC,KAAK,GAAG,QAAQ,EAChB,IAAwB;AAC3B,SAAO,KAAK,WAAW,CAAC;AAC1B;AAfsB;AAiBtB,SAAS,eAAe,aAA6B;AACnD,SAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAkBK,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAsDzB;AAzES;;;ACnHT,IAAM,qBAAqB;AAC3B,IAAM,uBAAuB,oBAAI,IAAwD;AAAA,EACvF;AAAA,EACA;AAAA,EACA;AACF,CAAC;AA+CD,eAAsB,iCAAiC,KAAc,KAAU;AAC7E,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,SAAS,mBAA8C,4BAA4B,OAAO;AAChG,MAAI,CAAC,OAAO,SAAS;AACnB,WAAO,wBAAwB,OAAO,MAAM;AAAA,EAC9C;AAEA,QAAM,OAAO,OAAO;AACpB,QAAM,QAAQ,iBAAiB,IAAI;AAEnC,MAAI,KAAK,QAAQ,WAAW,GAAG;AAC7B,WAAO,KAAK,EAAE,cAAc,OAAO,GAAG,OAAO,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC;AAAA,EAChE;AAEA,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK;AAAA,MACV,cAAc,OAAO;AAAA,MACrB,OAAO,CAAC;AAAA,MACR,SAAS,CAAC,GAAG,IAAI,IAAI,KAAK,OAAO,CAAC;AAAA,IACpC,CAAC;AAAA,EACH;AAQA,QAAM,YAA+B,KAAK,QAAQ;AAAA,IAChD,CAAC,OAAe,WAAoC;AAAA,MAClD;AAAA,MACA;AAAA,MACA,UAAU;AAAA,IACZ;AAAA,EACF;AAEA,QAAM,aAAa,wBACjB,UACoD,MAAM,aAAa,MAFtD;AAInB,QAAM,UAAoB,CAAC;AAC3B,aAAW,SAAS,WAAW;AAC7B,UAAM,WAAW,MAAM,gBAAgB,MAAM,OAAO,KAAK,MAAM,OAAO;AACtE,QAAI,CAAC,UAAU;AACb,cAAQ,KAAK,MAAM,KAAK;AACxB;AAAA,IACF;AACA,UAAM,WAAW;AAAA,EACnB;AAEA,QAAM,cAAc,MAAM,KAAK,IAAI,IAAI,UAAU,OAAO,UAAU,EAAE,IAAI,CAACC,OAAMA,GAAE,QAAQ,CAAC,CAAC;AAE3F,MAAI,CAAC,YAAY,QAAQ;AACvB,WAAO,KAAK;AAAA,MACV,cAAc,OAAO;AAAA,MACrB,OAAO,CAAC;AAAA,MACR,SAAS,oBAAoB,KAAK,SAAS,OAAO;AAAA,IACpD,CAAC;AAAA,EACH;AAEA,QAAM,OAAO,MAAM,gBAAgB,KAAK,aAAa,KAAK;AAC1D,QAAM,SAAS,oBAAI,IAA4B;AAC/C,aAAW,OAAO,MAAM;AACtB,WAAO,IAAI,IAAI,WAAW,GAAG;AAAA,EAC/B;AAEA,QAAM,QAAQ,CAAC;AACf,QAAM,OAAO,oBAAI,IAAY;AAC7B,QAAM,gBAAgB,IAAI,IAAY,OAAO;AAE7C,aAAW,SAAS,WAAW;AAC7B,QAAI,CAAC,MAAM,UAAU;AACnB;AAAA,IACF;AACA,QAAI,KAAK,IAAI,MAAM,QAAQ,GAAG;AAC5B;AAAA,IACF;AACA,UAAM,MAAM,OAAO,IAAI,MAAM,QAAQ;AACrC,QAAI,CAAC,KAAK;AACR,oBAAc,IAAI,MAAM,KAAK;AAC7B;AAAA,IACF;AACA,SAAK,IAAI,MAAM,QAAQ;AACvB,QAAI;AACF,YAAM,YAAY,MAAM;AAAA,QACtB;AAAA,QACA;AAAA,QACA,YAAY,IAAI;AAAA,QAChB,KAAK,WAAW,EAAE,QAAQ,MAAM,SAAS,KAAK;AAAA,MAChD;AACA,YAAM,KAAK,SAAS;AAAA,IACtB,SAAS,OAAO;AACd,uBAAiB,KAAK,EAAE,OAAO,8BAA8B,CAAC,EAAE;AAAA,QAC9D;AAAA,QACA,EAAE,OAAO,WAAW,MAAM,SAAS;AAAA,MACrC;AAAA,IACF;AAAA,EACF;AAEA,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB;AAAA,IACA,SAAS,oBAAoB,KAAK,SAAS,MAAM,KAAK,aAAa,CAAC;AAAA,EACtE,CAAC;AACH;AAjHsB;AAmHtB,eAAsB,4BAA4B,KAAc,KAAU;AACxE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,WAA0C,CAAC;AACjD,QAAM,gBAAgB,IAAI;AAC1B,aAAW,CAAC,KAAK,KAAK,KAAK,eAAe;AACxC,aAAS,GAAG,IAAI;AAAA,EAClB;AACA,QAAM,SAAS,2BAA2B,UAAU,QAAQ;AAC5D,MAAI,CAAC,OAAO,SAAS;AACnB,WAAO,wBAAwB,OAAO,KAAK;AAAA,EAC7C;AAEA,QAAM,SAAS,MAAM,oBAAoB,OAAO,MAAM,KAAK,IAAI;AAC/D,MAAI,CAAC,OAAO,IAAI;AACd,QAAI,OAAO,WAAW,KAAK;AACzB,aAAO,KAAK,EAAE,OAAO,OAAO,MAAM,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACtD;AACA,QAAI,OAAO,WAAW,KAAK;AACzB,aAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AACA,QAAI,OAAO,WAAW,KAAK;AACzB,aAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AACA,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,EAAE,OAAO,IAAI;AACnB,QAAM,QAAQC,gBAAe,OAAO,WAAW;AAC/C,QAAM,WAAW,CAAC,OAAO,UAAU,OAAO,SAAS,OAAO,OAAO,GAAG,OAAO,QAAQ;AAEnF,QAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,KAAK,EAAE,KAAK,GAAG,QAAQ,EAAE,IAAe;AAC1E,QAAM,aAAa,KAAK,WAAW,CAAC;AAEpC,QAAM,SAAS,oBAAoB,YAAY;AAAA,IAC7C,SAAS,OAAO;AAAA,IAChB,OAAO,OAAO;AAAA,IACd,UAAU,OAAO;AAAA,IACjB,SAAS,OAAO;AAAA,IAChB,UAAU,OAAO;AAAA,IACjB,SAAS,YAAY,IAAI;AAAA,IACzB,iBAAiB,OAAO;AAAA,EAC1B,CAAC;AAED,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB,OAAO,OAAO;AAAA,IACd,aAAa,OAAO;AAAA,IACpB,QAAQ;AAAA,MACN,OAAO,IAAI,KAAK,OAAO,OAAO,EAAE,YAAY;AAAA,MAC5C,KAAK,IAAI,KAAK,OAAO,KAAK,EAAE,YAAY;AAAA,IAC1C;AAAA,IACA,SAAS,OAAO;AAAA,IAChB;AAAA,EACF,CAAC;AACH;AAzDsB;AA6FtB,eAAe,oBACb,QACA,KACA,MAC6B;AAC7B,QAAM,UAAUC,gBAAe,OAAO,MAAM;AAC5C,MAAI,CAAC,QAAQ,QAAQ;AACnB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,kBAAkB;AAAA,EAC5D;AAEA,QAAM,WAAWC,iBAAgB,OAAO,YAAY,IAAI;AACxD,MAAI,CAAC,UAAU;AACb,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,mBAAmB;AAAA,EAC7D;AAEA,QAAM,MAAM,KAAK,IAAI;AACrB,QAAM,QAAQC,gBAAe,OAAO,KAAK,GAAG;AAC5C,MAAI,UAAU,MAAM;AAClB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,wBAAwB;AAAA,EAClE;AAEA,QAAM,eAAe,QAAQ,KAAK,KAAK,KAAK;AAC5C,MAAI,UAAUA,gBAAe,OAAO,OAAO,YAAY;AACvD,MAAI,YAAY,MAAM;AACpB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,0BAA0B;AAAA,EACpE;AAEA,MAAI,WAAW,OAAO;AACpB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,2BAA2B;AAAA,EACrE;AAEA,QAAM,QAAQ,OAAO,SAAS;AAC9B,QAAM,YAAY,QAAQ;AAC1B,MAAI,QAAQ,UAAU,WAAW;AAC/B,cAAU,QAAQ;AAAA,EACpB;AAEA,QAAM,QAAQ,iBAAiB,MAAM,GAAG;AACxC,QAAM,UAAU,MAAM;AACtB,QAAM,WAAW,OAAO,SAAS,UAAU,UAAU;AACrD,QAAM,kBAAkB,UAAU,IAAI;AAEtC,QAAM,aAAuB,CAAC,gDAAgD;AAC9E,QAAM,WAAkB,CAAC;AACzB,MAAI;AAEJ,MAAI,OAAO,UAAU,UAAU;AAC7B,QAAI,CAAC,OAAO,QAAQ;AAClB,aAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,gDAAgD;AAAA,IAC1F;AACA,UAAM,aAAa,MAAM,gBAAgB,OAAO,QAAQ,KAAK,OAAO;AACpE,QAAI,CAAC,YAAY;AACf,aAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,mBAAmB;AAAA,IAC7D;AAEA,UAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,wEAAwE,EAChF,KAAK,UAAU,EACf,MAAwD;AAC3D,QAAI,CAAC,KAAK;AACR,aAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,mBAAmB;AAAA,IAC7D;AAEA,QAAI,CAAC,SAAS;AACZ,YAAM,UAAW,MAAM,QAAqB,CAAC;AAC7C,UAAI,CAAC,QAAQ,SAAS,IAAI,cAAc,EAAE,GAAG;AAC3C,eAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,YAAY;AAAA,MACtD;AAAA,IACF;AAEA,eAAW,KAAK,iBAAiB;AACjC,aAAS,KAAK,IAAI,SAAS;AAE3B,UAAM,YAAY,gBAAgB,IAAI,WAAW,OAAO;AACxD,UAAM,SAAS,MAAM,kBAAkB,IAAI,WAAW,KAAK,OAAO;AAClE,sBAAkB,EAAE,MAAM,UAAU,WAAW,WAAW,OAAO;AAAA,EACnE,WAAW,OAAO,UAAU,WAAW;AACrC,QAAI,SAAS;AACX,UAAI,CAAC,OAAO,SAAS;AACnB,eAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,kDAAkD;AAAA,MAC5F;AACA,YAAM,SAASC,eAAc,gBAAgB,CAAC,OAAO,OAAO,CAAC;AAC7D,iBAAW,KAAK,MAAM;AACtB,eAAS,KAAK,OAAO,OAAO;AAC5B,wBAAkB,EAAE,MAAM,WAAW,aAAa,CAAC,OAAO,OAAO,EAAE;AAAA,IACrE,OAAO;AACL,YAAM,UAAW,MAAM,QAAqB,CAAC;AAC7C,UAAI,CAAC,QAAQ,QAAQ;AACnB,mBAAW,KAAK,KAAK;AACrB,0BAAkB,EAAE,MAAM,WAAW,aAAa,CAAC,EAAE;AAAA,MACvD,OAAO;AACL,YAAI;AACJ,YAAI,OAAO,SAAS;AAClB,cAAI,CAAC,QAAQ,SAAS,OAAO,OAAO,GAAG;AACrC,mBAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,YAAY;AAAA,UACtD;AACA,qBAAW,CAAC,OAAO,OAAO;AAAA,QAC5B,WAAW,QAAQ,WAAW,GAAG;AAC/B,qBAAW,CAAC,GAAG,OAAO;AAAA,QACxB,OAAO;AACL,iBAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,8CAA8C;AAAA,QACxF;AACA,cAAM,SAASA,eAAc,gBAAgB,QAAQ;AACrD,mBAAW,KAAK,MAAM;AACtB,iBAAS,KAAK,GAAG,QAAQ;AACzB,0BAAkB,EAAE,MAAM,WAAW,aAAa,SAAS;AAAA,MAC7D;AAAA,IACF;AAAA,EACF,OAAO;AAEL,QAAI,SAAS;AACX,UAAI,OAAO,SAAS;AAClB,cAAM,SAASA,eAAc,gBAAgB,CAAC,OAAO,OAAO,CAAC;AAC7D,mBAAW,KAAK,MAAM;AACtB,iBAAS,KAAK,OAAO,OAAO;AAC5B,0BAAkB,EAAE,MAAM,SAAS,aAAa,CAAC,OAAO,OAAO,EAAE;AAAA,MACnE,OAAO;AACL,0BAAkB,EAAE,MAAM,SAAS,aAAa,KAAK;AAAA,MACvD;AAAA,IACF,OAAO;AACL,YAAM,UAAW,MAAM,QAAqB,CAAC;AAC7C,UAAI,CAAC,QAAQ,QAAQ;AACnB,mBAAW,KAAK,KAAK;AACrB,0BAAkB,EAAE,MAAM,SAAS,aAAa,CAAC,EAAE;AAAA,MACrD,OAAO;AACL,YAAI,WAAW,CAAC,GAAG,OAAO;AAC1B,YAAI,OAAO,SAAS;AAClB,cAAI,CAAC,QAAQ,SAAS,OAAO,OAAO,GAAG;AACrC,mBAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,YAAY;AAAA,UACtD;AACA,qBAAW,CAAC,OAAO,OAAO;AAAA,QAC5B;AACA,cAAM,SAASA,eAAc,gBAAgB,QAAQ;AACrD,mBAAW,KAAK,MAAM;AACtB,iBAAS,KAAK,GAAG,QAAQ;AACzB,0BAAkB,EAAE,MAAM,SAAS,aAAa,SAAS;AAAA,MAC3D;AAAA,IACF;AAAA,EACF;AAEA,MAAI,CAAC,WAAW,MAAM,QAAQ;AAC5B,eAAW,KAAK,MAAM,MAAM;AAC5B,aAAS,KAAK,GAAG,MAAM,IAAI;AAAA,EAC7B;AAEA,QAAM,cAAc,WAAW,KAAK,OAAO;AAE3C,SAAO;AAAA,IACL,IAAI;AAAA,IACJ,QAAQ;AAAA,MACN;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;AAjKe;AAmKf,SAASH,gBAAe,KAAgC;AACtD,MAAI,CAAC,IAAK,QAAO,CAAC,GAAG,yBAAyB;AAC9C,QAAM,QAAQ,IACX,MAAM,GAAG,EACT,IAAI,CAAC,SAAS,KAAK,KAAK,CAAC,EACzB,OAAO,OAAO;AACjB,QAAM,UAAU,IAAI,IAAI,yBAAyB;AACjD,SAAO,MAAM,OAAO,CAAC,SAAS,QAAQ,IAAI,IAAI,CAAC;AACjD;AARS,OAAAA,iBAAA;AAUT,SAASC,iBAAgB,UAA8B;AACrD,MAAI,CAAC,SAAU,QAAO,uBAAuB,IAAI;AACjD,SAAO,uBAAuB,QAAQ,KAAK;AAC7C;AAHS,OAAAA,kBAAA;AAKT,SAASC,gBAAe,OAA2C,UAAiC;AAClG,MAAI,SAAS,KAAM,QAAO;AAC1B,MAAI,OAAO,UAAU,SAAU,QAAO,OAAO,SAAS,KAAK,IAAI,QAAQ;AACvE,QAAM,UAAU,OAAO,KAAK,EAAE,KAAK;AACnC,MAAI,CAAC,QAAS,QAAO;AACrB,MAAI,QAAQ,KAAK,OAAO,GAAG;AACzB,UAAME,UAAS,OAAO,SAAS,SAAS,EAAE;AAC1C,WAAO,OAAO,MAAMA,OAAM,IAAI,OAAOA;AAAA,EACvC;AACA,QAAM,SAAS,KAAK,MAAM,OAAO;AACjC,SAAO,OAAO,MAAM,MAAM,IAAI,OAAO;AACvC;AAXS,OAAAF,iBAAA;AAaT,SAASC,eAAc,QAAgB,QAAkB;AACvD,MAAI,CAAC,OAAO,OAAQ,QAAO;AAC3B,QAAM,eAAe,OAAO,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AACnD,SAAO,GAAG,MAAM,QAAQ,YAAY;AACtC;AAJS,OAAAA,gBAAA;AAMT,SAASJ,gBAAe,aAAqB;AAC3C,SAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAkBK,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA+CzB;AAlES,OAAAA,iBAAA;AAoET,eAAe,gBACb,KACA,WACA,OACA;AACA,QAAM,OAAyB,CAAC;AAChC,WAAS,IAAI,GAAG,IAAI,UAAU,QAAQ,KAAK,oBAAoB;AAC7D,UAAM,QAAQ,UAAU,MAAM,GAAG,IAAI,kBAAkB;AACvD,UAAM,eAAe,MAAM,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AAClD,QAAI,QAAQ,oBAAoB,YAAY;AAC5C,UAAM,OAAc,CAAC,GAAG,KAAK;AAE7B,QAAI,CAAC,MAAM,WAAW,MAAM,QAAQ;AAClC,cAAQ,SAAS,OAAO,MAAM,OAAO,QAAQ,cAAc,EAAE,CAAC;AAC9D,WAAK,KAAK,GAAG,MAAM,IAAI;AAAA,IACzB;AAEA,UAAM,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cA4BJ,KAAK;AAAA;AAGf,UAAM,SAAS,MAAM,IAAI,GAAG,QAAQ,KAAK,EAAE,KAAK,GAAG,IAAI,EAAE,IAAoB;AAC7E,SAAK,KAAK,GAAI,OAAO,WAAW,CAAC,CAAE;AAAA,EACrC;AACA,SAAO;AACT;AApDe;AAsDf,eAAe,iBACb,KACA,KACA,SACA,SACA;AACA,QAAM,SAAS,MAAM,kBAAkB,IAAI,WAAW,KAAK,OAAO;AAClE,QAAM,YAAY,gBAAgB,IAAI,WAAW,OAAO;AACxD,QAAM,UAAUM,eAAc,IAAI,YAAY;AAC9C,QAAM,SAAkC;AAAA,IACtC,IAAI,IAAI,MAAM;AAAA,IACd,YAAY,IAAI,cAAc;AAAA,IAC9B,QAAQ,IAAI,kBAAkB;AAAA,IAC9B,MAAM,IAAI,QAAQ;AAAA,IAClB,SAAS,IAAI,WAAW;AAAA,IACxB,aAAa,IAAI,eAAe;AAAA,IAChC;AAAA,EACF;AAEA,MAAI,QAAQ,YAAY,OAAO;AAC7B,WAAO,UAAU,oBAAoB,IAAI,SAAS,OAAO;AACzD,WAAO,UAAU,oBAAoB,IAAI,SAAS,OAAO;AACzD,WAAO,QAAQ,oBAAoB,IAAI,OAAO,OAAO;AACrD,WAAO,WAAW,oBAAoB,IAAI,UAAU,OAAO;AAC3D,WAAO,UAAU,oBAAoB,IAAI,SAAS,SAAS,CAAC;AAC5D,WAAO,eAAe,oBAAoB,IAAI,cAAc,SAAS,CAAC;AACtE,WAAO,WAAW,oBAAoB,IAAI,UAAU,SAAS,CAAC;AAC9D,WAAO,UAAU,oBAAoB,IAAI,SAAS,SAAS,CAAC;AAC5D,WAAO,SAAS,oBAAoB,IAAI,QAAQ,SAAS,CAAC;AAC1D,WAAO,YAAY,oBAAoB,IAAI,WAAW,SAAS,CAAC;AAChE,WAAO,MAAM,oBAAoB,IAAI,KAAK,SAAS,CAAC;AAAA,EACtD;AAEA,MAAI,QAAQ,WAAW,OAAO;AAC5B,WAAO,SAAS,gBAAgB,IAAI,WAAW;AAAA,EACjD;AAEA,SAAO;AAAA,IACL;AAAA,IACA,WAAW;AAAA,IACX,YAAY,IAAI,cAAc;AAAA,IAC9B,MAAM,IAAI,QAAQ;AAAA,IAClB,QAAQ,IAAI,kBAAkB;AAAA,IAC9B,cAAc,IAAI,gBAAgB;AAAA,IAClC;AAAA,EACF;AACF;AA9Ce;AAyDf,SAAS,oBAAoB,MAAmB,SAA6B;AAC3E,QAAM,EAAE,SAAS,OAAO,UAAU,SAAS,UAAU,SAAS,gBAAgB,IAAI;AAElF,QAAM,MAAM,oBAAI,IAAuB;AACvC,aAAW,OAAO,MAAM;AACtB,QAAI,IAAI,IAAI,iBAAiB,GAAG;AAAA,EAClC;AAEA,QAAM,cAAc,KAAK,MAAM,UAAU,QAAQ,IAAI;AACrD,QAAM,YAAY,KAAK,MAAM,QAAQ,QAAQ,IAAI;AAEjD,QAAM,UAAuB,CAAC;AAE9B,MAAI,aAAa,SAAS;AACxB,QAAI,UAAU;AACd,QAAI,aAAmD;AAEvD,WAAO,WAAW,WAAW;AAC3B,YAAM,MAAM,IAAI,IAAI,OAAO;AAC3B,UAAI,KAAK;AACP,gBAAQ,KAAK,GAAG;AAChB,qBAAa,kBAAkB,GAAG;AAAA,MACpC,WAAW,YAAY;AACrB,gBAAQ,KAAK;AAAA,UACX,iBAAiB;AAAA,UACjB,cAAc;AAAA,UACd,YAAY,WAAW;AAAA,UACvB,YAAY,WAAW;AAAA,UACvB,YAAY,WAAW;AAAA,UACvB,eAAe,WAAW;AAAA,UAC1B,eAAe,WAAW;AAAA,UAC1B,eAAe,WAAW;AAAA,UAC1B,SAAS,WAAW;AAAA,UACpB,SAAS,WAAW;AAAA,UACpB,SAAS,WAAW;AAAA,UACpB,aAAa,WAAW;AAAA,UACxB,aAAa,WAAW;AAAA,UACxB,aAAa,WAAW;AAAA,UACxB,aAAa,WAAW;AAAA,QAC1B,CAAC;AAAA,MACH;AACA,iBAAW;AAAA,IACb;AAAA,EACF,OAAO;AACL,YAAQ,KAAK,GAAG,IAAI;AAAA,EACtB;AAEA,SAAO,QAAQ,IAAI,CAAC,SAAS;AAAA,IAC3B,cAAc,IAAI,KAAK,IAAI,eAAe,EAAE,YAAY;AAAA,IACxD,cAAc,IAAI;AAAA,IAClB,QAAQ,kBAAkB,KAAK,SAAS,SAAS,eAAe;AAAA,EAClE,EAAE;AACJ;AApDS;AAsDT,SAAS,kBAAkB,KAAgB;AACzC,SAAO;AAAA,IACL,QAAQ,IAAI;AAAA,IACZ,WAAW,IAAI;AAAA,IACf,KAAK,IAAI;AAAA,IACT,SAAS,IAAI;AAAA,IACb,SAAS,IAAI;AAAA,IACb,SAAS,IAAI;AAAA,IACb,SAAS,IAAI;AAAA,EACf;AACF;AAVS;AAYT,SAAS,kBACP,KACA,SACA,SACA,iBACA;AACA,QAAM,SAAwD,CAAC;AAC/D,aAAW,UAAU,SAAS;AAC5B,UAAM,QAAuC,CAAC;AAC9C,UAAM,MAAM,iBAAiB,KAAK,MAAM;AACxC,UAAM,MAAM,oBAAoB,KAAK,SAAS,iBAAiB,CAAC;AAEhE,QAAI,qBAAqB,IAAI,MAAM,GAAG;AACpC,YAAM,SAAS,aAAa,KAAK,MAAM;AACvC,YAAM,SAAS,aAAa,KAAK,MAAM;AACvC,YAAM,MAAM,oBAAoB,QAAQ,SAAS,iBAAiB,CAAC;AACnE,YAAM,MAAM,oBAAoB,QAAQ,SAAS,iBAAiB,CAAC;AAAA,IACrE;AAEA,WAAO,MAAM,IAAI;AAAA,EACnB;AACA,SAAO;AACT;AAtBS;AAwBT,SAAS,iBAAiB,KAAgB,QAAkD;AAC1F,UAAQ,QAAQ;AAAA,IACd,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb;AACE,aAAO;AAAA,EACX;AACF;AAnBS;AAqBT,SAAS,aAAa,KAAgB,QAAkD;AACtF,UAAQ,QAAQ;AAAA,IACd,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb;AACE,aAAO;AAAA,EACX;AACF;AAXS;AAaT,SAAS,aAAa,KAAgB,QAAkD;AACtF,UAAQ,QAAQ;AAAA,IACd,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb;AACE,aAAO;AAAA,EACX;AACF;AAXS;AAaT,SAASA,eAAc,SAAoC;AACzD,MAAI,CAAC,QAAS,QAAO;AACrB,MAAI;AACF,WAAO,KAAK,MAAM,OAAO;AAAA,EAC3B,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAPS,OAAAA,gBAAA;AAST,SAAS,oBAAoB,WAAqB,OAAiB;AACjE,QAAM,OAAO,oBAAI,IAAY;AAC7B,QAAM,SAAmB,CAAC;AAC1B,QAAM,WAAW,IAAI,IAAI,KAAK;AAC9B,aAAW,SAAS,WAAW;AAC7B,QAAI,SAAS,IAAI,KAAK,KAAK,CAAC,KAAK,IAAI,KAAK,GAAG;AAC3C,WAAK,IAAI,KAAK;AACd,aAAO,KAAK,KAAK;AAAA,IACnB;AAAA,EACF;AACA,aAAW,SAAS,OAAO;AACzB,QAAI,CAAC,KAAK,IAAI,KAAK,GAAG;AACpB,WAAK,IAAI,KAAK;AACd,aAAO,KAAK,KAAK;AAAA,IACnB;AAAA,EACF;AACA,SAAO;AACT;AAjBS;;;ACvwBT,IAAMC,wBAAuB,oBAAI,IAAwD;AAAA,EACvF;AAAA,EACA;AAAA,EACA;AACF,CAAC;AACM,IAAM,gCAAgC;AAEtC,SAAS,2BAA2B,KAAkB;AAC3D,QAAM,MACJ,OAAO,IAAI,gCAAgC,WACvC,IAAI,4BAA4B,KAAK,IACrC;AACN,MAAI,KAAK;AACP,UAAM,SAAS,OAAO,SAAS,KAAK,EAAE;AACtC,QAAI,OAAO,SAAS,MAAM,KAAK,SAAS,GAAG;AACzC,aAAO,SAAS,KAAK;AAAA,IACvB;AAAA,EACF;AACA,SAAO,gCAAgC,KAAK;AAC9C;AAZgB;AAchB,eAAsB,2BAA2B,KAAc,KAAU,KAAwB;AAC/F,QAAM,OAAO,wBAAwB,GAAG;AACxC,MAAI,SAAS,UAAU;AACrB,WAAO,iCAAiC,KAAK,GAAG;AAAA,EAClD;AAEA,QAAM,YAAY,SAAS,YAAY,IAAI,MAAM,IAAI;AAErD,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,SAAS,mBAA8C,4BAA4B,OAAO;AAChG,MAAI,CAAC,OAAO,SAAS;AACnB,WAAO,wBAAwB,OAAO,MAAM;AAAA,EAC9C;AAEA,QAAM,OAAO,OAAO;AACpB,QAAM,aAAa,MAAM,0BAA0B,KAAK,MAAM,KAAK,OAAO;AAC1E,QAAM,EAAE,OAAO,WAAW,aAAa,cAAc,IAAI;AAEzD,MAAI,KAAK,QAAQ,WAAW,GAAG;AAC7B,UAAMC,YAAW,KAAK,EAAE,cAAc,OAAO,GAAG,OAAO,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC;AACxE,QAAI,WAAW;AACb;AAAA,QACE;AAAA,QACA;AAAA,UACE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACAA,UAAS,MAAM;AAAA,UACf;AAAA,QACF;AAAA,MACF;AAAA,IACF;AACA,WAAOA;AAAA,EACT;AAEA,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,UAAMA,YAAW,KAAK;AAAA,MACpB,cAAc,OAAO;AAAA,MACrB,OAAO,CAAC;AAAA,MACR,SAAS,CAAC,GAAG,IAAI,IAAI,KAAK,OAAO,CAAC;AAAA,IACpC,CAAC;AACD,QAAI,WAAW;AACb;AAAA,QACE;AAAA,QACA;AAAA,UACE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACAA,UAAS,MAAM;AAAA,UACf;AAAA,QACF;AAAA,MACF;AAAA,IACF;AACA,WAAOA;AAAA,EACT;AAEA,MAAI,CAAC,YAAY,QAAQ;AACvB,UAAMA,YAAW,KAAK;AAAA,MACpB,cAAc,OAAO;AAAA,MACrB,OAAO,CAAC;AAAA,MACR,SAASC,qBAAoB,KAAK,SAAS,aAAa;AAAA,IAC1D,CAAC;AACD,QAAI,WAAW;AACb;AAAA,QACE;AAAA,QACA;AAAA,UACE;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACAD,UAAS,MAAM;AAAA,UACf;AAAA,QACF;AAAA,MACF;AAAA,IACF;AACA,WAAOA;AAAA,EACT;AAEA,QAAM,OAAO,MAAM,0BAA0B,KAAK,aAAa,KAAK;AACpE,QAAM,SAAS,IAAI,IAAI,KAAK,IAAI,CAAC,QAAQ,CAAC,IAAI,WAAW,GAAG,CAAC,CAAC;AAC9D,QAAM,UAAiC,KAAK,WAAW,EAAE,QAAQ,MAAM,SAAS,KAAK;AACrF,QAAM,QAAmB,CAAC;AAC1B,QAAM,OAAO,oBAAI,IAAY;AAC7B,QAAM,aAAa,IAAI,IAAY,aAAa;AAEhD,aAAW,SAAS,WAAW;AAC7B,QAAI,CAAC,MAAM,SAAU;AACrB,QAAI,KAAK,IAAI,MAAM,QAAQ,EAAG;AAC9B,UAAM,MAAM,OAAO,IAAI,MAAM,QAAQ;AACrC,QAAI,CAAC,KAAK;AACR,iBAAW,IAAI,MAAM,KAAK;AAC1B;AAAA,IACF;AACA,SAAK,IAAI,MAAM,QAAQ;AACvB,QAAI;AACF,YAAM,YAAY,MAAM,sBAAsB,KAAK,KAAK,SAAS,IAAI;AACrE,YAAM,KAAK,SAAS;AAAA,IACtB,SAAS,OAAO;AACd,uBAAiB,KAAK,EAAE,OAAO,8BAA8B,CAAC,EAAE;AAAA,QAC9D;AAAA,QACA,EAAE,OAAO,WAAW,MAAM,UAAU,KAAK;AAAA,MAC3C;AAAA,IACF;AAAA,EACF;AAEA,QAAM,WAAW,KAAK;AAAA,IACpB,cAAc,OAAO;AAAA,IACrB;AAAA,IACA,SAASC,qBAAoB,KAAK,SAAS,MAAM,KAAK,UAAU,CAAC;AAAA,EACnE,CAAC;AAED,MAAI,WAAW;AACb;AAAA,MACE;AAAA,MACA;AAAA,QACE;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,SAAS,MAAM;AAAA,QACf;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAEA,SAAO;AACT;AAzIsB;AA2ItB,eAAsB,sBAAsB,KAAc,KAAU,KAAwB;AAC1F,QAAM,OAAO,wBAAwB,GAAG;AACxC,MAAI,SAAS,UAAU;AACrB,WAAO,4BAA4B,KAAK,GAAG;AAAA,EAC7C;AAEA,QAAM,YAAY,SAAS,YAAY,IAAI,MAAM,IAAI;AAErD,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,WAA0C,CAAC;AACjD,QAAM,gBAAgB,IAAI;AAC1B,aAAW,CAAC,KAAK,KAAK,KAAK,eAAe;AACxC,aAAS,GAAG,IAAI;AAAA,EAClB;AACA,QAAM,SAAS,2BAA2B,UAAU,QAAQ;AAC5D,MAAI,CAAC,OAAO,SAAS;AACnB,WAAO,wBAAwB,OAAO,KAAK;AAAA,EAC7C;AAEA,QAAM,SAAS,MAAM,6BAA6B,OAAO,MAAM,KAAK,IAAI;AACxE,MAAI,CAAC,OAAO,IAAI;AACd,QAAI,OAAO,WAAW,KAAK;AACzB,aAAO,KAAK,EAAE,OAAO,OAAO,MAAM,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACtD;AACA,QAAI,OAAO,WAAW,KAAK;AACzB,aAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AACA,QAAI,OAAO,WAAW,KAAK;AACzB,aAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AACA,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,EAAE,OAAO,IAAI;AACnB,QAAM,OAAO,MAAM,qBAAqB,KAAK,MAAM;AAEnD,QAAM,sBAAsB,2BAA2B,GAAG;AAC1D,QAAM,SAASC,qBAAoB,MAAM;AAAA,IACvC,SAAS,OAAO;AAAA,IAChB,OAAO,OAAO;AAAA,IACd,UAAU,OAAO;AAAA,IACjB,SAAS,OAAO;AAAA,IAChB,UAAU,OAAO;AAAA,IACjB,SAAS,YAAY,IAAI;AAAA,IACzB,iBAAiB,OAAO;AAAA,IACxB;AAAA,EACF,CAAC;AAED,QAAM,WAAW,KAAK;AAAA,IACpB,cAAc,OAAO;AAAA,IACrB,OAAO,OAAO;AAAA,IACd,aAAa,OAAO;AAAA,IACpB,QAAQ;AAAA,MACN,OAAO,IAAI,KAAK,OAAO,OAAO,EAAE,YAAY;AAAA,MAC5C,KAAK,IAAI,KAAK,OAAO,KAAK,EAAE,YAAY;AAAA,IAC1C;AAAA,IACA,SAAS,OAAO;AAAA,IAChB;AAAA,EACF,CAAC;AAED,MAAI,WAAW;AACb;AAAA,MACE;AAAA,MACA;AAAA,QACE;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,SAAS,MAAM;AAAA,QACf;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAEA,SAAO;AACT;AA9EsB;AA2FtB,SAASA,qBAAoB,MAA4B,SAA6B;AACpF,QAAM;AAAA,IACJ;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,IAAI;AAEJ,QAAM,MAAM,oBAAI,IAAgC;AAChD,aAAW,OAAO,MAAM;AACtB,QAAI,IAAI,IAAI,iBAAiB,GAAG;AAAA,EAClC;AAEA,QAAM,cAAc,KAAK,MAAM,UAAU,QAAQ,IAAI;AACrD,QAAM,YAAY,KAAK,MAAM,QAAQ,QAAQ,IAAI;AAEjD,QAAM,UAA8D,CAAC;AAErE,MAAI,aAAa,SAAS;AACxB,QAAI,UAAU;AACd,QAAI,aAAmD;AACvD,QAAI,mBAAkC;AAEtC,WAAO,WAAW,WAAW;AAC3B,YAAM,MAAM,IAAI,IAAI,OAAO;AAC3B,UAAI,KAAK;AACP,gBAAQ,KAAK,EAAE,KAAK,OAAO,MAAM,CAAC;AAClC,2BAAmB;AACnB,qBAAaC,mBAAkB,GAAG;AAAA,MACpC,WAAW,YAAY;AACrB,YAAI,qBAAqB,QAAQ,UAAU,mBAAmB,qBAAqB;AACjF,uBAAa;AACb,6BAAmB;AAAA,QACrB,OAAO;AACL,gBAAM,eAAmC;AAAA,YACvC,iBAAiB;AAAA,YACjB,cAAc;AAAA,YACd,YAAY,WAAW;AAAA,YACvB,YAAY,WAAW;AAAA,YACvB,YAAY,WAAW;AAAA,YACvB,eAAe,WAAW;AAAA,YAC1B,eAAe,WAAW;AAAA,YAC1B,eAAe,WAAW;AAAA,YAC1B,SAAS,WAAW;AAAA,YACpB,SAAS,WAAW;AAAA,YACpB,SAAS,WAAW;AAAA,YACpB,aAAa,WAAW;AAAA,YACxB,aAAa,WAAW;AAAA,YACxB,aAAa,WAAW;AAAA,YACxB,aAAa,WAAW;AAAA,UAC1B;AACA,kBAAQ,KAAK,EAAE,KAAK,cAAc,OAAO,KAAK,CAAC;AAAA,QACjD;AAAA,MACF;AACA,iBAAW;AAAA,IACb;AAAA,EACF,OAAO;AACL,eAAW,OAAO,MAAM;AACtB,cAAQ,KAAK,EAAE,KAAK,OAAO,MAAM,CAAC;AAAA,IACpC;AAAA,EACF;AAEA,SAAO,QAAQ,IAAI,CAAC,EAAE,KAAK,MAAM,OAAO;AAAA,IACtC,cAAc,IAAI,KAAK,IAAI,eAAe,EAAE,YAAY;AAAA,IACxD,cAAc,IAAI;AAAA,IAClB;AAAA,IACA,QAAQC,mBAAkB,KAAK,SAAS,SAAS,eAAe;AAAA,EAClE,EAAE;AACJ;AAxES,OAAAF,sBAAA;AA0ET,SAASC,mBAAkB,KAAyB;AAClD,SAAO;AAAA,IACL,QAAQ,IAAI;AAAA,IACZ,WAAW,IAAI;AAAA,IACf,KAAK,IAAI;AAAA,IACT,SAAS,IAAI;AAAA,IACb,SAAS,IAAI;AAAA,IACb,SAAS,IAAI;AAAA,IACb,SAAS,IAAI;AAAA,EACf;AACF;AAVS,OAAAA,oBAAA;AAYT,SAASC,mBACP,KACA,SACA,SACA,iBACA;AACA,QAAM,SAAwD,CAAC;AAC/D,aAAW,UAAU,SAAS;AAC5B,UAAM,QAAuC,CAAC;AAC9C,UAAM,MAAMC,kBAAiB,KAAK,MAAM;AACxC,UAAM,MAAM,oBAAoB,KAAK,SAAS,iBAAiB,CAAC;AAEhE,QAAIN,sBAAqB,IAAI,MAAM,GAAG;AACpC,YAAM,SAASO,cAAa,KAAK,MAAM;AACvC,YAAM,SAASC,cAAa,KAAK,MAAM;AACvC,YAAM,MAAM,oBAAoB,QAAQ,SAAS,iBAAiB,CAAC;AACnE,YAAM,MAAM,oBAAoB,QAAQ,SAAS,iBAAiB,CAAC;AAAA,IACrE;AAEA,WAAO,MAAM,IAAI;AAAA,EACnB;AACA,SAAO;AACT;AAtBS,OAAAH,oBAAA;AAwBT,SAASC,kBAAiB,KAAyB,QAAkD;AACnG,UAAQ,QAAQ;AAAA,IACd,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb;AACE,aAAO;AAAA,EACX;AACF;AAnBS,OAAAA,mBAAA;AAqBT,SAASC,cAAa,KAAyB,QAAkD;AAC/F,UAAQ,QAAQ;AAAA,IACd,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb;AACE,aAAO;AAAA,EACX;AACF;AAXS,OAAAA,eAAA;AAaT,SAASC,cAAa,KAAyB,QAAkD;AAC/F,UAAQ,QAAQ;AAAA,IACd,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb,KAAK;AACH,aAAO,IAAI;AAAA,IACb;AACE,aAAO;AAAA,EACX;AACF;AAXS,OAAAA,eAAA;AAaT,SAASN,qBAAoB,WAAqB,OAAiB;AACjE,QAAM,OAAO,oBAAI,IAAY;AAC7B,QAAM,SAAmB,CAAC;AAC1B,QAAM,WAAW,IAAI,IAAI,KAAK;AAC9B,aAAW,SAAS,WAAW;AAC7B,QAAI,SAAS,IAAI,KAAK,KAAK,CAAC,KAAK,IAAI,KAAK,GAAG;AAC3C,WAAK,IAAI,KAAK;AACd,aAAO,KAAK,KAAK;AAAA,IACnB;AAAA,EACF;AACA,aAAW,SAAS,OAAO;AACzB,QAAI,CAAC,KAAK,IAAI,KAAK,GAAG;AACpB,WAAK,IAAI,KAAK;AACd,aAAO,KAAK,KAAK;AAAA,IACnB;AAAA,EACF;AACA,SAAO;AACT;AAjBS,OAAAA,sBAAA;AAmBT,SAAS,wBAAwB,KAAgC;AAC/D,QAAM,MAAM,OAAO,IAAI,2BAA2B,EAAE,EAAE,KAAK,EAAE,YAAY;AACzE,MAAI,QAAQ,YAAY,QAAQ,OAAO;AACrC,WAAO;AAAA,EACT;AACA,MAAI,QAAQ,aAAa,QAAQ,YAAY,QAAQ,QAAQ;AAC3D,WAAO;AAAA,EACT;AACA,SAAO;AACT;AATS;AAWT,SAAS,yBAAyB,KAAmC,MAAqB;AACxF,MAAI,KAAK;AACP,QAAI,UAAU,IAAI;AAAA,EACpB,OAAO;AACL,SAAK;AAAA,EACP;AACF;AANS;AAQT,eAAe,0BACb,KACA,WACA,KACA,SACA,kBACA,OACA;AACA,MAAI;AACF,UAAM,iBAAiB,MAAM,QAAQ,WAAW,GAAG;AACnD,UAAM,iBAAiB,KAAK,kBAAkB,gBAAgB,KAAK;AAAA,EACrE,SAAS,OAAO;AACd,qBAAiB,KAAK,EAAE,MAAM,CAAC,EAAE,KAAK,oCAAoC,EAAE,MAAM,CAAC;AAAA,EACrF;AACF;AAde;AAgBf,eAAe,iBACb,KACA,kBACA,gBACA,OACA;AACA,MAAI;AACF,UAAM,eAAe,MAAM,YAAY,gBAAgB;AACvD,UAAM,aAAa,MAAM,YAAY,cAAc;AACnD,UAAM,iBAAiB,iBAAiB,WAAW,eAAe;AAClE,UAAM,eAAe,CAAC,UAAU,cAAc,UAAU;AACxD,QAAI,kBAAkB,cAAc;AAClC,uBAAiB,KAAK,EAAE,MAAM,CAAC,EAAE,KAAK,sCAAsC;AAAA,QAC1E,iBAAiB,iBAAiB;AAAA,QAClC,eAAe,eAAe;AAAA,QAC9B,eAAe;AAAA,QACf,aAAa;AAAA,MACf,CAAC;AAAA,IACH;AAAA,EACF,SAAS,OAAO;AACd,qBAAiB,KAAK,EAAE,MAAM,CAAC,EAAE,KAAK,4CAA4C,EAAE,MAAM,CAAC;AAAA,EAC7F;AACF;AAtBe;AAwBf,eAAe,YAAY,UAAoB;AAC7C,QAAMO,QAAO,MAAM,SAAS,KAAK;AACjC,MAAI,CAACA,MAAM,QAAO;AAClB,MAAI;AACF,WAAO,KAAK,MAAMA,KAAI;AAAA,EACxB,QAAQ;AACN,WAAOA;AAAA,EACT;AACF;AARe;AAUf,SAAS,UAAU,KAAc,KAAc;AAC7C,SAAO,KAAK,UAAU,GAAG,MAAM,KAAK,UAAU,GAAG;AACnD;AAFS;;;AC1gBF,SAAS,wBAAwBC,SAAmB;AACzD,EAAAA,QACG;AAAA,IACC;AAAA,IACA,WAAW,CAAC,KAAK,KAAK,QAAQ,2BAA2B,KAAK,KAAK,GAAG,CAAC;AAAA,EACzE,EACC;AAAA,IACC;AAAA,IACA,WAAW,CAAC,KAAK,KAAK,QAAQ,sBAAsB,KAAK,KAAK,GAAG,CAAC;AAAA,EACpE;AACJ;AAVgB;;;ACFT,IAAM,mBAAmB,CAAC,QAAQ,WAAW,UAAU;AACvD,IAAM,iBAAiB,CAAC,QAAQ,gBAAgB,UAAU;AAC1D,IAAM,gBAAgB,CAAC,eAAe,UAAU,SAAS;AAEzD,IAAM,sBAAsB,iBAAE,KAAK,gBAAgB;AACnD,IAAM,oBAAoB,iBAAE,KAAK,cAAc;AAC/C,IAAM,oBAAoB,iBAAE,KAAK,aAAa;AAE9C,IAAM,oBAAoB,iBAC9B,OAAO;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAAA,EACzE,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAC3E,CAAC,EACA,OAAO;AAEH,IAAM,uBAAuB,iBACjC,OAAO;AAAA,EACN,QAAQ,kBAAkB,SAAS;AAAA,EACnC,UAAU,oBAAoB,SAAS;AAAA,EACvC,QAAQ,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC1C,SAAS,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC3C,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAAA,EACzE,OAAO,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AAAA,EACtD,OAAO,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AACxD,CAAC,EACA,OAAO;AAEH,IAAM,oBAAoB,iBAC9B,OAAO;AAAA,EACN,UAAU,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC5C,WAAW,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC;AAAA,EAClC,YAAY,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC9C,YAAY,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC;AAAA,EACnC,UAAU,oBAAoB,QAAQ,MAAM;AAAA,EAC5C,QAAQ,kBAAkB,QAAQ,MAAM;AAAA,EACxC,SAAS,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG,EAAE,SAAS;AAAA,EACpD,aAAa,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EACzD,UAAU,iBAAE,OAAO,iBAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EACrC,iBAAiB,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AAAA,EAChE,aAAa,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS,EAAE,SAAS;AAAA,EACvE,aAAa,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC/C,aAAa,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AACjD,CAAC,EACA,OAAO;AAEV,IAAM,gBAAgB,iBACnB,OAAO,EACP,KAAK,EACL,IAAI,GAAG,2BAA2B,EAClC,IAAI,KAAM,0CAA0C;AAEvD,IAAM,iBAAiB,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,IAAI,GAAG;AAEhD,IAAM,6BAA6B,iBAAE,mBAAmB,UAAU;AAAA,EACvE,iBACG,OAAO;AAAA,IACN,QAAQ,iBAAE,QAAQ,aAAa;AAAA,IAC/B,SAAS,cAAc,SAAS;AAAA,IAChC,UAAU,eAAe,SAAS;AAAA,EACpC,CAAC,EACA,OAAO;AAAA,EACV,iBACG,OAAO;AAAA,IACN,QAAQ,iBAAE,QAAQ,QAAQ;AAAA,IAC1B,UAAU;AAAA,IACV,SAAS,cAAc,SAAS;AAAA,EAClC,CAAC,EACA,OAAO;AAAA,EACV,iBACG,OAAO;AAAA,IACN,QAAQ,iBAAE,QAAQ,SAAS;AAAA,IAC3B,SAAS,cAAc,SAAS;AAAA,EAClC,CAAC,EACA,OAAO;AACZ,CAAC;AAEM,IAAM,2BAA2B,iBACrC,OAAO;AAAA,EACN,SAAS;AACX,CAAC,EACA,OAAO;;;AChFV,IAAI,qBAAqB;AAEzB,eAAe,kBAAkB,IAAe;AAC9C,MAAI,mBAAoB;AACxB,MAAI;AACF,UAAM,GAAG,QAAQ,0BAA0B,EAAE,IAAI;AACjD,yBAAqB;AAAA,EACvB,SAAS,OAAO;AACd,iBAAa,EAAE,OAAO,KAAK,CAAC,EAAE,KAAK,iCAAiC,EAAE,MAAM,CAAC;AAAA,EAC/E;AACF;AARe;AAUf,eAAsB,gBACpB,IACA,MACY;AACZ,QAAM,kBAAkB,EAAE;AAC1B,QAAM,GAAG,QAAQ,iBAAiB,EAAE,IAAI;AACxC,MAAI;AACF,UAAM,SAAS,MAAM,KAAK;AAC1B,UAAM,GAAG,QAAQ,QAAQ,EAAE,IAAI;AAC/B,WAAO;AAAA,EACT,SAAS,OAAO;AACd,QAAI;AACF,YAAM,GAAG,QAAQ,UAAU,EAAE,IAAI;AAAA,IACnC,SAAS,eAAe;AACtB,mBAAa,EAAE,OAAO,KAAK,CAAC,EAAE,MAAM,kCAAkC;AAAA,QACpE,OAAO;AAAA,QACP,gBAAgB;AAAA,MAClB,CAAC;AAAA,IACH;AACA,UAAM;AAAA,EACR;AACF;AArBsB;;;AC0DtB,SAAS,YAAY,KAA4B;AAC/C,MAAI,WAA2C;AAC/C,MAAI,IAAI,eAAe;AACrB,QAAI;AACF,YAAM,SAAS,KAAK,MAAM,IAAI,aAAa;AAC3C,UAAI,UAAU,OAAO,WAAW,SAAU,YAAW;AAAA,IACvD,QAAQ;AACN,iBAAW;AAAA,IACb;AAAA,EACF;AACA,SAAO;AAAA,IACL,UAAU,IAAI;AAAA,IACd,WAAW,IAAI;AAAA,IACf,YAAY,IAAI;AAAA,IAChB,YAAY,IAAI;AAAA,IAChB,UAAU,IAAI;AAAA,IACd,QAAQ,IAAI;AAAA,IACZ,SAAS,IAAI;AAAA,IACb,aAAa,IAAI;AAAA,IACjB;AAAA,IACA,iBAAiB,IAAI;AAAA,IACrB,aAAa,IAAI;AAAA,IACjB,aAAa,IAAI;AAAA,IACjB,aAAa,IAAI;AAAA,IACjB,YAAY,IAAI;AAAA,IAChB,YAAY,IAAI;AAAA,EAClB;AACF;AA3BS;AA6BT,eAAsB,YAAY,KAAU,QAAuD;AACjG,QAAM,WAAW,OAAO;AACxB,QAAM,KAAK,OAAO,YAAY,OAAO,WAAW;AAChD,QAAM,YAAY,OAAO,cAAc,OAAO;AAC9C,QAAM,YAAY,OAAO,cAAc;AACvC,QAAM,iBAAiB,OAAO,mBAAmB;AACjD,QAAM,aAAa,OAAO,eAAe;AACzC,QAAM,aAAa,OAAO,eAAe;AACzC,QAAM,aAAa,OAAO,eAAe;AACzC,QAAM,UAAU,OAAO,WAAW;AAClC,QAAM,cAAc,OAAO,eAAe;AAC1C,QAAM,eAAe,OAAO,WAAW,KAAK,UAAU,OAAO,QAAQ,IAAI;AAEzE,MAAI,YAAuC,OAAO,cAAc;AAEhE,MAAI,CAAC,WAAW;AACd,UAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,6DAA6D,EACrE,KAAK,QAAQ,EACb,MAAqC;AACxC,QAAI,CAAC,WAAW;AACd,aAAO,EAAE,IAAI,OAAO,QAAQ,mBAAmB;AAAA,IACjD;AACA,gBAAY,UAAU,cAAc;AAAA,EACtC,OAAO;AACL,UAAM,SAAS,MAAM,IAAI,GACtB,QAAQ,oDAAoD,EAC5D,KAAK,QAAQ,EACb,MAAM;AACT,QAAI,CAAC,QAAQ;AACX,aAAO,EAAE,IAAI,OAAO,QAAQ,mBAAmB;AAAA,IACjD;AAAA,EACF;AAEA,MAAI;AACF,UAAM,IAAI,GACP;AAAA,MACC;AAAA;AAAA;AAAA;AAAA;AAAA,IAKF,EACC;AAAA,MACC;AAAA,MACA;AAAA,MACA;AAAA,MACA,OAAO;AAAA,MACP,OAAO;AAAA,MACP,OAAO;AAAA,MACP;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,EACC,IAAI;AAAA,EACT,SAAS,KAAU;AACjB,UAAMC,WAAU,OAAO,KAAK,YAAY,WAAW,IAAI,UAAU,OAAO,GAAG;AAC3E,QAAIA,SAAQ,SAAS,0BAA0B,GAAG;AAChD,aAAO,EAAE,IAAI,OAAO,QAAQ,WAAW;AAAA,IACzC;AACA,UAAM;AAAA,EACR;AAEA,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,kDAAkD,EAC1D,KAAK,EAAE,EACP,MAAgB;AAEnB,MAAI,CAAC,KAAK;AACR,WAAO,EAAE,IAAI,OAAO,QAAQ,mBAAmB;AAAA,EACjD;AAEA,SAAO,EAAE,IAAI,MAAM,OAAO,YAAY,GAAG,EAAE;AAC7C;AA/EsB;AAiFtB,eAAsB,WAAW,KAAU,SAAmD;AAC5F,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AAErB,MAAI,QAAQ,QAAQ;AAClB,YAAQ,SAAS,OAAO,YAAY;AACpC,SAAK,KAAK,QAAQ,MAAM;AAAA,EAC1B;AAEA,MAAI,QAAQ,UAAU;AACpB,YAAQ,SAAS,OAAO,cAAc;AACtC,SAAK,KAAK,QAAQ,QAAQ;AAAA,EAC5B;AAEA,MAAI,QAAQ,WAAW;AACrB,YAAQ,SAAS,OAAO,eAAe;AACvC,SAAK,KAAK,QAAQ,SAAS;AAAA,EAC7B;AAEA,MAAI,QAAQ,eAAe,QAAQ,YAAY,QAAQ;AACrD,UAAM,eAAe,QAAQ,YAAY,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AAChE,YAAQ,SAAS,OAAO,kBAAkB,YAAY,GAAG;AACzD,SAAK,KAAK,GAAG,QAAQ,WAAW;AAAA,EAClC,WAAW,QAAQ,YAAY;AAC7B,YAAQ,SAAS,OAAO,gBAAgB;AACxC,SAAK,KAAK,QAAQ,UAAU;AAAA,EAC9B;AAEA,MAAI,QAAQ,OAAO;AACjB,YAAQ,SAAS,OAAO,iBAAiB;AACzC,SAAK,KAAK,QAAQ,KAAK;AAAA,EACzB;AAEA,MAAI,QAAQ,OAAO;AACjB,YAAQ,SAAS,OAAO,iBAAiB;AACzC,SAAK,KAAK,QAAQ,KAAK;AAAA,EACzB;AAEA,QAAM,MAAM,wBAAwB,KAAK;AACzC,OAAK,KAAK,QAAQ,KAAK;AAEvB,QAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,GAAG,EAAE,KAAK,GAAG,IAAI,EAAE,IAAc;AACnE,UAAQ,KAAK,WAAW,CAAC,GAAG,IAAI,WAAW;AAC7C;AA3CsB;AAmEtB,SAAS,mBAAmB,KAA0C;AACpE,MAAI,WAA2C;AAC/C,MAAI,IAAI,eAAe;AACrB,QAAI;AACF,YAAM,SAAS,KAAK,MAAM,IAAI,aAAa;AAC3C,UAAI,UAAU,OAAO,WAAW,SAAU,YAAW;AAAA,IACvD,QAAQ;AACN,iBAAW;AAAA,IACb;AAAA,EACF;AAEA,SAAO;AAAA,IACL,YAAY,IAAI;AAAA,IAChB,UAAU,IAAI;AAAA,IACd,QAAQ,IAAI;AAAA,IACZ,WAAW,IAAI;AAAA,IACf,cAAc,IAAI;AAAA,IAClB,MAAM,IAAI;AAAA,IACV;AAAA,IACA,YAAY,IAAI;AAAA,EAClB;AACF;AArBS;AAuBT,eAAsB,SAAS,KAAU,SAA8C;AACrF,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,kDAAkD,EAC1D,KAAK,OAAO,EACZ,MAAgB;AACnB,MAAI,CAAC,IAAK,QAAO;AACjB,SAAO,YAAY,GAAG;AACxB;AAPsB;AAmCtB,eAAsB,qBACpB,KACA,QACqC;AACrC,QAAM,UAAU,MAAM,IAAI,GACvB,QAAQ,kDAAkD,EAC1D,KAAK,OAAO,QAAQ,EACpB,MAAgB;AACnB,MAAI,CAAC,SAAS;AACZ,WAAO,EAAE,IAAI,OAAO,QAAQ,YAAY;AAAA,EAC1C;AAEA,QAAM,MAAM,OAAO;AACnB,QAAM,aAAa,OAAO,eAAe;AACzC,MAAI,kBAAkD;AACtD,MAAI,gBAAgB,OAAO;AAC3B,MAAI,cAA6B,OAAO,WAAW;AACnD,MAAI,sBAAsB,QAAQ,OAAO,OAAO;AAChD,MAAI,aAAa,QAAQ;AACzB,MAAI,iBAAiB,QAAQ;AAC7B,MAAI,SAAS,QAAQ;AACrB,MAAI,aAAa,QAAQ;AACzB,MAAI,aAAa,QAAQ;AAEzB,MAAI,OAAO,WAAW,eAAe;AACnC,qBAAiB,OAAO,mBAAmB;AAC3C,QAAI,QAAQ,WAAW,YAAY;AACjC,eAAS;AAAA,IACX;AACA,QAAI,OAAO,aAAa,QAAW;AACjC,mBAAa,OAAO;AACpB,UAAI,CAAC,OAAO,SAAS;AACnB,sBAAc;AAAA,MAChB;AACA,UAAI,OAAO,aAAa,MAAM;AAC5B,0BAAkB,EAAE,UAAU,OAAO,SAAS;AAAA,MAChD;AACA,4BAAsB,uBAAuB,OAAO,aAAa;AAAA,IACnE;AAAA,EACF,WAAW,OAAO,WAAW,UAAU;AACrC,iBAAa,OAAO;AACpB,sBAAkB,EAAE,UAAU,OAAO,SAAS;AAC9C,0BAAsB;AACtB,oBAAgB;AAAA,EAClB,WAAW,OAAO,WAAW,WAAW;AACtC,aAAS;AACT,iBAAa,OAAO,eAAe;AACnC,iBAAa,OAAO;AACpB,QAAI,CAAC,gBAAgB;AACnB,uBAAiB;AAAA,IACnB;AAAA,EACF;AAEA,QAAM,aAAa,IAAI,GACpB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAQF,EACC;AAAA,IACC,OAAO;AAAA,IACP;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AAEF,QAAM,aAAa,CAAC,UAAU;AAC9B,MAAI,gBAA2C;AAE/C,MAAI,qBAAqB;AACvB,UAAM,YAAY,OAAO,WAAW;AACpC,UAAM,eAAe,kBAAkB,KAAK,UAAU,eAAe,IAAI;AACzE,UAAM,aAAa,IAAI,GACpB;AAAA,MACC;AAAA;AAAA;AAAA,IAGF,EACC;AAAA,MACC;AAAA,MACA,OAAO;AAAA,MACP;AAAA,MACA,OAAO;AAAA,MACP;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF;AACF,eAAW,KAAK,UAAU;AAE1B,oBAAgB;AAAA,MACd,YAAY;AAAA,MACZ,UAAU,OAAO;AAAA,MACjB,QAAQ;AAAA,MACR,WAAW,OAAO;AAAA,MAClB,cAAc;AAAA,MACd,MAAM;AAAA,MACN,UAAU;AAAA,MACV,YAAY;AAAA,IACd;AAAA,EACF;AAEA,QAAM,gBAAgB,IAAI,IAAI,YAAY;AACxC,eAAW,aAAa,YAAY;AAClC,YAAM,UAAU,IAAI;AAAA,IACtB;AAAA,EACF,CAAC;AAED,QAAM,YAAY,MAAM,SAAS,KAAK,OAAO,QAAQ;AACrD,MAAI,CAAC,WAAW;AACd,WAAO,EAAE,IAAI,OAAO,QAAQ,YAAY;AAAA,EAC1C;AAEA,SAAO,EAAE,IAAI,MAAM,OAAO,WAAW,SAAS,cAAc;AAC9D;AA1HsB;AA4HtB,eAAsB,kBAAkB,KAAU,SAAgD;AAChG,QAAM,OAAO,MAAM,IAAI,GACpB;AAAA,IACC;AAAA,EACF,EACC,KAAK,OAAO,EACZ,IAAqB;AACxB,UAAQ,KAAK,WAAW,CAAC,GAAG,IAAI,kBAAkB;AACpD;AARsB;AAUtB,eAAsB,2BACpB,KACA,UAC4C;AAC5C,QAAM,MAAM,oBAAI,IAAkC;AAClD,MAAI,CAAC,SAAS,QAAQ;AACpB,WAAO;AAAA,EACT;AACA,QAAM,SAAS,CAAC,GAAG,IAAI,IAAI,QAAQ,CAAC;AACpC,QAAM,eAAe,OAAO,IAAI,CAAC,GAAG,QAAQ,IAAI,MAAM,CAAC,EAAE,EAAE,KAAK,GAAG;AACnE,QAAM,OAAO,MAAM,IAAI,GACpB;AAAA,IACC;AAAA,8BACwB,YAAY;AAAA;AAAA,EAEtC,EACC,KAAK,GAAG,MAAM,EACd,IAAqB;AAExB,aAAW,OAAO,KAAK,WAAW,CAAC,GAAG;AACpC,UAAM,SAAS,mBAAmB,GAAG;AACrC,UAAM,SAAS,IAAI,IAAI,OAAO,QAAQ;AACtC,QAAI,QAAQ;AACV,aAAO,KAAK,MAAM;AAAA,IACpB,OAAO;AACL,UAAI,IAAI,OAAO,UAAU,CAAC,MAAM,CAAC;AAAA,IACnC;AAAA,EACF;AAEA,aAAW,MAAM,QAAQ;AACvB,QAAI,CAAC,IAAI,IAAI,EAAE,GAAG;AAChB,UAAI,IAAI,IAAI,CAAC,CAAC;AAAA,IAChB;AAAA,EACF;AAEA,SAAO;AACT;AApCsB;AAsCtB,eAAsB,gBACpB,KACA,QAQ6B;AAC7B,QAAM,MAAM,OAAO;AACnB,QAAM,eAAe,OAAO,WAAW,KAAK,UAAU,OAAO,QAAQ,IAAI;AACzE,QAAM,YAAY,OAAO,WAAW;AACpC,QAAM,aAAa,IAAI,GACpB;AAAA,IACC;AAAA;AAAA;AAAA,EAGF,EACC;AAAA,IACC;AAAA,IACA,OAAO;AAAA,IACP,OAAO;AAAA,IACP,OAAO;AAAA,IACP,OAAO,eAAe;AAAA,IACtB,OAAO,QAAQ;AAAA,IACf;AAAA,IACA;AAAA,EACF;AAEF,QAAM,kBAAkB,IAAI,GACzB,QAAQ,uDAAuD,EAC/D,KAAK,OAAO,UAAU,GAAG;AAE5B,QAAM,gBAAgB,IAAI,IAAI,YAAY;AACxC,UAAM,WAAW,IAAI;AACrB,UAAM,gBAAgB,IAAI;AAAA,EAC5B,CAAC;AAED,SAAO;AAAA,IACL,YAAY;AAAA,IACZ,UAAU,OAAO;AAAA,IACjB,QAAQ,OAAO;AAAA,IACf,WAAW,OAAO;AAAA,IAClB,cAAc,OAAO,eAAe;AAAA,IACpC,MAAM,OAAO,QAAQ;AAAA,IACrB,UAAU,OAAO,YAAY;AAAA,IAC7B,YAAY;AAAA,EACd;AACF;AAlDsB;;;AC1btB,eAAsB,iBAAiB,KAAc,KAAU;AAC7D,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,IAAI;AACnC,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,kBAAkB,UAAU;AAAA,IAC/C,OAAO,IAAI,aAAa,IAAI,OAAO;AAAA,IACnC,OAAO,IAAI,aAAa,IAAI,OAAO;AAAA,EACrC,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,QAAQ,IAAI,QAAQ,GAAG,IAAI,aAAa;AAChD,QAAM,UAAU,KAAK,IAAI,IAAI,QAAQ,KAAK,KAAK;AAE/C,MAAI,MAAM,OAAO;AACf,WAAO,KAAK,EAAE,cAAc,OAAO,GAAG,OAAO,CAAC,GAAG,OAAO,EAAE,OAAO,GAAG,QAAQ,EAAE,EAAE,CAAC;AAAA,EACnF;AAEA,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AACrB,MAAI,MAAM,QAAQ;AAChB,YAAQ,SAAS,OAAO,MAAM,MAAM;AACpC,SAAK,KAAK,GAAG,MAAM,IAAI;AAAA,EACzB;AAEA,QAAM,cAAc;AAAA,IAClB,SAAS,OAAO,WAAW;AAAA,IAC3B;AAAA,EACF;AACA,QAAM,YAAY,MAAM,IAAI,GACzB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA,WAIK,WAAW;AAAA;AAAA,gBAEN,KAAK;AAAA,EACjB,EACC,KAAK,GAAG,MAAM,OAAO,EACrB,IAOE;AAEL,MAAI;AACJ,MAAI;AACF,YAAQ,MAAM,QAAQ;AAAA,OACnB,UAAU,WAAW,CAAC,GAAG,IAAI,OAAO,QAAQ;AAC3C,cAAM,SAAS,gBAAgB,IAAI,WAAW;AAC9C,cAAM,eAAe,gBAAgB,IAAI,aAAa;AACtD,eAAO;AAAA,UACL,WAAW,gBAAgB,IAAI,WAAW,MAAM,OAAO;AAAA,UACvD,QAAQ,MAAM,kBAAkB,IAAI,WAAW,KAAK,MAAM,OAAO;AAAA,UACjE,MAAM,IAAI,QAAQ;AAAA,UAClB,IAAI,IAAI,KAAK,IAAI,EAAE,EAAE,YAAY;AAAA,UACjC,aAAa,OAAO;AAAA,UACpB;AAAA,UACA,QAAQ,aAAa,SAAS;AAAA,UAC9B,eAAe;AAAA,UACf,aAAa,IAAI,eAAe;AAAA,QAClC;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF,SAAS,KAAK;AACZ,qBAAiB,KAAK,EAAE,OAAO,qBAAqB,CAAC,EAAE,MAAM,sBAAsB;AAAA,MACjF,OAAO;AAAA,IACT,CAAC;AACD,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,SAAS,MAAM,OAAO,CAAC,MAAW,EAAE,MAAM,EAAE;AAElD,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB;AAAA,IACA,OAAO;AAAA,MACL,OAAO,MAAM;AAAA,MACb;AAAA,IACF;AAAA,EACF,CAAC;AACH;AAvFsB;AAyFtB,SAAS,UAAU,KAA6B;AAC9C,SACE,IAAI,QAAQ,IAAI,kBAAkB,KAClC,IAAI,QAAQ,IAAI,iBAAiB,KACjC,IAAI,QAAQ,IAAI,WAAW,KAC3B;AAEJ;AAPS;AAST,SAAS,oBAAoB,SAA6B;AACxD,SAAO;AAAA,IACL,YAAY,QAAQ;AAAA,IACpB,UAAU,QAAQ;AAAA,IAClB,QAAQ,QAAQ;AAAA,IAChB,WAAW,QAAQ;AAAA,IACnB,cAAc,QAAQ;AAAA,IACtB,MAAM,QAAQ;AAAA,IACd,UAAU,QAAQ;AAAA,IAClB,YAAY,QAAQ;AAAA,EACtB;AACF;AAXS;AAaT,eAAe,kBACb,KACA,OACA,OACA;AACA,MAAI,MAAM,QAAS,QAAO;AAC1B,MAAI,MAAM,MAAO,QAAO;AACxB,QAAM,kBAAmB,MAAM,QAAqB,CAAC;AACrD,MAAI,CAAC,gBAAgB,OAAQ,QAAO;AACpC,MAAI,MAAM,cAAc,gBAAgB,SAAS,MAAM,UAAU,EAAG,QAAO;AAE3E,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,6DAA6D,EACrE,KAAK,MAAM,SAAS,EACpB,MAAqC;AACxC,QAAM,YAAY,KAAK,cAAc;AACrC,MAAI,CAAC,UAAW,QAAO;AACvB,SAAO,gBAAgB,SAAS,SAAS;AAC3C;AAlBe;AAoBf,eAAe,iBACb,KACA,KACA,WACA,QACA,OACA,QACA;AACA,QAAM,SAAS,MAAM,iBAAiB,KAAK;AAAA,IACzC,UAAU;AAAA,IACV,aAAa;AAAA,IACb,YAAY;AAAA,IACZ;AAAA,IACA,aAAa;AAAA,IACb,WAAW,MAAM;AAAA,IACjB,UAAU;AAAA,MACR,UAAU,MAAM;AAAA,MAChB,WAAW,MAAM;AAAA,MACjB,YAAY,MAAM;AAAA,MAClB,QAAQ,MAAM;AAAA,MACd,UAAU,MAAM;AAAA,MAChB,iBAAiB,MAAM;AAAA,MACvB,aAAa,MAAM;AAAA,MACnB,aAAa,MAAM;AAAA,MACnB,GAAG;AAAA,IACL;AAAA,IACA,YAAY,UAAU,GAAG;AAAA,EAC3B,CAAC;AAED,MAAI,CAAC,OAAO,IAAI;AACd,UAAM,IAAI,MAAM,yDAAyD;AAAA,EAC3E;AACF;AAhCe;AAkCf,eAAe,mBACb,QACA,KACA,OACA,MACA,UACA;AACA,QAAM,OAAO,KAAK,IAAI,OAAO,SAAS;AACtC,QAAM,YAAY,gBAAgB,OAAO,WAAW,MAAM,OAAO;AACjE,QAAM,SAAS,MAAM,kBAAkB,OAAO,WAAW,KAAK,MAAM,OAAO;AAC3E,SAAO;AAAA,IACL,UAAU,OAAO;AAAA,IACjB,WAAW;AAAA,IACX;AAAA,IACA,YAAY,OAAO,cAAc,MAAM,cAAc;AAAA,IACrD,MAAM,MAAM,QAAQ;AAAA,IACpB,YAAY,OAAO;AAAA,IACnB,UAAU,OAAO;AAAA,IACjB,QAAQ,OAAO;AAAA,IACf,SAAS,OAAO;AAAA,IAChB,aAAa,OAAO;AAAA,IACpB,UAAU,OAAO;AAAA,IACjB,iBAAiB,OAAO;AAAA,IACxB,aAAa,OAAO;AAAA,IACpB,aAAa,OAAO;AAAA,IACpB,aAAa,OAAO;AAAA,IACpB,YAAY,OAAO;AAAA,IACnB,YAAY,OAAO;AAAA,IACnB,WAAW,YAAY,CAAC,GAAG,IAAI,mBAAmB;AAAA,EACpD;AACF;AA9Be;AAgCf,eAAsB,uBAAuB,KAAc,KAAU;AACnE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,MAAM,GAAG;AACxC,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK,EAAE,cAAc,OAAO,GAAG,OAAO,CAAC,EAAE,CAAC;AAAA,EACnD;AAEA,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,mBAAmC,sBAAsB;AAAA,IAC5E,QAAQ,IAAI,aAAa,IAAI,QAAQ,KAAK;AAAA,IAC1C,UAAU,IAAI,aAAa,IAAI,UAAU,KAAK;AAAA,IAC9C,QAAQ,IAAI,aAAa,IAAI,QAAQ,KAAK;AAAA,IAC1C,SAAS,IAAI,aAAa,IAAI,SAAS,KAAK;AAAA,IAC5C,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,IACxC,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,IACxC,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,EAC1C,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,MAAM;AAAA,EACpD;AACA,QAAM,SAAS,aAAa;AAE5B,MAAI,OAAO,SAAS,OAAO,OAAO;AAChC,UAAM,UAAU,KAAK,MAAM,OAAO,KAAK;AACvC,UAAM,UAAU,KAAK,MAAM,OAAO,KAAK;AACvC,QAAI,CAAC,OAAO,MAAM,OAAO,KAAK,CAAC,OAAO,MAAM,OAAO,KAAK,UAAU,SAAS;AACzE,aAAO,KAAK,EAAE,OAAO,gBAAgB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACzD;AAAA,EACF;AAEA,MAAI;AACJ,MAAI,OAAO,QAAQ;AACjB,UAAM,WAAW,MAAM,gBAAgB,OAAO,QAAQ,KAAK,MAAM,OAAO;AACxE,QAAI,CAAC,UAAU;AACb,aAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1D;AACA,eAAW;AAAA,EACb;AAEA,MAAI;AACJ,MAAI,gBAAoC;AACxC,MAAI,MAAM,SAAS;AACjB,QAAI,OAAO,QAAS,iBAAgB,OAAO;AAAA,EAC7C,OAAO;AACL,UAAM,kBAAkB,MAAM;AAC9B,QAAI,CAAC,gBAAgB,QAAQ;AAC3B,aAAO,KAAK,EAAE,cAAc,OAAO,GAAG,OAAO,CAAC,EAAE,CAAC;AAAA,IACnD;AACA,QAAI,OAAO,SAAS;AAClB,UAAI,CAAC,gBAAgB,SAAS,OAAO,OAAO,GAAG;AAC7C,eAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MACrD;AACA,mBAAa,CAAC,OAAO,OAAO;AAAA,IAC9B,OAAO;AACL,mBAAa;AAAA,IACf;AAEA,QAAI,UAAU;AACZ,YAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,6DAA6D,EACrE,KAAK,QAAQ,EACb,MAAqC;AACxC,YAAM,gBAAgB,WAAW,cAAc;AAC/C,UAAI,CAAC,iBAAiB,CAAC,gBAAgB,SAAS,aAAa,GAAG;AAC9D,eAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MACrD;AAAA,IACF;AAAA,EACF;AAEA,QAAM,QAAQ,OAAO,SAAS;AAE9B,QAAM,SAAS,MAAM,WAAW,KAAK;AAAA,IACnC,QAAQ,OAAO,UAAU;AAAA,IACzB,UAAU,OAAO,YAAY;AAAA,IAC7B,WAAW;AAAA,IACX,YAAY;AAAA,IACZ,aAAa;AAAA,IACb,OAAO,OAAO,SAAS;AAAA,IACvB,OAAO,OAAO,SAAS;AAAA,IACvB;AAAA,EACF,CAAC;AAED,QAAM,OAAO,MAAM,gBAAgB,KAAK,OAAO,IAAI,CAAC,MAAM,EAAE,SAAS,CAAC;AACtE,QAAM,aAAa,MAAM;AAAA,IACvB;AAAA,IACA,OAAO,IAAI,CAAC,MAAM,EAAE,QAAQ;AAAA,EAC9B;AACA,QAAM,QAAQ,MAAM,QAAQ;AAAA,IAC1B,OAAO;AAAA,MAAI,CAAC,WACV,mBAAmB,QAAQ,KAAK,OAAO,MAAM,WAAW,IAAI,OAAO,QAAQ,KAAK,CAAC,CAAC;AAAA,IACpF;AAAA,EACF;AAEA,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB;AAAA,EACF,CAAC;AACH;AAnGsB;AAqGtB,eAAsB,wBAAwB,KAAc,KAAU;AACpE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,MAAM,GAAG;AACxC,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,cAAc,mBAAqC,mBAAmB,OAAO;AACnF,MAAI,CAAC,YAAY,SAAS;AACxB,WAAO,wBAAwB,YAAY,MAAM;AAAA,EACnD;AACA,QAAM,OAAO,YAAY;AAEzB,QAAM,WAAW,MAAM,gBAAgB,KAAK,WAAW,KAAK,MAAM,OAAO;AACzE,MAAI,CAAC,UAAU;AACb,WAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC1D;AAEA,MAAI,kBAAkB,KAAK,cAAc;AAEzC,MAAI,CAAC,MAAM,SAAS;AAClB,UAAM,kBAAkB,MAAM;AAC9B,UAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,6DAA6D,EACrE,KAAK,QAAQ,EACb,MAAqC;AAExC,QAAI,CAAC,WAAW,cAAc,CAAC,gBAAgB,SAAS,UAAU,UAAU,GAAG;AAC7E,aAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AAEA,QAAI,mBAAmB,oBAAoB,UAAU,YAAY;AAC/D,aAAO,KAAK,EAAE,OAAO,mBAAmB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC5D;AAEA,sBAAkB,UAAU;AAAA,EAC9B;AAEA,QAAM,SAAS,MAAM,YAAY,KAAK;AAAA,IACpC,UAAU,KAAK;AAAA,IACf,WAAW;AAAA,IACX,YAAY;AAAA,IACZ,YAAY,KAAK;AAAA,IACjB,UAAU,KAAK;AAAA,IACf,QAAQ,KAAK;AAAA,IACb,SAAS,KAAK,WAAW;AAAA,IACzB,aAAa,KAAK,eAAe;AAAA,IACjC,UAAU,KAAK,YAAY;AAAA,IAC3B,iBAAiB,KAAK,mBAAmB;AAAA,IACzC,aAAa,KAAK,eAAe;AAAA,IACjC,aAAa,KAAK,eAAe;AAAA,IACjC,aAAa,KAAK,eAAe;AAAA,EACnC,CAAC;AAED,MAAI,CAAC,OAAO,IAAI;AACd,QAAI,OAAO,WAAW,oBAAoB;AACxC,aAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1D;AACA,QAAI,OAAO,WAAW,YAAY;AAChC,aAAO,KAAK,EAAE,OAAO,uBAAuB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAChE;AACA,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,OAAO,MAAM,gBAAgB,KAAK,CAAC,OAAO,MAAM,SAAS,CAAC;AAChE,QAAM,CAAC,KAAK,IAAI,MAAM,QAAQ,IAAI;AAAA,IAChC,mBAAmB,OAAO,OAAO,KAAK,OAAO,MAAM,CAAC,CAAC;AAAA,EACvD,CAAC;AAED,SAAO,KAAK,EAAE,IAAI,MAAM,MAAM,GAAG,EAAE,QAAQ,IAAI,CAAC;AAClD;AA/EsB;AAiFtB,eAAsB,wBAAwB,KAAc,KAAU,SAAiB;AACrF,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,MAAM,GAAG;AACxC,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,QAAM,WAAW,MAAM,SAAS,KAAK,OAAO;AAC5C,MAAI,CAAC,UAAU;AACb,WAAO,KAAK,EAAE,OAAO,kBAAkB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3D;AAEA,MAAI,CAAE,MAAM,kBAAkB,KAAK,OAAO,QAAQ,GAAI;AACpD,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,cAAc,mBAA8C,4BAA4B,OAAO;AACrG,MAAI,CAAC,YAAY,SAAS;AACxB,WAAO,wBAAwB,YAAY,MAAM;AAAA,EACnD;AACA,QAAM,OAAO,YAAY;AAEzB,QAAM,eAAe,MAAM,qBAAqB,KAAK;AAAA,IACnD,GAAG;AAAA,IACH,UAAU;AAAA,IACV,UAAU,KAAK;AAAA,IACf,aAAa,KAAK;AAAA,IAClB,SAAS,KAAK,WAAW;AAAA,EAC3B,CAAC;AAED,MAAI,CAAC,aAAa,IAAI;AACpB,WAAO,KAAK,EAAE,OAAO,kBAAkB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3D;AAEA,QAAM,eAAe,aAAa;AAClC,QAAM,OAAO,MAAM,gBAAgB,KAAK,CAAC,aAAa,SAAS,CAAC;AAChE,QAAM,WAAW,MAAM,kBAAkB,KAAK,OAAO;AACrD,QAAM,YAAY,MAAM,mBAAmB,cAAc,KAAK,OAAO,MAAM,QAAQ;AAEnF,QAAM,cAAuC,CAAC;AAC9C,MAAI,KAAK,QAAS,aAAY,UAAU,KAAK;AAC7C,MAAI,cAAc,MAAM;AACtB,gBAAY,WAAY,KAA+B,YAAY;AAAA,EACrE;AACA,MAAI,aAAa,SAAS;AACxB,gBAAY,aAAa,aAAa,QAAQ;AAAA,EAChD;AAEA,QAAM,iBAAiB,KAAK,KAAK,KAAK,OAAO,SAAS,KAAK,MAAM,IAAI,cAAc,WAAW;AAE9F,SAAO,KAAK;AAAA,IACV,IAAI;AAAA,IACJ,OAAO;AAAA,IACP,SAAS,aAAa,UAAU,oBAAoB,aAAa,OAAO,IAAI;AAAA,EAC9E,CAAC;AACH;AAhEsB;AAkEtB,eAAsB,yBAAyB,KAAc,KAAU,SAAiB;AACtF,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,MAAM,GAAG;AACxC,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,QAAM,WAAW,MAAM,SAAS,KAAK,OAAO;AAC5C,MAAI,CAAC,UAAU;AACb,WAAO,KAAK,EAAE,OAAO,kBAAkB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3D;AAEA,MAAI,CAAE,MAAM,kBAAkB,KAAK,OAAO,QAAQ,GAAI;AACpD,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,cAAc,mBAA4C,0BAA0B,OAAO;AACjG,MAAI,CAAC,YAAY,SAAS;AACxB,WAAO,wBAAwB,YAAY,MAAM;AAAA,EACnD;AACA,QAAM,OAAO,YAAY;AAEzB,QAAM,gBAAgB,MAAM,gBAAgB,KAAK;AAAA,IAC/C,UAAU;AAAA,IACV,QAAQ;AAAA,IACR,MAAM,KAAK;AAAA,IACX,UAAU,KAAK;AAAA,IACf,aAAa,KAAK;AAAA,IAClB,UAAU;AAAA,EACZ,CAAC;AAED,QAAM,YAAY,MAAM,SAAS,KAAK,OAAO;AAC7C,MAAI,CAAC,WAAW;AACd,WAAO,KAAK,EAAE,OAAO,kBAAkB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC3D;AAEA,QAAM,OAAO,MAAM,gBAAgB,KAAK,CAAC,UAAU,SAAS,CAAC;AAC7D,QAAM,WAAW,MAAM,kBAAkB,KAAK,OAAO;AACrD,QAAM,YAAY,MAAM,mBAAmB,WAAW,KAAK,OAAO,MAAM,QAAQ;AAEhF,QAAM,iBAAiB,KAAK,KAAK,KAAK,OAAO,mBAAmB,WAAW;AAAA,IACzE,YAAY,cAAc;AAAA,EAC5B,CAAC;AAED,SAAO,KAAK;AAAA,IACV,IAAI;AAAA,IACJ,OAAO;AAAA,IACP,SAAS,oBAAoB,aAAa;AAAA,EAC5C,CAAC;AACH;AA1DsB;;;AChef,IAAM,qBAAqB,iBAC/B,OAAO;AAAA,EACN,cAAc,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAAA,EAChF,MAAM,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,IAAI,cAAc,GAAG,CAAC;AACzE,CAAC,EACA,OAAO;;;ACEV,eAAsB,cAAc,KAAc,KAAU;AAC1D,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,IAAI;AACnC,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,mBAAmB,UAAU;AAAA,IAChD,cAAc,IAAI,aAAa,IAAI,cAAc;AAAA,IACjD,MAAM,IAAI,aAAa,IAAI,MAAM;AAAA,EACnC,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,eAAe,IAAI,OAAO,GAAG,IAAI,aAAa;AACtD,QAAM,mBAAmB,IAAI,KAAK,KAAK,IAAI,IAAI,eAAe,KAAK,KAAK,GAAI,EAAE,YAAY;AAE1F,QAAM,iBAAiB,KAAK,IAAI,IAAI,OAAO,KAAK,KAAK,KAAK;AAE1D,MAAI,MAAM,OAAO;AACf,WAAO,KAAK,EAAE,cAAc,OAAO,GAAG,SAAS,CAAC,GAAG,SAAS,CAAC,EAAE,CAAC;AAAA,EAClE;AAEA,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AACrB,MAAI,MAAM,QAAQ;AAChB,YAAQ,SAAS,OAAO,MAAM,MAAM;AACpC,SAAK,KAAK,GAAG,MAAM,IAAI;AAAA,EACzB;AAEA,QAAM,eAAe,SAAS,OAAO,gDAAgD;AACrF,QAAM,cAAc,MAAM,IAAI,GAC3B;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,YAAY;AAAA;AAAA;AAAA,EAGnB,EACC,KAAK,GAAG,MAAM,gBAAgB,EAC9B,IASE;AAEL,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,QAAQ;AAAA,OACrB,YAAY,WAAW,CAAC,GAAG,IAAI,OAAO,SAAS;AAAA,QAC9C,WAAW,gBAAgB,IAAI,WAAW,MAAM,OAAO;AAAA,QACvD,QAAQ,MAAM,kBAAkB,IAAI,WAAW,KAAK,MAAM,OAAO;AAAA,QACjE,MAAM,IAAI,QAAQ;AAAA,QAClB,cAAc,IAAI,gBAAgB;AAAA,QAClC,QAAQ,CAAC,CAAC,IAAI;AAAA,QACd,KAAK,oBAAoB,IAAI,KAAK,MAAM,SAAS,GAAG,CAAC;AAAA,QACrD,QAAQ,oBAAoB,IAAI,QAAQ,MAAM,SAAS,GAAG,CAAC;AAAA,QAC3D,QAAQ,gBAAgB,IAAI,WAAW,EAAE;AAAA,QACzC,YAAY,IAAI,cAAc;AAAA,MAChC,EAAE;AAAA,IACJ;AAAA,EACF,SAAS,KAAK;AACZ,qBAAiB,KAAK,EAAE,OAAO,uBAAuB,CAAC,EAAE,MAAM,kCAAkC;AAAA,MAC/F,OAAO;AAAA,IACT,CAAC;AACD,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,eAAe,SAAS,SAAS,OAAO,WAAW,GAAG,kBAAkB;AAC9E,QAAM,cAAc,MAAM,IAAI,GAC3B;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,YAAY;AAAA;AAAA;AAAA,gBAGP,IAAI;AAAA,EAChB,EACC,KAAK,GAAG,MAAM,cAAc,EAC5B,IAAsC;AAEzC,QAAM,WAAW,YAAY,WAAW,CAAC,GAAG,IAAI,CAAC,SAAS;AAAA,IACxD,KAAK,IAAI;AAAA,IACT,SAAS,IAAI;AAAA,EACf,EAAE;AAEF,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB;AAAA,IACA;AAAA,EACF,CAAC;AACH;AAjGsB;;;ACPf,IAAM,2BAA2B,iBACrC,OAAO;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,IAAI,cAAc,GAAG,CAAC;AAAA,EACxE,WAAW,aAAa,EAAE,KAAK,GAAG,cAAc,EAAE,CAAC;AACrD,CAAC,EACA,OAAO;;;ACEV,eAAsB,oBAAoB,KAAc,KAAU;AAChE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,IAAI;AACnC,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,yBAAyB,UAAU;AAAA,IACtD,OAAO,IAAI,aAAa,IAAI,OAAO;AAAA,IACnC,WAAW,IAAI,aAAa,IAAI,WAAW;AAAA,EAC7C,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,QAAQ,IAAI,YAAY,EAAE,IAAI,aAAa;AACnD,QAAM,UAAU,KAAK,IAAI,IAAI,QAAQ,KAAK,KAAK;AAE/C,MAAI,MAAM,OAAO;AACf,WAAO,KAAK;AAAA,MACV,cAAc,OAAO;AAAA,MACrB,OAAO;AAAA,MACP,iBAAiB;AAAA,MACjB,MAAM;AAAA,QACJ,eAAe;AAAA,QACf,gBAAgB;AAAA,QAChB,eAAe;AAAA,QACf,YAAY;AAAA,QACZ,SAAS;AAAA,QACT,kBAAkB;AAAA,QAClB,aAAa;AAAA,QACb,uBAAuB;AAAA,MACzB;AAAA,MACA,QAAQ,CAAC;AAAA,MACT,aAAa,CAAC;AAAA,MACd,OAAO,CAAC;AAAA,IACV,CAAC;AAAA,EACH;AAEA,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AACrB,MAAI,MAAM,QAAQ;AAChB,YAAQ,SAAS,OAAO,MAAM,MAAM;AACpC,SAAK,KAAK,GAAG,MAAM,IAAI;AAAA,EACzB;AAEA,QAAM,WAAW,MAAM,IAAI,GACxB,QAAQ,uCAAuC,KAAK,EAAE,EACtD,KAAK,GAAG,IAAI,EACZ,MAAqB;AACxB,QAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,uCAAuC,SAAS,OAAO,cAAc,CAAC,EAAE,EAChF,KAAK,GAAG,IAAI,EACZ,MAAqB;AAExB,QAAM,gBAAgB,UAAU,KAAK;AACrC,QAAM,iBAAiB,WAAW,KAAK;AACvC,QAAM,gBAAgB,KAAK,IAAI,GAAG,gBAAgB,cAAc;AAChE,QAAM,aAAa,gBAAgB,KAAK,MAAO,iBAAiB,gBAAiB,GAAG,IAAI;AAExF,QAAM,aAAa,SAAS,OAAO,WAAW;AAC9C,QAAM,YAAY,CAAC,GAAG,MAAM,OAAO;AAEnC,QAAM,SAAS,MAAM,IAAI,GACtB;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,UAAU;AAAA,EACjB,EACC,KAAK,GAAG,SAAS,EACjB,MAA4B;AAE/B,QAAM,WAAW,SAAS,YAAY,uCAAuC;AAC7E,QAAM,UAAU,CAAC,GAAG,WAAW,SAAS;AACxC,QAAM,SAAS,MAAM,IAAI,GACtB;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,QAAQ;AAAA,EACf,EACC,KAAK,GAAG,OAAO,EACf,MAAqB;AAExB,QAAM,QAAQ,MAAM,IAAI,GACrB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAMG,KAAK;AAAA,EACV,EACC,KAAK,GAAG,IAAI,EACZ,MAA4B;AAE/B,QAAM,aAAa,MAAM,IAAI,GAC1B;AAAA,IACC;AAAA;AAAA;AAAA;AAAA,WAIK,SAAS,YAAY,6EAA6E,CAAC;AAAA;AAAA;AAAA,EAG1G,EACC,KAAK,GAAG,SAAS,EACjB,IAME;AAEL,MAAI;AACJ,MAAI;AACF,aAAS,MAAM,QAAQ;AAAA,OACpB,WAAW,WAAW,CAAC,GAAG,IAAI,OAAO,QAAQ;AAC5C,cAAM,SAAS,gBAAgB,IAAI,WAAW;AAC9C,eAAO;AAAA,UACL,WAAW,gBAAgB,IAAI,WAAW,MAAM,OAAO;AAAA,UACvD,QAAQ,MAAM,kBAAkB,IAAI,WAAW,KAAK,MAAM,OAAO;AAAA,UACjE,MAAM,IAAI,QAAQ;AAAA,UAClB,IAAI,IAAI,KAAK,IAAI,EAAE,EAAE,YAAY;AAAA,UACjC,YAAY,IAAI,cAAc;AAAA,UAC9B;AAAA,UACA,aAAa,OAAO;AAAA,QACtB;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF,SAAS,KAAK;AACZ,qBAAiB,KAAK,EAAE,OAAO,sBAAsB,CAAC,EAAE,MAAM,gCAAgC;AAAA,MAC5F,OAAO;AAAA,IACT,CAAC;AACD,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,kBAAkB,OAAO,OAAO,CAAC,MAAW,EAAE,cAAc,CAAC,EAAE;AAErE,QAAM,UAAU,MAAM,IAAI,GACvB;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,KAAK;AAAA;AAAA;AAAA,EAGZ,EACC,KAAK,GAAG,IAAI,EACZ,IAUE;AAEL,MAAI;AACJ,MAAI;AACF,iBAAa,MAAM,QAAQ;AAAA,OACxB,QAAQ,WAAW,CAAC,GAAG,IAAI,OAAO,QAAQ;AACzC,cAAM,SAAS,gBAAgB,IAAI,WAAW;AAC9C,eAAO;AAAA,UACL,WAAW,gBAAgB,IAAI,WAAW,MAAM,OAAO;AAAA,UACvD,QAAQ,MAAM,kBAAkB,IAAI,WAAW,KAAK,MAAM,OAAO;AAAA,UACjE,MAAM,IAAI,QAAQ;AAAA,UAClB,QAAQ,CAAC,CAAC,IAAI;AAAA,UACd,cAAc,IAAI,gBAAgB;AAAA,UAClC,YAAY,IAAI,cAAc;AAAA,UAC9B,KAAK,oBAAoB,IAAI,KAAK,MAAM,SAAS,GAAG,CAAC;AAAA,UACrD,QAAQ,oBAAoB,IAAI,QAAQ,MAAM,SAAS,GAAG,CAAC;AAAA,UAC3D,WAAW,oBAAoB,IAAI,WAAW,MAAM,SAAS,GAAG,CAAC;AAAA,UACjE,aAAa,OAAO;AAAA,QACtB;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF,SAAS,KAAK;AACZ,qBAAiB,KAAK,EAAE,OAAO,sBAAsB,CAAC,EAAE,MAAM,qCAAqC;AAAA,MACjG,OAAO;AAAA,IACT,CAAC;AACD,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,gBAAgB,MAAM,IAAI,GAC7B;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,UAAU;AAAA;AAAA;AAAA,EAGjB,EACC,KAAK,GAAG,SAAS,EACjB,IAKE;AAEL,QAAM,cAAc;AACpB,QAAM,QAAQ,KAAK,IAAI;AACvB,QAAM,SAAS,KAAK,IAAI,GAAG,QAAQ,OAAO;AAC1C,QAAM,WAAW,SAAS;AAC1B,QAAM,UAAU,MAAM,KAAK,EAAE,QAAQ,YAAY,GAAG,CAAC,GAAG,OAAO;AAAA,IAC7D,OAAO,UAAU,IAAI;AAAA,IACrB,KAAK,WAAW,IAAI,KAAK;AAAA,IACzB,OAAO;AAAA,IACP,KAAK;AAAA,IACL,SAAS;AAAA,IACT,OAAO;AAAA,EACT,EAAE;AAEF,aAAW,OAAO,cAAc,WAAW,CAAC,GAAG;AAC7C,UAAM,MAAM,KAAK,IAAI,cAAc,GAAG,KAAK,IAAI,GAAG,KAAK,OAAO,IAAI,KAAK,WAAW,QAAQ,CAAC,CAAC;AAC5F,UAAM,SAAS,QAAQ,GAAG;AAC1B,WAAO,SAAS;AAChB,QAAI,OAAO,IAAI,QAAQ,SAAU,QAAO,OAAO,IAAI;AACnD,QAAI,OAAO,IAAI,cAAc,SAAU,QAAO,WAAW,IAAI;AAC7D,QAAI,OAAO,IAAI,WAAW,SAAU,QAAO,SAAS,IAAI;AAAA,EAC1D;AAEA,QAAM,QAAQ,QAAQ,IAAI,CAAC,WAAW;AACpC,UAAM,SAAS,OAAO,QAAQ,OAAO,MAAM,OAAO,QAAQ;AAC1D,UAAM,aAAa,OAAO,QAAQ,OAAO,UAAU,OAAO,QAAQ;AAClE,UAAM,WAAW,OAAO,QAAQ,OAAO,QAAQ,OAAO,QAAQ;AAC9D,WAAO;AAAA,MACL,OAAO,IAAI,KAAK,KAAK,IAAI,OAAO,OAAO,GAAG,CAAC,EAAE,YAAY;AAAA,MACzD,KAAK,oBAAoB,QAAQ,MAAM,SAAS,GAAG,CAAC;AAAA,MACpD,WAAW,oBAAoB,YAAY,MAAM,SAAS,GAAG,CAAC;AAAA,MAC9D,QAAQ,oBAAoB,UAAU,MAAM,SAAS,GAAG,CAAC;AAAA,IAC3D;AAAA,EACF,CAAC;AAED,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB,OAAO,MAAM,UAAU,UAAU;AAAA,IACjC,iBAAiB;AAAA,IACjB,MAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,SAAS,oBAAoB,QAAQ,KAAK,MAAM,MAAM,SAAS,GAAG,CAAC;AAAA,MACnE,kBAAkB,QAAQ,KAAK;AAAA,MAC/B,aAAa;AAAA,MACb,uBAAuB,OAAO,KAAK;AAAA,IACrC;AAAA,IACA;AAAA,IACA,aAAa;AAAA,IACb;AAAA,EACF,CAAC;AACH;AAjQsB;;;ACPf,IAAM,0BAA0B,iBACpC,OAAO;AAAA,EACN,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAAA,EACzE,WAAW,aAAa,EAAE,KAAK,GAAG,cAAc,EAAE,CAAC;AACrD,CAAC,EACA,OAAO;;;ACCV,eAAsB,mBAAmB,KAAc,KAAU;AAC/D,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,IAAI;AACnC,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,wBAAwB,UAAU;AAAA,IACrD,OAAO,IAAI,aAAa,IAAI,OAAO;AAAA,IACnC,WAAW,IAAI,aAAa,IAAI,WAAW;AAAA,EAC7C,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,KAAK;AAAA,EACnD;AACA,QAAM,EAAE,QAAQ,IAAI,YAAY,EAAE,IAAI,aAAa;AACnD,QAAM,UAAU,KAAK,IAAI,IAAI,QAAQ,KAAK,KAAK;AAE/C,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AAErB,MAAI,MAAM,OAAO;AACf,WAAO,KAAK;AAAA,MACV,eAAe;AAAA,MACf,gBAAgB;AAAA,MAChB,YAAY;AAAA,MACZ,aAAa;AAAA,MACb,sBAAsB;AAAA,MACtB,uBAAuB;AAAA,MACvB,iBAAiB;AAAA,MACjB,cAAc,OAAO;AAAA,IACvB,CAAC;AAAA,EACH;AAEA,MAAI,MAAM,QAAQ;AAChB,YAAQ,SAAS,OAAO,MAAM,MAAM;AACpC,SAAK,KAAK,GAAG,MAAM,IAAI;AAAA,EACzB;AAEA,QAAM,WAAW,MAAM,IAAI,GACxB,QAAQ,uCAAuC,KAAK,EAAE,EACtD,KAAK,GAAG,IAAI,EACZ,MAAqB;AAExB,QAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,uCAAuC,SAAS,OAAO,cAAc,CAAC,EAAE,EAChF,KAAK,GAAG,IAAI,EACZ,MAAqB;AAExB,QAAM,gBAAgB,UAAU,KAAK;AACrC,QAAM,iBAAiB,WAAW,KAAK;AACvC,QAAM,aAAa,gBAAgB,KAAK,MAAO,iBAAiB,gBAAiB,GAAG,IAAI;AAExF,QAAM,aAAa,SAAS,OAAO,WAAW;AAC9C,QAAM,YAAY,CAAC,GAAG,MAAM,OAAO;AAEnC,QAAM,SAAS,MAAM,IAAI,GACtB;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,UAAU;AAAA,EACjB,EACC,KAAK,GAAG,SAAS,EACjB,MAA4B;AAE/B,QAAM,WAAW,SAAS,YAAY,uCAAuC;AAC7E,QAAM,UAAU,CAAC,GAAG,WAAW,SAAS;AACxC,QAAM,SAAS,MAAM,IAAI,GACtB;AAAA,IACC;AAAA;AAAA;AAAA,WAGK,QAAQ;AAAA,EACf,EACC,KAAK,GAAG,OAAO,EACf,MAAqB;AAExB,QAAM,QAAQ,MAAM,IAAI,GACrB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,SAMG,KAAK;AAAA,EACV,EACC,KAAK,GAAG,IAAI,EACZ,MAA4B;AAE/B,SAAO,KAAK;AAAA,IACV;AAAA,IACA;AAAA,IACA;AAAA,IACA,aAAa,oBAAoB,QAAQ,KAAK,MAAM,MAAM,SAAS,GAAG,CAAC;AAAA,IACvE,sBAAsB,QAAQ,KAAK;AAAA,IACnC,uBAAuB,OAAO,KAAK;AAAA,IACnC,iBAAiB;AAAA,IACjB,cAAc,OAAO;AAAA,EACvB,CAAC;AACH;AAnGsB;;;ACNtB,IAAM,iBAAiB,oBAAI,IAA0B;AACrD,IAAM,sBAAsB,IAAI,KAAK;AA6BrC,IAAI,cAAc,KAAK,IAAI;AAE3B,eAAsB,iBACpB,KACA,KACA,OACmC;AACnC,QAAM,SAAS,cAAc,GAAG;AAChC,MAAI,CAAC,OAAQ,QAAO;AACpB,QAAM,KAAK,gBAAgB,GAAG;AAC9B,MAAI,CAAC,GAAI,QAAO;AAEhB,QAAM,MAAM,GAAG,KAAK,IAAI,EAAE;AAC1B,QAAM,MAAM,KAAK,IAAI;AAErB,MAAI,IAAI,mBAAmB;AACzB,QAAI;AACF,YAAM,WAAW,MAAM,iBAAiB,IAAI,mBAAmB,KAAK,IAAI,QAAQ,GAAG;AACnF,UAAI,UAAU;AACZ,eAAO;AAAA,MACT;AAAA,IACF,SAAS,OAAO;AACd,mBAAa,EAAE,OAAO,uBAAuB,CAAC,EAAE,KAAK,8BAA8B;AAAA,QACjF;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AAEA,iBAAe,GAAG;AAClB,SAAO,qBAAqB,KAAK,IAAI,QAAQ,GAAG;AAClD;AA5BsB;AA8BtB,SAAS,cAAc,KAAoC;AACzD,QAAM,WACJ,OAAO,IAAI,4BAA4B,WACnC,IAAI,wBAAwB,KAAK,IACjC;AACN,MAAI,CAAC,SAAU,QAAO;AACtB,QAAM,WAAW,OAAO,SAAS,UAAU,EAAE;AAC7C,MAAI,CAAC,OAAO,SAAS,QAAQ,KAAK,YAAY,EAAG,QAAO;AAExD,QAAM,kBACJ,OAAO,IAAI,4BAA4B,WACnC,IAAI,wBAAwB,KAAK,IACjC;AACN,QAAM,eAAe,OAAO,SAAS,mBAAmB,MAAM,EAAE;AAChE,QAAM,kBACJ,OAAO,SAAS,YAAY,KAAK,eAAe,IAAI,eAAe,MAAO;AAE5E,SAAO;AAAA,IACL;AAAA,IACA,kBAAkB;AAAA,IAClB;AAAA,EACF;AACF;AAtBS;AAwBT,SAAS,gBAAgB,KAA6B;AACpD,QAAM,SAAS,IAAI,QAAQ,IAAI,kBAAkB;AACjD,MAAI,QAAQ,KAAK,GAAG;AAClB,WAAO,OAAO,KAAK;AAAA,EACrB;AACA,QAAM,YAAY,IAAI,QAAQ,IAAI,iBAAiB;AACnD,MAAI,WAAW,KAAK,GAAG;AACrB,UAAM,QAAQ,UAAU,MAAM,GAAG,EAAE,CAAC,GAAG,KAAK;AAC5C,WAAO,SAAS;AAAA,EAClB;AACA,SAAO;AACT;AAXS;AAaT,SAAS,OAAO,QAAqC,QAA2B,KAAa;AAC3F,MAAI,OAAO,UAAU,OAAO,UAAU;AACpC,WAAO,SAAS,OAAO;AACvB,WAAO,aAAa;AACpB;AAAA,EACF;AAEA,QAAM,UAAU,MAAM,OAAO;AAC7B,MAAI,WAAW,EAAG;AAElB,QAAM,cAAe,UAAU,OAAO,mBAAoB,OAAO;AACjE,SAAO,SAAS,KAAK,IAAI,OAAO,UAAU,OAAO,SAAS,WAAW;AACrE,SAAO,aAAa;AACtB;AAbS;AAoBT,eAAe,iBACb,IACA,KACA,IACA,QACA,KACmC;AACnC,MAAI,CAAC,GAAI,QAAO;AAChB,QAAM,aAAa,kBAAkB,MAAM;AAC3C,QAAM,SAAU,MAAM,GAAG,IAAI,KAAK,EAAE,MAAM,OAAO,CAAC;AAClD,QAAM,SACJ,UAAU;AAAA,IACR,QAAQ,OAAO;AAAA,IACf,YAAY;AAAA,IACZ,cAAc;AAAA,EAChB;AAEF,MAAI,OAAO,eAAe,KAAK;AAC7B,UAAM,GAAG;AAAA,MACP;AAAA,MACA,KAAK,UAAU,MAAM;AAAA,MACrB,EAAE,eAAe,WAAW;AAAA,IAC9B;AACA,WAAO;AAAA,MACL,SAAS;AAAA,MACT,mBAAmB,KAAK,MAAM,OAAO,eAAe,OAAO,GAAI;AAAA,MAC/D,WAAW;AAAA,MACX,OAAO,OAAO;AAAA,MACd;AAAA,IACF;AAAA,EACF;AAEA,SAAO,QAAQ,QAAQ,GAAG;AAE1B,MAAI,OAAO,UAAU,GAAG;AACtB,WAAO,UAAU;AACjB,UAAM,GAAG;AAAA,MACP;AAAA,MACA,KAAK,UAAU,MAAM;AAAA,MACrB,EAAE,eAAe,WAAW;AAAA,IAC9B;AACA,WAAO;AAAA,MACL,SAAS;AAAA,MACT,WAAW,KAAK,MAAM,OAAO,MAAM;AAAA,MACnC,OAAO,OAAO;AAAA,MACd;AAAA,IACF;AAAA,EACF;AAEA,SAAO,SAAS;AAChB,SAAO,eAAe,MAAM,OAAO;AACnC,QAAM,GAAG;AAAA,IACP;AAAA,IACA,KAAK,UAAU,MAAM;AAAA,IACrB,EAAE,eAAe,WAAW;AAAA,EAC9B;AAEA,SAAO;AAAA,IACL,SAAS;AAAA,IACT,mBAAmB,KAAK,KAAK,OAAO,kBAAkB,GAAI;AAAA,IAC1D,WAAW;AAAA,IACX,OAAO,OAAO;AAAA,IACd;AAAA,EACF;AACF;AAhEe;AAkEf,SAAS,qBACP,KACA,IACA,QACA,KACmB;AACnB,MAAI,SAAS,eAAe,IAAI,GAAG;AACnC,MAAI,CAAC,QAAQ;AACX,aAAS;AAAA,MACP,UAAU,OAAO;AAAA,MACjB,QAAQ,OAAO;AAAA,MACf,YAAY;AAAA,MACZ,cAAc;AAAA,IAChB;AACA,mBAAe,IAAI,KAAK,MAAM;AAAA,EAChC;AAEA,MAAI,OAAO,eAAe,KAAK;AAC7B,WAAO;AAAA,MACL,SAAS;AAAA,MACT,mBAAmB,KAAK,MAAM,OAAO,eAAe,OAAO,GAAI;AAAA,MAC/D,WAAW;AAAA,MACX,OAAO,OAAO;AAAA,MACd;AAAA,IACF;AAAA,EACF;AAEA,SAAO,QAAQ,QAAQ,GAAG;AAE1B,MAAI,OAAO,UAAU,GAAG;AACtB,WAAO,UAAU;AAEjB,WAAO;AAAA,MACL,SAAS;AAAA,MACT,WAAW,KAAK,MAAM,OAAO,MAAM;AAAA,MACnC,OAAO,OAAO;AAAA,MACd;AAAA,IACF;AAAA,EACF;AAEA,SAAO,eAAe,MAAM,OAAO;AACnC,SAAO,SAAS;AAEhB,SAAO;AAAA,IACL,SAAS;AAAA,IACT,mBAAmB,KAAK,KAAK,OAAO,kBAAkB,GAAI;AAAA,IAC1D,WAAW;AAAA,IACX,OAAO,OAAO;AAAA,IACd;AAAA,EACF;AACF;AAlDS;AAoDT,SAAS,kBAAkB,QAAmC;AAC5D,QAAM,UAAU,OAAO,kBAAkB,OAAO,mBAAmB;AACnE,SAAO,KAAK,IAAI,IAAI,KAAK,KAAK,UAAU,GAAI,CAAC;AAC/C;AAHS;AAKT,SAAS,eAAe,KAAa;AACnC,MAAI,MAAM,cAAc,oBAAqB;AAC7C,gBAAc;AACd,aAAW,CAAC,KAAK,MAAM,KAAK,gBAAgB;AAC1C,QAAI,OAAO,UAAU,OAAO,YAAY,OAAO,gBAAgB,KAAK;AAClE,qBAAe,OAAO,GAAG;AAAA,IAC3B;AAAA,EACF;AACF;AARS;;;ACnPT,IAAM,iBAAiB,iBACpB,MAAM,CAAC,iBAAE,OAAO,GAAG,iBAAE,KAAK,CAAC,CAAC,EAC5B,SAAS,EACT;AAAA,EAAU,CAAC,UACV,UAAU,SAAY,OAAO;AAC/B;AAEF,IAAM,iBAAiB,iBACpB,MAAM,CAAC,iBAAE,OAAO,EAAE,IAAI,CAAC,GAAG,iBAAE,KAAK,CAAC,CAAC,EACnC,SAAS,EACT;AAAA,EAAU,CAAC,UACV,UAAU,SAAY,OAAO;AAC/B;AAEK,IAAM,yBAAyB,iBACnC,OAAO;AAAA,EACN,SAAS;AAAA,EACT,SAAS;AAAA,EACT,OAAO;AAAA,EACP,UAAU;AAAA,EACV,SAAS;AAAA,EACT,cAAc;AAAA,EACd,UAAU;AAAA,EACV,SAAS;AAAA,EACT,MAAM;AAAA,EACN,SAAS;AACX,CAAC,EACA,MAAM;AAEF,IAAM,yBAAyB,iBACnC,OAAO;AAAA,EACN,WAAW,iBAAE,OAAO,EAAE,IAAI,GAAG,6BAA6B;AAAA,EAC1D,IAAI,iBAAE,OAAO,EAAE,IAAI,GAAG,sBAAsB;AAAA,EAC5C,SAAS;AAAA,EACT,QAAQ,iBAAE,MAAM,iBAAE,OAAO,CAAC,EAAE,QAAQ,CAAC,CAAC;AAAA,EACtC,MAAM;AACR,CAAC,EACA,OAAO;AAIH,IAAM,yBAAyB,iBACnC,OAAO;AAAA,EACN,WAAW,iBAAE,OAAO,EAAE,IAAI,GAAG,6BAA6B;AAAA,EAC1D,IAAI,iBAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC/B,MAAM;AACR,CAAC,EACA,OAAO;;;AC/CH,IAAM,sCAAsC;AAE5C,SAAS,oBAAoB,KAAuD;AACzF,QAAM,MAAM,IAAI;AAChB,QAAM,SAAS,MAAM,OAAO,GAAG,IAAI;AACnC,QAAM,UACJ,OAAO,SAAS,MAAM,KAAK,SAAS,IAAI,SAAS;AACnD,QAAM,WAAW,KAAK,MAAM,UAAU,GAAM;AAC5C,SAAO,KAAK,IAAI,UAAU,GAAK;AACjC;AAPgB;;;ACJhB,IAAM,kBAAkB,oBAAI,QAA0B;AAE/C,SAAS,yBAAyB,KAAoB;AAC3D,kBAAgB,IAAI,KAAK,KAAK;AAChC;AAFgB;AAIT,SAAS,2BAA2B,KAAoB;AAC7D,kBAAgB,IAAI,KAAK,IAAI;AAC/B;AAFgB;AAIT,SAAS,uBAAuB,KAAuB;AAC5D,SAAO,gBAAgB,IAAI,GAAG,MAAM;AACtC;AAFgB;;;ACWhB,IAAM,oBAAoB;AAC1B,IAAM,mBAAmB;AACzB,IAAM,mBAAmB;AACzB,IAAM,eAAe;AACrB,IAAM,kBAAkB;AAExB,IAAM,cAAc,IAAI,YAAY;AAMpC,SAAS,qBAAqB,KAAU;AACtC,QAAM,MAAM,IAAI;AAChB,QAAM,SAAS,MAAM,OAAO,GAAG,IAAI;AACnC,QAAM,UAAU,OAAO,SAAS,MAAM,KAAK,SAAS,IAAI,SAAS;AACjE,SAAO,UAAU;AACnB;AALS;AAOT,SAAS,wBAAwB,KAA4B;AAC3D,QAAM,QAAQ,IAAI,KAAK;AACvB,MAAI,CAAC,MAAO,QAAO;AACnB,MAAI,YAAY,KAAK,KAAK,GAAG;AAC3B,UAAM,UAAU,OAAO,KAAK;AAC5B,QAAI,CAAC,OAAO,SAAS,OAAO,EAAG,QAAO;AACtC,QAAI,MAAM,UAAU,IAAI;AACtB,aAAO,UAAU;AAAA,IACnB;AACA,WAAO;AAAA,EACT;AACA,QAAM,SAAS,KAAK,MAAM,KAAK;AAC/B,SAAO,OAAO,MAAM,MAAM,IAAI,OAAO;AACvC;AAbS;AAeT,SAAS,iBAAiB,KAAyB,UAA0B;AAC3E,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,SAAS,OAAO,SAAS,KAAK,EAAE;AACtC,MAAI,CAAC,OAAO,SAAS,MAAM,KAAK,UAAU,EAAG,QAAO;AACpD,SAAO;AACT;AALS;AAOT,SAAS,oBAAoB,KAAyB,UAA0B;AAC9E,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,SAAS,OAAO,SAAS,KAAK,EAAE;AACtC,MAAI,CAAC,OAAO,SAAS,MAAM,KAAK,SAAS,EAAG,QAAO;AACnD,SAAO;AACT;AALS;AAOT,SAAS,gBAAgB,KAAkB;AACzC,SAAO,iBAAiB,IAAI,2BAA2B,GAAG;AAC5D;AAFS;AAIT,SAAS,mBAAmB,KAAU,cAA8B;AAClE,QAAM,WAAW,oBAAoB,IAAI,8BAA8B,EAAE;AACzE,MAAI,YAAY,GAAG;AACjB,WAAO;AAAA,EACT;AACA,MAAI,eAAe,GAAG;AACpB,WAAO,KAAK,IAAI,IAAI,KAAK,MAAM,eAAe,CAAC,CAAC;AAAA,EAClD;AACA,SAAO;AACT;AATS;AAWT,eAAe,cACb,KACA,OACA,UACA,gBACA;AACA,MAAI,kBAAkB,EAAG,QAAO;AAChC,QAAM,WAAW,IAAI,KAAK,KAAK,IAAI,IAAI,GAAM,EAAE,YAAY;AAC3D,QAAM,MAAM,MAAM,IAAI,GACnB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA;AAAA,EAKF,EACC,KAAK,UAAU,OAAO,QAAQ,EAC9B,MAAuC;AAC1C,QAAM,WAAW,KAAK,OAAO;AAC7B,QAAM,QAAQ,OAAO,aAAa,WAAW,WAAW,OAAO,QAAQ;AACvE,SAAO,OAAO,SAAS,KAAK,KAAK,SAAS;AAC5C;AArBe;AAuBf,eAAe,qBACb,KACA,OACA,UACA,uBACA;AACA,MAAI,yBAAyB,EAAG,QAAO;AACvC,QAAM,WAAW,IAAI,KAAK,KAAK,IAAI,IAAI,GAAM,EAAE,YAAY;AAC3D,QAAM,MAAM,MAAM,IAAI,GACnB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMF,EACC,KAAK,UAAU,OAAO,QAAQ,EAC9B,MAAuC;AAC1C,QAAM,WAAW,KAAK,OAAO;AAC7B,QAAM,QAAQ,OAAO,aAAa,WAAW,WAAW,OAAO,QAAQ;AACvE,SAAO,OAAO,SAAS,KAAK,KAAK,SAAS;AAC5C;AAtBe;AAwBf,SAAS,gBAAgB,OAAyB;AAChD,MAAI,CAAC,MAAO,QAAO;AACnB,QAAMC,WACJ,iBAAiB,QAAQ,MAAM,UAC/B,OAAO,UAAU,WAAW,QAC5B;AACF,MAAI,CAACA,SAAS,QAAO;AACrB,SACEA,SAAQ,SAAS,eAAe,KAChCA,SAAQ,YAAY,EAAE,SAAS,0BAA0B;AAE7D;AAXS;AAaT,eAAe,gBACb,KACA,KACA,SACA,eAC8B;AAC9B,QAAM,kBAAkB,IAAI,QAAQ,IAAI,gBAAgB;AACxD,QAAM,kBAAkB,IAAI,QAAQ,IAAI,gBAAgB;AACxD,MAAI,CAAC,mBAAmB,CAAC,iBAAiB;AACxC,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,4BAA4B;AAAA,EACtE;AAEA,QAAM,mBAAmB,gBAAgB,KAAK;AAC9C,QAAM,sBAAsB,gBAAgB,KAAK,EAAE,YAAY;AAC/D,MAAI,CAAC,kBAAkB;AACrB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,8BAA8B;AAAA,EACxE;AACA,MAAI,CAAC,qBAAqB;AACxB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,oBAAoB;AAAA,EAC9D;AAEA,QAAM,OAAO,wBAAwB,gBAAgB;AACrD,MAAI,SAAS,MAAM;AACjB,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,8BAA8B;AAAA,EACxE;AAEA,QAAM,cAAc,qBAAqB,GAAG;AAC5C,MAAI,KAAK,IAAI,KAAK,IAAI,IAAI,IAAI,IAAI,aAAa;AAC7C,WAAO;AAAA,MACL,IAAI;AAAA,MACJ,QAAQ;AAAA,MACR,OAAO;AAAA,IACT;AAAA,EACF;AAEA,QAAM,WAAW,MAAM,cAAc,eAAe,GAAG,gBAAgB,IAAI,OAAO,EAAE;AACpF,MAAI,CAAC,gBAAgB,UAAU,mBAAmB,GAAG;AACnD,WAAO,EAAE,IAAI,OAAO,QAAQ,KAAK,OAAO,oBAAoB;AAAA,EAC9D;AAEA,SAAO,EAAE,IAAI,KAAK;AACpB;AAzCe;AA2Cf,SAAS,YAAY,KAAsB;AACzC,MAAI,CAAC,IAAK,QAAO;AACjB,SAAO,KAAK,MAAM,GAAG;AACvB;AAHS;AAKT,SAAS,cAAc,KAAa;AAClC,SAAO,YAAY,OAAO,GAAG,EAAE,UAAU;AAC3C;AAFS;AAMT,eAAe,sBACb,KACA,KACA,OACA,YACA,IACA,KACA,OACA,UAII,CAAC,GACL;AACA,QAAM,EAAE,WAAW,MAAM,OAAO,OAAO,IAAI;AAC3C,QAAM,YAAY,WAAW,IAAI,KAAK,EAAE,WAAW,SAAS,CAAC,IAAI;AACjE,QAAM,gBAAgB,KAAK,OAAO,YAAY,KAAK,IAAI,IAAI,IAAI,UAAU,SAAS;AAClF,6BAA2B,GAAG;AAC9B,QAAM,WACJ,UAAU,cAAc,MAAM,UAAU,cAAc,MAAM,SAAS;AACvE,QAAM,UAAU,EAAE,aAAa,YAAY,GAAI,UAAU,CAAC,EAAG;AAC7D,MAAI,aAAa,SAAS;AACxB,cAAU,MAAM,OAAO,OAAO;AAAA,EAChC,WAAW,aAAa,QAAQ;AAC9B,cAAU,KAAK,OAAO,OAAO;AAAA,EAC/B,OAAO;AACL,cAAU,KAAK,OAAO,OAAO;AAAA,EAC/B;AACF;AA5Be;AA8Bf,eAAsB,aAAa,KAAc,KAAU,WAAmB;AAC5E,QAAM,KAAK,KAAK,IAAI;AACpB,QAAM,MAAM,iBAAiB,KAAK,EAAE,OAAO,GAAG,YAAY,aAAa,YAAY,UAAU,CAAC;AAC9F,QAAM,OAAO,aAAa,KAAK,GAAG;AAClC,MAAI,CAAC,KAAK,SAAS;AACjB,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,uBAAuB;AAAA,MACvF,QAAQ,EAAE,QAAQ,sBAAsB,QAAQ,KAAK,OAAO;AAAA,MAC5D,OAAO;AAAA,IACT,CAAC;AACD,WAAO,KAAK,EAAE,OAAO,qBAAqB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9D;AAEA,QAAM,aAAa,MAAM,iBAAiB,KAAK,KAAK,YAAY;AAChE,MAAI,YAAY,SAAS;AACvB,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,0BAA0B;AAAA,MAC1F,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,WAAW,WAAW;AAAA,QACtB,kBAAkB,WAAW;AAAA,QAC7B,qBAAqB,WAAW;AAAA,MAClC;AAAA,MACA,OAAO;AAAA,IACT,CAAC;AACD,UAAM,eAAe,KAAK,EAAE,OAAO,sBAAsB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC3E,QAAI,WAAW,qBAAqB,MAAM;AACxC,mBAAa,QAAQ,IAAI,eAAe,OAAO,WAAW,iBAAiB,CAAC;AAAA,IAC9E;AACA,WAAO,SAAS,KAAK,KAAK,cAAc,IAAI;AAAA,EAC9C;AAEA,MAAI;AACJ,MAAI;AACF,kBAAc,MAAM,IAAI,KAAK;AAAA,EAC/B,SAAS,OAAO;AACd,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,2BAA2B;AAAA,MAC3F,QAAQ,EAAE,QAAQ,gBAAgB,MAAM;AAAA,MACxC,OAAO;AAAA,IACT,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AAEA,MAAI,CAAC,cAAc,WAAW,GAAG;AAC/B,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,4BAA4B;AAAA,MAC5F,QAAQ,EAAE,QAAQ,oBAAoB;AAAA,IACxC,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,oBAAoB,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EACvF;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,YAAY,WAAW;AAAA,EACnC,SAAS,OAAO;AACd,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,uBAAuB;AAAA,MACvF,QAAQ,EAAE,QAAQ,gBAAgB,MAAM;AAAA,MACxC,OAAO;AAAA,IACT,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AAEA,QAAM,aAAa,uBAAuB,UAAU,OAAO;AAC3D,MAAI,CAAC,WAAW,SAAS;AACvB,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,4BAA4B;AAAA,MAC5F,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,aAAa,WAAW,MAAM,OAAO;AAAA,MACvC;AAAA,IACF,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,wBAAwB,WAAW,KAAK,GAAG,IAAI;AAAA,EAC3E;AACA,QAAM,OAAyB,WAAW;AAE1C,QAAM,UAAU,gBAAgB,KAAK,EAAE;AACvC,MAAI,CAAC,QAAQ,IAAI;AACf,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,4BAA4B;AAAA,MAC5F,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,QAAQ,OAAO;AAAA,IACnC,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,QAAQ,OAAO,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AACA,QAAM,OAAO,QAAQ;AAErB,QAAM,iBAAiB,gBAAgB,GAAG;AAC1C,QAAM,wBAAwB,mBAAmB,KAAK,cAAc;AAEpE,MACE,MAAM,qBAAqB,KAAK,cAAc,KAAK,WAAW,qBAAqB,GACnF;AACA,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,+BAA+B;AAAA,MAC/F,UAAU,KAAK;AAAA,MACf,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,0BAA0B;AAAA,MAC5B;AAAA,IACF,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,sBAAsB,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EACzF;AAEA,MAAI,MAAM,cAAc,KAAK,cAAc,KAAK,WAAW,cAAc,GAAG;AAC1E,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,uBAAuB;AAAA,MACvF,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,gBAAgB,kBAAkB,eAAe;AAAA,IACrE,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,sBAAsB,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EACzF;AAEA,QAAM,YAAY,IAAI,QAAQ,IAAI,iBAAiB;AACnD,QAAM,kBAAkB,MAAM,gBAAgB,KAAK,KAAK,WAAW,SAAS;AAC5E,MAAI,CAAC,gBAAgB,MAAM,CAAC,gBAAgB,eAAe;AACzD,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,kCAAkC;AAAA,MAClG,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,qBAAqB;AAAA,IACzC,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AAEA,QAAM,iBAAiB,MAAM,gBAAgB,KAAK,KAAK,aAAa,gBAAgB,aAAa;AACjG,MAAI,CAAC,eAAe,IAAI;AACtB,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA,eAAe;AAAA,MACf;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,QACE,UAAU,KAAK;AAAA,QACf,QAAQ,EAAE,QAAQ,eAAe,MAAM;AAAA,MACzC;AAAA,IACF;AACA,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,KAAK,EAAE,OAAO,eAAe,MAAM,GAAG,EAAE,QAAQ,eAAe,OAAO,CAAC;AAAA,MACvE;AAAA,IACF;AAAA,EACF;AAEA,QAAM,SAAS,MAAM,IAAI,GACtB,QAAQ,qDAAqD,EAC7D,KAAK,KAAK,SAAS,EACnB,MAAsC;AAEzC,MAAI,CAAC,QAAQ;AACX,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,yBAAyB;AAAA,MACzF,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,iBAAiB;AAAA,IACrC,CAAC;AACD,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,KAAK,EAAE,OAAO,gCAAgC,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MAChE;AAAA,IACF;AAAA,EACF;AAEA,MAAI,OAAO,cAAc,OAAO,eAAe,WAAW;AACxD,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,2BAA2B;AAAA,MAC3F,UAAU,KAAK;AAAA,MACf,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,eAAe,OAAO;AAAA,QACtB,sBAAsB;AAAA,MACxB;AAAA,IACF,CAAC;AACD,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,KAAK,EAAE,OAAO,8BAA8B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MAC9D;AAAA,IACF;AAAA,EACF;AAEA,MAAI,CAAC,OAAO,YAAY;AACtB,UAAM,QAAQ,MAAM,qBAAqB,KAAK,KAAK,WAAW,SAAS;AACvE,QAAI,CAAC,MAAM,MAAM,MAAM,WAAW,oBAAoB;AACpD,YAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,yBAAyB;AAAA,QACzF,UAAU,KAAK;AAAA,QACf,QAAQ,EAAE,QAAQ,iBAAiB;AAAA,MACrC,CAAC;AACD,aAAO;AAAA,QACL;AAAA,QACA;AAAA,QACA,KAAK,EAAE,OAAO,8BAA8B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,QAC9D;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAEA,QAAM,SAAS,OAAO,KAAK,QAAQ,YAAY,WAAW,KAAK,QAAQ,UAAU;AACjF,QAAM,MAAM,OAAO,KAAK,QAAQ,YAAY,WAAW,KAAK,QAAQ,UAAU;AAC9E,QAAM,OAAO,OAAO,KAAK,QAAQ,YAAY,WAAW,KAAK,QAAQ,UAAU;AAC/E,QAAM,UAAU,OAAO,KAAK,QAAQ,YAAY,WAAW,KAAK,QAAQ,UAAU;AAElF,QAAM,EAAE,QAAQ,WAAW,KAAK,YAAY,IAAI,uBAAuB;AAAA,IACrE,SAAS;AAAA,IACT,SAAS;AAAA,IACT,SAAS;AAAA,IACT;AAAA,EACF,CAAC;AAED,QAAM,uBAAuB,KAAK,UAAU,KAAK,OAAO;AACxD,QAAM,cAAc,KAAK,UAAU,KAAK,UAAU,CAAC,CAAC;AACpD,QAAM,cAAc,KAAK,UAAU;AAAA,IACjC,MAAM,KAAK,QAAQ,QAAQ;AAAA,IAC3B,SAAS,KAAK,QAAQ,WAAW;AAAA,IACjC,MAAM,KAAK,QAAQ;AAAA,EACrB,CAAC;AAED,QAAM,gBAAgB,oBAAoB,GAAG;AAC7C,QAAM,iBAAiB,OAAO;AAC9B,QAAM,qBAAqB,KAAK,IAAI;AAEpC,MAAI;AACF,UAAM,eAAe,OAAO;AAC5B,UAAM,cAAc,IAAI,KAAK,IAAI,EAAE,YAAY;AAE/C,UAAM,gBAAgB,IAAI,IAAI,YAAY;AACxC,YAAM,IAAI,GACP;AAAA,QACC;AAAA,MACF,EACC,KAAK,KAAK,WAAW,MAAM,kBAAkB,EAC7C,IAAI;AAEP,YAAM,IAAI,GACP;AAAA,QACC;AAAA;AAAA;AAAA,MAGF,EACC;AAAA,QACC,KAAK;AAAA,QACL;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACF,EACC,IAAI;AAEP,YAAM,IAAI,GACP;AAAA,QACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAWF,EACC;AAAA,QACC,KAAK;AAAA,QACL;AAAA,QACA;AAAA,QACA;AAAA,QACA,KAAK,QAAQ,SAAS;AAAA,QACtB,KAAK,QAAQ,YAAY;AAAA,QACzB;AAAA,QACA,KAAK,QAAQ,gBAAgB;AAAA,QAC7B,KAAK,QAAQ,YAAY;AAAA,QACzB,KAAK,QAAQ,WAAW;AAAA,QACxB;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,KAAK,QAAQ,QAAQ;AAAA,QACrB,KAAK,QAAQ,WAAW;AAAA,QACxB;AAAA,QACA;AAAA,QACA;AAAA,MACF,EACC,IAAI;AAEP,YAAM,IAAI,GACP,QAAQ,iEAAiE,EACzE,KAAK,KAAK,WAAW,WAAW,EAChC,IAAI;AAEP,YAAM,IAAI,GACP,QAAQ,8EAA8E,EACtF,KAAK,KAAK,WAAW,MAAM,cAAc,EACzC,IAAI;AAAA,IACT,CAAC;AAED,UAAM,YAAY,IAAI,KAAK,EAAE,WAAW,KAAK,UAAU,CAAC;AACxD,UAAM,gBAAgB,KAAK,cAAc,KAAK,KAAK,IAAI,IAAI,IAAI,KAAK,WAAW,SAAS;AACxF,+BAA2B,GAAG;AAC9B,cAAU,KAAK,2BAA2B;AAAA,MACxC,YAAY,IAAI,KAAK,IAAI,EAAE,YAAY;AAAA,MACvC,cAAc,KAAK,QAAQ,UAAU;AAAA,MACrC,SAAS;AAAA,MACT,YAAY;AAAA,MACZ;AAAA,IACF,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,IAAI,KAAK,CAAC,GAAG,IAAI;AAAA,EACpD,SAAS,GAAQ;AACf,QAAI,gBAAgB,CAAC,GAAG;AACtB,YAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,4BAA4B;AAAA,QAC5F,UAAU,KAAK;AAAA,QACf,QAAQ;AAAA,UACN,QAAQ;AAAA,UACR,YAAY,IAAI,KAAK,IAAI,EAAE,YAAY;AAAA,UACvC,iBAAiB;AAAA,QACnB;AAAA,MACF,CAAC;AACD,aAAO;AAAA,QACL;AAAA,QACA;AAAA,QACA,KAAK,EAAE,OAAO,oBAAoB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,QACpD;AAAA,MACF;AAAA,IACF;AAEA,UAAM,sBAAsB,KAAK,KAAK,cAAc,KAAK,IAAI,KAAK,mBAAmB;AAAA,MACnF,UAAU,KAAK;AAAA,MACf,OAAO;AAAA,MACP,QAAQ,EAAE,QAAQ,YAAY,OAAO,EAAE;AAAA,IACzC,CAAC;AACD,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,KAAK,EAAE,OAAO,WAAW,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MAC3C;AAAA,IACF;AAAA,EACF;AACF;AA7UsB;AA+UtB,eAAsB,gBAAgB,KAAc,KAAU,WAAmB;AAC/E,QAAM,KAAK,KAAK,IAAI;AACpB,QAAM,MAAM,iBAAiB,KAAK,EAAE,OAAO,GAAG,eAAe,aAAa,YAAY,UAAU,CAAC;AACjG,QAAM,OAAO,aAAa,KAAK,GAAG;AAClC,MAAI,CAAC,KAAK,SAAS;AACjB,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,0BAA0B;AAAA,MAC7F,QAAQ,EAAE,QAAQ,sBAAsB,QAAQ,KAAK,OAAO;AAAA,MAC5D,OAAO;AAAA,IACT,CAAC;AACD,WAAO,KAAK,EAAE,OAAO,qBAAqB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC9D;AAEA,QAAM,aAAa,MAAM,iBAAiB,KAAK,KAAK,eAAe;AACnE,MAAI,YAAY,SAAS;AACvB,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,6BAA6B;AAAA,MAChG,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,WAAW,WAAW;AAAA,QACtB,kBAAkB,WAAW;AAAA,QAC7B,qBAAqB,WAAW;AAAA,MAClC;AAAA,MACA,OAAO;AAAA,IACT,CAAC;AACD,UAAM,eAAe,KAAK,EAAE,OAAO,sBAAsB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC3E,QAAI,WAAW,qBAAqB,MAAM;AACxC,mBAAa,QAAQ,IAAI,eAAe,OAAO,WAAW,iBAAiB,CAAC;AAAA,IAC9E;AACA,WAAO,SAAS,KAAK,KAAK,cAAc,IAAI;AAAA,EAC9C;AAEA,MAAI;AACJ,MAAI;AACF,kBAAc,MAAM,IAAI,KAAK;AAAA,EAC/B,SAAS,OAAO;AACd,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,8BAA8B;AAAA,MACjG,QAAQ,EAAE,QAAQ,gBAAgB,MAAM;AAAA,MACxC,OAAO;AAAA,IACT,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AAEA,MAAI,CAAC,cAAc,WAAW,GAAG;AAC/B,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,+BAA+B;AAAA,MAClG,QAAQ,EAAE,QAAQ,oBAAoB;AAAA,IACxC,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,oBAAoB,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EACvF;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,YAAY,WAAW;AAAA,EACnC,SAAS,OAAO;AACd,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,0BAA0B;AAAA,MAC7F,QAAQ,EAAE,QAAQ,gBAAgB,MAAM;AAAA,MACxC,OAAO;AAAA,IACT,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AAEA,QAAM,aAAa,uBAAuB,UAAU,OAAO;AAC3D,MAAI,CAAC,WAAW,SAAS;AACvB,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,+BAA+B;AAAA,MAClG,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,aAAa,WAAW,MAAM,OAAO;AAAA,MACvC;AAAA,IACF,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,wBAAwB,WAAW,KAAK,GAAG,IAAI;AAAA,EAC3E;AACA,QAAM,OAAyB,WAAW;AAE1C,QAAM,QAAQ,KAAK,OAAM,oBAAI,KAAK,GAAE,YAAY;AAChD,QAAM,UAAU,gBAAgB,KAAK;AACrC,MAAI,CAAC,QAAQ,IAAI;AACf,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,+BAA+B;AAAA,MAClG,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,QAAQ,OAAO;AAAA,IACnC,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,QAAQ,OAAO,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AAEA,QAAM,iBAAiB,gBAAgB,GAAG;AAC1C,QAAM,oBAAoB,mBAAmB,KAAK,cAAc;AAEhE,MACE,MAAM,qBAAqB,KAAK,iBAAiB,KAAK,WAAW,iBAAiB,GAClF;AACA,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,kCAAkC;AAAA,MACrG,UAAU,KAAK;AAAA,MACf,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,0BAA0B;AAAA,MAC5B;AAAA,IACF,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,sBAAsB,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EACzF;AAEA,MAAI,MAAM,cAAc,KAAK,iBAAiB,KAAK,WAAW,cAAc,GAAG;AAC7E,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,0BAA0B;AAAA,MAC7F,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,gBAAgB,kBAAkB,eAAe;AAAA,IACrE,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,sBAAsB,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EACzF;AAEA,QAAM,YAAY,IAAI,QAAQ,IAAI,iBAAiB;AACnD,QAAM,kBAAkB,MAAM,gBAAgB,KAAK,KAAK,WAAW,SAAS;AAC5E,MAAI,CAAC,gBAAgB,MAAM,CAAC,gBAAgB,eAAe;AACzD,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,qCAAqC;AAAA,MACxG,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,qBAAqB;AAAA,IACzC,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAClF;AAEA,QAAM,iBAAiB,MAAM,gBAAgB,KAAK,KAAK,aAAa,gBAAgB,aAAa;AACjG,MAAI,CAAC,eAAe,IAAI;AACtB,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,MACA,eAAe;AAAA,MACf;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,QACE,UAAU,KAAK;AAAA,QACf,QAAQ,EAAE,QAAQ,eAAe,MAAM;AAAA,MACzC;AAAA,IACF;AACA,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,KAAK,EAAE,OAAO,eAAe,MAAM,GAAG,EAAE,QAAQ,eAAe,OAAO,CAAC;AAAA,MACvE;AAAA,IACF;AAAA,EACF;AAEA,QAAM,SAAS,MAAM,IAAI,GACtB,QAAQ,qDAAqD,EAC7D,KAAK,KAAK,SAAS,EACnB,MAAsC;AAEzC,MAAI,CAAC,QAAQ;AACX,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,4BAA4B;AAAA,MAC/F,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,iBAAiB;AAAA,IACrC,CAAC;AACD,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,KAAK,EAAE,OAAO,gCAAgC,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MAChE;AAAA,IACF;AAAA,EACF;AAEA,MAAI,OAAO,cAAc,OAAO,eAAe,WAAW;AACxD,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,8BAA8B;AAAA,MACjG,UAAU,KAAK;AAAA,MACf,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,eAAe,OAAO;AAAA,QACtB,sBAAsB;AAAA,MACxB;AAAA,IACF,CAAC;AACD,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA,KAAK,EAAE,OAAO,8BAA8B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MAC9D;AAAA,IACF;AAAA,EACF;AAEA,MAAI,CAAC,OAAO,YAAY;AACtB,UAAM,QAAQ,MAAM,qBAAqB,KAAK,KAAK,WAAW,SAAS;AACvE,QAAI,CAAC,MAAM,MAAM,MAAM,WAAW,oBAAoB;AACpD,YAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,4BAA4B;AAAA,QAC/F,UAAU,KAAK;AAAA,QACf,QAAQ,EAAE,QAAQ,iBAAiB;AAAA,MACrC,CAAC;AACD,aAAO;AAAA,QACL;AAAA,QACA;AAAA,QACA,KAAK,EAAE,OAAO,8BAA8B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,QAC9D;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAEA,QAAM,iBAAiB,gBAAgB,GAAG;AAC1C,MAAI,MAAM,cAAc,KAAK,iBAAiB,KAAK,WAAW,cAAc,GAAG;AAC7E,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,0BAA0B;AAAA,MAC7F,UAAU,KAAK;AAAA,MACf,QAAQ,EAAE,QAAQ,gBAAgB,kBAAkB,eAAe;AAAA,IACrE,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,sBAAsB,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EACzF;AAEA,QAAM,OAAO,QAAQ,MAAM,KAAK,IAAI;AAEpC,MAAI;AACF,UAAM,aAAa,IAAI,KAAK,IAAI,EAAE,YAAY;AAC9C,UAAM,gBAAgB,IAAI,IAAI,YAAY;AACxC,YAAM,IAAI,GACP;AAAA,QACC;AAAA;AAAA;AAAA,MAGF,EACC,KAAK,KAAK,WAAW,UAAU,EAC/B,IAAI;AAEP,YAAM,IAAI,GACP,QAAQ,iEAAiE,EACzE,KAAK,KAAK,WAAW,UAAU,EAC/B,IAAI;AAAA,IACT,CAAC;AAED,UAAM,YAAY,IAAI,KAAK,EAAE,WAAW,KAAK,UAAU,CAAC;AACxD,UAAM,gBAAgB,KAAK,iBAAiB,KAAK,KAAK,IAAI,IAAI,IAAI,KAAK,WAAW,SAAS;AAC3F,+BAA2B,GAAG;AAC9B,cAAU,KAAK,sBAAsB,EAAE,YAAY,IAAI,KAAK,IAAI,EAAE,YAAY,EAAE,CAAC;AACjF,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,IAAI,MAAM,cAAa,oBAAI,KAAK,GAAE,YAAY,EAAE,CAAC,GAAG,IAAI;AAAA,EAC3F,SAAS,GAAG;AACV,UAAM,sBAAsB,KAAK,KAAK,iBAAiB,KAAK,IAAI,KAAK,sBAAsB;AAAA,MACzF,UAAU,KAAK;AAAA,MACf,OAAO;AAAA,MACP,QAAQ,EAAE,QAAQ,YAAY,OAAO,EAAE;AAAA,IACzC,CAAC;AACD,WAAO,SAAS,KAAK,KAAK,KAAK,EAAE,OAAO,WAAW,GAAG,EAAE,QAAQ,IAAI,CAAC,GAAG,IAAI;AAAA,EAC9E;AACF;AAvOsB;;;AC/iBtB,eAAsB,SAAS,KAAc,KAAU;AACrD,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AACjE,SAAO,KAAK,IAAI;AAClB;AAJsB;;;ACGtB,eAAsB,oBAAoB,KAAc,KAAU;AAChE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,IAAI;AACnC,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK,EAAE,cAAc,OAAO,GAAG,SAAS,CAAC,GAAG,SAAS,EAAE,OAAO,GAAG,OAAO,EAAE,EAAE,CAAC;AAAA,EACtF;AAEA,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AACrB,MAAI,CAAC,MAAM,SAAS;AAClB,YAAQ,SAAS,OAAO,MAAM,MAAM;AACpC,SAAK,KAAK,GAAG,MAAM,IAAI;AAAA,EACzB;AAEA,QAAM,OAAO,MAAM,IAAI,GACpB;AAAA,IACC;AAAA;AAAA;AAAA;AAAA;AAAA,WAKK,KAAK;AAAA;AAAA,EAEZ,EACC,KAAK,GAAG,IAAI,EACZ,IAeE;AAEL,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,QAAQ;AAAA,OACrB,KAAK,WAAW,CAAC,GAAG,IAAI,OAAO,SAAS;AAAA,QACvC,WAAW,gBAAgB,IAAI,WAAW,MAAM,OAAO;AAAA,QACvD,QAAQ,MAAM,kBAAkB,IAAI,WAAW,KAAK,MAAM,OAAO;AAAA,QACjE,MAAM,IAAI,QAAQ;AAAA,QAClB,QAAQ,CAAC,CAAC,IAAI;AAAA,QACd,cAAc,IAAI,gBAAgB;AAAA,QAClC,SAAS,IAAI,WAAW;AAAA,QACxB,SAAS,IAAI,WAAW;AAAA,QACxB,QAAQ,IAAI,UAAU;AAAA,QACtB,SAAS,IAAI,WAAW;AAAA,QACxB,KAAK,IAAI,OAAO;AAAA,QAChB,WAAW,IAAI,aAAa;AAAA,QAC5B,MAAM,IAAI,QAAQ;AAAA,QAClB,SAAS,IAAI,WAAW;AAAA,QACxB,SAAS,IAAI,WAAW;AAAA,QACxB,YAAY,IAAI,cAAc;AAAA,MAChC,EAAE;AAAA,IACJ;AAAA,EACF,SAAS,KAAK;AACZ,qBAAiB,KAAK,EAAE,OAAO,+BAA+B,CAAC,EAAE;AAAA,MAC/D;AAAA,MACA,EAAE,OAAO,IAAI;AAAA,IACf;AACA,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,QAAQ,QAAQ,OAAO,CAAC,MAAW,EAAE,UAAU,EAAE,WAAW,QAAQ,EAAE,YAAY,IAAI,EAAE;AAE9F,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB;AAAA,IACA,SAAS;AAAA,MACP,OAAO,QAAQ;AAAA,MACf;AAAA,IACF;AAAA,EACF,CAAC;AACH;AAnFsB;;;ACJtB,eAAsB,eAAe;AACnC,SAAO,KAAK,EAAE,IAAI,MAAM,IAAI,OAAO,EAAE,CAAC;AACxC;AAFsB;;;ACAf,IAAM,yBAAyB,CAAC,SAAS,eAAe,WAAW,aAAa,QAAQ;AAExF,IAAM,4BAA4B,iBAAE,KAAK,sBAAsB;AAE/D,IAAM,+BAA+B,iBACzC,OAAO;AAAA,EACN,QAAQ,0BAA0B,SAAS;AAAA,EAC3C,QAAQ,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC1C,SAAS,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC3C,OAAO,aAAa,EAAE,SAAS,MAAM,KAAK,GAAG,KAAK,KAAK,cAAc,GAAG,CAAC;AAAA,EACzE,OAAO,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AAAA,EACtD,OAAO,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AACxD,CAAC,EACA,OAAO;AAEH,IAAM,+BAA+B,iBACzC,OAAO;AAAA,EACN,QAAQ,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC1C,WAAW,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC;AAAA,EAClC,YAAY,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,EAC9C,QAAQ,0BAA0B,QAAQ,OAAO;AAAA,EACjD,YAAY,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS;AAAA,EAC3D,cAAc,iBAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,KAAK,CAAC,EAAE,SAAS,EAAE,SAAS;AAAA,EACxE,WAAW,iBAAE,MAAM,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC,EAAE,SAAS;AAAA,EACtD,OAAO,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,IAAI,GAAI,EAAE,SAAS;AAAA,EACnD,cAAc,iBAAE,OAAO,EAAE,KAAK,EAAE,IAAI,CAAC,EAAE,SAAS;AAClD,CAAC,EACA,OAAO;;;AC1BV,IAAMC,WAAU,IAAI,YAAY;AAEhC,IAAM,oBAAoB;AAC1B,IAAM,sBAAsB,IAAI,KAAK,KAAK;AAC1C,IAAM,kBAAkB;AAExB,IAAM,sBAA8C;AAAA,EAClD,QAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AAAA,EACV,UAAU;AACZ;AAEA,SAAS,gBAAgB,OAAuB;AAC9C,SAAO,MACJ,UAAU,MAAM,EAChB,QAAQ,oBAAoB,EAAE,EAC9B,MAAM,EAAE,EACR,IAAI,CAAC,SAAS;AACb,QAAI,SAAS,QAAQ,SAAS,KAAM,QAAO;AAC3C,QAAI,SAAS,IAAM,QAAO;AAC1B,QAAI,QAAQ,OAAO,QAAQ,IAAK,QAAO;AACvC,WAAO,oBAAoB,IAAI,KAAK;AAAA,EACtC,CAAC,EACA,KAAK,EAAE;AACZ;AAZS;AAqBT,SAAS,cAAc,OAAuB;AAC5C,QAAM,YAAY,gBAAgB,KAAK;AACvC,SAAO,UAAU,QAAQ,OAAO,MAAM,EAAE,QAAQ,OAAO,KAAK,EAAE,QAAQ,OAAO,KAAK,EAAE,QAAQ,UAAU,GAAG;AAC3G;AAHS;AAKT,SAAS,SAASC,OAAc,WAAW,IAAc;AACvD,QAAM,QAAQA,MAAK,MAAM,KAAK,EAAE,OAAO,OAAO;AAC9C,MAAI,CAAC,MAAM,OAAQ,QAAO,CAAC,EAAE;AAC7B,QAAM,QAAkB,CAAC;AACzB,MAAI,UAAU;AACd,aAAW,QAAQ,OAAO;AACxB,UAAM,YAAY,UAAU,GAAG,OAAO,IAAI,IAAI,KAAK;AACnD,QAAI,UAAU,UAAU,UAAU;AAChC,gBAAU;AAAA,IACZ,OAAO;AACL,UAAI,QAAS,OAAM,KAAK,OAAO;AAC/B,gBAAU;AAAA,IACZ;AAAA,EACF;AACA,MAAI,QAAS,OAAM,KAAK,OAAO;AAC/B,SAAO,MAAM,SAAS,QAAQ,CAACA,MAAK,MAAM,GAAG,QAAQ,CAAC;AACxD;AAhBS;AAkBT,SAAS,WAAW,QAA0BA,OAAc;AAC1D,SAAO,SAAS,KAAK,IAAI,cAAcA,KAAI,CAAC,MAAM;AAClD,SAAO,WAAW,OAAO;AACzB,SAAO,SAAS,KAAK,MAAM,OAAO,UAAU,KAAK;AACnD;AAJS;AAMT,SAAS,aAAa,KAA6B,aAA6B;AAC9E,QAAM,QAAkB,CAAC;AACzB,QAAM,KAAK,0BAA0B;AACrC,QAAM,KAAK,WAAW,IAAI,MAAM,EAAE;AAClC,QAAM,KAAK,WAAW,IAAI,SAAS,EAAE;AACrC,QAAM,KAAK,YAAY,IAAI,cAAc,KAAK,EAAE;AAChD,QAAM,KAAK,WAAW,IAAI,MAAM,EAAE;AAClC,QAAM,KAAK,YAAY,IAAI,UAAU,EAAE;AACvC,QAAM,KAAK,cAAc,IAAI,gBAAgB,KAAK,EAAE;AACpD,QAAM,KAAK,iBAAiB,IAAI,gBAAgB,KAAK,EAAE;AACvD,QAAM,KAAK,cAAc,WAAW,EAAE;AAEtC,MAAI,IAAI,OAAO;AACb,UAAM,KAAK,EAAE;AACb,UAAM,KAAK,QAAQ;AACnB,UAAM,YAAY,SAAS,IAAI,KAAK;AACpC,eAAW,QAAQ,WAAW;AAC5B,YAAM,KAAK,KAAK,IAAI,EAAE;AAAA,IACxB;AAAA,EACF;AAEA,MAAI,MAAM,QAAQ,IAAI,SAAS,KAAK,IAAI,UAAU,QAAQ;AACxD,UAAM,KAAK,EAAE;AACb,UAAM,KAAK,YAAY;AACvB,eAAW,QAAQ,IAAI,WAAW;AAChC,YAAM,KAAK,KAAK,IAAI,EAAE;AAAA,IACxB;AAAA,EACF;AAEA,QAAM,SAA2B;AAAA,IAC/B,SAAS;AAAA,IACT,SAAS;AAAA,IACT,UAAU,CAAC,MAAM,aAAa,WAAW;AAAA,IACzC,YAAY;AAAA,EACd;AAEA,aAAW,QAAQ,OAAO;AACxB,eAAW,QAAQ,QAAQ,GAAG;AAAA,EAChC;AAEA,SAAO,SAAS,KAAK,IAAI;AACzB,SAAO,OAAO,SAAS,KAAK,IAAI;AAClC;AA1CS;AA4CT,SAAS,YAAY,eAAmC;AACtD,QAAM,cAAc,aAAa,aAAa;AAC9C,QAAM,UAAoB,CAAC;AAE3B,UAAQ,CAAC,IAAI;AAAA;AAAA;AAAA;AAKb,UAAQ,CAAC,IAAI;AAAA;AAAA;AAAA;AAKb,UAAQ,CAAC,IAAI;AAAA;AAAA;AAAA;AAKb,UAAQ,CAAC,IAAI;AAAA,aACF,YAAY,MAAM;AAAA;AAAA,EAE7B,aAAa;AAAA;AAAA;AAAA;AAKb,UAAQ,CAAC,IAAI;AAAA;AAAA;AAAA;AAKb,QAAM,SAAS;AAAA,EACf,OAAO,aAAa,KAAM,KAAM,KAAM,GAAI,CAAC;AAAA;AAE3C,MAAI,WAAW,OAAO;AACtB,QAAM,UAAoB,CAAC,CAAC;AAC5B,MAAI,OAAO;AAEX,WAAS,IAAI,GAAG,KAAK,GAAG,KAAK;AAC3B,UAAM,MAAM,QAAQ,CAAC;AACrB,YAAQ,CAAC,IAAI;AACb,YAAQ;AACR,gBAAY,IAAI;AAAA,EAClB;AAEA,QAAM,YAAY;AAClB,MAAI,OAAO;AAAA;AAAA;AAAA;AAIX,WAAS,IAAI,GAAG,KAAK,GAAG,KAAK;AAC3B,YAAQ,GAAG,QAAQ,CAAC,EAAE,SAAS,EAAE,SAAS,IAAI,GAAG,CAAC;AAAA;AAAA,EACpD;AAEA,QAAM,UAAU;AAAA;AAAA;AAAA,EAGhB,SAAS;AAAA;AAAA;AAIT,QAAM,YAAY,OAAO,OAAO;AAChC,SAAO,aAAa,SAAS;AAC/B;AAhES;AAkET,SAAS,aAAa,OAA2B;AAC/C,QAAM,QAAQ,IAAI,WAAW,MAAM,MAAM;AACzC,WAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK,GAAG;AACxC,UAAM,CAAC,IAAI,MAAM,WAAW,CAAC,IAAI;AAAA,EACnC;AACA,SAAO;AACT;AANS;AAOT,eAAe,cAAc,KAAU,KAAa,QAAgB,YAA4C;AAC9G,MAAI,CAAC,IAAI,gBAAgB,CAAC,IAAI,sBAAsB;AAClD,WAAO;AAAA,EACT;AAEA,QAAM,UAAU,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI,IAAI;AAChD,QAAM,kBAAkB,OAAO,YAAY;AAC3C,QAAM,UAAU,GAAG,eAAe;AAAA,EAAK,GAAG;AAAA,EAAK,OAAO;AACtD,QAAM,YAAY,MAAM,OAAO,OAAO;AAAA,IACpC;AAAA,IACAD,SAAQ,OAAO,IAAI,oBAAoB;AAAA,IACvC,EAAE,MAAM,QAAQ,MAAM,UAAU;AAAA,IAChC;AAAA,IACA,CAAC,MAAM;AAAA,EACT;AACA,QAAM,MAAM,MAAM,OAAO,OAAO,KAAK,QAAQ,WAAWA,SAAQ,OAAO,OAAO,CAAC;AAC/E,QAAM,YAAY,CAAC,GAAG,IAAI,WAAW,GAAG,CAAC,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AAC9F,QAAM,MAAM,IAAI,IAAI,OAAO,GAAG,IAAI,IAAI,YAAY;AAClD,MAAI,aAAa,IAAI,OAAO,OAAO,OAAO,CAAC;AAC3C,MAAI,aAAa,IAAI,OAAO,SAAS;AACrC,SAAO,IAAI,SAAS;AACtB;AArBe;AA6Bf,eAAsB,4BACpB,KACA,KACA,UAA6D,CAAC,GACtB;AACxC,QAAM,SAAS,IAAI,aAAa,IAAI;AACpC,MAAI,CAAC,QAAQ;AACX,WAAO;AAAA,EACT;AAEA,QAAM,cAAc,OAAO;AAC3B,QAAM,gBAAgB,aAAa,KAAK,WAAW;AACnD,QAAM,WAAW,YAAY,aAAa;AAC1C,QAAM,MAAM,GAAG,QAAQ,aAAa,iBAAiB,GAAG,IAAI,MAAM;AAElE,QAAM,OAAO,IAAI,KAAK,UAAU;AAAA,IAC9B,cAAc,EAAE,aAAa,kBAAkB;AAAA,EACjD,CAAC;AAED,MAAI,MAAM,MAAM,cAAc,KAAK,KAAK,OAAO,QAAQ,oBAAoB,mBAAmB;AAC9F,MAAI,CAAC,OAAO,IAAI,cAAc;AAC5B,UAAM,IAAI,IAAI,OAAO,GAAG,IAAI,IAAI,YAAY,EAAE,SAAS;AAAA,EACzD;AACA,SAAO,EAAE,KAAK,KAAK,cAAc,YAAY;AAC/C;AAxBsB;;;AC3JtB,SAAS,UAAU,KAA+C;AAChE,MAAI,YAA6B;AACjC,MAAI,IAAI,gBAAgB;AACtB,QAAI;AACF,YAAM,SAAS,KAAK,MAAM,IAAI,cAAc;AAC5C,UAAI,MAAM,QAAQ,MAAM,EAAG,aAAY,OAAO,OAAO,CAAC,SAAS,OAAO,SAAS,QAAQ;AAAA,IACzF,QAAQ;AACN,kBAAY;AAAA,IACd;AAAA,EACF;AACA,SAAO;AAAA,IACL,QAAQ,IAAI;AAAA,IACZ,WAAW,IAAI;AAAA,IACf,YAAY,IAAI;AAAA,IAChB,QAAQ,IAAI;AAAA,IACZ,YAAY,IAAI;AAAA,IAChB,cAAc,IAAI;AAAA,IAClB;AAAA,IACA,OAAO,IAAI;AAAA,IACX,cAAc,IAAI;AAAA,IAClB,YAAY,IAAI;AAAA,IAChB,YAAY,IAAI;AAAA,IAChB,YAAY,IAAI;AAAA,EAClB;AACF;AAxBS;AA0BT,eAAsB,uBACpB,KACA,QACuC;AACvC,QAAM,WAAW,OAAO;AACxB,QAAM,KAAK,OAAO,UAAU,OAAO,WAAW;AAC9C,QAAM,YAAY,OAAO,cAAc,OAAO;AAC9C,QAAM,YAAY,OAAO,cAAc;AACvC,QAAM,YAAY,OAAO,cAAc;AACvC,QAAM,cAAc,OAAO,gBAAgB;AAC3C,QAAM,gBAAgB,OAAO,YAAY,KAAK,UAAU,OAAO,SAAS,IAAI;AAC5E,QAAM,QAAQ,OAAO,SAAS;AAC9B,QAAM,cAAc,OAAO,gBAAgB;AAC3C,QAAM,YAAY;AAElB,MAAI,YAAuC,OAAO,cAAc;AAEhE,MAAI,CAAC,WAAW;AACd,UAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,6DAA6D,EACrE,KAAK,QAAQ,EACb,MAAqC;AACxC,QAAI,CAAC,WAAW;AACd,aAAO,EAAE,IAAI,OAAO,QAAQ,mBAAmB;AAAA,IACjD;AACA,gBAAY,UAAU,cAAc;AAAA,EACtC,OAAO;AACL,UAAM,SAAS,MAAM,IAAI,GACtB,QAAQ,oDAAoD,EAC5D,KAAK,QAAQ,EACb,MAAM;AACT,QAAI,CAAC,QAAQ;AACX,aAAO,EAAE,IAAI,OAAO,QAAQ,mBAAmB;AAAA,IACjD;AAAA,EACF;AAEA,MAAI;AACF,UAAM,IAAI,GACP;AAAA,MACC;AAAA;AAAA;AAAA;AAAA;AAAA,IAKF,EACC;AAAA,MACC;AAAA,MACA;AAAA,MACA;AAAA,MACA,OAAO;AAAA,MACP;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IACF,EACC,IAAI;AAAA,EACT,SAAS,KAAU;AACjB,UAAME,WAAU,OAAO,KAAK,YAAY,WAAW,IAAI,UAAU,OAAO,GAAG;AAC3E,QAAIA,SAAQ,SAAS,0BAA0B,GAAG;AAChD,aAAO,EAAE,IAAI,OAAO,QAAQ,WAAW;AAAA,IACzC;AACA,UAAM;AAAA,EACR;AAEA,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,4DAA4D,EACpE,KAAK,EAAE,EACP,MAAwB;AAE3B,MAAI,CAAC,KAAK;AACR,WAAO,EAAE,IAAI,OAAO,QAAQ,mBAAmB;AAAA,EACjD;AAEA,MAAI,YAAY,UAAU,GAAG;AAE7B,MAAI,UAAU,WAAW,eAAe,CAAC,UAAU,YAAY;AAC7D,QAAI;AACF,YAAM,SAAS,MAAM,4BAA4B,KAAK,SAAS;AAC/D,UAAI,QAAQ,KAAK;AACf,cAAM,eAAe,OAAO;AAC5B,cAAM,IAAI,GACP,QAAQ,kFAAkF,EAC1F,KAAK,OAAO,KAAK,cAAc,UAAU,MAAM,EAC/C,IAAI;AACP,oBAAY,EAAE,GAAG,WAAW,YAAY,OAAO,KAAK,YAAY,aAAa;AAAA,MAC/E;AAAA,IACF,SAAS,OAAO;AACd,cAAQ,KAAK,+BAA+B;AAAA,QAC1C,QAAQ,UAAU;AAAA,QAClB;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AAEA,SAAO,EAAE,IAAI,MAAM,KAAK,UAAU;AACpC;AAnGsB;AAqGtB,eAAsB,sBACpB,KACA,SACmC;AACnC,MAAI,QAAQ;AACZ,QAAM,OAAc,CAAC;AAErB,MAAI,QAAQ,QAAQ;AAClB,YAAQ,SAAS,OAAO,YAAY;AACpC,SAAK,KAAK,QAAQ,MAAM;AAAA,EAC1B;AAEA,MAAI,QAAQ,WAAW;AACrB,YAAQ,SAAS,OAAO,eAAe;AACvC,SAAK,KAAK,QAAQ,SAAS;AAAA,EAC7B;AAEA,MAAI,QAAQ,eAAe,QAAQ,YAAY,QAAQ;AACrD,UAAM,eAAe,QAAQ,YAAY,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AAChE,YAAQ,SAAS,OAAO,kBAAkB,YAAY,GAAG;AACzD,SAAK,KAAK,GAAG,QAAQ,WAAW;AAAA,EAClC,WAAW,QAAQ,YAAY;AAC7B,YAAQ,SAAS,OAAO,gBAAgB;AACxC,SAAK,KAAK,QAAQ,UAAU;AAAA,EAC9B;AAEA,MAAI,QAAQ,OAAO;AACjB,YAAQ,SAAS,OAAO,iBAAiB;AACzC,SAAK,KAAK,QAAQ,KAAK;AAAA,EACzB;AAEA,MAAI,QAAQ,OAAO;AACjB,YAAQ,SAAS,OAAO,iBAAiB;AACzC,SAAK,KAAK,QAAQ,KAAK;AAAA,EACzB;AAEA,QAAM,MAAM,oCAAoC,KAAK;AACrD,OAAK,KAAK,QAAQ,KAAK;AAEvB,QAAM,OAAO,MAAM,IAAI,GAAG,QAAQ,GAAG,EAAE,KAAK,GAAG,IAAI,EAAE,IAAsB;AAC3E,UAAQ,KAAK,WAAW,CAAC,GAAG,IAAI,SAAS;AAC3C;AAzCsB;;;ACpKtB,eAAe,WACb,QACA,KACA,OACA,MACA;AACA,QAAM,OAAO,KAAK,IAAI,OAAO,SAAS;AACtC,QAAM,YAAY,gBAAgB,OAAO,WAAW,MAAM,OAAO;AACjE,QAAM,SAAS,MAAM,kBAAkB,OAAO,WAAW,KAAK,MAAM,OAAO;AAC3E,SAAO;AAAA,IACL,QAAQ,OAAO;AAAA,IACf,WAAW;AAAA,IACX;AAAA,IACA,YAAY,OAAO,cAAc,MAAM,cAAc;AAAA,IACrD,MAAM,MAAM,QAAQ;AAAA,IACpB,QAAQ,OAAO;AAAA,IACf,YAAY,OAAO;AAAA,IACnB,cAAc,OAAO;AAAA,IACrB,WAAW,OAAO;AAAA,IAClB,OAAO,OAAO;AAAA,IACd,cAAc,OAAO;AAAA,IACrB,YAAY,OAAO;AAAA,IACnB,YAAY,OAAO;AAAA,IACnB,YAAY,OAAO;AAAA,EACrB;AACF;AAzBe;AA2Bf,eAAsB,4BAA4B,KAAc,KAAU;AACxE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,MAAM,IAAI;AACzC,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK,EAAE,cAAc,OAAO,GAAG,MAAM,CAAC,EAAE,CAAC;AAAA,EAClD;AAEA,QAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,QAAM,eAAe,mBAA2C,8BAA8B;AAAA,IAC5F,QAAQ,IAAI,aAAa,IAAI,QAAQ,KAAK;AAAA,IAC1C,QAAQ,IAAI,aAAa,IAAI,QAAQ,KAAK;AAAA,IAC1C,SAAS,IAAI,aAAa,IAAI,SAAS,KAAK;AAAA,IAC5C,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,IACxC,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,IACxC,OAAO,IAAI,aAAa,IAAI,OAAO,KAAK;AAAA,EAC1C,CAAC;AACD,MAAI,CAAC,aAAa,SAAS;AACzB,WAAO,wBAAwB,aAAa,MAAM;AAAA,EACpD;AACA,QAAM,SAAS,aAAa;AAE5B,MAAI,OAAO,SAAS,OAAO,OAAO;AAChC,UAAM,UAAU,KAAK,MAAM,OAAO,KAAK;AACvC,UAAM,UAAU,KAAK,MAAM,OAAO,KAAK;AACvC,QAAI,CAAC,OAAO,MAAM,OAAO,KAAK,CAAC,OAAO,MAAM,OAAO,KAAK,UAAU,SAAS;AACzE,aAAO,KAAK,EAAE,OAAO,gBAAgB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACzD;AAAA,EACF;AAEA,MAAI;AACJ,MAAI,OAAO,QAAQ;AACjB,UAAM,WAAW,MAAM,gBAAgB,OAAO,QAAQ,KAAK,MAAM,OAAO;AACxE,QAAI,CAAC,UAAU;AACb,aAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1D;AACA,eAAW;AAAA,EACb;AAEA,MAAI;AACJ,MAAI;AAEJ,MAAI,MAAM,SAAS;AACjB,QAAI,OAAO,QAAS,aAAY,OAAO;AAAA,EACzC,OAAO;AACL,UAAM,kBAAkB,MAAM;AAC9B,QAAI,CAAC,gBAAgB,QAAQ;AAC3B,aAAO,KAAK,EAAE,cAAc,OAAO,GAAG,MAAM,CAAC,EAAE,CAAC;AAAA,IAClD;AACA,QAAI,OAAO,SAAS;AAClB,UAAI,CAAC,gBAAgB,SAAS,OAAO,OAAO,GAAG;AAC7C,eAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MACrD;AACA,mBAAa,CAAC,OAAO,OAAO;AAAA,IAC9B,OAAO;AACL,mBAAa;AAAA,IACf;AAEA,QAAI,UAAU;AACZ,YAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,6DAA6D,EACrE,KAAK,QAAQ,EACb,MAAqC;AACxC,YAAM,gBAAgB,WAAW,cAAc;AAC/C,UAAI,CAAC,iBAAiB,CAAC,gBAAgB,SAAS,aAAa,GAAG;AAC9D,eAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,MACrD;AAAA,IACF;AAAA,EACF;AAEA,QAAM,QAAQ,OAAO,SAAS;AAE9B,QAAM,OAAO,MAAM,sBAAsB,KAAK;AAAA,IAC5C,QAAQ,OAAO,UAAU;AAAA,IACzB,WAAW;AAAA,IACX,YAAY;AAAA,IACZ,aAAa;AAAA,IACb,OAAO,OAAO,SAAS;AAAA,IACvB,OAAO,OAAO,SAAS;AAAA,IACvB;AAAA,EACF,CAAC;AAED,QAAM,OAAO,MAAM,gBAAgB,KAAK,KAAK,IAAI,CAAC,QAAQ,IAAI,SAAS,CAAC;AACxE,QAAM,QAAQ,MAAM,QAAQ,IAAI,KAAK,IAAI,CAAC,QAAQ,WAAW,KAAK,KAAK,OAAO,IAAI,CAAC,CAAC;AAEpF,SAAO,KAAK;AAAA,IACV,cAAc,OAAO;AAAA,IACrB,MAAM;AAAA,EACR,CAAC;AACH;AA1FsB;AA4FtB,eAAsB,6BAA6B,KAAc,KAAU;AACzE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,KAAM,QAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAEjE,QAAM,QAAQ,iBAAiB,MAAM,IAAI;AACzC,MAAI,MAAM,SAAS,CAAC,MAAM,SAAS;AACjC,WAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACrD;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,cAAc,mBAAgD,8BAA8B,OAAO;AACzG,MAAI,CAAC,YAAY,SAAS;AACxB,WAAO,wBAAwB,YAAY,MAAM;AAAA,EACnD;AACA,QAAM,OAAO,YAAY;AAEzB,QAAM,WAAW,MAAM,gBAAgB,KAAK,WAAW,KAAK,MAAM,OAAO;AACzE,MAAI,CAAC,UAAU;AACb,WAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC1D;AAEA,MAAI,KAAK,gBAAgB,KAAK,YAAY;AACxC,UAAM,YAAY,KAAK,MAAM,KAAK,UAAU;AAC5C,UAAM,cAAc,KAAK,MAAM,KAAK,YAAY;AAChD,QAAI,CAAC,OAAO,MAAM,SAAS,KAAK,CAAC,OAAO,MAAM,WAAW,KAAK,cAAc,WAAW;AACrF,aAAO,KAAK,EAAE,OAAO,+BAA+B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACxE;AAAA,EACF;AAEA,MAAI,kBAAkB,KAAK,cAAc;AACzC,MAAI,CAAC,MAAM,SAAS;AAClB,UAAM,kBAAkB,MAAM;AAC9B,UAAM,YAAY,MAAM,IAAI,GACzB,QAAQ,6DAA6D,EACrE,KAAK,QAAQ,EACb,MAAqC;AACxC,QAAI,CAAC,WAAW,cAAc,CAAC,gBAAgB,SAAS,UAAU,UAAU,GAAG;AAC7E,aAAO,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IACrD;AACA,QAAI,mBAAmB,oBAAoB,UAAU,YAAY;AAC/D,aAAO,KAAK,EAAE,OAAO,mBAAmB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC5D;AACA,sBAAkB,UAAU;AAAA,EAC9B;AAEA,QAAM,SAAS,MAAM,uBAAuB,KAAK;AAAA,IAC/C,QAAQ,KAAK;AAAA,IACb,WAAW;AAAA,IACX,YAAY;AAAA,IACZ,QAAQ,KAAK;AAAA,IACb,YAAY,KAAK;AAAA,IACjB,cAAc,KAAK,gBAAgB;AAAA,IACnC,WAAW,KAAK,aAAa;AAAA,IAC7B,OAAO,KAAK,SAAS;AAAA,IACrB,cAAc,KAAK,gBAAgB;AAAA,EACrC,CAAC;AAED,MAAI,CAAC,OAAO,IAAI;AACd,QAAI,OAAO,WAAW,oBAAoB;AACxC,aAAO,KAAK,EAAE,OAAO,iBAAiB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1D;AACA,QAAI,OAAO,WAAW,YAAY;AAChC,aAAO,KAAK,EAAE,OAAO,qBAAqB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC9D;AACA,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,OAAO,MAAM,gBAAgB,KAAK,CAAC,OAAO,IAAI,SAAS,CAAC;AAC9D,QAAM,CAAC,GAAG,IAAI,MAAM,QAAQ,IAAI,CAAC,WAAW,OAAO,KAAK,KAAK,OAAO,IAAI,CAAC,CAAC;AAE1E,SAAO,KAAK,EAAE,IAAI,MAAM,IAAI,GAAG,EAAE,QAAQ,IAAI,CAAC;AAChD;AA7EsB;;;AC9ItB,IAAM,wBAAwB,wBAAC,QAC7B,iBACG,OAAO,EACP,IAAI,GAAG,EACP,SAAS,GAJgB;AAM9B,IAAMC,yBAAwB,wBAAC,QAC7B,iBACG,OAAO,EACP,KAAK,EACL,IAAI,GAAG,EACP,SAAS,GALgB;AAO9B,IAAM,uBAAuB,iBAAE,OAAO,iBAAE,MAAM,CAAC,iBAAE,OAAO,GAAG,iBAAE,OAAO,GAAG,iBAAE,QAAQ,GAAG,iBAAE,KAAK,CAAC,CAAC,CAAC,EAAE,SAAS;AAElG,IAAM,0BAA0B,iBACpC,OAAO;AAAA,EACN,MAAMA,uBAAsB,GAAG;AAAA,EAC/B,SAAS,sBAAsB,IAAI;AAAA,EACnC,OAAO,sBAAsB,IAAI;AAAA,EACjC,gBAAgB,sBAAsB,IAAI;AAAA,EAC1C,WAAW,sBAAsB,IAAI;AAAA,EACrC,KAAK,sBAAsB,IAAI;AAAA,EAC/B,WAAWA,uBAAsB,EAAE;AAAA,EACnC,SAASA,uBAAsB,GAAG;AAAA,EAClC,MAAM;AAAA,EACN,QAAQ,iBAAE,QAAQ,EAAE,SAAS;AAC/B,CAAC,EACA,OAAO;AAAA,EACN,MAAM,iBACH,OAAO;AAAA,IACN,OAAOA,uBAAsB,GAAG;AAAA,IAChC,OAAO,iBAAE,MAAMA,uBAAsB,GAAG,CAAC,EAAE,SAAS;AAAA,IACpD,WAAW,iBAAE,MAAMA,uBAAsB,GAAG,CAAC,EAAE,SAAS;AAAA,EAC1D,CAAC,EACA,SAAS;AACd,CAAC,EACA,YAAY;;;AC/Bf,IAAM,aAAa;AACnB,IAAM,4BAA4B;AAClC,IAAM,kBAAkB;AACxB,IAAM,4BAA4B;AAClC,IAAM,oBAAoB;AAC1B,IAAM,mBAAmB;AACzB,IAAMC,WAAU,IAAI,YAAY;AAEhC,eAAsB,wBAAwB,KAAc,KAAU;AACpE,QAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,MAAI,CAAC,MAAM;AACT,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,MAAI,UAAU;AACd,MAAI;AACF,cAAU,MAAM,IAAI,KAAK;AAAA,EAC3B,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,WAAW,uBAAuB,GAAG;AAC3C,MAAIA,SAAQ,OAAO,OAAO,EAAE,SAAS,UAAU;AAC7C,WAAO,KAAK,EAAE,OAAO,oBAAoB,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EAC7D;AAEA,MAAI;AACJ,MAAI;AACF,cAAU,UAAU,KAAK,MAAM,OAAO,IAAI,CAAC;AAAA,EAC7C,QAAQ;AACN,WAAO,KAAK,EAAE,OAAO,eAAe,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACxD;AAEA,QAAM,SAAS,mBAAsC,yBAAyB,OAAO;AACrF,MAAI,CAAC,OAAO,SAAS;AACnB,WAAO,wBAAwB,OAAO,MAAM;AAAA,EAC9C;AAEA,QAAM,OAAO,OAAO;AACpB,QAAM,MAAM,iBAAiB,KAAK,EAAE,OAAO,WAAW,CAAC;AAEvD,QAAM,YAAY,0BAA0B,IAAI;AAEhD,QAAM,cAAc;AAAA,IAClB,OAAO,KAAK;AAAA,IACZ,OAAO,KAAK;AAAA,IACZ,YAAY,KAAK;AAAA,EACnB;AAEA,QAAM,aAAsC;AAAA,IAC1C,QAAQ;AAAA,IACR,QAAQ,UAAU;AAAA,IAClB,MAAM;AAAA,EACR;AAEA,MAAI,UAAU,gBAAgB,QAAQ;AACpC,eAAW,mBAAmB,UAAU;AAAA,EAC1C;AAEA,MAAI,MAAM,qBAAqB,UAAU;AAEzC,SAAO,KAAK,EAAE,IAAI,KAAK,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC3C;AAtDsB;AAwDtB,SAAS,uBAAuB,KAAkB;AAChD,QAAM,MAAM,IAAI,yBAAyB,KAAK;AAC9C,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,SAAS,OAAO,GAAG;AACzB,SAAO,OAAO,SAAS,MAAM,KAAK,SAAS,IAAI,KAAK,MAAM,MAAM,IAAI;AACtE;AALS;AAOT,SAAS,0BAA0B,MAAyB;AAC1D,QAAM,kBAA4B,CAAC;AAEnC,QAAM,SAAS;AAAA,IACb,MAAM,KAAK,QAAQ;AAAA,IACnB,SAAS,eAAe,KAAK,SAAS,mBAAmB,iBAAiB,SAAS;AAAA,IACnF,OAAO,eAAe,KAAK,OAAO,iBAAiB,iBAAiB,OAAO;AAAA,IAC3E,iBAAiB;AAAA,MACf,KAAK;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,IACA,YAAY,KAAK,aAAa;AAAA,IAC9B,KAAK,KAAK,OAAO;AAAA,IACjB,WAAW,KAAK,cAAa,oBAAI,KAAK,GAAE,YAAY;AAAA,IACpD,SAAS,KAAK,WAAW;AAAA,IACzB,MAAM,KAAK,QAAQ;AAAA,IACnB,QAAQ,eAAe,KAAK,QAAQ,eAAe;AAAA,IACnD,eAAe,KAAK,QAAQ;AAAA,EAC9B;AAEA,SAAO,EAAE,QAAQ,gBAAgB;AACnC;AAvBS;AAyBT,SAAS,eACP,OACA,WACA,iBACA,WACe;AACf,MAAI,OAAO,UAAU,SAAU,QAAO,SAAS;AAC/C,MAAI,MAAM,UAAU,UAAW,QAAO;AACtC,kBAAgB,KAAK,SAAS;AAC9B,SAAO,GAAG,MAAM,MAAM,GAAG,SAAS,CAAC;AACrC;AAVS;AAYT,SAAS,eAAe,QAAiB,iBAA2B;AAClE,MAAI,WAAW,OAAW,QAAO;AACjC,MAAI,WAAW,KAAM,QAAO;AAC5B,MAAI;AACF,UAAM,aAAa,KAAK,UAAU,MAAM;AACxC,QAAIA,SAAQ,OAAO,UAAU,EAAE,UAAU,kBAAkB;AACzD,aAAO;AAAA,IACT;AACA,oBAAgB,KAAK,QAAQ;AAC7B,WAAO;AAAA,MACL,WAAW;AAAA,MACX,OAAOA,SAAQ,OAAO,UAAU,EAAE;AAAA,MAClC,MAAM,0BAA0B,gBAAgB;AAAA,IAClD;AAAA,EACF,QAAQ;AACN,oBAAgB,KAAK,QAAQ;AAC7B,WAAO;AAAA,MACL,WAAW;AAAA,MACX,MAAM;AAAA,IACR;AAAA,EACF;AACF;AArBS;;;AC9ET,IAAM,SAAoB,EAAO;AAEjC,OAAO,IAAI,WAAW,MAAM,aAAa,CAAC;AAE1C,sBAAsB,MAAM;AAC5B,qBAAqB,QAAQ,SAAS;AACtC,wBAAwB,MAAM;AAC9B,oBAAoB,MAAM;AAE1B,OACG,IAAI,WAAW,WAAW,CAAC,KAAK,QAAQ,SAAS,KAAK,GAAG,CAAC,CAAC,EAC3D,IAAI,sBAAsB,WAAW,CAAC,KAAK,QAAQ,mBAAmB,KAAK,GAAG,CAAC,CAAC,EAChF;AAAA,EACC;AAAA,EACA,WAAW,CAAC,KAAK,QAAQ,yBAAyB,KAAK,GAAG,CAAC;AAC7D,EACC,IAAI,uBAAuB,WAAW,CAAC,KAAK,QAAQ,oBAAoB,KAAK,GAAG,CAAC,CAAC,EAClF,IAAI,eAAe,WAAW,CAAC,KAAK,QAAQ,uBAAuB,KAAK,GAAG,CAAC,CAAC,EAC7E,KAAK,eAAe,WAAW,CAAC,KAAK,QAAQ,wBAAwB,KAAK,GAAG,CAAC,CAAC,EAC/E;AAAA,EACC;AAAA,EACA;AAAA,IACE,UAAU,MAAM,CAAC,KAAK,KAAK,YAAY,wBAAwB,KAAK,KAAK,OAAO,CAAC;AAAA,EACnF;AACF,EACC;AAAA,EACC;AAAA,EACA;AAAA,IACE,UAAU,MAAM,CAAC,KAAK,KAAK,YAAY,yBAAyB,KAAK,KAAK,OAAO,CAAC;AAAA,EACpF;AACF,EACC,IAAI,sBAAsB,WAAW,CAAC,KAAK,QAAQ,iBAAiB,KAAK,GAAG,CAAC,CAAC,EAC9E,IAAI,gCAAgC,WAAW,CAAC,KAAK,QAAQ,oBAAoB,KAAK,GAAG,CAAC,CAAC,EAC3F,IAAI,2BAA2B,WAAW,CAAC,KAAK,QAAQ,4BAA4B,KAAK,GAAG,CAAC,CAAC,EAC9F,KAAK,2BAA2B,WAAW,CAAC,KAAK,QAAQ,6BAA6B,KAAK,GAAG,CAAC,CAAC,EAChG,IAAI,wBAAwB,WAAW,CAAC,KAAK,QAAQ,cAAc,KAAK,GAAG,CAAC,CAAC,EAC7E;AAAA,EACC;AAAA,EACA,WAAW,CAAC,KAAK,QAAQ,wBAAwB,KAAK,GAAG,CAAC;AAC5D,EACC;AAAA,EACC;AAAA,EACA,UAAU,WAAW,CAAC,KAAK,KAAK,YAAY,aAAa,KAAK,KAAK,OAAO,CAAC;AAC7E,EACC;AAAA,EACC;AAAA,EACA,UAAU,WAAW,CAAC,KAAK,KAAK,YAAY,gBAAgB,KAAK,KAAK,OAAO,CAAC;AAChF;AAEF,OAAO,IAAI,KAAK,MAAM,KAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC,CAAC;AAE5D,SAAS,cAAc,KAAc,KAAU,KAAwB;AAC5E,QAAM,QAAQ,KAAK,IAAI;AACvB,2BAAyB,GAAG;AAC5B,QAAM,SAAS,kBAAkB,KAAK,GAAG;AACzC,SAAO,MAAM,kBAAkB;AAC/B,QAAM,WAAWC,UAAS,IAAI,GAAG;AACjC,MAAI,aAA4B;AAChC,SAAO,QAAQ,QAAQ,OAAO,MAAM,KAAK,KAAK,GAAG,CAAC,EAC/C,KAAK,CAAC,QAAQ;AACb,iBAAa,KAAK,UAAU;AAC5B,WAAO,KAAK,qBAAqB;AAAA,MAC/B,QAAQ;AAAA,MACR,aAAa,KAAK,IAAI,IAAI;AAAA,IAC5B,CAAC;AACD,WAAO;AAAA,EACT,CAAC,EACA,MAAM,CAAC,QAAQ;AACd,iBAAa;AACb,qBAAiB,GAAG,EAAE,MAAM,kBAAkB;AAAA,MAC5C,aAAa,KAAK,IAAI,IAAI;AAAA,MAC1B,OAAO;AAAA,IACT,CAAC;AACD,UAAM;AAAA,EACR,CAAC,EACA,QAAQ,YAAY;AACnB,QAAI;AACF,UAAI,CAAC,uBAAuB,GAAG,GAAG;AAChC,cAAM,QAAQ,eAAe,QAAQ;AACrC,cAAM,gBAAgB,KAAK,OAAO,cAAc,GAAG,KAAK,IAAI,IAAI,OAAO,MAAM,MAAM;AAAA,MACrF;AAAA,IACF,SAAS,OAAO;AACd,aAAO,KAAK,0BAA0B,EAAE,MAAM,CAAC;AAAA,IACjD,UAAE;AACA,2BAAqB,GAAG;AAAA,IAC1B;AAAA,EACF,CAAC;AACL;AApCgB;AAsChB,SAASA,UAAS,KAAqB;AACrC,MAAI;AACF,WAAO,IAAI,IAAI,GAAG,EAAE;AAAA,EACtB,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AANS,OAAAA,WAAA;AAQT,SAAS,eAAe,UAA0B;AAChD,MAAI,SAAS,WAAW,cAAc,EAAG,QAAO;AAChD,MAAI,SAAS,WAAW,iBAAiB,EAAG,QAAO;AACnD,MAAI,SAAS,WAAW,cAAc,KAAK,SAAS,MAAM,GAAG,EAAE,WAAW,GAAG;AAC3E,WAAO;AAAA,EACT;AACA,MAAI,SAAS,WAAW,yBAAyB,GAAG;AAClD,WAAO;AAAA,EACT;AACA,SAAO;AACT;AAVS;;;ACrIT,IAAM,qBAAqB;AAC3B,IAAM,kBAAkB;AACxB,IAAM,2BAA2B,oBAAI,IAAI,CAAC,SAAS,QAAQ,CAAC;AAE5D,IAAM,8BAAN,cAA0C,MAAM;AAAA,EANhD,OAMgD;AAAA;AAAA;AAAA,EACrC;AAAA,EAET,YAAY,QAAgB;AAC1B,UAAM,kCAAkC,MAAM,EAAE;AAChD,SAAK,OAAO;AACZ,SAAK,SAAS,OAAO,YAAY;AAAA,EACnC;AACF;AAUA,SAAS,eAAe,KAA8B;AACpD,QAAM,UAAU,IAAI,KAAK;AACzB,MAAI,CAAC,SAAS;AACZ,UAAMC,OAAM,IAAI,IAAI,KAAK,kBAAkB;AAC3C,WAAO,EAAE,KAAAA,MAAK,MAAM,iBAAiB,UAAU,QAAQ;AAAA,EACzD;AACA,MAAI,QAAQ,WAAW,IAAI,GAAG;AAC5B,UAAMA,OAAM,IAAI,IAAI,SAAS,OAAO,EAAE;AACtC,WAAO,EAAE,KAAAA,MAAK,MAAM,qBAAqB,UAAU,QAAQ;AAAA,EAC7D;AACA,MAAI,gBAAgB,KAAK,OAAO,GAAG;AACjC,UAAM,SAAS,QAAQ,MAAM,GAAG,QAAQ,QAAQ,GAAG,IAAI,CAAC,EAAE,YAAY;AACtE,QAAI,CAAC,yBAAyB,IAAI,MAAM,GAAG;AACzC,YAAM,IAAI,4BAA4B,MAAM;AAAA,IAC9C;AACA,UAAMA,OAAM,IAAI,IAAI,OAAO;AAC3B,WAAO,EAAE,KAAAA,MAAK,MAAM,YAAY,UAAU,QAAQ;AAAA,EACpD;AACA,QAAM,MAAM,IAAI,IAAI,SAAS,kBAAkB;AAC/C,QAAM,OAAsB,QAAQ,WAAW,GAAG,IAAI,kBAAkB;AACxE,SAAO,EAAE,KAAK,MAAM,UAAU,QAAQ;AACxC;AArBS;AAuBT,SAAS,oBAAoB,KAAgB;AAC3C,MAAI,CAAC,IAAI,SAAS,SAAS,GAAG,GAAG;AAC/B,QAAI,WAAW,GAAG,IAAI,QAAQ;AAAA,EAChC;AACF;AAJS;AAMT,SAAS,kBAAkB,QAAiC;AAC1D,QAAM,EAAE,KAAK,KAAK,IAAI;AACtB,QAAM,SAAS,GAAG,IAAI,QAAQ,GAAG,IAAI,MAAM,GAAG,IAAI,IAAI;AACtD,UAAQ,MAAM;AAAA,IACZ,KAAK;AACH,aAAO,IAAI,SAAS;AAAA,IACtB,KAAK;AACH,aAAO,KAAK,IAAI,IAAI,GAAG,MAAM;AAAA,IAC/B,KAAK;AACH,aAAO;AAAA,IACT,KAAK,YAAY;AACf,aAAO,OAAO,WAAW,GAAG,IAAI,OAAO,MAAM,CAAC,IAAI;AAAA,IACpD;AAAA,IACA;AACE,aAAO;AAAA,EACX;AACF;AAhBS;AAkBT,SAAS,YAAY,OAA+D;AAClF,QAAM,QAAQ,MAAM,MAAM,4BAA4B;AACtD,SAAO;AAAA,IACL,MAAM,QAAQ,CAAC,KAAK;AAAA,IACpB,QAAQ,QAAQ,CAAC,KAAK;AAAA,IACtB,MAAM,QAAQ,CAAC,KAAK;AAAA,EACtB;AACF;AAPS;AAST,SAAS,oBAAoB,YAAoB,cAA8B;AAC7E,QAAM,SAAS,IAAI,gBAAgB;AACnC,MAAI,cAAc;AAChB,UAAM,eAAe,IAAI,gBAAgB,aAAa,MAAM,CAAC,CAAC;AAC9D,iBAAa,QAAQ,CAAC,OAAO,QAAQ;AACnC,aAAO,OAAO,KAAK,KAAK;AAAA,IAC1B,CAAC;AAAA,EACH;AACA,MAAI,YAAY;AACd,UAAM,aAAa,IAAI,gBAAgB,WAAW,MAAM,CAAC,CAAC;AAC1D,eAAW,QAAQ,CAAC,OAAO,QAAQ;AACjC,aAAO,OAAO,KAAK,KAAK;AAAA,IAC1B,CAAC;AAAA,EACH;AACA,QAAM,WAAW,OAAO,SAAS;AACjC,SAAO,WAAW,IAAI,QAAQ,KAAK;AACrC;AAhBS;AAkBT,SAAS,0BAA0B,OAAuB;AACxD,QAAM,UAAU,MAAM,KAAK;AAC3B,MAAI,CAAC,QAAS,QAAO;AACrB,QAAM,QAAQ,QAAQ,MAAM,qBAAqB;AACjD,MAAI,CAAC,MAAO,QAAO,QAAQ,SAAS,GAAG,IAAI,UAAU,GAAG,OAAO;AAC/D,MAAI,OAAO,MAAM,CAAC,KAAK;AACvB,QAAM,SAAS,MAAM,CAAC,KAAK;AAC3B,MAAI,CAAC,KAAK,SAAS,GAAG,GAAG;AACvB,WAAO,OAAO,GAAG,IAAI,MAAM;AAAA,EAC7B;AACA,SAAO,GAAG,IAAI,GAAG,MAAM;AACzB;AAXS;AAaT,SAAS,aAAa,MAAc,QAAwB;AAC1D,QAAM,YAAY,KAAK,MAAM,4BAA4B;AACzD,MAAI,CAAC,UAAW,QAAO,KAAK,SAAS,GAAG,IAAI,GAAG,IAAI,GAAG,MAAM,KAAK,GAAG,IAAI,IAAI,MAAM;AAClF,MAAI,WAAW,UAAU,CAAC,KAAK;AAC/B,QAAM,aAAa,UAAU,CAAC,KAAK;AACnC,QAAM,WAAW,UAAU,CAAC,KAAK;AACjC,MAAI,CAAC,SAAS,SAAS,GAAG,GAAG;AAC3B,eAAW,WAAW,GAAG,QAAQ,MAAM;AAAA,EACzC;AACA,QAAM,cAAc,YAAY,MAAM;AACtC,QAAM,eAAe,GAAG,QAAQ,GAAG,YAAY,IAAI;AACnD,QAAM,iBAAiB,oBAAoB,YAAY,YAAY,MAAM;AACzE,QAAM,eAAe,YAAY,QAAQ;AACzC,SAAO,GAAG,YAAY,GAAG,cAAc,GAAG,YAAY;AACxD;AAdS;AAgBF,SAAS,mBAAmB,OAA2B,UAA0B;AACtF,QAAM,YAAY,OAAO,KAAK,GAAG,SAAS,MAAM,KAAK,IAAI;AACzD,MAAI;AACF,UAAM,SAAS,eAAe,SAAS;AACvC,wBAAoB,OAAO,GAAG;AAC9B,WAAO,kBAAkB,MAAM;AAAA,EACjC,SAAS,KAAK;AACZ,QAAI,eAAe,+BAA+B,cAAc,UAAU;AACxE,mBAAa,EAAE,OAAO,aAAa,CAAC,EAAE,KAAK,6BAA6B;AAAA,QACtE,OAAO;AAAA,QACP;AAAA,QACA,QAAQ,IAAI;AAAA,MACd,CAAC;AAAA,IACH;AACA,QAAI,cAAc,UAAU;AAC1B,aAAO,mBAAmB,QAAW,QAAQ;AAAA,IAC/C;AACA,WAAO,0BAA0B,SAAS;AAAA,EAC5C;AACF;AAnBgB;AAqBT,SAAS,gBAAgB,WAAmB,QAAwB;AACzE,QAAM,cAAc,UAAU,KAAK;AACnC,MAAI,CAAC,aAAa;AAChB,WAAO;AAAA,EACT;AACA,MAAI;AACF,UAAM,SAAS,eAAe,WAAW;AACzC,wBAAoB,OAAO,GAAG;AAC9B,UAAM,iBAAiB,OAAO,IAAI;AAClC,UAAM,eAAe,OAAO,IAAI;AAChC,UAAM,cAAc,YAAY,MAAM;AACtC,WAAO,IAAI,WAAW,GAAG,OAAO,IAAI,QAAQ,GAAG,YAAY,IAAI;AAC/D,UAAM,iBAAiB,oBAAoB,gBAAgB,YAAY,MAAM;AAC7E,WAAO,IAAI,SAAS,iBAAiB,eAAe,MAAM,CAAC,IAAI;AAC/D,UAAM,YAAY,YAAY,QAAQ;AACtC,WAAO,IAAI,OAAO,YAAY,UAAU,MAAM,CAAC,IAAI;AACnD,WAAO,kBAAkB,MAAM;AAAA,EACjC,QAAQ;AACN,WAAO,aAAa,aAAa,MAAM;AAAA,EACzC;AACF;AApBgB;;;AC1IT,IAAM,qBAAuE;AAAA,EAClF,SAAS;AAAA,EACT,WAAW;AACb;AAEA,IAAM,uBAAuB;AAC7B,IAAM,8BAAsD;AAAA,EAC1D,KAAK;AAAA,EACL,KAAK;AAAA,EACL,KAAK;AAAA,EACL,UAAU;AAAA,EACV,UAAU;AACZ;AACA,IAAMC,2BAA0B;AAChC,IAAM,sBAAsB;AAC5B,IAAM,yBAAyB;AAE/B,SAAS,gBAAgB,UAA0B;AACjD,MAAI,CAAC,YAAY,aAAa,KAAK;AACjC,WAAO;AAAA,EACT;AACA,QAAM,YAAY,SAAS,QAAQ,WAAW,GAAG;AACjD,MAAI,UAAU,SAAS,GAAG,GAAG;AAC3B,WAAO,UAAU,QAAQ,QAAQ,GAAG;AAAA,EACtC;AACA,SAAO;AACT;AATS;AAWT,SAAS,iBAAiB,OAA2B,UAA0B;AAC7E,QAAM,UAAU,OAAO,KAAK,KAAK;AACjC,MAAI,CAAC,SAAS;AACZ,WAAO;AAAA,EACT;AAEA,QAAM,YAAYA,yBAAwB,KAAK,OAAO;AACtD,MAAI,aAAa,CAAC,oBAAoB,KAAK,OAAO,GAAG;AACnD,iBAAa,EAAE,OAAO,aAAa,CAAC,EAAE,KAAK,2BAA2B;AAAA,MACpE,OAAO;AAAA,MACP;AAAA,IACF,CAAC;AACD,WAAO;AAAA,EACT;AAEA,MAAI;AACF,UAAM,iBAAiB,QAAQ,WAAW,GAAG;AAC7C,UAAM,MAAM,YAAY,IAAI,IAAI,OAAO,IAAI,IAAI,IAAI,SAAS,sBAAsB;AAClF,QAAI,WAAW,gBAAgB,IAAI,QAAQ;AAC3C,UAAM,aAAa,IAAI,SAAS;AAChC,QAAI,WAAW;AACb,aAAO;AAAA,IACT;AACA,UAAM,qBAAqB,WAAW,QAAQ,wBAAwB,EAAE;AACxE,QAAI,gBAAgB;AAClB,aAAO;AAAA,IACT;AACA,WAAO,mBAAmB,WAAW,GAAG,IAAI,mBAAmB,MAAM,CAAC,IAAI;AAAA,EAC5E,SAAS,OAAO;AACd,iBAAa,EAAE,OAAO,aAAa,CAAC,EAAE,KAAK,iCAAiC;AAAA,MAC1E,OAAO;AAAA,MACP;AAAA,MACA;AAAA,IACF,CAAC;AACD,WAAO;AAAA,EACT;AACF;AApCS;AAsCF,SAAS,iBAAiB,KAA6B;AAC5D,SAAO;AAAA,IACL,SAAS,iBAAiB,IAAI,cAAc,mBAAmB,OAAO;AAAA,IACtE,WAAW,mBAAmB,IAAI,gBAAgB,mBAAmB,SAAS;AAAA,IAC9E,eAAe,IAAI;AAAA,EACrB;AACF;AANgB;AAQT,SAAS,mBAAmB,QAAmC;AACpE,QAAMC,QAAO,KAAK,UAAU,MAAM;AAClC,SAAOA,MAAK,QAAQ,sBAAsB,CAAC,SAAS,4BAA4B,IAAI,KAAK,IAAI;AAC/F;AAHgB;;;AChFhB,IAAM,uBAA2D;AAAA,EAC/D;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,IAAM,oBAAoB,oBAAI,IAAI,CAAC,SAAS,QAAQ,CAAC;AAErD,SAAS,cAAc,OAAsC;AAC3D,MAAI,CAAC,MAAO,QAAO;AACnB,QAAM,UAAU,MAAM,KAAK;AAC3B,MAAI,CAAC,QAAS,QAAO;AACrB,MAAI;AACF,UAAM,MAAM,IAAI,IAAI,OAAO;AAC3B,QAAI,kBAAkB,IAAI,IAAI,QAAQ,GAAG;AACvC,aAAO,IAAI;AAAA,IACb;AAAA,EACF,QAAQ;AAAA,EAER;AACA,SAAO;AACT;AAbS;AAeT,SAAS,UAAU,MAAiB,OAAwC;AAC1E,MAAI,CAAC,QAAQ,CAAC,MAAO,QAAO;AAC5B,QAAM,WAAW,CAAC,GAAI,QAAQ,CAAC,CAAE;AACjC,MAAI,OAAO;AACT,eAAW,SAAS,OAAO;AACzB,UAAI,CAAC,SAAS,SAAS,KAAK,GAAG;AAC7B,iBAAS,KAAK,KAAK;AAAA,MACrB;AAAA,IACF;AAAA,EACF;AACA,SAAO,SAAS,SAAS,WAAW;AACtC;AAXS;AAaT,SAAS,aAAa,QAAsD;AAC1E,QAAMC,SAA+B,CAAC;AACtC,aAAW,OAAO,sBAAsB;AACtC,UAAM,OAAO,OAAO,GAAG;AACvB,QAAI,QAAQ,KAAK,QAAQ;AACvB,MAAAA,OAAM,GAAG,IAAI,CAAC,GAAG,IAAI;AAAA,IACvB;AAAA,EACF;AACA,SAAOA;AACT;AATS;AAWF,SAAS,0BAA0B,KAAiC;AACzE,QAAM,SAAS,iBAAiB,GAAG;AACnC,QAAM,YAAY,cAAc,OAAO,OAAO;AAC9C,QAAM,cAAc,cAAc,OAAO,SAAS;AAElD,QAAM,OAA8B,CAAC;AAErC,QAAM,iBAA2B,CAAC;AAClC,MAAI,UAAW,gBAAe,KAAK,SAAS;AAC5C,MAAI,YAAa,gBAAe,KAAK,WAAW;AAChD,MAAI,eAAe,QAAQ;AACzB,SAAK,aAAa;AAAA,EACpB;AAEA,MAAI,aAAa;AACf,SAAK,YAAY,CAAC,WAAW;AAC7B,SAAK,SAAS,CAAC,WAAW;AAC1B,SAAK,WAAW,CAAC,WAAW;AAC5B,SAAK,UAAU,CAAC,WAAW;AAAA,EAC7B;AAEA,SAAO;AACT;AAtBgB;AAwBT,SAAS,2BACd,MACA,WACuB;AACvB,MAAI,CAAC,WAAW;AACd,WAAO,aAAa,IAAI;AAAA,EAC1B;AAEA,QAAM,SAAgC,CAAC;AAEvC,aAAW,OAAO,sBAAsB;AACtC,UAAM,WAAW,UAAU,KAAK,GAAG,GAAG,UAAU,GAAG,CAAC;AACpD,QAAI,YAAY,SAAS,QAAQ;AAC/B,aAAO,GAAG,IAAI;AAAA,IAChB;AAAA,EACF;AAEA,SAAO;AACT;AAlBgB;;;AC/EhB,IAAMC,gBAAe,oBAAI,IAAI,CAAC,SAAS,QAAQ,CAAC;AAChD,IAAMC,mBAAkB;AAExB,SAASC,oBAAmB,WAA4B;AACtD,SAAO,UAAU,WAAW,GAAG,KAAK,CAAC,UAAU,WAAW,IAAI;AAChE;AAFS,OAAAA,qBAAA;AAIT,SAAS,sBAAsB,KAAU,eAAoC;AAC3E,QAAM,UAAU,oBAAI,IAAY,CAAC,aAAa,CAAC;AAC/C,MAAI;AACF,UAAM,SAAS,IAAI,IAAI,IAAI,YAAY;AACvC,YAAQ,IAAI,OAAO,MAAM;AAAA,EAC3B,QAAQ;AAAA,EAER;AACA,MAAI,IAAI,gBAAgB;AACtB,QAAI;AACF,YAAM,cAAc,IAAI,IAAI,IAAI,gBAAgB,aAAa;AAC7D,cAAQ,IAAI,YAAY,MAAM;AAAA,IAChC,QAAQ;AAAA,IAER;AAAA,EACF;AACA,SAAO;AACT;AAjBS;AAmBF,SAAS,oBAAoB,KAAoB,KAAU,YAAyB;AACzF,QAAM,WAAW,IAAI,kBAAkB;AACvC,QAAM,YAAY,KAAK,KAAK;AAC5B,MAAI,CAAC,UAAW,QAAO;AAEvB,MAAIA,oBAAmB,SAAS,GAAG;AACjC,WAAO;AAAA,EACT;AACA,MAAI,UAAU,WAAW,IAAI,GAAG;AAC9B,WAAO;AAAA,EACT;AAEA,MAAI;AACF,UAAM,SAAS,IAAI,IAAI,WAAW,WAAW,MAAM;AACnD,QAAI,CAACF,cAAa,IAAI,OAAO,QAAQ,GAAG;AACtC,aAAO;AAAA,IACT;AACA,UAAM,iBAAiB,sBAAsB,KAAK,WAAW,MAAM;AACnE,QAAI,CAAC,eAAe,IAAI,OAAO,MAAM,GAAG;AACtC,aAAO;AAAA,IACT;AAEA,QAAIC,iBAAgB,KAAK,SAAS,GAAG;AACnC,aAAO,OAAO,SAAS;AAAA,IACzB;AAEA,WAAO,GAAG,OAAO,QAAQ,GAAG,OAAO,MAAM,GAAG,OAAO,IAAI;AAAA,EACzD,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AA9BgB;;;ACbhB,IAAME,QAAO;AAEb,SAAS,WAAW,MAAM,eAAe;AACvC,SAAOA,MAAK,EAAE,OAAO,IAAI,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC7C;AAFS;AAIT,SAAS,aAAa,MAAM,gBAAgB;AAC1C,SAAOA,MAAK,EAAE,OAAO,IAAI,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC7C;AAFS;AAIT,SAAS,UAAU,MAAM,aAAa;AACpC,SAAOA,MAAK,EAAE,OAAO,IAAI,GAAG,EAAE,QAAQ,IAAI,CAAC;AAC7C;AAFS;AAIT,SAAS,WAAW;AAClB,SAAOA,MAAK,EAAE,OAAO,YAAY,GAAG,EAAE,QAAQ,IAAI,CAAC;AACrD;AAFS;AAIT,SAAS,aAAa,UAA0B;AAC9C,MAAI,MAAM,SAAS,QAAQ,QAAQ,EAAE;AACrC,MAAI,CAAC,IAAK,OAAM,IAAI,MAAM,WAAW;AACrC,MAAI,IAAI,MAAM,GAAG,EAAE,KAAK,CAAC,YAAY,YAAY,IAAI,GAAG;AACtD,UAAM,IAAI,MAAM,aAAa;AAAA,EAC/B;AACA,SAAO;AACT;AAPS;AAST,SAAS,qBAAqB,KAA2B;AACvD,QAAM,MAAM,IAAI,kBAAkB,KAAK;AACvC,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,WAAW,oBAAI,IAAY;AACjC,aAAW,SAAS,IAAI,MAAM,GAAG,EAAE,IAAI,CAAC,SAAS,KAAK,KAAK,CAAC,EAAE,OAAO,OAAO,GAAG;AAC7E,UAAM,aAAa,MAAM,QAAQ,QAAQ,EAAE,EAAE,QAAQ,QAAQ,EAAE;AAC/D,QAAI,CAAC,YAAY;AAEf,aAAO;AAAA,IACT;AACA,aAAS,IAAI,GAAG,UAAU,GAAG;AAAA,EAC/B;AACA,SAAO,SAAS,OAAO,CAAC,GAAG,QAAQ,IAAI;AACzC;AAbS;AAeT,SAAS,sBAAsB,KAAa,UAA2B;AACrE,SAAO,CAAC,YAAY,SAAS,KAAK,CAAC,WAAW,IAAI,WAAW,MAAM,CAAC;AACtE;AAFS;AAIT,IAAMC,aAAY,oBAAI,IAAmD;AACzE,SAASC,SAAQ,KAAU;AACzB,QAAM,MAAM,IAAI;AAChB,MAAI,CAACD,WAAU,IAAI,GAAG,GAAG;AACvB,IAAAA,WAAU,IAAI,KAAK,mBAAmB,IAAI,IAAI,GAAG,CAAC,CAAC;AAAA,EACrD;AACA,SAAOA,WAAU,IAAI,GAAG;AAC1B;AANS,OAAAC,UAAA;AAQT,eAAe,cAAc,KAAc,KAAsC;AAC/E,QAAM,MAAM,IAAI,QAAQ,IAAI,yBAAyB;AACrD,MAAI,CAAC,IAAK,QAAO;AACjB,MAAI;AACF,UAAM,EAAE,QAAQ,IAAI,MAAM,UAAU,KAAKA,SAAQ,GAAG,GAAG,EAAE,UAAU,IAAI,WAAW,CAAC;AACnF,WAAO;AAAA,EACT,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AATe;AAWf,SAAS,SAAS;AAChB,SAAO,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AACrC;AAFS;AAIT,SAAS,IAAI,KAA0B;AACrC,SAAO,CAAC,GAAG,IAAI,WAAW,GAAG,CAAC,EAAE,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AACrF;AAFS;AAIT,SAAS,OAAO,GAAW,GAAoB;AAC7C,MAAI,EAAE,WAAW,EAAE,OAAQ,QAAO;AAClC,MAAI,OAAO;AACX,WAAS,IAAI,GAAG,IAAI,EAAE,QAAQ,KAAK;AACjC,YAAQ,EAAE,WAAW,CAAC,IAAI,EAAE,WAAW,CAAC;AAAA,EAC1C;AACA,SAAO,SAAS;AAClB;AAPS;AAUT,eAAe,gBAAgB,KAAU,QAAgB,KAA4B;AACnF,QAAM,SAAS,IAAI;AACnB,MAAI,CAAC,OAAQ,QAAO;AACpB,QAAM,MAAM,OAAO,IAAI,aAAa,IAAI,KAAK,CAAC;AAC9C,QAAM,MAAM,IAAI,aAAa,IAAI,KAAK,KAAK;AAC3C,MAAI,CAAC,OAAO,SAAS,GAAG,KAAK,MAAM,OAAO,EAAG,QAAO;AAEpD,MAAI;AACJ,MAAI;AACF,UAAM,aAAa,IAAI,QAAQ;AAAA,EACjC,QAAQ;AACN,WAAO;AAAA,EACT;AAEA,QAAM,MAAM,GAAG,OAAO,YAAY,CAAC;AAAA,EAAK,GAAG;AAAA,EAAK,GAAG;AACnD,QAAMC,WAAU,IAAI,YAAY;AAChC,QAAM,YAAY,MAAM,OAAO,OAAO;AAAA,IACpC;AAAA,IACAA,SAAQ,OAAO,MAAM;AAAA,IACrB,EAAE,MAAM,QAAQ,MAAM,UAAU;AAAA,IAChC;AAAA,IACA,CAAC,MAAM;AAAA,EACT;AACA,QAAM,MAAM,MAAM,OAAO,OAAO,KAAK,QAAQ,WAAWA,SAAQ,OAAO,GAAG,CAAC;AAC3E,QAAM,WAAW,IAAI,GAAG;AACxB,SAAO,OAAO,UAAU,GAAG;AAC7B;AA1Be;AA4Bf,SAASC,UAAS,KAAe;AAC/B,QAAM,UAAU,IAAI,QAAQ,IAAI,OAAO;AAEvC,UAAQ,IAAI,+BAA+B,GAAG;AAC9C,UAAQ,IAAI,QAAQ,QAAQ;AAC5B,SAAO;AAAA,IACL,IAAI,SAAS,IAAI,MAAM;AAAA,MACrB;AAAA,MACA,QAAQ,IAAI;AAAA,MACZ,YAAY,IAAI;AAAA,IAClB,CAAC;AAAA,EACH;AACF;AAZS,OAAAA,WAAA;AAcT,SAAS,oBAAoB,UAAe,QAAwC;AAClF,MAAI,CAAC,OAAQ,QAAO,IAAI,IAAI,QAAQ;AACpC,QAAM,aAAa,OAAO,SAAS,GAAG,KAAK,WAAW,MAAM,OAAO,MAAM,GAAG,EAAE,IAAI;AAClF,MAAI,CAAC,WAAW,WAAW,GAAG,GAAG;AAC/B,UAAM,IAAI,MAAM,oCAAoC,MAAM,EAAE;AAAA,EAC9D;AACA,QAAM,OAAO,SAAS;AACtB,MAAI,SAAS,YAAY;AACvB,UAAMC,SAAQ,IAAI,IAAI,QAAQ;AAC9B,IAAAA,OAAM,WAAW;AACjB,WAAOA;AAAA,EACT;AACA,MAAI,KAAK,WAAW,GAAG,UAAU,GAAG,GAAG;AACrC,UAAMA,SAAQ,IAAI,IAAI,QAAQ;AAC9B,IAAAA,OAAM,WAAW,KAAK,MAAM,WAAW,MAAM,KAAK;AAClD,WAAOA;AAAA,EACT;AACA,SAAO;AACT;AAlBS;AAoBT,eAAsB,gBACpB,KACA,KACA,UAA4B,CAAC,GACV;AACnB,QAAM,SAAS,IAAI;AACnB,MAAI,CAAC,QAAQ;AACX,WAAOL,MAAK,EAAE,OAAO,2BAA2B,GAAG,EAAE,QAAQ,IAAI,CAAC;AAAA,EACpE;AAEA,QAAM,eAAe,oBAAoB,IAAI,IAAI,IAAI,GAAG,GAAG,QAAQ,WAAW;AAC9E,MAAI,CAAC,cAAc;AACjB,WAAO,SAAS;AAAA,EAClB;AAEA,MAAI;AACJ,MAAI;AACF,UAAM,aAAa,aAAa,QAAQ;AAAA,EAC1C,QAAQ;AACN,WAAO,WAAW,oBAAoB;AAAA,EACxC;AAEA,QAAM,SAAS,IAAI,OAAO,YAAY;AACtC,QAAM,WAAW,qBAAqB,GAAG;AACzC,MAAI,CAAC,sBAAsB,KAAK,QAAQ,GAAG;AACzC,WAAO,UAAU,iBAAiB;AAAA,EACpC;AAEA,QAAM,gBAAgB,MAAM,cAAc,KAAK,GAAG;AAClD,QAAM,YAAY,CAAC,CAAC;AACpB,QAAM,oBAAoB,MAAM,gBAAgB,cAAc,QAAQ,GAAG;AAEzE,MAAI,WAAW,OAAO;AACpB,QAAI,CAAC,UAAW,QAAO,aAAa;AACpC,UAAM,cAAc,IAAI,QAAQ,IAAI,cAAc,KAAK;AACvD,QAAI;AACF,YAAM,OAAO,IAAI,KAAK,IAAI,MAAM,EAAE,cAAc,EAAE,YAAY,EAAE,CAAC;AACjE,aAAOA,MAAK,EAAE,IAAI,MAAM,IAAI,CAAC;AAAA,IAC/B,SAAS,OAAgB;AACvB,mBAAa,EAAE,OAAO,KAAK,CAAC,EAAE,MAAM,iBAAiB,EAAE,KAAK,MAAM,CAAC;AACnE,aAAOA;AAAA,QACL,EAAE,OAAO,eAAe;AAAA,QACxB,EAAE,QAAQ,IAAI;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,WAAW,UAAU;AACvB,QAAI,CAAC,UAAW,QAAO,aAAa;AACpC,QAAI;AACF,YAAM,OAAO,OAAO,GAAG;AACvB,aAAOA,MAAK,EAAE,IAAI,MAAM,KAAK,SAAS,KAAK,CAAC;AAAA,IAC9C,SAAS,OAAgB;AACvB,mBAAa,EAAE,OAAO,KAAK,CAAC,EAAE,MAAM,oBAAoB,EAAE,KAAK,MAAM,CAAC;AACtE,aAAOA;AAAA,QACL,EAAE,OAAO,gBAAgB;AAAA,QACzB,EAAE,QAAQ,IAAI;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AAEA,MAAI,WAAW,OAAO;AACpB,QAAI,CAAC,aAAa,CAAC,kBAAmB,QAAO,aAAa;AAC1D,UAAM,MAAM,MAAM,OAAO,IAAI,GAAG;AAChC,QAAI,CAAC,IAAK,QAAO,SAAS;AAC1B,UAAM,UAAU,IAAI,QAAQ;AAC5B,QAAI,IAAI,cAAc,YAAa,SAAQ,IAAI,gBAAgB,IAAI,aAAa,WAAW;AAC3F,QAAI,IAAI,cAAc,aAAc,SAAQ,IAAI,iBAAiB,IAAI,aAAa,YAAY;AAC9F,QAAI,IAAI,KAAM,SAAQ,IAAI,QAAQ,IAAI,IAAI;AAC1C,QAAI,IAAI,SAAU,SAAQ,IAAI,iBAAiB,IAAI,SAAS,YAAY,CAAC;AACzE,WAAOI,UAAS,IAAI,SAAS,IAAI,MAAM,EAAE,QAAQ,CAAC,CAAC;AAAA,EACrD;AAEA,MAAI,WAAW,QAAQ;AACrB,QAAI,CAAC,aAAa,CAAC,kBAAmB,QAAO,aAAa;AAC1D,UAAM,MAAM,MAAM,OAAO,KAAK,GAAG;AACjC,QAAI,CAAC,IAAK,QAAO,SAAS;AAC1B,UAAM,UAAU,IAAI,QAAQ;AAC5B,QAAI,IAAI,cAAc,YAAa,SAAQ,IAAI,gBAAgB,IAAI,aAAa,WAAW;AAC3F,QAAI,IAAI,cAAc,aAAc,SAAQ,IAAI,iBAAiB,IAAI,aAAa,YAAY;AAC9F,QAAI,IAAI,KAAM,SAAQ,IAAI,QAAQ,IAAI,IAAI;AAC1C,QAAI,IAAI,SAAU,SAAQ,IAAI,iBAAiB,IAAI,SAAS,YAAY,CAAC;AACzE,YAAQ,IAAI,kBAAkB,OAAO,IAAI,IAAI,CAAC;AAC9C,WAAOA,UAAS,IAAI,SAAS,MAAM,EAAE,QAAQ,CAAC,CAAC;AAAA,EACjD;AAEA,MAAI,WAAW,WAAW;AACxB,UAAM,UAAU,IAAI,QAAQ;AAC5B,YAAQ,IAAI,+BAA+B,GAAG;AAC9C,YAAQ,IAAI,gCAAgC,6BAA6B;AACzE,YAAQ;AAAA,MACN;AAAA,MACA;AAAA,IACF;AACA,YAAQ,IAAI,0BAA0B,KAAK;AAC3C,WAAO,oBAAoB,IAAI,SAAS,MAAM,EAAE,QAAQ,KAAK,QAAQ,CAAC,CAAC;AAAA,EACzE;AAEA,SAAOJ;AAAA,IACL,EAAE,OAAO,qBAAqB;AAAA,IAC9B,EAAE,QAAQ,KAAK,SAAS,EAAE,OAAO,8BAA8B,EAAE;AAAA,EACnE;AACF;AAtGsB;;;AC9JtB,IAAM,oBAAoB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAQ1B,eAAsB,eAAe,KAAU,MAAsC;AACnF,QAAM,MAAM,MAAM,IAAI,GACnB,QAAQ,yDAAyD,EACjE,KAAK,IAAI,EACT,MAAiC;AACpC,SAAO,KAAK,UAAU;AACxB;AANsB;AAQtB,eAAsB,gBAAgB,KAAU,MAAc,QAAwC;AACpG,QAAM,cAAc,OAAO,WAAW,WAAW,OAAO,KAAK,MAAM,MAAM,CAAC,IAAI,OAAO,MAAM;AAC3F,QAAM,IAAI,GAAG,QAAQ,iBAAiB,EAAE,KAAK,MAAM,aAAa,OAAO,CAAC,EAAE,IAAI;AAChF;AAHsB;AAKtB,eAAsB,gBAAgB,KAAU,MAA6B;AAC3E,QAAM,IAAI,GAAG,QAAQ,0CAA0C,EAAE,KAAK,IAAI,EAAE,IAAI;AAClF;AAFsB;;;ACnBtB,IAAM,yBAAyB;AAC/B,IAAM,qBAAqB;AAC3B,IAAM,aAAa,KAAK,KAAK,KAAK;AAClC,IAAM,uBAAuB;AAEtB,IAAM,2BAA2B;AAgDxC,IAAM,eAAe,oBAAI,IAAI,CAAC,KAAK,QAAQ,OAAO,IAAI,CAAC;AACvD,IAAM,gCAAgC;AACtC,IAAM,uBAAuB;AAE7B,eAAsB,sBAAsB,KAAU,UAA4B,CAAC,GAA8B;AAC/G,QAAM,YAAY,KAAK,IAAI;AAC3B,QAAM,MAAM,QAAQ,OAAO,oBAAI,KAAK;AACpC,QAAM,gBAAgB,mBAAmB,IAAI,wBAAwB;AACrE,QAAM,WAAW,IAAI,QAAQ,IAAI,gBAAgB;AACjD,QAAM,YAAY,IAAI,KAAK,QAAQ,EAAE,YAAY;AACjD,QAAM,QAAQ,QAAQ,SAAS,cAAc,GAAG;AAEhD,QAAM,aAAa,QAAQ,UAAU,aAAa,EAAE,MAAM,iBAAiB,CAAC;AAC5E,QAAM,MAAM,WAAW,KAAK;AAAA,IAC1B,QAAQ;AAAA,IACR,gBAAgB;AAAA,IAChB,YAAY;AAAA,EACd,CAAC;AAED,QAAM,gBAAgB,qBAAqB,GAAG;AAC9C,QAAM,iBAAiB,SAAS,IAAI,8BAA8B;AAClE,QAAM,eAAe,CAAC,QAAQ,UAAU,kBAAkB;AAE1D,MAAI,kBAAkB,kBAAkB,MAAM;AAC5C,UAAM,MAAM,IAAI,MAAM,2EAA2E;AACjG,QAAI,MAAM,4BAA4B,EAAE,OAAO,IAAI,CAAC;AACpD,UAAM;AAAA,EACR;AAEA,MAAI,CAAC,QAAQ,UAAU,kBAAkB,MAAM;AAC7C,QAAI,KAAK,4BAA4B;AAAA,MACnC,QAAQ;AAAA,IACV,CAAC;AAAA,EACH;AAEA,MAAI,KAAK,qBAAqB;AAAA,IAC5B,SAAS,QAAQ,QAAQ,MAAM;AAAA,IAC/B,gBAAgB;AAAA,EAClB,CAAC;AAED,MAAI,iBAAgC;AACpC,MAAI,CAAC,QAAQ,QAAQ;AACnB,UAAM,YAAY,MAAM,eAAe,KAAK,oBAAoB;AAChE,qBAAiB,YAAY,OAAO,SAAS,IAAI;AAAA,EACnD;AAEA,QAAM,mBAAmB,MAAM,eAAe,KAAK;AAAA,IACjD;AAAA,IACA;AAAA,IACA;AAAA,IACA,KAAK,IAAI,KAAK,EAAE,OAAO,YAAY,CAAC;AAAA,IACpC,SAAS,eAAe,gBAAgB;AAAA,IACxC,QAAQ,QAAQ,QAAQ,MAAM;AAAA,IAC9B,QAAQ;AAAA,EACV,CAAC;AAED,MAAI,CAAC,QAAQ,QAAQ;AACnB,QAAI,iBAAiB,iBAAiB,MAAM;AAC1C,YAAM,gBAAgB,KAAK,sBAAsB,iBAAiB,YAAY;AAAA,IAChF,OAAO;AACL,YAAM,gBAAgB,KAAK,oBAAoB;AAAA,IACjD;AAAA,EACF;AAEA,QAAM,aAAa,MAAMM,iBAAgB,KAAK;AAAA,IAC5C;AAAA,IACA,QAAQ,QAAQ,QAAQ,MAAM;AAAA,IAC9B,KAAK,IAAI,KAAK,EAAE,OAAO,cAAc,CAAC;AAAA,EACxC,CAAC;AAED,MAAI,KAAK,uBAAuB;AAAA,IAC9B,mBAAmB,iBAAiB;AAAA,IACpC,mBAAmB,iBAAiB;AAAA,IACpC,mBAAmB,iBAAiB,QAAQ;AAAA,IAC5C,qBAAqB;AAAA,IACrB,oBAAoB,iBAAiB;AAAA,IACrC,yBAAyB,iBAAiB;AAAA,EAC5C,CAAC;AAED,QAAM,aAAa,iBAAiB,UAAU,MAAM;AACpD,QAAM,gBAAgB,KAAK,mBAAmB,YAAY,KAAK,IAAI,IAAI,WAAW,MAAM,GAAG;AAE3F,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA,WAAW;AAAA,IACX,mBAAmB;AAAA,IACnB,kBAAkB,iBAAiB;AAAA,IACnC,iBAAiB,iBAAiB;AAAA,EACpC;AACF;AAvFsB;AAyFtB,SAAS,mBAAmB,KAAiC;AAC3D,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,SAAS,OAAO,GAAG;AACzB,MAAI,CAAC,OAAO,SAAS,MAAM,EAAG,QAAO;AACrC,QAAM,UAAU,KAAK,MAAM,MAAM;AACjC,MAAI,WAAW,EAAG,QAAO;AACzB,SAAO,KAAK,IAAI,oBAAoB,OAAO;AAC7C;AAPS;AAST,SAAS,SAAS,OAAoC;AACpD,MAAI,CAAC,MAAO,QAAO;AACnB,SAAO,aAAa,IAAI,MAAM,KAAK,EAAE,YAAY,CAAC;AACpD;AAHS;AAKT,SAAS,eAAe,QAAwB;AAC9C,QAAM,UAAU,OAAO,KAAK,EAAE,QAAQ,kBAAkB,EAAE;AAC1D,SAAO,UAAU,UAAU;AAC7B;AAHS;AAKT,SAAS,cAAc,KAAmB;AACxC,SAAO,IAAI,YAAY,EAAE,QAAQ,SAAS,GAAG;AAC/C;AAFS;AAIT,SAAS,qBAAqB,KAAgC;AAC5D,QAAM,SAAS,IAAI,qBAAqB,IAAI,aAAa;AACzD,MAAI,CAAC,OAAQ,QAAO;AACpB,QAAM,cAAc,IAAI,2BAA2B;AACnD,QAAM,SAAS,eAAe,WAAW;AACzC,SAAO,EAAE,QAAQ,OAAO;AAC1B;AANS;AAQT,eAAe,eACb,KACA,QASgC;AAChC,QAAM,UAAiC;AAAA,IACrC,SAAS;AAAA,IACT,SAAS;AAAA,IACT,SAAS;AAAA,IACT,SAAS,CAAC;AAAA,IACV,SAAS;AAAA,IACT,cAAc,OAAO,UAAU;AAAA,EACjC;AAEA,MAAI,SAAS,OAAO,UAAU;AAE9B,SAAO,MAAM;AACX,UAAM,QAAQ,MAAM,IAAI,GACrB;AAAA,MACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAMF,EACC,KAAK,OAAO,UAAU,QAAQ,oBAAoB,EAClD,IAAkB;AAErB,UAAM,OAAO,MAAM,WAAW,CAAC;AAC/B,QAAI,CAAC,KAAK,QAAQ;AAChB,cAAQ,eAAe;AACvB;AAAA,IACF;AAEA,YAAQ,WAAW,KAAK;AACxB,YAAQ,WAAW;AACnB,UAAM,SAAS,KAAK,IAAI,CAAC,QAAQ,IAAI,KAAK,EAAE,OAAO,CAAC,UAAU,OAAO,UAAU,QAAQ;AACvF,UAAM,YAAY,OAAO,OAAO,SAAS,CAAC,KAAK;AAE/C,QAAI,CAAC,OAAO,UAAU,OAAO,SAAS;AACpC,YAAM,MAAM,gBAAgB,OAAO,QAAQ,QAAQ,OAAO,OAAO,aAAa,QAAQ,OAAO;AAC7F,YAAM,UAAU,KACb;AAAA,QAAI,CAAC,QACJ,KAAK,UAAU;AAAA,UACb,WAAW,IAAI;AAAA,UACf,IAAI,SAAS,IAAI,EAAE;AAAA,UACnB,cAAc,IAAI;AAAA,UAClB,QAAQ,iBAAiB,IAAI,MAAM;AAAA,UACnC,WAAW,iBAAiB,IAAI,SAAS;AAAA,UACzC,KAAK,iBAAiB,IAAI,GAAG;AAAA,UAC7B,aAAa,IAAI,eAAe;AAAA,UAChC,aAAa,IAAI,eAAe;AAAA,UAChC,aAAa,IAAI,eAAe;AAAA,UAChC,sBAAsB,OAAO;AAAA,UAC7B,kBAAkB,OAAO;AAAA,QAC3B,CAAC;AAAA,MACH,EACC,KAAK,IAAI,EACT,OAAO,IAAI;AAEd,YAAM,OAAO,QAAQ,OAAO,IAAI,KAAK,SAAS;AAAA,QAC5C,cAAc,EAAE,aAAa,uBAAuB;AAAA,QACpD,gBAAgB;AAAA,UACd,OAAO;AAAA,UACP,YAAY,OAAO;AAAA,UACnB,QAAQ,OAAO;AAAA,QACjB;AAAA,MACF,CAAC;AACD,cAAQ,QAAQ,KAAK,GAAG;AACxB,aAAO,IAAI,KAAK,6BAA6B,EAAE,KAAK,MAAM,KAAK,OAAO,CAAC;AAAA,IACzE;AAEA,QAAI,CAAC,OAAO,QAAQ;AAClB,UAAI,OAAO,QAAQ;AACjB,cAAM,eAAe,OAAO,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AACnD,cAAM,IAAI,GAAG,QAAQ,yCAAyC,YAAY,GAAG,EAAE,KAAK,GAAG,MAAM,EAAE,IAAI;AAAA,MACrG;AACA,cAAQ,WAAW,OAAO;AAAA,IAC5B;AAEA,aAAS;AACT,YAAQ,eAAe;AAEvB,QAAI,QAAQ,WAAW,+BAA+B;AACpD,cAAQ,UAAU;AAClB,aAAO,IAAI,KAAK,iCAAiC;AAAA,QAC/C,SAAS,QAAQ;AAAA,QACjB,SAAS,OAAO,SAAS,IAAI,QAAQ;AAAA,MACvC,CAAC;AACD;AAAA,IACF;AAEA,QAAI,KAAK,SAAS,sBAAsB;AACtC,cAAQ,UAAU;AAClB,cAAQ,eAAe;AACvB;AAAA,IACF;AAAA,EACF;AAEA,SAAO,IAAI,KAAK,6BAA6B;AAAA,IAC3C,SAAS,QAAQ;AAAA,IACjB,SAAS,OAAO,SAAS,IAAI,QAAQ;AAAA,IACrC,SAAS,QAAQ;AAAA,IACjB,UAAU,QAAQ;AAAA,IAClB,eAAe,QAAQ;AAAA,EACzB,CAAC;AAED,SAAO;AACT;AApHe;AAsHf,eAAeA,iBACb,KACA,QACiB;AACjB,MAAI,OAAO,QAAQ;AACjB,UAAM,WAAW,MAAM,IAAI,GAAG;AAAA,MAC5B;AAAA,IACF,EACG,KAAK,OAAO,SAAS,EACrB,MAAuC;AAC1C,UAAM,MAAM,UAAU,OAAO;AAC7B,UAAM,QAAQ,OAAO,QAAQ,WAAW,MAAM,OAAO,GAAG;AACxD,WAAO,IAAI,KAAK,6BAA6B;AAAA,MAC3C,SAAS;AAAA,MACT,SAAS;AAAA,MACT,SAAS;AAAA,IACX,CAAC;AACD,WAAO;AAAA,EACT;AAEA,QAAM,SAAS,MAAM,IAAI,GAAG,QAAQ,uCAAuC,EACxE,KAAK,OAAO,SAAS,EACrB,IAAI;AACP,QAAM,UAAU,OAAO,OAAO,MAAM,WAAW,CAAC;AAChD,SAAO,IAAI,KAAK,6BAA6B;AAAA,IAC3C,SAAS;AAAA,IACT;AAAA,IACA,SAAS;AAAA,EACX,CAAC;AACD,SAAO;AACT;AA9Be,OAAAA,kBAAA;AAgCf,SAAS,gBAAgB,QAAgB,OAAe,OAAe,OAAuB;AAC5F,QAAM,SAAS,MAAM,SAAS,EAAE,SAAS,GAAG,GAAG;AAC/C,SAAO,GAAG,MAAM,IAAI,KAAK,IAAI,KAAK,UAAU,MAAM;AACpD;AAHS;AAKT,SAAS,SAAS,OAAgC;AAChD,MAAI,OAAO,UAAU,SAAU,QAAO;AACtC,QAAM,SAAS,OAAO,KAAK;AAC3B,MAAI,CAAC,OAAO,SAAS,MAAM,GAAG;AAC5B,UAAM,IAAI,MAAM,wCAAwC,KAAK,GAAG;AAAA,EAClE;AACA,SAAO;AACT;AAPS;AAST,SAAS,iBAAiB,OAAiD;AACzE,MAAI,UAAU,QAAQ,UAAU,OAAW,QAAO;AAClD,SAAO,SAAS,KAAK;AACvB;AAHS;;;AClUT,IAAM,uBAA+C;AAAA,EACnD,SAAS;AAAA,EACT,OAAO;AAAA,EACP,QAAQ;AACV;AACA,IAAM,gBAAgB;AACtB,IAAM,kCAAkC;AACxC,IAAM,6BAA6B;AACnC,IAAM,qBAAqB;AAC3B,IAAM,8BAA8B;AACpC,IAAM,qBAAqB;AAE3B,SAAS,QAAQ,MAAsB;AACrC,QAAM,MAAM,KAAK,YAAY,GAAG;AAChC,SAAO,QAAQ,KAAK,KAAK,KAAK,MAAM,GAAG;AACzC;AAHS;AAKT,SAAS,eAAe,MAAsB;AAC5C,SAAO,qBAAqB,QAAQ,IAAI,CAAC,KAAK;AAChD;AAFS;AAIT,SAAS,mBAAmB,OAA2B,UAA0B;AAC/E,MAAI,UAAU,OAAW,QAAO;AAChC,QAAM,SAAS,OAAO,KAAK;AAC3B,SAAO,OAAO,SAAS,MAAM,IAAI,SAAS;AAC5C;AAJS;AAWT,SAAS,uBAAuB,MAAc,WAAmB;AAC/D,MAAI,CAAC,UAAW,QAAO;AACvB,SAAO,KAAK,QAAQ,kDAAkD,CAAC,QAAQ,MAAM,OAAO,WAAW;AACrG,UAAM,YAAY,gBAAgB,WAAW,MAAM;AACnD,WAAO,GAAG,IAAI,IAAI,KAAK,GAAG,SAAS;AAAA,EACrC,CAAC;AACH;AANS;AAQT,SAAS,oBAAoB,KAAsB;AACjD,MAAI,QAAQ,aAAc,QAAO;AACjC,MAAI,IAAI,WAAW,SAAS,GAAG;AAC7B,WAAO;AAAA,EACT;AACA,SAAO;AACT;AANS;AAQT,eAAe,aAAa,SAAiB;AAC3C,QAAM,OAAO,IAAI,YAAY,EAAE,OAAO,OAAO;AAC7C,QAAM,SAAS,MAAM,OAAO,OAAO,OAAO,WAAW,IAAI;AACzD,QAAM,QAAQ,IAAI,WAAW,MAAM;AACnC,MAAI,SAAS;AACb,aAAW,QAAQ,MAAO,WAAU,OAAO,aAAa,IAAI;AAC5D,SAAO,KAAK,MAAM;AACpB;AAPe;AASf,eAAe,gBAAgB,MAAc,KAA6D;AACxG,QAAM,SAAS,iBAAiB,GAAG;AACnC,QAAM,gBAAgB,uBAAuB,MAAM,OAAO,SAAS;AACnE,QAAM,gBAAgB,yBAAyB,mBAAmB,MAAM,CAAC;AACzE,QAAM,OAAO,MAAM,aAAa,aAAa;AAC7C,QAAM,cAAc,WAAW,IAAI;AACnC,QAAM,YAAY,WAAW,aAAa;AAC1C,QAAM,cAAc;AACpB,QAAM,WACJ,YAAY,KAAK,aAAa,IAC5B,cAAc,QAAQ,aAAa,KAAK,SAAS;AAAA,QAAW,IAC5D,GAAG,SAAS;AAAA,EAAK,aAAa;AAClC,SAAO,EAAE,MAAM,UAAU,cAAc,CAAC,WAAW,EAAE;AACvD;AAbe;AAef,eAAe,WAAW,KAAa,KAAU;AAC/C,MAAI,EAAE,gBAAgB,QAAQ,CAAC,IAAI,WAAY,QAAO;AACtD,SAAO,IAAI,WAAW,IAAI,gBAAgB,GAAG;AAC/C;AAHe;AAKf,SAAS,UAAU,KAAU,YAAoB,KAAsB;AACrE,QAAM,UAAU,IAAI,QAAQ;AAC5B,MAAI,KAAK,cAAc,aAAa;AAClC,YAAQ,IAAI,gBAAgB,IAAI,aAAa,WAAW;AAAA,EAC1D,OAAO;AACL,YAAQ,IAAI,gBAAgB,UAAU;AAAA,EACxC;AACA,MAAI,KAAK,cAAc,cAAc;AACnC,YAAQ,IAAI,iBAAiB,IAAI,aAAa,YAAY;AAAA,EAC5D;AACA,MAAI,CAAC,QAAQ,IAAI,eAAe,GAAG;AACjC,YAAQ,IAAI,iBAAiB,oBAAoB,GAAG,CAAC;AAAA,EACvD;AACA,SAAO;AACT;AAdS;AAgBT,eAAe,eAAe,KAAsB,KAAwC;AAC1F,QAAM,OAAO,cAAc,GAAG;AAC9B,QAAM,KAAK,eAAe,GAAG;AAC7B,MAAI,UAAU;AACd,MAAI;AACJ,MAAI,QAAQ,cAAc;AACxB,UAAM,WAAW,MAAM,gBAAgB,MAAM,GAAG;AAChD,cAAU,SAAS;AACnB,mBAAe,SAAS;AAAA,EAC1B;AACA,QAAM,UAAU,IAAI,QAAQ;AAAA,IAC1B,gBAAgB;AAAA,IAChB,iBAAiB,oBAAoB,GAAG;AAAA,EAC1C,CAAC;AACD,SAAO,EAAE,UAAU,IAAI,SAAS,SAAS,EAAE,QAAQ,CAAC,GAAG,aAAa;AACtE;AAfe;AAiBf,eAAe,WAAW,KAAU;AAClC,MAAI,OAAO,OAAO,IAAI,SAAS,YAAY;AACzC,WAAO,IAAI,KAAK;AAAA,EAClB;AACA,SAAO,IAAI,SAAS,KAAK,IAAI,EAAE,KAAK;AACtC;AALe;AAOf,eAAe,eAAe,MAAc,KAA+C;AACzF,QAAM,aAAa,KAAK,QAAQ,aAAa,EAAE;AAC/C,QAAM,YAAa,cAAc,CAAC,WAAW,WAAW,SAAS,IAAI,eAAe,cAAc;AAClG,MAAI,EAAE,aAAa,gBAAgB;AACjC,WAAO;AAAA,EACT;AACA,QAAM,SAAS,eAAe,SAAS;AACvC,QAAM,KAAK,MAAM,WAAW,WAAW,GAAG;AAC1C,MAAI,IAAI;AACN,UAAM,UAAU,UAAU,IAAI,QAAQ,SAAS;AAC/C,QAAI,cAAc,cAAc;AAC9B,YAAM,MAAM,MAAM,WAAW,EAAE;AAC/B,YAAM,WAAW,MAAM,gBAAgB,KAAK,GAAG;AAC/C,aAAO;AAAA,QACL,UAAU,IAAI,SAAS,SAAS,MAAM,EAAE,QAAQ,CAAC;AAAA,QACjD,cAAc,SAAS;AAAA,MACzB;AAAA,IACF;AACA,WAAO,EAAE,UAAU,IAAI,SAAS,GAAG,MAAM,EAAE,QAAQ,CAAC,EAAE;AAAA,EACxD;AACA,SAAO,eAAe,WAAW,GAAG;AACtC;AArBe;AAuBf,IAAO,cAAQ;AAAA,EACb,MAAM,MAAM,KAAc,KAA6B;AACrD,gBAAY,GAAG;AACf,UAAM,MAAM,IAAI,IAAI,IAAI,GAAG;AAC3B,UAAM,OAAO,IAAI;AACjB,UAAM,eAAe,0BAA0B,GAAG;AAClD,UAAM,gBAAgB,wBAAC,UAAoB,cACzC,oBAAoB,UAAU,2BAA2B,cAAc,SAAS,CAAC,GAD7D;AAEtB,UAAM,yBAAyB,wBAAC,eAAyB;AACvD,UAAI;AACF,cAAM,YAAY,IAAI,IAAI,IAAI,YAAY;AAC1C,kBAAU,WAAW,WAAW;AAChC,kBAAU,SAAS,WAAW;AAC9B,kBAAU,OAAO,WAAW;AAC5B,eAAO;AAAA,MACT,QAAQ;AACN,eAAO;AAAA,MACT;AAAA,IACF,GAV+B;AAW/B,UAAM,yBAAyB,6BAAM;AACnC,UAAI,IAAI,WAAW,SAAS,IAAI,WAAW,QAAQ;AACjD,YAAI;AACF,gBAAM,eAAe,uBAAuB,GAAG;AAC/C,gBAAM,WAAW,IAAI;AAAA,YACnB,yBAAyB,mBAAmB,IAAI,UAAU,CAAC;AAAA,YAC3D;AAAA,UACF;AACA,mBAAS,aAAa,IAAI,gBAAgB,aAAa,SAAS,CAAC;AACjE,iBAAO,cAAc,SAAS,SAAS,SAAS,SAAS,GAAG,GAAG,CAAC;AAAA,QAClE,QAAQ;AAAA,QAER;AAAA,MACF;AACA,aAAO,cAAc,IAAI,SAAS,gBAAgB,EAAE,QAAQ,IAAI,CAAC,CAAC;AAAA,IACpE,GAf+B;AAiB/B,QAAI,SAAS,KAAK;AAChB,aAAO,SAAS,SAAS,IAAI,SAAS,QAAQ,GAAG;AAAA,IACnD;AAEA,UAAM,YAAY,qBAAqB,KAAK,MAAM,GAAG;AACrD,QAAI,UAAW,QAAO,cAAc,SAAS;AAE7C,QAAI,SAAS,gBAAgB;AAC3B,aAAO,cAAc,IAAI,SAAS,IAAI,EAAE,QAAQ,IAAI,CAAC,CAAC;AAAA,IACxD;AAEA,QAAI,SAAS,gBAAgB;AAC3B,aAAO;AAAA,QACL,IAAI,SAAS,aAAa,EAAE,SAAS,EAAE,gBAAgB,yBAAyB,EAAE,CAAC;AAAA,MACrF;AAAA,IACF;AAEA,QAAI,SAAS,SAAS,KAAK,WAAW,MAAM,GAAG;AAC7C,aAAO,gBAAgB,KAAK,KAAK,EAAE,aAAa,MAAM,CAAC;AAAA,IACzD;AAEA,QAAI,IAAI,WAAW,WAAW;AAC5B,aAAO,cAAc,IAAI,SAAS,IAAI,EAAE,QAAQ,KAAK,SAAS,UAAU,CAAC,CAAC;AAAA,IAC5E;AAEA,QAAI,KAAK,WAAW,UAAU,GAAG;AAC/B,YAAM,OAAO,mBAAmB,KAAK,QAAQ,YAAY,EAAE,CAAC;AAC5D,YAAM,QAAQ,OAAO,IAAI;AACzB,UAAI,CAAC,MAAO,QAAO,KAAK,aAAa,EAAE,QAAQ,IAAI,CAAC;AACpD,aAAO,cAAc,IAAI,SAAS,MAAM,MAAM,EAAE,SAAS,EAAE,gBAAgB,MAAM,GAAG,EAAE,CAAC,CAAC;AAAA,IAC1F;AAEA,QAAI,SAAS,UAAU,SAAS,SAAS;AACvC,YAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,UAAI,CAAC,MAAM;AACT,eAAO,uBAAuB;AAAA,MAChC;AACA,YAAM,cAAc,WAAW,IAAI;AACnC,UAAI,CAAC,YAAY,WAAW,GAAG,KAAK,YAAY,WAAW,IAAI,GAAG;AAChE,cAAM,IAAI,MAAM,yBAAyB,WAAW,EAAE;AAAA,MACxD;AACA,YAAM,aAAa,IAAI,IAAI,aAAa,IAAI,YAAY;AACxD,UAAI,IAAI,aAAa,WAAW,UAAU;AACxC,eAAO,cAAc,SAAS,SAAS,WAAW,SAAS,GAAG,GAAG,CAAC;AAAA,MACpE;AACA,YAAM,MAAM,MAAM,eAAe,QAAQ,GAAG;AAC5C,UAAI,KAAK;AACP,cAAM,YAAY,IAAI,eAAe,EAAE,cAAc,IAAI,aAAa,IAAI;AAC1E,eAAO,cAAc,IAAI,UAAU,SAAS;AAAA,MAC9C;AACA,aAAO,KAAK,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1C;AAEA,QAAI,SAAS,eAAe;AAC1B,YAAM,MAAM,oBAAoB,IAAI,aAAa,IAAI,QAAQ,GAAG,KAAK,GAAG;AACxE,YAAM,YAAY,IAAI,IAAI,0BAA0B,GAAG;AACvD,gBAAU,aAAa,IAAI,UAAU,GAAG;AACxC,aAAO,SAAS,SAAS,UAAU,SAAS,GAAG,GAAG;AAAA,IACpD;AAEA,QAAI,KAAK,WAAW,cAAc,GAAG;AACnC,YAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,UAAI,CAAC,MAAM;AACT,eAAO,uBAAuB;AAAA,MAChC;AACA,YAAM,WAAW,MAAM,eAAe,MAAM,GAAG;AAC/C,UAAI,UAAU;AACZ,cAAM,YAAY,SAAS,eAAe,EAAE,cAAc,SAAS,aAAa,IAAI;AACpF,eAAO,cAAc,SAAS,UAAU,SAAS;AAAA,MACnD;AACA,aAAO,KAAK,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1C;AAEA,QAAI,KAAK,WAAW,OAAO,GAAG;AAC5B,YAAM,OAAO,MAAM,kBAAkB,KAAK,GAAG;AAC7C,UAAI,CAAC,MAAM;AACT,eAAO,uBAAuB;AAAA,MAChC;AACA,YAAM,MAAM,MAAM,eAAe,MAAM,GAAG;AAC1C,UAAI,KAAK;AACP,cAAM,YAAY,IAAI,eAAe,EAAE,cAAc,IAAI,aAAa,IAAI;AAC1E,eAAO,cAAc,IAAI,UAAU,SAAS;AAAA,MAC9C;AACA,aAAO,KAAK,aAAa,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC1C;AAEA,WAAO,cAAc,KAAK,GAAG;AAAA,EAC/B;AAAA,EAEA,MAAM,UAAU,OAAuB,KAAU,MAAwB;AACvE,QAAI,MAAM,SAAS,0BAA0B;AAC3C,YAAM,eAAe,aAAa,EAAE,MAAM,iBAAiB,CAAC;AAC5D,UAAI;AACF,cAAM,sBAAsB,KAAK,EAAE,QAAQ,aAAa,CAAC;AAAA,MAC3D,SAAS,OAAO;AACd,qBAAa,MAAM,yBAAyB,EAAE,MAAM,CAAC;AAAA,MACvD;AACA;AAAA,IACF;AAEA,UAAM,MAAM,aAAa,EAAE,MAAM,eAAe,CAAC;AACjD,QAAI;AACF,YAAM,SAAS,MAAM,IAAI,GAAG;AAAA,QAC1B;AAAA,MACF,EACG,KAAK,KAAK,IAAI,CAAC,EACf,IAAI;AACP,UAAI,MAAM,qCAAqC;AAAA,QAC7C,SAAS,OAAO,MAAM,WAAW;AAAA,MACnC,CAAC;AAAA,IACH,SAAS,OAAO;AACd,UAAI,MAAM,kCAAkC,EAAE,MAAM,CAAC;AAAA,IACvD;AAEA,UAAM,aAAa;AAAA,MACjB,IAAI;AAAA,MACJ;AAAA,IACF;AACA,UAAM,aAAa,mBAAmB,IAAI,oBAAoB,0BAA0B;AACxF,UAAM,gBAAgB,KAAK,IAAI,IAAI,aAAa,UAAU;AAC1D,UAAM,OAAO,gBAAgB;AAE7B,UAAM,mBAAmB,KAAK,IAAI;AAElC,UAAM,WAAW,MAAM,IAAI,GACxB;AAAA,MACC;AAAA;AAAA;AAAA;AAAA,IAIF,EACC,KAAK,IAAI,EACT,MAAuC;AAC1C,UAAM,aAAa,OAAO,UAAU,OAAO,CAAC;AAE5C,QAAI,CAAC,OAAO,SAAS,UAAU,KAAK,cAAc,GAAG;AACnD,YAAM,gBAAgB,KAAK,kBAAkB;AAC7C,UAAI,MAAM,2BAA2B,EAAE,aAAa,GAAG,gBAAgB,cAAc,CAAC;AACtF,YAAM,gBAAgB,KAAK,iBAAiB,KAAK,KAAK,IAAI,IAAI,kBAAkB,MAAM,GAAG;AACzF;AAAA,IACF;AAEA,QAAI,KAAK,4BAA4B;AAAA,MACnC,aAAa;AAAA,MACb,gBAAgB;AAAA,IAClB,CAAC;AAED,UAAM,MAAK,oBAAI,KAAK,GAAE,YAAY;AAClC,UAAM,oBAAoB,MAAM,eAAe,KAAK,kBAAkB;AACtE,QAAI,SAAS,oBAAoB,OAAO,iBAAiB,IAAI;AAC7D,QAAI,eAA8B,oBAAoB,OAAO,iBAAiB,IAAI;AAClF,QAAI,YAAY;AAChB,QAAI,UAAU;AACd,QAAI,YAAY;AAEhB,WAAO,MAAM;AACX,YAAM,aAAa,MAAM,IAAI,GAC1B;AAAA,QACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAOF,EACC,KAAK,MAAM,QAAQ,kBAAkB,EACrC,IAA0C;AAE7C,YAAM,OAAO,WAAW,WAAW,CAAC;AACpC,UAAI,CAAC,KAAK,QAAQ;AAChB,uBAAe;AACf;AAAA,MACF;AAEA,YAAM,WAAW,KAAK,IAAI,CAAC,QAAQ,IAAI,SAAS;AAChD,iBAAW;AAEX,YAAM,qBAAqB,SAAS,IAAI,MAAM,GAAG,EAAE,KAAK,GAAG;AAC3D,YAAM,IAAI,GAAG;AAAA,QACX,gEAAgE,kBAAkB;AAAA,MACpF,EACG,KAAK,GAAG,QAAQ,EAChB,IAAI;AAEP,YAAM,qBAAqB,SAAS,IAAI,CAAC,GAAG,UAAU,IAAI,QAAQ,CAAC,EAAE,EAAE,KAAK,GAAG;AAC/E,YAAM,IAAI,GAAG;AAAA,QACX,uEAAuE,kBAAkB;AAAA,MAC3F,EACG,KAAK,IAAI,GAAG,QAAQ,EACpB,IAAI;AAEP,YAAM,SAAS,SAAS,IAAI,MAAM,iBAAiB,EAAE,KAAK,GAAG;AAC7D,YAAM,QAAe,CAAC;AACtB,iBAAW,MAAM,UAAU;AACzB,cAAM,KAAK,IAAI,iBAAiB,KAAK,GAAG,EAAE;AAAA,MAC5C;AACA,YAAM,IAAI,GAAG;AAAA,QACX,mFAAmF,MAAM;AAAA,MAC3F,EACG,KAAK,GAAG,KAAK,EACb,IAAI;AAEP,mBAAa,SAAS;AACtB,YAAM,YAAY,KAAK,KAAK,SAAS,CAAC,GAAG,SAAS;AAClD,eAAS;AACT,qBAAe;AAEf,UAAI,WAAW,6BAA6B;AAC1C,oBAAY;AACZ;AAAA,MACF;AAEA,UAAI,KAAK,SAAS,oBAAoB;AACpC,uBAAe;AACf;AAAA,MACF;AAAA,IACF;AAEA,QAAI,iBAAiB,MAAM;AACzB,YAAM,gBAAgB,KAAK,oBAAoB,YAAY;AAAA,IAC7D,OAAO;AACL,YAAM,gBAAgB,KAAK,kBAAkB;AAAA,IAC/C;AAEA,QAAI,KAAK,gCAAgC;AAAA,MACvC,aAAa;AAAA,MACb;AAAA,MACA;AAAA,MACA;AAAA,MACA,eAAe;AAAA,IACjB,CAAC;AAED,UAAM,gBAAgB,KAAK,iBAAiB,YAAY,MAAM,KAAK,KAAK,IAAI,IAAI,kBAAkB,MAAM,GAAG;AAAA,EAC7G;AACF;;;ACjbA,IAAM,YAAwB,8BAAO,SAAS,KAAK,MAAM,kBAAkB;AAC1E,MAAI;AACH,WAAO,MAAM,cAAc,KAAK,SAAS,GAAG;AAAA,EAC7C,UAAE;AACD,QAAI;AACH,UAAI,QAAQ,SAAS,QAAQ,CAAC,QAAQ,UAAU;AAC/C,cAAM,SAAS,QAAQ,KAAK,UAAU;AACtC,eAAO,EAAE,MAAM,OAAO,KAAK,GAAG,MAAM;AAAA,QAAC;AAAA,MACtC;AAAA,IACD,SAAS,GAAG;AACX,cAAQ,MAAM,4CAA4C,CAAC;AAAA,IAC5D;AAAA,EACD;AACD,GAb8B;AAe9B,IAAO,6CAAQ;;;ACRf,SAAS,YAAY,GAAmB;AACvC,SAAO;AAAA,IACN,MAAM,GAAG;AAAA,IACT,SAAS,GAAG,WAAW,OAAO,CAAC;AAAA,IAC/B,OAAO,GAAG;AAAA,IACV,OAAO,GAAG,UAAU,SAAY,SAAY,YAAY,EAAE,KAAK;AAAA,EAChE;AACD;AAPS;AAUT,IAAM,YAAwB,8BAAO,SAAS,KAAK,MAAM,kBAAkB;AAC1E,MAAI;AACH,WAAO,MAAM,cAAc,KAAK,SAAS,GAAG;AAAA,EAC7C,SAAS,GAAQ;AAChB,UAAM,QAAQ,YAAY,CAAC;AAC3B,WAAO,SAAS,KAAK,OAAO;AAAA,MAC3B,QAAQ;AAAA,MACR,SAAS,EAAE,+BAA+B,OAAO;AAAA,IAClD,CAAC;AAAA,EACF;AACD,GAV8B;AAY9B,IAAO,2CAAQ;;;ACzBJ,IAAM,mCAAmC;AAAA,EAE9B;AAAA,EAAyB;AAC3C;AACA,IAAO,sCAAQ;;;ACcnB,IAAM,wBAAsC,CAAC;AAKtC,SAAS,uBAAuB,MAAqC;AAC3E,wBAAsB,KAAK,GAAG,KAAK,KAAK,CAAC;AAC1C;AAFgB;AAShB,SAAS,uBACR,SACA,KACA,KACA,UACA,iBACsB;AACtB,QAAM,CAAC,MAAM,GAAG,IAAI,IAAI;AACxB,QAAM,gBAAmC;AAAA,IACxC;AAAA,IACA,KAAK,YAAY,QAAQ;AACxB,aAAO,uBAAuB,YAAY,QAAQ,KAAK,UAAU,IAAI;AAAA,IACtE;AAAA,EACD;AACA,SAAO,KAAK,SAAS,KAAK,KAAK,aAAa;AAC7C;AAfS;AAiBF,SAAS,kBACf,SACA,KACA,KACA,UACA,iBACsB;AACtB,SAAO,uBAAuB,SAAS,KAAK,KAAK,UAAU;AAAA,IAC1D,GAAG;AAAA,IACH;AAAA,EACD,CAAC;AACF;AAXgB;;;AC3ChB,IAAM,iCAAN,MAAM,gCAA8D;AAAA,EAGnE,YACU,eACA,MACT,SACC;AAHQ;AACA;AAGT,SAAK,WAAW;AAAA,EACjB;AAAA,EArBD,OAYoE;AAAA;AAAA;AAAA,EAC1D;AAAA,EAUT,UAAU;AACT,QAAI,EAAE,gBAAgB,kCAAiC;AACtD,YAAM,IAAI,UAAU,oBAAoB;AAAA,IACzC;AAEA,SAAK,SAAS;AAAA,EACf;AACD;AAEA,SAAS,oBAAoB,QAA0C;AAEtE,MACC,qCAAqC,UACrC,iCAAiC,WAAW,GAC3C;AACD,WAAO;AAAA,EACR;AAEA,aAAW,cAAc,kCAAkC;AAC1D,wBAAoB,UAAU;AAAA,EAC/B;AAEA,QAAM,kBAA+C,gCACpD,SACA,KACA,KACC;AACD,QAAI,OAAO,UAAU,QAAW;AAC/B,YAAM,IAAI,MAAM,6CAA6C;AAAA,IAC9D;AACA,WAAO,OAAO,MAAM,SAAS,KAAK,GAAG;AAAA,EACtC,GATqD;AAWrD,SAAO;AAAA,IACN,GAAG;AAAA,IACH,MAAM,SAAS,KAAK,KAAK;AACxB,YAAM,aAAyB,gCAAU,MAAM,MAAM;AACpD,YAAI,SAAS,eAAe,OAAO,cAAc,QAAW;AAC3D,gBAAM,aAAa,IAAI;AAAA,YACtB,KAAK,IAAI;AAAA,YACT,KAAK,QAAQ;AAAA,YACb,MAAM;AAAA,YAAC;AAAA,UACR;AACA,iBAAO,OAAO,UAAU,YAAY,KAAK,GAAG;AAAA,QAC7C;AAAA,MACD,GAT+B;AAU/B,aAAO,kBAAkB,SAAS,KAAK,KAAK,YAAY,eAAe;AAAA,IACxE;AAAA,EACD;AACD;AAxCS;AA0CT,SAAS,qBACR,OAC8B;AAE9B,MACC,qCAAqC,UACrC,iCAAiC,WAAW,GAC3C;AACD,WAAO;AAAA,EACR;AAEA,aAAW,cAAc,kCAAkC;AAC1D,wBAAoB,UAAU;AAAA,EAC/B;AAGA,SAAO,cAAc,MAAM;AAAA,IAC1B,mBAAyE,wBACxE,SACA,KACA,QACI;AACJ,WAAK,MAAM;AACX,WAAK,MAAM;AACX,UAAI,MAAM,UAAU,QAAW;AAC9B,cAAM,IAAI,MAAM,sDAAsD;AAAA,MACvE;AACA,aAAO,MAAM,MAAM,OAAO;AAAA,IAC3B,GAXyE;AAAA,IAazE,cAA0B,wBAAC,MAAM,SAAS;AACzC,UAAI,SAAS,eAAe,MAAM,cAAc,QAAW;AAC1D,cAAM,aAAa,IAAI;AAAA,UACtB,KAAK,IAAI;AAAA,UACT,KAAK,QAAQ;AAAA,UACb,MAAM;AAAA,UAAC;AAAA,QACR;AACA,eAAO,MAAM,UAAU,UAAU;AAAA,MAClC;AAAA,IACD,GAT0B;AAAA,IAW1B,MAAM,SAAwD;AAC7D,aAAO;AAAA,QACN;AAAA,QACA,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AAAA,MACN;AAAA,IACD;AAAA,EACD;AACD;AAnDS;AAqDT,IAAI;AACJ,IAAI,OAAO,wCAAU,UAAU;AAC9B,kBAAgB,oBAAoB,mCAAK;AAC1C,WAAW,OAAO,wCAAU,YAAY;AACvC,kBAAgB,qBAAqB,mCAAK;AAC3C;AACA,IAAO,kCAAQ;",
  "names": ["util", "objectUtil", "t", "json", "message", "errorUtil", "message", "errorMap", "message", "ctx", "result", "issues", "types", "elements", "processed", "result", "p", "p2", "r", "ZodFirstPartyTypeKind", "h", "message", "types", "jwk", "json", "decode", "decode", "r", "g", "message", "clone", "jwksCache", "DEV_SHIM_ENVIRONMENTS", "t", "r", "o", "e", "n", "hex", "f", "f", "encoder", "message", "coerceNumber", "router", "r", "router", "withParam", "router", "parsed", "r", "buildSeriesSql", "resolveMetrics", "resolveInterval", "clampTimestamp", "buildInClause", "parsed", "safeParseJson", "METRICS_WITH_EXTENTS", "response", "dedupePreserveOrder", "buildSeriesResponse", "captureLastValues", "buildMetricValues", "averageForMetric", "minForMetric", "maxForMetric", "text", "router", "message", "message", "encoder", "text", "message", "optionalTrimmedString", "encoder", "safePath", "url", "ABSOLUTE_SCHEME_PATTERN", "json", "clone", "HTTP_SCHEMES", "ABSOLUTE_SCHEME", "isSafeRelativePath", "json", "jwksCache", "getJwks", "encoder", "withCors", "clone", "pruneOpsMetrics"]
}
