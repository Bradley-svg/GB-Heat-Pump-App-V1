name = "gb-heat-pump-app-v1"
main = "src/app.ts"
# Must NOT be in the future. Use a recent date.
compatibility_date = "2024-12-20"

workers_dev = true

# D1
[[d1_databases]]
binding = "DB"
database_name = "GREENBRO_DB"
database_id = "ee7ad98b-3629-4985-bd7d-a60c401953a7"

[vars]
APP_BASE_URL = "https://gb-heat-pump-app-v1.bradleyayliffl.workers.dev"
RETURN_DEFAULT = "https://www.greenbro.co.za/"
TIMEZONE = "Africa/Johannesburg"
APP_API_BASE = "https://gb-heat-pump-app-v1.bradleyayliffl.workers.dev"
APP_ASSET_BASE = "https://pub-3f14c9b10881423a97f40e12402d4b03.r2.dev/app/assets/"
ALLOWED_PREFIXES = "brand/"
# Ingest controls are provided via `wrangler secret put` per environment:
#   INGEST_ALLOWED_ORIGINS
#   INGEST_RATE_LIMIT_PER_MIN
#   INGEST_SIGNATURE_TOLERANCE_SECS

# Ops thresholds (override per-env if needed)
HEARTBEAT_INTERVAL_SECS = "30"        # expected device heartbeat period
OFFLINE_MULTIPLIER = "6"              # mark offline if > 6Ã— heartbeat interval (=> 3 min w/ 30s hb)

# --- Observability / Logs ---
[observability]
  [observability.logs]
  enabled = true
  head_sampling_rate = 1
  invocation_logs = true
  persist = true

# --- Cron schedules ---
# Every 5 minutes: set devices offline if stale
[triggers]
crons = ["*/5 * * * *"]

[[r2_buckets]]
binding = "GB_BUCKET"
bucket_name = "greenbro-brand"
# optional for local dev:
# preview_bucket_name = "greenbro-brand-dev"

[[r2_buckets]]
binding = "APP_STATIC"
bucket_name = "greenbro-app-static"
# optional for local dev:
# preview_bucket_name = "greenbro-app-static-dev"

[env.production]
  workers_dev = true

  [[env.production.routes]]
  pattern = "app.greenbro.co.za"
  custom_domain = true

  [env.production.vars]
  APP_BASE_URL = "https://app.greenbro.co.za"
  APP_API_BASE = "https://app.greenbro.co.za"
  APP_ASSET_BASE = "https://pub-3f14c9b10881423a97f40e12402d4b03.r2.dev/app/assets/"
  RETURN_DEFAULT = "https://www.greenbro.co.za/"
  TIMEZONE = "Africa/Johannesburg"
  HEARTBEAT_INTERVAL_SECS = "30"
  OFFLINE_MULTIPLIER = "6"
  ALLOWED_PREFIXES = "brand/"

  [[env.production.d1_databases]]
  binding = "DB"
  database_name = "GREENBRO_DB"
  database_id = "ee7ad98b-3629-4985-bd7d-a60c401953a7"

  [[env.production.r2_buckets]]
  binding = "GB_BUCKET"
  bucket_name = "greenbro-brand"

  [[env.production.r2_buckets]]
  binding = "APP_STATIC"
  bucket_name = "greenbro-app-static"

  # Main worker serves API, SPA, and /r2/* on the same hostname.
  [[env.production.routes]]
  pattern = "app.greenbro.co.za/*"
  zone_name = "greenbro.co.za"

[env.local]
  [env.local.vars]
  # Enable the Access shim for local Miniflare sessions (adjust as needed).
  ALLOW_DEV_ACCESS_SHIM = "true"
  DEV_ALLOW_USER = '{"email":"local-admin@example.com","roles":["admin"],"clientIds":["profile-west"]}'

