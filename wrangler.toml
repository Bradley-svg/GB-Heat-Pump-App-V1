name = "gb-heat-pump-app-v1"
main = "src/app.ts"
# Must NOT be in the future. Use a recent date.
compatibility_date = "2024-10-25"

workers_dev = true

# D1
[[d1_databases]]
binding = "DB"
database_name = "GREENBRO_DB"
database_id = "ee7ad98b-3629-4985-bd7d-a60c401953a7"
migrations_dir = "./migrations"

[vars]
APP_BASE_URL = "https://gb-heat-pump-app-v1.bradleyayliffl.workers.dev/app"
RETURN_DEFAULT = "https://www.greenbro.co.za/"
TIMEZONE = "Africa/Johannesburg"
APP_API_BASE = "https://gb-heat-pump-app-v1.bradleyayliffl.workers.dev"
APP_ASSET_BASE = "https://pub-3f14c9b10881423a97f40e12402d4b03.r2.dev/app/assets/"
TELEMETRY_REFACTOR_MODE = "compare"
ALLOWED_PREFIXES = "brand/"
TELEMETRY_RETENTION_DAYS = "90"
RETENTION_BACKUP_PREFIX = "data-retention"
ENVIRONMENT = "production"
# Ingest controls are provided via `wrangler secret put` per environment:
#   INGEST_ALLOWED_ORIGINS
#   INGEST_RATE_LIMIT_PER_MIN
#   INGEST_FAILURE_LIMIT_PER_MIN
#   INGEST_SIGNATURE_TOLERANCE_SECS
INGEST_FAILURE_LIMIT_PER_MIN = "60"
INGEST_IP_LIMIT_PER_MIN = "240"
INGEST_IP_BLOCK_SECONDS = "60"

# Ops thresholds (override per-env if needed)
HEARTBEAT_INTERVAL_SECS = "30"        # expected device heartbeat period
OFFLINE_MULTIPLIER = "6"              # mark offline if > 6Ã— heartbeat interval (=> 3 min w/ 30s hb)

# --- Observability / Logs ---
[observability]
  [observability.logs]
  enabled = true
  head_sampling_rate = 1
  invocation_logs = true
  persist = true

# --- Cron schedules ---
# Every 5 minutes: set devices offline if stale
[triggers]
crons = ["*/5 * * * *", "15 2 * * *"]


[[r2_buckets]]
binding = "GB_BUCKET"
bucket_name = "greenbro-brand"
# optional for local dev:
# preview_bucket_name = "greenbro-brand-dev"

[[r2_buckets]]
binding = "APP_STATIC"
bucket_name = "greenbro-app-static"
# optional for local dev:
# preview_bucket_name = "greenbro-app-static-dev"

[[r2_buckets]]
binding = "RETENTION_ARCHIVE"
bucket_name = "greenbro-telemetry-archive"
preview_bucket_name = "greenbro-telemetry-archive-dev"

[[kv_namespaces]]
# Replace the placeholder IDs with the production/preview KV namespace IDs returned by
# `wrangler kv namespace create greenbro-ingest-ip`.
binding = "INGEST_IP_BUCKETS"
id = "a5ea436cc7854b0a8ce5bab3e3551455"
preview_id = "<preview-namespace-id>"

[env.local]
  [env.local.vars]
  APP_BASE_URL = "http://127.0.0.1:8787/app"
  APP_API_BASE = "http://127.0.0.1:8787"
  ENVIRONMENT = "development"
  TELEMETRY_REFACTOR_MODE = "compare"
  INGEST_IP_LIMIT_PER_MIN = "0"
  INGEST_IP_BLOCK_SECONDS = "60"
  # Enable the Access shim for local Miniflare sessions (adjust as needed).
  ALLOW_DEV_ACCESS_SHIM = "true"
  DEV_ALLOW_USER = '{"email":"local-admin@example.com","roles":["admin"],"clientIds":["profile-west"]}'

[env.production]
  [env.production.vars]

[[env.production.r2_buckets]]
binding = "APP_STATIC"
bucket_name = "greenbro-app-static"

