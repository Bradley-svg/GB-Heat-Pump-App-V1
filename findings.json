[
  {
    "id": "P0-modea-bypass-overseas-ingest",
    "severity": "P0",
    "category": "Privacy",
    "status": "mitigated",
    "files": [
      "src/routes/ingest.ts:260-565",
      "src/schemas/ingest.ts:17-39",
      "migrations/0001_init.sql:1-34"
    ],
    "evidence": "`handleIngest` now checks `ALLOW_RAW_INGEST` and returns `410 raw_ingest_disabled` by default (see src/routes/ingest.ts:260-310). The new unit test `handleIngest returns 410 when raw ingest is disabled` covers the guard.",
    "impact": "Raw payloads can no longer reach overseas storage unless someone deliberately flips the feature flag, keeping Mode A DROP/Safe guarantees intact.",
    "fix": "Leave `ALLOW_RAW_INGEST` unset in production and use the signed batch exporter + overseas API as the only cross-border path.",
    "tests": [
      "npx vitest run src/routes/__tests__/ingest.test.ts"
    ]
  },
  {
    "id": "P1-access-jwt-weak",
    "severity": "P1",
    "category": "Security",
    "status": "fixed",
    "files": [
      "src/lib/access.ts:148-179"
    ],
    "evidence": "`requireAccessUser` now derives the issuer from `ACCESS_JWKS_URL` and calls `jwtVerify` with `{ audience, issuer, clockTolerance: 60 }` (src/lib/access.ts:148-196).",
    "impact": "Access tokens minted for other apps or replayed outside the clock skew window are rejected before they reach operator APIs.",
    "fix": "Deploy the hardened verifier and monitor Access logs for unexpected 403 spikes.",
    "tests": [
      "npx vitest run src/lib/__tests__/access.test.ts"
    ]
  },
  {
    "id": "P1-observability-reporter-user",
    "severity": "P1",
    "category": "Privacy",
    "status": "fixed",
    "files": [
      "src/routes/observability.ts:211-252",
      "src/routes/__tests__/observability.test.ts:320-360"
    ],
    "evidence": "Client error logs used to include `reporter_user: body.user`. The new `sanitizeReporterUser` masks emails and only emits counts.",
    "impact": "Without masking, operator identities were written to overseas logs.",
    "fix": "Mask reporter emails via `maskEmail`, emit role/client counts, and update tests to assert the masked form.",
    "tests": [
      "npx vitest run src/routes/__tests__/observability.test.ts"
    ]
  },
  {
    "id": "P1-client-events-email-plaintext",
    "severity": "P1",
    "category": "Privacy",
    "status": "fixed",
    "files": [
      "src/lib/client-events.ts:15-78",
      "src/lib/__tests__/client-events.test.ts:1-32"
    ],
    "evidence": "`recordClientEvent` now hashes `userEmail` with `CLIENT_EVENT_TOKEN_SECRET` before storing; previously it inserted the plaintext email.",
    "impact": "Raw operator emails in D1 violate Mode A DROP guidance.",
    "fix": "`recordClientEvent` hashes emails and the new admin endpoint `/api/admin/client-events/backfill` rehashes existing rows before deploy.",
    "tests": [
      "npx vitest run src/lib/__tests__/client-events.test.ts src/routes/__tests__/client-events-admin.test.ts"
    ]
  },
  {
    "id": "P1-ip-log-nested",
    "severity": "P1",
    "category": "Privacy",
    "status": "fixed",
    "files": [
      "src/routes/ingest.ts:272-280"
    ],
    "evidence": "The `ip_rate_limited` and related events no longer include `client_ip` in their `fields` payload (src/routes/ingest.ts:272-282 & 600-608).",
    "impact": "Structured logs shipped overseas no longer leak raw IP addresses, satisfying the DROP rule.",
    "fix": "Deploy the Worker build containing the logging change and spot-check log sinks for only aggregate counters.",
    "tests": [
      "npx vitest run src/routes/__tests__/ingest.test.ts"
    ]
  },
  {
    "id": "P1-overseas-schema-mismatch",
    "severity": "P1",
    "category": "Correctness",
    "status": "fixed",
    "files": [
      "services/cn-gateway/src/ingest/exporter.ts:11-60",
      "services/overseas-api/src/index.ts:7-66"
    ],
    "evidence": "CN exporter, OpenAPI docs, and responses now emit `didPseudo` (see services/cn-gateway/src/ingest/exporter.ts and services/cn-gateway/openapi/modea-cn-gateway.yaml). Overseas API already required `didPseudo`, so batches now parse.",
    "impact": "Signed batches can finally land overseas, removing the need for legacy raw ingest fallbacks.",
    "fix": "Deploy both CN gateway and overseas Worker updates together.",
    "tests": [
      "npx vitest run services/overseas-api/src/index.test.ts"
    ]
  },
  {
    "id": "P1-export-key-unset",
    "severity": "P1",
    "category": "Security",
    "status": "mitigated",
    "files": [
      "services/overseas-api/wrangler.toml:5-8",
      "services/overseas-api/src/index.ts:28-41"
    ],
    "evidence": "`EXPORT_VERIFY_PUBKEY` is now supplied via Wrangler secret, `/health` reports `signatureConfigured`, and missing keys trigger a `503 signing key not configured` response (services/overseas-api/src/index.ts:28-83).",
    "impact": "Exports cannot silently bypass signature verification - operators must upload the Ed25519 public key before enabling batches.",
    "fix": "Run `wrangler secret put EXPORT_VERIFY_PUBKEY` for each environment and monitor `/health` for `signatureConfigured: true`.",
    "tests": [
      "npx vitest run services/overseas-api/src/index.test.ts"
    ]
  },
  {
    "id": "P1-safe-metrics-drift",
    "severity": "P1",
    "category": "Correctness",
    "status": "open",
    "files": [
      "services/cn-gateway/src/modea/drop-safe.ts:1-16",
      "packages/sdk-core/src/constants.ts:1-18"
    ],
    "evidence": "SDK SAFE metrics include `firmware_version_major_minor` and `alerts`, but CN gateway SAFE list does not, so those fields are silently dropped.",
    "impact": "Developers believe the fields are approved and may attempt to bypass the gateway to recover them, reintroducing PII risk.",
    "fix": "Decide if the extra fields are SAFE\u2014either add them to the gateway sanitization or remove them from the SDK/docs.",
    "tests": []
  },
  {
    "id": "P2-ingest-strip-silent",
    "severity": "P2",
    "category": "Correctness",
    "status": "open",
    "files": [
      "src/schemas/ingest.ts:17-30"
    ],
    "evidence": "Telemetry schema uses `.strip()`, so unexpected keys are silently dropped rather than rejected/audited.",
    "impact": "Firmware bugs or DROP fields go unnoticed because the API still returns 2xx, eroding compliance guarantees.",
    "fix": "Switch to `.strict()` and emit 4xx + audit log when payloads include unknown keys.",
    "tests": []
  },
  {
    "id": "P2-modea-doc-drift",
    "severity": "P2",
    "category": "Compliance",
    "status": "mitigated",
    "files": [
      "docs/mode-a-operational-guidance.md:6-12",
      "src/routes/ingest.ts:260-565"
    ],
    "evidence": "`docs/mode-a-operational-guidance.md` now notes that `/api/ingest` is disabled by default and SAFE metrics align with the CN gateway list.",
    "impact": "Regulators and internal reviewers see the same behavior described in docs and implemented in code.",
    "fix": "Update docs whenever SAFE metrics or ingest behaviors change.",
    "tests": []
  }
]