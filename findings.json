[
  {
    "id": "P0-overseas-raw-ingest",
    "title": "Overseas API still ingests and stores raw device_id values",
    "category": "Privacy",
    "where": [
      "services/overseas-api/src/schemas/ingest.ts:34",
      "services/overseas-api/src/routes/ingest.ts:342",
      "services/overseas-api/migrations/0021_overseas_ingest_storage.sql:1"
    ],
    "evidence": "TelemetryPayloadSchema requires `device_id`/`ts` and the ingest handler writes those raw identifiers into D1 tables before any pseudonymization.",
    "impact": "Raw identifiers, metrics, and replay data leave mainland China, violating Mode A DROP/SAFE guarantees and exposing overseas operators to PII.",
    "fix": "Implement a `/api/export` path that accepts `{ didPseudo, keyVersion, SAFE_METRICS }` batches, refuse any payload containing `device_id`, and migrate D1 tables to store pseudonymous IDs only.",
    "tests": "Add contract tests that replay CN gateway batches against the overseas worker to prove only SAFE metrics are accepted.",
    "status": "open"
  },
  {
    "id": "P0-export-signature-missing",
    "title": "Ed25519 batch signatures are never verified downstream",
    "category": "Security",
    "where": [
      "docs/mode-a/audit-2025-11-11/pr-summary.md:4",
      "docs/mode-a/audit-2025-11-11/mode-a-guardrail-checklist.md:6",
      "services/overseas-api/src/routes/health.ts:1",
      "services/overseas-api/src/routes/ingest.ts:27"
    ],
    "evidence": "Docs claim `EXPORT_VERIFY_PUBKEY` enforcement, but the worker only looks for `X-GREENBRO-*` headers. `/health` never reports signature state.",
    "impact": "Any actor that can reach `/api/ingest/:profile` can inject or replay telemetry without CN approval, defeating batch integrity and compliance evidence.",
    "fix": "Introduce an Ed25519 verifier that loads `EXPORT_VERIFY_PUBKEY` from Wrangler secrets, validates `x-batch-signature`, and exposes `signatureConfigured`/`signatureVerified` on `/health`.",
    "tests": "Add positive/negative Vitest cases covering signed vs tampered batches.",
    "status": "open"
  },
  {
    "id": "P1-logs-leak-device-id",
    "title": "Logs and ops metrics include raw device_id outside CN",
    "category": "Privacy",
    "where": [
      "services/overseas-api/src/routes/ingest.ts:247",
      "services/overseas-api/src/routes/ingest.ts:563",
      "services/overseas-api/src/lib/ops-metrics.ts:31"
    ],
    "evidence": "`logAndRecordEarlyExit` and `recordOpsMetric` call sites attach `device_id` directly to log fields and D1 rows.",
    "impact": "Even if export data were pseudonymized, Cloudflare logs, D1 tables (`ops_metrics`), and dashboards would expose raw identifiers, breaking the \"No raw IDs outside CN\" contract.",
    "fix": "Pseudonymize before logging (HMAC with CN key or derive from mapping) and store only `did_pseudo`/hashes in ops metrics.",
    "tests": "Add logging unit tests that assert redaction and add integration tests verifying ops_metrics rows contain only pseudonymous IDs.",
    "status": "open"
  },
  {
    "id": "P1-allow-raw-ingest-unguarded",
    "title": "ALLOW_RAW_INGEST flag bypassed Mode A protections globally",
    "category": "Security",
    "where": [
      "services/overseas-api/src/env.ts:242",
      "services/overseas-api/src/__tests__/env.validation.test.ts:124",
      "scripts/ensure-prod-shim-disabled.mjs:31"
    ],
    "evidence": "Before this PR, `isRawIngestEnabled` only checked for a truthy string, so production deployments could flip the flag without any locality guard or CI block.",
    "impact": "Human error or malicious config could silently re-enable direct device uploads overseas, reintroducing PII.",
    "fix": "âœ… Added explicit validation that `ALLOW_RAW_INGEST` only passes when `ENVIRONMENT` is local/test and `APP_BASE_URL` points to localhost, covered by Vitest, and included the flag in the shim CI script.",
    "tests": "`pnpm --filter @greenbro/overseas-api exec vitest run src/__tests__/env.validation.test.ts`",
    "status": "fixed"
  },
  {
    "id": "P1-schema-drift-didPseudo",
    "title": "CN exporter and overseas worker disagree on payload shape",
    "category": "Correctness",
    "where": [
      "services/cn-gateway/src/ingest/routes.ts:82",
      "packages/sdk-core/src/schemas.ts:46",
      "services/overseas-api/src/schemas/ingest.ts:34"
    ],
    "evidence": "CN gateway exports `{ didPseudo, keyVersion, SAFE_METRICS }`, but the overseas schemas/tests still demand `{ device_id, ts, tankC, ambientC, ... }`.",
    "impact": "Even after signature verification lands, sanitized batches would fail validation, so the exporter cannot be enabled without a breaking change.",
    "fix": "Unify schemas (e.g., use the shared sdk-core schema on both sides) and add contract tests in CI.",
    "tests": "Add a simulated exporter -> worker roundtrip test case that must pass before deploy.",
    "status": "open"
  },
  {
    "id": "P1-modea-doc-drift",
    "title": "Mode A reports mark missing guardrails as Pass",
    "category": "Compliance",
    "where": [
      "docs/mode-a/audit-2025-11-11/pr-summary.md:4",
      "docs/mode-a/audit-2025-11-11/mode-a-guardrail-checklist.md:5"
    ],
    "evidence": "The published PR summary and guard checklist state that raw ingest is \"sunsetted\" and signing is verified even though the code lacks both features.",
    "impact": "Compliance/legal stakeholders make deployment decisions based on inaccurate evidence, increasing regulatory exposure if Mode A filings are audited.",
    "fix": "Update the guardrail docs to reflect reality, link to automated evidence (tests, health endpoints), and require doc PRs when guard status changes.",
    "tests": "Add a doc linter that cross-checks guard status with actual automated checks.",
    "status": "open"
  },
  {
    "id": "P2-guard-scripts-skip-dirs",
    "title": "Forbidden-field scanners ignore docs/tests",
    "category": "Maintainability",
    "where": [
      "scripts/forbidden-fields-lint.js:24",
      "scripts/pii-regex-scan.js:12"
    ],
    "evidence": "Both scripts hard-code a small `watchPrefixes` list and skip `docs/**`, so privacy notices, SOPs, and wrangler configs never get scanned.",
    "impact": "PII strings creep back into documentation and fixtures without any CI signal, undermining Mode A guardrails.",
    "fix": "Load globs from `.modea.guard.json`, remove broad directory excludes, and support an explicit allowlist for known-good references.",
    "tests": "Add unit tests for the scripts plus a CI job that ensures they run over sample markdown files.",
    "status": "open"
  },
  {
    "id": "P2-dev-fixtures-embed-email",
    "title": "Dev/test fixtures and wrangler defaults embed literal email fields",
    "category": "Privacy",
    "where": [
      "services/overseas-api/tests/integration/access-shim.integration.test.ts:22",
      "services/overseas-api/tests/security/csp.security.test.ts:17",
      "services/overseas-api/wrangler.toml:122"
    ],
    "evidence": "`DEV_ALLOW_USER` strings in tests/wrangler config include real `\"email\":\"...\"` JSON, tripping the guard script and checking PII into git.",
    "impact": "The guard workflow fails (as seen when running `node scripts/forbidden-fields-lint.js`), so engineers ignore the signal and real leaks may be missed.",
    "fix": "Represent shim users via hashed IDs or assemble the JSON at runtime (e.g., base64 in env) so literal forbidden keys never appear in repo.",
    "tests": "Extend guard tests to include these fixtures so we enforce the new encoding.",
    "status": "open"
  },
  {
    "id": "P2-dashboard-no-csp",
    "title": "Dashboard SPA ships without CSP or Permissions-Policy",
    "category": "Security",
    "where": [
      "apps/dashboard-web/index.html:1"
    ],
    "evidence": "The root HTML only sets charset, viewport, and title. No CSP/Permissions-Policy headers are injected server-side either, so the SPA relies on Cloudflare defaults.",
    "impact": "XSS injection or malicious third-party scripts have no additional containment, which is risky for an admin console that handles tenant data.",
    "fix": "Inject a strict CSP/Permissions-Policy via Worker middleware (e.g., `frame-ancestors 'none'; default-src 'self'; script-src 'self' 'sha256-...'`).",
    "tests": "Add an integration test that fetches `/app` and asserts the headers are present.",
    "status": "open"
  },
  {
    "id": "P2-guard-checklist-outdated",
    "title": "Mode A guard checklist references nonexistent verification code",
    "category": "Compliance",
    "where": [
      "docs/guardrails/MODEA_GUARDS_CHECKLIST.md:6"
    ],
    "evidence": "The checklist cites `services/overseas-api/src/index.ts` for signature verification even though that file is gone and the Worker never checks signatures.",
    "impact": "Audit evidence is stale; reviewers may accept the checklist at face value while guardrails regress.",
    "fix": "Regenerate the checklist from automated checks (e.g., a script that inspects code/tests) and fail CI when cited files disappear.",
    "tests": "Add a doc test ensuring every evidence path exists and that guard status matches automated results.",
    "status": "open"
  }
]
