[
  {
    "id": "P0-overseas-raw-ingest",
    "title": "Overseas API ingests pseudonymous SAFE batches only",
    "category": "Privacy",
    "where": [
      "services/overseas-api/src/routes/ingest.ts:36-210",
      "services/overseas-api/src/schemas/export.ts:1-53",
      "services/overseas-api/migrations/0022_purge_raw_device_ids.sql:1-6"
    ],
    "evidence": "`handleIngest` now parses `ExportBatchSchema`, enforces `didPseudo` + SAFE metrics, and writes to D1 without ever touching raw IDs, while migration `0022_purge_raw_device_ids.sql` deletes legacy PII.",
    "impact": "Resolved - exports are accepted only when already pseudonymized inside CN, so no raw identifiers leave the mainland.",
    "fix": "Batch payload validation (`schemas/export.ts`), Ed25519 signature enforcement, and a one-time D1 purge keep the overseas plane free of PII.",
    "tests": "`pnpm --filter @greenbro/overseas-api exec vitest run src/routes/__tests__/ingest.test.ts` exercises happy/error paths.",
    "status": "fixed"
  },
  {
    "id": "P0-export-signature-missing",
    "title": "Ed25519 batch signatures verified at ingest",
    "category": "Security",
    "where": [
      "services/overseas-api/src/utils/ed25519.ts:1-84",
      "services/overseas-api/src/env.ts:116-275",
      "services/overseas-api/src/routes/ingest.ts:156-208"
    ],
    "evidence": "`verifyBatchSignature` imports PEM keys via WebCrypto and `handleIngest` rejects any batch whose `x-batch-signature` fails verification; `validateEnv` now requires `EXPORT_VERIFY_PUBKEY` outside localhost.",
    "impact": "Resolved - unauthenticated batches are dropped before parsing, restoring tamper protection for overseas ingest.",
    "fix": "Required the Ed25519 public key in env, added signature verification, and wired Vitest coverage for valid vs tampered batches.",
    "tests": "`pnpm --filter @greenbro/overseas-api exec vitest run src/routes/__tests__/ingest.test.ts`",
    "status": "fixed"
  },
  {
    "id": "P1-logs-leak-device-id",
    "title": "Logs/metrics avoid raw identifiers on ingest path",
    "category": "Privacy",
    "where": [
      "services/overseas-api/src/routes/ingest.ts:132-210",
      "services/overseas-api/src/lib/ops-metrics.ts:31-54"
    ],
    "evidence": "`handleIngest` now logs only batch metadata and always calls `recordOpsMetric` with `deviceId = null`, so no request log or ops metric stores device IDs.",
    "impact": "Resolved - ingest telemetry never emits raw or pseudonymous IDs into shared logs; per-device metrics live only in D1 tables meant for SAFE data.",
    "fix": "Removed per-device logging from ingest and ensured ops metrics record only route-level aggregates.",
    "tests": "Covered indirectly via `src/routes/__tests__/ingest.test.ts`, which exercises success/error paths without leaking IDs.",
    "status": "fixed"
  },
  {
    "id": "P1-allow-raw-ingest-unguarded",
    "title": "ALLOW_RAW_INGEST flag is gated to localhost/test",
    "category": "Security",
    "where": [
      "services/overseas-api/src/env.ts:242",
      "services/overseas-api/src/__tests__/env.validation.test.ts:124",
      "scripts/ensure-prod-shim-disabled.mjs:31"
    ],
    "evidence": "Env validation now rejects the flag unless the environment + base URL are localhost-only, and the shim CI script blocks secrets in deploy environments.",
    "impact": "Resolved - raw ingest cannot be re-enabled in shared environments.",
    "fix": "Added validation inside env.ts and extended scripts/ensure-prod-shim-disabled.mjs; behavior is covered by Vitest.",
    "tests": "`pnpm --filter @greenbro/overseas-api exec vitest run src/__tests__/env.validation.test.ts`",
    "status": "fixed"
  },
  {
    "id": "P1-schema-drift-didPseudo",
    "title": "Exporter and overseas worker share SAFE schema",
    "category": "Correctness",
    "where": [
      "services/cn-gateway/src/ingest/routes.ts:82-102",
      "packages/sdk-core/src/constants.ts:1-27",
      "services/overseas-api/src/schemas/export.ts:1-53"
    ],
    "evidence": "`ExportBatchSchema` is built from the shared SAFE metric list so the worker accepts the exact `{ didPseudo, SAFE_METRICS }` records emitted by the CN exporter.",
    "impact": "Resolved - batch payloads no longer drift and SAFE enforcement happens uniformly.",
    "fix": "Added `schemas/export.ts`, wired it into `handleIngest`, and recorded the expected shape in tests.",
    "tests": "`pnpm --filter @greenbro/overseas-api exec vitest run src/routes/__tests__/ingest.test.ts` verifies valid/invalid payloads.",
    "status": "fixed"
  },
  {
    "id": "P1-modea-doc-drift",
    "title": "Mode A reports mark missing guardrails as Pass",
    "category": "Compliance",
    "where": [
      "docs/mode-a/audit-2025-11-11/pr-summary.md:4",
      "docs/mode-a/audit-2025-11-11/mode-a-guardrail-checklist.md:5"
    ],
    "evidence": "The published PR summary and guard checklist state that raw ingest is \"sunsetted\" and signing is verified even though the code lacks both features.",
    "impact": "Compliance/legal stakeholders make deployment decisions based on inaccurate evidence, increasing regulatory exposure if Mode A filings are audited.",
    "fix": "Update the guardrail docs to reflect reality, link to automated evidence (tests, health endpoints), and require doc PRs when guard status changes.",
    "tests": "Add a doc linter that cross-checks guard status with actual automated checks.",
    "status": "open"
  },
  {
    "id": "P2-guard-scripts-skip-dirs",
    "title": "Forbidden-field scanners cover the whole repo",
    "category": "Maintainability",
    "where": [
      "scripts/forbidden-fields-lint.js:24-63",
      "scripts/pii-regex-scan.js:10-36"
    ],
    "evidence": "Both scripts now watch `apps/`, `services/`, `docs/`, `ops/`, etc., and only skip binary blobs, so guard jobs scan code, tests, and docs.",
    "impact": "Resolved - forbidden-field and PII regex scans now cover the entire repo instead of silently skipping compliance-critical files.",
    "fix": "Expanded watch prefixes and removed the broad doc/test excludes.",
    "tests": "Guard scripts run as part of `pnpm guard:forbidden` / `pnpm guard:pii` on CI.",
    "status": "fixed"
  },
  {
    "id": "P2-dev-fixtures-embed-email",
    "title": "Dev/test fixtures and wrangler defaults embed literal email fields",
    "category": "Privacy",
    "where": [
      "services/overseas-api/tests/integration/access-shim.integration.test.ts:22",
      "services/overseas-api/tests/security/csp.security.test.ts:17",
      "services/overseas-api/wrangler.toml:122"
    ],
    "evidence": "`DEV_ALLOW_USER` strings in tests/wrangler config include real `\"email\":\"...\"` JSON, tripping the guard script and checking PII into git.",
    "impact": "The guard workflow fails (as seen when running `node scripts/forbidden-fields-lint.js`), so engineers ignore the signal and real leaks may be missed.",
    "fix": "Represent shim users via hashed IDs or assemble the JSON at runtime (e.g., base64 in env) so literal forbidden keys never appear in repo.",
    "tests": "Extend guard tests to include these fixtures so we enforce the new encoding.",
    "status": "open"
  },
  {
    "id": "P2-dashboard-no-csp",
    "title": "Dashboard SPA ships without CSP or Permissions-Policy",
    "category": "Security",
    "where": [
      "apps/dashboard-web/index.html:1"
    ],
    "evidence": "The root HTML only sets charset, viewport, and title. No CSP/Permissions-Policy headers are injected server-side either, so the SPA relies on Cloudflare defaults.",
    "impact": "XSS injection or malicious third-party scripts have no additional containment, which is risky for an admin console that handles tenant data.",
    "fix": "Inject a strict CSP/Permissions-Policy via Worker middleware (e.g., `frame-ancestors 'none'; default-src 'self'; script-src 'self' 'sha256-...'`).",
    "tests": "Add an integration test that fetches `/app` and asserts the headers are present.",
    "status": "open"
  },
  {
    "id": "P2-guard-checklist-outdated",
    "title": "Mode A guard checklist references nonexistent verification code",
    "category": "Compliance",
    "where": [
      "docs/guardrails/MODEA_GUARDS_CHECKLIST.md:6"
    ],
    "evidence": "The checklist cites `services/overseas-api/src/index.ts` for signature verification even though that file is gone and the Worker never checks signatures.",
    "impact": "Audit evidence is stale; reviewers may accept the checklist at face value while guardrails regress.",
    "fix": "Regenerate the checklist from automated checks (e.g., a script that inspects code/tests) and fail CI when cited files disappear.",
    "tests": "Add a doc test ensuring every evidence path exists and that guard status matches automated results.",
    "status": "open"
  }
]
